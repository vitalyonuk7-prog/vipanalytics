/*************************************************
 * Code.gs ‚Äî ENHANCED BACKEND –¥–ª—è Slotornado
 * ‚úÖ FIX: FTD deduplication
 * ‚úÖ FIX: METRICS sheet support
 * ‚úÖ FIX: Player Profiling
 *************************************************/

/******************** MENU ********************/
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('üå™Ô∏è Slotornado')
    .addItem('üìä Open App', 'openDepositApp')
    .addItem('üíé Bonus Calculator', 'openBonusCalculator')
    .addSeparator()
    .addItem('üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', 'diagnosticSheets')
    .addToUi();
}

function openDepositApp() {
  var html = HtmlService.createHtmlOutputFromFile('App')
    .setWidth(1600).setHeight(900);
  SpreadsheetApp.getUi().showModelessDialog(html, 'Slotornado Analytics');
}

function openBonusCalculator() {
  var html = HtmlService.createHtmlOutputFromFile('BonusCalc')
    .setWidth(1400).setHeight(900);
  SpreadsheetApp.getUi().showModalDialog(html, 'üíé Bonus Calculator');
}

/******************** WEB ENTRYPOINT ********************/
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('App')
    .setTitle('Slotornado Analytics')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/******************** TYPE MAPPING ********************/
function getTypeMapping() {
  var result = { tagToType: {}, typeMapping: {} };
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    // Try both "TYPE" and "[TYPE]" sheet names
    var sheet = ss.getSheetByName('TYPE') || ss.getSheetByName('[TYPE]');
    if (sheet) {
      var data = sheet.getDataRange().getValues();
      for (var i = 1; i < data.length; i++) {
        var typeName = String(data[i][0] || '').trim();
        var tagsRaw = String(data[i][1] || '').trim();
        if (!typeName || !tagsRaw) continue;
        
        // Parse tags - can be JSON array or single tag
        var tags = [];
        if (tagsRaw.charAt(0) === '[') {
          try { tags = JSON.parse(tagsRaw); } catch(e) { tags = [tagsRaw]; }
        } else {
          tags = tagsRaw.split(',').map(function(t) { return t.trim(); });
        }
        
        if (!result.typeMapping[typeName]) result.typeMapping[typeName] = [];
        
        tags.forEach(function(tag) {
          var t = String(tag).toLowerCase().trim().replace(/"/g, '');
          if (t) {
            result.tagToType[t] = typeName;
            result.typeMapping[typeName].push(t);
          }
        });
      }
    }
    Logger.log('TYPE mapping loaded: ' + Object.keys(result.tagToType).length + ' tags ‚Üí ' + Object.keys(result.typeMapping).length + ' types');
  } catch (e) {
    Logger.log('Error loading TYPE mapping: ' + e);
  }
  return result;
}

/**
 * Get MANAGER mapping from MANAGER sheet
 * Structure: Col A = Manager name, Col B = tags (JSON array)
 * Returns: { tagToManager: {tag: managerName}, managerMapping: {managerName: [tags]} }
 */
function getManagerMapping() {
  var result = { tagToManager: {}, managerMapping: {} };
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('MANAGER') || ss.getSheetByName('[MANAGER]');
    if (!sheet) {
      Logger.log('MANAGER sheet not found');
      return result;
    }
    
    var data = sheet.getDataRange().getValues();
    for (var i = 1; i < data.length; i++) {
      var managerName = String(data[i][0] || '').trim();
      var tagsRaw = String(data[i][1] || '').trim();
      if (!managerName || !tagsRaw) continue;
      
      var tags = [];
      if (tagsRaw.charAt(0) === '[') {
        try { tags = JSON.parse(tagsRaw); } catch(e) { tags = [tagsRaw]; }
      } else {
        tags = tagsRaw.split(',').map(function(t) { return t.trim(); });
      }
      
      if (!result.managerMapping[managerName]) result.managerMapping[managerName] = [];
      
      tags.forEach(function(tag) {
        var t = String(tag).toLowerCase().trim().replace(/"/g, '');
        if (t) {
          result.tagToManager[t] = managerName;
          result.managerMapping[managerName].push(t);
        }
      });
    }
    
    Logger.log('MANAGER mapping loaded: ' + Object.keys(result.tagToManager).length + ' tags ‚Üí ' + Object.keys(result.managerMapping).length + ' managers');
  } catch (e) {
    Logger.log('Error loading MANAGER mapping: ' + e);
  }
  return result;
}

/******************** RETENTION WEEKLY ********************/

/**
 * Get vocabulary mapping for metrics
 */
function getVocabulary() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var vocabSheet = ss.getSheetByName('VOCABULARY');
    
    if (!vocabSheet) {
      Logger.log('VOCABULARY sheet not found - using empty vocabulary');
      return {};
    }
    
    var data = vocabSheet.getDataRange().getValues();
    var vocabulary = {};
    
    Logger.log('=== Reading VOCABULARY Sheet ===');
    Logger.log('Total rows: ' + data.length);
    
    // Skip header row (row 0)
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      // Skip empty rows
      if (!row[0]) continue;
      
      var metricId = String(row[0]).trim();
      var metricName = row[1] ? String(row[1]).trim() : metricId;
      var metricType = row[2] ? String(row[2]).trim().toLowerCase() : '';
      var filterFlag = row[3] ? String(row[3]).trim().toLowerCase() : '';
      
      // Only add metrics with valid types
      if (metricType === 'dash sum' || metricType === 'dash count' || metricType === 'dash pie') {
        vocabulary[metricId] = {
          id: metricId,
          name: metricName,
          type: metricType,
          filter: filterFlag === 'filter' ? 'filter' : ''
        };
        
        Logger.log('Added metric: ' + metricId + ' ‚Üí ' + metricName + ' (' + metricType + ')' + (filterFlag === 'filter' ? ' [FILTER]' : ''));
      }
    }
    
    Logger.log('Vocabulary loaded: ' + Object.keys(vocabulary).length + ' metrics');
    return vocabulary;
    
  } catch (error) {
    Logger.log('ERROR reading vocabulary: ' + error.toString());
    return {};
  }
}


/**
 * Get VIP Dashboard data
 */
function getVIPDashboardData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    Logger.log('=== VIP Dashboard Data Loading ===');
    
    // Try new dynamic system first (with prefix)
    var dynamicData = getVIPGroupData('vip_dashboard');
    
    if (dynamicData && !dynamicData.error && dynamicData.players && dynamicData.players.length > 0) {
      Logger.log('Using dynamic system - found ' + dynamicData.players.length + ' players');
      
      // Split by vipType for metrics calculation
      var vipPlayers = [];
      var silentVipPlayers = [];
      
      dynamicData.players.forEach(function(player) {
        if (player.vipType === 'VIP') {
          vipPlayers.push(player);
        } else if (player.vipType === 'SILENT VIP') {
          silentVipPlayers.push(player);
        }
      });
      
      Logger.log('VIP players: ' + vipPlayers.length);
      Logger.log('Silent VIP players: ' + silentVipPlayers.length);
      
      // Calculate metrics
      var metrics = calculateVIPMetrics(vipPlayers, silentVipPlayers, dynamicData.vocabulary);
      Logger.log('Metrics calculated successfully');
      
      return {
        playerCounts: {
          vip: vipPlayers.length,
          silentVip: silentVipPlayers.length,
          total: dynamicData.players.length
        },
        metrics: metrics,
        vocabulary: dynamicData.vocabulary,
        allPlayers: {
          vip: vipPlayers,
          silentVip: silentVipPlayers
        }
      };
    }
    
    // Fallback to old system (sheets without prefix)
    Logger.log('Dynamic system not found, trying legacy sheet names...');
    var vipSheet = ss.getSheetByName('VIP');
    var silentVipSheet = ss.getSheetByName('SILENT VIP');
    
    Logger.log('VIP Sheet: ' + (vipSheet ? 'found' : 'NOT FOUND'));
    Logger.log('Silent VIP Sheet: ' + (silentVipSheet ? 'found' : 'NOT FOUND'));
    
    if (!vipSheet || !silentVipSheet) {
      return {
        error: 'VIP sheets not found. Please ensure sheets are named either:\n' +
               '1. "(VIP DASHBOARD) VIP" and "(VIP DASHBOARD) SILENT VIP" (recommended), or\n' +
               '2. "VIP" and "SILENT VIP" (legacy)'
      };
    }
    
    // Get vocabulary
    var vocabulary = getVocabulary();
    Logger.log('Vocabulary metrics count: ' + Object.keys(vocabulary).length);
    
    // Get VIP players
    var vipPlayers = getVIPSheetData(vipSheet);
    Logger.log('VIP players loaded: ' + vipPlayers.length);
    
    // Get SILENT VIP players
    var silentVipPlayers = getVIPSheetData(silentVipSheet);
    Logger.log('Silent VIP players loaded: ' + silentVipPlayers.length);
    
    if (vipPlayers.length === 0 && silentVipPlayers.length === 0) {
      return {
        error: 'No players found in VIP or SILENT VIP sheets'
      };
    }
    
    // Calculate metrics
    var metrics = calculateVIPMetrics(vipPlayers, silentVipPlayers, vocabulary);
    Logger.log('Metrics calculated successfully');
    
    // CRITICAL: Return allPlayers for client-side filtering (like Retention Rate)
    var result = {
      playerCounts: {
        vip: vipPlayers.length,
        silentVip: silentVipPlayers.length,
        total: vipPlayers.length + silentVipPlayers.length
      },
      vocabulary: vocabulary,
      metrics: metrics,
      allPlayers: {
        vip: vipPlayers,
        silentVip: silentVipPlayers
      }
    };
    
    Logger.log('=== VIP Dashboard Data Ready ===');
    Logger.log('Returning ' + result.allPlayers.vip.length + ' VIP + ' + result.allPlayers.silentVip.length + ' Silent VIP players');
    
    return result;
    
  } catch (error) {
    Logger.log('ERROR in getVIPDashboardData: ' + error.toString());
    return {
      error: 'Error loading VIP data: ' + error.toString()
    };
  }
}

/**
 * Calculate VIP metrics based on vocabulary
 */
function calculateVIPMetrics(vipPlayers, silentVipPlayers, vocabulary) {
  var allPlayers = vipPlayers.concat(silentVipPlayers);
  
  var metrics = {
    total: {
      count: allPlayers.length,
      vipCount: vipPlayers.length,
      silentVipCount: silentVipPlayers.length
    },
    sums: {},
    pies: {}
  };
  
  Logger.log('=== Calculating VIP Metrics ===');
  Logger.log('Total players: ' + allPlayers.length + ' (VIP: ' + vipPlayers.length + ', Silent: ' + silentVipPlayers.length + ')');
  
  var processedCount = 0;
  
  // Process each metric from vocabulary
  Object.keys(vocabulary).forEach(function(metricId) {
    var metric = vocabulary[metricId];
    var metricType = metric.type;
    
    // Only process dash sum, dash count, and dash pie
    if (metricType !== 'dash sum' && metricType !== 'dash count' && metricType !== 'dash pie') {
      return; // Skip this metric
    }
    
    processedCount++;
    
    if (metricType === 'dash pie') {
      // Calculate distribution for pie chart
      var totalDist = {};
      var vipDist = {};
      var silentDist = {};
      
      allPlayers.forEach(function(player) {
        var value = String(player[metricId] || 'Unknown').trim();
        if (value === '' || value === 'null') value = 'Unknown';
        totalDist[value] = (totalDist[value] || 0) + 1;
      });
      
      vipPlayers.forEach(function(player) {
        var value = String(player[metricId] || 'Unknown').trim();
        if (value === '' || value === 'null') value = 'Unknown';
        vipDist[value] = (vipDist[value] || 0) + 1;
      });
      
      silentVipPlayers.forEach(function(player) {
        var value = String(player[metricId] || 'Unknown').trim();
        if (value === '' || value === 'null') value = 'Unknown';
        silentDist[value] = (silentDist[value] || 0) + 1;
      });
      
      metrics.pies[metricId] = {
        name: metric.name || metricId,
        type: metricType,
        total: totalDist,
        vip: vipDist,
        silentVip: silentDist
      };
      
      Logger.log('Pie metric: ' + metricId + ' - Total categories: ' + Object.keys(totalDist).length);
    } else {
      // Calculate totals for sum/count metrics
      var totalSum = 0;
      var vipSum = 0;
      var silentVipSum = 0;
      
      // Sum for all players
      allPlayers.forEach(function(player) {
        var value = parseFloat(player[metricId]) || 0;
        totalSum += value;
      });
      
      // Sum for VIP only
      vipPlayers.forEach(function(player) {
        var value = parseFloat(player[metricId]) || 0;
        vipSum += value;
      });
      
      // Sum for Silent VIP only
      silentVipPlayers.forEach(function(player) {
        var value = parseFloat(player[metricId]) || 0;
        silentVipSum += value;
      });
      
      metrics.sums[metricId] = {
        name: metric.name || metricId,
        type: metricType,
        total: totalSum,
        vip: vipSum,
        silentVip: silentVipSum
      };
      
      Logger.log('Metric: ' + metricId + ' (' + metricType + ') - Total: ' + totalSum + ', VIP: ' + vipSum + ', Silent: ' + silentVipSum);
    }
  });
  
  Logger.log('Processed ' + processedCount + ' metrics from vocabulary');
  
  return metrics;
}

/**
 * Get VIP sheet data with ALL columns (including metrics)
 */
function getVIPSheetData(sheet) {
  var data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  
  var headers = data[0];
  var result = [];
  
  // Get all data starting from row 2
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var playerObj = {};
    
    // Map all columns
    for (var j = 0; j < headers.length; j++) {
      var header = String(headers[j]).trim();
      if (header) {
        var value = row[j];
        
        // Parse tags from JSON string to array
        if (header === 'tags' && value) {
          try {
            // If tags is a string like '["ann_vip","closed"]', parse it
            if (typeof value === 'string' && value.trim().startsWith('[')) {
              value = JSON.parse(value);
            }
            // If it's already an array, keep it
            else if (!Array.isArray(value)) {
              value = [];
            }
          } catch (e) {
            Logger.log('Failed to parse tags for player ' + (playerObj.id || i) + ': ' + e);
            value = [];
          }
        }
        
        playerObj[header] = value;
      }
    }
    
    // Only add if has id
    if (playerObj.id) {
      result.push(playerObj);
    }
  }
  
  Logger.log('getVIPSheetData: ' + result.length + ' players with ' + headers.length + ' columns');
  return result;
}

function getAllPlayersForFilters() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var allPlayers = [];
  var seen = {};
  
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    
    // Process both monthly and weekly ACTIVE sheets
    if (name.indexOf('ACTIVE') !== -1) {
      var data = getDetailedSheetData(sheet);
      data.forEach(function(player) {
        if (player.id && !seen[player.id]) {
          seen[player.id] = true;
          allPlayers.push({
            id: player.id,
            email: player.email,
            country: player.country,
            tags: player.tags,
            trafficType: player.trafficType || ''
          });
        }
      });
    }
  });
  
  Logger.log('getAllPlayersForFilters: ' + allPlayers.length + ' unique players');
  return allPlayers;
}

/**
 * Get filtered retention counts based on filters
 * @param {Object} params - {mode: 'monthly'|'weekly', filters: {vipType, manager, trafficType, country}}
 */
/**
 * Get filtered deposit counts based on filters
 * @param {Object} params - {filters: {vipType, manager, trafficType, country}}
 */
function getFilteredDepositCounts(params) {
  var filters = params.filters || {};
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var weekPattern = /^\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2}/;
  var ftdSheets = [];
  
  // Find monthly FTD sheets only
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    var isWeekly = weekPattern.test(name);
    
    if (!isWeekly && name.indexOf('FTD') !== -1 && name.indexOf('ACTIVE') === -1) {
      ftdSheets.push(sheet);
    }
  });
  
  ftdSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  var depositRanges = ['FTD', '2+', '3+', '4+', '5+', '6+', '7+', '8+', '9+', '10+', '11+', '12+'];
  
  var result = {
    months: [],
    rows: []
  };
  
  // Get month names
  ftdSheets.forEach(function(sheet) {
    var monthName = extractMonthName(sheet.getName());
    result.months.push(monthName);
  });
  
  // For each deposit range
  depositRanges.forEach(function(range) {
    var row = {
      range: range,
      cells: []
    };
    
    // For each month
    ftdSheets.forEach(function(ftdSheet) {
      var ftdData = getDetailedSheetData(ftdSheet);
      
      // Apply filters to all FTD players
      var ftdFiltered = ftdData.filter(function(p) {
        return matchesFilters(p, filters);
      });
      
      var ftdCount = ftdFiltered.length;
      
      // For deposit ranges
      if (range === 'FTD') {
        row.cells.push({
          count: ftdCount,
          pct: 1.0
        });
      } else {
        // Count players with deposits >= range
        var minDeposits = parseInt(range.replace('+', ''));
        var achievedCount = 0;
        
        ftdFiltered.forEach(function(player) {
          var deposits = player.deposits || 0;
          if (deposits >= minDeposits) {
            achievedCount++;
          }
        });
        
        row.cells.push({
          count: achievedCount,
          pct: ftdCount > 0 ? achievedCount / ftdCount : 0
        });
      }
    });
    
    result.rows.push(row);
  });
  
  return result;
}

function getFilteredRetentionCounts(params) {
  var mode = params.mode; // 'monthly' or 'weekly'
  var filters = params.filters || {};
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheets = [];
  var activeSheets = [];
  var weekPattern = /^\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2}/;
  
  // Find sheets based on mode
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    var isWeekly = weekPattern.test(name);
    
    if ((mode === 'weekly' && isWeekly) || (mode === 'monthly' && !isWeekly)) {
      if (name.indexOf('FTD') !== -1 && name.indexOf('ACTIVE') === -1) {
        ftdSheets.push(sheet);
      } else if (name.indexOf('ACTIVE') !== -1) {
        activeSheets.push(sheet);
      }
    }
  });
  
  ftdSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  activeSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  var result = {};
  
  // Set correct field names based on mode
  if (mode === 'weekly') {
    result.weeks = [];
    result.rows = [];
  } else {
    result.months = [];
    result.rows = [];
  }
  
  // Get period names
  activeSheets.forEach(function(sheet) {
    var periodName = mode === 'weekly' ? extractWeekName(sheet.getName()) : extractMonthName(sheet.getName());
    if (mode === 'weekly') {
      result.weeks.push(periodName);
    } else {
      result.months.push(periodName);
    }
  });
  
  // Calculate filtered retention for each FTD period
  ftdSheets.forEach(function(ftdSheet, ftdIdx) {
    var ftdName = ftdSheet.getName();
    var periodName = mode === 'weekly' ? extractWeekName(ftdName) : extractMonthName(ftdName);
    
    var ftdData = getDetailedSheetData(ftdSheet);
    
    // Apply filters to FTD players
    var ftdFiltered = ftdData.filter(function(p) {
      return matchesFilters(p, filters);
    });
    
    var ftdCount = ftdFiltered.length;
    var ftdPlayerIds = ftdFiltered.map(function(p) { return p.id; });
    
    var row = {};
    if (mode === 'weekly') {
      row.week = periodName;
    } else {
      row.month = periodName;
    }
    row.ftdCount = ftdCount;
    row.retention = [];
    
    // Calculate retention for each subsequent ACTIVE period
    for (var i = ftdIdx; i < activeSheets.length; i++) {
      var activeSheet = activeSheets[i];
      var activeData = getDetailedSheetData(activeSheet);
      
      // Filter active players
      var activeFiltered = activeData.filter(function(p) {
        return matchesFilters(p, filters);
      });
      
      var retainedCount = 0;
      ftdPlayerIds.forEach(function(ftdId) {
        var found = activeFiltered.some(function(p) {
          return p.id === ftdId;
        });
        if (found) retainedCount++;
      });
      
      row.retention.push({
        count: retainedCount,
        pct: ftdCount > 0 ? retainedCount / ftdCount : 0
      });
    }
    
    result.rows.push(row);
  });
  
  return result;
}

/**
 * Check if player matches filters
 */
function matchesFilters(player, filters) {
  // VIP Type filter
  if (filters.vipType && filters.vipType.length > 0) {
    var vipType = getVipTypeFromTags(player.tags);
    if (!filters.vipType.includes(vipType)) {
      return false;
    }
  }
  
  // Manager filter
  if (filters.manager && filters.manager.length > 0) {
    var manager = getManagerFromTags(player.tags);
    if (!filters.manager.includes(manager)) {
      return false;
    }
  }
  
  // Traffic Type filter
  if (filters.trafficType && filters.trafficType.length > 0) {
    if (!filters.trafficType.includes(player.trafficType || '')) {
      return false;
    }
  }
  
  // Country filter
  if (filters.country && filters.country.length > 0) {
    if (!filters.country.includes(player.country || '')) {
      return false;
    }
  }
  
  return true;
}

/**
 * Extract VIP type from tags
 */
function getVipTypeFromTags(tags) {
  if (!tags) return '';
  var t = String(tags).toLowerCase();
  if (t.indexOf('ann_vip') !== -1) return 'VIP';
  if (t.indexOf('ann') !== -1 && t.indexOf('vip') === -1) return 'Silent';
  if (t.indexOf('vip') !== -1 && t.indexOf('ann') === -1) return 'Super VIP';
  return '';
}

/**
 * Extract manager from tags
 */
function getManagerFromTags(tags) {
  if (!tags) return '';
  var t = String(tags).toLowerCase();
  if (t.indexOf('ann') !== -1) return 'Ann';
  if (t.indexOf('vlad') !== -1) return 'Vlad';
  if (t.indexOf('kate') !== -1) return 'Kate';
  if (t.indexOf('max') !== -1) return 'Max';
  return '';
}

function getWeeklyRetentionData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheets = [];
  var activeSheets = [];
  
  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ weekly sheets –∑–∞ —Ñ–æ—Ä–º–∞—Ç–æ–º DD.MM - DD.MM
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    // –§–æ—Ä–º–∞—Ç: 22.12 - 28.12 FTD –∞–±–æ 22.12 - 28.12 ACTIVE
    var weekPattern = /^\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2}/;
    
    if (weekPattern.test(name)) {
      if (name.indexOf('FTD') !== -1 && name.indexOf('ACTIVE') === -1) {
        ftdSheets.push(sheet);
      } else if (name.indexOf('ACTIVE') !== -1) {
        activeSheets.push(sheet);
      }
    }
  });
  
  // Helper —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É –¥–∞—Ç –∑ –Ω–∞–∑–≤ —Ç–∏–∂–Ω—ñ–≤
  function parseWeekDateBackend(weekStr) {
    var parts = weekStr.split('-');
    if (parts.length !== 2) return null;
    var startParts = parts[0].trim().split('.');
    if (startParts.length !== 2) return null;
    var day = parseInt(startParts[0]);
    var month = parseInt(startParts[1]);
    var now = new Date();
    var currentYear = now.getFullYear();
    // If month is in the future relative to current month, assume previous year
    var year = (month > now.getMonth() + 1) ? currentYear - 1 : currentYear;
    return new Date(year, month - 1, day);
  }
  
  // –°–æ—Ä—Ç—É—î–º–æ sheets –•–†–û–ù–û–õ–û–ì–Ü–ß–ù–û
  function sortSheetsByDate(sheetList) {
    return sheetList.sort(function(a, b) {
      var aWeek = extractWeekName(a.getName());
      var bWeek = extractWeekName(b.getName());
      var aDate = parseWeekDateBackend(aWeek);
      var bDate = parseWeekDateBackend(bWeek);
      if (!aDate || !bDate) return 0;
      return aDate - bDate;
    });
  }
  
  ftdSheets = sortSheetsByDate(ftdSheets);
  activeSheets = sortSheetsByDate(activeSheets);
  
  var result = {
    weeks: [],
    rows: []
  };
  
  // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–∑–≤–∏ —Ç–∏–∂–Ω—ñ–≤ –∑ ACTIVE sheets
  activeSheets.forEach(function(sheet) {
    var weekName = extractWeekName(sheet.getName());
    result.weeks.push(weekName);
  });
  
  // –î–ª—è –∫–æ–∂–Ω–æ–≥–æ FTD —Ç–∏–∂–Ω—è —Ä–∞—Ö—É—î–º–æ retention
  ftdSheets.forEach(function(ftdSheet, ftdIdx) {
    var ftdName = ftdSheet.getName();
    var weekName = extractWeekName(ftdName);
    
    var ftdData = getSheetData(ftdSheet);
    var ftdCount = ftdData.length;
    var ftdPlayerIds = ftdData.map(function(p) { return p.id; });
    
    var row = {
      week: weekName,
      ftdCount: ftdCount,
      retention: []
    };
    
    // –†–∞—Ö—É—î–º–æ retention –¥–ª—è –í–°–Ü–• —Ç–∏–∂–Ω—ñ–≤ (–∑ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ –¥–ª—è –º–∏–Ω—É–ª–æ–≥–æ)
    for (var i = 0; i < activeSheets.length; i++) {
      if (i < ftdIdx) {
        // –ú–∏–Ω—É–ª–∏–π —Ç–∏–∂–¥–µ–Ω—å - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
        row.retention.push({count: 0, pct: 0});
        continue;
      }
      
      var activeSheet = activeSheets[i];
      var activeData = getSheetData(activeSheet);
      
      var retainedCount = 0;
      ftdPlayerIds.forEach(function(ftdId) {
        var found = activeData.some(function(p) {
          return p.id === ftdId;
        });
        if (found) retainedCount++;
      });
      
      row.retention.push({
        count: retainedCount,
        pct: ftdCount > 0 ? retainedCount / ftdCount : 0
      });
    }
    
    result.rows.push(row);
  });
  
  return result;
}

function extractWeekName(sheetName) {
  // –í–∏—Ç—è–≥—É—î–º–æ –¥–∞—Ç–∏ –∑ —Ñ–æ—Ä–º–∞—Ç—É "22.12 - 28.12 FTD" –∞–±–æ "22.12 - 28.12 ACTIVE"
  var match = sheetName.match(/(\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2})/);
  if (match) {
    return match[1].trim();
  }
  return sheetName;
}


/******************** DEPOSIT CONVERSION ********************/

function getTrafficTypeMapping() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var generalSheet = ss.getSheetByName('GENERAL INFO');
  
  if (!generalSheet) {
    Logger.log('GENERAL INFO sheet not found');
    return {};
  }
  
  var data = generalSheet.getDataRange().getValues();
  var headers = data[0];
  
  var stagIdx = -1;
  var typeIdx = -1;
  
  for (var i = 0; i < headers.length; i++) {
    if (String(headers[i]).toLowerCase() === 'stag') stagIdx = i;
    if (String(headers[i]).toLowerCase() === 'type') typeIdx = i;
  }
  
  if (stagIdx === -1 || typeIdx === -1) {
    Logger.log('STAG or TYPE column not found in GENERAL INFO');
    Logger.log('Available headers: ' + headers.join(', '));
    return {};
  }
  
  var mapping = {};
  
  for (var i = 1; i < data.length; i++) {
    var stag = String(data[i][stagIdx] || '').trim();
    var type = String(data[i][typeIdx] || '').trim();
    
    if (stag && type) {
      // General Info already has clean stag (e.g. "74442")
      // Don't split - just store as is
      mapping[stag] = type;
    }
  }
  
  Logger.log('Traffic type mapping from GENERAL INFO: ' + JSON.stringify(mapping));
  return mapping;
}

function extractMonthNumber(sheetName) {
  var months = {
    'january': 1, 'jan': 1,
    'february': 2, 'feb': 2,
    'march': 3, 'mar': 3,
    'april': 4, 'apr': 4,
    'may': 5,
    'june': 6, 'jun': 6,
    'july': 7, 'jul': 7,
    'august': 8, 'aug': 8,
    'september': 9, 'sep': 9, 'sept': 9,
    'october': 10, 'oct': 10,
    'november': 11, 'nov': 11,
    'december': 12, 'dec': 12
  };
  
  var name = sheetName.toLowerCase();
  for (var month in months) {
    if (name.indexOf(month) !== -1) {
      return months[month];
    }
  }
  return 0;
}

function extractMonthName(sheetName) {
  var months = ['January', 'February', 'March', 'April', 'May', 'June', 
                'July', 'August', 'September', 'October', 'November', 'December'];
  var monthNum = extractMonthNumber(sheetName);
  return monthNum > 0 ? months[monthNum - 1] : sheetName;
}

function getRetentionData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheets = [];
  var activeSheets = [];
  
  var weekPattern = /^\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2}/;
  
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    if (weekPattern.test(name)) return;
    
    if (name.indexOf('FTD') !== -1 && name.indexOf('ACTIVE') === -1) {
      ftdSheets.push(sheet);
    } else if (name.indexOf('ACTIVE') !== -1) {
      activeSheets.push(sheet);
    }
  });
  
  ftdSheets.sort(function(a, b) { return sheets.indexOf(a) - sheets.indexOf(b); });
  activeSheets.sort(function(a, b) { return sheets.indexOf(a) - sheets.indexOf(b); });
  
  Logger.log('=== getRetentionData ===');
  Logger.log('FTD sheets: ' + ftdSheets.map(function(s) { return s.getName(); }).join(', '));
  Logger.log('ACTIVE sheets: ' + activeSheets.map(function(s) { return s.getName(); }).join(', '));
  
  var result = { months: [], rows: [] };
  
  activeSheets.forEach(function(sheet) {
    var monthName = extractMonthName(sheet.getName());
    result.months.push(monthName);
  });
  
  ftdSheets.forEach(function(ftdSheet, ftdIdx) {
    var ftdName = ftdSheet.getName();
    var ftdMonth = extractMonthName(ftdName);
    
    var ftdData = getSheetData(ftdSheet);
    var ftdCount = ftdData.length;
    var ftdPlayerIds = ftdData.map(function(p) { return p.id; });
    
    Logger.log('FTD "' + ftdName + '": ' + ftdCount + ' players, sample IDs: ' + ftdPlayerIds.slice(0, 3).join(', '));
    
    var row = { month: ftdMonth, ftdCount: ftdCount, retention: [] };
    
    for (var i = ftdIdx; i < activeSheets.length; i++) {
      var activeSheet = activeSheets[i];
      var activeData = getSheetData(activeSheet);
      
      var retainedCount = 0;
      ftdPlayerIds.forEach(function(ftdId) {
        var found = activeData.some(function(p) { return p.id === ftdId; });
        if (found) retainedCount++;
      });
      
      // Debug: log if 0 retained but both sheets have data
      if (retainedCount === 0 && ftdCount > 0 && activeData.length > 0) {
        Logger.log('‚ö†Ô∏è 0 retained: "' + ftdName + '" (' + ftdCount + ' players) vs "' + activeSheet.getName() + '" (' + activeData.length + ' players)');
        Logger.log('  FTD IDs sample: ' + ftdPlayerIds.slice(0, 3).join(', '));
        Logger.log('  ACTIVE IDs sample: ' + activeData.slice(0, 3).map(function(p) { return p.id; }).join(', '));
      }
      
      row.retention.push({
        count: retainedCount,
        pct: ftdCount > 0 ? retainedCount / ftdCount : 0
      });
    }
    
    result.rows.push(row);
  });
  
  return result;
}

function getDepositConversionData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheets = [];
  var activeSheets = [];
  
  // Weekly pattern: DD.MM - DD.MM
  var weekPattern = /^\d{2}\.\d{2}\s*-\s*\d{2}\.\d{2}/;
  
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    
    // Skip weekly sheets - only process monthly
    if (weekPattern.test(name)) {
      return; // Skip this sheet
    }
    
    if (name.indexOf('FTD') !== -1 && name.indexOf('ACTIVE') === -1) {
      ftdSheets.push(sheet);
    } else if (name.indexOf('ACTIVE') !== -1) {
      activeSheets.push(sheet);
    }
  });
  
  activeSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  var allActiveData = [];
  activeSheets.forEach(function(sheet) {
    allActiveData.push({
      name: sheet.getName(),
      data: getSheetData(sheet)
    });
  });
  
  Logger.log('Loaded ' + allActiveData.length + ' ACTIVE sheets');
  
  ftdSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  var depositRanges = ['FTD','2+','3+','4+','5+','6+','7+','8+','9+','10+',
    '11-15','16-20','21-25','26-30','31-40','41-50','50+'];
  
  var data = {months: [], rows: []};
  depositRanges.forEach(function(range) {
    data.rows.push({range: range, cells: []});
  });
  
  ftdSheets.forEach(function(ftdSheet) {
    var ftdName = ftdSheet.getName();
    var monthName = extractMonthName(ftdName);
    data.months.push(monthName);
    
    var ftdData = getSheetData(ftdSheet);
    var ftdCount = ftdData.length;
    
    data.rows[0].cells.push({count: ftdCount, total: ftdCount, pct: 1.0});
    
    if (allActiveData.length > 0) {
      for (var i = 1; i < depositRanges.length; i++) {
        var range = depositRanges[i];
        var parsed = parseDepositRange(range);
        var min = parsed.min;
        var max = parsed.max;
        
        var count = 0;
        
        for (var j = 0; j < ftdData.length; j++) {
          var ftdPlayerId = ftdData[j].id;
          var found = false;
          
          for (var k = 0; k < allActiveData.length && !found; k++) {
            var activeSheet = allActiveData[k];
            
            for (var m = 0; m < activeSheet.data.length; m++) {
              var player = activeSheet.data[m];
              
              if (player.id === ftdPlayerId) {
                var deposits = player.depositCount;
                var inRange = false;
                
                if (max === null) {
                  inRange = (deposits >= min);
                } else {
                  inRange = (deposits >= min && deposits <= max);
                }
                
                if (inRange) {
                  count++;
                  found = true;
                  break;
                }
              }
            }
          }
        }
        
        data.rows[i].cells.push({count: count, total: ftdCount, pct: ftdCount > 0 ? count / ftdCount : 0});
      }
    } else {
      for (var k = 1; k < depositRanges.length; k++) {
        data.rows[k].cells.push({count: 0, total: ftdCount, pct: 0});
      }
    }
  });
  
  return data;
}

function getSheetData(sheet) {
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  var idIdx = -1;
  var depositCountIdx = -1;
  
  for (var i = 0; i < headers.length; i++) {
    var h = String(headers[i] || '').toLowerCase().trim();
    if (h === 'id' && idIdx === -1) idIdx = i;
    if (h === 'lifetime_deposit_count_total') depositCountIdx = i;
  }
  
  if (idIdx === -1) {
    Logger.log('WARNING: getSheetData - no "id" column found in sheet: ' + sheet.getName() + ', headers: ' + headers.join(', '));
    return [];
  }
  
  var result = [];
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    if (!row[idIdx]) continue;
    
    result.push({
      id: String(row[idIdx]).trim(),
      depositCount: depositCountIdx !== -1 ? (Number(row[depositCountIdx]) || 0) : 0
    });
  }
  
  return result;
}

function parseDepositRange(range) {
  if (range.indexOf('-') !== -1) {
    var parts = range.split('-');
    return {min: parseInt(parts[0]), max: parseInt(parts[1])};
  } else if (range.indexOf('+') !== -1) {
    return {min: parseInt(range), max: null};
  }
  
  return {min: 0, max: null};
}

/**
 * ‚úÖ FIX: FTD DEDUPLICATION
 * –ö–æ–∂–µ–Ω –≥—Ä–∞–≤–µ—Ü—å —Ä–∞—Ö—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –û–î–ò–ù –†–ê–ó
 */
function getCellPlayers(params) {
  var month = params.month;
  var depositRange = params.depositRange;
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheetName = month.toUpperCase() + ' FTD';
  
  Logger.log('Looking for FTD: ' + ftdSheetName);
  
  var ftdSheet = ss.getSheetByName(ftdSheetName);
  
  if (!ftdSheet) {
    ftdSheetName = month.charAt(0).toUpperCase() + month.slice(1).toLowerCase() + ' FTD';
    ftdSheet = ss.getSheetByName(ftdSheetName);
  }
  
  if (!ftdSheet) {
    return {error: 'Sheet not found: ' + month + ' FTD (tried: ' + ftdSheetName + ')'};
  }
  
  var activeSheets = [];
  sheets.forEach(function(sheet) {
    var name = sheet.getName();
    if (name.indexOf('ACTIVE') !== -1) {
      activeSheets.push(sheet);
    }
  });
  
  activeSheets.sort(function(a, b) {
    return sheets.indexOf(a) - sheets.indexOf(b);
  });
  
  if (activeSheets.length === 0) {
    return {error: 'No ACTIVE sheets found in document'};
  }
  
  var allActiveData = [];
  activeSheets.forEach(function(sheet) {
    allActiveData.push({
      name: sheet.getName(),
      data: getDetailedSheetData(sheet)
    });
  });
  
  Logger.log('Loaded ' + allActiveData.length + ' ACTIVE sheets');
  
  var ftdData = ftdSheet.getDataRange().getValues();
  var ftdHeaders = ftdData[0];
  var ftdIdIdx = -1;
  
  for (var i = 0; i < ftdHeaders.length; i++) {
    if (ftdHeaders[i] === 'id') ftdIdIdx = i;
  }
  
  var ftdPlayerIds = [];
  for (var i = 1; i < ftdData.length; i++) {
    var id = String(ftdData[i][ftdIdIdx] || '').trim();
    if (id) ftdPlayerIds.push(id);
  }
  
  Logger.log('FTD player IDs: ' + ftdPlayerIds.length);
  
  if (depositRange === 'FTD') {
    // ‚úÖ FIX: DEDUPLICATE FTD PLAYERS
    var ftdAchieved = [];
    var seenPlayers = {}; // Track unique players
    
    ftdPlayerIds.forEach(function(playerId) {
      // Skip if already found
      if (seenPlayers[playerId]) return;
      
      for (var i = 0; i < allActiveData.length; i++) {
        var activeSheet = allActiveData[i];
        
        for (var j = 0; j < activeSheet.data.length; j++) {
          var player = activeSheet.data[j];
          
          if (player.id === playerId) {
            ftdAchieved.push({
              id: player.id,
              email: player.email,
              country: player.country,
              status: player.status,
              tags: player.tags || '',
              trafficType: player.trafficType || '',
              actualDeposits: player.depositCount,
              foundIn: activeSheet.name
            });
            seenPlayers[playerId] = true; // Mark as seen
            break;
          }
        }
        if (seenPlayers[playerId]) break; // Stop searching after found
      }
    });
    
    return {
      achieved: ftdAchieved,
      dropped: [],
      month: month,
      range: depositRange,
      total: ftdPlayerIds.length
    };
  }
  
  var parsed = parseDepositRange(depositRange);
  var min = parsed.min;
  var max = parsed.max;
  
  var achieved = [];
  var dropped = [];
  
  ftdPlayerIds.forEach(function(playerId) {
    var found = false;
    var playerInfo = null;
    
    for (var i = 0; i < allActiveData.length && !found; i++) {
      var activeSheet = allActiveData[i];
      
      for (var j = 0; j < activeSheet.data.length; j++) {
        var player = activeSheet.data[j];
        
        if (player.id === playerId) {
          var deposits = player.depositCount;
          var inRange = false;
          
          if (max === null) {
            inRange = (deposits >= min);
          } else {
            inRange = (deposits >= min && deposits <= max);
          }
          
          if (inRange) {
            achieved.push({
              id: player.id,
              email: player.email,
              country: player.country,
              status: player.status,
              tags: player.tags || '',
              trafficType: player.trafficType || '',
              actualDeposits: deposits,
              foundIn: activeSheet.name
            });
            found = true;
            break;
          } else {
            if (!playerInfo) {
              playerInfo = {
                id: player.id,
                email: player.email,
                country: player.country,
                status: player.status,
                tags: player.tags || '',
                trafficType: player.trafficType || '',
                actualDeposits: deposits,
                foundIn: activeSheet.name
              };
            }
          }
        }
      }
    }
    
    if (!found) {
      if (playerInfo) {
        dropped.push(playerInfo);
      }
    }
  });
  
  Logger.log('Result: ' + achieved.length + ' achieved, ' + dropped.length + ' dropped');
  
  return {
    achieved: achieved,
    dropped: dropped,
    month: month,
    range: depositRange,
    total: ftdPlayerIds.length
  };
}

function getDetailedSheetData(sheet) {
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  var idIdx = -1;
  var emailIdx = -1;
  var countryIdx = -1;
  var statusIdx = -1;
  var depositCountIdx = -1;
  var tagsIdx = -1;
  var stagIdx = -1;
  
  for (var i = 0; i < headers.length; i++) {
    var h = String(headers[i] || '').toLowerCase().trim();
    if (h === 'id' && idIdx === -1) idIdx = i;
    if (h === 'email' && emailIdx === -1) emailIdx = i;
    if (h === 'country' && countryIdx === -1) countryIdx = i;
    if (h === 'disabled') statusIdx = i;
    if (h === 'lifetime_deposit_count_total') depositCountIdx = i;
    if (h === 'tags') tagsIdx = i;
    if (h === 'stag') stagIdx = i;
  }
  
  var trafficMapping = getTrafficTypeMapping();
  
  var result = [];
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    if (!row[idIdx]) continue;
    
    var stag = stagIdx !== -1 ? String(row[stagIdx] || '') : '';
    var trafficType = '';
    if (stag) {
      var stagPrefix = stag.split('_')[0];
      trafficType = trafficMapping[stagPrefix] || '';
    }
    
    result.push({
      id: String(row[idIdx]).trim(),
      email: emailIdx !== -1 ? String(row[emailIdx] || '') : '',
      country: countryIdx !== -1 ? String(row[countryIdx] || '') : '',
      status: statusIdx !== -1 ? String(row[statusIdx] || 'none') : 'none',
      depositCount: depositCountIdx !== -1 ? Number(row[depositCountIdx]) || 0 : 0,
      tags: tagsIdx !== -1 ? String(row[tagsIdx] || '') : '',
      trafficType: trafficType
    });
  }
  
  return result;
}

function getCellPlayersRetention(params) {
  var ftdMonth = params.ftdMonth;
  var activeMonth = params.activeMonth;
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  
  var ftdSheetName = ftdMonth.toUpperCase() + ' FTD';
  var ftdSheet = ss.getSheetByName(ftdSheetName);
  
  if (!ftdSheet) {
    ftdSheetName = ftdMonth.charAt(0).toUpperCase() + ftdMonth.slice(1).toLowerCase() + ' FTD';
    ftdSheet = ss.getSheetByName(ftdSheetName);
  }
  
  if (!ftdSheet) {
    return {error: 'FTD sheet not found: ' + ftdMonth + ' FTD'};
  }
  
  var activeSheetName = activeMonth.toUpperCase() + ' ACTIVE';
  var activeSheet = ss.getSheetByName(activeSheetName);
  
  if (!activeSheet) {
    activeSheetName = activeMonth.charAt(0).toUpperCase() + activeMonth.slice(1).toLowerCase() + ' ACTIVE';
    activeSheet = ss.getSheetByName(activeSheetName);
  }
  
  if (!activeSheet) {
    return {error: 'ACTIVE sheet not found: ' + activeMonth + ' ACTIVE'};
  }
  
  var ftdData = ftdSheet.getDataRange().getValues();
  var ftdHeaders = ftdData[0];
  var ftdIdIdx = -1;
  var ftdEmailIdx = -1;
  var ftdCountryIdx = -1;
  var ftdTagsIdx = -1;
  
  for (var i = 0; i < ftdHeaders.length; i++) {
    var h = String(ftdHeaders[i] || '').toLowerCase().trim();
    if (h === 'id' && ftdIdIdx === -1) ftdIdIdx = i;
    if (h === 'email' && ftdEmailIdx === -1) ftdEmailIdx = i;
    if (h === 'country' && ftdCountryIdx === -1) ftdCountryIdx = i;
    if (h === 'tags') ftdTagsIdx = i;
  }
  
  var ftdPlayerIds = [];
  var ftdPlayersMap = {};
  for (var i = 1; i < ftdData.length; i++) {
    var id = ftdIdIdx !== -1 ? String(ftdData[i][ftdIdIdx] || '').trim() : '';
    if (id) {
      ftdPlayerIds.push(id);
      ftdPlayersMap[id] = {
        email: ftdEmailIdx !== -1 ? String(ftdData[i][ftdEmailIdx] || '') : '',
        country: ftdCountryIdx !== -1 ? String(ftdData[i][ftdCountryIdx] || '') : '',
        tags: ftdTagsIdx !== -1 ? String(ftdData[i][ftdTagsIdx] || '') : ''
      };
    }
  }
  
  var activePlayersData = getDetailedSheetData(activeSheet);
  
  var achieved = [];
  var dropped = [];
  
  ftdPlayerIds.forEach(function(ftdId) {
    var found = false;
    
    for (var i = 0; i < activePlayersData.length; i++) {
      if (activePlayersData[i].id === ftdId) {
        achieved.push({
          id: activePlayersData[i].id,
          email: activePlayersData[i].email,
          country: activePlayersData[i].country,
          status: activePlayersData[i].status,
          tags: activePlayersData[i].tags || '',
          trafficType: activePlayersData[i].trafficType || '',
          actualDeposits: activePlayersData[i].depositCount
        });
        found = true;
        break;
      }
    }
    
    if (!found) {
      var ftdInfo = ftdPlayersMap[ftdId] || {};
      dropped.push({
        id: ftdId,
        email: ftdInfo.email || '',
        country: ftdInfo.country || '',
        status: 'dropped',
        tags: ftdInfo.tags || '',
        trafficType: '',
        actualDeposits: 0
      });
    }
  });
  
  return {
    achieved: achieved,
    dropped: dropped,
    month: ftdMonth + ' ‚Üí ' + activeMonth,
    range: 'Retention',
    total: ftdPlayerIds.length
  };
}

/**
 * Get retention players for weekly periods
 */
function getCellPlayersRetentionWeekly(params) {
  var ftdWeek = params.ftdWeek;
  var activeWeek = params.activeWeek;
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Weekly sheets named like "29.12-04.01 FTD" and "29.12-04.01 ACTIVE"
  var ftdSheetName = ftdWeek + ' FTD';
  var ftdSheet = ss.getSheetByName(ftdSheetName);
  
  if (!ftdSheet) {
    return {error: 'FTD sheet not found: ' + ftdSheetName};
  }
  
  var activeSheetName = activeWeek + ' ACTIVE';
  var activeSheet = ss.getSheetByName(activeSheetName);
  
  if (!activeSheet) {
    return {error: 'ACTIVE sheet not found: ' + activeSheetName};
  }
  
  var ftdData = ftdSheet.getDataRange().getValues();
  var ftdHeaders = ftdData[0];
  var ftdIdIdx = -1;
  var ftdEmailIdx = -1;
  var ftdCountryIdx = -1;
  var ftdTagsIdx = -1;
  
  for (var i = 0; i < ftdHeaders.length; i++) {
    var h = String(ftdHeaders[i] || '').toLowerCase().trim();
    if (h === 'id' && ftdIdIdx === -1) ftdIdIdx = i;
    if (h === 'email' && ftdEmailIdx === -1) ftdEmailIdx = i;
    if (h === 'country' && ftdCountryIdx === -1) ftdCountryIdx = i;
    if (h === 'tags') ftdTagsIdx = i;
  }
  
  var ftdPlayerIds = [];
  var ftdPlayersMap = {};
  for (var i = 1; i < ftdData.length; i++) {
    var id = ftdIdIdx !== -1 ? String(ftdData[i][ftdIdIdx] || '').trim() : '';
    if (id) {
      ftdPlayerIds.push(id);
      ftdPlayersMap[id] = {
        email: ftdEmailIdx !== -1 ? String(ftdData[i][ftdEmailIdx] || '') : '',
        country: ftdCountryIdx !== -1 ? String(ftdData[i][ftdCountryIdx] || '') : '',
        tags: ftdTagsIdx !== -1 ? String(ftdData[i][ftdTagsIdx] || '') : ''
      };
    }
  }
  
  var activePlayersData = getDetailedSheetData(activeSheet);
  
  var achieved = [];
  var dropped = [];
  
  ftdPlayerIds.forEach(function(ftdId) {
    var found = false;
    
    for (var i = 0; i < activePlayersData.length; i++) {
      if (activePlayersData[i].id === ftdId) {
        achieved.push({
          id: activePlayersData[i].id,
          email: activePlayersData[i].email,
          country: activePlayersData[i].country,
          status: activePlayersData[i].status,
          tags: activePlayersData[i].tags || '',
          trafficType: activePlayersData[i].trafficType || '',
          actualDeposits: activePlayersData[i].depositCount
        });
        found = true;
        break;
      }
    }
    
    if (!found) {
      var ftdInfo = ftdPlayersMap[ftdId] || {};
      dropped.push({
        id: ftdId,
        email: ftdInfo.email || '',
        country: ftdInfo.country || '',
        status: 'dropped',
        tags: ftdInfo.tags || '',
        trafficType: '',
        actualDeposits: 0
      });
    }
  });
  
  return {
    achieved: achieved,
    dropped: dropped,
    week: ftdWeek + ' ‚Üí ' + activeWeek,
    range: 'Retention',
    total: ftdPlayerIds.length
  };
}

function createPlayersSheet(params) {
  var title = params.title;
  var achieved = params.achieved || [];
  var dropped = params.dropped || [];
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var tagsSheet = ss.getSheetByName('TAGS');
  var tagToManager = {};
  
  if (tagsSheet) {
    var tagsData = tagsSheet.getDataRange().getValues();
    for (var i = 1; i < tagsData.length; i++) {
      var tag = String(tagsData[i][0] || '').trim();
      var fullName = String(tagsData[i][1] || '').trim();
      
      if (tag && fullName) {
        var manager = '';
        if (fullName.indexOf('Silent ') === 0) {
          manager = fullName.substring(7).trim();
        } else if (fullName.indexOf('VIP ') === 0) {
          manager = fullName.substring(4).trim();
        } else {
          manager = fullName;
        }
        
        if (manager) {
          tagToManager[tag.toLowerCase()] = manager;
        }
      }
    }
  }
  
  function getManager(tags) {
    if (!tags) return '';
    var tagList = String(tags).toLowerCase().split(',');
    
    for (var i = 0; i < tagList.length; i++) {
      var tag = tagList[i].trim();
      if (tagToManager[tag]) {
        return tagToManager[tag];
      }
    }
    
    var tagsLower = String(tags).toLowerCase();
    if (tagsLower.indexOf('ann') !== -1) return 'Ann';
    if (tagsLower.indexOf('vlad') !== -1) return 'Vlad';
    if (tagsLower.indexOf('kate') !== -1) return 'Kate';
    if (tagsLower.indexOf('max') !== -1) return 'Max';
    
    return '';
  }
  
  function createBackofficeLink(playerId) {
    if (!playerId) return '';
    var id = String(playerId).replace('slotornado:', '').trim();
    return 'https://backoffice.slotornado-bivu.com/backend/players/' + id;
  }
  
  var timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm');
  var fileName = title + ' - ' + timestamp;
  var newFile = SpreadsheetApp.create(fileName);
  var newSheet = newFile.getSheets()[0];
  newSheet.setName('Players');
  
  var headers = ['Status', 'Email', 'ID', 'Country', 'Account Status', 'Link', 'Manager', 'Deposits'];
  var allData = [headers];
  
  achieved.forEach(function(p) {
    var status = String(p.status || 'none').toLowerCase() === 'none' ? 'active' : p.status;
    var link = createBackofficeLink(p.id);
    var manager = getManager(p.tags);
    
    allData.push([
      '‚úÖ Achieved',
      p.email || '',
      p.id || '',
      p.country || '',
      status,
      link,
      manager,
      p.actualDeposits || 0
    ]);
  });
  
  dropped.forEach(function(p) {
    var status = String(p.status || 'none').toLowerCase() === 'none' ? 'active' : p.status;
    var link = createBackofficeLink(p.id);
    var manager = getManager(p.tags);
    
    allData.push([
      '‚ùå Dropped',
      p.email || '',
      p.id || '',
      p.country || '',
      status,
      link,
      manager,
      p.actualDeposits || 0
    ]);
  });
  
  newSheet.getRange(1, 1, allData.length, headers.length).setValues(allData);
  
  newSheet.getRange(1, 1, 1, headers.length)
    .setBackground('#E8EAF6')
    .setFontColor('#1A237E')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');
  
  if (allData.length > 1) {
    var linkColumn = 6;
    for (var i = 2; i <= allData.length; i++) {
      var link = allData[i-1][linkColumn-1];
      if (link) {
        var safeLink = String(link).replace(/"/g, '""');
        newSheet.getRange(i, linkColumn).setFormula('=HYPERLINK("' + safeLink + '"; "Open")');
      }
    }
  }
  
  for (var i = 2; i <= allData.length; i++) {
    var statusCell = newSheet.getRange(i, 1);
    var statusValue = allData[i-1][0];
    
    if (statusValue === '‚úÖ Achieved') {
      statusCell.setBackground('#E8F5E9');
      statusCell.setFontColor('#2E7D32');
    } else {
      statusCell.setBackground('#FFEBEE');
      statusCell.setFontColor('#C62828');
    }
  }
  
  newSheet.setFrozenRows(1);
  
  for (var i = 1; i <= headers.length; i++) {
    newSheet.autoResizeColumn(i);
  }
  
  newSheet.getRange(1, 1, allData.length, headers.length)
    .setBorder(true, true, true, true, true, true, '#BDBDBD', SpreadsheetApp.BorderStyle.SOLID);
  
  return {
    success: true,
    sheetName: fileName,
    url: newFile.getUrl()
  };
}

/******************** KPI DASHBOARD ********************/

function diagnosticSheets() {
  var found = kpiFindSheetsForProject_();
  var allSheets = SpreadsheetApp.getActive().getSheets().map(function(s){ return s.getName(); });
  
  return {
    allSheets: allSheets,
    tabs: found
  };
}

function getWebAppUrl(){
  return kpiGetWebAppUrl();
}

function kpiGetWebAppUrl() {
  var hardcoded = 'https://script.google.com/a/macros/bets.io/s/AKfycbwm6zh3qw00OXpug7hqiLc79Szs5oaKlsj9rqqT-tTbINUho57yqolUb51fdSmcVlhP/exec';
  try {
    var url = ScriptApp.getService().getUrl();
    if (url) return url;
  } catch (e) {}
  var prop = PropertiesService.getScriptProperties().getProperty('KPI_WEBAPP_URL');
  if (prop) return prop;
  return hardcoded;
}

function kpiFindSheetsForProject_() {
  var sheets = SpreadsheetApp.getActive().getSheets();
  var tabsData = {};
  
  for (var i = 0; i < sheets.length; i++) {
    var name = sheets[i].getName();
    if (!name) continue;
    
    var up = String(name).toUpperCase();
    
    if (up.indexOf('SLOTORNADO') === -1) continue;
    
    var prefixMatch = name.match(/^\[([^\]]+)\]/);
    if (!prefixMatch) continue;
    
    var tab = prefixMatch[1].toUpperCase();
    
    if (!tabsData[tab]) {
      tabsData[tab] = { monthly: [], weekly: [] };
    }
    
    if (up.indexOf('MONTHLY') !== -1) {
      tabsData[tab].monthly.push(name);
    }
    if (up.indexOf('WEEKLY') !== -1) {
      tabsData[tab].weekly.push(name);
    }
  }
  
  return tabsData;
}

/**
 * ‚úÖ FIX: METRICS SHEET INTEGRATION
 */
function readMetricFormats() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var metricsSheet = ss.getSheetByName('METRICS');
    
    if (!metricsSheet) {
      return {};
    }
    
    var lastRow = metricsSheet.getLastRow();
    if (lastRow < 2) {
      return {};
    }
    
    var data = metricsSheet.getRange('A2:B' + lastRow).getValues();
    var formats = {};
    
    data.forEach(function(row) {
      var metricName = row[0];
      var format = row[1];
      
      if (metricName && format) {
        formats[metricName] = format;
      }
    });
    
    return formats;
  } catch (e) {
    Logger.log('Error in readMetricFormats: ' + e.toString());
    return {};
  }
}

/**
 * ‚úÖ FIX: Return metricFormats
 */
function kpiLoadProject() {
  try {
    var tabsFound = kpiFindSheetsForProject_();
    
    Logger.log('Found tabs: ' + JSON.stringify(Object.keys(tabsFound)));
    
    if (Object.keys(tabsFound).length === 0) {
      throw new Error('No [VIP] or [TOTAL] sheets found');
    }
    
    var result = { tabs: {} };
    
    for (var tab in tabsFound) {
      var sheets = tabsFound[tab];
      
      var mon = readMonthlyDynamicMulti_(sheets.monthly);
      var wk  = readWeeklyDynamicMulti_(sheets.weekly);

      var months = [];
      var ymKeys = {};
      Object.keys(mon.map).forEach(function(k){ ymKeys[k]=1; });
      Object.keys(wk.map).forEach(function(k){ ymKeys[k]=1; });

      Object.keys(ymKeys).sort().forEach(function(ym){
        var label = mon.map[ym] ? mon.map[ym].label : monthLabelFromYm_(ym);
        var monthly = emptyFromNames_(mergeNameSets_(mon.metrics));
        if (mon.map[ym]) copyAdd_(monthly, mon.map[ym].monthly);

        var weeksArr = [];
        if (wk.map[ym]) {
          var weekKeys = Object.keys(wk.map[ym]).map(function(s){return +s;}).sort(function(a,b){return a-b;});
          for (var i=0; i<weekKeys.length; i++){
            var ts  = weekKeys[i];
            var row = wk.map[ym][ts];
            var dIso = row && row.date ? String(row.date) : null;
            row.label = 'Week ' + (i+1) + (dIso ? (' (' + dIso + ')') : '');
            row.weekNo = (i+1);
            weeksArr.push(row);
          }
        }

        var sumWeeks = emptyFromNames_(mergeNameSets_(wk.metrics));
        weeksArr.forEach(function(w){ copyAdd_(sumWeeks, w.weekly); });

        months.push({ ym: ym, label: label, monthly: monthly, weeks: weeksArr, sumWeeks: sumWeeks });
      });

      var metricsObj = mergeNameSets_(mergeNameSets_(mon.metrics), wk.metrics);
      var metricsArr = Object.keys(metricsObj || {});
      var nonZero = {};
      metricsArr.forEach(function (m) { nonZero[m] = hasNonZero_(months, m); });
      
      Logger.log(tab + ': ' + metricsArr.length + ' metrics, ' + months.length + ' months');
      
      result.tabs[tab] = { metrics: metricsArr, months: months, nonZero: nonZero };
    }
    
    // ‚úÖ FIX: Read and return METRICS sheet
    var metricFormats = readMetricFormats();
    result.metricFormats = metricFormats;

    return result;
  } catch (e) {
    Logger.log('Error in kpiLoadProject: ' + e.toString());
    return {
      tabs: {},
      metricFormats: {},
      error: e.toString()
    };
  }
}

function readMonthlyDynamicMulti_(sheetNames){
  var total = { map: {}, metrics: {} };
  (sheetNames || []).forEach(function(name){
    var one = readMonthlyDynamic_(name);
    Object.keys(one.metrics||{}).forEach(function(k){ total.metrics[k]=1; });
    Object.keys(one.map||{}).forEach(function(ym){
      var box = total.map[ym] || (total.map[ym] = { label: one.map[ym].label, monthly: {} });
      copyAdd_(box.monthly, one.map[ym].monthly);
    });
  });
  return total;
}

function readWeeklyDynamicMulti_(sheetNames){
  var total = { map: {}, metrics: {} };
  (sheetNames || []).forEach(function(name){
    var one = readWeeklyDynamic_(name);
    Object.keys(one.metrics||{}).forEach(function(k){ total.metrics[k]=1; });
    Object.keys(one.map||{}).forEach(function(ym){
      var tMonth = total.map[ym] || (total.map[ym] = {});
      var sMonth = one.map[ym] || {};
      Object.keys(sMonth).forEach(function(ts){
        var src = sMonth[ts];
        var dst = tMonth[ts] || (tMonth[ts] = { label: src.label||'', ts: ts, weekly: {} });
        if (src.date) dst.date = src.date;
        copyAdd_(dst.weekly, src.weekly);
      });
    });
  });
  return total;
}

function readMonthlyDynamic_(sheetName){
  var sh = getSheetSafe_(sheetName); if (!sh) return {map:{}, metrics:{}};
  var values = sh.getDataRange().getValues(); if (!values.length) return {map:{}, metrics:{}};

  var head = values[0].map(function(h){ return String(h||'').trim(); });
  var norm = head.map(norm_);
  var rows = values.slice(1);

  var dateIdx   = firstIndex_(norm, ['month','period','date']);
  var metricIdx = detectMetricColumns_(rows, head, norm);

  var out = {}; var metrics = {};
  rows.forEach(function(r){
    var ym = ymFromAny_(r[dateIdx]); if (!ym) return;
    var box = out[ym] || (out[ym] = { label: monthLabelFromYm_(ym), monthly: {} });
    metricIdx.forEach(function(i){
      var name = head[i]; var val = toNumber_(r[i]); if (val == null) return;
      metrics[name]=1; box.monthly[name] = (box.monthly[name]||0) + val;
    });
  });
  return { map: out, metrics: metrics };
}

function readWeeklyDynamic_(sheetName){
  var sh = getSheetSafe_(sheetName); if (!sh) return {map:{}, metrics:{}};
  var values = sh.getDataRange().getValues(); if (!values.length) return {map:{}, metrics:{}};

  var head = values[0].map(function(h){ return String(h||'').trim(); });
  var norm = head.map(norm_);
  var rows = values.slice(1);

  var monthIdx = firstIndex_(norm, ['month','period','date']);
  var weekIdx  = findWeekDateColumn_(head, norm, rows);
  var metricIdx = detectMetricColumns_(rows, head, norm, true);

  var out = {}; var metrics = {}; var seqByYm = {};

  rows.forEach(function(r){
    var ym = ymFromAny_(r[monthIdx]); if (!ym) return;

    var d = dateFromAny_(r[weekIdx]);
    var ts;
    if (d) {
      d = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      ts = Math.floor(d.getTime()/1000);
    } else {
      var seq=(seqByYm[ym]||0)+1; seqByYm[ym]=seq;
      ts = pseudoTs_(ym+':'+seq);
    }

    var mbox = out[ym] || (out[ym] = {});
    var w = mbox[ts] || (mbox[ts] = { label: '', ts: ts, weekly: {} });
    if (d) w.date = isoDate_(d);

    metricIdx.forEach(function(i){
      var name = head[i]; var val = toNumber_(r[i]); if (val == null) return;
      metrics[name]=1; w.weekly[name] = (w.weekly[name]||0) + val;
    });
  });

  return { map: out, metrics: metrics };
}

function findWeekDateColumn_(head, norm, rows){
  var prefer = ['week start','start_of_week','week date','start date','monday','start'];
  for (var i=0;i<norm.length;i++){
    for (var j=0;j<prefer.length;j++){
      if (norm[i].indexOf(prefer[j]) !== -1 && columnLooksLikeDate_(rows, i)) return i;
    }
  }
  var candidates = [];
  for (var k=0;k<norm.length;k++){
    if (norm[k]==='week') continue;
    if (columnLooksLikeDate_(rows, k)) candidates.push(k);
  }
  return candidates.length ? candidates[0] : -1;
}

function columnLooksLikeDate_(rows, idx){
  if (idx<0) return false;
  var hits=0, total=0;
  for (var i=0;i<rows.length;i++){
    var v = rows[i][idx]; if (v==='' || v==null) continue;
    total++; if (dateFromAny_(v)) hits++;
  }
  return total>0 && hits/Math.max(total,1) >= 0.5;
}

function getSheetSafe_(name){ try { return SpreadsheetApp.getActive().getSheetByName(name) || null; } catch(e){ return null; } }
function norm_(s){ return String(s||'').toLowerCase().trim(); }

function firstIndex_(normHeaders, needlesArr){
  var needles = needlesArr.map(norm_);
  for (var i=0;i<normHeaders.length;i++){
    for (var j=0;j<needles.length;j++){
      if (normHeaders[i].indexOf(needles[j]) !== -1) return i;
    }
  } return -1;
}

function detectMetricColumns_(rows, head, norm, excludeWeekCols){
  var idx = [];
  for (var i=0;i<head.length;i++){
    var h = norm[i];
    if (h.indexOf('month')!==-1 || h.indexOf('period')!==-1 || h.indexOf('date')!==-1) continue;
    if (excludeWeekCols && (h.indexOf('week')!==-1 || h.indexOf('start')!==-1)) continue;
    if (h==='label' || h==='id' || h==='ym' || h==='ts') continue;

    var isMetric=false;
    for (var r=0;r<rows.length;r++){
      var v = rows[r][i];
      if (isNumberLike_(v)) { isMetric=true; break; }
    }
    if (isMetric) idx.push(i);
  }
  return idx;
}

function isNumberLike_(v){ if (v==null || v==='') return false; if (typeof v==='number') return isFinite(v);
  var s=String(v).replace(/[‚Ç¨,%\s,]/g,'').trim(); return s!=='' && !isNaN(+s); }
function toNumber_(v){ if (!isNumberLike_(v)) return null; if (typeof v==='number') return v;
  var s=String(v).replace(/[‚Ç¨,%\s,]/g,'').trim(); return Number(s)||0; }

function ymFromAny_(v){
  var d=dateFromAny_(v); if (d) return d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2);
  var s=String(v||'').trim(); var m=s.match(/^(\d{4})[-\/](\d{1,2})/);
  return m?(m[1]+'-'+('0'+m[2]).slice(-2)):null;
}

function dateFromAny_(v){
  if (Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v)) return v;
  var s=String(v||'').trim();
  var m;
  m=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/); if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  m=s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/); if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  return null;
}

function isoDate_(d){ return d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2)+'-'+('0'+d.getDate()).slice(-2); }
function monthLabelFromYm_(ym){
  var p=ym.split('-'); var y=+p[0], m=+p[1];
  var names=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return names[m-1]+' '+y;
}
function pseudoTs_(s){ var h=0; for (var i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return 1700000000 + (Math.abs(h)%1000000); }

function mergeNameSets_(objA, objB){
  var args = Array.prototype.slice.call(arguments), out = {};
  args.forEach(function(o){ if (!o) return; Object.keys(o).forEach(function(k){ out[k]=1; }); });
  return out;
}
function emptyFromNames_(namesObj){ var o={}; Object.keys(namesObj||{}).forEach(function(k){ o[k]=0; }); return o; }
function copyAdd_(dst, src){ Object.keys(src||{}).forEach(function(k){ dst[k]=(dst[k]||0)+Number(src[k]||0); }); }
function hasNonZero_(months, metric){
  for (var i=0;i<(months||[]).length;i++){
    var m=months[i];
    if (Number(m.monthly && m.monthly[metric])>0) return true;
    if (Number(m.sumWeeks && m.sumWeeks[metric])>0) return true;
    for (var j=0;j<(m.weeks||[]).length;j++){
      var w=m.weeks[j]; if (Number(w.weekly && w.weekly[metric])>0) return true;
    }
  } return false;
}

// ============================================
// VIP DASHBOARD FILTERS
// ============================================

function getFilteredVIPDashboardData(filters) {
  try {
    Logger.log('=== VIP Dashboard Filtered Data Loading ===');
    Logger.log('Filters: ' + JSON.stringify(filters));
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var vipSheet = ss.getSheetByName('VIP');
    var silentVipSheet = ss.getSheetByName('SILENT VIP');
    
    if (!vipSheet || !silentVipSheet) {
      return {
        error: 'VIP or SILENT VIP sheet not found. Please ensure sheets are named exactly "VIP" and "SILENT VIP".'
      };
    }
    
    var vocabulary = getVocabulary();
    var allVipPlayers = getVIPSheetData(vipSheet);
    var allSilentVipPlayers = getVIPSheetData(silentVipSheet);
    
    Logger.log('Total VIP players before filtering: ' + allVipPlayers.length);
    Logger.log('Total Silent VIP players before filtering: ' + allSilentVipPlayers.length);
    
    var filteredVipPlayers = filterVIPPlayers(allVipPlayers, filters, vocabulary);
    var filteredSilentVipPlayers = filterVIPPlayers(allSilentVipPlayers, filters, vocabulary);
    
    Logger.log('Filtered VIP players: ' + filteredVipPlayers.length);
    Logger.log('Filtered Silent VIP players: ' + filteredSilentVipPlayers.length);
    
    var metrics = calculateVIPMetrics(filteredVipPlayers, filteredSilentVipPlayers, vocabulary);
    
    var result = {
      playerCounts: {
        total: filteredVipPlayers.length + filteredSilentVipPlayers.length,
        vip: filteredVipPlayers.length,
        silentVip: filteredSilentVipPlayers.length
      },
      metrics: metrics,
      vocabulary: vocabulary,
      appliedFilters: filters
    };
    
    Logger.log('Filtered data result prepared successfully');
    return result;
    
  } catch (error) {
    Logger.log('ERROR in getFilteredVIPDashboardData: ' + error.toString());
    Logger.log('Stack trace: ' + error.stack);
    return {
      error: error.toString()
    };
  }
}

function filterVIPPlayers(players, filters, vocabulary) {
  if (!filters) return players;
  
  Logger.log('=== Filtering VIP Players ===');
  Logger.log('Initial count: ' + players.length);
  Logger.log('Filters: ' + JSON.stringify(filters));
  
  var filtered = players.filter(function(player) {
    // Manager filter (from tags)
    if (filters.manager && filters.manager.length > 0) {
      var playerManager = '';
      if (player.tags) {
        var tags = String(player.tags);
        var managerMatch = tags.match(/manager:([^,\]]+)/i);
        if (managerMatch) {
          playerManager = managerMatch[1].trim();
        }
      }
      if (!filters.manager.includes(playerManager)) {
        return false;
      }
    }
    
    // Traffic Type filter - try multiple field names
    if (filters.trafficType && filters.trafficType.length > 0) {
      var playerTraffic = player.trafficType || player.traffic_type || player.type || player.playerType || '';
      playerTraffic = String(playerTraffic).trim();
      if (!filters.trafficType.includes(playerTraffic)) {
        return false;
      }
    }
    
    // Country filter
    if (filters.country && filters.country.length > 0) {
      var playerCountry = String(player.country || '').trim();
      if (!filters.country.includes(playerCountry)) {
        return false;
      }
    }
    
    // Currency filter
    if (filters.currency && filters.currency.length > 0) {
      var playerCurrency = String(player.currency || '').trim();
      if (!filters.currency.includes(playerCurrency)) {
        return false;
      }
    }
    
    // Dynamic filters from Vocabulary
    for (var filterKey in filters) {
      if (filterKey !== 'manager' && filterKey !== 'trafficType' && 
          filterKey !== 'country' && filterKey !== 'currency') {
        
        var filterValues = filters[filterKey];
        if (filterValues && filterValues.length > 0) {
          var playerValue = String(player[filterKey] || '').trim();
          
          // Normalize gender values
          if (filterKey === 'gender') {
            var playerGender = playerValue.toLowerCase();
            var normalizedGender = '';
            if (playerGender === 'm' || playerGender === 'male') {
              normalizedGender = 'Male';
            } else if (playerGender === 'f' || playerGender === 'female') {
              normalizedGender = 'Female';
            } else {
              normalizedGender = 'Unknown';
            }
            playerValue = normalizedGender;
          }
          
          if (!filterValues.includes(playerValue)) {
            return false;
          }
        }
      }
    }
    
    return true;
  });
  
  Logger.log('Filtered count: ' + filtered.length);
  return filtered;
}

/**
 * Get manager mapping from TAGS sheet
 * Returns: { player_id: manager_name }
 */
/**
 * Get tag-to-manager mapping from TAGS sheet
 * Column A: tag (e.g. "ann_vip", "ann", "verified")
 * Column B: Type (e.g. "VIP", "Silent", "Super VIP")
 * Column C: Name (e.g. "Ann", "Kevin")
 * Returns: { tag: manager_name }
 * Example: { "ann_vip": "Ann", "ann": "Ann", "verified": "Kevin" }
 */
/**
 * Extract STAG prefix (before "_") from full stag
 * Example: "74494_69496e021b8271b5f7f" ‚Üí "74494"
 */
function getStagPrefix(fullStag) {
  if (!fullStag) return '';
  var stagStr = String(fullStag);
  var underscoreIdx = stagStr.indexOf('_');
  if (underscoreIdx > 0) {
    return stagStr.substring(0, underscoreIdx);
  }
  return stagStr;
}

/**
 * Scan all sheets and group them by prefix in parentheses
 * Returns config for dynamic VIP-style tabs
 * Example: "(VIP DASHBOARD) VIP" ‚Üí group: "VIP DASHBOARD", suffix: "VIP"
 */
function getVIPTabsConfig() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var allSheets = ss.getSheets();
    
    var groups = {};
    var regex = /^\(([^)]+)\)\s+(.+)$/; // Matches: (PREFIX) Suffix
    
    allSheets.forEach(function(sheet) {
      var name = sheet.getName();
      var match = name.match(regex);
      
      if (match) {
        var prefix = match[1].trim();      // "VIP DASHBOARD"
        var suffix = match[2].trim();      // "VIP" or "SILENT VIP"
        
        if (!groups[prefix]) {
          groups[prefix] = {
            sheets: [],
            displayName: toTitleCase(prefix.toLowerCase()),
            id: prefix.toLowerCase().replace(/\s+/g, '_')
          };
        }
        
        groups[prefix].sheets.push({
          fullName: name,
          suffix: suffix,
          sheetObject: sheet
        });
      }
    });
    
    Logger.log('=== VIP Tabs Config ===');
    Logger.log('Found ' + Object.keys(groups).length + ' tab groups');
    
    Object.keys(groups).forEach(function(prefix) {
      Logger.log('Group "' + prefix + '": ' + groups[prefix].sheets.length + ' sheets');
      groups[prefix].sheets.forEach(function(s) {
        Logger.log('  - ' + s.fullName);
      });
    });
    
    return groups;
    
  } catch (error) {
    Logger.log('ERROR in getVIPTabsConfig: ' + error.toString());
    return {};
  }
}

/**
 * Convert string to Title Case
 * "VIP DASHBOARD" ‚Üí "Vip Dashboard"
 */
function toTitleCase(str) {
  return str.replace(/\w\S*/g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });
}

/**
 * Get unified dashboard data from single DASHBOARD sheet.
 * Groups players by type (VIP/Previp/etc) detected from tags.
 * Falls back to old prefix-based system if DASHBOARD sheet not found.
 */
function getUnifiedDashboardData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var dashSheet = ss.getSheetByName('DASHBOARD');
    
    if (!dashSheet) {
      Logger.log('DASHBOARD sheet not found, falling back to prefix system');
      return getUnifiedFromPrefixSystem();
    }
    
    Logger.log('=== Reading DASHBOARD sheet ===');
    var allPlayers = getVIPSheetData(dashSheet);
    Logger.log('Total players in DASHBOARD: ' + allPlayers.length);
    
    var vocabulary = getVocabulary();
    var managerResult = getManagerMapping();
    var tagToManager = managerResult.tagToManager;
    var typeMappingResult = getTypeMapping();
    var tagToType = typeMappingResult.tagToType;
    
    Logger.log('TYPE mapping: ' + Object.keys(tagToType).length + ' tags ‚Üí ' + Object.keys(typeMappingResult.typeMapping).length + ' types');
    
    // Determine type for each player from tags using TYPE sheet
    var typeGroups = {};
    
    allPlayers.forEach(function(player) {
      var typeInfo = detectPlayerType(player.tags, tagToType);
      player.dashboardType = typeInfo.type;
      player.vipType = typeInfo.subType || typeInfo.type;
      
      if (!typeGroups[typeInfo.type]) typeGroups[typeInfo.type] = [];
      typeGroups[typeInfo.type].push(player);
    });
    
    var typeNames = Object.keys(typeGroups).sort();
    Logger.log('Detected types: ' + typeNames.join(', '));
    
    // Build result for each type
    var typesData = {};
    typeNames.forEach(function(typeName) {
      var players = typeGroups[typeName];
      var metrics = calculateVIPMetrics(players, [], vocabulary);
      
      typesData[typeName] = {
        groupId: typeName.toLowerCase().replace(/\s+/g, '_'),
        displayName: typeName,
        metrics: metrics,
        vocabulary: vocabulary,
        playerCounts: { vip: players.length, silentVip: 0, total: players.length },
        allPlayers: { vip: players, silentVip: [] }
      };
    });
    
    return {
      source: 'DASHBOARD',
      types: typeNames,
      typesData: typesData,
      vocabulary: vocabulary,
      managerMapping: tagToManager,
      managers: Object.keys(managerResult.managerMapping).sort(),
      typeMapping: typeMappingResult.typeMapping
    };
    
  } catch (error) {
    Logger.log('ERROR in getUnifiedDashboardData: ' + error.toString());
    return { error: error.toString() };
  }
}

/**
 * Fall back: build unified data from old prefix-based sheets
 */
function getUnifiedFromPrefixSystem() {
  var config = getVIPTabsConfig();
  var prefixes = Object.keys(config).sort();
  
  if (prefixes.length === 0) {
    return { error: 'No DASHBOARD sheet and no (PREFIX) sheets found' };
  }
  
  var vocabulary = getVocabulary();
  var managerResult = getManagerMapping();
  var typesData = {};
  var typeNames = [];
  
  prefixes.forEach(function(prefix) {
    var group = config[prefix];
    var groupId = group.id;
    var displayName = group.displayName;
    
    var groupPlayers = [];
    group.sheets.forEach(function(sheetInfo) {
      var players = getVIPSheetData(sheetInfo.sheetObject);
      players.forEach(function(p) {
        p.vipType = sheetInfo.suffix;
        p.sourceSheet = sheetInfo.fullName;
      });
      groupPlayers = groupPlayers.concat(players);
    });
    
    // Split into vip/silentVip based on suffix
    var vipP = [], silentP = [];
    groupPlayers.forEach(function(p) {
      if (String(p.vipType || '').toLowerCase().indexOf('silent') >= 0) silentP.push(p);
      else vipP.push(p);
    });
    
    var metrics = calculateVIPMetrics(vipP, silentP, vocabulary);
    
    typeNames.push(displayName);
    typesData[displayName] = {
      groupId: groupId,
      displayName: displayName,
      metrics: metrics,
      vocabulary: vocabulary,
      playerCounts: { vip: vipP.length, silentVip: silentP.length, total: groupPlayers.length },
      allPlayers: { vip: vipP, silentVip: silentP }
    };
  });
  
  return {
    source: 'PREFIX',
    types: typeNames,
    typesData: typesData,
    vocabulary: vocabulary,
    managerMapping: managerResult.tagToManager,
    managers: Object.keys(managerResult.managerMapping).sort()
  };
}

/**
 * Detect player type from tags using TYPE sheet mapping
 */
function detectPlayerType(tags, tagToType) {
  var result = { type: 'Other', subType: '' };
  if (!tags || !Array.isArray(tags) || !tagToType) return result;
  
  for (var i = 0; i < tags.length; i++) {
    var tag = String(tags[i]).toLowerCase().trim();
    if (tagToType[tag]) {
      return { type: tagToType[tag], subType: tagToType[tag] };
    }
  }
  
  return result;
}

/**
 * Get data for a specific VIP-style tab group
 * @param {string} groupId - ID of the group (e.g. "vip_dashboard", "one_day")
 */
function getVIPGroupData(groupId) {
  try {
    var config = getVIPTabsConfig();
    var group = null;
    
    // Find group by ID
    Object.keys(config).forEach(function(prefix) {
      if (config[prefix].id === groupId) {
        group = config[prefix];
      }
    });
    
    if (!group) {
      return { error: 'Group not found: ' + groupId };
    }
    
    var allPlayers = [];
    
    // Collect data from all sheets in this group
    group.sheets.forEach(function(sheetInfo) {
      var sheet = sheetInfo.sheetObject;
      var players = getVIPSheetData(sheet);
      
      // Add vipType based on suffix
      players.forEach(function(player) {
        player.vipType = sheetInfo.suffix; // "VIP" or "SILENT VIP"
        player.sourceSheet = sheetInfo.fullName;
      });
      
      allPlayers = allPlayers.concat(players);
    });
    
    Logger.log('getVIPGroupData(' + groupId + '): ' + allPlayers.length + ' total players');
    
    // Get vocabulary
    var vocabulary = getVocabulary();
    
    // Split players by vipType for metrics calculation
    var vipPlayers = [];
    var silentVipPlayers = [];
    
    allPlayers.forEach(function(player) {
      // Categorize by vipType:
      // If contains "silent" ‚Üí Silent VIP category
      // Otherwise ‚Üí VIP category
      var type = String(player.vipType || '').toLowerCase();
      
      if (type.indexOf('silent') >= 0) {
        silentVipPlayers.push(player);
      } else {
        vipPlayers.push(player);
      }
    });
    
    Logger.log('Players split: VIP=' + vipPlayers.length + ', Silent/Pre=' + silentVipPlayers.length);
    
    // Calculate metrics
    var metrics = calculateVIPMetrics(vipPlayers, silentVipPlayers, vocabulary);
    
    return {
      groupId: groupId,
      displayName: group.displayName,
      sheets: group.sheets.map(function(s) { return s.fullName; }),
      players: allPlayers,
      playerCounts: {
        vip: vipPlayers.length,
        silentVip: silentVipPlayers.length,
        total: allPlayers.length
      },
      metrics: metrics,
      vocabulary: vocabulary,
      allPlayers: {
        vip: vipPlayers,
        silentVip: silentVipPlayers
      }
    };
    
  } catch (error) {
    Logger.log('ERROR in getVIPGroupData: ' + error.toString());
    return { error: error.toString() };
  }
}

function getVIPFilterOptions() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var allPlayers = [];
    
    // 1. Try DASHBOARD sheet first
    var dashSheet = ss.getSheetByName('DASHBOARD');
    if (dashSheet) {
      Logger.log('=== VIP Filter Options (DASHBOARD sheet) ===');
      allPlayers = getVIPSheetData(dashSheet);
    } else {
      // 2. Try dynamic prefix system
      var groupData = getVIPGroupData('vip_dashboard');
      if (groupData && !groupData.error && groupData.players) {
        Logger.log('=== VIP Filter Options (Dynamic System) ===');
        allPlayers = groupData.players;
      } else {
        // 3. Legacy system
        Logger.log('=== VIP Filter Options (Legacy System) ===');
        var vipSheet = ss.getSheetByName('VIP');
        var silentVipSheet = ss.getSheetByName('SILENT VIP');
        if (vipSheet) allPlayers = allPlayers.concat(getVIPSheetData(vipSheet));
        if (silentVipSheet) allPlayers = allPlayers.concat(getVIPSheetData(silentVipSheet));
      }
    }
    
    Logger.log('Total players for filters: ' + allPlayers.length);
    
    // Get mappings from MANAGER sheet and General Info
    var managerResult = getManagerMapping();
    var managerMapping = managerResult.tagToManager || {}; // ‚úÖ flat {tag: manager}
    var trafficMapping = getTrafficTypeMapping();
    
    Logger.log('Manager mapping size: ' + Object.keys(managerMapping).length);
    Logger.log('Traffic mapping size: ' + Object.keys(trafficMapping).length);
    
    var managers = {};
    var trafficTypes = {};
    var playersWithManagers = 0;
    
    // Helper: Get player's manager from tags with priority
    function getPlayerManager(tags, mapping) {
      if (!tags || !Array.isArray(tags)) return null;
      var matches = [];
      for (var i = 0; i < tags.length; i++) {
        var tag = String(tags[i]).trim();
        if (mapping[tag]) {
          matches.push({ tag: tag, manager: mapping[tag], priority: tag.length });
        }
      }
      if (matches.length === 0) return null;
      matches.sort(function(a, b) { return b.priority - a.priority; });
      return { manager: matches[0].manager, tag: matches[0].tag };
    }
    
    // Process all players
    allPlayers.forEach(function(player) {
      if (player.tags && Array.isArray(player.tags)) {
        var result = getPlayerManager(player.tags, managerMapping);
        if (result) {
          managers[result.manager] = true;
          playersWithManagers++;
        }
      }
      if (player.stag) {
        var stagPrefix = getStagPrefix(player.stag);
        if (stagPrefix && trafficMapping[stagPrefix]) {
          trafficTypes[trafficMapping[stagPrefix]] = true;
        }
      }
    });
    
    Logger.log('Players with managers: ' + playersWithManagers + ' / ' + allPlayers.length);
    
    var managersList = Object.keys(managers).sort();
    var trafficTypesList = Object.keys(trafficTypes).sort();
    
    Logger.log('Managers: ' + managersList.join(', '));
    Logger.log('Traffic types: ' + trafficTypesList.join(', '));
    
    return {
      managers: managersList,
      trafficTypes: trafficTypesList,
      managerMapping: managerMapping,
      trafficMapping: trafficMapping
    };
    
  } catch (error) {
    Logger.log('ERROR in getVIPFilterOptions: ' + error.toString());
    return { error: error.toString() };
  }
}
/**
 * Create a new Google Sheet with exported data from modal
 */
function createExportSheet(sheetName, data) {
  try {
    // Create new spreadsheet
    var ss = SpreadsheetApp.create(sheetName + ' - Export');
    var sheet = ss.getActiveSheet();
    sheet.setName('Data');
    
    // Write data
    if (data && data.length > 0) {
      sheet.getRange(1, 1, data.length, data[0].length).setValues(data);
      
      // Format header row
      var headerRange = sheet.getRange(1, 1, 1, data[0].length);
      headerRange.setBackground('#667eea');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      
      // Auto-resize columns
      for (var i = 1; i <= data[0].length; i++) {
        sheet.autoResizeColumn(i);
      }
      
      // Freeze header row
      sheet.setFrozenRows(1);
      
      // Add filters
      sheet.getRange(1, 1, data.length, data[0].length).createFilter();
      
      Logger.log('Created export sheet: ' + ss.getUrl());
    }
    
    return ss.getUrl();
    
  } catch (error) {
    Logger.log('ERROR in createExportSheet: ' + error.toString());
    throw new Error('Failed to create export sheet: ' + error.message);
  }
}

/*************************************************
 * PLAYER PROFILING - –î–û–î–ê–ù–û
 *************************************************/
function getPlayerProfilingData() {
  var output = { players: [], fieldConfig: {}, managerMapping: {}, success: false, error: null };
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    Logger.log('=== getPlayerProfilingData START ===');
    
    // ‚úÖ Read single PROFILING sheet
    var sheet = ss.getSheetByName('PROFILING') || ss.getSheetByName('[PROFILING]');
    
    if (!sheet) {
      Logger.log('ERROR: PROFILING sheet not found');
      output.error = 'PROFILING sheet not found';
      return output;
    }
    
    var allData = sheet.getDataRange().getValues();
    
    if (allData.length < 2) {
      output.success = true;
      Logger.log('PROFILING sheet is empty');
      return output;
    }
    
    var headerRow = allData[0];
    var emailColumnIndex = -1;
    var tagsColumnIndex = -1;
    
    for (var h = 0; h < headerRow.length; h++) {
      var headerText = String(headerRow[h] || '').toLowerCase().trim();
      if (headerText.indexOf('email') !== -1 && emailColumnIndex === -1) emailColumnIndex = h;
      if (headerText === 'tags' || headerText === 'tag') tagsColumnIndex = h;
    }
    
    if (emailColumnIndex === -1) {
      Logger.log('WARNING: No email column in PROFILING sheet');
      output.error = 'No email column found';
      return output;
    }
    
    // Read all players
    for (var r = 1; r < allData.length; r++) {
      var rowData = allData[r];
      var playerEmail = String(rowData[emailColumnIndex] || '').trim();
      if (!playerEmail) continue;
      
      var playerObject = { email: playerEmail, _rowIndex: r + 1 }; // r+1 = 1-based sheet row
      
      for (var c = 0; c < headerRow.length; c++) {
        var fieldName = String(headerRow[c] || '').trim();
        if (!fieldName) continue;
        
        var cellValue = rowData[c];
        
        // Sanitize Date objects
        if (Object.prototype.toString.call(cellValue) === '[object Date]') {
          cellValue = isNaN(cellValue.getTime()) ? '' : Utilities.formatDate(cellValue, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        }
        
        // Parse tags column
        if (c === tagsColumnIndex && cellValue) {
          try {
            if (typeof cellValue === 'string') {
              var trimmed = cellValue.trim();
              if (trimmed.charAt(0) === '[') {
                cellValue = JSON.parse(trimmed);
              } else if (trimmed.length > 0) {
                cellValue = [trimmed];
              } else {
                cellValue = [];
              }
            } else if (!Array.isArray(cellValue)) {
              cellValue = [];
            }
          } catch (e) { cellValue = []; }
        }
        
        // Ensure serializable
        if (cellValue !== null && cellValue !== undefined 
            && typeof cellValue !== 'string' 
            && typeof cellValue !== 'number' 
            && typeof cellValue !== 'boolean'
            && !Array.isArray(cellValue)) {
          cellValue = String(cellValue);
        }
        
        playerObject[fieldName] = (cellValue === undefined) ? '' : cellValue;
      }
      
      output.players.push(playerObject);
    }
    
    Logger.log('PROFILING: ' + output.players.length + ' players loaded');
    
    // ‚úÖ Load MANAGER mapping
    var mgrResult = getManagerMapping();
    output.managerMapping = mgrResult;
    
    // ‚úÖ Load ATTENTION rules
    output.attentionRules = getAttentionRules();
    
    output.success = true;
    
    // ‚úÖ BUILD fieldConfig from headers
    if (output.players.length > 0) {
      var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      var sections = {};
      var order = [];
      var allPlayers = output.players;
      
      // Read Data Validation for dropdown detection
      var dataValidations = null;
      try {
        if (sheet.getLastRow() >= 2) {
          dataValidations = sheet.getRange(2, 1, 1, sheet.getLastColumn()).getDataValidations()[0];
        }
      } catch(dvErr) {
        Logger.log('Warning: Could not read data validations: ' + dvErr);
      }
      
      for (var hi = 0; hi < headers.length; hi++) {
        var rawHeader = String(headers[hi] || '').trim();
        if (!rawHeader) continue;
        
        var lowerHeader = rawHeader.toLowerCase();
        if (lowerHeader === 'tags' || lowerHeader === 'tag') continue;
        
        var isPreview = rawHeader.charAt(0) === '*';
        var isPrevColumn = rawHeader.indexOf('[PREV]') !== -1;
        var cleanHeader = rawHeader;
        if (isPreview) cleanHeader = cleanHeader.substring(1).trim();
        if (isPrevColumn) cleanHeader = cleanHeader.replace(/\[PREV\]/gi, '').trim();
        
        var sectionName = 'General';
        var sectionMatch = cleanHeader.match(/^(.+?)\s*\(([^)]+)\)\s*$/);
        if (sectionMatch) {
          cleanHeader = sectionMatch[1].trim();
          sectionName = sectionMatch[2].trim();
        }
        
        var fieldType = 'text';
        var fieldOptions = null;
        
        if (lowerHeader.indexOf('birthday') !== -1 || lowerHeader.indexOf('dob') !== -1 || lowerHeader.indexOf('birth date') !== -1 || lowerHeader.indexOf('date') !== -1) {
          fieldType = 'date';
        }
        
        // Method 1: Google Sheets Data Validation
        if (dataValidations && dataValidations[hi]) {
          var dv = dataValidations[hi];
          var criteriaType = dv.getCriteriaType();
          if (criteriaType === SpreadsheetApp.DataValidationCriteria.VALUE_IN_LIST) {
            var args = dv.getCriteriaValues();
            if (args && args[0] && Array.isArray(args[0]) && args[0].length > 0) {
              fieldType = 'dropdown';
              fieldOptions = args[0].map(function(v) { return String(v); });
            }
          } else if (criteriaType === SpreadsheetApp.DataValidationCriteria.VALUE_IN_RANGE) {
            try {
              var args = dv.getCriteriaValues();
              if (args && args[0]) {
                var rangeValues = args[0].getValues();
                fieldOptions = [];
                for (var rv = 0; rv < rangeValues.length; rv++) {
                  var val = String(rangeValues[rv][0] || '').trim();
                  if (val) fieldOptions.push(val);
                }
                if (fieldOptions.length > 0) fieldType = 'dropdown';
              }
            } catch(rangeErr) {}
          }
        }
        
        // Method 2: Fallback - analyze column values
        if (fieldType === 'text') {
          var skipDropdown = lowerHeader.indexOf('email') !== -1 
            || lowerHeader.indexOf('comment') !== -1 
            || lowerHeader.indexOf('photo') !== -1
            || lowerHeader.indexOf('upload') !== -1
            || lowerHeader.indexOf('[icon]') !== -1
            || lowerHeader.indexOf('[bicon]') !== -1
            || lowerHeader.indexOf('link') !== -1
            || lowerHeader.indexOf('url') !== -1
            || lowerHeader.indexOf('note') !== -1
            || lowerHeader.indexOf('name') !== -1
            || lowerHeader.indexOf('id') !== -1
            || fieldType === 'date';
          
          if (!skipDropdown && allPlayers.length > 3) {
            var uniqueVals = {};
            var nonEmptyCount = 0;
            for (var pi = 0; pi < allPlayers.length; pi++) {
              var val = allPlayers[pi][rawHeader];
              if (val !== null && val !== undefined && String(val).trim() !== '') {
                nonEmptyCount++;
                var strVal = String(val).trim();
                if (strVal.length <= 50) uniqueVals[strVal] = (uniqueVals[strVal] || 0) + 1;
              }
            }
            var uniqueCount = Object.keys(uniqueVals).length;
            if (uniqueCount >= 2 && uniqueCount <= 20 && nonEmptyCount > uniqueCount) {
              fieldType = 'dropdown';
              fieldOptions = Object.keys(uniqueVals).sort();
            }
          }
        }
        
        var fieldKey = rawHeader;
        output.fieldConfig[fieldKey] = {
          label: cleanHeader,
          type: fieldType,
          section: sectionName,
          preview: isPrevColumn,
          starred: isPreview
        };
        if (fieldOptions) output.fieldConfig[fieldKey].options = fieldOptions;
        
        order.push(fieldKey);
        if (!sections[sectionName]) sections[sectionName] = [];
        sections[sectionName].push(fieldKey);
      }
      
      output.fieldConfig._order = order;
      output.fieldConfig._sections = sections;
      
      Logger.log('fieldConfig built: ' + order.length + ' fields, ' + Object.keys(sections).length + ' sections');
    }
    
    Logger.log('=== getPlayerProfilingData END: ' + output.players.length + ' players ===');
  } catch (mainError) {
    Logger.log('ERROR in getPlayerProfilingData: ' + mainError.toString());
    Logger.log('Stack: ' + (mainError.stack || 'no stack'));
    output.error = mainError.toString();
  }
  
  return output;
}

/**
 * Update player data in PROFILING sheet
 */
function updatePlayerProfiling(data) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetName = data.sheetName || 'PROFILING';
  var sheet = ss.getSheetByName(sheetName) || ss.getSheetByName('[PROFILING]');
  
  if (!sheet) throw new Error('Sheet "' + sheetName + '" not found');
  
  var rowIndex = data.rowIndex;
  if (!rowIndex || rowIndex < 2) throw new Error('Invalid row index: ' + rowIndex);
  
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  Logger.log('updatePlayerProfiling: row=' + rowIndex + ', sheet=' + sheetName);
  
  for (var c = 0; c < headers.length; c++) {
    var headerRaw = String(headers[c] || '').trim();
    if (!headerRaw) continue;
    
    var headerLower = headerRaw.toLowerCase();
    if (headerLower === 'tags' || headerLower === 'tag') continue; // Don't overwrite tags
    
    // Try exact match first, then case-insensitive
    var value = undefined;
    if (data.hasOwnProperty(headerRaw)) {
      value = data[headerRaw];
    } else {
      // Try matching by original keys (case-insensitive)
      var dataKeys = Object.keys(data);
      for (var k = 0; k < dataKeys.length; k++) {
        if (dataKeys[k].toLowerCase().trim() === headerLower) {
          value = data[dataKeys[k]];
          break;
        }
      }
    }
    
    if (value !== undefined && value !== null) {
      sheet.getRange(rowIndex, c + 1).setValue(value);
    }
  }
  
  Logger.log('‚úÖ Player updated at row ' + rowIndex);
  return { success: true, row: rowIndex };
}

/**
 * Delete player from PROFILING sheet by email
 */
function deletePlayer(playerEmail) {
  if (!playerEmail) throw new Error('No email provided');
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('PROFILING') || ss.getSheetByName('[PROFILING]');
  
  if (!sheet) throw new Error('PROFILING sheet not found');
  
  var allData = sheet.getDataRange().getValues();
  var headers = allData[0];
  
  // Find email column
  var emailCol = -1;
  for (var h = 0; h < headers.length; h++) {
    if (String(headers[h] || '').toLowerCase().trim().indexOf('email') !== -1) {
      emailCol = h;
      break;
    }
  }
  
  if (emailCol === -1) throw new Error('Email column not found');
  
  // Find player row (search from bottom to avoid index shift issues)
  var targetEmail = playerEmail.toLowerCase().trim();
  for (var r = allData.length - 1; r >= 1; r--) {
    var cellEmail = String(allData[r][emailCol] || '').toLowerCase().trim();
    if (cellEmail === targetEmail) {
      sheet.deleteRow(r + 1); // +1 because getValues is 0-based, deleteRow is 1-based
      Logger.log('‚úÖ Deleted player "' + playerEmail + '" from row ' + (r + 1));
      return { success: true, email: playerEmail, row: r + 1 };
    }
  }
  
  throw new Error('Player "' + playerEmail + '" not found in PROFILING sheet');
}

/**
 * Read ATTENTION sheet ‚Äî returns rules with tags, message, and color
 */
function getAttentionRules() {
  var rules = [];
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('ATTENTION');
    if (!sheet) { Logger.log('ATTENTION sheet not found'); return rules; }
    
    var lastRow = sheet.getLastRow();
    var lastCol = sheet.getLastColumn();
    if (lastRow < 2 || lastCol < 3) return rules;
    
    var data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
    var headers = data[0].map(function(h) { return String(h || '').toLowerCase().trim(); });
    
    var errorCol = headers.indexOf('error');
    var tagsCol = headers.indexOf('tags');
    var msgCol = headers.indexOf('message');
    
    if (errorCol === -1 || tagsCol === -1 || msgCol === -1) {
      Logger.log('ATTENTION: Missing required columns (error/tags/message)');
      return rules;
    }
    
    // Get background colors for ERROR column
    var bgColors = sheet.getRange(2, errorCol + 1, lastRow - 1, 1).getBackgrounds();
    
    for (var r = 1; r < data.length; r++) {
      var errorName = String(data[r][errorCol] || '').trim();
      var tagsRaw = String(data[r][tagsCol] || '').trim();
      var message = String(data[r][msgCol] || '').trim();
      
      if (!errorName || !message) continue;
      
      // Parse tags
      var tags = [];
      try {
        if (tagsRaw.charAt(0) === '[') {
          tags = JSON.parse(tagsRaw);
        } else if (tagsRaw) {
          tags = tagsRaw.split(',').map(function(t) { return t.trim(); });
        }
      } catch(e) { tags = [tagsRaw]; }
      
      // Get bg color (hex)
      var bgColor = bgColors[r - 1] ? bgColors[r - 1][0] : '#ef4444';
      if (bgColor === '#ffffff' || bgColor === '#fff') bgColor = '#ef4444'; // default red if white
      
      rules.push({
        error: errorName,
        tags: tags.map(function(t) { return String(t).toLowerCase().trim(); }),
        message: message,
        color: bgColor
      });
    }
    
    Logger.log('ATTENTION: loaded ' + rules.length + ' rules');
  } catch(e) {
    Logger.log('ATTENTION error: ' + e.toString());
  }
  return rules;
}

/**
 * Export profiling data to a new Google Spreadsheet
 */
function exportProfilingToSheet(headers, rows) {
  var timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm');
  var ss = SpreadsheetApp.create('Profiling Export - ' + timestamp);
  var sheet = ss.getActiveSheet();
  sheet.setName('Players');
  
  // Write headers
  if (headers && headers.length > 0) {
    var headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setValues([headers]);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#667eea');
    headerRange.setFontColor('#ffffff');
  }
  
  // Write data
  if (rows && rows.length > 0) {
    var dataRange = sheet.getRange(2, 1, rows.length, headers.length);
    dataRange.setValues(rows);
  }
  
  // Auto-resize columns
  for (var i = 1; i <= headers.length; i++) {
    sheet.autoResizeColumn(i);
  }
  
  // Add filters
  if (rows.length > 0) {
    sheet.getRange(1, 1, rows.length + 1, headers.length).createFilter();
  }
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  return { url: ss.getUrl(), id: ss.getId() };
}

/******************** BONUS CALCULATOR BACKEND ********************/

var KB = {
  RTP_SHEET: 'RTP GAMES',
  HEADER_ROW: 1,
  DATA_ROW: 2,
  CASINO_PREFIX: '[C]',
  SPORT_PREFIX: '[S]'
};

function parseRTP(val) {
  if (val === null || val === undefined || val === '') return null;
  var str = String(val).replace(/[^\d\.]/g, '');
  var num = parseFloat(str);
  return !isNaN(num) ? num : null;
}

function colToA1(col) {
  var s = '';
  for (var c = col; c > 0;) {
    var m = (c - 1) % 26;
    s = String.fromCharCode(65 + m) + s;
    c = Math.floor((c - 1) / 26);
  }
  return s;
}

function parseSheetInfo(sheetName) {
  var category = null;
  var cleanName = sheetName;
  var fbGroup = null;
  var fbVariant = null;
  
  if (sheetName.indexOf(KB.CASINO_PREFIX) === 0) {
    category = 'casino';
    cleanName = sheetName.substring(KB.CASINO_PREFIX.length).trim();
  } else if (sheetName.indexOf(KB.SPORT_PREFIX) === 0) {
    category = 'sport';
    cleanName = sheetName.substring(KB.SPORT_PREFIX.length).trim();
  }
  
  var fbMatch = cleanName.match(/^(.+?)\s*\*(.+)$/);
  if (fbMatch) {
    fbVariant = fbMatch[1].trim();
    fbGroup = fbMatch[2].trim();
  }
  
  return { category: category, cleanName: cleanName, originalName: sheetName, fbGroup: fbGroup, fbVariant: fbVariant };
}

function getConfig() {
  try {
    var ss = SpreadsheetApp.getActive();
    var all = ss.getSheets();
    
    var casino = [];
    var sport = [];
    var fbGroups = {};
    var sheetsToLoad = [];
    
    for (var i = 0; i < all.length; i++) {
      var name = all[i].getName();
      if (name === KB.RTP_SHEET) continue;
      
      var info = parseSheetInfo(name);
      if (!info.category) continue;
      
      var calc = {
        sheet: info.originalName,
        displayName: info.cleanName,
        category: info.category,
        isFS: /FS/i.test(info.cleanName),
        isLootbox: /lootbox/i.test(info.cleanName),
        fbGroup: info.fbGroup,
        fbVariant: info.fbVariant
      };
      
      sheetsToLoad.push(info.originalName);
      
      if (info.fbGroup && info.fbVariant) {
        var key = info.category + '_' + info.fbGroup;
        if (!fbGroups[key]) {
          fbGroups[key] = {
            displayName: info.fbGroup,
            category: info.category,
            isFB: true,
            isLootbox: /lootbox/i.test(info.fbGroup),
            variants: []
          };
        }
        fbGroups[key].variants.push(calc);
      } else {
        if (info.category === 'casino') casino.push(calc);
        else sport.push(calc);
      }
    }
    
    var fbKeys = Object.keys(fbGroups);
    for (var f = 0; f < fbKeys.length; f++) {
      var g = fbGroups[fbKeys[f]];
      if (g.category === 'casino') casino.push(g);
      else sport.push(g);
    }
    
    var allFields = getAllFields(sheetsToLoad);
    
    var allCalcs = casino.concat(sport);
    for (var c = 0; c < allCalcs.length; c++) {
      if (allCalcs[c].isFB) {
        for (var v = 0; v < allCalcs[c].variants.length; v++) {
          allCalcs[c].variants[v].fields = allFields[allCalcs[c].variants[v].sheet] || [];
        }
      } else {
        allCalcs[c].fields = allFields[allCalcs[c].sheet] || [];
      }
    }
    
    var rtpGames = getRTPGames();
    
    return { casino: casino, sport: sport, rtpGames: rtpGames };
  } catch (e) {
    Logger.log('Config error: ' + e.message);
    return { casino: [], sport: [], rtpGames: [] };
  }
}

function getAllFields(sheetNames) {
  var results = {};
  for (var i = 0; i < sheetNames.length; i++) {
    results[sheetNames[i]] = getFields(sheetNames[i]);
  }
  return results;
}

function getFields(sheetName) {
  var userCache = CacheService.getUserCache();
  var cacheKey = 'fields_' + sheetName;
  var cached = userCache.get(cacheKey);
  if (cached) {
    try { return JSON.parse(cached); } catch (e) {}
  }
  
  try {
    var ss = SpreadsheetApp.getActive();
    var sh = ss.getSheetByName(sheetName);
    if (!sh) return [];
    
    var isLootbox = /lootbox/i.test(sheetName);
    
    if (isLootbox) {
      var lastRow = Math.min(sh.getLastRow(), 50);
      var dataRange = sh.getRange(1, 1, lastRow, 11);
      var values = dataRange.getValues();
      var backgrounds = dataRange.getBackgrounds();
      var fontWeights = dataRange.getFontWeights();
      var formulas = dataRange.getFormulas();
      
      var fields = [];
      for (var i = 0; i < values.length; i++) {
        var lbl = String(values[i][0] || '').trim();
        if (!lbl) continue;
        var rowNum = i + 1;
        fields.push({
          label: lbl,
          a1: 'A' + rowNum,
          row: rowNum,
          col: 1,
          hasFormula: !!(formulas[i][1] && formulas[i][1].length > 0),
          color: backgrounds[i][0] && backgrounds[i][0] !== '#ffffff' ? backgrounds[i][0] : null,
          bold: fontWeights[i][0] === 'bold'
        });
      }
      try { userCache.put(cacheKey, JSON.stringify(fields), 60); } catch (e) {}
      return fields;
    }
    
    var lastCol = sh.getLastColumn();
    if (lastCol === 0) return [];
    
    var maxRows = Math.min(3, sh.getMaxRows());
    var dataRange2 = sh.getRange(1, 1, maxRows, lastCol);
    var values2 = dataRange2.getValues();
    var backgrounds2 = dataRange2.getBackgrounds();
    var fontWeights2 = dataRange2.getFontWeights();
    var formulas2 = dataRange2.getFormulas();
    var headerNotes = sh.getRange(1, 1, 1, lastCol).getNotes()[0];
    
    var labels = values2[0];
    var dataValues = values2[1] || [];
    var thresholds = values2[2] || [];
    var bgColors = backgrounds2[0];
    var rowBgColors = backgrounds2[1] || [];
    var fWeights = fontWeights2[0];
    var forms = formulas2[1] || [];
    
    var fields2 = [];
    for (var j = 0; j < labels.length; j++) {
      var lbl2 = String(labels[j] || '').trim();
      if (!lbl2) continue;
      fields2.push({
        label: lbl2,
        a1: colToA1(j + 1) + '2',
        col: j + 1,
        hasFormula: !!(forms[j] && forms[j].length),
        value: dataValues[j],
        threshold: thresholds[j] !== undefined && thresholds[j] !== '' ? Number(thresholds[j]) : null,
        color: bgColors[j] && bgColors[j] !== '#ffffff' ? bgColors[j] : null,
        bold: fWeights[j] === 'bold',
        note: headerNotes[j] || '',
        cellBgColor: rowBgColors[j] && rowBgColors[j] !== '#ffffff' ? rowBgColors[j] : null
      });
    }
    try { userCache.put(cacheKey, JSON.stringify(fields2), 60); } catch (e) {}
    return fields2;
  } catch (e) {
    Logger.log('getFields error: ' + e.message);
    return [];
  }
}

function getPlayerPreferences(email) {
  try {
    var ss = SpreadsheetApp.getActive();
    var prefSheet = ss.getSheetByName('preferences');
    if (!prefSheet) return null;
    
    var data = prefSheet.getDataRange().getValues();
    if (data.length <= 1) return null;
    
    var headers = data[0].map(function(h) { return String(h).toUpperCase().trim(); });
    var emailIdx = headers.indexOf('EMAIL');
    var gamesIdx = headers.indexOf('GAMES');
    if (emailIdx === -1 || gamesIdx === -1) return null;
    
    var emailLower = String(email).toLowerCase().trim();
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][emailIdx] || '').toLowerCase().trim() === emailLower) {
        return { email: data[i][emailIdx], games: String(data[i][gamesIdx] || '').trim() };
      }
    }
    return null;
  } catch (e) {
    Logger.log('Error loading player preferences: ' + e.message);
    return null;
  }
}

function clearCache() {
  try {
    CacheService.getUserCache().removeAll([]);
    return { success: true };
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function setZerosInSheet(sheetName, allInputFields) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return { success: false, error: 'Sheet not found' };
    if (!allInputFields || allInputFields.length === 0) return { success: false, error: 'No input fields' };
    
    for (var i = 0; i < allInputFields.length; i++) {
      sheet.getRange(allInputFields[i]).setValue(0);
    }
    SpreadsheetApp.flush();
    return { success: true };
  } catch (e) {
    Logger.log('Error setting zeros: ' + e.message);
    return { success: false, error: e.message };
  }
}

function getRTPGames() {
  try {
    var ss = SpreadsheetApp.getActive();
    var rtpSheet = ss.getSheetByName(KB.RTP_SHEET);
    if (!rtpSheet) return [];
    
    var data = rtpSheet.getDataRange().getValues();
    if (data.length <= 1) return [];
    
    var headers = data[0].map(function(h) { return String(h).toUpperCase().trim(); });
    var providerIdx = headers.indexOf('PROVIDER');
    var slotIdx = headers.indexOf('SLOT');
    var rtpIdx = headers.indexOf('RTP');
    var volatilityIdx = headers.indexOf('VOLATILITY');
    var categoryIdx = headers.indexOf('CATEGORY');
    
    if (providerIdx === -1 || slotIdx === -1 || rtpIdx === -1) return [];
    
    var betLvlIndices = [];
    for (var h = 0; h < headers.length; h++) {
      if (headers[h].indexOf('BET LVL') === 0) betLvlIndices.push(h);
    }
    
    var games = [];
    for (var i = 1; i < data.length; i++) {
      var provider = data[i][providerIdx];
      var slot = data[i][slotIdx];
      var rtpRaw = data[i][rtpIdx];
      if (!provider || !slot || rtpRaw === null || rtpRaw === undefined || rtpRaw === '') continue;
      
      var rtpValue = parseRTP(rtpRaw);
      if (rtpValue === null) continue;
      var rtpPct = rtpValue < 2 ? rtpValue * 100 : rtpValue;
      var volatility = volatilityIdx !== -1 ? String(data[i][volatilityIdx] || '').trim() : '';
      var category = categoryIdx !== -1 ? String(data[i][categoryIdx] || '').trim() : '';
      
      var betLevels = [];
      for (var b = 0; b < betLvlIndices.length; b++) {
        var betVal = data[i][betLvlIndices[b]];
        if (betVal !== null && betVal !== undefined && betVal !== '') {
          betLevels.push({ level: headers[betLvlIndices[b]].replace('BET LVL', '').trim(), value: Number(betVal) });
        }
      }
      
      games.push({
        provider: String(provider).trim(),
        slot: String(slot).trim(),
        rtpPct: rtpPct.toFixed(2),
        volatility: volatility,
        category: category,
        betLevels: betLevels
      });
    }
    return games;
  } catch (e) {
    Logger.log('Error loading RTP games: ' + e.message);
    return [];
  }
}

function compute(sheetName, inputMap) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error('Sheet not found');
    
    var keys = Object.keys(inputMap);
    for (var k = 0; k < keys.length; k++) {
      sheet.getRange(keys[k]).setValue(inputMap[keys[k]]);
    }
    SpreadsheetApp.flush();
    
    var lastCol = sheet.getLastColumn();
    var labels = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    var values = sheet.getRange(2, 1, 1, lastCol).getDisplayValues()[0];
    var backgrounds = sheet.getRange(2, 1, 1, lastCol).getBackgrounds()[0];
    var notes = sheet.getRange(1, 1, 1, lastCol).getNotes()[0];
    
    var result = [];
    for (var i = 0; i < labels.length; i++) {
      var lbl = String(labels[i] || '').trim();
      if (lbl) {
        result.push({
          label: lbl,
          a1: colToA1(i + 1) + '2',
          value: values[i] || '',
          cellBgColor: backgrounds[i] && backgrounds[i] !== '#ffffff' ? backgrounds[i] : null,
          note: notes[i] || ''
        });
      }
    }
    return { sheet: sheetName, result: result };
  } catch (e) {
    throw new Error('Compute error: ' + e.message);
  }
}

// ==================== RTP GAMES CRUD ====================

function getRTPGamesFullData() {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName(KB.RTP_SHEET);
    if (!sheet) return { headers: [], games: [], headerRow: [] };
    
    var data = sheet.getDataRange().getValues();
    if (data.length < 1) return { headers: [], games: [], headerRow: [] };
    
    var headers = data[0].map(function(h) { return String(h).trim(); });
    var games = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = {};
      var hasData = false;
      for (var j = 0; j < headers.length; j++) {
        var val = data[i][j];
        if (val !== null && val !== undefined && val !== '') hasData = true;
        
        // Format RTP as percentage string
        var key = headers[j].toUpperCase();
        if (key === 'RTP' && typeof val === 'number') {
          row[headers[j]] = val < 2 ? (val * 100).toFixed(2) + '%' : val.toFixed(2) + '%';
        } else {
          row[headers[j]] = val !== null && val !== undefined ? String(val) : '';
        }
      }
      if (hasData) {
        row._row = i + 1; // 1-based sheet row
        games.push(row);
      }
    }
    
    return { headers: headers, games: games };
  } catch (e) {
    throw new Error('getRTPGamesFullData: ' + e.message);
  }
}

function saveRTPGame(rowNum, gameData) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName(KB.RTP_SHEET);
    if (!sheet) throw new Error('RTP GAMES sheet not found');
    
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var headerMap = {};
    for (var i = 0; i < headers.length; i++) {
      headerMap[String(headers[i]).trim()] = i + 1; // 1-based column
    }
    
    // If rowNum is 0 or null, append new row
    if (!rowNum || rowNum === 0) {
      rowNum = sheet.getLastRow() + 1;
    }
    
    var keys = Object.keys(gameData);
    for (var k = 0; k < keys.length; k++) {
      var colNum = headerMap[keys[k]];
      if (!colNum) continue;
      
      var val = gameData[keys[k]];
      var headerKey = keys[k].toUpperCase();
      
      // Parse RTP: store as decimal (0.96)
      if (headerKey === 'RTP') {
        var rtpStr = String(val).replace('%', '').replace(',', '.').trim();
        var rtpNum = parseFloat(rtpStr);
        if (!isNaN(rtpNum)) {
          val = rtpNum > 2 ? rtpNum / 100 : rtpNum;
        }
      }
      // Parse BET LVL: store as number
      else if (headerKey.indexOf('BET LVL') === 0) {
        var betStr = String(val).replace(',', '.').trim();
        var betNum = parseFloat(betStr);
        val = isNaN(betNum) ? '' : betNum;
      }
      
      sheet.getRange(rowNum, colNum).setValue(val);
    }
    
    SpreadsheetApp.flush();
    return { success: true, row: rowNum };
  } catch (e) {
    throw new Error('saveRTPGame: ' + e.message);
  }
}

function deleteRTPGame(rowNum) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName(KB.RTP_SHEET);
    if (!sheet) throw new Error('RTP GAMES sheet not found');
    if (rowNum < 2) throw new Error('Cannot delete header row');
    
    sheet.deleteRow(rowNum);
    SpreadsheetApp.flush();
    return { success: true };
  } catch (e) {
    throw new Error('deleteRTPGame: ' + e.message);
  }
}

// ==================== PLAYER FAVOURITE SLOTS ====================

function getPlayerFavouriteSlots(email) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName('PLAYER PREFERENCE');
    if (!sheet) return [];
    
    var data = sheet.getDataRange().getValues();
    if (data.length < 2) return [];
    
    var headers = data[0].map(function(h) { return String(h).toUpperCase().trim(); });
    var emailIdx = headers.indexOf('EMAIL');
    if (emailIdx === -1) return [];
    
    var emailLower = String(email).toLowerCase().trim();
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][emailIdx] || '').toLowerCase().trim() === emailLower) {
        var slots = [];
        for (var j = 1; j < data[i].length; j++) {
          var val = String(data[i][j] || '').trim();
          if (val) slots.push(val);
        }
        return slots;
      }
    }
    return [];
  } catch (e) {
    Logger.log('getPlayerFavouriteSlots error: ' + e.message);
    return [];
  }
}

function savePlayerFavouriteSlots(email, slotsArr) {
  try {
    var ss = SpreadsheetApp.getActive();
    var sheet = ss.getSheetByName('PLAYER PREFERENCE');
    if (!sheet) {
      sheet = ss.insertSheet('PLAYER PREFERENCE');
      sheet.getRange(1, 1).setValue('EMAIL');
    }
    
    var data = sheet.getDataRange().getValues();
    var headers = data[0] || ['EMAIL'];
    var emailLower = String(email).toLowerCase().trim();
    var rowNum = 0;
    
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][0] || '').toLowerCase().trim() === emailLower) {
        rowNum = i + 1;
        break;
      }
    }
    
    if (rowNum === 0) {
      rowNum = sheet.getLastRow() + 1;
    }
    
    // Write email + all slots in columns A, B, C, D...
    var rowData = [email];
    for (var s = 0; s < slotsArr.length; s++) {
      rowData.push(slotsArr[s]);
    }
    
    // Ensure enough columns
    var neededCols = rowData.length;
    var currentCols = sheet.getMaxColumns();
    if (neededCols > currentCols) {
      sheet.insertColumnsAfter(currentCols, neededCols - currentCols);
    }
    
    // Clear old data in that row first
    if (currentCols > 0) {
      sheet.getRange(rowNum, 1, 1, Math.max(currentCols, neededCols)).clearContent();
    }
    
    // Write new data
    sheet.getRange(rowNum, 1, 1, rowData.length).setValues([rowData]);
    SpreadsheetApp.flush();
    
    return { success: true };
  } catch (e) {
    throw new Error('savePlayerFavouriteSlots: ' + e.message);
  }
}

/**
 * Get HOME sheet data. Auto-reads date/author from cell notes.
 * Note format: "dd.MM.yyyy HH:mm|Author Name"  
 * Returns newest posts first.
 */
function getHomeData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('HOME') || ss.getSheetByName('Home');
    if (!sheet) return { error: 'HOME sheet not found' };
    
    var lastRow = sheet.getLastRow();
    var lastCol = sheet.getLastColumn();
    if (lastRow < 2 || lastCol < 1) return { news: [], blog: [], links: [] };
    
    var data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
    var allNotes = sheet.getRange(1, 1, lastRow, lastCol).getNotes();
    var headers = data[0].map(function(h) { return String(h).trim().toUpperCase(); });
    
    var newsCol = headers.indexOf('NEWS');
    var blogCol = headers.indexOf('BLOG');
    var linksCol = headers.indexOf('USEFUL LINKS');
    
    function parsePosts(colIdx) {
      if (colIdx < 0) return [];
      var posts = [];
      var seen = {};
      for (var i = 1; i < data.length; i++) {
        var val = String(data[i][colIdx] || '').trim();
        if (!val) continue;
        var hash = val.substring(0, 100);
        if (seen[hash]) continue;
        seen[hash] = true;
        
        var date = '';
        var author = '';
        var note = (allNotes[i] && allNotes[i][colIdx]) ? allNotes[i][colIdx].trim() : '';
        if (note && note.indexOf('|') !== -1) {
          var parts = note.split('|');
          date = parts[0].trim();
          author = parts.slice(1).join('|').trim();
        } else if (note) {
          date = note;
        }
        
        posts.push({ content: val, date: date, author: author, row: i + 1 });
      }
      posts.reverse();
      return posts;
    }
    
    function parseLinks(colIdx) {
      if (colIdx < 0) return [];
      var links = [];
      for (var i = 1; i < data.length; i++) {
        var val = String(data[i][colIdx] || '').trim();
        if (!val) continue;
        var url = '';
        try {
          var richText = sheet.getRange(i + 1, colIdx + 1).getRichTextValue();
          if (richText) {
            var runs = richText.getRuns();
            for (var r = 0; r < runs.length; r++) {
              var linkUrl = runs[r].getLinkUrl();
              if (linkUrl) { url = linkUrl; break; }
            }
          }
        } catch(e) {}
        if (!url && val.match(/^https?:\/\//)) url = val;
        links.push({ label: val, url: url, row: i + 1 });
      }
      return links;
    }
    
    return {
      news: parsePosts(newsCol),
      blog: parsePosts(blogCol),
      links: parseLinks(linksCol)
    };
  } catch (e) {
    Logger.log('getHomeData error: ' + e);
    return { error: e.message };
  }
}

/**
 * Auto-stamp date & author on HOME sheet edits.
 * Stores as cell note: "dd.MM.yyyy HH:mm|Author Name"
 * INSTALLABLE trigger - run setupHomeTrigger() once.
 */
function onHomeEdit(e) {
  try {
    if (!e || !e.range) return;
    var sheet = e.range.getSheet();
    if (sheet.getName().toUpperCase() !== 'HOME') return;
    
    var col = e.range.getColumn();
    var row = e.range.getRow();
    if (row <= 1) return;
    
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var colName = String(headers[col - 1] || '').trim().toUpperCase();
    if (colName !== 'NEWS' && colName !== 'BLOG') return;
    
    var cellValue = String(e.range.getValue() || '').trim();
    if (!cellValue) { e.range.setNote(''); return; }
    
    var authorName = getCurrentAuthorName();
    var now = Utilities.formatDate(new Date(), 'Europe/Kiev', 'dd.MM.yyyy HH:mm');
    
    var existing = e.range.getNote();
    if (!existing) {
      e.range.setNote(now + '|' + authorName);
    }
  } catch(err) {
    Logger.log('onHomeEdit error: ' + err);
  }
}

function emailToName(email) {
  if (!email) return '';
  var name = email.split('@')[0];
  return name.replace(/[._-]/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
}

/**
 * Get current user name - tries multiple methods
 */
function getCurrentAuthorName() {
  var email = '';
  try { email = Session.getActiveUser().getEmail(); } catch(e) {}
  if (!email) try { email = Session.getEffectiveUser().getEmail(); } catch(e) {}
  if (email) return emailToName(email);
  
  // Fallback: try Drive owner
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var owner = ss.getOwner();
    if (owner) return owner.getName() || emailToName(owner.getEmail());
  } catch(e) {}
  
  return 'Admin';
}

/** Run ONCE to install the auto-stamp trigger */
function setupHomeTrigger() {
  ScriptApp.getProjectTriggers().forEach(function(t) {
    if (t.getHandlerFunction() === 'onHomeEdit') ScriptApp.deleteTrigger(t);
  });
  ScriptApp.newTrigger('onHomeEdit')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit().create();
  Logger.log('HOME auto-stamp trigger installed');
}

/** Backfill notes on existing HOME entries */
function backfillHomeNotes() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('HOME') || ss.getSheetByName('Home');
  if (!sheet) return;
  var lastRow = sheet.getLastRow();
  var lastCol = sheet.getLastColumn();
  if (lastRow < 2) return;
  
  var data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
  var notes = sheet.getRange(1, 1, lastRow, lastCol).getNotes();
  var headers = data[0].map(function(h) { return String(h).trim().toUpperCase(); });
  var newsCol = headers.indexOf('NEWS');
  var blogCol = headers.indexOf('BLOG');
  var now = Utilities.formatDate(new Date(), 'Europe/Kiev', 'dd.MM.yyyy HH:mm');
  var author = getCurrentAuthorName();
  var count = 0;
  
  [newsCol, blogCol].filter(function(c) { return c >= 0; }).forEach(function(colIdx) {
    for (var i = 1; i < data.length; i++) {
      if (!String(data[i][colIdx] || '').trim()) continue;
      var note = notes[i][colIdx] || '';
      // Stamp if no note, or if author is Unknown
      if (!note || note.indexOf('|Unknown') !== -1) {
        sheet.getRange(i + 1, colIdx + 1).setNote(now + '|' + author);
        count++;
      }
    }
  });
  Logger.log('Backfilled ' + count + ' HOME notes');
}


/**
 * Fetch crypto (BTC, ETH) and forex (USD, AUD, NZD) rates relative to EUR
 * Uses Google Finance formulas (most reliable in Sheets environment)
 */
function getCryptoAndForexRates() {
  var result = { rates: { EUR: 1 }, btcEur: 0, ethEur: 0, btcChange: 0, ethChange: 0 };
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var tempSheet = ss.getSheetByName('_rates');
    if (!tempSheet) {
      tempSheet = ss.insertSheet('_rates');
      tempSheet.hideSheet();
    }
    
    // Set formulas
    var formulas = [
      ['=GOOGLEFINANCE("CURRENCY:EURUSD")', '=GOOGLEFINANCE("CURRENCY:EURAUD")', '=GOOGLEFINANCE("CURRENCY:EURNZD")'],
      ['=GOOGLEFINANCE("BTCEUR")', '=GOOGLEFINANCE("ETHEUR")', '=GOOGLEFINANCE("CURRENCY:EURCAD")']
    ];
    tempSheet.getRange('A1:C2').setValues(formulas);
    SpreadsheetApp.flush();
    Utilities.sleep(2000);
    
    var vals = tempSheet.getRange('A1:C2').getValues();
    
    // Forex rates (EUR base)
    result.rates['USD'] = parseFloat(vals[0][0]) || 1.08;
    result.rates['AUD'] = parseFloat(vals[0][1]) || 1.65;
    result.rates['NZD'] = parseFloat(vals[0][2]) || 1.78;
    result.rates['CAD'] = parseFloat(vals[1][2]) || 1.47;
    
    // Crypto (price in EUR)
    var btcPrice = parseFloat(vals[1][0]) || 0;
    var ethPrice = parseFloat(vals[1][1]) || 0;
    
    if (btcPrice > 0) {
      result.btcEur = btcPrice;
      result.rates['BTC'] = 1 / btcPrice;
    }
    if (ethPrice > 0) {
      result.ethEur = ethPrice;
      result.rates['ETH'] = 1 / ethPrice;
    }
    
    Logger.log('Rates loaded via Google Finance: BTC=' + btcPrice + ', ETH=' + ethPrice + ', USD=' + result.rates['USD']);
    
  } catch (e) {
    Logger.log('Google Finance error: ' + e);
  }
  
  // Fallback to CoinGecko for crypto if Google Finance failed
  if (!result.btcEur) {
    try {
      var url = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=eur&include_24hr_change=true';
      var resp = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
      var data = JSON.parse(resp.getContentText());
      if (data.bitcoin) {
        result.btcEur = data.bitcoin.eur || 0;
        result.btcChange = data.bitcoin.eur_24h_change || 0;
        result.rates['BTC'] = 1 / (data.bitcoin.eur || 1);
      }
      if (data.ethereum) {
        result.ethEur = data.ethereum.eur || 0;
        result.ethChange = data.ethereum.eur_24h_change || 0;
        result.rates['ETH'] = 1 / (data.ethereum.eur || 1);
      }
    } catch (e2) { Logger.log('CoinGecko fallback error: ' + e2); }
  }
  
  return result;
}


// ===================== BIRTHDAY CALENDAR =====================

/**
 * Get upcoming player birthdays from PROFILING sheet
 * Returns players sorted by days until birthday
 */
function getUpcomingBirthdays() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('PROFILING') || ss.getSheetByName('[PROFILING]');
    if (!sheet) return { birthdays: [] };
    
    var data = sheet.getDataRange().getValues();
    if (data.length < 2) return { birthdays: [] };
    
    var headers = data[0];
    var emailCol = -1, nameCol = -1, bdayCol = -1, countryCol = -1;
    
    for (var h = 0; h < headers.length; h++) {
      var hdr = String(headers[h] || '').toLowerCase().trim();
      if (hdr.indexOf('email') !== -1 && emailCol === -1) emailCol = h;
      if ((hdr === 'name' || hdr === 'player name' || hdr === 'full name' || hdr.indexOf('name') !== -1) && nameCol === -1) nameCol = h;
      if (hdr.indexOf('birthday') !== -1 || hdr.indexOf('birth date') !== -1 || hdr === 'dob' || hdr === 'date of birth') bdayCol = h;
      if (hdr.indexOf('country') !== -1 && countryCol === -1) countryCol = h;
    }
    
    if (bdayCol === -1) return { birthdays: [], error: 'No birthday column found' };
    
    var today = new Date();
    var todayMonth = today.getMonth();
    var todayDay = today.getDate();
    var results = [];
    
    for (var i = 1; i < data.length; i++) {
      var bday = data[i][bdayCol];
      if (!bday) continue;
      
      var bdayDate;
      if (bday instanceof Date) {
        bdayDate = bday;
      } else {
        bdayDate = new Date(bday);
        if (isNaN(bdayDate.getTime())) continue;
      }
      
      var bMonth = bdayDate.getMonth();
      var bDay = bdayDate.getDate();
      
      // Calculate days until birthday this year
      var nextBday = new Date(today.getFullYear(), bMonth, bDay);
      if (nextBday < today) {
        nextBday = new Date(today.getFullYear() + 1, bMonth, bDay);
      }
      var daysUntil = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24));
      
      var email = emailCol >= 0 ? String(data[i][emailCol] || '').trim() : '';
      var name = nameCol >= 0 ? String(data[i][nameCol] || '').trim() : email.split('@')[0];
      var country = countryCol >= 0 ? String(data[i][countryCol] || '').trim() : '';
      
      if (!email && !name) continue;
      
      results.push({
        email: email,
        name: name || email,
        country: country,
        birthday: Utilities.formatDate(bdayDate, 'Europe/Kiev', 'dd.MM'),
        birthdayFull: Utilities.formatDate(bdayDate, 'Europe/Kiev', 'dd.MM.yyyy'),
        daysUntil: daysUntil,
        isToday: daysUntil === 0,
        age: today.getFullYear() - bdayDate.getFullYear()
      });
    }
    
    results.sort(function(a, b) { return a.daysUntil - b.daysUntil; });
    
    return { birthdays: results.slice(0, 30) }; // top 30 upcoming
    
  } catch (e) {
    Logger.log('getUpcomingBirthdays error: ' + e);
    return { birthdays: [], error: e.message };
  }
}

// ===================== PROMO PLAN =====================

/**
 * Get promo plan from PROMO_PLAN sheet
 */
function getPromoPlan() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('PROMO_PLAN');
    
    if (!sheet) {
      initPromoPlanSheet();
      sheet = ss.getSheetByName('PROMO_PLAN');
    }
    
    var data = sheet.getDataRange().getValues();
    if (data.length < 2) return { events: [] };
    
    var headers = data[0].map(function(h) { return String(h).trim().toUpperCase(); });
    var dateCol = headers.indexOf('DATE');
    var nameCol = headers.indexOf('EVENT');
    var typeCol = headers.indexOf('TYPE');
    var descCol = headers.indexOf('DESCRIPTION');
    var statusCol = headers.indexOf('STATUS');
    
    if (dateCol === -1 || nameCol === -1) return { events: [] };
    
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var events = [];
    
    for (var i = 1; i < data.length; i++) {
      var d = data[i][dateCol];
      if (!d) continue;
      
      var eventDate;
      if (d instanceof Date) {
        eventDate = d;
      } else {
        eventDate = new Date(d);
        if (isNaN(eventDate.getTime())) continue;
      }
      
      var diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
      
      events.push({
        date: Utilities.formatDate(eventDate, 'Europe/Kiev', 'dd.MM.yyyy'),
        dateShort: Utilities.formatDate(eventDate, 'Europe/Kiev', 'dd MMM'),
        dayOfWeek: Utilities.formatDate(eventDate, 'Europe/Kiev', 'EEE'),
        event: String(data[i][nameCol] || '').trim(),
        type: typeCol >= 0 ? String(data[i][typeCol] || '').trim() : '',
        description: descCol >= 0 ? String(data[i][descCol] || '').trim() : '',
        status: statusCol >= 0 ? String(data[i][statusCol] || '').trim() : '',
        daysUntil: diffDays,
        isPast: diffDays < 0,
        isToday: diffDays === 0
      });
    }
    
    // Sort: upcoming first, then past
    events.sort(function(a, b) {
      if (a.isPast !== b.isPast) return a.isPast ? 1 : -1;
      return a.daysUntil - b.daysUntil;
    });
    
    return { events: events };
    
  } catch (e) {
    Logger.log('getPromoPlan error: ' + e);
    return { events: [], error: e.message };
  }
}

/**
 * Create PROMO_PLAN sheet with holidays pre-filled
 */
function initPromoPlanSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('PROMO_PLAN');
  if (sheet) return;
  
  sheet = ss.insertSheet('PROMO_PLAN');
  
  // Headers
  sheet.getRange('A1:E1').setValues([['DATE', 'EVENT', 'TYPE', 'DESCRIPTION', 'STATUS']]);
  sheet.getRange('A1:E1').setFontWeight('bold').setBackground('#1e293b').setFontColor('#ffffff');
  
  // Pre-fill with 2025-2026 holidays
  var holidays = [
    ['2025-01-01', "New Year's Day", 'Holiday', 'Global celebration', ''],
    ['2025-01-07', 'Orthodox Christmas', 'Holiday', 'UA/Eastern Europe', ''],
    ['2025-01-14', 'Old New Year', 'Holiday', 'UA tradition', ''],
    ['2025-02-14', "Valentine's Day", 'Promo', 'Love-themed promotions', ''],
    ['2025-03-08', "Women's Day", 'Holiday', 'International', ''],
    ['2025-03-17', "St. Patrick's Day", 'Promo', 'Irish-themed promo', ''],
    ['2025-04-20', 'Easter (Western)', 'Holiday', 'Western Easter', ''],
    ['2025-04-20', 'Easter (Orthodox)', 'Holiday', 'Orthodox Easter 2025', ''],
    ['2025-05-01', 'Labour Day', 'Holiday', 'International', ''],
    ['2025-05-09', 'Victory Day', 'Holiday', 'Europe', ''],
    ['2025-06-28', 'Constitution Day UA', 'Holiday', 'Ukraine', ''],
    ['2025-07-04', 'Independence Day US', 'Promo', 'USA market', ''],
    ['2025-08-24', 'Independence Day UA', 'Holiday', 'Ukraine', ''],
    ['2025-10-14', 'Defenders Day UA', 'Holiday', 'Ukraine', ''],
    ['2025-10-31', 'Halloween', 'Promo', 'Spooky-themed promotions', ''],
    ['2025-11-27', 'Thanksgiving', 'Promo', 'USA market', ''],
    ['2025-11-28', 'Black Friday', 'Promo', 'Mega promotions', ''],
    ['2025-12-01', 'Cyber Monday', 'Promo', 'Online promotions', ''],
    ['2025-12-06', 'St. Nicholas Day', 'Promo', 'Gift-themed', ''],
    ['2025-12-24', 'Christmas Eve', 'Holiday', 'Western', ''],
    ['2025-12-25', 'Christmas Day', 'Holiday', 'Western', ''],
    ['2025-12-31', "New Year's Eve", 'Holiday', 'Global', ''],
    ['2026-01-01', "New Year's Day", 'Holiday', 'Global', ''],
    ['2026-01-07', 'Orthodox Christmas', 'Holiday', 'UA/Eastern Europe', ''],
    ['2026-02-14', "Valentine's Day", 'Promo', 'Love-themed promotions', ''],
    ['2026-03-08', "Women's Day", 'Holiday', 'International', ''],
    ['2026-03-17', "St. Patrick's Day", 'Promo', 'Irish-themed', ''],
    ['2026-04-05', 'Easter (Western)', 'Holiday', 'Western Easter 2026', ''],
    ['2026-04-12', 'Easter (Orthodox)', 'Holiday', 'Orthodox Easter 2026', ''],
    ['2026-05-01', 'Labour Day', 'Holiday', 'International', ''],
    ['2026-06-28', 'Constitution Day UA', 'Holiday', 'Ukraine', ''],
    ['2026-08-24', 'Independence Day UA', 'Holiday', 'Ukraine', ''],
    ['2026-10-31', 'Halloween', 'Promo', 'Spooky-themed', ''],
    ['2026-11-26', 'Thanksgiving', 'Promo', 'USA market', ''],
    ['2026-11-27', 'Black Friday', 'Promo', 'Mega promotions', ''],
    ['2026-12-25', 'Christmas Day', 'Holiday', 'Western', ''],
    ['2026-12-31', "New Year's Eve", 'Holiday', 'Global', '']
  ];
  
  if (holidays.length > 0) {
    sheet.getRange(2, 1, holidays.length, 5).setValues(holidays);
    // Format date column
    sheet.getRange(2, 1, holidays.length, 1).setNumberFormat('yyyy-mm-dd');
  }
  
  sheet.setColumnWidth(1, 120);
  sheet.setColumnWidth(2, 250);
  sheet.setColumnWidth(3, 100);
  sheet.setColumnWidth(4, 250);
  sheet.setColumnWidth(5, 100);
  
  // Add status dropdown
  var statusRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['', 'Planned', 'In Progress', 'Done', 'Cancelled'], true)
    .build();
  sheet.getRange(2, 5, 200, 1).setDataValidation(statusRule);
  
  // Add type dropdown
  var typeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Holiday', 'Promo', 'Tournament', 'VIP Event', 'Other'], true)
    .build();
  sheet.getRange(2, 3, 200, 1).setDataValidation(typeRule);
  
  Logger.log('PROMO_PLAN sheet created with ' + holidays.length + ' events');
}
