<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"><base target="_top">
<title>Slotornado Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<!-- Font Awesome –¥–ª—è —ñ–∫–æ–Ω–æ–∫ —Å–æ—Ü–º–µ—Ä–µ–∂ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --surface: #ffffff;
  --surface-elevated: #f8fafc;
  --border: #e2e8f0;
  --text-primary: #1e293b;
  --text-muted: #64748b;
  --accent-primary: #667eea;
  --accent-danger: #ef4444;
}

canvas{z-index:0}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f7fa;color:#2d3748;height:100vh;margin:0;overflow-x:hidden}

#splash{position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:1;transition:opacity 0.5s}
#splash.hide{opacity:0;pointer-events:none}
.splash-content{text-align:center}
.splash-logo{font-size:48px;font-weight:900;margin-bottom:20px;color:#fff}
.splash-spinner{width:60px;height:60px;margin:0 auto 20px;border:5px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.splash-text{font-size:16px;color:rgba(255,255,255,0.9)}

.container{display:flex;height:100vh}
.sidebar{width:280px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;flex-shrink:0;box-shadow:2px 0 10px rgba(0,0,0,0.02);transition:width 0.3s cubic-bezier(0.4,0,0.2,1)}
.sidebar.collapsed{width:70px}
.sidebar.collapsed .player-search-container{opacity:0;height:0;overflow:hidden;padding:0;border:none}
.sidebar.collapsed .profiling-btn{display:none}
.sidebar.collapsed .logo{opacity:1;font-size:32px;overflow:visible;text-align:center;padding:0}
.sidebar.collapsed .subtitle{display:none}
.sidebar.collapsed .nav-item span:not(.nav-icon){opacity:0;width:0;overflow:hidden;white-space:nowrap;transition:opacity 0.2s,width 0.2s}
.sidebar.collapsed .nav-item{justify-content:center;padding:14px}
.sidebar.collapsed .nav-item .nav-icon{font-size:24px}
.sidebar-toggle{position:absolute;top:20px;left:calc(100% + 8px);width:30px;height:30px;background:#667eea;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:14px;font-weight:700;box-shadow:0 2px 8px rgba(102,126,234,0.4);transition:all 0.2s;z-index:100}
.sidebar-toggle:hover{transform:scale(1.15);background:#764ba2;box-shadow:0 4px 12px rgba(118,75,162,0.5)}
.sidebar-toggle:active{transform:scale(1.05)}
.sidebar-header{padding:24px;border-bottom:1px solid #e2e8f0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);position:relative;transition:padding 0.3s}
.sidebar.collapsed .sidebar-header{padding:20px 0}
.logo{font-size:24px;font-weight:900;margin-bottom:6px;color:#fff;cursor:pointer;user-select:none}
.subtitle{font-size:11px;color:rgba(255,255,255,0.9);text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
.sidebar-nav{padding:16px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;margin-bottom:6px;border-radius:8px;cursor:pointer;color:#64748b;font-weight:600;transition:all 0.2s;font-size:14px}
.nav-item:hover{background:#f1f5f9;color:#475569}
.nav-item.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.nav-icon{font-size:18px}
.sidebar-submenu{display:none;flex-direction:column;margin:0 0 8px 0;padding:0;background:transparent}.sidebar-submenu.open{display:flex}.sidebar-submenu-item{display:flex;align-items:center;gap:10px;padding:10px 16px 10px 48px;color:#94a3b8;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;border-radius:6px;margin:0 8px}.sidebar-submenu-item:hover{background:rgba(102,126,234,0.08);color:#667eea}.sidebar-submenu-item.active{background:rgba(102,126,234,0.12);color:#667eea;font-weight:600}.sidebar-submenu-item-icon{font-size:14px}.sidebar-submenu-toggle{margin-left:auto;font-size:10px;color:#94a3b8;transition:transform 0.3s ease;display:inline-block}.sidebar-submenu-toggle.open{transform:rotate(180deg)}.sidebar-submenu-toggle:hover{color:#667eea}

.main-wrapper{flex:1;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden}
.filters-bar{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px 32px;border-bottom:2px solid rgba(255,255,255,0.3);box-shadow:0 2px 10px rgba(0,0,0,0.1);position:relative;overflow:visible}
.filters-grid{display:grid;grid-template-columns:repeat(5,1fr) auto;gap:12px;align-items:end;position:relative}
.filter-group{background:rgba(255,255,255,0.15);padding:12px;border-radius:8px;backdrop-filter:blur(10px)}
.filter-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;opacity:0.9;color:#fff}
.filter-select{position:relative}
.filter-chip{padding:8px 16px;background:rgba(255,255,255,0.25);border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;border:2px solid transparent;color:#fff;min-height:36px;display:flex;align-items:center;justify-content:center}
.filter-chip:hover{background:rgba(255,255,255,0.35)}
.filter-chip.selected{background:#fff;color:#667eea;border-color:#fff}
.filter-dropdown{position:relative;min-width:200px;z-index:100}
.filter-dropdown-toggle{padding:10px 16px;background:rgba(255,255,255,0.95);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid rgba(255,255,255,0.3);color:#1e293b;display:flex;align-items:center;justify-content:space-between;gap:8px;transition:all 0.2s}
.filter-dropdown-toggle:hover{background:#fff;border-color:#667eea}
.filter-dropdown-toggle.active{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}
.filter-dropdown-toggle .count{background:#667eea;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700}
.filter-dropdown-menu{position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-height:300px;overflow-y:auto;overflow-x:hidden;z-index:9999;display:none;padding:8px}
.filter-search-input{width:100%;padding:8px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;margin-bottom:8px;outline:none;transition:border-color 0.2s}
.filter-search-input:focus{border-color:#667eea}
.filter-items-container{max-height:240px;overflow-y:auto}
.filter-dropdown-menu.open{display:block}
.filter-dropdown-item{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:8px;transition:background 0.2s;font-size:13px;color:#1e293b}
.filter-dropdown-item:hover{background:#f1f5f9}
.filter-checkbox{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.filter-checkbox.checked{background:#667eea;border-color:#667eea;color:#fff}
.filter-checkbox.checked::before{content:'‚úì';font-size:12px;font-weight:700}
.filter-chip input{display:none}
.filter-actions{display:flex;flex-direction:column;gap:8px}
.btn-filter{padding:12px 24px;border-radius:10px;border:2px solid #fff;background:#fff;color:#667eea;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap;min-height:44px}
.btn-filter:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,255,255,0.3)}
.btn-clear{background:rgba(255,255,255,0.15);color:#fff;border-color:rgba(255,255,255,0.5)}
.btn-clear:hover{background:rgba(255,255,255,0.25)}

.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:40px 0 !important;background:#f5f7fa;min-height:0;width:100%;box-sizing:border-box;max-width:1800px;margin:0 auto}
.content{display:none;width:100%;box-sizing:border-box;padding:0 80px !important}
.content.active{display:block;width:100%;box-sizing:border-box;padding:0 80px !important}
h1{font-size:32px;margin-bottom:8px;color:#1e293b;font-weight:900}
.desc{color:#64748b;margin-bottom:24px;font-size:15px}

.chart-section{margin-bottom:24px;background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.chart-title{font-size:16px;font-weight:700;color:#1e293b}
.metric-selector{display:flex;gap:8px;flex-wrap:wrap}
.metric-btn{padding:6px 14px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;color:#64748b;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s}
.metric-btn:hover{border-color:#667eea;color:#667eea}
.metric-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
.chart-container{height:350px;position:relative;z-index:1}

.table-wrap{overflow:auto;max-height:calc(100vh - 450px);border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:14px;text-align:center;border-right:1px solid #f1f5f9;border-bottom:1px solid #f1f5f9;white-space:nowrap}
th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;position:sticky;top:0;z-index:10;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
th.row-header{left:0;z-index:20;text-align:left;min-width:140px}
th:first-child{border-top-left-radius:12px}
th:last-child{border-top-right-radius:12px}
td.row-header{position:sticky;left:0;background:linear-gradient(90deg,#fff 0%,#fff 90%,rgba(255,255,255,0));z-index:5;font-weight:700;text-align:left;color:#667eea;border-right:2px solid rgba(102,126,234,0.2)}
.cell{display:inline-block;padding:8px 12px;border-radius:8px;min-width:90px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid transparent}
.cell:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.2);border-color:#667eea}
.count{font-size:16px;font-weight:800}
.pct{font-size:11px;opacity:0.7;margin-left:4px}
.filtered-out{opacity:0.3;pointer-events:none}

.kpi-tabs{display:flex;gap:8px;margin-bottom:20px;padding:8px;background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.kpi-tab{padding:10px 20px;border-radius:8px;border:2px solid transparent;background:#f8fafc;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s}
.kpi-tab:hover{background:#f1f5f9;color:#475569}
.kpi-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.kpi-tab.compare-tab{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(5,150,105,0.1));border:2px solid rgba(16,185,129,0.2)}
.kpi-tab.compare-tab:hover{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.15));border-color:rgba(16,185,129,0.3)}
.kpi-tab.compare-tab.active{background:linear-gradient(135deg,#10b981,#059669)!important;border-color:transparent!important;box-shadow:0 3px 10px rgba(16,185,129,0.4)!important}
.kpi-layout{display:grid;grid-template-columns:280px 1fr;gap:20px;height:calc(100vh - 320px)}
.kpi-sidebar{background:#fff;border-radius:12px;padding:20px;overflow-y:auto;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.kpi-main{display:flex;flex-direction:column;gap:20px;overflow:hidden}
.period-header{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#64748b;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.period-header::before{content:'';width:3px;height:16px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:2px}
.month-group{margin-bottom:16px;border-bottom:1px solid #f1f5f9;padding-bottom:16px}
.month-group:last-child{border-bottom:none}
.month-header{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;cursor:pointer;transition:all 0.2s;margin-bottom:8px;background:#f8fafc}
.month-header:hover{background:#e0e7ff;transform:translateX(4px)}
.month-header input[type="checkbox"]{margin:0;cursor:pointer;width:18px;height:18px}
.month-label{flex:1;font-weight:700;color:#1e293b;font-size:14px;cursor:pointer}
.month-count{font-size:11px;color:#667eea;font-weight:700;background:#e0e7ff;padding:4px 10px;border-radius:12px}
.weeks-list{margin-left:24px;display:none;margin-top:8px}
.weeks-list.open{display:block}
.week-item{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;transition:all 0.2s;margin:4px 0;background:#fff;border:1px solid #f1f5f9}
.week-item:hover{background:#f8fafc;border-color:#e0e7ff;transform:translateX(4px)}
.week-item input[type="checkbox"]{margin:0;cursor:pointer;width:16px;height:16px}
.week-label{font-size:13px;color:#475569;cursor:pointer;flex:1}
.kpi-chart-wrap{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);flex-shrink:0}
.kpi-table-wrap{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);flex:1;display:flex;flex-direction:column;min-height:0}
.metrics-filter{margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;transition:all 0.3s}
.metrics-filter.collapsed{padding:0;max-height:48px;overflow:hidden}
.metrics-filter.collapsed .metrics-grid{display:none}
.metrics-filter-header{font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:8px}
.metrics-filter-header:hover{background:#fff;border-radius:6px}
.metrics-filter-toggle{font-size:16px;transition:transform 0.3s}
.metrics-filter.collapsed .metrics-filter-toggle{transform:rotate(-90deg)}
.selected-metric-display{padding:20px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(102,126,234,0.3)}
.selected-metric-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.9;margin-bottom:6px}
.selected-metric-value{font-size:28px;font-weight:900;letter-spacing:-0.5px}
.compare-controls{display:flex;align-items:center;justify-content:center;gap:24px;margin-bottom:24px;padding:24px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.compare-selector{display:flex;flex-direction:column;gap:8px;min-width:220px}
.compare-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.compare-dropdown{padding:12px 16px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;font-weight:600;color:#1e293b;background:#fff;cursor:pointer;transition:all 0.2s;width:100%}
.compare-dropdown:hover{border-color:#667eea}
.compare-dropdown:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}
.compare-vs{font-size:28px;font-weight:900;color:#667eea;display:flex;align-items:center;padding:0 20px}
.heatmap-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;padding:8px 12px;border-radius:8px;background:#f8fafc;border:2px solid #e2e8f0;transition:all 0.2s}
.heatmap-toggle:hover{background:#f1f5f9;border-color:#cbd5e1}
.heatmap-toggle input[type="checkbox"]{width:40px;height:20px;appearance:none;background:#cbd5e1;border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s}
.heatmap-toggle input[type="checkbox"]:checked{background:#667eea}
.heatmap-toggle input[type="checkbox"]::before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;left:2px;transition:left 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.heatmap-toggle input[type="checkbox"]:checked::before{left:22px}
.toggle-label{font-size:13px;font-weight:600;color:#64748b}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.metric-check-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:all 0.2s}
.metric-check-item:hover{background:#fff}
.metric-check-item input{cursor:pointer}
.metric-check-item label{cursor:pointer;font-size:12px;color:#475569;flex:1}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;overflow:auto}
.modal.open{display:flex}
.modal-card{background:#fff;border-radius:12px;width:min(1400px,95vw);max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:24px 28px;border-bottom:1px solid #e2e8f0;background:linear-gradient(135deg,rgba(102,126,234,0.05),rgba(118,75,162,0.05))}
.modal-title{font-size:22px;font-weight:900;color:#1e293b}
.modal-tools{display:flex;gap:12px}
.modal-body{flex:1;overflow:auto;padding:24px 28px}
.analytics-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #e2e8f0}
.analytics-title{font-size:16px;font-weight:700;margin-bottom:16px;color:#1e293b}
.pies-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.pie-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;display:flex;gap:16px;align-items:center}
.pie-chart{width:150px;height:150px;flex-shrink:0}
.pie-legend{flex:1;font-size:12px}
.legend-item{display:flex;align-items:center;gap:10px;margin:6px 0;padding:6px;border-radius:6px}
.legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.players-section{margin-bottom:20px}
.section-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0}
.section-title{font-size:18px;font-weight:800;color:#1e293b}
.section-count{margin-left:auto;font-size:20px;font-weight:900;color:#667eea}
.players-list{max-height:400px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
.player-row{display:grid;grid-template-columns:2fr 1fr 1fr 1.5fr 1fr 1fr;gap:12px;padding:12px 16px;border-bottom:1px solid #f1f5f9;font-size:13px;transition:all 0.2s}
.player-row:hover{background:#f8fafc}
.player-row:last-child{border-bottom:none}
.player-email{color:#667eea;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px}
.player-email:hover{text-decoration:underline}
.copy-icon{opacity:0;transition:opacity 0.2s;cursor:pointer;font-size:14px}
.player-email:hover .copy-icon{opacity:1}
.player-link{color:#667eea;text-decoration:none;font-weight:600}
.player-link:hover{text-decoration:underline}
.btn-close{background:#fff;border:1px solid #e2e8f0;color:#64748b;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s}
.btn-close:hover{background:#f8fafc;border-color:#667eea;color:#667eea}
.btn-create{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700;transition:all 0.2s;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.btn-create:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
.btn-create:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.err{color:#ef4444;padding:20px;text-align:center;font-size:14px}
.toast{position:fixed;bottom:24px;right:24px;background:#667eea;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(102,126,234,0.4);font-weight:600;font-size:14px;opacity:0;transform:translateY(20px);transition:all 0.3s;z-index:10000}
.toast.show{opacity:1;transform:translateY(0)}
#top-loader{position:fixed;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transform-origin:left;transition:transform 0.3s ease;z-index:10000}#top-loader.loading{animation:loader-progress 2s ease-in-out infinite}@keyframes loader-progress{0%{transform:scaleX(0)}50%{transform:scaleX(0.7)}100%{transform:scaleX(1);opacity:0}}
.vip-tabs-wrap{display:flex;gap:12px;margin:24px 0;padding:8px;background:#f8fafc;border-radius:12px}.vip-tab{padding:12px 24px;background:#fff;border:2px solid transparent;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;color:#64748b}.vip-tab:hover{border-color:#667eea;color:#667eea}.vip-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
.vip-active-filters{display:none;margin:0 0 20px 0;padding:12px 16px;background:#f0f4ff;border:1px solid #c7d2fe;border-radius:8px;font-size:13px}.vip-active-filters.visible{display:block}.vip-active-filters-title{font-weight:700;color:#4338ca;margin-bottom:8px;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}.vip-active-filters-list{display:flex;flex-wrap:wrap;gap:8px}.vip-filter-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#fff;border:1px solid #818cf8;border-radius:6px;color:#4338ca;font-size:12px;font-weight:600}.vip-filter-tag-label{color:#64748b;font-weight:500}.vip-filter-tag-remove{cursor:pointer;color:#94a3b8;font-weight:700;transition:color 0.2s}.vip-filter-tag-remove:hover{color:#ef4444}
.vip-manager-selector{display:flex;align-items:center;gap:12px;margin:0 0 20px 0;padding:12px 16px;background:#fff;border:1px solid #e2e8f0;border-radius:8px}.vip-manager-label{font-weight:600;color:#64748b;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}.vip-manager-dropdown{flex:1;max-width:300px;padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;font-weight:500;color:#1e293b;cursor:pointer;transition:all 0.2s;background:#fff}.vip-manager-dropdown:hover{border-color:#667eea}.vip-manager-dropdown:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.vip-manager-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:6px;font-size:12px;font-weight:600}.vip-manager-clear{padding:6px 12px;background:#f1f5f9;color:#64748b;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s}.vip-manager-clear:hover{background:#e2e8f0;color:#1e293b}
.period-tabs-wrap{display:flex;gap:8px;margin:16px 0;padding:6px;background:#f1f5f9;border-radius:10px;justify-content:center;max-width:560px}.period-tab{background:#fff;border:2px solid #e2e8f0;padding:6px 14px;font-size:12px;font-weight:600;color:#64748b;cursor:pointer;transition:all 0.2s;border-radius:6px;white-space:nowrap}.period-tab:hover{border-color:#667eea;color:#667eea}.period-tab.active{background:#667eea;border-color:#667eea;color:#fff;box-shadow:0 2px 6px rgba(102,126,234,0.3)}
.vip-filter-toggle{position:fixed;top:80px;right:20px;z-index:999;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 16px;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);transition:all 0.3s;font-size:20px}.vip-filter-toggle:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
.vip-filter-badge{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;padding:0 6px;border:2px solid #fff;box-shadow:0 2px 8px rgba(239,68,68,0.4)}
.vip-filter-sidebar{
  position:fixed;
  top:0;
  right:-400px;
  width:380px;
  height:100vh;
  background:#fff;
  box-shadow:-4px 0 24px rgba(0,0,0,0.3);
  z-index:10000;
  transition:right 0.3s ease;
  overflow-y:auto;
  overflow-x:hidden;
}
.vip-filter-sidebar.open{
  right:0;
}
.vip-filter-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  display:none;
  opacity:0;
  transition:opacity 0.3s;
}
.vip-filter-overlay.open{
  display:block;
  opacity:1;
}.vip-filter-header{position:sticky;top:0;background:#fff;padding:20px;border-bottom:2px solid #e2e8f0;z-index:10}.vip-filter-title{font-size:18px;font-weight:700;color:#1e293b;margin-bottom:4px}.vip-filter-subtitle{font-size:13px;color:#64748b}.vip-filter-close{position:absolute;top:20px;right:20px;background:none;border:none;font-size:24px;color:#64748b;cursor:pointer;padding:4px 8px;line-height:1}.vip-filter-close:hover{color:#ef4444}.vip-filter-body{padding:20px}.vip-filter-section{margin-bottom:24px}.vip-filter-section-title{font-size:14px;font-weight:600;color:#1e293b;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}.vip-filter-group{margin-bottom:16px}.vip-filter-group-label{font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;display:block}.vip-filter-items{max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;padding:8px}.vip-filter-item{display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:all 0.2s}.vip-filter-item:hover{background:#f8fafc}.vip-filter-checkbox{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:4px;margin-right:10px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.vip-filter-checkbox.checked{background:#667eea;border-color:#667eea}.vip-filter-checkbox.checked::after{content:'‚úì';color:#fff;font-size:12px;font-weight:bold}.vip-filter-item-text{font-size:13px;color:#1e293b;flex:1}.vip-filter-item-count{font-size:11px;color:#64748b;background:#f1f5f9;padding:2px 8px;border-radius:10px}.vip-filter-search{width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;margin-bottom:8px}.vip-filter-search:focus{outline:none;border-color:#667eea}.vip-filter-actions{position:sticky;bottom:0;background:#fff;padding:20px;border-top:2px solid #e2e8f0}.vip-filter-actions button{width:100%;padding:12px;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;background:#f1f5f9;color:#64748b}.vip-filter-actions button:hover{background:#e2e8f0}
#vip-content{width:100%;box-sizing:border-box}
.vip-cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;margin:24px 0;width:100%;box-sizing:border-box}.vip-card{background:#fff;border:2px solid #e2e8f0;border-radius:16px;padding:24px;transition:all 0.3s ease;box-sizing:border-box}.vip-card:hover{border-color:#667eea;transform:translateY(-4px);box-shadow:0 12px 24px rgba(102,126,234,0.15)}
.vip-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.vip-card-icon{font-size:32px}.vip-card-title{font-size:16px;font-weight:600;color:#64748b}.vip-card-value{font-size:48px;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:12px 0}.vip-card-subtitle{font-size:14px;color:#94a3b8;margin-bottom:16px}.vip-card-sum{font-size:20px;font-weight:600;color:#1e293b;padding-top:16px;border-top:2px solid #f1f5f9}
#vip-metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-top:32px;width:100%;box-sizing:border-box}


/* Metric Modal Table */
.metric-table-container{overflow-x:auto;margin-top:20px}
.metric-table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border-radius:8px;overflow:hidden}
.metric-table thead{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.metric-table th{padding:12px 16px;text-align:left;font-weight:700;cursor:pointer;user-select:none;white-space:nowrap}
.metric-table th.sorted-asc::after{content:" ‚ñ≤";opacity:0.7}
.metric-table th.sorted-desc::after{content:" ‚ñº";opacity:0.7}
.metric-table td{padding:10px 16px;border-bottom:1px solid #e2e8f0;color:#1e293b}
.metric-table tbody tr:hover{background:#f8fafc}
.metric-table tbody tr:last-child td{border-bottom:none}

/* Metric breakdown cards */
.metric-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.metric-breakdown-card{background:#fff;border-radius:12px;padding:20px;border:2px solid #e2e8f0;text-align:center}
.metric-breakdown-label{font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.metric-breakdown-value{font-size:28px;font-weight:900;color:#1e293b}
.metric-breakdown-subtitle{font-size:11px;color:#94a3b8;margin-top:4px}

/* Responsive padding */
@media (max-width: 1400px) {
  .content, .content.active { padding: 0 60px !important; }
}

@media (max-width: 1024px) {
  .content, .content.active { padding: 0 40px !important; }
}

@media (max-width: 768px) {
  .content, .content.active { padding: 0 24px !important; }
}

@media (max-width: 480px) {
  .content, .content.active { padding: 0 16px !important; }
}

/* ============================================
   Social Media Icons - Brand Colors
   ============================================ */
a[title="Whatsapp"]:hover, a[title="WhatsApp"]:hover {
  background: #25D366 !important;
}

a[title="Telegram"]:hover {
  background: #0088cc !important;
}

a[title="Signal"]:hover {
  background: #3a76f0 !important;
}

a[title="Messenger"]:hover {
  background: #0084ff !important;
}

a[title="Facebook"]:hover {
  background: #1877f2 !important;
}

a[title="Instagram"]:hover {
  background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%) !important;
}

a[title="Intercom"]:hover {
  background: #0085ff !important;
}

a[title="Viber"]:hover {
  background: #665CAC !important;
}

a[title="WeChat"]:hover, a[title="Wechat"]:hover {
  background: #09B83E !important;
}

a[title="Twitter"]:hover {
  background: #1DA1F2 !important;
}

a[title="X"]:hover {
  background: #000000 !important;
}

a[title="LinkedIn"]:hover, a[title="Linkedin"]:hover {
  background: #0077b5 !important;
}

a[title="TikTok"]:hover, a[title="Tiktok"]:hover {
  background: #000000 !important;
}

a[title="Snapchat"]:hover {
  background: #FFFC00 !important;
  color: #000 !important;
}

a[title="Discord"]:hover {
  background: #5865F2 !important;
}

a[title="Skype"]:hover {
  background: #00aff0 !important;
}

a[title="Reddit"]:hover {
  background: #FF4500 !important;
}

a[title="YouTube"]:hover, a[title="Youtube"]:hover {
  background: #FF0000 !important;
}

a[title="Twitch"]:hover {
  background: #9146FF !important;
}

a[title="Pinterest"]:hover {
  background: #E60023 !important;
}

a[title="VK"]:hover {
  background: #0077FF !important;
}

a[title="Line"]:hover, a[title="LINE"]:hover {
  background: #00B900 !important;
}

/* ============================================
   Big Icons [BICON] - Brand Colors
   ============================================ */
a[title="BO"]:hover, a[title="Bo"]:hover, a[title="BackOffice"]:hover, a[title="Back Office"]:hover {
  background: #4CAF50 !important;
}

a[title="JIRA"]:hover, a[title="Jira"]:hover {
  background: #0052CC !important;
}

/* Icon size adjustments */
.fa-brands, .fas {
  line-height: 1;
}

/* ===== Unified Flip Card Modal ===== */
.unified-flip-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.unified-flip-modal.show {
  display: flex;
}

.flip-card-container {
  width: 90%;
  max-width: 1200px;
  height: 85vh;
  perspective: 2000px;
}

.flip-card {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
  transform-style: preserve-3d;
}

.flip-card.flipped {
  transform: rotateY(180deg);
}

.flip-card-side {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border: 1px solid var(--border);
}

.flip-card-front {
  transform: rotateY(0deg);
}

.flip-card-back {
  transform: rotateY(180deg);
}

.unified-card-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-bottom: 1px solid var(--border);
  padding: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.unified-card-title-area {
  display: flex;
  align-items: center;
  gap: 16px;
}

.unified-card-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}

.unified-card-title-text h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
  color: #fff;
}

.unified-card-title-text p {
  margin: 4px 0 0 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

.unified-card-header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.flip-toggle-btn {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  backdrop-filter: blur(10px);
}

.flip-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.unified-card-close {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 32px;
  color: #fff;
}

.unified-card-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

.unified-card-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 24px;
}

.unified-card-body::-webkit-scrollbar {
  width: 6px;
}

.unified-card-body::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

@media (max-width: 768px) {
  .flip-card-container {
    width: 95%;
    height: 90vh;
  }
  
  .unified-card-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .unified-card-header-actions {
    width: 100%;
    justify-content: flex-end;
  }
}
.profiling-type-tab.active {
  color: #667eea !important;
  border-bottom-color: #667eea !important;
}

.profiling-type-tab:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

/* Filter Sidebar Styles */
.filter-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.filter-overlay.active {
  opacity: 1;
  visibility: visible;
}

.filter-sidebar {
  position: fixed;
  top: 0;
  right: -450px;
  width: 420px;
  height: 100%;
  background: #fff;
  box-shadow: -8px 0 32px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
}

.filter-sidebar.active {
  right: 0;
}

.sidebar-header {
  padding: 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  flex-shrink: 0;
}

.sidebar-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-subtitle {
  font-size: 13px;
  opacity: 0.9;
}

.close-sidebar-btn {
  position: absolute;
  top: 24px;
  right: 24px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  line-height: 1;
}

.close-sidebar-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.sidebar-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.sidebar-filter-group {
  margin-bottom: 24px;
}

.sidebar-filter-label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 10px;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-filter-search {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 13px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.sidebar-filter-search:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.sidebar-filter-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 6px;
  background: #f8fafc;
}

.sidebar-filter-item {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  gap: 10px;
}

.sidebar-filter-item:hover {
  background: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.sidebar-filter-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #667eea;
  margin: 0;
}

.sidebar-filter-item-label {
  flex: 1;
  cursor: pointer;
  font-size: 14px;
  color: #1e293b;
  font-weight: 500;
}

.sidebar-filter-count {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.sidebar-footer {
  padding: 20px;
  border-top: 2px solid #e2e8f0;
  background: #f8fafc;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.sidebar-btn-apply {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.sidebar-btn-apply:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.sidebar-btn-clear {
  width: 100%;
  padding: 15px;
  background: #fff;
  color: #64748b;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.sidebar-btn-clear:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.sidebar-filter-list::-webkit-scrollbar,
.sidebar-body::-webkit-scrollbar {
  width: 8px;
}

.sidebar-filter-list::-webkit-scrollbar-track,
.sidebar-body::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.sidebar-filter-list::-webkit-scrollbar-thumb,
.sidebar-body::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

.sidebar-filter-list::-webkit-scrollbar-thumb:hover,
.sidebar-body::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

@media (max-width: 768px) {
  .filter-sidebar {
    width: 100%;
    right: -100%;
  }
}

</style>
</head>
<body>
<div id="top-loader"></div>
<div id="splash">
<div class="splash-content">
<div class="splash-logo">üå™Ô∏è Slotornado</div>
<div class="splash-spinner"></div>
<div class="splash-text">Loading analytics...</div>
</div>
</div>

<div class="container">
<div class="sidebar" id="sidebar">
<div class="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</div>
<div class="sidebar-header">
<div class="logo" onclick="toggleSidebar()">üå™Ô∏è Slotornado</div>
<div class="subtitle">Analytics Suite</div>
</div>

<div class="player-search-container" style="padding:16px;border-bottom:1px solid #e2e8f0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)">
  <div style="position:relative">
    <input 
      type="text" 
      id="playerSearchInput" 
      placeholder="üîç Search by email..." 
      style="width:100%;padding:12px 40px 12px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;outline:none"
      onkeypress="if(event.key==='Enter') searchPlayer()"
      onfocus="this.style.borderColor='#667eea';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
      onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'"
    />
    <button 
      onclick="searchPlayer()" 
      style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#667eea;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s"
      onmouseover="this.style.background='#5568d3';this.style.transform='translateY(-50%) scale(1.05)'"
      onmouseout="this.style.background='#667eea';this.style.transform='translateY(-50%) scale(1)'"
    >
      GO
    </button>
  </div>
</div>

<div class="sidebar-nav">
<div class="nav-item active" data-view="deposit">
<span class="nav-icon">üí∞</span>
<span>Deposit Conversion</span>
</div>
<div class="nav-item" data-view="retention">
<span class="nav-icon">üìä</span>
<span>Retention Rate</span>
</div>
<div class="nav-item" data-view="kpi">
<span class="nav-icon">üìà</span>
<span>KPI Dashboard</span>
</div>

<!-- DYNAMIC TABS WILL BE INSERTED HERE -->
<div id="dynamicTabsContainer"></div>

</div>

<!-- Player Profiling Section (Separate) -->
<div style="margin-top:auto;padding-top:16px;border-top:2px solid #e2e8f0">
  <div class="profiling-btn" onclick="showProfilingView()" style="margin:12px 8px;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(102,126,234,0.3)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
    <div style="display:flex;align-items:center;gap:12px;color:#fff">
      <span style="font-size:28px">üëë</span>
      <div style="flex:1">
        <div style="font-weight:800;font-size:14px;line-height:1.2">Player Profiling</div>
        <div style="font-size:11px;opacity:0.9;margin-top:2px">VIP Management</div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="main-wrapper">
<div class="main">
<div class="content active" id="deposit-view">
<h1>üí∞ Deposit Conversion</h1>
<p class="desc">FTD Players Deposit Progression Analysis</p>

<button class="open-filter-btn" onclick="openDepositFilterSidebar()" style="position:fixed;top:20px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s">
  üîç
</button>

<div class="chart-section">
<div class="chart-header">
<div class="chart-title">üìä Deposit Conversion Chart</div>
<div class="metric-selector" id="metricSelector"></div>
</div>
<div class="chart-container">
<canvas id="conversionChart"></canvas>
</div>
</div>
<div style="display:flex;justify-content:flex-end;margin-bottom:12px;padding:0 24px">
<label class="heatmap-toggle">
<input type="checkbox" id="depositHeatmapToggle" checked onchange="toggleDepositHeatmap()">
<span class="toggle-label">Show %</span>
</label>
</div>
<div class="table-wrap">
<table id="deposit-table"></table>
</div>
</div>

<div class="content" id="retention-view">
<h1>üìä Retention Rate</h1>
<p class="desc">FTD to Active Retention Analysis</p>

<button class="open-filter-btn" onclick="openRetentionFilterSidebar()" style="position:fixed;top:20px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s">
  üîç
</button>

<div style="display:flex;gap:12px;margin-bottom:20px">
<button class="metric-btn active" id="retentionMonthlyTab" onclick="switchRetentionMode('monthly')" style="padding:12px 24px;font-size:14px">üìÖ Monthly</button>
<button class="metric-btn" id="retentionWeeklyTab" onclick="switchRetentionMode('weekly')" style="padding:12px 24px;font-size:14px">üìÜ Weekly</button>
</div>

<div style="margin-bottom:30px">
<div class="chart-header">
<div class="chart-title">üìä Retention Cohort Chart</div>
<div class="metric-selector" id="retentionMetricSelector"></div>
</div>
<div class="chart-container" style="height:300px">
<canvas id="retentionChart"></canvas>
</div>
</div>

<div style="display:flex;justify-content:flex-end;margin-bottom:12px;padding:0 24px">
<label class="heatmap-toggle">
<input type="checkbox" id="retentionHeatmapToggle" checked onchange="toggleRetentionHeatmap()">
<span class="toggle-label">Show %</span>
</label>
</div>

<div class="table-wrap">
<table id="retention-table"></table>
</div>
</div>

<div class="content" id="profiling-view">
<h1>üëë VIP Player Profiling</h1>
<p class="desc">Manage and analyze VIP players</p>

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:16px">
  <div style="display:flex;gap:12px;flex:1">
    <div style="position:relative;flex:1;max-width:400px">
      <input type="text" id="profilingSearchInput" placeholder="üîç Search players..." style="width:100%;padding:10px 14px 10px 46px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;outline:none;transition:all 0.2s" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
      <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:#64748b;pointer-events:none">üîç</span>
    </div>
    
    <div style="position:relative">
      <select id="profilingTypeFilter" onchange="handleProfilingTypeFilter()" style="padding:10px 16px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;outline:none;cursor:pointer;min-width:150px;transition:all 0.2s" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
        <option value="ALL">All Types</option>
        <!-- Dynamic options will be populated here -->
      </select>
    </div>
  </div>
  
  <div style="display:flex;gap:12px">
    <button id="profilingAddPlayerBtn" onclick="openProfilingAddModal()" style="padding:10px 20px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
      ‚ûï Add Player
    </button>
    
    <button id="profilingAnalyticsBtn" onclick="toggleProfilingAnalytics()" style="padding:10px 20px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:#059669;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(16,185,129,0.2)'" onmouseout="this.style.background='rgba(16,185,129,0.1)'">
      üìä Analytics
    </button>
    
    <button id="profilingViewToggle" onclick="toggleProfilingView()" style="padding:10px 20px;background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.3);border-radius:8px;color:#667eea;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(102,126,234,0.2)'" onmouseout="this.style.background='rgba(102,126,234,0.1)'">
      <span id="profilingViewIcon">‚äû</span> Grid View
    </button>
  </div>
</div>

<div id="profilingManagerTabs" style="display:flex;gap:6px;overflow-x:auto;padding:4px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:12px;scrollbar-width:none">
  <!-- Manager tabs will be inserted here -->
</div>

<!-- Type Subtabs - Dynamic -->
<div id="profilingTypeTabs" style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:2px">
  <!-- Dynamic type tabs will be inserted here -->
</div>

<div style="min-height:400px">
  <div id="profilingPlayersContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
    <!-- Player cards will be inserted here -->
  </div>
  
  <div id="profilingAnalyticsContainer" style="display:none">
    <!-- Analytics view will be inserted here -->
  </div>
  
  <div id="profilingEmptyState" style="display:none;text-align:center;padding:80px 40px;color:#64748b">
    <div style="font-size:64px;margin-bottom:20px;opacity:0.5">üë•</div>
    <div style="font-size:18px;font-weight:600;margin-bottom:8px">No [PROFILING] Sheets Found</div>
    <div style="font-size:14px;opacity:0.7;line-height:1.6">
      Please create sheets with names like:<br>
      <strong>[PROFILING] Ann</strong><br>
      <strong>[PROFILING] Kevin</strong><br>
      <strong>[PROFILING] preVIPs</strong><br><br>
      Sheet must have at least <strong>email</strong> column<br>
      (can be "EMAIL", "EMAIL [PREV]", etc)
    </div>
  </div>
</div>

<div id="profilingPlayerDetail" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:40px;overflow:auto">
  <!-- Player detail modal content -->
</div>

</div>

<div class="content" id="kpi-view">
<h1>üìà KPI Dashboard</h1>
<p class="desc">Monthly & weekly performance metrics</p>

<div class="kpi-tabs" id="kpiTabs"></div>

<div id="kpiNormalView">
<div class="kpi-layout">
<div class="kpi-sidebar">
<div class="period-header">üìÖ Select Periods</div>
<div id="kpiPeriods">Loading...</div>
</div>

<div class="kpi-main">
<div id="selectedMetricDisplay" class="selected-metric-display" style="display:none">
<div class="selected-metric-label">Selected Metric</div>
<div class="selected-metric-value" id="selectedMetricName">-</div>
</div>

<div class="kpi-chart-wrap">
<div class="chart-header">
<div class="metric-selector" id="kpiMetrics"></div>
</div>
<div class="chart-container"><canvas id="kpiChart"></canvas></div>
</div>

<div class="kpi-table-wrap">
<div class="metrics-filter" id="metricsFilter">
<div class="metrics-filter-header" onclick="toggleMetricsFilter()">
<span>üìä Visible Metrics</span>
<span class="metrics-filter-toggle">‚ñº</span>
</div>
<div class="metrics-grid" id="metricsFilterGrid"></div>
</div>
<div class="chart-title" style="margin-bottom:16px">üìã Data Table</div>
<div style="overflow:auto">
<table id="kpi-table"></table>
</div>
</div>
</div>
</div>
</div>

<div id="kpiCompareView" style="display:none">
<div class="compare-controls">
<div class="compare-selector">
<label class="compare-label">First Tab:</label>
<select id="compareTab1" class="compare-dropdown" onchange="renderCompareData()"></select>
</div>
<div class="compare-vs">VS</div>
<div class="compare-selector">
<label class="compare-label">Second Tab:</label>
<select id="compareTab2" class="compare-dropdown" onchange="renderCompareData()"></select>
</div>
</div>

<div class="kpi-main" style="width:100%">
<div id="compareMetricDisplay" class="selected-metric-display" style="display:none">
<div class="selected-metric-label">Comparing Metric</div>
<div class="selected-metric-value" id="compareMetricName">-</div>
</div>

<div class="kpi-chart-wrap">
<div class="chart-header">
<div class="metric-selector" id="compareMetrics"></div>
</div>
<div class="chart-container"><canvas id="compareChart"></canvas></div>
</div>

<div class="kpi-table-wrap">
<div class="chart-title" style="margin-bottom:16px">üìã Comparison Table</div>
<div style="overflow:auto">
<table id="compare-table"></table>
</div>
</div>
</div>
</div>

</div>
</div>
</div>

<div class="content" id="vip-view">
<h1>üëë VIP Dashboard</h1>
<p class="desc">VIP & Silent VIP Players Analytics</p>

<div class="vip-tabs-wrap">
<button class="vip-tab active" data-tab="total" onclick="switchVIPTab('total')">TOTAL</button>
<button class="vip-tab" data-tab="vip" onclick="switchVIPTab('vip')">VIP</button>
<button class="vip-tab" data-tab="silent-vip" onclick="switchVIPTab('silent-vip')">SILENT VIP</button>
</div>

<div class="period-tabs-wrap">
<button class="period-tab" data-period="lifetime" onclick="switchPeriod('lifetime')">Lifetime</button>
<button class="period-tab active" data-period="30" onclick="switchPeriod('30')">30 days</button>
<button class="period-tab" data-period="90" onclick="switchPeriod('90')">90 days</button>
<button class="period-tab" data-period="7" onclick="switchPeriod('7')">7 days</button>
<button class="period-tab" data-period="1" onclick="switchPeriod('1')">1 day</button>
</div>

<div class="vip-active-filters" id="vipActiveFilters">
<div class="vip-active-filters-title">üîç Active Filters</div>
<div class="vip-active-filters-list" id="vipActiveFiltersList"></div>
</div>

<div class="vip-manager-selector" id="vipManagerSelector" style="display:none">
<div class="vip-manager-label">üë• By Manager</div>
<select class="vip-manager-dropdown" id="vipManagerDropdown" onchange="selectManager(this.value)">
<option value="">All Managers</option>
</select>
<div class="vip-manager-badge" id="vipManagerBadge" style="display:none"></div>
<button class="vip-manager-clear" id="vipManagerClearBtn" onclick="clearManager()" style="display:none">Clear</button>
</div>

<button class="vip-filter-toggle" onclick="toggleVIPFilterSidebar()">
üîç
<span class="vip-filter-badge" id="vip-filter-badge" style="display:none">0</span>
</button>

<!-- Filter Overlays -->
<div class="vip-filter-overlay" id="vipFilterOverlay" onclick="toggleVIPFilterSidebar()"></div>

<div class="vip-filter-sidebar" id="vipFilterSidebar">
<div class="vip-filter-header">
<div class="vip-filter-title">üîç VIP Filters</div>
<div class="vip-filter-subtitle">Instant filtering</div>
<button class="vip-filter-close" onclick="toggleVIPFilterSidebar()">√ó</button>
</div>

<div class="vip-filter-body">
<div class="vip-filter-section">
<div class="vip-filter-section-title">üè∑Ô∏è VIP Type</div>

<div class="vip-filter-group">
<div class="vip-filter-items" id="vipTypeFilterItems">
<div class="vip-filter-item" onclick="toggleVIPTypeFilter('VIP')">
<div class="vip-filter-checkbox" id="vipTypeVIP"></div>
<span class="vip-filter-item-text">VIP</span>
</div>
<div class="vip-filter-item" onclick="toggleVIPTypeFilter('Silent VIP')">
<div class="vip-filter-checkbox" id="vipTypeSilent"></div>
<span class="vip-filter-item-text">Silent VIP</span>
</div>
</div>
</div>
</div>

<div class="vip-filter-section">
<div class="vip-filter-section-title">üìä Player Attributes</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">VIP Manager</label>
<input type="text" class="vip-filter-search" id="vipManagerSearch" placeholder="Search managers...">
<div class="vip-filter-items" id="vipManagerFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Traffic Type</label>
<input type="text" class="vip-filter-search" id="vipTrafficSearch" placeholder="Search traffic types...">
<div class="vip-filter-items" id="vipTrafficFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Country</label>
<input type="text" class="vip-filter-search" id="vipCountrySearch" placeholder="Search countries...">
<div class="vip-filter-items" id="vipCountryFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Currency</label>
<input type="text" class="vip-filter-search" id="vipCurrencySearch" placeholder="Search currencies...">
<div class="vip-filter-items" id="vipCurrencyFilterItems"></div>
</div>
</div>

<div class="vip-filter-section" id="vipDynamicFilters">
<div class="vip-filter-section-title">üéØ Dynamic Filters</div>
</div>
</div>

<div class="vip-filter-actions">
<button onclick="clearAllVIPFilters()">üîÑ Clear All Filters</button>
</div>
</div>

<div id="vip-content"></div>

</div>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-card">
<div class="modal-header">
<div class="modal-title" id="modalTitle">Players</div>
<div class="modal-tools">
<button class="btn-create" id="btnCreateSheet">üìÑ Create Sheet</button>
<button class="btn-close" onclick="closeModal()">‚úï Close</button>
</div>
</div>
<div class="modal-body" id="modalBody"></div>
</div>
</div>

<div class="modal" id="metricModal" style="display:none">
<div class="modal-card" style="max-width:1400px;max-height:90vh">
<div class="modal-header">
<div class="modal-title" id="metricModalTitle">Metric Details</div>
<div class="modal-tools">
<button class="btn-close" onclick="closeMetricModal()">‚úï Close</button>
</div>
</div>
<div class="modal-body" id="metricModalBody" style="overflow-y:auto;max-height:calc(90vh - 80px)"></div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// Verify Chart.js loaded
if(typeof Chart==='undefined'){
  console.error('Chart.js failed to load!');
  alert('Chart library not loaded. Please refresh the page.');
}else{
  try{
    Chart.register(ChartDataLabels);
  }catch(e){
    console.error('ChartDataLabels registration failed:',e);
  }
}

let allData=null,retentionData=null,weeklyRetentionData=null,kpiDataByTab={},vipData=null,selectedMonths=[],currentMetric='FTD',currentVIPTab='total',barChart=null,retentionChart=null,kpiChart=null,compareChart=null,currentRetentionMonth=0;
let depositFilters={type:[],manager:[],trafficType:[],country:[]};
let retentionFilters={type:[],manager:[],trafficType:[],country:[]};
let tagToTypeMap={}; // Global TYPE mapping from Google Sheets
let typeMapping={}; // TYPE -> [tags] mapping
let allPlayersData=[];
let depositCellsLoaded = false;
let retentionCellsLoaded = false;
let playersCellMap=new Map();
let retentionPlayersCellMap=new Map();
let weeklyRetentionPlayersCellMap=new Map();
let kpiSelectedPeriods=new Set(),kpiCurrentMetric=null,kpiCurrentTab='VIP',kpiVisibleMetrics=new Set();
let compareTab1='',compareTab2='',compareCurrentMetric=null;
let heatmapShowPercent=true;
let metricFormats={};
let retentionMode='monthly';
let currentRetentionWeek=0;
const depositRanges=['FTD','2+','3+','4+','5+','6+','7+','8+','9+','10+','11-15','16-20','21-25','26-30','31-40','41-50','50+'];
const pieColors=['#667eea','#3b82f6','#f59e0b','#8b5cf6','#ef4444','#64748b','#06b6d4','#ec4899','#84cc16','#f97316'];

// ============================================
// GLOBAL: Copy email on double-click
// ============================================
function copyEmailToClipboard(email) {
  if (!email) return;
  
  // Create temporary input
  var temp = document.createElement('input');
  temp.value = email;
  temp.style.position = 'absolute';
  temp.style.left = '-9999px';
  document.body.appendChild(temp);
  temp.select();
  
  try {
    document.execCommand('copy');
    
    // Show toast notification
    showCopyToast('üìã Email copied: ' + email);
  } catch (err) {
    console.error('Failed to copy:', err);
  }
  
  document.body.removeChild(temp);
}

function showCopyToast(message) {
  var toast = document.getElementById('copyToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'copyToast';
    toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#10b981;color:#fff;padding:16px 24px;border-radius:12px;font-weight:700;font-size:14px;z-index:100000;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;pointer-events:none';
    document.body.appendChild(toast);
    
    var style = document.createElement('style');
    style.textContent = '@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }';
    document.head.appendChild(style);
  }
  
  toast.textContent = message;
  toast.style.display = 'block';
  toast.style.animation = 'slideIn 0.3s ease';
  
  setTimeout(function() {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(function() {
      toast.style.display = 'none';
    }, 300);
  }, 2000);
}

function makeEmailCopyable(element, email) {
  if (!element || !email) return;
  
  element.style.cursor = 'pointer';
  element.title = 'Double-click to copy email';
  
  element.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    copyEmailToClipboard(email);
  });
}

// Dynamic Tabs System
let dynamicTabsConfig=null;
let dynamicTabsData={};  // Stores data for each dynamic tab group

// Icon mapping for dynamic tabs
const tabIconMap={
  'vip_dashboard':'üëë',
  'previp_dashboard':'‚è∞',
  'one_day':'üìÖ',
  'retention':'üìä',
  'weekly':'üóìÔ∏è'
};

// Load dynamic tabs configuration on startup
function loadDynamicTabsConfig(){
  console.log('üîÑ Loading dynamic tabs config...');
  google.script.run
    .withSuccessHandler(function(config){
      console.log('‚úÖ Dynamic tabs config loaded:',config);
      dynamicTabsConfig=config;
      buildDynamicSidebar();
    })
    .withFailureHandler(function(err){
      console.error('‚ùå Failed to load dynamic tabs config:',err);
    })
    .getVIPTabsConfig();
}

// Build dynamic sidebar items from config
function buildDynamicSidebar(){
  if(!dynamicTabsConfig){
    console.log('‚ö†Ô∏è No dynamic tabs config available');
    return;
  }
  
  const container=document.getElementById('dynamicTabsContainer');
  if(!container){
    console.error('‚ùå dynamicTabsContainer not found!');
    return;
  }
  
  container.innerHTML='';
  
  // Sort groups alphabetically
  const sortedGroups=Object.keys(dynamicTabsConfig).sort();
  
  sortedGroups.forEach(function(prefix){
    const group=dynamicTabsConfig[prefix];
    const groupId=group.id;
    const displayName=group.displayName;
    const icon=tabIconMap[groupId]||'üìä';
    
    console.log('Building nav item for:',prefix,'‚Üí',groupId);
    
    // Create nav item
    const navItem=document.createElement('div');
    navItem.className='nav-item';
    navItem.dataset.view=groupId;
    navItem.dataset.dynamic='true';
    
    // Icon
    const iconSpan=document.createElement('span');
    iconSpan.className='nav-icon';
    iconSpan.textContent=icon;
    iconSpan.onclick=function(){switchToDynamicView(groupId)};
    
    // Label
    const labelSpan=document.createElement('span');
    labelSpan.textContent=displayName;
    labelSpan.style.flex='1';
    labelSpan.onclick=function(){switchToDynamicView(groupId)};
    
    // Submenu toggle
    const toggleSpan=document.createElement('span');
    toggleSpan.className='sidebar-submenu-toggle';
    toggleSpan.id=groupId+'SubmenuToggle';
    toggleSpan.textContent='‚ñº';
    toggleSpan.onclick=function(e){
      e.stopPropagation();
      toggleDynamicSubmenu(groupId);
    };
    
    navItem.appendChild(iconSpan);
    navItem.appendChild(labelSpan);
    navItem.appendChild(toggleSpan);
    
    // Create submenu container
    const submenu=document.createElement('div');
    submenu.className='sidebar-submenu';
    submenu.id=groupId+'Submenu';
    
    container.appendChild(navItem);
    container.appendChild(submenu);
  });
  
  console.log('‚úÖ Dynamic sidebar built with',sortedGroups.length,'groups');
  
  // Setup click handlers for dynamic nav items
  setupDynamicNavHandlers();
}

// Setup click handlers for dynamic tabs
function setupDynamicNavHandlers(){
  document.querySelectorAll('.nav-item[data-dynamic="true"]').forEach(item=>{
    item.onclick=function(){
      const viewId=item.dataset.view;
      switchToDynamicView(viewId);
    };
  });
}

// Switch to dynamic view
function switchToDynamicView(groupId){
  console.log('Switching to dynamic view:',groupId);
  
  // Update nav items
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  
  const navItem=document.querySelector('.nav-item[data-view="' + groupId + '"]');
  if(navItem)navItem.classList.add('active');
  
  // Use VIP view for all dynamic tabs
  const vipView=document.getElementById('vip-view');
  if(vipView){
    vipView.classList.add('active');
    
    // Update header
    const config=dynamicTabsConfig;
    let displayName='Dashboard';
    let icon='üìä';
    
    Object.keys(config).forEach(function(prefix){
      if(config[prefix].id===groupId){
        displayName=config[prefix].displayName;
        icon=tabIconMap[groupId]||'üìä';
      }
    });
    
    const h1=vipView.querySelector('h1');
    if(h1)h1.textContent=icon+' '+displayName;
  }
  
  // Data already loaded during splash - just render
  if(dynamicTabsData[groupId]){
    renderDynamicTab(groupId);
  }else{
    console.warn('Data not loaded for',groupId,'- loading now...');
    loadDynamicTabData(groupId);
  }
}



// Toggle dynamic submenu
function toggleDynamicSubmenu(groupId){
  const submenu=document.getElementById(groupId+'Submenu');
  const toggle=document.getElementById(groupId+'SubmenuToggle');
  
  if(!submenu||!toggle)return;
  
  submenu.classList.toggle('open');
  toggle.classList.toggle('open');
}

// Load data for dynamic tab
function loadDynamicTabData(groupId){
  console.log('üì• Loading data for',groupId,'...');
  
  const vipContent=document.getElementById('vip-content');
  if(vipContent){
    vipContent.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚è≥</div><div style="font-size:18px;font-weight:600">Loading Data...</div></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(data){
      console.log('‚úÖ Data loaded for',groupId,':',data);
      dynamicTabsData[groupId]=data;
      renderDynamicTab(groupId);
    })
    .withFailureHandler(function(err){
      console.error('‚ùå Failed to load data for',groupId,':',err);
      if(vipContent){
        vipContent.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">Failed to Load Data</div><div style="font-size:14px">' + err + '</div></div>';
      }
    })
    .getVIPGroupData(groupId);
}

// Reset VIP tab labels to default
function resetVIPTabLabels(){
  const vipTabBtn = document.querySelector('.vip-tab[data-tab="vip"]');
  const silentTabBtn = document.querySelector('.vip-tab[data-tab="silent-vip"]');
  
  if(vipTabBtn) vipTabBtn.textContent = 'VIP';
  if(silentTabBtn) silentTabBtn.textContent = 'SILENT VIP';
}

// Render dynamic tab (simple approach - reuse VIP Dashboard rendering)
function renderDynamicTab(groupId){
  const data=dynamicTabsData[groupId];
  
  if(!data){
    console.warn('No data for',groupId);
    return;
  }
  
  console.log('Rendering dynamic tab:',groupId,'with data:',data);
  
  // Set adaptive tab labels based on sheet suffixes
  let vipLabel = 'VIP';
  let silentLabel = 'SILENT VIP';
  
  if(data.sheets && data.sheets.length > 0){
    // Get unique suffixes from sheet names
    const suffixes = new Set();
    const config = dynamicTabsConfig;
    
    Object.keys(config).forEach(function(prefix){
      if(config[prefix].id === groupId){
        config[prefix].sheets.forEach(function(sheetInfo){
          const suffix = sheetInfo.suffix.toUpperCase();
          suffixes.add(suffix);
        });
      }
    });
    
    const suffixArray = Array.from(suffixes).sort();
    
    // Set custom labels for VIP tabs
    if(suffixArray.length >= 2){
      // Two or more types - first = VIP, second = Silent
      vipLabel = suffixArray[0];
      silentLabel = suffixArray[1];
    } else if(suffixArray.length === 1){
      // One type - use for both
      vipLabel = suffixArray[0];
      silentLabel = suffixArray[0];
    }
    
    console.log('Adaptive tab labels: VIP =',vipLabel,', Silent =',silentLabel);
  }
  
  // Update VIP tab button labels
  const vipTabBtn = document.querySelector('.vip-tab[data-tab="vip"]');
  const silentTabBtn = document.querySelector('.vip-tab[data-tab="silent-vip"]');
  
  if(vipTabBtn) vipTabBtn.textContent = vipLabel;
  if(silentTabBtn) silentTabBtn.textContent = silentLabel;
  
  // Set vipData
  vipData=data;
  
  // Backend now returns allPlayers in correct format: {vip: [...], silentVip: [...]}
  window.vipAllPlayers = data.allPlayers || null;
  
  if(window.vipAllPlayers){
    console.log('Set vipAllPlayers:',
      (window.vipAllPlayers.vip?window.vipAllPlayers.vip.length:0),'VIP +',
      (window.vipAllPlayers.silentVip?window.vipAllPlayers.silentVip.length:0),'Silent');
  }
  
  currentVIPTab='total';
  
  // Render VIP Dashboard
  renderVIPDashboard();
  renderVIPFilters();
  
  // Populate manager submenu
  populateDynamicSubmenu(groupId,data);
}

// Populate manager submenu for dynamic tab
function populateDynamicSubmenu(groupId,data){
  const submenu=document.getElementById(groupId+'Submenu');
  const toggle=document.getElementById(groupId+'SubmenuToggle');
  
  if(!submenu)return;
  
  console.log('Populating submenu for',groupId);
  
  // Get managers from players
  const managersSet=new Set();
  
  // allPlayers is in format {vip: [...], silentVip: [...]}
  if(data.allPlayers){
    const allPlayersList = [];
    
    if(data.allPlayers.vip){
      allPlayersList.push(...data.allPlayers.vip);
    }
    
    if(data.allPlayers.silentVip){
      allPlayersList.push(...data.allPlayers.silentVip);
    }
    
    allPlayersList.forEach(function(player){
      const manager = getPlayerManager(player);
      if(manager){
        managersSet.add(manager);
      }
    });
  }
  
  const managers=Array.from(managersSet).sort();
  
  if(managers.length===0){
    submenu.innerHTML='';
    if(toggle) toggle.style.display='none';
    return;
  }
  
  submenu.innerHTML='';
  
  managers.forEach(function(manager){
    const item=document.createElement('div');
    item.className='sidebar-submenu-item';
    item.innerHTML='<span class="sidebar-submenu-item-icon">üë§</span><span>' + manager + '</span>';
    item.onclick=function(){
      // Filter by this manager in VIP Dashboard
      console.log('Filter by manager:',manager);
      
      // Select manager in dropdown
      const dropdown = document.getElementById('vipManagerDropdown');
      if(dropdown){
        dropdown.value = manager;
        selectManager(manager);
      }
    };
    submenu.appendChild(item);
  });
  
  console.log('Submenu populated with',managers.length,'managers');
  
  // Show toggle and open submenu
  if(toggle){
    toggle.style.display='inline-block';
  }
  
  // Open submenu by default
  submenu.classList.add('open');
  if(toggle) toggle.classList.add('open');
}

document.querySelectorAll('.nav-item').forEach(item=>{item.onclick=()=>{
document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
item.classList.add('active');
const view=item.dataset.view;
document.getElementById(view+'-view').classList.add('active');
if(view==='retention'){
switchRetentionMode('monthly');
}else if(view==='deposit'){
renderBarChart();
renderDepositTable();
}else if(view==='kpi'){
if(kpiCurrentTab){
  renderKpiSidebar();
  renderKpiMetrics();
  if(kpiCurrentMetric && kpiSelectedPeriods.size > 0){
    renderKpiChart();
    renderKpiTable();
  }
}
}else if(view==='vip'){
resetVIPTabLabels();  // Reset to default VIP/SILENT VIP labels
renderVIPDashboard();
}
}});

loadData();

function loadData(){
  Promise.all([
    loadTypeMapping(),  // Load TYPE mapping first
    loadDepositData(),
    loadRetentionData(),
    loadWeeklyRetentionData(),
    loadKpiData(),
    loadVIPData(),
    loadProfilingData(),  // Preload profiling data
    loadDynamicTabsConfigAsync()  // Load dynamic tabs during splash
  ]).then(()=>{
    document.getElementById('splash').classList.add('hide');
    setupGlobalClickHandler();
    renderInitialFilters();
    renderBarChart();
    renderDepositTable();
    setTimeout(()=>{
      loadAllPlayersForFilters();
      loadAllRetentionPlayersForFilters();
    },2000);
  });
}

// Async version of loadDynamicTabsConfig for Promise.all
function loadDynamicTabsConfigAsync(){
  return new Promise((resolve)=>{
    console.log('üîÑ Loading dynamic tabs config...');
    google.script.run
      .withSuccessHandler(function(config){
        console.log('‚úÖ Dynamic tabs config loaded:',config);
        dynamicTabsConfig=config;
        buildDynamicSidebar();
        
        // Load all dynamic tabs data during splash
        loadAllDynamicTabsData().then(resolve);
      })
      .withFailureHandler(function(err){
        console.error('‚ùå Failed to load dynamic tabs config:',err);
        resolve();
      })
      .getVIPTabsConfig();
  });
}

// Load data for all dynamic tabs
function loadAllDynamicTabsData(){
  if(!dynamicTabsConfig){
    return Promise.resolve();
  }
  
  const promises=[];
  
  Object.keys(dynamicTabsConfig).forEach(function(prefix){
    const groupId=dynamicTabsConfig[prefix].id;
    
    const promise=new Promise((resolve)=>{
      console.log('üì• Preloading',groupId,'data...');
      google.script.run
        .withSuccessHandler(function(data){
          console.log('‚úÖ',groupId,'data loaded');
          dynamicTabsData[groupId]=data;
          
          // Populate submenu for this group
          populateDynamicSubmenu(groupId,data);
          
          resolve();
        })
        .withFailureHandler(function(err){
          console.error('‚ùå',groupId,'failed:',err);
          resolve();
        })
        .getVIPGroupData(groupId);
    });
    
    promises.push(promise);
  });
  
  return Promise.all(promises);
}


function switchRetentionMode(mode){
retentionMode=mode;
document.getElementById('retentionMonthlyTab').classList.toggle('active',mode==='monthly');
document.getElementById('retentionWeeklyTab').classList.toggle('active',mode==='weekly');
if(mode==='monthly'){
if(retentionData&&retentionData.rows&&retentionData.rows.length>0){
renderRetentionMetricSelector();
renderRetentionChart();
renderRetentionTable();
}else{
document.getElementById('retention-table').innerHTML='<div class="err">No monthly retention data available</div>';
}
}else{
if(weeklyRetentionData&&weeklyRetentionData.rows&&weeklyRetentionData.rows.length>0){
renderWeeklyRetentionMetricSelector();
renderWeeklyRetentionChart();
renderWeeklyRetentionTable();
}else{
document.getElementById('retentionMetricSelector').innerHTML='';
document.getElementById('retention-table').innerHTML='<div class="err">No weekly retention sheets found. Create sheets with format: DD.MM - DD.MM FTD / DD.MM - DD.MM ACTIVE</div>';
if(retentionChart)retentionChart.destroy();
}
}
}

function parseWeekDate(weekStr){const parts=weekStr.split('-');if(parts.length!==2)return null;const startParts=parts[0].trim().split('.');if(startParts.length!==2)return null;const day=parseInt(startParts[0]);const month=parseInt(startParts[1]);const year=month>=7?2024:2025;return new Date(year,month-1,day)}
function sortWeeklyData(data){console.log('=== SORT WEEKLY DATA DEBUG ===');if(!data||!data.weeks||!data.rows){console.log('No data to sort');return data}console.log('ORIGINAL data:',JSON.parse(JSON.stringify(data)));const weekDates=data.weeks.map(w=>({week:w,date:parseWeekDate(w),dateStr:parseWeekDate(w)?parseWeekDate(w).toISOString():'null'}));console.log('Week dates:',weekDates);weekDates.sort((a,b)=>{if(!a.date||!b.date)return 0;return a.date-b.date});const sortedWeeks=weekDates.map(w=>w.week);console.log('SORTED weeks:',sortedWeeks);const originalWeeks=data.weeks;const sortedRows=data.rows.map(row=>{const originalFtdIdx=originalWeeks.indexOf(row.week);const sortedFtdIdx=sortedWeeks.indexOf(row.week);console.log('Processing row ' + row.week + ': originalFtdIdx=' + originalFtdIdx + ', sortedFtdIdx=' + sortedFtdIdx);const newRow={week:row.week,ftdCount:row.ftdCount,retention:[]};for(let i=0;i<sortedWeeks.length;i++){const targetWeek=sortedWeeks[sortedFtdIdx+i];if(!targetWeek){console.log('  i=' + i + ': targetWeek undefined, push {0,0}');newRow.retention.push({count:0,pct:0});continue}const targetOriginalIdx=originalWeeks.indexOf(targetWeek);const originalOffset=targetOriginalIdx-originalFtdIdx;console.log('  i=' + i + ': targetWeek=' + targetWeek + ', targetOriginalIdx=' + targetOriginalIdx + ', originalOffset=' + originalOffset);if(originalOffset>=0&&originalOffset<row.retention.length){console.log('    -> use retention[' + originalOffset + ']:',row.retention[originalOffset]);newRow.retention.push(row.retention[originalOffset])}else{console.log('    -> offset invalid, push {0,0}');newRow.retention.push({count:0,pct:0})}}console.log('Result retention for ' + row.week + ':',newRow.retention);return newRow});sortedRows.sort((a,b)=>{const aDate=parseWeekDate(a.week);const bDate=parseWeekDate(b.week);if(!aDate||!bDate)return 0;return aDate-bDate});console.log('SORTED rows:',sortedRows);console.log('=== END DEBUG ===');return{weeks:sortedWeeks,rows:sortedRows}}
function loadWeeklyRetentionData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{if(!data||!data.rows){console.warn('Weekly retention: no data');weeklyRetentionData={weeks:[],rows:[]};resolve();return}weeklyRetentionData=data;console.log('Weekly retention loaded:',weeklyRetentionData);resolve()}).withFailureHandler(err=>{console.error('Weekly retention error:',err);weeklyRetentionData={weeks:[],rows:[]};resolve()}).getWeeklyRetentionData()})}

function renderWeeklyRetentionMetricSelector(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.rows||data.rows.length===0){console.warn('No weekly retention data for selector');return}const container=document.getElementById('retentionMetricSelector');container.innerHTML='';const maxWeeks=data.weeks?data.weeks.length:0;for(let i=0;i<maxWeeks;i++){const btn=document.createElement('button');btn.className='metric-btn'+(i===currentRetentionWeek?' active':'');btn.textContent='Week +'+i;btn.onclick=()=>{currentRetentionWeek=i;document.querySelectorAll('#retentionMetricSelector .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderWeeklyRetentionChart()};container.appendChild(btn)}}

function renderWeeklyRetentionChart(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.rows||data.rows.length===0){console.warn('No weekly retention data for chart');return}if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('retentionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let weekIdx=0;data.rows.forEach((row,rowIdx)=>{const retentionIdx=rowIdx+currentRetentionWeek;if(!row.retention||retentionIdx>=row.retention.length)return;const cell=row.retention[retentionIdx];let pct=cell?cell.pct:0;labels.push(row.week+' FTD');chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[weekIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);weekIdx++});if(retentionChart)retentionChart.destroy();retentionChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:'Weekly Retention (Week +'+currentRetentionWeek+')',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function renderWeeklyRetentionTable(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.weeks||data.weeks.length===0){console.warn('No weekly retention data for table');return}const table=document.getElementById('retention-table');const maxOffset=Math.max(...data.rows.map(r=>r.retention?r.retention.length:0));let html='<thead><tr><th class="row-header">FTD Week ‚Üì / Active Week ‚Üí</th>';data.weeks.forEach(w=>html+='<th>' + w + '</th>');html+='</tr></thead><tbody>';data.rows.forEach((row,rowIdx)=>{html+='<tr><td class="row-header">' + row.week + ' FTD</td>';data.weeks.forEach((activeWeek,colIdx)=>{if(colIdx<rowIdx){html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}else{if(row.retention&&colIdx<row.retention.length){const cell=row.retention[colIdx];let count=cell?cell.count:0,pct=cell?cell.pct:0;const retOffset=colIdx-rowIdx;const bg=retentionHeatmapColor(pct,retOffset,maxOffset),fg=getTextColor(bg);const display=heatmapShowPercent?(pct*100).toFixed(1) + '%':count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + ';cursor:pointer" data-ftd-week="' + row.week + '" data-active-week="' + activeWeek + '">' + display + '</span></td>'}else{html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}}});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell[data-ftd-week]').forEach(cell=>{cell.onclick=()=>openWeeklyRetentionModal(cell.dataset.ftdWeek,cell.dataset.activeWeek)})}

function openWeeklyRetentionModal(ftdWeek,activeWeek){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=ftdWeek + ' FTD ‚Üí ' + activeWeek + ' ACTIVE';document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=ftdWeek + '|' + activeWeek;const cachedData=retentionPlayersCellMap.get(cellKey);if(cachedData){console.log('Using cached weekly data for:',cellKey,cachedData);currentModalData=cachedData;currentFilteredData=applyFiltersToData(cachedData,retentionFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching weekly modal data for:',ftdWeek,'‚Üí',activeWeek);google.script.run.withSuccessHandler(data=>{console.log('Weekly modal data received:',data);console.log('Achieved count:',data.achieved?data.achieved.length:0);console.log('FTD total:',data.total);currentModalData=data;currentFilteredData=applyFiltersToData(data,retentionFilters);console.log('Filtered data:',currentFilteredData);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Weekly modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayersRetentionWeekly({ftdWeek,activeWeek})}

function renderInitialFilters(){
if(!allData||!retentionData){
setTimeout(renderInitialFilters,500);
return;
}
const vipSet=new Set();
const mgrSet=new Set();
const trafficSet=new Set();
const countrySet=new Set();
google.script.run.withSuccessHandler(data=>{
data.forEach(p=>{
const vip=getVipType(p.tags);
const mgr=getManager(p.tags);
if(vip)vipSet.add(vip);
if(mgr)mgrSet.add(mgr);
if(p.trafficType)trafficSet.add(p.trafficType);
if(p.country)countrySet.add(p.country);
});
const vips=[...vipSet].sort();
const mgrs=[...mgrSet].sort();
const traffic=[...trafficSet].sort();
const countries=[...countrySet].sort();
renderFilterDropdown('depositVipTypeFilters',vips,'vipType','All Types','deposit');
renderFilterDropdown('depositManagerFilters',mgrs,'manager','All Managers','deposit');
renderFilterDropdown('depositTrafficFilters',traffic,'trafficType','All Traffic','deposit');
renderFilterDropdown('depositCountryFilters',countries,'country','All Countries','deposit');
renderFilterDropdown('retentionVipTypeFilters',vips,'vipType','All Types','retention');
renderFilterDropdown('retentionManagerFilters',mgrs,'manager','All Managers','retention');
renderFilterDropdown('retentionTrafficFilters',traffic,'trafficType','All Traffic','retention');
renderFilterDropdown('retentionCountryFilters',countries,'country','All Countries','retention');
}).withFailureHandler(err=>{
console.error('Filter data load error:',err);
const basicVip=['VIP','Silent','Super VIP'];
const basicMgr=['Ann','Vlad','Kate','Max'];
renderFilterDropdown('depositVipTypeFilters',basicVip,'vipType','All Types','deposit');
renderFilterDropdown('depositManagerFilters',basicMgr,'manager','All Managers','deposit');
renderFilterDropdown('depositTrafficFilters',[],'trafficType','All Traffic','deposit');
renderFilterDropdown('depositCountryFilters',[],'country','All Countries','deposit');
renderFilterDropdown('retentionVipTypeFilters',basicVip,'vipType','All Types','retention');
renderFilterDropdown('retentionManagerFilters',basicMgr,'manager','All Managers','retention');
renderFilterDropdown('retentionTrafficFilters',[],'trafficType','All Traffic','retention');
renderFilterDropdown('retentionCountryFilters',[],'country','All Countries','retention');
}).getAllPlayersForFilters();
}

function setupGlobalClickHandler(){document.addEventListener('click',()=>{document.querySelectorAll('.filter-dropdown-menu').forEach(menu=>menu.classList.remove('open'));document.querySelectorAll('.filter-dropdown-toggle').forEach(toggle=>toggle.classList.remove('active'))})}

function loadDepositData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{allData=data;selectedMonths=[...data.months];renderMonthFilters(data.months);renderMetricSelector();renderBarChart();renderDepositTable();resolve()}).withFailureHandler(err=>{alert('Error: '+err.message);resolve()}).getDepositConversionData()})}

function loadRetentionData(){
  console.log('üì• Loading Monthly Retention Data...');
  return new Promise((resolve)=>{
    google.script.run
      .withSuccessHandler(data=>{
        console.log('‚úÖ Monthly Retention Data received:', {
          hasData: !!data,
          months: data?.months,
          rowsCount: data?.rows?.length,
          firstRow: data?.rows?.[0]
        });
        retentionData=data;
        renderRetentionMetricSelector();
        renderRetentionChart();
        renderRetentionTable();
        resolve();
      })
      .withFailureHandler(err=>{
        console.error('‚ùå Failed to load Monthly Retention Data:', err);
        document.getElementById('retention-table').parentElement.innerHTML='<div class="err">Error: '+err+'</div>';
        resolve();
      })
      .getRetentionData();
  });
}

function loadKpiData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{console.log('KPI data received:',data);if(!data){document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">Error: No data returned</div>';resolve();return}if(data.error){document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">Error: '+data.error+'</div>';resolve();return}if(data.tabs && Object.keys(data.tabs).length>0){kpiDataByTab=data.tabs;if(data.metricFormats){metricFormats=data.metricFormats}const tabs=Object.keys(kpiDataByTab);kpiCurrentTab=tabs[0];renderKpiTabs();renderKpiSidebar();renderKpiMetrics();renderMetricsFilter()}else{document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">No [VIP] or [TOTAL] sheets found. Check sheet names!</div>'}resolve()}).withFailureHandler(err=>{console.error('KPI load error:',err);document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444;padding:20px">Error: '+err.message+'</div>';resolve()}).kpiLoadProject()})}

function loadAllPlayersForFilters(){return new Promise((resolve)=>{if(!allData){setTimeout(()=>loadAllPlayersForFilters().then(resolve),500);return}const requests=[];allData.months.forEach(month=>{allData.rows.forEach(row=>{requests.push({month:month,range:row.range})})});const BATCH_SIZE=5;let batchIndex=0;console.log('üì• Loading ALL deposit cells:',requests.length,'total');function loadNextBatch(){const start=batchIndex*BATCH_SIZE;const end=Math.min(start+BATCH_SIZE,requests.length);if(start>=requests.length){console.log('‚úÖ All deposit cells loaded');console.log('üîß Setting depositCellsLoaded = true');depositCellsLoaded = true;console.log('üîß Calling tryEnrichRetentionPlayers() from deposit...');tryEnrichRetentionPlayers();renderGlobalFilters();resolve();return}const batch=requests.slice(start,end);let batchCompleted=0;let timeoutId;console.log('‚è≥ Loading batch',batchIndex+1,'/',Math.ceil(requests.length/BATCH_SIZE),'(size:',batch.length,')');timeoutId=setTimeout(function(){if(batchCompleted<batch.length){console.error('‚è±Ô∏è Batch',batchIndex+1,'TIMEOUT! Only',batchCompleted,'/',batch.length,'completed');batchIndex++;loadNextBatch()}},15000);batch.forEach(req=>{const k=req.month + '|' + req.range;google.script.run.withSuccessHandler(function(data){const players=data.achieved||[];playersCellMap.set(k,players);allPlayersData.push(...players);batchCompleted++;console.log('  ‚úì Cell completed (',batchCompleted,'/',batch.length,') key:',k,'players:',players.length);if(batchCompleted===batch.length){clearTimeout(timeoutId);console.log('  ‚úÖ Batch',batchIndex+1,'complete! Moving to next...');batchIndex++;setTimeout(loadNextBatch,500)}}).withFailureHandler(function(error){console.error('  ‚ùå Cell failed! key:',k,'error:',error);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);console.log('  ‚ö†Ô∏è Batch',batchIndex+1,'complete with errors! Moving to next...');batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayers({month:req.month,depositRange:req.range})})}loadNextBatch()})}

function loadAllRetentionPlayersForFilters(){return new Promise((resolve)=>{if(!retentionData){setTimeout(()=>loadAllRetentionPlayersForFilters().then(resolve),500);return}const requests=[];retentionData.rows.forEach((row,rowIdx)=>{const ftdMonth=row.month;for(let i=rowIdx;i<retentionData.months.length;i++){const activeMonth=retentionData.months[i];requests.push({ftdMonth:ftdMonth,activeMonth:activeMonth,type:'monthly'})}});if(weeklyRetentionData&&weeklyRetentionData.rows){weeklyRetentionData.rows.forEach((row,rowIdx)=>{const ftdWeek=row.week;for(let i=rowIdx;i<weeklyRetentionData.weeks.length;i++){const activeWeek=weeklyRetentionData.weeks[i];requests.push({ftdPeriod:ftdWeek,activePeriod:activeWeek,type:'weekly'})}})}const BATCH_SIZE=10;let batchIndex=0;console.log('üì• Loading ALL retention cells:',requests.length,'total');function loadNextBatch(){const start=batchIndex*BATCH_SIZE;const end=Math.min(start+BATCH_SIZE,requests.length);if(start>=requests.length){console.log('‚úÖ All retention cells loaded');
console.log('üîß Setting retentionCellsLoaded = true');
retentionCellsLoaded = true;
console.log('üîß Calling tryEnrichRetentionPlayers() from retention...');
tryEnrichRetentionPlayers();
renderGlobalFilters();resolve();return}const batch=requests.slice(start,end);let batchCompleted=0;console.log('‚è≥ Loading batch',batchIndex+1,'/',Math.ceil(requests.length/BATCH_SIZE));batch.forEach(req=>{if(req.type==='monthly'){const k=req.ftdMonth + '|' + req.activeMonth;google.script.run.withSuccessHandler(function(data){retentionPlayersCellMap.set(k,data);batchCompleted++;if(batchCompleted===batch.length){batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayersRetention({ftdMonth:req.ftdMonth,activeMonth:req.activeMonth})}else{const k=req.ftdPeriod + '|' + req.activePeriod;google.script.run.withSuccessHandler(function(data){retentionPlayersCellMap.set(k,data);batchCompleted++;if(batchCompleted===batch.length){batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayersRetentionWeekly({ftdWeek:req.ftdPeriod,activeWeek:req.activePeriod})}})}loadNextBatch()})}

/**
 * Try to enrich retention players with tags from deposit cells
 * Only runs when BOTH deposit and retention cells are loaded
 */
function tryEnrichRetentionPlayers() {
  console.log('üöÄ tryEnrichRetentionPlayers() CALLED!');
  console.log('  - depositCellsLoaded:', depositCellsLoaded);
  console.log('  - retentionCellsLoaded:', retentionCellsLoaded);
  console.log('  - allPlayersData.length:', allPlayersData.length);
  console.log('  - retentionPlayersCellMap.size:', retentionPlayersCellMap.size);
  
  // Check if both loading processes are complete
  if (!depositCellsLoaded || !retentionCellsLoaded) {
    console.log('‚è≥ Waiting for all cells to load before enrichment...');
    console.log('  - Deposit cells loaded:', depositCellsLoaded);
    console.log('  - Retention cells loaded:', retentionCellsLoaded);
    return;
  }
  
  console.log('üîÑ Enriching retention players with tags...');
  
  // üîç DIAGNOSTIC: Sample deposit player
  if (allPlayersData.length > 0) {
    console.log('üîç Sample DEPOSIT player:', allPlayersData[0]);
    console.log('  - email:', allPlayersData[0].email);
    console.log('  - playerId:', allPlayersData[0].playerId);
    console.log('  - tags:', allPlayersData[0].tags);
    console.log('  - Object.keys:', Object.keys(allPlayersData[0]));
  }
  
  // üîç DIAGNOSTIC: Sample retention player
  const firstCell = retentionPlayersCellMap.values().next().value;
  if (firstCell && firstCell.achieved && firstCell.achieved.length > 0) {
    console.log('üîç Sample RETENTION player:', firstCell.achieved[0]);
    console.log('  - email:', firstCell.achieved[0].email);
    console.log('  - playerId:', firstCell.achieved[0].playerId);
    console.log('  - tags:', firstCell.achieved[0].tags);
    console.log('  - Object.keys:', Object.keys(firstCell.achieved[0]));
  }
  
  const playerTagsMap = new Map();
  let playersWithTags = 0;
  let playersWithoutTags = 0;
  let playersWithoutKey = 0;
  
  allPlayersData.forEach(p => {
    const key = p.email || p.playerId;
    if (key) {
      if (p.tags && p.tags.length > 0) {
        playersWithTags++;
        playerTagsMap.set(key, {
          tags: p.tags,
          trafficType: p.trafficType,
          country: p.country
        });
      } else {
        playersWithoutTags++;
      }
    } else {
      playersWithoutKey++;
    }
  });
  
  console.log('üìä allPlayersData analysis:');
  console.log('  - Total:', allPlayersData.length);
  console.log('  - With tags:', playersWithTags);
  console.log('  - Without tags:', playersWithoutTags);
  console.log('  - Without email/playerId:', playersWithoutKey);
  console.log('  - Tags map size:', playerTagsMap.size);
  
  // üîç Show first 5 keys from deposit map
  const sampleKeys = [...playerTagsMap.keys()].slice(0, 5);
  console.log('üîç Sample DEPOSIT keys (first 5):', sampleKeys);
  
  if (playerTagsMap.size === 0) {
    console.warn('‚ö†Ô∏è No tags found in allPlayersData - enrichment will not work!');
    return;
  }
  
  let enrichedCount = 0;
  let notFoundCount = 0;
  let retentionKeysNotFound = [];
  
  retentionPlayersCellMap.forEach((cellData, cellKey) => {
    if (!cellData) return;
    
    // Enrich achieved players
    if (cellData.achieved) {
      cellData.achieved.forEach(p => {
        const key = p.email || p.playerId;
        if (!key) {
          console.warn('‚ö†Ô∏è Retention player without key:', p);
          notFoundCount++;
          return;
        }
        
        const enrichData = playerTagsMap.get(key);
        if (enrichData) {
          if (!p.tags || p.tags.length === 0) {
            p.tags = enrichData.tags;
            enrichedCount++;
          }
          if (!p.trafficType) p.trafficType = enrichData.trafficType;
          if (!p.country) p.country = enrichData.country;
        } else {
          notFoundCount++;
          if (retentionKeysNotFound.length < 5) {
            retentionKeysNotFound.push(key);
          }
        }
      });
    }
    
    // Enrich dropped players
    if (cellData.dropped) {
      cellData.dropped.forEach(p => {
        const key = p.email || p.playerId;
        if (!key) {
          notFoundCount++;
          return;
        }
        
        const enrichData = playerTagsMap.get(key);
        if (enrichData) {
          if (!p.tags || p.tags.length === 0) {
            p.tags = enrichData.tags;
            enrichedCount++;
          }
          if (!p.trafficType) p.trafficType = enrichData.trafficType;
          if (!p.country) p.country = enrichData.country;
        } else {
          notFoundCount++;
          if (retentionKeysNotFound.length < 5) {
            retentionKeysNotFound.push(key);
          }
        }
      });
    }
  });
  
  console.log('‚úÖ Enrichment complete:');
  console.log('  - Enriched:', enrichedCount, 'players');
  console.log('  - Not found in map:', notFoundCount, 'players');
  console.log('üîç Sample RETENTION keys NOT FOUND (first 5):', retentionKeysNotFound);
  const successRate = playerTagsMap.size > 0 ? ((enrichedCount / (enrichedCount + notFoundCount) * 100).toFixed(1) + '%') : '0%';
  console.log('  - Success rate:', successRate);
  
  // Re-render retention if filters are active
  const hasRetentionFilters = Object.values(retentionFilters).some(arr=>arr.length>0);
  if(hasRetentionFilters){
    console.log('üîÑ Re-rendering retention with filters after enrichment');
    if(retentionMode==='monthly'){
      renderRetentionChart();
      renderRetentionTable();
    }else{
      renderWeeklyRetentionChart();
      renderWeeklyRetentionTable();
    }
  }
}

function renderGlobalFilters(){
  const typesSet=new Set();
  const managersSet=new Set();
  const trafficTypesSet=new Set();
  const countriesSet=new Set();
  
  // Collect unique values from allPlayersData
  allPlayersData.forEach(p=>{
    const playerType=getPlayerTypeFromTags(p.tags); // ‚úÖ FIX: Use TYPE sheet mapping
    const mgr=getManager(p.tags);
    if(playerType && playerType !== 'UNKNOWN')typesSet.add(playerType);
    if(mgr)managersSet.add(mgr);
    if(p.trafficType)trafficTypesSet.add(p.trafficType);
    if(p.country)countriesSet.add(p.country);
  });
  
  // Collect unique values from retentionPlayersCellMap
  retentionPlayersCellMap.forEach(cellData=>{
    if(!cellData)return;
    const achieved=cellData.achieved||[];
    const dropped=cellData.dropped||[];
    [...achieved,...dropped].forEach(p=>{
      const playerType=getPlayerTypeFromTags(p.tags); // ‚úÖ FIX: Use TYPE sheet mapping
      const mgr=getManager(p.tags);
      if(playerType && playerType !== 'UNKNOWN')typesSet.add(playerType);
      if(mgr)managersSet.add(mgr);
      if(p.trafficType)trafficTypesSet.add(p.trafficType);
      if(p.country)countriesSet.add(p.country);
    });
  });
  
  // üîç ANALYZE ALL UNIQUE TAGS IN THE DATABASE
  const allTagsSet = new Set();
  
  // Collect tags from allPlayersData
  allPlayersData.forEach(p => {
    if (p.tags) {
      let tagsArray = [];
      if (Array.isArray(p.tags)) {
        tagsArray = p.tags;
      } else if (typeof p.tags === 'string') {
        if (p.tags.trim().startsWith('[')) {
          try {
            tagsArray = JSON.parse(p.tags);
          } catch (e) {
            tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
          }
        } else {
          tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
        }
      }
      tagsArray.forEach(tag => {
        if (tag && String(tag).trim() !== '') {
          allTagsSet.add(String(tag).toLowerCase());
        }
      });
    }
  });
  
  // Collect tags from retentionPlayersCellMap
  retentionPlayersCellMap.forEach(cellData => {
    if (!cellData) return;
    const achieved = cellData.achieved || [];
    const dropped = cellData.dropped || [];
    [...achieved, ...dropped].forEach(p => {
      if (p.tags) {
        let tagsArray = [];
        if (Array.isArray(p.tags)) {
          tagsArray = p.tags;
        } else if (typeof p.tags === 'string') {
          if (p.tags.trim().startsWith('[')) {
            try {
              tagsArray = JSON.parse(p.tags);
            } catch (e) {
              tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
            }
          } else {
            tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
          }
        }
        tagsArray.forEach(tag => {
          if (tag && String(tag).trim() !== '') {
            allTagsSet.add(String(tag).toLowerCase());
          }
        });
      }
    });
  });
  
  const allTags = [...allTagsSet].sort();
  
  // üîç Count players with valid TYPE tags
  let playersWithValidTags = 0;
  let playersWithoutValidTags = 0;
  
  const checkPlayer = (p) => {
    const playerType = getPlayerTypeFromTags(p.tags);
    if (playerType && playerType !== 'UNKNOWN') {
      playersWithValidTags++;
    } else if (p.tags && p.tags !== '' && p.tags !== '[]') {
      playersWithoutValidTags++;
    }
  };
  
  allPlayersData.forEach(checkPlayer);
  retentionPlayersCellMap.forEach(cellData => {
    if (!cellData) return;
    const achieved = cellData.achieved || [];
    const dropped = cellData.dropped || [];
    [...achieved, ...dropped].forEach(checkPlayer);
  });
  
  console.log('üîç ===== ALL UNIQUE TAGS ANALYSIS =====');
  console.log('üìä Total unique tags found:', allTags.length);
  console.log('üìã All tags (lowercase):', allTags);
  console.log('üó∫Ô∏è TYPE mapping available:', Object.keys(tagToTypeMap));
  console.log('‚ùå Tags NOT in TYPE mapping:', allTags.filter(tag => !tagToTypeMap[tag]));
  console.log('‚úÖ Tags IN TYPE mapping:', allTags.filter(tag => tagToTypeMap[tag]));
  console.log('üë• Players with VALID tags (in TYPE sheet):', playersWithValidTags);
  console.log('üë• Players with INVALID tags (not in TYPE sheet):', playersWithoutValidTags);
  console.log('üìä Ratio:', (playersWithValidTags / (playersWithValidTags + playersWithoutValidTags) * 100).toFixed(1) + '%');
  console.log('======================================');
  
  const types=[...typesSet].sort();
  const managers=[...managersSet].sort();
  const trafficTypes=[...trafficTypesSet].sort();
  const countries=[...countriesSet].sort();
  
  // Render filters for Deposit
  renderSidebarFilterItems('depositVipTypeFilters',types,'type','deposit');
  renderSidebarFilterItems('depositManagerFilters',managers,'manager','deposit');
  renderSidebarFilterItems('depositTrafficFilters',trafficTypes,'trafficType','deposit');
  renderSidebarFilterItems('depositCountryFilters',countries,'country','deposit');
  
  // Render filters for Retention
  renderSidebarFilterItems('retentionVipTypeFilters',types,'type','retention');
  renderSidebarFilterItems('retentionManagerFilters',managers,'manager','retention');
  renderSidebarFilterItems('retentionTrafficFilters',trafficTypes,'trafficType','retention');
  renderSidebarFilterItems('retentionCountryFilters',countries,'country','retention');
  
  console.log('‚úÖ Global filters rendered:', {
    types: types.length,
    managers: managers.length,
    trafficTypes: trafficTypes.length,
    countries: countries.length
  });
}


function renderFilterDropdown(containerId,values,filterKey,label,view){const container=document.getElementById(containerId);if(!container)return;container.innerHTML='';const dropdown=document.createElement('div');dropdown.className='filter-dropdown';const toggle=document.createElement('div');toggle.className='filter-dropdown-toggle';toggle.innerHTML='<span>' + label + '</span><span style="display:flex;align-items:center;gap:6px"><span class="count" style="display:none">0</span><span style="font-size:10px">‚ñº</span></span>';const menu=document.createElement('div');menu.className='filter-dropdown-menu';const searchInput=document.createElement('input');searchInput.type='text';searchInput.className='filter-search-input';searchInput.placeholder='Search...';searchInput.onclick=(e)=>e.stopPropagation();menu.appendChild(searchInput);const itemsContainer=document.createElement('div');itemsContainer.className='filter-items-container';values.forEach(value=>{const item=document.createElement('div');item.className='filter-dropdown-item';item.dataset.value=value.toLowerCase();const checkbox=document.createElement('div');checkbox.className='filter-checkbox';const text=document.createElement('span');text.textContent=value;item.appendChild(checkbox);item.appendChild(text);item.onclick=(e)=>{e.stopPropagation();const isChecked=checkbox.classList.toggle('checked');if(filterKey==='months'){toggleMonth(value,view)}else{updateFilter(filterKey,value,isChecked,view)}const checkedCount=itemsContainer.querySelectorAll('.filter-checkbox.checked').length;const countSpan=toggle.querySelector('.count');if(checkedCount>0&&checkedCount<values.length){countSpan.textContent=checkedCount;countSpan.style.display='block'}else if(checkedCount===values.length){countSpan.style.display='none'}else{countSpan.textContent=checkedCount;countSpan.style.display='block'}};itemsContainer.appendChild(item)});menu.appendChild(itemsContainer);searchInput.oninput=()=>{const searchTerm=searchInput.value.toLowerCase();itemsContainer.querySelectorAll('.filter-dropdown-item').forEach(item=>{const matches=item.dataset.value.includes(searchTerm);item.style.display=matches?'flex':'none'})};toggle.onclick=(e)=>{e.stopPropagation();const allMenus=document.querySelectorAll('.filter-dropdown-menu');allMenus.forEach(m=>{if(m!==menu)m.classList.remove('open')});menu.classList.toggle('open');toggle.classList.toggle('active');if(menu.classList.contains('open')){searchInput.value='';searchInput.focus();itemsContainer.querySelectorAll('.filter-dropdown-item').forEach(item=>item.style.display='flex')}};menu.onclick=(e)=>{e.stopPropagation()};dropdown.appendChild(toggle);dropdown.appendChild(menu);container.appendChild(dropdown)}

function matchesDepositFilters(player,filters){
  if(!filters)return true;
  
  const hasFilters = filters.type?.length > 0 || filters.manager?.length > 0 || 
                     filters.trafficType?.length > 0 || filters.country?.length > 0;
  
  // Check TYPE filter
  if(filters.type&&filters.type.length>0){
    const playerType=getPlayerTypeFromTags(player.tags); // ‚úÖ FIX: Use new function
    if(!filters.type.includes(playerType)){
      if(hasFilters && Math.random() < 0.01) { // Log 1% of filtered players
        console.log('‚ùå Deposit: Player filtered by TYPE:', {
          playerType,
          allowedTypes: filters.type,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Manager filter
  if(filters.manager&&filters.manager.length>0){
    const mgr=getManager(player.tags);
    if(!filters.manager.includes(mgr)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Manager:', {
          manager: mgr,
          allowedManagers: filters.manager,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Traffic Type filter
  if(filters.trafficType&&filters.trafficType.length>0){
    if(!filters.trafficType.includes(player.trafficType)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Traffic:', {
          traffic: player.trafficType,
          allowedTraffic: filters.trafficType
        });
      }
      return false;
    }
  }
  
  // Check Country filter
  if(filters.country&&filters.country.length>0){
    if(!filters.country.includes(player.country)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Country:', {
          country: player.country,
          allowedCountries: filters.country
        });
      }
      return false;
    }
  }
  
  return true;
}

function filterDepositData(baseData, filters) {
  if (!baseData || !allPlayersData || allPlayersData.length === 0) return baseData;
  
  console.log('üîç filterDepositData called:', {
    filters,
    monthsCount: baseData.months?.length,
    rowsCount: baseData.rows?.length
  });
  
  const result = {
    months: baseData.months,
    rows: []
  };
  
  let totalPlayersBefore = 0;
  let totalPlayersAfter = 0;
  
  baseData.rows.forEach((rowData, rowIdx) => {
    const newRow = {
      range: rowData.range,
      cells: []
    };
    
    baseData.months.forEach((month, monthIdx) => {
      // ‚úÖ FIX: Get FTD players first
      const totalFtd = playersCellMap.get(month + '|FTD') || [];
      const filteredFtd = totalFtd.filter(p => matchesDepositFilters(p, filters));
      const ftdCount = filteredFtd.length;
      
      // ‚úÖ FIX: Create FTD email set for intersection
      const ftdEmailSet = new Set(filteredFtd.map(p => p.email || p.playerId));
      
      const cellKey = month + '|' + rowData.range;
      const cellPlayers = playersCellMap.get(cellKey) || [];
      totalPlayersBefore += cellPlayers.length;
      
      // ‚úÖ FIX: Filter by deposits filters AND must be in FTD
      const filteredPlayers = cellPlayers.filter(p => {
        const playerEmail = p.email || p.playerId;
        return matchesDepositFilters(p, filters) && ftdEmailSet.has(playerEmail);
      });
      
      totalPlayersAfter += filteredPlayers.length;
      
      const count = filteredPlayers.length;
      const pct = ftdCount > 0 ? count / ftdCount : 0;
      
      // Log first cell to see what's happening
      if (rowIdx === 0 && monthIdx === 0) {
        console.log('üìä First cell filtering:', {
          month,
          range: rowData.range,
          playersBefore: cellPlayers.length,
          playersAfter: filteredPlayers.length,
          ftdBefore: totalFtd.length,
          ftdAfter: ftdCount,
          filters
        });
        
        if (cellPlayers.length > 0 && filteredPlayers.length === 0) {
          console.log('‚ö†Ô∏è All players filtered out! Checking first player:', {
            player: cellPlayers[0],
            playerType: getPlayerTypeFromTags(cellPlayers[0].tags),
            manager: getManager(cellPlayers[0].tags),
            traffic: cellPlayers[0].trafficType,
            country: cellPlayers[0].country,
            isInFtd: ftdEmailSet.has(cellPlayers[0].email || cellPlayers[0].playerId)
          });
        }
      }
      
      newRow.cells.push({count: count, pct: pct});
    });
    
    result.rows.push(newRow);
  });
  
  console.log('‚úÖ Deposit filtering complete:', {
    totalPlayersBefore,
    totalPlayersAfter,
    filtered: totalPlayersBefore - totalPlayersAfter,
    filterRate: totalPlayersBefore > 0 ? ((totalPlayersBefore - totalPlayersAfter) / totalPlayersBefore * 100).toFixed(1) + '%' : '0%'
  });
  
  return result;
}
function matchesRetentionFilters(player,filters){
  if(!filters)return true;
  
  const hasFilters = filters.type?.length > 0 || filters.manager?.length > 0 || 
                     filters.trafficType?.length > 0 || filters.country?.length > 0;
  
  // Check TYPE filter
  if(filters.type&&filters.type.length>0){
    const playerType=getPlayerTypeFromTags(player.tags); // ‚úÖ FIX: Use new function
    if(!filters.type.includes(playerType)){
      if(hasFilters && Math.random() < 0.01) { // Log 1% of filtered players
        console.log('‚ùå Retention: Player filtered by TYPE:', {
          playerType,
          allowedTypes: filters.type,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Manager filter
  if(filters.manager&&filters.manager.length>0){
    const mgr=getManager(player.tags);
    if(!filters.manager.includes(mgr)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Manager:', {
          manager: mgr,
          allowedManagers: filters.manager,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Traffic Type filter
  if(filters.trafficType&&filters.trafficType.length>0){
    if(!filters.trafficType.includes(player.trafficType)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Traffic:', {
          traffic: player.trafficType,
          allowedTraffic: filters.trafficType
        });
      }
      return false;
    }
  }
  
  // Check Country filter
  if(filters.country&&filters.country.length>0){
    if(!filters.country.includes(player.country)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Country:', {
          country: player.country,
          allowedCountries: filters.country
        });
      }
      return false;
    }
  }
  
  return true;
}

function filterRetentionData(baseData, filters, mode) {
  console.log('üîç filterRetentionData ENTRY:', {
    baseDataExists: !!baseData,
    baseDataType: typeof baseData,
    filtersExists: !!filters,
    mode
  });
  
  if (!baseData) {
    console.log('‚ùå filterRetentionData: baseData is null/undefined, returning early');
    return baseData;
  }
  
  // ‚úÖ FIX: Check if retentionPlayersCellMap has data
  if (retentionPlayersCellMap.size === 0) {
    console.log('‚ö†Ô∏è filterRetentionData: retentionPlayersCellMap is empty, returning baseData as-is');
    return baseData;
  }
  
  const periodField = mode === 'weekly' ? 'week' : 'month';
  const periodsKey = mode === 'weekly' ? 'weeks' : 'months';
  
  console.log('üîç filterRetentionData called:', {
    mode,
    filters,
    periodsCount: baseData[periodsKey]?.length,
    rowsCount: baseData.rows?.length,
    mapSize: retentionPlayersCellMap.size
  });
  
  const result = {
    [periodsKey]: baseData[periodsKey],
    rows: []
  };
  
  let totalFtdBefore = 0;
  let totalFtdAfter = 0;
  
  baseData.rows.forEach((rowData, rowIdx) => {
    const newRow = {
      [periodField]: rowData[periodField],
      ftdCount: 0,
      retention: []
    };
    
    const ftdKey = rowData[periodField] + '|' + rowData[periodField];
    const ftdCellData = retentionPlayersCellMap.get(ftdKey);
    
    // Debug first row
    if (rowIdx === 0) {
      console.log('üîç Checking first row:', {
        period: rowData[periodField],
        ftdKey: ftdKey,
        hasCellData: !!ftdCellData,
        cellMapSize: retentionPlayersCellMap.size,
        cellMapKeys: Array.from(retentionPlayersCellMap.keys()).slice(0, 3)
      });
    }
    
    if (ftdCellData) {
      const ftdPlayers = ftdCellData.achieved || [];
      totalFtdBefore += ftdPlayers.length;
      
      const filteredFtdPlayers = ftdPlayers.filter(p => matchesRetentionFilters(p, filters));
      totalFtdAfter += filteredFtdPlayers.length;
      
      newRow.ftdCount = filteredFtdPlayers.length;
      
      // Log first period to see what's happening
      if (rowIdx === 0) {
        console.log('üìä First period filtering:', {
          period: rowData[periodField],
          ftdBefore: ftdPlayers.length,
          ftdAfter: filteredFtdPlayers.length,
          filters
        });
        
        if (ftdPlayers.length > 0 && filteredFtdPlayers.length === 0) {
          console.log('‚ö†Ô∏è All FTD players filtered out! Checking first player:', {
            player: ftdPlayers[0],
            playerType: getPlayerTypeFromTags(ftdPlayers[0].tags),
            manager: getManager(ftdPlayers[0].tags),
            traffic: ftdPlayers[0].trafficType,
            country: ftdPlayers[0].country
          });
        }
      }
      
      baseData[periodsKey].forEach((activePeriod, colIdx) => {
        if (colIdx < rowIdx) {
          newRow.retention.push({count: 0, pct: 0});
          return;
        }
        
        const retKey = rowData[periodField] + '|' + activePeriod;
        const retCellData = retentionPlayersCellMap.get(retKey);
        
        if (retCellData) {
          const achievedPlayers = (retCellData.achieved || []).filter(p => matchesRetentionFilters(p, filters));
          const count = achievedPlayers.length;
          const pct = newRow.ftdCount > 0 ? count / newRow.ftdCount : 0;
          newRow.retention.push({count: count, pct: pct});
        } else {
          newRow.retention.push({count: 0, pct: 0});
        }
      });
    } else {
      // ‚ö†Ô∏è No cell data - use baseData values
      newRow.ftdCount = rowData.ftdCount || 0;
      newRow.retention = rowData.retention || baseData[periodsKey].map(() => ({count: 0, pct: 0}));
    }
    
    result.rows.push(newRow);
  });
  
  console.log('‚úÖ Retention filtering complete:', {
    totalFtdBefore,
    totalFtdAfter,
    filtered: totalFtdBefore - totalFtdAfter,
    filterRate: totalFtdBefore > 0 ? ((totalFtdBefore - totalFtdAfter) / totalFtdBefore * 100).toFixed(1) + '%' : '0%'
  });
  
  return result;
}
function updateFilter(filterKey,value,checked,view){
  console.log('üîç updateFilter called:', {filterKey, value, checked, view});
  
  const filters=view==='deposit'?depositFilters:retentionFilters;
  
  if(checked){
    if(!filters[filterKey].includes(value)){
      filters[filterKey].push(value);
    }
  }else{
    filters[filterKey]=filters[filterKey].filter(v=>v!==value);
  }
  
  console.log('üìä Current filters:', view==='deposit'?depositFilters:retentionFilters);
  
  if(view==='deposit'){
    renderBarChart();
    renderDepositTable();
  }else if(view==='retention'){
    if(retentionMode==='monthly'){
      renderRetentionChart();
      renderRetentionTable();
    }else{
      renderWeeklyRetentionChart();
      renderWeeklyRetentionTable();
    }
  }
}

function applyFilters(){renderBarChart();renderDepositTable();if(retentionMode==='monthly'){if(retentionData)renderRetentionTable()}else{if(weeklyRetentionData)renderWeeklyRetentionTable()}showToast('üîç Filters applied!')}

function clearDepositFilters(){
  depositFilters={type:[],manager:[],trafficType:[],country:[]};
  document.querySelectorAll('#depositVipTypeFilters .sidebar-filter-checkbox, #depositManagerFilters .sidebar-filter-checkbox, #depositTrafficFilters .sidebar-filter-checkbox, #depositCountryFilters .sidebar-filter-checkbox').forEach(checkbox=>checkbox.checked=false);
  renderBarChart();
  renderDepositTable();
  closeDepositFilterSidebar();
  showToast('üîÑ Filters cleared');
}

function clearRetentionFilters(){
  retentionFilters={type:[],manager:[],trafficType:[],country:[]};
  document.querySelectorAll('#retentionVipTypeFilters .sidebar-filter-checkbox, #retentionManagerFilters .sidebar-filter-checkbox, #retentionTrafficFilters .sidebar-filter-checkbox, #retentionCountryFilters .sidebar-filter-checkbox').forEach(checkbox=>checkbox.checked=false);
  if(retentionMode==='monthly'){
    renderRetentionChart();
    renderRetentionTable();
  }else{
    renderWeeklyRetentionChart();
    renderWeeklyRetentionTable();
  }
  closeRetentionFilterSidebar();
  showToast('üîÑ Filters cleared');
}

function renderMonthFilters(months){renderFilterDropdown('depositMonthFilters',months,'months','All Months','deposit');renderFilterDropdown('retentionMonthFilters',months,'months','All Months','retention');setTimeout(()=>{document.querySelectorAll('#depositMonthFilters .filter-checkbox, #retentionMonthFilters .filter-checkbox').forEach(checkbox=>{checkbox.classList.add('checked')});document.querySelectorAll('#depositMonthFilters .count, #retentionMonthFilters .count').forEach(countSpan=>{if(countSpan)countSpan.style.display='none'})},0)}

function toggleMonth(month,view){const idx=selectedMonths.indexOf(month);if(idx>-1)selectedMonths.splice(idx,1);else selectedMonths.push(month);renderBarChart();renderDepositTable();if(retentionData){renderRetentionChart();renderRetentionTable()}}

function renderMetricSelector(){const container=document.getElementById('metricSelector');container.innerHTML='';depositRanges.forEach(range=>{const btn=document.createElement('button');btn.className='metric-btn'+(range===currentMetric?' active':'');btn.textContent=range;btn.onclick=()=>{currentMetric=range;document.querySelectorAll('.metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBarChart()};container.appendChild(btn)})}

function renderRetentionMetricSelector(){
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  if(!data||!data.rows||data.rows.length===0)return;const container=document.getElementById('retentionMetricSelector');container.innerHTML='';const maxMonths=Math.max(...data.rows.map(r=>r.retention.length));for(let i=0;i<maxMonths;i++){const btn=document.createElement('button');btn.className='metric-btn'+(i===currentRetentionMonth?' active':'');btn.textContent='Month '+i;btn.onclick=()=>{currentRetentionMonth=i;document.querySelectorAll('#retentionMetricSelector .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderRetentionChart()};container.appendChild(btn)}}

function renderRetentionChart(){
  console.log('üìä renderRetentionChart called');
  console.log('üìä retentionData:', retentionData ? {rows: retentionData.rows?.length, months: retentionData.months?.length} : 'NULL');
  console.log('üìä selectedMonths:', selectedMonths);
  console.log('üìä currentRetentionMonth:', currentRetentionMonth);
  
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  console.log('üìä hasFilters:', hasFilters);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  console.log('üìä canFilter:', canFilter, '(mapSize:', retentionPlayersCellMap.size, ')');
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  console.log('üìä data after filtering:', data ? {rowsCount: data.rows?.length, monthsCount: data.months?.length} : 'NULL');
  
  if(!data||!data.rows||data.rows.length===0){
    console.log('‚ö†Ô∏è No retention data for chart - stopping render');
    return;
  }if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('retentionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;data.rows.forEach((row,rowIdx)=>{if(selectedMonths.includes(row.month)&&currentRetentionMonth<row.retention.length){const cell=row.retention[currentRetentionMonth];let pct=cell.pct;labels.push(row.month+' FTD');chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}});if(retentionChart)retentionChart.destroy();retentionChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:'Retention (Month '+currentRetentionMonth+')',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function renderBarChart(){if(!allData||selectedMonths.length===0)return;if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('conversionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;const hasFilters=Object.values(depositFilters).some(arr=>arr.length>0);let data=allData;if(hasFilters){data=filterDepositData(allData,depositFilters)}const metricRow=data.rows.find(r=>r.range===currentMetric);if(!metricRow)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;data.months.forEach((month,idx)=>{if(selectedMonths.includes(month)){let pct=metricRow.cells[idx].pct;labels.push(month);chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}});if(barChart)barChart.destroy();barChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:currentMetric+' (%)',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function heatmapColor(pct){const p=Math.max(0,Math.min(1,pct));const colors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];return colors[Math.floor(p*9)]}
function depositHeatmapColor(pct,rowIndex,maxRows){const p=Math.max(0,Math.min(1,pct));const baseColors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];const darkenOffset=Math.floor((rowIndex/(maxRows-1||1))*2);const adjustedColors=baseColors.map((_,idx)=>baseColors[Math.min(9,idx+darkenOffset)]);const colorIdx=Math.floor(p*9);return adjustedColors[colorIdx]}
function retentionHeatmapColor(pct,columnOffset,maxOffset){const p=Math.max(0,Math.min(1,pct));const colors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];const baseIdx=Math.floor(p*9);const lightenFactor=columnOffset/(maxOffset||1);const lightenAmount=Math.floor(lightenFactor*3);const finalIdx=Math.max(0,baseIdx-lightenAmount);return colors[finalIdx]}

function getTextColor(bg){const hex=bg.replace('#','');const r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);return((r*299+g*587+b*114)/1000)>155?'#1e293b':'#f8fafc'}

function toggleDepositHeatmap(){
  heatmapShowPercent=document.getElementById('depositHeatmapToggle').checked;
  renderDepositTable();
}

function toggleRetentionHeatmap(){
  heatmapShowPercent=document.getElementById('retentionHeatmapToggle').checked;
  if(retentionMode==='monthly'){
    renderRetentionTable();
  }else{
    renderWeeklyRetentionTable();
  }
}

function renderDepositTable(){const hasFilters=Object.values(depositFilters).some(arr=>arr.length>0);const data=hasFilters?filterDepositData(allData,depositFilters):allData;if(!data||selectedMonths.length===0)return;const table=document.getElementById('deposit-table');const recalculated=[];data.rows.forEach(row=>{const rowData={range:row.range,cells:[]};row.cells.forEach((cell,idx)=>{const month=data.months[idx];if(selectedMonths.includes(month)){rowData.cells.push({month,count:cell.count,pct:cell.pct})}});recalculated.push(rowData)});const allPcts=recalculated.flatMap(r=>r.cells.map(c=>c.pct));const maxPct=Math.max(...allPcts,0.01);const maxRows=recalculated.length;let html='<thead><tr><th class="row-header">Deposits ‚Üì / Month ‚Üí</th>';selectedMonths.forEach(month=>html+='<th>' + month + '</th>');html+='</tr></thead><tbody>';recalculated.forEach((rowData,rowIdx)=>{html+='<tr><td class="row-header">'+rowData.range+'</td>';rowData.cells.forEach(cellData=>{const bg=depositHeatmapColor(cellData.pct/maxPct,rowIdx,maxRows),fg=getTextColor(bg);const display=heatmapShowPercent?(cellData.pct*100).toFixed(1) + '%':cellData.count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + '" data-month="' + cellData.month + '" data-range="' + rowData.range + '">' + display + '</span></td>'});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell').forEach(cell=>{cell.onclick=()=>openCellModal(cell.dataset.month,cell.dataset.range)})}


function renderRetentionTable(){
  console.log('üìä renderRetentionTable called');
  
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  console.log('üìä hasFilters:', hasFilters);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  console.log('üìä canFilter:', canFilter, '(mapSize:', retentionPlayersCellMap.size, ')');
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  console.log('üìä data after filtering:', data ? {rowsCount: data.rows?.length, monthsCount: data.months?.length} : 'null');
  
  if(!data)return;const table=document.getElementById('retention-table');const filteredMonths=data.months.filter(m=>selectedMonths.includes(m));const maxOffset=Math.max(...data.rows.map(r=>r.retention?r.retention.length:0));let html='<thead><tr><th class="row-header">FTD Month ‚Üì / Active Month ‚Üí</th>';filteredMonths.forEach(m=>html+='<th>' + m + '</th>');html+='</tr></thead><tbody>';data.rows.forEach((row,rowIdx)=>{if(!selectedMonths.includes(row.month))return;html+='<tr><td class="row-header">' + row.month + ' FTD</td>';filteredMonths.forEach((activeMonth,colIdx)=>{const origColIdx=data.months.indexOf(activeMonth);if(origColIdx<rowIdx){html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}else{const retIdx=origColIdx-rowIdx;if(retIdx<row.retention.length){const cell=row.retention[retIdx];let count=cell.count,pct=cell.pct;const bg=retentionHeatmapColor(pct,retIdx,maxOffset),fg=getTextColor(bg);const display=heatmapShowPercent?(pct*100).toFixed(1) + '%':count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + ';cursor:pointer" data-ftd-month="' + row.month + '" data-active-month="' + activeMonth + '">' + display + '</span></td>'}else{html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}}});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell[data-ftd-month]').forEach(cell=>{cell.onclick=()=>openRetentionModal(cell.dataset.ftdMonth,cell.dataset.activeMonth)})}

function renderKpiTabs(){
  const container=document.getElementById('kpiTabs');
  container.innerHTML='';
  
  Object.keys(kpiDataByTab).forEach(tab=>{
    const tabBtn=document.createElement('div');
    tabBtn.className='kpi-tab'+(tab===kpiCurrentTab?' active':'');
    tabBtn.textContent=tab;
    tabBtn.onclick=()=>{
      // Switch to new tab
      kpiCurrentTab=tab;
      document.querySelectorAll('.kpi-tab').forEach(b=>b.classList.remove('active'));
      tabBtn.classList.add('active');
      
      // DON'T clear kpiSelectedPeriods - keep them for all tabs!
      console.log('üîÑ Switched to', tab, '- keeping', kpiSelectedPeriods.size, 'selected periods');
      
      kpiVisibleMetrics.clear();
      document.getElementById('kpiNormalView').style.display='block';
      document.getElementById('kpiCompareView').style.display='none';
      renderKpiSidebar();
      renderKpiMetrics();
      renderMetricsFilter();
    };
    container.appendChild(tabBtn);
  });
  
  const compareBtn=document.createElement('div');
  compareBtn.className='kpi-tab compare-tab';
  compareBtn.textContent='üîÑ Compare';
  compareBtn.style.marginLeft='auto';
  compareBtn.onclick=()=>{
    document.querySelectorAll('.kpi-tab').forEach(b=>b.classList.remove('active'));
    compareBtn.classList.add('active');
    document.getElementById('kpiNormalView').style.display='none';
    document.getElementById('kpiCompareView').style.display='block';
    if(!window.compareInitialized){
      initCompareView();
      window.compareInitialized=true;
    }
  };
  container.appendChild(compareBtn);
}

function renderKpiSidebar(){
  const kpiData=kpiDataByTab[kpiCurrentTab];
  if(!kpiData||!kpiData.months){
    document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">No data</div>';
    return;
  }
  
  const container=document.getElementById('kpiPeriods');
  container.innerHTML='';
  
  // Render all months and weeks
  kpiData.months.forEach((m,idx)=>{
    const monthGroup=document.createElement('div');
    monthGroup.className='month-group';
    
    const monthHeader=document.createElement('div');
    monthHeader.className='month-header';
    monthHeader.style.cursor='pointer';
    monthHeader.onclick=()=>toggleMonthExpand(idx);
    
    const monthCheckbox=document.createElement('input');
    monthCheckbox.type='checkbox';
    monthCheckbox.id='kpi-m-'+m.ym;
    monthCheckbox.onclick=(e)=>{e.stopPropagation();toggleKpiMonth('M:'+m.ym)};
    
    const monthLabel=document.createElement('span');
    monthLabel.className='month-label';
    monthLabel.textContent=m.label;
    
    const monthCount=document.createElement('span');
    monthCount.className='month-count';
    monthCount.textContent=m.weeks.length+' wk';
    
    monthHeader.appendChild(monthCheckbox);
    monthHeader.appendChild(monthLabel);
    monthHeader.appendChild(monthCount);
    
    const weeksList=document.createElement('div');
    weeksList.className='weeks-list';
    weeksList.id='weeks-'+idx;
    
    m.weeks.forEach((w,wi)=>{
      const wKey='W:'+m.ym+':'+wi;
      const weekItem=document.createElement('div');
      weekItem.className='week-item';
      
      const weekCheckbox=document.createElement('input');
      weekCheckbox.type='checkbox';
      weekCheckbox.id='kpi-w-'+wKey;
      weekCheckbox.onclick=()=>toggleKpiPeriod(wKey);
      
      const weekLabel=document.createElement('label');
      weekLabel.className='week-label';
      weekLabel.htmlFor='kpi-w-'+wKey;
      weekLabel.textContent=w.label;
      
      weekItem.appendChild(weekCheckbox);
      weekItem.appendChild(weekLabel);
      weeksList.appendChild(weekItem);
    });
    
    monthGroup.appendChild(monthHeader);
    monthGroup.appendChild(weeksList);
    container.appendChild(monthGroup);
  });
  
  // Restore checkboxes from GLOBAL kpiSelectedPeriods
  if (kpiSelectedPeriods.size > 0) {
    console.log('üîÑ Applying', kpiSelectedPeriods.size, 'global periods to', kpiCurrentTab, 'tab');
    
    var appliedCount = 0;
    
    // Restore month checkboxes (only if they exist in this tab)
    kpiData.months.forEach((m) => {
      const mKey = 'M:' + m.ym;
      if (kpiSelectedPeriods.has(mKey)) {
        const cb = document.getElementById('kpi-m-' + m.ym);
        if (cb) {
          cb.checked = true;
          appliedCount++;
        }
      }
    });
    
    // Restore week checkboxes (only if they exist in this tab)
    kpiData.months.forEach((m) => {
      m.weeks.forEach((w, wi) => {
        const wKey = 'W:' + m.ym + ':' + wi;
        if (kpiSelectedPeriods.has(wKey)) {
          const cb = document.getElementById('kpi-w-' + wKey);
          if (cb) {
            cb.checked = true;
            appliedCount++;
          }
        }
      });
    });
    
    console.log('‚úÖ Applied', appliedCount, 'periods to', kpiCurrentTab, 'tab');
  } else {
    // First time - select last 3 months by default
    console.log('üÜï No global periods - selecting last 3 months by default');
    kpiData.months.slice(-3).forEach((m)=>{
      const cb=document.getElementById('kpi-m-'+m.ym);
      if(cb){
        cb.checked=true;
        kpiSelectedPeriods.add('M:'+m.ym);
      }
    });
  }
  
  renderKpiChart();
  renderKpiTable();
}

function toggleMonthExpand(idx){document.getElementById('weeks-'+idx).classList.toggle('open')}

function toggleKpiMonth(key){const cb=document.getElementById('kpi-m-'+key.substring(2));if(cb&&cb.checked){kpiSelectedPeriods.add(key)}else{kpiSelectedPeriods.delete(key)}renderKpiChart();renderKpiTable()}

function toggleKpiPeriod(key){const cb=document.getElementById('kpi-w-'+key);if(cb&&cb.checked){kpiSelectedPeriods.add(key)}else{kpiSelectedPeriods.delete(key)}renderKpiChart();renderKpiTable()}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
  const toggle = document.querySelector('.sidebar-toggle');
  if(document.getElementById('sidebar').classList.contains('collapsed')){
    toggle.textContent = '‚ñ∂';
  }else{
    toggle.textContent = '‚óÄ';
  }
}

function toggleMetricsFilter(){
  document.getElementById('metricsFilter').classList.toggle('collapsed');
}

function renderKpiMetrics(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiData.metrics)return;const container=document.getElementById('kpiMetrics');container.innerHTML='';const metrics=kpiData.metrics.slice(0,20);metrics.forEach((m,i)=>{const btn=document.createElement('button');btn.className='metric-btn'+(i===0&&!kpiCurrentMetric?' active':'')+(m===kpiCurrentMetric?' active':'');btn.textContent=m;btn.onclick=()=>{kpiCurrentMetric=m;document.querySelectorAll('#kpiMetrics .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderKpiChart();document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=m};container.appendChild(btn)});if(!kpiCurrentMetric&&metrics.length>0){kpiCurrentMetric=metrics[0];document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=metrics[0]}else if(kpiCurrentMetric){document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=kpiCurrentMetric}}

function renderMetricsFilter(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiData.metrics)return;const container=document.getElementById('metricsFilterGrid');container.innerHTML='';kpiData.metrics.forEach((metric,idx)=>{const item=document.createElement('div');item.className='metric-check-item';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.id='metric-vis-'+idx;checkbox.checked=kpiVisibleMetrics.has(metric)||idx<5;if(checkbox.checked)kpiVisibleMetrics.add(metric);checkbox.onchange=()=>{if(checkbox.checked){kpiVisibleMetrics.add(metric)}else{kpiVisibleMetrics.delete(metric)}renderKpiTable()};const label=document.createElement('label');label.htmlFor='metric-vis-'+idx;label.textContent=metric;item.appendChild(checkbox);item.appendChild(label);container.appendChild(item)})}

function renderKpiChart(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiCurrentMetric||kpiSelectedPeriods.size===0)return;if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const ctx=document.getElementById('kpiChart').getContext('2d');const labels=[],values=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;kpiData.months.forEach(m=>{const mKey='M:'+m.ym;if(kpiSelectedPeriods.has(mKey)){labels.push(m.label);const val=m.monthly[kpiCurrentMetric]||m.sumWeeks[kpiCurrentMetric]||0;values.push(val);const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}m.weeks.forEach((w,wi)=>{const wKey='W:'+m.ym+':'+wi;if(kpiSelectedPeriods.has(wKey)){labels.push(w.label);values.push(w.weekly[kpiCurrentMetric]||0);const colorPair=monthGradients[(monthIdx-1)%monthGradients.length];const lightColor=lightenColor(colorPair[0],0.3);colors.push(lightColor)}})});const config={type:'bar',data:{labels,datasets:[{data:values,backgroundColor:colors,borderRadius:8,barPercentage:0.6,categoryPercentage:0.7}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:11},formatter:(v)=>formatKpiValue(kpiCurrentMetric,v)}},scales:{y:{beginAtZero:true,grace:'10%',grid:{color:'#f1f5f9'},ticks:{font:{weight:'600'},color:'#64748b',callback:(v)=>formatKpiValue(kpiCurrentMetric,v)}},x:{grid:{display:false},ticks:{font:{weight:'600',size:10},color:'#64748b'}}}}};if(kpiChart)kpiChart.destroy();kpiChart=new Chart(ctx,config)}

function lightenColor(hex,percent){const num=parseInt(hex.replace('#',''),16);const amt=Math.round(2.55*percent*100);const R=(num>>16)+amt;const G=(num>>8&0x00FF)+amt;const B=(num&0x0000FF)+amt;return '#'+(0x1000000+(R<255?R<1?0:R:255)*0x10000+(G<255?G<1?0:G:255)*0x100+(B<255?B<1?0:B:255)).toString(16).slice(1)}

function renderKpiTable(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData)return;const table=document.getElementById('kpi-table');const visibleMetrics=kpiVisibleMetrics.size>0?[...kpiVisibleMetrics]:kpiData.metrics.slice(0,5);let html='<thead><tr><th>Period</th>';visibleMetrics.forEach(m=>html+='<th>'+escapeHtml(m)+'</th>');html+='</tr></thead><tbody>';kpiData.months.forEach(m=>{const mKey='M:'+m.ym;if(kpiSelectedPeriods.has(mKey)){html+='<tr><td style="font-weight:700;color:#667eea">'+escapeHtml(m.label)+'</td>';visibleMetrics.forEach(metric=>{const val=m.monthly[metric]||m.sumWeeks[metric]||0;html+='<td style="font-weight:700">'+formatKpiValue(metric,val)+'</td>'});html+='</tr>'}m.weeks.forEach((w,wi)=>{const wKey='W:'+m.ym+':'+wi;if(kpiSelectedPeriods.has(wKey)){html+='<tr><td style="padding-left:24px;color:#64748b">'+escapeHtml(w.label)+'</td>';visibleMetrics.forEach(metric=>{html+='<td>'+formatKpiValue(metric,w.weekly[metric]||0)+'</td>'});html+='</tr>'}})});html+='</tbody>';table.innerHTML=html}

function formatKpiValue(metric,val){const format=metricFormats[metric];if(format){if(format==='%')return(val||0).toFixed(2)+'%';if(format==='eur')return'‚Ç¨'+(val||0).toFixed(2);if(format==='count')return Math.round(val||0).toLocaleString();return Math.round(val||0).toLocaleString()}const m=String(metric).toLowerCase();if(m.includes('rate')||m.includes('percent')||m.includes('conversion')||m.includes('hold'))return(val||0).toFixed(2)+'%';if(m.includes('arpu')||m.includes('amount')||m.includes('sum')||m.includes('ggr')||m.includes('ngr')||m.includes('cashout'))return'‚Ç¨'+(val||0).toFixed(2);return Math.round(val||0).toLocaleString()}

function openRetentionModal(ftdMonth,activeMonth){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=ftdMonth + ' FTD ‚Üí ' + activeMonth + ' Active';document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=ftdMonth + '|' + activeMonth;const cachedData=retentionPlayersCellMap.get(cellKey);if(cachedData){console.log('Using cached monthly data for:',cellKey,cachedData);currentModalData=cachedData;currentFilteredData=applyFiltersToData(cachedData,retentionFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching monthly modal data for:',ftdMonth,'‚Üí',activeMonth);google.script.run.withSuccessHandler(data=>{console.log('Monthly modal data received:',data);currentModalData=data;currentFilteredData=applyFiltersToData(data,retentionFilters);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Monthly modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayersRetention({ftdMonth,activeMonth})}

let currentModalData=null;
let currentFilteredData=null;
function openCellModal(month,depositRange){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=month + ' ‚Ä¢ ' + depositRange;document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=month + '|' + depositRange;const cachedData=playersCellMap.get(cellKey);if(cachedData){console.log('Using cached deposit data for:',cellKey);console.log('  - Cached type:', typeof cachedData, Array.isArray(cachedData) ? 'array' : 'object');console.log('  - Cached achieved:', cachedData.achieved ? cachedData.achieved.length : (Array.isArray(cachedData) ? cachedData.length : 0));console.log('  - Cached dropped:', cachedData.dropped ? cachedData.dropped.length : 0);let data;if(Array.isArray(cachedData)){console.warn('‚ö†Ô∏è Old cache format - no dropped data');data={achieved:cachedData,dropped:[],month:month,range:depositRange,total:cachedData.length,totalAchieved:cachedData.length,totalDropped:0}}else{data=cachedData}currentModalData=data;currentFilteredData=applyFiltersToData(data,depositFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching deposit modal data for:',month,depositRange);google.script.run.withSuccessHandler(data=>{console.log('Deposit modal data received:',data);console.log('  - Achieved:', data.achieved ? data.achieved.length : 0);console.log('  - Dropped:', data.dropped ? data.dropped.length : 0);playersCellMap.set(cellKey, data);console.log('‚úÖ Cached deposit data for:', cellKey);currentModalData=data;currentFilteredData=applyFiltersToData(data,depositFilters);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Deposit modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayers({month,depositRange})}

function closeModal(){document.getElementById('modal').classList.remove('open');currentModalData=null}

function applyFiltersToData(data,filters){
  const achievedOriginal=deduplicatePlayers(data.achieved||[]);
  const droppedOriginal=deduplicatePlayers(data.dropped||[]);
  
  let filtered={
    achieved:achievedOriginal,
    dropped:droppedOriginal,
    month:data.month,
    range:data.range,
    totalAchieved:achievedOriginal.length,
    totalDropped:droppedOriginal.length
  };
  
  // ‚úÖ FIX: Support both 'type' and 'vipType' keys
  const typeFilter = filters.type || filters.vipType || [];
  if(typeFilter.length>0){
    filtered.achieved=filtered.achieved.filter(p=>typeFilter.includes(getPlayerTypeFromTags(p.tags)));
    filtered.dropped=filtered.dropped.filter(p=>typeFilter.includes(getPlayerTypeFromTags(p.tags)));
  }
  
  if(filters.manager && filters.manager.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.manager.includes(getManager(p.tags)));
    filtered.dropped=filtered.dropped.filter(p=>filters.manager.includes(getManager(p.tags)));
  }
  
  if(filters.trafficType && filters.trafficType.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.trafficType.includes(p.trafficType));
    filtered.dropped=filtered.dropped.filter(p=>filters.trafficType.includes(p.trafficType));
  }
  
  if(filters.country && filters.country.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.country.includes(p.country));
    filtered.dropped=filtered.dropped.filter(p=>filters.country.includes(p.country));
  }
  
  return filtered;
}

/**
 * DEPRECATED: Use getPlayerTypeFromTags() instead
 * Kept for backwards compatibility but redirects to new function
 */
function getVipType(tags){
  return getPlayerTypeFromTags(tags);
}

function getManager(tags){if(!tags)return'';const t=String(tags).toLowerCase();if(t.includes('ann'))return'Ann';if(t.includes('vlad'))return'Vlad';if(t.includes('kate'))return'Kate';if(t.includes('max'))return'Max';return''}

/**
 * Get player TYPE from tags attribute using TYPE sheet mapping
 * This function uses tagToTypeMap loaded from Google Sheets TYPE sheet
 */
function getPlayerTypeFromTags(tags) {
  // ‚úÖ Handle empty strings
  if (!tags || tags === '' || tags === '[]') return 'UNKNOWN';
  
  // If tagToTypeMap is loaded and not empty, use it
  if (tagToTypeMap && Object.keys(tagToTypeMap).length > 0) {
    // Parse tags - can be string, JSON array, or comma-separated
    let tagsArray = [];
    
    if (Array.isArray(tags)) {
      tagsArray = tags.filter(t => t && String(t).trim() !== ''); // Filter empty
    } else if (typeof tags === 'string') {
      // ‚úÖ Skip empty strings
      if (tags.trim() === '') return 'UNKNOWN';
      
      // Try parse as JSON first
      if (tags.trim().startsWith('[')) {
        try {
          tagsArray = JSON.parse(tags);
          tagsArray = tagsArray.filter(t => t && String(t).trim() !== ''); // Filter empty
        } catch (e) {
          // Not JSON, split by comma
          tagsArray = tags.split(',').map(t => t.trim()).filter(t => t !== '');
        }
      } else {
        // Split by comma
        tagsArray = tags.split(',').map(t => t.trim()).filter(t => t !== '');
      }
    } else {
      tagsArray = [String(tags)];
    }
    
    // ‚úÖ Skip if no valid tags
    if (tagsArray.length === 0) return 'UNKNOWN';
    
    // Check each tag against tagToTypeMap (case-insensitive)
    for (let i = 0; i < tagsArray.length; i++) {
      let tag = String(tagsArray[i]).trim().toLowerCase(); // ‚úÖ LOWERCASE
      if (tagToTypeMap[tag]) {
        // Debug first match (only log 1% to avoid spam)
        if (Math.random() < 0.01) {
          console.log('‚úÖ TYPE match:', tag, '‚Üí', tagToTypeMap[tag]);
        }
        return tagToTypeMap[tag];
      }
    }
    
    // ‚ö†Ô∏è ENHANCED DEBUG: Show ALL unmatched tags to find the problem
    if (tagsArray.length > 0) {
      console.warn('‚ö†Ô∏è No TYPE match!', {
        inputTags: tagsArray,
        inputTagsLowercase: tagsArray.map(t => String(t).toLowerCase()),
        availableTags: Object.keys(tagToTypeMap),
        tagToTypeMap: tagToTypeMap
      });
    }
    
    return 'UNKNOWN';
  }
  
  // Fallback if tagToTypeMap not loaded
  return getPlayerTypeFallback(tags);
}

/**
 * Fallback function for TYPE determination when TYPE sheet is not loaded
 * Based on hardcoded rules
 */
function getPlayerTypeFallback(tags) {
  if (!tags) return 'UNKNOWN';
  
  var tagsStr = String(tags).toLowerCase();
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥ –ù–ê–ô–ë–Ü–õ–¨–® –°–ü–ï–¶–ò–§–Ü–ß–ù–û–ì–û –¥–æ –ó–ê–ì–ê–õ–¨–ù–û–ì–û
  
  // PRE-VIP: ann_pre_vip (–ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ü–ï–†–ï–î VIP, –±–æ –º—ñ—Å—Ç–∏—Ç—å 'vip')
  if (tagsStr.includes('ann_pre_vip')) {
    return 'PRE-VIP';
  }
  
  // VIP: ann_vip, kevin_vip, dominic_vip
  if (tagsStr.includes('ann_vip') || tagsStr.includes('kevin_vip') || 
      tagsStr.includes('dominic_vip')) {
    return 'VIP';
  }
  
  // SILENT PRE-VIP: pre_ann
  if (tagsStr.includes('pre_ann')) {
    return 'SILENT PRE-VIP';
  }
  
  // SILENT VIP: ann (–∞–ª–µ –Ω–µ ann_vip —ñ –Ω–µ ann_pre_vip)
  if (tagsStr.includes('ann') && !tagsStr.includes('ann_vip') && !tagsStr.includes('ann_pre_vip')) {
    return 'SILENT VIP';
  }
  
  // VIP: –ø—Ä–æ—Å—Ç–æ 'vip' tag (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –æ–∫—Ä–µ–º–∏–π tag, –Ω–µ —á–∞—Å—Ç–∏–Ω–∞ —ñ–Ω—à–æ–≥–æ)
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ 'vip' –ù–ï —î —á–∞—Å—Ç–∏–Ω–æ—é pre_vip –∞–±–æ _vip
  var tagsArray = tagsStr.split(',').map(t => t.trim());
  if (tagsArray.includes('vip')) {
    return 'VIP';
  }
  
  return 'UNKNOWN';
}

/**
 * Load TYPE mapping from Google Sheets
 * This should be called during app initialization
 */
function loadTypeMapping() {
  return new Promise((resolve) => {
    console.log('üìã Loading TYPE mapping from Google Sheets...');
    
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      console.log('‚ö†Ô∏è Not in Apps Script environment - using fallback TYPE detection');
      resolve();
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.error) {
          console.error('‚ùå Error loading TYPE mapping:', result.error);
          console.log('‚ö†Ô∏è Using fallback TYPE detection');
          resolve();
          return;
        }
        
        tagToTypeMap = result.tagToType || {};
        typeMapping = result.typeMapping || {};
        
        console.log('‚úÖ TYPE mapping loaded:', {
          types: Object.keys(typeMapping),
          tagsCount: Object.keys(tagToTypeMap).length
        });
        console.log('üìä Tag to Type mapping:');
        Object.entries(tagToTypeMap).forEach(([tag, type]) => {
          console.log(`  "${tag}" ‚Üí ${type}`);
        });
        
        if (typeof renderGlobalFilters === 'function') {
          renderGlobalFilters();
        }
        
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to load TYPE mapping:', error);
        console.log('‚ö†Ô∏è Using fallback TYPE detection');
        resolve();
      })
      .getTypeMapping();
  });
}

function createBackofficeLink(id){if(!id)return'';return'https://backoffice.slotornado-bivu.com/backend/players/'+String(id).replace('slotornado:','').trim()}

function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>showToast('üìã Copied: '+text)).catch(err=>console.error(err))}

function showToast(msg){const toast=document.getElementById('toast');toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000)}
function loadVIPData(){return new Promise((resolve)=>{console.log('Loading VIP data...');google.script.run.withSuccessHandler(data=>{console.log('VIP data received:',data);if(!data){console.error('No data received from backend');vipData={error:'No data received from backend'};renderVIPDashboard();resolve();return}if(data.error){console.error('Backend error:',data.error);vipData={error:data.error};renderVIPDashboard();resolve();return}vipData=data;window.vipAllPlayers=data.allPlayers||null;console.log('VIP data loaded successfully:',{playerCounts:data.playerCounts,allPlayers:vipAllPlayers?'‚úì':'‚úó',vocabulary:data.vocabulary?Object.keys(data.vocabulary).length:0,metrics:data.metrics?'‚úì':'‚úó'});renderVIPDashboard();renderVIPFilters();resolve()}).withFailureHandler(err=>{console.error('Failed to load VIP data:',err);vipData={error:'Failed to load VIP data: '+err.message};renderVIPDashboard();resolve()}).getVIPDashboardData()})}

let currentPeriod='30'
function getMetricIdForPeriod(baseMetric,period){const mapping={deposit_sum:{lifetime:'lifetime_deposit_sum_total','90':'deposit_sum_last_90_total','30':'deposit_sum_last_30_total','7':'deposit_sum_last_7_total','1':'deposit_sum_previous_day_total'},cashout_sum:{lifetime:'lifetime_cashout_sum_total','90':'cashout_sum_last_90_total','30':'cashout_sum_last_30_total','7':'cashout_sum_last_7_total','1':'cashout_sum_previous_day_total'},deposit_count:{lifetime:'lifetime_deposit_count_total','90':'deposit_count_last_90_total','30':'deposit_count_last_30_total','7':'deposit_count_last_7_total','1':'deposit_count_previous_day_total'},cashout_count:{lifetime:'lifetime_cashout_count_total','90':'cashout_count_last_90_total','30':'cashout_count_last_30_total','7':'cashout_count_last_7_total','1':'cashout_count_previous_day_total'}};return mapping[baseMetric]?mapping[baseMetric][period]:null}

function isCorePeriodMetric(metricId){const patterns=[/_deposit_sum_/,/_cashout_sum_/,/_deposit_count_/,/_cashout_count_/];return patterns.some(p=>p.test(metricId))}

function getBaseMetricType(metricId){if(metricId.includes('deposit_sum'))return'deposit_sum';if(metricId.includes('cashout_sum'))return'cashout_sum';if(metricId.includes('deposit_count'))return'deposit_count';if(metricId.includes('cashout_count'))return'cashout_count';return null}

function switchPeriod(period){currentPeriod=period;document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));document.querySelector('.period-tab[data-period="' + period + '"]').classList.add('active');renderVIPDashboard()}


function switchVIPTab(tab){
  currentVIPTab=tab;
  
  // Update active class on tabs
  document.querySelectorAll('.vip-tab').forEach(function(btn) {
    if (btn.getAttribute('data-tab') === tab) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  console.log('üîÑ Switched to VIP tab:', tab);
  renderVIPDashboard();
}


let vipFilters={manager:[],trafficType:[],country:[],currency:[],vipType:[]}
let vipDynamicFilters={}
// Use window.vipAllPlayers for global access
window.vipAllPlayers=null
let vipManagerMapping={}
let vipTrafficMapping={}
let currentManager=null
let availableManagers=[]

function getPlayerManager(player){
  if(!player||!player.tags||!Array.isArray(player.tags))return'';
  
  // Find all matching tags
  const matches=[];
  for(let i=0;i<player.tags.length;i++){
    const tag=String(player.tags[i]).trim();
    if(vipManagerMapping[tag]){
      matches.push({
        tag:tag,
        manager:vipManagerMapping[tag],
        priority:tag.length  // Longer tags = more specific
      });
    }
  }
  
  if(matches.length===0)return'';
  
  // Sort by priority (longer/more specific tags first)
  matches.sort((a,b)=>b.priority-a.priority);
  
  // Return most specific match
  return matches[0].manager;
}

function getStagPrefix(fullStag){if(!fullStag)return'';const stagStr=String(fullStag);const idx=stagStr.indexOf('_');return idx>0?stagStr.substring(0,idx):stagStr}

function toggleVIPFilterSidebar(){
  console.log('üîç Toggle VIP Filter');
  const sidebar=document.getElementById('vipFilterSidebar');
  const overlay=document.getElementById('vipFilterOverlay');
  if(!sidebar){console.error('‚ùå VIP sidebar not found!');return;}
  if(!overlay){console.error('‚ùå VIP overlay not found!');return;}
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('open');
  
  const isOpen=sidebar.classList.contains('open');
  console.log('‚úÖ VIP sidebar toggled, open:', isOpen);
  
  if(isOpen){
    console.log('  - Sidebar position:', window.getComputedStyle(sidebar).right);
    console.log('  - Sidebar z-index:', window.getComputedStyle(sidebar).zIndex);
  }
}

// Deposit Sidebar Functions
function openDepositFilterSidebar(){
  console.log('üîç Opening Deposit Filter Sidebar');
  document.getElementById('depositFilterSidebar').classList.add('active');
  document.getElementById('depositFilterOverlay').classList.add('active');
  document.body.style.overflow='hidden';
  setupDepositSidebarSearch();
}

function closeDepositFilterSidebar(){
  console.log('üîç Closing Deposit Filter Sidebar');
  document.getElementById('depositFilterSidebar').classList.remove('active');
  document.getElementById('depositFilterOverlay').classList.remove('active');
  document.body.style.overflow='';
}

// Retention Sidebar Functions
function openRetentionFilterSidebar(){
  console.log('üîç Opening Retention Filter Sidebar');
  document.getElementById('retentionFilterSidebar').classList.add('active');
  document.getElementById('retentionFilterOverlay').classList.add('active');
  document.body.style.overflow='hidden';
  setupRetentionSidebarSearch();
}

function closeRetentionFilterSidebar(){
  console.log('üîç Closing Retention Filter Sidebar');
  document.getElementById('retentionFilterSidebar').classList.remove('active');
  document.getElementById('retentionFilterOverlay').classList.remove('active');
  document.body.style.overflow='';
}

// Setup search for Deposit sidebar
function setupDepositSidebarSearch(){
  const filters=['Type','Manager','Traffic','Country'];
  filters.forEach(function(filter){
    const search=document.getElementById('deposit'+filter+'Search');
    const list=document.getElementById('deposit'+filter.replace('Type','VipType')+'Filters');
    if(search&&list){
      search.oninput=function(){
        const term=this.value.toLowerCase();
        Array.from(list.children).forEach(function(item){
          const label=item.querySelector('.sidebar-filter-item-label');
          if(label){
            const text=label.textContent.toLowerCase();
            item.style.display=text.includes(term)?'flex':'none';
          }
        });
      };
    }
  });
}

// Setup search for Retention sidebar
function setupRetentionSidebarSearch(){
  const filters=['Type','Manager','Traffic','Country'];
  filters.forEach(function(filter){
    const search=document.getElementById('retention'+filter+'Search');
    const list=document.getElementById('retention'+filter.replace('Type','VipType')+'Filters');
    if(search&&list){
      search.oninput=function(){
        const term=this.value.toLowerCase();
        Array.from(list.children).forEach(function(item){
          const label=item.querySelector('.sidebar-filter-item-label');
          if(label){
            const text=label.textContent.toLowerCase();
            item.style.display=text.includes(term)?'flex':'none';
          }
        });
      };
    }
  });
}

// Close sidebars on Escape key
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeDepositFilterSidebar();
    closeRetentionFilterSidebar();
  }
});

function renderSidebarFilterItems(containerId,values,filterKey,view){
  const container=document.getElementById(containerId);
  if(!container)return;
  
  container.innerHTML='';
  
  if(!values||values.length===0){
    container.innerHTML='<div style="padding:10px;text-align:center;color:#94a3b8;font-size:12px">No options</div>';
    return;
  }
  
  const currentFilters=view==='retention'?retentionFilters[filterKey]:depositFilters[filterKey];
  
  values.forEach((value,index)=>{
    if(!value||value==='')return;
    
    // Create item container
    const item=document.createElement('div');
    item.className='sidebar-filter-item';
    
    // Create checkbox
    const checkbox=document.createElement('input');
    checkbox.type='checkbox';
    checkbox.className='sidebar-filter-checkbox';
    checkbox.id=view+'_'+filterKey+'_'+index;
    if(currentFilters&&currentFilters.includes(value)){
      checkbox.checked=true;
    }
    
    // Create label
    const label=document.createElement('label');
    label.className='sidebar-filter-item-label';
    label.htmlFor=view+'_'+filterKey+'_'+index;
    label.textContent=value;
    
    // Create count badge (placeholder - will be updated with actual count)
    const count=document.createElement('span');
    count.className='sidebar-filter-count';
    count.textContent='0';
    count.style.display='none'; // Hide for now, will show when we have counts
    
    // Add click handler - only update filter object, don't re-render
    checkbox.onchange=function(){
      const filters=view==='deposit'?depositFilters:retentionFilters;
      if(this.checked){
        if(!filters[filterKey].includes(value)){
          filters[filterKey].push(value);
        }
      }else{
        filters[filterKey]=filters[filterKey].filter(v=>v!==value);
      }
      console.log('‚úÖ Filter updated:', view, filterKey, '=', value, 'checked:', this.checked);
      console.log('üìä Current', view, 'filters:', JSON.stringify(filters, null, 2));
    };
    
    // Assemble item
    item.appendChild(checkbox);
    item.appendChild(label);
    item.appendChild(count);
    
    container.appendChild(item);
  });
}

function applyDepositFilters(){
  console.log('‚úÖ Applying Deposit Filters');
  console.log('üìä Deposit filters:', depositFilters);
  console.log('üìä Detailed filters:', {
    types: depositFilters.type,
    managers: depositFilters.manager,
    trafficTypes: depositFilters.trafficType,
    countries: depositFilters.country
  });
  console.log('üî¢ Filter counts:', {
    types: depositFilters.type.length,
    managers: depositFilters.manager.length,
    traffic: depositFilters.trafficType.length,
    countries: depositFilters.country.length
  });
  renderBarChart();
  renderDepositTable();
  closeDepositFilterSidebar();
  showToast('‚úÖ Filters applied');
}

function applyRetentionFilters(){
  console.log('===== APPLYING RETENTION FILTERS =====');
  console.log('üìä Types selected:', retentionFilters.type);
  console.log('üë§ Managers selected:', retentionFilters.manager);
  console.log('üéØ Traffic selected:', retentionFilters.trafficType);
  console.log('üåç Countries selected:', retentionFilters.country);
  console.log('======================================');
  
  if(retentionMode==='monthly'){
    renderRetentionChart();
    renderRetentionTable();
  }else{
    renderWeeklyRetentionChart();
    renderWeeklyRetentionTable();
  }
  closeRetentionFilterSidebar();
  showToast('‚úÖ Filters applied');
}

function toggleVIPTypeFilter(vipType){const checkbox=vipType==='VIP'?document.getElementById('vipTypeVIP'):document.getElementById('vipTypeSilent');checkbox.classList.toggle('checked');const checked=checkbox.classList.contains('checked');updateVIPFilter('vipType',vipType,checked)}

function selectManager(managerName){currentManager=managerName||null;updateManagerUI();applyManagerFilter()}

function clearManager(){currentManager=null;document.getElementById('vipManagerDropdown').value='';updateManagerUI();applyManagerFilter()}

function updateManagerUI(){const badge=document.getElementById('vipManagerBadge');const clearBtn=document.getElementById('vipManagerClearBtn');if(currentManager){badge.textContent='üë§ '+currentManager;badge.style.display='inline-flex';clearBtn.style.display='block'}else{badge.style.display='none';clearBtn.style.display='none'}}

function applyManagerFilter(){if(!vipAllPlayers)return;console.log('üéØ Applying manager filter:',currentManager);let filteredPlayers=vipAllPlayers;if(currentManager){filteredPlayers={vip:vipAllPlayers.vip.filter(p=>getPlayerManager(p)===currentManager),silentVip:vipAllPlayers.silentVip.filter(p=>getPlayerManager(p)===currentManager)};console.log('Filtered by manager:',filteredPlayers.vip.length,'VIP +',filteredPlayers.silentVip.length,'Silent VIP')}const finalFiltered=filterVIPData(filteredPlayers,vipFilters);const vocabulary=vipData.vocabulary||{};const newMetrics=calculateVIPMetricsClient(finalFiltered.vip,finalFiltered.silentVip,vocabulary);vipData.metrics=newMetrics;vipData.playerCounts={total:finalFiltered.vip.length+finalFiltered.silentVip.length,vip:finalFiltered.vip.length,silentVip:finalFiltered.silentVip.length};renderVIPDashboard()}

function populateManagerDropdown(){console.log('üîß populateManagerDropdown called with',availableManagers.length,'managers');const dropdown=document.getElementById('vipManagerDropdown');const selector=document.getElementById('vipManagerSelector');if(!availableManagers||availableManagers.length===0){console.log('‚ö†Ô∏è No managers available, hiding selector');selector.style.display='none';return}console.log('‚úÖ Showing manager selector with managers:',availableManagers);selector.style.display='flex';dropdown.innerHTML='<option value="">All Managers</option>';availableManagers.forEach(manager=>{const option=document.createElement('option');option.value=manager;option.textContent=manager;dropdown.appendChild(option)});console.log('‚úÖ Manager dropdown populated')}

function toggleVIPSubmenu(){console.log('üîÑ toggleVIPSubmenu called');const submenu=document.getElementById('vipSubmenu');const toggle=document.getElementById('vipSubmenuToggle');if(!submenu||!toggle){console.error('‚ùå Submenu or toggle not found');return}submenu.classList.toggle('open');toggle.classList.toggle('open');console.log('Submenu open:',submenu.classList.contains('open'))}

function populateVIPSubmenu(){console.log('üîß populateVIPSubmenu called');console.log('availableManagers:',availableManagers);const submenu=document.getElementById('vipSubmenu');if(!submenu){console.error('‚ùå VIP submenu element not found');return}const toggle=document.getElementById('vipSubmenuToggle');if(!toggle){console.error('‚ùå VIP submenu toggle not found');return}if(!availableManagers||availableManagers.length===0){console.log('‚ö†Ô∏è No managers available - check if TAGS sheet has data and VIP players have tags');submenu.innerHTML='<div style="padding:10px 16px 10px 48px;color:#94a3b8;font-size:12px;font-style:italic">No managers found<br><span style="font-size:11px">Check TAGS sheet & player tags</span></div>';toggle.style.display='inline-block';return}let html='';availableManagers.forEach(manager=>{html+='<div class="sidebar-submenu-item" onclick="selectManagerFromSidebar(manager)"><span class="sidebar-submenu-item-icon">üë§</span><span>' + manager + '</span></div>'});submenu.innerHTML=html;toggle.style.display='inline-block';console.log('‚úÖ VIP submenu populated with',availableManagers.length,'managers:',availableManagers)}

function selectManagerFromSidebar(manager){console.log('üìå Selected manager from sidebar:',manager);currentManager=manager;document.getElementById('vipManagerDropdown').value=manager;updateManagerUI();applyManagerFilter();document.querySelectorAll('.sidebar-submenu-item').forEach(item=>item.classList.remove('active'));event.target.closest('.sidebar-submenu-item').classList.add('active')}

function filterVIPData(allPlayers,filters){if(!allPlayers)return{vip:[],silentVip:[]};let vipFiltered=allPlayers.vip||[];let silentFiltered=allPlayers.silentVip||[];const allFilters={...filters,...vipDynamicFilters};const hasFilters=Object.values(allFilters).some(arr=>arr&&arr.length>0);if(!hasFilters)return allPlayers;const applyFilters=(players,playerType)=>{return players.filter(player=>{if(allFilters.vipType&&allFilters.vipType.length>0){if(!allFilters.vipType.includes(playerType))return false}if(allFilters.manager&&allFilters.manager.length>0){const playerManager=getPlayerManager(player);if(!allFilters.manager.includes(playerManager))return false}if(allFilters.trafficType&&allFilters.trafficType.length>0){const stagPrefix=getStagPrefix(player.stag);const playerTraffic=vipTrafficMapping[stagPrefix]||'';if(!allFilters.trafficType.includes(playerTraffic))return false}if(allFilters.country&&allFilters.country.length>0){if(!allFilters.country.includes(String(player.country||'').trim()))return false}if(allFilters.currency&&allFilters.currency.length>0){if(!allFilters.currency.includes(String(player.currency||'').trim()))return false}for(const key in allFilters){if(!['manager','trafficType','country','currency','vipType'].includes(key)&&allFilters[key]&&allFilters[key].length>0){let value=String(player[key]||'').trim();if(key==='gender'){const g=value.toLowerCase();value=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}if(!allFilters[key].includes(value))return false}}return true})};return{vip:applyFilters(vipFiltered,'VIP'),silentVip:applyFilters(silentFiltered,'Silent VIP')}}

function calculateVIPMetricsClient(vipPlayers,silentPlayers,vocabulary){const allPlayers=vipPlayers.concat(silentPlayers);const metrics={sums:{},pies:{},total:{count:allPlayers.length,vipCount:vipPlayers.length,silentVipCount:silentPlayers.length}};Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.type==='dash sum'||metric.type==='dash count'){let totalSum=0,vipSum=0,silentSum=0;vipPlayers.forEach(p=>{const val=Number(p[metricId]||0);vipSum+=val;totalSum+=val});silentPlayers.forEach(p=>{const val=Number(p[metricId]||0);silentSum+=val;totalSum+=val});metrics.sums[metricId]={total:totalSum,vip:vipSum,silentVip:silentSum,name:metric.name,type:metric.type}}else if(metric.type==='dash pie'){const totalDist={},vipDist={},silentDist={};vipPlayers.forEach(p=>{let val=String(p[metricId]||'Unknown').trim();if(metricId==='gender'){const g=val.toLowerCase();val=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}vipDist[val]=(vipDist[val]||0)+1;totalDist[val]=(totalDist[val]||0)+1});silentPlayers.forEach(p=>{let val=String(p[metricId]||'Unknown').trim();if(metricId==='gender'){const g=val.toLowerCase();val=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}silentDist[val]=(silentDist[val]||0)+1;totalDist[val]=(totalDist[val]||0)+1});metrics.pies[metricId]={total:totalDist,vip:vipDist,silentVip:silentDist}}});return metrics}

function renderVIPFilters(){if(!vipData||!vipData.metrics||!vipData.metrics.pies)return;const pies=vipData.metrics.pies;const vocabulary=vipData.vocabulary||{};const countries=pies.country?Object.keys(pies.country.total).sort():[];const currencies=pies.currency?Object.keys(pies.currency.total).sort():[];renderVIPFilterItems('vipCountryFilterItems','vipCountrySearch','country',countries);renderVIPFilterItems('vipCurrencyFilterItems','vipCurrencySearch','currency',currencies);console.log('üîç Calling getVIPFilterOptions()...');google.script.run.withSuccessHandler(function(options){console.log('‚úÖ Filter options received:',options);if(options.error){console.error('‚ùå Failed to load filter options:',options.error);alert('‚ö†Ô∏è Error loading filters:\n\n'+options.error+'\n\nCheck:\n1. TAGS sheet exists with columns: A (tag), B (Type), C (Name)\n2. GENERAL INFO sheet exists with columns: STAG, TYPE');return}console.log('üìä Managers array:',options.managers);console.log('üìä Traffic Types array:',options.trafficTypes);console.log('üìä Manager mapping size:',Object.keys(options.managerMapping||{}).length);console.log('üìä Traffic mapping size:',Object.keys(options.trafficMapping||{}).length);vipManagerMapping=options.managerMapping||{};vipTrafficMapping=options.trafficMapping||{};availableManagers=options.managers||[];console.log('‚úÖ Mappings stored:',{tagToManager:Object.keys(vipManagerMapping).length,traffic:Object.keys(vipTrafficMapping).length});console.log('Sample manager mapping:',Object.keys(vipManagerMapping).slice(0,3).map(k=>k+' ‚Üí '+vipManagerMapping[k]));console.log('Sample traffic mapping:',Object.keys(vipTrafficMapping).slice(0,3).map(k=>k+' ‚Üí '+vipTrafficMapping[k]));renderVIPFilterItems('vipManagerFilterItems','vipManagerSearch','manager',options.managers||[]);renderVIPFilterItems('vipTrafficFilterItems','vipTrafficSearch','trafficType',options.trafficTypes||[]);populateManagerDropdown();populateVIPSubmenu()}).withFailureHandler(function(err){console.error('‚ùå Failed to call getVIPFilterOptions:',err);alert('‚ö†Ô∏è Failed to load filter options:\n\n'+err+'\n\nCheck Apps Script logs (Executions tab)')}).getVIPFilterOptions();const dynamicSection=document.getElementById('vipDynamicFilters');let dynamicHTML='';let hasDynamicFilters=false;Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.filter==='filter'&&metric.type==='dash pie'&&pies[metricId]&&metricId!=='country'&&metricId!=='currency'){if(!hasDynamicFilters){dynamicHTML+='<div class="vip-filter-section-title">üéØ Dynamic Filters</div>';hasDynamicFilters=true}const values=Object.keys(pies[metricId].total).sort();const displayName=metric.name||metricId;if(!vipDynamicFilters[metricId])vipDynamicFilters[metricId]=[];dynamicHTML+='<div class="vip-filter-group"><label class="vip-filter-group-label">' + displayName + '</label><input type="text" class="vip-filter-search" id="vip' + metricId + 'Search" placeholder="Search..."><div class="vip-filter-items" id="vip' + metricId + 'FilterItems"></div></div>'}});dynamicSection.innerHTML=dynamicHTML;Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.filter==='filter'&&metric.type==='dash pie'&&pies[metricId]&&metricId!=='country'&&metricId!=='currency'){const values=Object.keys(pies[metricId].total).sort();renderVIPFilterItems('vip' + metricId + 'FilterItems','vip' + metricId + 'Search',metricId,values)}});updateVIPFilterBadge()}

function renderVIPFilterItems(containerId,searchId,filterKey,values){const container=document.getElementById(containerId);if(!container)return;const search=document.getElementById(searchId);container.innerHTML='';if(!values||values.length===0){container.innerHTML='<div style="padding:10px;text-align:center;color:#94a3b8;font-size:12px">No options available</div>';return}const currentFilters=filterKey in vipFilters?vipFilters[filterKey]:vipDynamicFilters[filterKey]||[];values.forEach(value=>{if(!value||value==='')return;const item=document.createElement('div');item.className='vip-filter-item';const checkbox=document.createElement('div');checkbox.className='vip-filter-checkbox';if(currentFilters.includes(value)){checkbox.classList.add('checked')}const text=document.createElement('span');text.className='vip-filter-item-text';text.textContent=value;item.appendChild(checkbox);item.appendChild(text);item.onclick=()=>{checkbox.classList.toggle('checked');updateVIPFilter(filterKey,value,checkbox.classList.contains('checked'))};container.appendChild(item)});if(search){search.oninput=()=>{const term=search.value.toLowerCase();container.querySelectorAll('.vip-filter-item').forEach(item=>{const text=item.querySelector('.vip-filter-item-text').textContent.toLowerCase();item.style.display=text.includes(term)?'flex':'none'})}}}

function updateVIPFilter(filterKey,value,checked){if(filterKey in vipFilters){if(checked){if(!vipFilters[filterKey].includes(value))vipFilters[filterKey].push(value)}else{vipFilters[filterKey]=vipFilters[filterKey].filter(v=>v!==value)}}else{if(!vipDynamicFilters[filterKey])vipDynamicFilters[filterKey]=[];if(checked){if(!vipDynamicFilters[filterKey].includes(value))vipDynamicFilters[filterKey].push(value)}else{vipDynamicFilters[filterKey]=vipDynamicFilters[filterKey].filter(v=>v!==value)}}updateVIPFilterBadge();updateActiveFiltersDisplay();applyManagerFilter()}

function updateActiveFiltersDisplay(){const allFilters={...vipFilters,...vipDynamicFilters};const container=document.getElementById('vipActiveFilters');const list=document.getElementById('vipActiveFiltersList');if(!container||!list)return;const filterLabels={vipType:'VIP Type',manager:'Manager',trafficType:'Traffic Type',country:'Country',currency:'Currency'};const vocabulary=vipData?.vocabulary||{};let html='';let hasFilters=false;Object.keys(allFilters).forEach(key=>{const values=allFilters[key];if(values&&values.length>0){hasFilters=true;const label=filterLabels[key]||vocabulary[key]?.name||key;values.forEach(val=>{html+='<div class="vip-filter-tag"><span class="vip-filter-tag-label">' + label + ':</span> ' + val + '<span class="vip-filter-tag-remove" onclick="removeFilter(key,val)">√ó</span></div>'})}});if(hasFilters){list.innerHTML=html;container.classList.add('visible')}else{container.classList.remove('visible')}}

function removeFilter(filterKey,value){if(filterKey==='vipType'){const checkbox=value==='VIP'?document.getElementById('vipTypeVIP'):document.getElementById('vipTypeSilent');if(checkbox)checkbox.classList.remove('checked')}else{const checkboxes=document.querySelectorAll('.vip-filter-checkbox');checkboxes.forEach(cb=>{const item=cb.parentElement;const text=item.querySelector('.vip-filter-item-text');if(text&&text.textContent===value){cb.classList.remove('checked')}})}updateVIPFilter(filterKey,value,false)}

function updateVIPFilterBadge(){const allFilters={...vipFilters,...vipDynamicFilters};let count=0;Object.values(allFilters).forEach(arr=>{if(arr&&arr.length>0)count+=arr.length});const badge=document.getElementById('vip-filter-badge');if(badge){if(count>0){badge.textContent=count;badge.style.display='inline-block'}else{badge.style.display='none'}}}

function clearAllVIPFilters(){vipFilters={manager:[],trafficType:[],country:[],currency:[],vipType:[]};vipDynamicFilters={};currentManager=null;document.getElementById('vipManagerDropdown').value='';updateManagerUI();document.querySelectorAll('.vip-filter-checkbox').forEach(cb=>cb.classList.remove('checked'));updateVIPFilterBadge();updateActiveFiltersDisplay();applyManagerFilter();showToast('üîÑ Filters cleared')}
function renderVIPDashboard(){console.log('Rendering VIP Dashboard...');const container=document.getElementById('vip-content');if(!vipData){container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚è≥</div><div style="font-size:18px;font-weight:600">Loading VIP Data...</div></div>';return}if(vipData.error){const errorMsg=vipData.error;container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">VIP Dashboard Unavailable</div><div style="font-size:14px;max-width:600px;margin:0 auto">' + errorMsg + '</div><div style="margin-top:20px;font-size:13px;color:#94a3b8">Check browser console (F12) for details</div></div>';return}if(!vipData.metrics){container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">No Metrics Available</div><div style="font-size:14px">Please ensure VOCABULARY sheet exists with metrics</div></div>';return}console.log('Rendering dashboard with tab:',currentVIPTab,'period:',currentPeriod);const metrics=vipData.metrics;const depositSumId=getMetricIdForPeriod('deposit_sum',currentPeriod);const cashoutSumId=getMetricIdForPeriod('cashout_sum',currentPeriod);const depositMetric=metrics.sums[depositSumId];const cashoutMetric=metrics.sums[cashoutSumId];function calculateINOUT(tab){const deposit=(depositMetric?depositMetric[tab]:0)||0;let cashout=(cashoutMetric?cashoutMetric[tab]:0)||0;if(currentPeriod!=='lifetime'){cashout=Math.abs(cashout)}return deposit-cashout}const totalINOUT=calculateINOUT('total');const vipINOUT=calculateINOUT('vip');const silentINOUT=calculateINOUT('silentVip');function formatINOUT(value){const formatted='‚Ç¨'+Math.abs(value).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});const color=value>=0?'#10b981':'#ef4444';return'<span style="color:' + color + ';font-weight:700">' + value>=0?'+':formatted + '</span>'}let cardsHTML='';if(currentVIPTab==='total'){cardsHTML='<div class="vip-cards-grid"><div class="vip-card"><div class="vip-card-header"><span class="vip-card-icon">üë•</span><span class="vip-card-title">Total Players</span></div><div class="vip-card-value" id="vip-total-count">' + metrics.total.count.toLocaleString() + '</div><div class="vip-card-subtitle">All VIP + Silent VIP</div><div class="vip-card-sum" id="vip-total-sum">' + formatINOUT(totalINOUT) + '</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">INOUT (Deposit - Cashout)</div></div><div class="vip-card"><div class="vip-card-header"><span class="vip-card-icon">üëë</span><span class="vip-card-title">VIP Players</span></div><div class="vip-card-value" id="vip-vip-count">' + metrics.total.vipCount.toLocaleString() + '</div><div class="vip-card-subtitle">VIP sheet players</div><div class="vip-card-sum" id="vip-vip-sum">' + formatINOUT(vipINOUT) + '</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">INOUT (Deposit - Cashout)</div></div><div class="vip-card"><div class="vip-card-header"><span class="vip-card-icon">ü§´</span><span class="vip-card-title">Silent VIP Players</span></div><div class="vip-card-value" id="vip-silent-count">' + metrics.total.silentVipCount.toLocaleString() + '</div><div class="vip-card-subtitle">Silent VIP sheet players</div><div class="vip-card-sum" id="vip-silent-sum">' + formatINOUT(silentINOUT) + '</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">INOUT (Deposit - Cashout)</div></div></div>'}else if(currentVIPTab==='vip'){cardsHTML='<div class="vip-cards-grid"><div class="vip-card"><div class="vip-card-header"><span class="vip-card-icon">üëë</span><span class="vip-card-title">VIP Players</span></div><div class="vip-card-value" id="vip-vip-count">' + metrics.total.vipCount.toLocaleString() + '</div><div class="vip-card-subtitle">VIP sheet players</div><div class="vip-card-sum" id="vip-vip-sum">' + formatINOUT(vipINOUT) + '</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">INOUT (Deposit - Cashout)</div></div></div>'}else{cardsHTML='<div class="vip-cards-grid"><div class="vip-card"><div class="vip-card-header"><span class="vip-card-icon">ü§´</span><span class="vip-card-title">Silent VIP Players</span></div><div class="vip-card-value" id="vip-silent-count">' + metrics.total.silentVipCount.toLocaleString() + '</div><div class="vip-card-subtitle">Silent VIP sheet players</div><div class="vip-card-sum" id="vip-silent-sum">' + formatINOUT(silentINOUT) + '</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">INOUT (Deposit - Cashout)</div></div></div>'}container.innerHTML=cardsHTML+'<div id="vip-metrics-grid"></div>';renderVIPMetricsGrid()}

function renderVIPMetricsGrid(){if(!vipData||!vipData.metrics||!vipData.metrics.sums){return}const grid=document.getElementById('vip-metrics-grid');const sums=vipData.metrics.sums;const pies=vipData.metrics.pies||{};const vocabulary=vipData.vocabulary||{};if(Object.keys(sums).length===0&&Object.keys(pies).length===0){grid.innerHTML='<div style="padding:20px;text-align:center;color:#64748b">No metrics available</div>';return}const coreMetrics={deposit_sum:null,cashout_sum:null,deposit_count:null,cashout_count:null};const otherSumMetrics=[];const otherCountMetrics=[];const dashPieMetrics=[];Object.keys(sums).forEach(metricId=>{const metric=sums[metricId];const baseType=getBaseMetricType(metricId);if(baseType){const expectedId=getMetricIdForPeriod(baseType,currentPeriod);if(metricId===expectedId){coreMetrics[baseType]={id:metricId,name:metric.name||metricId,data:metric}}}else{if(metric.type==='dash sum'){otherSumMetrics.push({id:metricId,name:metric.name||metricId,data:metric})}else if(metric.type==='dash count'){otherCountMetrics.push({id:metricId,name:metric.name||metricId,data:metric})}}});Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.type==='dash pie'&&pies[metricId]){dashPieMetrics.push({id:metricId,name:metric.name||metricId})}});let html='';html+='<div style="margin-top:30px"><h3 style="font-size:18px;font-weight:600;color:#1e293b;margin-bottom:16px">üí∞ Core Metrics</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;width:100%;box-sizing:border-box">';const coreOrder=['deposit_sum','cashout_sum','deposit_count','cashout_count'];coreOrder.forEach(key=>{const metric=coreMetrics[key];if(metric){let value=0;if(currentVIPTab==='total'){value=metric.data.total||0}else if(currentVIPTab==='vip'){value=metric.data.vip||0}else{value=metric.data.silentVip||0}if(key==='cashout_sum'&&currentPeriod!=='lifetime'){value=Math.abs(value)}const icon=key.includes('sum')?'üí∞':'üî¢';const formatted=key.includes('sum')?'‚Ç¨'+value.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):Math.round(value).toLocaleString();const metricType=key.includes('sum')?'currency':'number';html+='<div class="vip-card" data-metric-id="' + metric.id + '" data-metric-name="' + metric.name + '" data-metric-type="' + metricType + '" onclick="openMetricModalFromCard(this)" style="cursor:pointer;transition:all 0.2s"><div class="vip-card-header"><span class="vip-card-icon">' + icon + '</span><span class="vip-card-title">' + metric.name + '</span></div><div class="vip-card-value" style="font-size:32px">' + formatted + '</div><div class="vip-card-subtitle">' + (currentVIPTab==='total'?'All Players':currentVIPTab==='vip'?'VIP Only':'Silent VIP Only') + '</div><div style="text-align:center;margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;color:#667eea;font-size:13px;font-weight:600;opacity:0.8">üëÜ Click for details</div></div>'}});html+='</div></div>';if(otherSumMetrics.length>0){html+='<div style="margin-top:30px"><h3 style="font-size:18px;font-weight:600;color:#1e293b;margin-bottom:16px">üí∞ Other Sum Metrics (‚Ç¨)</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;width:100%;box-sizing:border-box">';otherSumMetrics.forEach(metric=>{let value=0;if(currentVIPTab==='total'){value=metric.data.total||0}else if(currentVIPTab==='vip'){value=metric.data.vip||0}else{value=metric.data.silentVip||0}html+='<div class="vip-card" data-metric-id="' + metric.id + '" data-metric-name="' + metric.name + '" data-metric-type="currency" onclick="openMetricModalFromCard(this)" style="cursor:pointer;transition:all 0.2s"><div class="vip-card-header"><span class="vip-card-icon">üí∞</span><span class="vip-card-title">' + metric.name + '</span></div><div class="vip-card-value" style="font-size:32px">‚Ç¨' + value.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div><div class="vip-card-subtitle">' + (currentVIPTab==='total'?'All Players':currentVIPTab==='vip'?'VIP Only':'Silent VIP Only') + '</div><div style="text-align:center;margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;color:#667eea;font-size:13px;font-weight:600;opacity:0.8">üëÜ Click for details</div></div>'});html+='</div></div>'}if(otherCountMetrics.length>0){html+='<div style="margin-top:30px"><h3 style="font-size:18px;font-weight:600;color:#1e293b;margin-bottom:16px">üî¢ Other Count Metrics</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;width:100%;box-sizing:border-box">';otherCountMetrics.forEach(metric=>{let value=0;if(currentVIPTab==='total'){value=metric.data.total||0}else if(currentVIPTab==='vip'){value=metric.data.vip||0}else{value=metric.data.silentVip||0}html+='<div class="vip-card" data-metric-id="' + metric.id + '" data-metric-name="' + metric.name + '" data-metric-type="number" onclick="openMetricModalFromCard(this)" style="cursor:pointer;transition:all 0.2s"><div class="vip-card-header"><span class="vip-card-icon">üî¢</span><span class="vip-card-title">' + metric.name + '</span></div><div class="vip-card-value" style="font-size:32px">' + Math.round(value).toLocaleString() + '</div><div class="vip-card-subtitle">' + (currentVIPTab==='total'?'All Players':currentVIPTab==='vip'?'VIP Only':'Silent VIP Only') + '</div><div style="text-align:center;margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;color:#667eea;font-size:13px;font-weight:600;opacity:0.8">üëÜ Click for details</div></div>'});html+='</div></div>'}if(dashPieMetrics.length>0){html+='<div style="margin-top:30px"><h3 style="font-size:18px;font-weight:600;color:#1e293b;margin-bottom:16px">üìä Pie Chart Metrics</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;width:100%;box-sizing:border-box">';dashPieMetrics.forEach(metric=>{const pieId='pie_'+metric.id.replace(/[^a-z0-9]/gi,'_');html+='<div class="vip-card" data-metric-id="' + metric.id + '" data-metric-name="' + metric.name + '" onclick="openPieChartModal(this.dataset.metricId, this.dataset.metricName)" style="cursor:pointer;transition:all 0.2s"><div class="vip-card-header"><span class="vip-card-icon">üìä</span><span class="vip-card-title">' + metric.name + '</span></div><div style="height:280px;position:relative;padding:20px"><canvas id="' + pieId + '"></canvas></div><div style="text-align:center;margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;color:#667eea;font-size:13px;font-weight:600;opacity:0.8">üëÜ Click for details</div></div>'});html+='</div></div>'}grid.innerHTML=html;console.log('VIP metrics grid rendered with period:',currentPeriod);if(dashPieMetrics.length>0&&vipData.metrics.pies){setTimeout(()=>{dashPieMetrics.forEach(metric=>{const pieData=vipData.metrics.pies[metric.id];if(!pieData)return;let distribution=null;if(currentVIPTab==='total'){distribution=pieData.total}else if(currentVIPTab==='vip'){distribution=pieData.vip}else{distribution=pieData.silentVip}if(!distribution||Object.keys(distribution).length===0)return;const pieId='pie_'+metric.id.replace(/[^a-z0-9]/gi,'_');renderVIPPieChart(pieId,distribution,metric.name)})},100)}}
function renderVIPPieChart(canvasId,distribution,metricName){if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById(canvasId);if(!canvas){console.error('Canvas not found:',canvasId);return}const ctx=canvas.getContext('2d');if(!ctx)return;function improveLabel(label,metricName){const labelStr=String(label).trim();if(metricName.toLowerCase().includes('gender')){if(labelStr.toLowerCase()==='m'||labelStr.toLowerCase()==='male')return'Male';if(labelStr.toLowerCase()==='f'||labelStr.toLowerCase()==='female')return'Female'}if(labelStr===''||labelStr==='null'||labelStr==='undefined')return'Unknown';return labelStr}const improvedDist={};Object.keys(distribution).forEach(key=>{const improvedKey=improveLabel(key,metricName);improvedDist[improvedKey]=(improvedDist[improvedKey]||0)+distribution[key]});const sortedEntries=Object.entries(improvedDist).sort((a,b)=>b[1]-a[1]);const labels=sortedEntries.map(([k])=>k);const values=sortedEntries.map(([,v])=>v);const colors=['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe','#43e97b','#38f9d7','#fa709a','#fee140','#30cfd0','#330867','#a8edea','#fed6e3','#ff9a9e','#fecfef'];new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:values,backgroundColor:colors.slice(0,labels.length),borderColor:'#fff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,layout:{padding:10},plugins:{legend:{position:'bottom',labels:{padding:10,font:{size:11},generateLabels:function(chart){const data=chart.data;if(data.labels.length&&data.datasets.length){return data.labels.map((label,i)=>{const value=data.datasets[0].data[i];const total=data.datasets[0].data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return{text:label+': '+value+' ('+percentage+'%)',fillStyle:data.datasets[0].backgroundColor[i],hidden:false,index:i}})}}}},tooltip:{callbacks:{label:function(context){const label=context.label||'';const value=context.parsed;const total=context.dataset.data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return' '+label+': '+value+' ('+percentage+'%)'}}}}}})};

// Metric Modal Functions


function openMetricModalFromCard(element) {
  console.log('üîµ openMetricModalFromCard called', element);
  const metricId = element.getAttribute('data-metric-id');
  const metricName = element.getAttribute('data-metric-name');
  const metricType = element.getAttribute('data-metric-type');
  console.log('üîµ Modal data:', {metricId, metricName, metricType});
  openMetricModal(metricId, metricName, metricType);
}

function handlePieClickWrapper(evt) {
  const canvas = evt.target;
  const metricId = canvas.getAttribute('data-metric-id');
  const metricName = canvas.getAttribute('data-metric-name');
  handlePieClick(evt, metricId, metricName);
}

// ============================================
// PERFECT MODAL FUNCTIONS - NO SYNTAX ERRORS
// ============================================

let metricModalSort = {column: null, direction: 'desc'};
let currentModalPlayers = [];
let visibleColumns = {
  name: true,
  email: true,
  link: true,
  vipType: true,
  manager: true,
  country: true,
  filterValue: true,
  deposit_sum_lifetime: true,
  cashout_sum_lifetime: true,
  deposit_count_lifetime: true,
  cashout_count_lifetime: true,
  inout_lifetime: true,
  deposit_sum_1d: true,
  cashout_sum_1d: true,
  deposit_count_1d: true,
  cashout_count_1d: true,
  inout_1d: true,
  deposit_sum_7d: true,
  cashout_sum_7d: true,
  deposit_count_7d: true,
  cashout_count_7d: true,
  inout_7d: true,
  deposit_sum_30d: true,
  cashout_sum_30d: true,
  deposit_count_30d: true,
  cashout_count_30d: true,
  inout_30d: true,
  deposit_sum_90d: true,
  cashout_sum_90d: true,
  deposit_count_90d: true,
  cashout_count_90d: true,
  inout_90d: true,
  value: true
};


function formatMetricValue(value, type) {
  if (type === 'currency') {
    return '‚Ç¨' + (value || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  } else {
    return Math.round(value || 0).toLocaleString();
  }
}

function openMetricModal(metricId, metricName, metricType) {
  console.log('üü¢ openMetricModal called with:', {metricId, metricName, metricType});
  console.log('üü¢ vipAllPlayers:', vipAllPlayers ? 'Loaded ‚úì' : 'NOT loaded ‚úó');
  console.log('üü¢ vipData:', vipData ? 'Loaded ‚úì' : 'NOT loaded ‚úó');
  
  if (!vipAllPlayers) {
    alert('Player data not loaded yet');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var title = document.getElementById('metricModalTitle');
  var body = document.getElementById('metricModalBody');
  
  title.textContent = metricName;
  
  var metricData = vipData.metrics.sums[metricId];
  
  if (!metricData) {
    body.innerHTML = '<div style="padding:40px;text-align:center;color:#64748b">Metric data not available</div>';
    modal.style.display = 'flex';
    return;
  }
  
  var activeFilters = getActiveFilters();
  
  var html = '';
  
  if (activeFilters.length > 0) {
    html += '<div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px 16px;margin-bottom:20px">';
    html += '<div style="font-size:13px;font-weight:600;color:#1e40af;margin-bottom:6px">üîç Applied Filters:</div>';
    html += '<div style="font-size:12px;color:#1e40af">' + activeFilters.join(' ‚Ä¢ ') + '</div>';
    html += '</div>';
  }
  
  html += '<div class="metric-breakdown">';
  html += '<div class="metric-breakdown-card">';
  html += '<div class="metric-breakdown-label">Total</div>';
  html += '<div class="metric-breakdown-value">' + formatMetricValue(metricData.total || 0, metricType) + '</div>';
  html += '<div class="metric-breakdown-subtitle">All Players</div>';
  html += '</div>';
  html += '<div class="metric-breakdown-card">';
  html += '<div class="metric-breakdown-label">VIP</div>';
  html += '<div class="metric-breakdown-value">' + formatMetricValue(metricData.vip || 0, metricType) + '</div>';
  html += '<div class="metric-breakdown-subtitle">VIP Category</div>';
  html += '</div>';
  html += '<div class="metric-breakdown-card">';
  html += '<div class="metric-breakdown-label">Silent VIP</div>';
  html += '<div class="metric-breakdown-value">' + formatMetricValue(metricData.silentVip || 0, metricType) + '</div>';
  html += '<div class="metric-breakdown-subtitle">Silent Category</div>';
  html += '</div>';
  html += '</div>';
  
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">';
  html += '<div style="position:relative">';
  html += '<button onclick="toggleColumnSelector(event)" style="background:#667eea;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üëÅÔ∏è Columns</button>';
  html += '<div id="columnSelector" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:200px;z-index:1000"></div>';
  html += '</div>';
  html += '<button onclick="createSheetFromModal()" style="background:#10b981;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üìä Create Sheet</button>';
  html += '</div>';
  
  html += '<h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:24px 0 16px 0">üìã Players Breakdown</h3>';
  html += '<div class="metric-table-container" style="overflow-x:auto;max-height:500px">';
  html += '<table class="metric-table" id="modalTable" style="width:100%;min-width:1800px">';
  html += '<thead style="position:sticky;top:0;background:#fff;z-index:10"><tr id="modalTableHeader"></tr></thead>';
  html += '<tbody id="metricTableBody"></tbody>';
  html += '</table>';
  html += '</div>';
  
  body.innerHTML = html;
  
  modal.dataset.metricId = metricId;
  modal.dataset.metricName = metricName;
  modal.dataset.metricType = metricType;
  
  renderMetricTable(metricId, metricType);
  
  modal.style.display = 'flex';
}

function renderMetricTable(metricId, metricType) {
  var tbody = document.getElementById('metricTableBody');
  var thead = document.getElementById('modalTableHeader');
  if (!tbody || !thead) return;
  
  var periodSuffix = getPeriodSuffix(currentPeriod);
  var vocabulary = vipData.vocabulary || {};
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (vipFilters) {
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filteredVip = filteredVip.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
      filteredSilent = filteredSilent.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
    }
    if (vipFilters.currency && vipFilters.currency.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.currency.includes(p.currency || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.currency.includes(p.currency || ''); });
    }
  }
  
  if (currentVIPTab === 'vip') {
    filteredSilent = [];
  } else if (currentVIPTab === 'silent-vip') {
    filteredVip = [];
  }
  
  var players = [];
  
  filteredVip.forEach(function(player) {
    var value = player[metricId] || 0;
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      value: value,
      rawPlayer: player
    });
  });
  
  filteredSilent.forEach(function(player) {
    var value = player[metricId] || 0;
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'Silent VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      value: value,
      rawPlayer: player
    });
  });
  
  if (metricModalSort.column) {
    players.sort(function(a, b) {
      var col = metricModalSort.column;
      var valA = a[col];
      var valB = b[col];
      
      var numericCols = ['value', 
        'deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime',
        'deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d',
        'deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d',
        'deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d',
        'deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d'
      ];
      
      if (numericCols.includes(col)) {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      } else {
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
      }
      
      if (valA < valB) return metricModalSort.direction === 'asc' ? -1 : 1;
      if (valA > valB) return metricModalSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
  }
  
  currentModalPlayers = players;
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  function getVocabLabel(key) {
    if (vocabulary[key] && vocabulary[key].name) {
      return vocabulary[key].name;
    }
    return null;
  }
  
  var depSumLifetimeLabel = getVocabLabel('lifetime_deposit_sum_total') || 'Deposit Sum (LT)';
  var cashSumLifetimeLabel = getVocabLabel('lifetime_cashout_sum_total') || 'Cashout Sum (LT)';
  var depCountLifetimeLabel = getVocabLabel('lifetime_deposit_count_total') || 'Deposit Count (LT)';
  var cashCountLifetimeLabel = getVocabLabel('lifetime_cashout_count_total') || 'Cashout Count (LT)';
  
  var depSum1dLabel = getVocabLabel('deposit_sum_previous_day_total') || 'Deposit Sum (1d)';
  var cashSum1dLabel = getVocabLabel('cashout_sum_previous_day_total') || 'Cashout Sum (1d)';
  var depCount1dLabel = getVocabLabel('deposit_count_previous_day_total') || 'Deposit Count (1d)';
  var cashCount1dLabel = getVocabLabel('cashout_count_previous_day_total') || 'Cashout Count (1d)';
  
  var depSum7dLabel = getVocabLabel('deposit_sum_last_7_total') || 'Deposit Sum (7d)';
  var cashSum7dLabel = getVocabLabel('cashout_sum_last_7_total') || 'Cashout Sum (7d)';
  var depCount7dLabel = getVocabLabel('deposit_count_last_7_total') || 'Deposit Count (7d)';
  var cashCount7dLabel = getVocabLabel('cashout_count_last_7_total') || 'Cashout Count (7d)';
  
  var depSum30dLabel = getVocabLabel('deposit_sum_last_30_total') || 'Deposit Sum (30d)';
  var cashSum30dLabel = getVocabLabel('cashout_sum_last_30_total') || 'Cashout Sum (30d)';
  var depCount30dLabel = getVocabLabel('deposit_count_last_30_total') || 'Deposit Count (30d)';
  var cashCount30dLabel = getVocabLabel('cashout_count_last_30_total') || 'Cashout Count (30d)';
  
  var depSum90dLabel = getVocabLabel('deposit_sum_last_90_total') || 'Deposit Sum (90d)';
  var cashSum90dLabel = getVocabLabel('cashout_sum_last_90_total') || 'Cashout Sum (90d)';
  var depCount90dLabel = getVocabLabel('deposit_count_last_90_total') || 'Deposit Count (90d)';
  var cashCount90dLabel = getVocabLabel('cashout_count_last_90_total') || 'Cashout Count (90d)';
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    
    {key: 'deposit_sum_lifetime', label: depSumLifetimeLabel, width: '140px'},
    {key: 'cashout_sum_lifetime', label: cashSumLifetimeLabel, width: '140px'},
    {key: 'deposit_count_lifetime', label: depCountLifetimeLabel, width: '140px'},
    {key: 'cashout_count_lifetime', label: cashCountLifetimeLabel, width: '140px'},
    {key: 'inout_lifetime', label: 'INOUT (LT)', width: '140px'},
    
    {key: 'deposit_sum_1d', label: depSum1dLabel, width: '140px'},
    {key: 'cashout_sum_1d', label: cashSum1dLabel, width: '140px'},
    {key: 'deposit_count_1d', label: depCount1dLabel, width: '140px'},
    {key: 'cashout_count_1d', label: cashCount1dLabel, width: '140px'},
    {key: 'inout_1d', label: 'INOUT (1d)', width: '140px'},
    
    {key: 'deposit_sum_7d', label: depSum7dLabel, width: '140px'},
    {key: 'cashout_sum_7d', label: cashSum7dLabel, width: '140px'},
    {key: 'deposit_count_7d', label: depCount7dLabel, width: '140px'},
    {key: 'cashout_count_7d', label: cashCount7dLabel, width: '140px'},
    {key: 'inout_7d', label: 'INOUT (7d)', width: '140px'},
    
    {key: 'deposit_sum_30d', label: depSum30dLabel, width: '140px'},
    {key: 'cashout_sum_30d', label: cashSum30dLabel, width: '140px'},
    {key: 'deposit_count_30d', label: depCount30dLabel, width: '140px'},
    {key: 'cashout_count_30d', label: cashCount30dLabel, width: '140px'},
    {key: 'inout_30d', label: 'INOUT (30d)', width: '140px'},
    
    {key: 'deposit_sum_90d', label: depSum90dLabel, width: '140px'},
    {key: 'cashout_sum_90d', label: cashSum90dLabel, width: '140px'},
    {key: 'deposit_count_90d', label: depCount90dLabel, width: '140px'},
    {key: 'cashout_count_90d', label: cashCount90dLabel, width: '140px'},
    {key: 'inout_90d', label: 'INOUT (90d)', width: '140px'},
    
    {key: 'value', label: 'Value', width: '140px'}
  ];
  
  var headerHtml = '';
  
  columns.forEach(function(col) {
    if (visibleColumns[col.key]) {
      var sortIndicator = metricModalSort.column === col.key ? (metricModalSort.direction === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      var clickHandler = col.key !== 'link' ? 'onclick="sortMetricTable(\'' + col.key + '\')"' : '';
      var cursorStyle = col.key !== 'link' ? 'cursor:pointer;' : '';
      var bgColor = col.key === 'value' ? 'background:#f0fdf4;' : '';
      headerHtml += '<th ' + clickHandler + ' style="min-width:' + col.width + ';' + cursorStyle + bgColor + '">' + col.label + ' ' + sortIndicator + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var totals = {
    deposit_sum_lifetime: 0,
    cashout_sum_lifetime: 0,
    deposit_count_lifetime: 0,
    cashout_count_lifetime: 0,
    inout_lifetime: 0,
    deposit_sum_1d: 0,
    cashout_sum_1d: 0,
    deposit_count_1d: 0,
    cashout_count_1d: 0,
    inout_1d: 0,
    deposit_sum_7d: 0,
    cashout_sum_7d: 0,
    deposit_count_7d: 0,
    cashout_count_7d: 0,
    inout_7d: 0,
    deposit_sum_30d: 0,
    cashout_sum_30d: 0,
    deposit_count_30d: 0,
    cashout_count_30d: 0,
    inout_30d: 0,
    deposit_sum_90d: 0,
    cashout_sum_90d: 0,
    deposit_count_90d: 0,
    cashout_count_90d: 0,
    inout_90d: 0,
    value: 0
  };
  
  var bodyHtml = '';
  players.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = '';
      
      switch(col.key) {
        case 'name':
          cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
          cellStyle = 'font-weight:600';
          break;
        case 'email':
          cellContent = player.email;
          cellStyle = 'font-size:12px;color:#64748b';
          break;
        case 'link':
          if (player.link) {
            cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
          } else {
            cellContent = '‚Äî';
          }
          break;
        case 'vipType':
          var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
          var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
          cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
          break;
        case 'manager':
          cellContent = player.manager;
          break;
        case 'country':
          cellContent = player.country;
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_1d':
        case 'deposit_sum_7d':
        case 'deposit_sum_30d':
        case 'deposit_sum_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_1d':
        case 'cashout_sum_7d':
        case 'cashout_sum_30d':
        case 'cashout_sum_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'deposit_count_lifetime':
        case 'cashout_count_lifetime':
        case 'deposit_count_1d':
        case 'cashout_count_1d':
        case 'deposit_count_7d':
        case 'cashout_count_7d':
        case 'deposit_count_30d':
        case 'cashout_count_30d':
        case 'deposit_count_90d':
        case 'cashout_count_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = (player[col.key] || 0).toLocaleString();
          cellStyle = 'text-align:right';
          break;
        case 'inout_lifetime':
        case 'inout_1d':
        case 'inout_7d':
        case 'inout_30d':
        case 'inout_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          var inoutValue = player[col.key] || 0;
          var inoutColor = inoutValue >= 0 ? '#10b981' : '#ef4444';
          cellContent = '‚Ç¨' + Math.abs(inoutValue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right;font-weight:700;color:' + inoutColor + ';background:#f0fdf4';
          break;
        case 'value':
          totals.value += parseFloat(player.value) || 0;
          cellContent = formatMetricValue(player.value, metricType);
          cellStyle = 'text-align:right;font-weight:700;background:#f0fdf4';
          break;
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  });
  
  if (players.length > 0) {
    bodyHtml += '<tr style="background:#f1f5f9;font-weight:700;border-top:2px solid #cbd5e1">';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = 'padding:12px 8px;';
      
      switch(col.key) {
        case 'name':
          cellContent = 'TOTAL';
          cellStyle += 'font-weight:700;color:#1e293b';
          break;
        case 'email':
        case 'link':
        case 'vipType':
        case 'manager':
        case 'country':
          cellContent = '';
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_1d':
        case 'deposit_sum_7d':
        case 'deposit_sum_30d':
        case 'deposit_sum_90d':
          cellContent = '‚Ç¨' + totals[col.key].toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_1d':
        case 'cashout_sum_7d':
        case 'cashout_sum_30d':
        case 'cashout_sum_90d':
          cellContent = '‚Ç¨' + Math.abs(totals[col.key]).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'deposit_count_lifetime':
        case 'cashout_count_lifetime':
        case 'deposit_count_1d':
        case 'cashout_count_1d':
        case 'deposit_count_7d':
        case 'cashout_count_7d':
        case 'deposit_count_30d':
        case 'cashout_count_30d':
        case 'deposit_count_90d':
        case 'cashout_count_90d':
          cellContent = Math.round(totals[col.key]).toLocaleString();
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'inout_lifetime':
        case 'inout_1d':
        case 'inout_7d':
        case 'inout_30d':
        case 'inout_90d':
          var totalInout = totals[col.key];
          var inoutColor = totalInout >= 0 ? '#10b981' : '#ef4444';
          cellContent = '‚Ç¨' + Math.abs(totalInout).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;font-weight:700;background:#e0f2fe;color:' + inoutColor;
          break;
        case 'value':
          cellContent = formatMetricValue(totals.value, metricType);
          cellStyle += 'text-align:right;background:#e0f2fe;color:#075985';
          break;
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  }
  
  if (players.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key]; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players match current filters</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function getPeriodSuffix(period) {
  var map = {
    'lifetime': 'lifetime',
    '30': 'last_30_total',
    '30d': 'last_30_total',
    '90': 'last_90_total',
    '90d': 'last_90_total',
    '180': 'last_180_total',
    '180d': 'last_180_total',
    '365': 'last_365_total',
    '365d': 'last_365_total',
    '1': 'previous_day_total',
    '1d': 'previous_day_total',
    '7': 'last_7_total',
    '7d': 'last_7_total',
    '14': 'last_14_total',
    '14d': 'last_14_total'
  };
  return map[period] || 'lifetime';
}

function getPeriodLabel(period) {
  var map = {
    'lifetime': 'LT',
    '30d': '30d',
    '90d': '90d',
    '180d': '180d',
    '365d': '365d',
    '1d': '1d',
    '7d': '7d',
    '14d': '14d'
  };
  return map[period] || 'LT';
}

function toggleColumnSelector(event) {
  event.stopPropagation();
  var selector = document.getElementById('columnSelector');
  
  if (selector.style.display === 'none') {
    var html = '<div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:12px">Select Columns</div>';
    
    var columnGroups = [
      {title: 'Basic Info', columns: ['name', 'email', 'link', 'vipType', 'manager', 'country']},
      {title: 'Lifetime Metrics', columns: ['deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime']},
      {title: '1 Day Metrics', columns: ['deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d']},
      {title: '7 Days Metrics', columns: ['deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d']},
      {title: '30 Days Metrics', columns: ['deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d']},
      {title: '90 Days Metrics', columns: ['deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d']},
      {title: 'Current Value', columns: ['value']}
    ];
    
    var labels = {
      name: 'Player Name',
      email: 'Email',
      link: 'Link',
      vipType: 'Type',
      manager: 'Manager',
      country: 'Country',
      deposit_sum_lifetime: 'Deposit Sum (LT)',
      cashout_sum_lifetime: 'Cashout Sum (LT)',
      deposit_count_lifetime: 'Deposit Count (LT)',
      cashout_count_lifetime: 'Cashout Count (LT)',
      inout_lifetime: 'INOUT (LT)',
      deposit_sum_1d: 'Deposit Sum (1d)',
      cashout_sum_1d: 'Cashout Sum (1d)',
      deposit_count_1d: 'Deposit Count (1d)',
      cashout_count_1d: 'Cashout Count (1d)',
      inout_1d: 'INOUT (1d)',
      deposit_sum_7d: 'Deposit Sum (7d)',
      cashout_sum_7d: 'Cashout Sum (7d)',
      deposit_count_7d: 'Deposit Count (7d)',
      cashout_count_7d: 'Cashout Count (7d)',
      inout_7d: 'INOUT (7d)',
      deposit_sum_30d: 'Deposit Sum (30d)',
      cashout_sum_30d: 'Cashout Sum (30d)',
      deposit_count_30d: 'Deposit Count (30d)',
      cashout_count_30d: 'Cashout Count (30d)',
      inout_30d: 'INOUT (30d)',
      deposit_sum_90d: 'Deposit Sum (90d)',
      cashout_sum_90d: 'Cashout Sum (90d)',
      deposit_count_90d: 'Deposit Count (90d)',
      cashout_count_90d: 'Cashout Count (90d)',
      inout_90d: 'INOUT (90d)',
      value: 'Metric Value'
    };
    
    columnGroups.forEach(function(group) {
      html += '<div style="margin-bottom:16px">';
      html += '<div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">' + group.title + '</div>';
      group.columns.forEach(function(col) {
        var checked = visibleColumns[col] ? 'checked' : '';
        html += '<label style="display:block;margin:4px 0;cursor:pointer;font-size:13px">';
        html += '<input type="checkbox" ' + checked + ' onchange="toggleColumn(\'' + col + '\')" style="margin-right:6px">';
        html += labels[col];
        html += '</label>';
      });
      html += '</div>';
    });
    
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0">';
    html += '<button onclick="selectAllColumns()" style="background:#667eea;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:8px">Select All</button>';
    html += '<button onclick="deselectAllColumns()" style="background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px">Deselect All</button>';
    html += '</div>';
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    
    setTimeout(function() {
      document.addEventListener('click', closeColumnSelector);
    }, 100);
  } else {
    selector.style.display = 'none';
  }
}

function closeColumnSelector(event) {
  var selector = document.getElementById('columnSelector');
  if (selector && !selector.contains(event.target)) {
    selector.style.display = 'none';
    document.removeEventListener('click', closeColumnSelector);
  }
}

function toggleColumn(columnKey) {
  visibleColumns[columnKey] = !visibleColumns[columnKey];
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
}

function selectAllColumns() {
  Object.keys(visibleColumns).forEach(function(key) { 
    visibleColumns[key] = true; 
  });
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
  toggleColumnSelector(new Event('click'));
}

function deselectAllColumns() {
  Object.keys(visibleColumns).forEach(function(key) {
    if (['name', 'email', 'link'].includes(key)) {
      visibleColumns[key] = true;
    } else {
      visibleColumns[key] = false;
    }
  });
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
  toggleColumnSelector(new Event('click'));
}

function getActiveFilters() {
  var filters = [];
  
  if (currentManager) {
    filters.push('Manager: ' + currentManager);
  }
  
  if (vipFilters) {
    if (vipFilters.manager && vipFilters.manager.length > 0) {
      filters.push('Manager: ' + vipFilters.manager.join(', '));
    }
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filters.push('Traffic: ' + vipFilters.trafficType.join(', '));
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filters.push('Country: ' + vipFilters.country.join(', '));
    }
    if (vipFilters.currency && vipFilters.currency.length > 0) {
      filters.push('Currency: ' + vipFilters.currency.join(', '));
    }
  }
  
  if (currentPeriod && currentPeriod !== 'lifetime') {
    filters.push('Period: ' + currentPeriod);
  }
  
  if (currentVIPTab && currentVIPTab !== 'total') {
    filters.push('Tab: ' + (currentVIPTab === 'vip' ? 'VIP Only' : 'Silent VIP Only'));
  }
  
  return filters;
}

function sortMetricTable(column) {
  if (metricModalSort.column === column) {
    metricModalSort.direction = metricModalSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    metricModalSort.column = column;
    metricModalSort.direction = 'desc';
  }
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
}

function createSheetFromModal() {
  if (!currentModalPlayers || currentModalPlayers.length === 0) {
    alert('No data to export');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var metricName = modal.dataset.metricName || 'Metric Export';
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Creating...';
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  var exportData = [];
  
  var header = [];
  if (visibleColumns.name) header.push('Player');
  if (visibleColumns.email) header.push('Email');
  if (visibleColumns.link) header.push('Link');
  if (visibleColumns.vipType) header.push('Type');
  if (visibleColumns.manager) header.push('Manager');
  if (visibleColumns.country) header.push('Country');
  if (visibleColumns.deposit_sum_lifetime) header.push('Deposit Sum (LT)');
  if (visibleColumns.cashout_sum_lifetime) header.push('Cashout Sum (LT)');
  if (visibleColumns.deposit_count_lifetime) header.push('Deposit Count (LT)');
  if (visibleColumns.cashout_count_lifetime) header.push('Cashout Count (LT)');
  if (visibleColumns.deposit_sum_period) header.push('Deposit Sum (' + periodLabel + ')');
  if (visibleColumns.cashout_sum_period) header.push('Cashout Sum (' + periodLabel + ')');
  if (visibleColumns.deposit_count_period) header.push('Deposit Count (' + periodLabel + ')');
  if (visibleColumns.cashout_count_period) header.push('Cashout Count (' + periodLabel + ')');
  if (visibleColumns.value) header.push(metricName);
  
  exportData.push(header);
  
  currentModalPlayers.forEach(function(player) {
    var row = [];
    if (visibleColumns.name) row.push(player.name.trim() || 'Unknown');
    if (visibleColumns.email) row.push(player.email);
    if (visibleColumns.link) row.push(player.link || '');
    if (visibleColumns.vipType) row.push(player.vipType);
    if (visibleColumns.manager) row.push(player.manager);
    if (visibleColumns.country) row.push(player.country);
    if (visibleColumns.deposit_sum_lifetime) row.push(player.deposit_sum_lifetime || 0);
    if (visibleColumns.cashout_sum_lifetime) row.push(Math.abs(player.cashout_sum_lifetime || 0));
    if (visibleColumns.deposit_count_lifetime) row.push(player.deposit_count_lifetime || 0);
    if (visibleColumns.cashout_count_lifetime) row.push(player.cashout_count_lifetime || 0);
    if (visibleColumns.deposit_sum_period) row.push(player.deposit_sum_period || 0);
    if (visibleColumns.cashout_sum_period) row.push(Math.abs(player.cashout_sum_period || 0));
    if (visibleColumns.deposit_count_period) row.push(player.deposit_count_period || 0);
    if (visibleColumns.cashout_count_period) row.push(player.cashout_count_period || 0);
    if (visibleColumns.value) row.push(player.value);
    
    exportData.push(row);
  });
  
  google.script.run
    .withSuccessHandler(function(url) {
      btn.disabled = false;
      btn.textContent = '‚úÖ Sheet Created!';
      
      if (url) {
        window.open(url, '_blank');
      }
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .withFailureHandler(function(error) {
      btn.disabled = false;
      btn.textContent = '‚ùå Error';
      alert('Failed to create sheet: ' + error.message);
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .createExportSheet(metricName, exportData);
}

function openPieModal(metricId, metricName, segmentName) {
  console.log('Opening pie modal:', metricId, metricName, segmentName);
  
  if (!vipAllPlayers) {
    alert('Player data not loaded yet');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var title = document.getElementById('metricModalTitle');
  var body = document.getElementById('metricModalBody');
  
  title.textContent = metricName + ' - ' + segmentName;
  
  var activeFilters = getActiveFilters();
  
  var html = '';
  
  if (activeFilters.length > 0) {
    html += '<div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px 16px;margin-bottom:20px">';
    html += '<div style="font-size:13px;font-weight:600;color:#1e40af;margin-bottom:6px">üîç Applied Filters:</div>';
    html += '<div style="font-size:12px;color:#1e40af">' + activeFilters.join(' ‚Ä¢ ') + '</div>';
    html += '</div>';
  }
  
  html += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:20px">';
  html += '<h3 style="font-size:16px;font-weight:700;color:#1e293b;margin:0 0 8px 0">Segment: ' + segmentName + '</h3>';
  html += '<div style="font-size:14px;color:#64748b">Showing players in this segment</div>';
  html += '</div>';
  
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">';
  html += '<div style="position:relative">';
  html += '<button onclick="toggleColumnSelector(event)" style="background:#667eea;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üëÅÔ∏è Columns</button>';
  html += '<div id="columnSelector" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:200px;z-index:1000"></div>';
  html += '</div>';
  html += '<button onclick="createSheetFromPieModal()" style="background:#10b981;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üìä Create Sheet</button>';
  html += '</div>';
  
  html += '<h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:24px 0 16px 0">üìã Players in this segment</h3>';
  html += '<div class="metric-table-container" style="overflow-x:auto;max-height:500px">';
  html += '<table class="metric-table" id="modalTable" style="width:100%;min-width:1800px">';
  html += '<thead style="position:sticky;top:0;background:#fff;z-index:10"><tr id="modalTableHeader"></tr></thead>';
  html += '<tbody id="metricTableBody"></tbody>';
  html += '</table>';
  html += '</div>';
  
  body.innerHTML = html;
  
  modal.dataset.metricId = metricId;
  modal.dataset.metricName = metricName + ' - ' + segmentName;
  modal.dataset.segmentName = segmentName;
  modal.dataset.isPie = 'true';
  
  renderPieSegmentPlayers(metricId, segmentName);
  
  modal.style.display = 'flex';
}

function renderPieSegmentPlayers(metricId, segmentName) {
  var tbody = document.getElementById('metricTableBody');
  var thead = document.getElementById('modalTableHeader');
  if (!tbody || !thead) return;
  
  var periodSuffix = getPeriodSuffix(currentPeriod);
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (currentVIPTab === 'vip') {
    filteredSilent = [];
  } else if (currentVIPTab === 'silent-vip') {
    filteredVip = [];
  }
  
  var allPlayers = [];
  filteredVip.forEach(function(p) { 
    var playerCopy = {};
    for (var key in p) playerCopy[key] = p[key];
    playerCopy.vipType = 'VIP';
    allPlayers.push(playerCopy);
  });
  filteredSilent.forEach(function(p) { 
    var playerCopy = {};
    for (var key in p) playerCopy[key] = p[key];
    playerCopy.vipType = 'Silent VIP';
    allPlayers.push(playerCopy);
  });
  
  var segmentPlayers = allPlayers.filter(function(player) {
    var playerValue = player[metricId];
    return String(playerValue) === String(segmentName);
  });
  
  currentModalPlayers = segmentPlayers.map(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    return {
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: player.vipType,
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      deposit_sum_lifetime: player.deposit_sum_lifetime || 0,
      cashout_sum_lifetime: player.cashout_sum_lifetime || 0,
      deposit_count_lifetime: player.deposit_count_lifetime || 0,
      cashout_count_lifetime: player.cashout_count_lifetime || 0,
      deposit_sum_period: player['deposit_sum_' + periodSuffix] || 0,
      cashout_sum_period: player['cashout_sum_' + periodSuffix] || 0,
      deposit_count_period: player['deposit_count_' + periodSuffix] || 0,
      cashout_count_period: player['cashout_count_' + periodSuffix] || 0,
      rawPlayer: player  // Store original player object with all data
    };
  });
  
  var periodLabel = getPeriodLabel(currentPeriod);
  var headerHtml = '';
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    {key: 'deposit_sum_lifetime', label: 'Dep Sum (LT)', width: '140px'},
    {key: 'cashout_sum_lifetime', label: 'Cash Sum (LT)', width: '140px'},
    {key: 'deposit_count_lifetime', label: 'Dep Count (LT)', width: '140px'},
    {key: 'cashout_count_lifetime', label: 'Cash Count (LT)', width: '140px'},
    {key: 'deposit_sum_period', label: 'Dep Sum (' + periodLabel + ')', width: '140px'},
    {key: 'cashout_sum_period', label: 'Cash Sum (' + periodLabel + ')', width: '140px'},
    {key: 'deposit_count_period', label: 'Dep Count (' + periodLabel + ')', width: '140px'},
    {key: 'cashout_count_period', label: 'Cash Count (' + periodLabel + ')', width: '140px'}
  ];
  
  columns.forEach(function(col) {
    if (visibleColumns[col.key]) {
      headerHtml += '<th style="min-width:' + col.width + '">' + col.label + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var bodyHtml = '';
  currentModalPlayers.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = '';
      
      switch(col.key) {
        case 'name':
          cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
          cellStyle = 'font-weight:600';
          break;
        case 'email':
          cellContent = player.email;
          cellStyle = 'font-size:12px;color:#64748b';
          break;
        case 'link':
          if (player.link) {
            cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
          } else {
            cellContent = '‚Äî';
          }
          break;
        case 'vipType':
          var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
          var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
          cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
          break;
        case 'manager':
          cellContent = player.manager;
          break;
        case 'country':
          cellContent = player.country;
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_period':
          cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_period':
          cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        default:
          cellContent = (player[col.key] || 0).toLocaleString();
          cellStyle = 'text-align:right';
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  });
  
  if (currentModalPlayers.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key]; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players in this segment</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function createSheetFromPieModal() {
  if (!currentModalPlayers || currentModalPlayers.length === 0) {
    alert('No data to export');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var metricName = modal.dataset.metricName || 'Pie Export';
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Creating...';
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  var exportData = [];
  
  var header = [];
  if (visibleColumns.name) header.push('Player');
  if (visibleColumns.email) header.push('Email');
  if (visibleColumns.link) header.push('Link');
  if (visibleColumns.vipType) header.push('Type');
  if (visibleColumns.manager) header.push('Manager');
  if (visibleColumns.country) header.push('Country');
  if (visibleColumns.deposit_sum_lifetime) header.push('Deposit Sum (LT)');
  if (visibleColumns.cashout_sum_lifetime) header.push('Cashout Sum (LT)');
  if (visibleColumns.deposit_count_lifetime) header.push('Deposit Count (LT)');
  if (visibleColumns.cashout_count_lifetime) header.push('Cashout Count (LT)');
  if (visibleColumns.deposit_sum_period) header.push('Deposit Sum (' + periodLabel + ')');
  if (visibleColumns.cashout_sum_period) header.push('Cashout Sum (' + periodLabel + ')');
  if (visibleColumns.deposit_count_period) header.push('Deposit Count (' + periodLabel + ')');
  if (visibleColumns.cashout_count_period) header.push('Cashout Count (' + periodLabel + ')');
  
  exportData.push(header);
  
  currentModalPlayers.forEach(function(player) {
    var row = [];
    if (visibleColumns.name) row.push(player.name.trim() || 'Unknown');
    if (visibleColumns.email) row.push(player.email);
    if (visibleColumns.link) row.push(player.link || '');
    if (visibleColumns.vipType) row.push(player.vipType);
    if (visibleColumns.manager) row.push(player.manager);
    if (visibleColumns.country) row.push(player.country);
    if (visibleColumns.deposit_sum_lifetime) row.push(player.deposit_sum_lifetime || 0);
    if (visibleColumns.cashout_sum_lifetime) row.push(Math.abs(player.cashout_sum_lifetime || 0));
    if (visibleColumns.deposit_count_lifetime) row.push(player.deposit_count_lifetime || 0);
    if (visibleColumns.cashout_count_lifetime) row.push(player.cashout_count_lifetime || 0);
    if (visibleColumns.deposit_sum_period) row.push(player.deposit_sum_period || 0);
    if (visibleColumns.cashout_sum_period) row.push(Math.abs(player.cashout_sum_period || 0));
    if (visibleColumns.deposit_count_period) row.push(player.deposit_count_period || 0);
    if (visibleColumns.cashout_count_period) row.push(player.cashout_count_period || 0);
    
    exportData.push(row);
  });
  
  google.script.run
    .withSuccessHandler(function(url) {
      btn.disabled = false;
      btn.textContent = '‚úÖ Sheet Created!';
      
      if (url) {
        window.open(url, '_blank');
      }
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .withFailureHandler(function(error) {
      btn.disabled = false;
      btn.textContent = '‚ùå Error';
      alert('Failed to create sheet: ' + error.message);
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .createExportSheet(metricName, exportData);
}

function handlePieClickWrapper(evt) {
  var canvas = evt.target;
  var metricId = canvas.getAttribute('data-metric-id');
  var metricName = canvas.getAttribute('data-metric-name');
  handlePieClick(evt, metricId, metricName);
}

function handlePieClick(evt, metricId, metricName) {
  var canvas = evt.target;
  var chart = Chart.getChart(canvas);
  
  if (!chart) return;
  
  var points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
  
  if (points.length > 0) {
    var firstPoint = points[0];
    var label = chart.data.labels[firstPoint.index];
    
    console.log('Clicked pie segment:', label);
    openPieModal(metricId, metricName, label);
  }
}

function closeMetricModal() {
  var modal = document.getElementById('metricModal');
  modal.style.display = 'none';
  metricModalSort = {column: null, direction: 'desc'};
  currentModalPlayers = [];
}


function hideLoader(){const loader=document.getElementById('top-loader');loader.classList.remove('loading')}

function deduplicatePlayers(players){const seen=new Map();players.forEach(p=>{if(!seen.has(p.id)){seen.set(p.id,p)}});return Array.from(seen.values())}

function renderModalContent(data){
  console.log('üìä renderModalContent called with data:', data);
  console.log('  - data.achieved:', data.achieved ? data.achieved.length : 'undefined');
  console.log('  - data.dropped:', data.dropped ? data.dropped.length : 'undefined');
  console.log('  - data.totalAchieved:', data.totalAchieved);
  console.log('  - data.totalDropped:', data.totalDropped);
  
  const achievedUnique=deduplicatePlayers(data.achieved||[]);
  const droppedUnique=deduplicatePlayers(data.dropped||[]);
  
  console.log('  - achievedUnique:', achievedUnique.length);
  console.log('  - droppedUnique:', droppedUnique.length);
  
  if (droppedUnique.length > 0) {
    console.log('  - First dropped player:', droppedUnique[0]);
  } else {
    console.log('  - ‚ö†Ô∏è No dropped players!');
  }
  
  const hasFilters=data.totalAchieved!==achievedUnique.length||data.totalDropped!==droppedUnique.length;let html='<div class="analytics-section"><div class="analytics-title">üìä Analytics'+(hasFilters?' (Filtered)':'')+'</div><div class="pies-grid">';const allPlayers=[...achievedUnique,...droppedUnique];if(allPlayers.length>0){html+=createPieCard('Countries','c1',groupBy(allPlayers,p=>p.country||'Unknown'));html+=createPieCard('Status','c2',groupBy(allPlayers,p=>(p.status==='none'||!p.status)?'Active':'Disabled'));html+=createPieCard('Achievement','c3',[{label:'Achieved',value:achievedUnique.length},{label:'Dropped',value:droppedUnique.length}])}html+='</div></div>';html+='<div class="players-section"><div class="section-header"><div class="section-title">‚úÖ Achieved</div><div class="section-count">'+achievedUnique.length+(hasFilters?' / '+data.totalAchieved:'')+'</div></div>';if(achievedUnique.length>0){html+='<div class="players-list"><div class="player-row" style="font-weight:700;background:#f8fafc;border-bottom:2px solid #667eea"><div>Email</div><div>Country</div><div>Status</div><div>Link</div><div>Manager</div><div>Type</div></div>';achievedUnique.forEach(p=>{const email=p.email||p.id||'N/A';html+='<div class="player-row"><div class="player-email" onclick="copyToClipboard(escapeHtml(email))">' + escapeHtml(email) + '<span class="copy-icon">üìã</span></div><div>' + escapeHtml(p.country||'N/A') + '</div><div style="font-size:11px">' + escapeHtml(String(p.status||'none').toLowerCase()==='none'?'active':p.status) + '</div><div><a href="' + createBackofficeLink(p.id) + '" target="_blank" class="player-link">Open</a></div><div>' + escapeHtml(getManager(p.tags)||'-') + '</div><div style="font-size:11px;color:#64748b">' + escapeHtml(p.trafficType||'-') + '</div></div>'});html+='</div>'}else{html+='<div style="padding:20px;text-align:center;color:#64748b">No players</div>'}html+='</div>';html+='<div class="players-section"><div class="section-header"><div class="section-title">‚ùå Dropped</div><div class="section-count">'+droppedUnique.length+(hasFilters?' / '+data.totalDropped:'')+'</div></div>';if(droppedUnique.length>0){html+='<div class="players-list"><div class="player-row" style="font-weight:700;background:#fef2f2;border-bottom:2px solid #ef4444"><div>Email</div><div>Country</div><div>Status</div><div>Link</div><div>Manager</div><div>Type</div></div>';droppedUnique.forEach(p=>{const email=p.email||p.id||'N/A';html+='<div class="player-row"><div class="player-email" onclick="copyToClipboard(escapeHtml(email))">' + escapeHtml(email) + '<span class="copy-icon">üìã</span></div><div>' + escapeHtml(p.country||'N/A') + '</div><div style="font-size:11px">' + escapeHtml(String(p.status||'none').toLowerCase()==='none'?'active':p.status) + '</div><div><a href="' + createBackofficeLink(p.id) + '" target="_blank" class="player-link">Open</a></div><div>' + escapeHtml(getManager(p.tags)||'-') + '</div><div style="font-size:11px;color:#64748b">' + escapeHtml(p.trafficType||'-') + '</div></div>'});html+='</div>'}else{html+='<div style="padding:20px;text-align:center;color:#64748b">All achieved!</div>'}html+='</div>';document.getElementById('modalBody').innerHTML=html;setTimeout(()=>{if(allPlayers.length>0){try{renderPieChart('c1',groupBy(allPlayers,p=>p.country||'Unknown'));renderPieChart('c2',groupBy(allPlayers,p=>(p.status==='none'||!p.status)?'Active':'Disabled'));renderPieChart('c3',[{label:'Achieved',value:achievedUnique.length},{label:'Dropped',value:droppedUnique.length}])}catch(e){console.error('Error rendering pie charts:',e)}}},100)}

function createPieCard(title,id,data){return'<div class="pie-card"><div class="pie-chart"><canvas id="' + id + '"></canvas></div><div class="pie-legend"><div style="font-weight:700;margin-bottom:10px;color:#1e293b;font-size:14px">' + title + '</div><div id="' + id + 'Legend"></div></div></div>'}

function groupBy(arr,fn){const map={};arr.forEach(item=>{const key=fn(item)||'Unknown';map[key]=(map[key]||0)+1});return Object.keys(map).map(label=>({label,value:map[label]})).sort((a,b)=>b.value-a.value)}

function renderPieChart(id,data){
  try{
    console.log('üé® Rendering pie chart:', id, 'with data:', data);
    const canvas=document.getElementById(id);
    if(!canvas||!data||data.length===0){
      console.log('‚ö†Ô∏è Cannot render pie chart - missing canvas or data');
      return;
    }
    const ctx=canvas.getContext('2d');
    if(!ctx)return;
    if(typeof Chart==='undefined'){
      console.error('Chart.js not loaded');
      return;
    }
    
    const labels=data.map(d=>d.label);
    const values=data.map(d=>d.value);
    const colors=data.map((_,i)=>pieColors[i%pieColors.length]);
    
    var chartInstance = new Chart(ctx,{
      type:'doughnut',
      data:{
        labels,
        datasets:[{
          data:values,
          backgroundColor:colors,
          borderColor:'#fff',
          borderWidth:3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:true,
        onClick: function(event, activeElements) {
          console.log('üñ±Ô∏è Chart clicked! Active elements:', activeElements.length);
          if (activeElements.length > 0) {
            var index = activeElements[0].index;
            var selectedLabel = labels[index];
            console.log('üìä Pie segment clicked:', selectedLabel, 'at index:', index);
            
            // Use the scroll function
            scrollToRetentionSection(selectedLabel);
          } else {
            console.log('‚ö†Ô∏è No active element clicked');
          }
        },
        plugins:{
          legend:{display:false},
          datalabels:{display:false},
          tooltip:{
            callbacks:{
              label: function(context) {
                var label = context.label || '';
                var value = context.parsed;
                var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                var percentage = ((value / total) * 100).toFixed(1);
                return ' ' + label + ': ' + value + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
    
    console.log('‚úÖ Pie chart created:', id);
    
    const legendEl=document.getElementById(id+'Legend');
    if(legendEl){
      let html='';
      data.forEach((d,i)=>{
        var escapedLabel = d.label.replace(/'/g, "\\'");
        html+='<div class="legend-item" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'rgba(102,126,234,0.1)\'" onmouseout="this.style.background=\'\'" onclick="console.log(\'Legend clicked:\',\'' + escapedLabel + '\');scrollToRetentionSection(\'' + escapedLabel + '\')">';
        html+='<div class="legend-dot" style="background:' + colors[i] + '"></div>';
        html+='<div style="flex:1;font-size:12px;font-weight:500">' + escapeHtml(d.label) + '</div>';
        html+='<div style="font-weight:800;font-size:13px;color:#667eea">' + d.value + '</div>';
        html+='</div>';
      });
      legendEl.innerHTML=html;
      console.log('‚úÖ Legend created for:', id);
    }
  }catch(e){
    console.error('‚ùå renderPieChart error:',e);
  }
}

function scrollToRetentionSection(sectionName) {
  console.log('üìç scrollToRetentionSection called with:', sectionName);
  
  // Wait for modal content to be rendered
  setTimeout(function() {
    // Try multiple selectors
    var selectors = [
      '.section-title',
      '.section-header .section-title',
      '[class*="section-title"]'
    ];
    
    var found = false;
    
    for (var s = 0; s < selectors.length; s++) {
      var sections = document.querySelectorAll(selectors[s]);
      console.log('üîç Trying selector:', selectors[s], 'found:', sections.length, 'sections');
      
      if (sections.length > 0) {
        for (var i = 0; i < sections.length; i++) {
          var text = sections[i].textContent || sections[i].innerText;
          console.log('  Section', i, ':', text);
          
          if (text.includes(sectionName)) {
            console.log('  ‚úÖ Match found! Scrolling...');
            found = true;
            
            // Get the parent section
            var section = sections[i].closest('.players-section') || sections[i].parentElement.parentElement;
            
            if (section) {
              // Scroll to section
              section.scrollIntoView({behavior: 'smooth', block: 'start'});
              
              // Highlight the section briefly
              var originalBg = section.style.background || '';
              section.style.transition = 'background 0.3s';
              section.style.background = 'rgba(102, 126, 234, 0.1)';
              setTimeout(function() {
                section.style.background = originalBg;
              }, 1500);
            }
            break;
          }
        }
        if (found) break;
      }
    }
    
    if (!found) {
      console.log('‚ùå Section not found:', sectionName);
      console.log('Available sections:', document.querySelectorAll('.section-title'));
    }
  }, 200); // Wait 200ms for modal to render
}

document.getElementById('btnCreateSheet').onclick=()=>{if(!currentFilteredData)return;const btn=document.getElementById('btnCreateSheet');btn.disabled=true;btn.textContent='‚è≥ Creating...';const achievedUnique=deduplicatePlayers(currentFilteredData.achieved||[]);const droppedUnique=deduplicatePlayers(currentFilteredData.dropped||[]);google.script.run.withSuccessHandler(result=>{btn.disabled=false;btn.textContent='‚úÖ Created!';setTimeout(()=>btn.textContent='üìÑ Create Sheet',2000);if(result.url)window.open(result.url,'_blank')}).withFailureHandler(err=>{btn.disabled=false;btn.textContent='‚ùå Error';alert('Error: '+err);setTimeout(()=>btn.textContent='üìÑ Create Sheet',2000)}).createPlayersSheet({title:currentModalData.month + ' ' + currentModalData.range,achieved:achievedUnique,dropped:droppedUnique})};

function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}

function initCompareView(){
  if(!kpiDataByTab||Object.keys(kpiDataByTab).length===0)return;
  
  const tabs=Object.keys(kpiDataByTab);
  const dropdown1=document.getElementById('compareTab1');
  const dropdown2=document.getElementById('compareTab2');
  
  dropdown1.innerHTML='';
  dropdown2.innerHTML='';
  
  tabs.forEach(tab=>{
    const opt1=document.createElement('option');
    opt1.value=tab;
    opt1.textContent=tab;
    dropdown1.appendChild(opt1);
    
    const opt2=document.createElement('option');
    opt2.value=tab;
    opt2.textContent=tab;
    dropdown2.appendChild(opt2);
  });
  
  compareTab1=tabs[0]||'';
  compareTab2=tabs[1]||tabs[0]||'';
  dropdown1.value=compareTab1;
  dropdown2.value=compareTab2;
  
  renderCompareMetrics();
  renderCompareData();
}

function renderCompareMetrics(){
  if(!kpiDataByTab||!compareTab1)return;
  
  const data1=kpiDataByTab[compareTab1];
  if(!data1||!data1.metrics)return;
  
  const container=document.getElementById('compareMetrics');
  container.innerHTML='';
  
  const metrics=data1.metrics.slice(0,20);
  metrics.forEach((m,i)=>{
    const btn=document.createElement('button');
    btn.className='metric-btn'+(i===0&&!compareCurrentMetric?' active':'')+(m===compareCurrentMetric?' active':'');
    btn.textContent=m;
    btn.onclick=()=>{
      compareCurrentMetric=m;
      document.querySelectorAll('#compareMetrics .metric-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderCompareChart();
      renderCompareTable();
      document.getElementById('compareMetricDisplay').style.display='block';
      document.getElementById('compareMetricName').textContent=m;
    };
    container.appendChild(btn);
  });
  
  if(!compareCurrentMetric&&metrics.length>0){
    compareCurrentMetric=metrics[0];
    document.getElementById('compareMetricDisplay').style.display='block';
    document.getElementById('compareMetricName').textContent=metrics[0];
  }
}

function renderCompareData(){
  compareTab1=document.getElementById('compareTab1').value;
  compareTab2=document.getElementById('compareTab2').value;
  renderCompareMetrics();
  renderCompareChart();
  renderCompareTable();
}

function renderCompareChart(){
  if(!compareCurrentMetric||!compareTab1||!compareTab2)return;
  if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}
  
  const data1=kpiDataByTab[compareTab1];
  const data2=kpiDataByTab[compareTab2];
  if(!data1||!data2)return;
  
  const ctx=document.getElementById('compareChart').getContext('2d');
  const labels=[];
  const values1=[];
  const values2=[];
  
  data1.months.forEach(m=>{
    labels.push(m.label);
    const val1=m.monthly[compareCurrentMetric]||m.sumWeeks[compareCurrentMetric]||0;
    values1.push(val1);
  });
  
  data2.months.forEach((m,i)=>{
    const val2=m.monthly[compareCurrentMetric]||m.sumWeeks[compareCurrentMetric]||0;
    if(values2.length<data1.months.length){
      values2.push(val2);
    }
  });
  
  while(values2.length<values1.length){
    values2.push(0);
  }
  
  const config={
    type:'bar',
    data:{
      labels,
      datasets:[
        {
          label:compareTab1,
          data:values1,
          backgroundColor:'#667eea',
          borderRadius:8,
          barPercentage:0.6
        },
        {
          label:compareTab2,
          data:values2,
          backgroundColor:'#764ba2',
          borderRadius:8,
          barPercentage:0.6
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:30,bottom:10}},
      plugins:{
        legend:{display:true,position:'top'},
        datalabels:{
          anchor:'end',
          align:'end',
          color:'#1e293b',
          font:{weight:'bold',size:10},
          formatter:(v)=>formatKpiValue(compareCurrentMetric,v)
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grace:'10%',
          grid:{color:'#f1f5f9'},
          ticks:{
            font:{weight:'600'},
            color:'#64748b',
            callback:(v)=>formatKpiValue(compareCurrentMetric,v)
          }
        },
        x:{
          grid:{display:false},
          ticks:{font:{weight:'600',size:10},color:'#64748b'}
        }
      }
    }
  };
  
  if(compareChart)compareChart.destroy();
  compareChart=new Chart(ctx,config);
}

function renderCompareTable(){
  if(!compareCurrentMetric||!compareTab1||!compareTab2)return;
  
  const data1=kpiDataByTab[compareTab1];
  const data2=kpiDataByTab[compareTab2];
  if(!data1||!data2)return;
  
  const table=document.getElementById('compare-table');
  let html='<thead><tr><th>Period</th><th>'+escapeHtml(compareTab1)+'</th><th>'+escapeHtml(compareTab2)+'</th><th>Difference</th></tr></thead><tbody>';
  
  data1.months.forEach((m1,i)=>{
    const val1=m1.monthly[compareCurrentMetric]||m1.sumWeeks[compareCurrentMetric]||0;
    const m2=data2.months[i];
    const val2=m2?(m2.monthly[compareCurrentMetric]||m2.sumWeeks[compareCurrentMetric]||0):0;
    const diff=val1-val2;
    const diffPct=val2>0?(diff/val2)*100:0;
    const diffColor=diff>0?'#10b981':diff<0?'#ef4444':'#64748b';
    
    html+='<tr>';
    html+='<td style="font-weight:700;color:#667eea">'+escapeHtml(m1.label)+'</td>';
    html+='<td style="font-weight:700">'+formatKpiValue(compareCurrentMetric,val1)+'</td>';
    html+='<td style="font-weight:700">'+formatKpiValue(compareCurrentMetric,val2)+'</td>';
    html+='<td style="font-weight:700;color:'+diffColor+'">';
    html+=(diff>0?'+':'')+formatKpiValue(compareCurrentMetric,diff);
    html+=' ('+diffPct.toFixed(1)+'%)</td>';
    html+='</tr>';
  });
  
  html+='</tbody>';
  table.innerHTML=html;
}

let currentPieMetricId = null;
let currentPieMetricName = null;
let currentPieFilter = null;
let pieChartInstance = null;
let pieSortColumn = null;
let pieSortDirection = 'desc';

function openPieChartModal(metricId, metricName) {
  currentPieMetricId = metricId;
  currentPieMetricName = metricName;
  currentPieFilter = null;
  
  var modal = document.getElementById('pieChartModal');
  var title = document.getElementById('pieChartModalTitle');
  
  title.textContent = metricName;
  modal.style.display = 'flex';
  
  renderPieChartInModal();
  renderPieModalTable();
}

function closePieChartModal() {
  var modal = document.getElementById('pieChartModal');
  modal.style.display = 'none';
  
  if (pieChartInstance) {
    pieChartInstance.destroy();
    pieChartInstance = null;
  }
  
  currentPieMetricId = null;
  currentPieMetricName = null;
  currentPieFilter = null;
}

function renderPieChartInModal() {
  if (!vipData || !vipData.metrics || !vipData.metrics.pies) return;
  
  var pieData = vipData.metrics.pies[currentPieMetricId];
  if (!pieData) return;
  
  var distribution = null;
  if (currentVIPTab === 'total') {
    distribution = pieData.total;
  } else if (currentVIPTab === 'vip') {
    distribution = pieData.vip;
  } else {
    distribution = pieData.silentVip;
  }
  
  if (!distribution || Object.keys(distribution).length === 0) return;
  
  function improveLabel(label) {
    var labelStr = String(label).trim();
    if (currentPieMetricName.toLowerCase().includes('gender')) {
      if (labelStr.toLowerCase() === 'm' || labelStr.toLowerCase() === 'male') return 'Male';
      if (labelStr.toLowerCase() === 'f' || labelStr.toLowerCase() === 'female') return 'Female';
    }
    if (labelStr === '' || labelStr === 'null' || labelStr === 'undefined') return 'Unknown';
    return labelStr;
  }
  
  var improvedDist = {};
  Object.keys(distribution).forEach(function(key) {
    var improvedKey = improveLabel(key);
    improvedDist[improvedKey] = (improvedDist[improvedKey] || 0) + distribution[key];
  });
  
  var sortedEntries = Object.entries(improvedDist).sort(function(a, b) { return b[1] - a[1]; });
  var labels = sortedEntries.map(function(e) { return e[0]; });
  var values = sortedEntries.map(function(e) { return e[1]; });
  
  var colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140', '#30cfd0', '#330867', '#a8edea', '#fed6e3', '#ff9a9e', '#fecfef'];
  
  var canvas = document.getElementById('pieChartModalCanvas');
  var ctx = canvas.getContext('2d');
  
  if (pieChartInstance) {
    pieChartInstance.destroy();
  }
  
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      onClick: function(event, activeElements) {
        if (activeElements.length > 0) {
          var index = activeElements[0].index;
          var selectedLabel = labels[index];
          currentPieFilter = selectedLabel;
          renderPieModalTable();
        } else {
          currentPieFilter = null;
          renderPieModalTable();
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 },
            generateLabels: function(chart) {
              var data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map(function(label, i) {
                  var value = data.datasets[0].data[i];
                  var total = data.datasets[0].data.reduce(function(a, b) { return a + b; }, 0);
                  var percentage = ((value / total) * 100).toFixed(1);
                  return {
                    text: label + ': ' + value + ' (' + percentage + '%)',
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var label = context.label || '';
              var value = context.parsed;
              var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
              var percentage = ((value / total) * 100).toFixed(1);
              return ' ' + label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

function renderPieModalTable() {
  var tbody = document.getElementById('pieModalTableBody');
  var thead = document.getElementById('pieModalTableHeader');
  if (!tbody || !thead) return;
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (vipFilters) {
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filteredVip = filteredVip.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
      filteredSilent = filteredSilent.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
    }
  }
  
  if (currentPieFilter) {
    var filterField = currentPieMetricId;
    filteredVip = filteredVip.filter(function(p) {
      var value = String(p[filterField] || '').trim();
      if (value === '' || value === 'null' || value === 'undefined') value = 'Unknown';
      return value === currentPieFilter;
    });
    filteredSilent = filteredSilent.filter(function(p) {
      var value = String(p[filterField] || '').trim();
      if (value === '' || value === 'null' || value === 'undefined') value = 'Unknown';
      return value === currentPieFilter;
    });
  }
  
  var filterIndicator = document.getElementById('pieFilterIndicator');
  if (filterIndicator) {
    if (currentPieFilter) {
      filterIndicator.innerHTML = '<span style="background:#667eea;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;margin-right:8px">Filter: ' + currentPieFilter + '</span>';
    } else {
      filterIndicator.innerHTML = '';
    }
  }
  
  var players = [];
  
  filteredVip.forEach(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      filterValue: player[currentPieMetricId] || '‚Äî',
      rawPlayer: player
    });
  });
  
  filteredSilent.forEach(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'Silent VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      filterValue: player[currentPieMetricId] || '‚Äî',
      rawPlayer: player
    });
  });
  
  if (pieSortColumn) {
    players.sort(function(a, b) {
      var valA = a[pieSortColumn];
      var valB = b[pieSortColumn];
      
      var numericCols = ['deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime',
        'deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d',
        'deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d',
        'deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d',
        'deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d'];
      
      if (numericCols.includes(pieSortColumn)) {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      } else {
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
      }
      
      if (valA < valB) return pieSortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return pieSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    {key: 'filterValue', label: currentPieMetricName, width: '120px'},
    
    {key: 'deposit_sum_lifetime', label: 'Dep Sum (LT)', width: '140px'},
    {key: 'cashout_sum_lifetime', label: 'Cash Sum (LT)', width: '140px'},
    {key: 'deposit_count_lifetime', label: 'Dep Count (LT)', width: '140px'},
    {key: 'cashout_count_lifetime', label: 'Cash Count (LT)', width: '140px'},
    {key: 'inout_lifetime', label: 'INOUT (LT)', width: '140px'},
    
    {key: 'deposit_sum_1d', label: 'Dep Sum (1d)', width: '140px'},
    {key: 'cashout_sum_1d', label: 'Cash Sum (1d)', width: '140px'},
    {key: 'deposit_count_1d', label: 'Dep Count (1d)', width: '140px'},
    {key: 'cashout_count_1d', label: 'Cash Count (1d)', width: '140px'},
    {key: 'inout_1d', label: 'INOUT (1d)', width: '140px'},
    
    {key: 'deposit_sum_7d', label: 'Dep Sum (7d)', width: '140px'},
    {key: 'cashout_sum_7d', label: 'Cash Sum (7d)', width: '140px'},
    {key: 'deposit_count_7d', label: 'Dep Count (7d)', width: '140px'},
    {key: 'cashout_count_7d', label: 'Cash Count (7d)', width: '140px'},
    {key: 'inout_7d', label: 'INOUT (7d)', width: '140px'},
    
    {key: 'deposit_sum_30d', label: 'Dep Sum (30d)', width: '140px'},
    {key: 'cashout_sum_30d', label: 'Cash Sum (30d)', width: '140px'},
    {key: 'deposit_count_30d', label: 'Dep Count (30d)', width: '140px'},
    {key: 'cashout_count_30d', label: 'Cash Count (30d)', width: '140px'},
    {key: 'inout_30d', label: 'INOUT (30d)', width: '140px'},
    
    {key: 'deposit_sum_90d', label: 'Dep Sum (90d)', width: '140px'},
    {key: 'cashout_sum_90d', label: 'Cash Sum (90d)', width: '140px'},
    {key: 'deposit_count_90d', label: 'Dep Count (90d)', width: '140px'},
    {key: 'cashout_count_90d', label: 'Cash Count (90d)', width: '140px'},
    {key: 'inout_90d', label: 'INOUT (90d)', width: '140px'}
  ];
  
  var headerHtml = '';
  columns.forEach(function(col) {
    if (visibleColumns[col.key] !== false) {
      var sortIndicator = pieSortColumn === col.key ? (pieSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      var clickHandler = col.key !== 'link' ? 'onclick="sortPieTable(\'' + col.key + '\')"' : '';
      var cursorStyle = col.key !== 'link' ? 'cursor:pointer;' : '';
      var bgColor = col.key === 'filterValue' ? 'background:#f0fdf4;' : '';
      headerHtml += '<th ' + clickHandler + ' style="min-width:' + col.width + ';' + cursorStyle + bgColor + '">' + col.label + ' ' + sortIndicator + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var bodyHtml = '';
  players.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (visibleColumns[col.key] !== false) {
        var cellContent = '';
        var cellStyle = '';
        
        switch(col.key) {
          case 'name':
            cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
            cellStyle = 'font-weight:600';
            break;
          case 'email':
            cellContent = player.email;
            cellStyle = 'font-size:12px;color:#64748b';
            break;
          case 'link':
            if (player.link) {
              cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
            } else {
              cellContent = '‚Äî';
            }
            break;
          case 'vipType':
            var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
            var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
            cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
            break;
          case 'manager':
            cellContent = player.manager;
            break;
          case 'country':
            cellContent = player.country;
            break;
          case 'filterValue':
            cellContent = player.filterValue;
            cellStyle = 'font-weight:600;background:#f0fdf4';
            break;
          case 'deposit_sum_lifetime':
          case 'deposit_sum_1d':
          case 'deposit_sum_7d':
          case 'deposit_sum_30d':
          case 'deposit_sum_90d':
            cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right';
            break;
          case 'cashout_sum_lifetime':
          case 'cashout_sum_1d':
          case 'cashout_sum_7d':
          case 'cashout_sum_30d':
          case 'cashout_sum_90d':
            cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right';
            break;
          case 'deposit_count_lifetime':
          case 'cashout_count_lifetime':
          case 'deposit_count_1d':
          case 'cashout_count_1d':
          case 'deposit_count_7d':
          case 'cashout_count_7d':
          case 'deposit_count_30d':
          case 'cashout_count_30d':
          case 'deposit_count_90d':
          case 'cashout_count_90d':
            cellContent = (player[col.key] || 0).toLocaleString();
            cellStyle = 'text-align:right';
            break;
          case 'inout_lifetime':
          case 'inout_1d':
          case 'inout_7d':
          case 'inout_30d':
          case 'inout_90d':
            var inoutValue = player[col.key] || 0;
            var inoutColor = inoutValue >= 0 ? '#10b981' : '#ef4444';
            cellContent = '‚Ç¨' + Math.abs(inoutValue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right;font-weight:700;color:' + inoutColor + ';background:#f0fdf4';
            break;
        }
        
        bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
      }
    });
    
    bodyHtml += '</tr>';
  });
  
  if (players.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key] !== false; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players match current filter</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function sortPieTable(column) {
  if (pieSortColumn === column) {
    pieSortDirection = pieSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    pieSortColumn = column;
    pieSortDirection = 'desc';
  }
  renderPieModalTable();
}

function togglePieColumnSelector(event) {
  event.stopPropagation();
  var selector = document.getElementById('pieColumnSelector');
  
  if (selector.style.display === 'none') {
    selector.innerHTML = '<div style="font-size:13px;color:#64748b">Column selection coming soon...</div>';
    selector.style.display = 'block';
    
    setTimeout(function() {
      document.addEventListener('click', closePieColumnSelector);
    }, 100);
  } else {
    selector.style.display = 'none';
  }
}

function closePieColumnSelector(event) {
  var selector = document.getElementById('pieColumnSelector');
  if (selector && !selector.contains(event.target)) {
    selector.style.display = 'none';
    document.removeEventListener('click', closePieColumnSelector);
  }
}

function formatUnixTimestamp(timestamp) {
  if (!timestamp || timestamp === 0 || timestamp === '0') return '‚Äî';
  
  // –Ø–∫—â–æ —Ü–µ –≤–∂–µ —Å—Ç—Ä–æ–∫–∞ –∑ –¥–∞—Ç–æ—é (–º—ñ—Å—Ç–∏—Ç—å –¥–µ—Ñ—ñ—Å –∞–±–æ —Å–ª–µ—à)
  if (typeof timestamp === 'string' && (timestamp.includes('-') || timestamp.includes('/'))) {
    return timestamp;
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ —á–∏—Å–ª–æ
  var ts = parseInt(timestamp);
  if (isNaN(ts)) return timestamp;
  
  // Unix timestamp –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö (—è–∫—â–æ –º–µ–Ω—à–µ 10000000000, —Ç–æ —Ü–µ —Å–µ–∫—É–Ω–¥–∏)
  var date = ts < 10000000000 ? new Date(ts * 1000) : new Date(ts);
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –¥–∞—Ç–∞ –≤–∞–ª—ñ–¥–Ω–∞
  if (isNaN(date.getTime())) return timestamp;
  
  // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É
  var year = date.getFullYear();
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var day = String(date.getDate()).padStart(2, '0');
  var hours = String(date.getHours()).padStart(2, '0');
  var minutes = String(date.getMinutes()).padStart(2, '0');
  
  return day + '.' + month + '.' + year + ' ' + hours + ':' + minutes;
}

function searchPlayer() {
  var input = document.getElementById('playerSearchInput');
  var email = input.value.trim().toLowerCase();
  
  if (!email) {
    showSearchMessage('Please enter an email address', 'warning');
    return;
  }
  
  var foundPlayer = null;
  var foundIn = null;
  
  // Search in VIP
  if (vipAllPlayers && vipAllPlayers.vip) {
    for (var i = 0; i < vipAllPlayers.vip.length; i++) {
      var player = vipAllPlayers.vip[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'VIP';
        break;
      }
    }
  }
  
  // Search in Silent VIP
  if (!foundPlayer && vipAllPlayers && vipAllPlayers.silentVip) {
    for (var i = 0; i < vipAllPlayers.silentVip.length; i++) {
      var player = vipAllPlayers.silentVip[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'Silent VIP';
        break;
      }
    }
  }
  
  // Search in Retention
  if (!foundPlayer && allRetentionData) {
    for (var i = 0; i < allRetentionData.length; i++) {
      var player = allRetentionData[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'Retention';
        break;
      }
    }
  }
  
  if (foundPlayer) {
    openPlayerProfile(foundPlayer, foundIn);
    input.value = '';
  } else {
    showSearchMessage('Player not found: ' + email, 'error');
  }
}

function showSearchMessage(message, type) {
  var input = document.getElementById('playerSearchInput');
  var originalBorderColor = input.style.borderColor;
  
  if (type === 'error') {
    input.style.borderColor = '#ef4444';
    input.placeholder = message;
  } else if (type === 'warning') {
    input.style.borderColor = '#f59e0b';
    input.placeholder = message;
  }
  
  setTimeout(function() {
    input.style.borderColor = originalBorderColor;
    input.placeholder = 'üîç Search by email...';
  }, 2000);
}

/**
 * Open player profile by email (searches in vipAllPlayers)
 */
/**
 * Open player profile from Profiling section
 * Uses profiling player object directly, tries to find VIP data
 */
function openProfilingPlayer(profilingPlayer) {
  if (!profilingPlayer || !profilingPlayer.data) {
    console.error('‚ùå Invalid profiling player:', profilingPlayer);
    alert('Cannot open player: Invalid data');
    return;
  }
  
  var email = profilingPlayer.data.email || profilingPlayer.data.EMAIL || profilingPlayer.data['EMAIL [PREV]'];
  
  if (!email) {
    console.error('‚ùå No email found in profiling player:', profilingPlayer);
    alert('Cannot open player: Email not found');
    return;
  }
  
  console.log('üîç Opening profiling player:', email);
  
  // Try to find VIP player data
  var vipPlayer = null;
  
  if (window.vipAllPlayers) {
    // Search in vip array
    if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
      vipPlayer = vipAllPlayers.vip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
    }
    
    // Search in silentVip array if not found
    if (!vipPlayer && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
      vipPlayer = vipAllPlayers.silentVip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
    }
  }
  
  // If VIP player found, use it with full metrics
  if (vipPlayer) {
    console.log('‚úÖ Found VIP player data for profiling player');
    openPlayerProfile(vipPlayer, 'Player Profiling');
  } else {
    // Create minimal VIP player from profiling data
    console.log('‚ö†Ô∏è VIP player not found, using profiling data only');
    var minimalVIPPlayer = {
      email: email,
      name: profilingPlayer.data.name || profilingPlayer.data.Name || profilingPlayer.data['Name [PREV]'] || 'Unknown',
      first_name: profilingPlayer.data.first_name || profilingPlayer.data['First Name'] || '',
      last_name: profilingPlayer.data.last_name || profilingPlayer.data['Last Name'] || '',
      country: profilingPlayer.data.country || profilingPlayer.data.Country || '',
      id: profilingPlayer.data.id || profilingPlayer.data.ID || profilingPlayer.data['Player ID'],
      fromProfilingOnly: true
    };
    openPlayerProfile(minimalVIPPlayer, 'Player Profiling');
  }
}

function openPlayerProfileByEmail(email, foundIn) {
  console.log('üîç Opening player by email:', email, 'from:', foundIn);
  
  // Search in vipAllPlayers first
  var player = null;
  
  if (window.vipAllPlayers) {
    console.log('üìä vipAllPlayers structure:', {
      hasVip: !!vipAllPlayers.vip,
      hasSilentVip: !!vipAllPlayers.silentVip,
      vipCount: vipAllPlayers.vip ? vipAllPlayers.vip.length : 0,
      silentCount: vipAllPlayers.silentVip ? vipAllPlayers.silentVip.length : 0
    });
    
    // Search in vip array
    if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
      player = vipAllPlayers.vip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
      
      if (player) {
        console.log('‚úÖ Found player in vipAllPlayers.vip:', player.name);
      }
    }
    
    // Search in silentVip array if not found
    if (!player && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
      player = vipAllPlayers.silentVip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
      
      if (player) {
        console.log('‚úÖ Found player in vipAllPlayers.silentVip:', player.name);
      }
    }
  } else {
    console.log('‚ö†Ô∏è vipAllPlayers not available');
  }
  
  // If not found, search in vipData
  if (!player && window.vipData) {
    console.log('üîç Searching in vipData...');
    var statusLists = ['slvip', 'vip', 'new', 'churned', 'other'];
    statusLists.forEach(function(status) {
      if (vipData[status] && Array.isArray(vipData[status])) {
        var found = vipData[status].find(function(p) {
          return p.email && p.email.toLowerCase() === email.toLowerCase();
        });
        if (found) {
          console.log('‚úÖ Found player in vipData.' + status);
          player = found;
        }
      }
    });
  }
  
  // If still not found, search in profilingData
  if (!player && window.profilingData && profilingData.managers) {
    console.log('üîç Searching in profilingData...');
    profilingData.managers.forEach(function(manager) {
      if (!player && manager.players && Array.isArray(manager.players)) {
        var found = manager.players.find(function(p) {
          return p.data && p.data.email && p.data.email.toLowerCase() === email.toLowerCase();
        });
        if (found) {
          console.log('‚úÖ Found player in profilingData for manager:', manager.name);
          // Convert profiling player to VIP format
          player = {
            email: found.data.email || found.data.EMAIL || found.data['EMAIL [PREV]'],
            name: found.data.name || found.data.Name || found.data['Name [PREV]'] || 'Unknown',
            first_name: found.data.first_name || found.data['First Name'] || '',
            last_name: found.data.last_name || found.data['Last Name'] || '',
            country: found.data.country || found.data.Country || '',
            id: found.data.id || found.data.ID || found.data['Player ID'],
            profilingData: found.data,
            fromProfiling: true
          };
        }
      }
    });
  }
  
  if (!player) {
    console.error('‚ùå Player not found:', email);
    alert('Player not found: ' + email);
    return;
  }
  
  // Call regular openPlayerProfile with found player
  openPlayerProfile(player, foundIn);
}

function openPlayerProfile(player, foundIn) {
  console.log('üîç Opening player profile:', {
    email: player.email,
    name: player.name || (player.first_name + ' ' + player.last_name),
    foundIn: foundIn,
    hasAllFields: !!(player.deposits && player.bets)
  });
  
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  var nameEl = document.getElementById('vipPlayerName');
  var emailEl = document.getElementById('vipPlayerEmail');
  
  // CRITICAL: Clear avatars FIRST to prevent caching
  var vipAvatar = document.querySelector('.flip-card-front .unified-card-avatar');
  if (vipAvatar) {
    vipAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared VIP avatar');
  }
  
  var profilingAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (profilingAvatar) {
    profilingAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared Profiling avatar');
  }
  
  // Find full VIP player data if we only have partial data
  var fullVIPPlayer = player;
  if (player.email && (!player.deposits || !player.bets)) {
    console.log('‚ö†Ô∏è Incomplete player data, searching in vipAllPlayers...');
    console.log('üìä vipAllPlayers exists:', !!window.vipAllPlayers);
    
    // Search in vipAllPlayers (structure: {vip: [], silentVip: []})
    if (window.vipAllPlayers) {
      var found = null;
      
      // Search in vip array
      if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
        found = vipAllPlayers.vip.find(function(p) {
          return p.email && p.email.toLowerCase() === player.email.toLowerCase();
        });
      }
      
      // Search in silentVip array if not found
      if (!found && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
        found = vipAllPlayers.silentVip.find(function(p) {
          return p.email && p.email.toLowerCase() === player.email.toLowerCase();
        });
      }
      
      if (found) {
        console.log('‚úÖ Found full VIP player data in vipAllPlayers');
        console.log('üìä Player data:', {
          deposits: found.deposits,
          bets: found.bets,
          hasMetrics: !!(found.deposits && found.bets)
        });
        fullVIPPlayer = found;
      } else {
        console.log('‚ùå Not found in vipAllPlayers');
      }
    }
    
    // If still not found, search in vipData
    if (!fullVIPPlayer.deposits && window.vipData) {
      console.log('üîç Searching in vipData...');
      console.log('üìä vipData keys:', Object.keys(vipData));
      
      // Search in all status lists
      var statusLists = ['slvip', 'vip', 'new', 'churned', 'other'];
      statusLists.forEach(function(status) {
        if (vipData[status] && Array.isArray(vipData[status])) {
          console.log('üìä Checking vipData.' + status + ' (' + vipData[status].length + ' players)');
          var found = vipData[status].find(function(p) {
            return p.email && p.email.toLowerCase() === player.email.toLowerCase();
          });
          if (found) {
            console.log('‚úÖ Found full VIP player data in vipData.' + status);
            fullVIPPlayer = found;
          }
        }
      });
    }
  }
  
  // Log final result
  console.log('üìä Final player data:', {
    hasDeposits: !!fullVIPPlayer.deposits,
    hasBets: !!fullVIPPlayer.bets,
    deposits: fullVIPPlayer.deposits,
    bets: fullVIPPlayer.bets
  });
  
  // Use fullVIPPlayer from now on
  player = fullVIPPlayer;
  
  var playerName = player.name || ((player.first_name || '') + ' ' + (player.last_name || '')).trim() || 'Unknown Player';
  var playerEmail = player.email || 'No email';
  
  nameEl.textContent = playerName;
  emailEl.textContent = playerEmail + ' ‚Ä¢ ' + foundIn;
  
  // Make name clickable if player exists in Profiling
  var profilingPlayer = player.email ? findProfilingPlayerByEmail(player.email) : null;
  
  // Get fresh profiling data if available
  if (profilingPlayer && profilingData && profilingData.managers) {
    profilingData.managers.forEach(function(manager) {
      manager.players.forEach(function(p) {
        if (p.data.email === player.email) {
          profilingPlayer = p;
          console.log('‚úÖ Using fresh profiling data for VIP card:', player.email);
        }
      });
    });
  }
  
  // Update VIP card avatar with profiling photo if exists
  setTimeout(function() {
    var avatarEl = document.querySelector('.flip-card-front .unified-card-avatar');
    var hasPhoto = profilingPlayer && profilingPlayer.data.photo && 
                   typeof profilingPlayer.data.photo === 'string' && 
                   profilingPlayer.data.photo.trim() !== '';
    
    if (avatarEl && hasPhoto) {
      avatarEl.innerHTML = '';
      var img = document.createElement('img');
      // Add cache busting
      var photoUrl = profilingPlayer.data.photo.trim();
      if (photoUrl.indexOf('?') === -1) {
        photoUrl += '?t=' + Date.now();
      } else {
        photoUrl += '&t=' + Date.now();
      }
      img.src = photoUrl;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
      img.onerror = function() {
        console.log('‚ùå Failed to load profiling photo on VIP card');
        avatarEl.textContent = 'üë§';
      };
      avatarEl.appendChild(img);
      console.log('üì∏ Loaded profiling photo on VIP card');
    }
  }, 100);
  
  nameEl.style.cursor = profilingPlayer ? 'pointer' : 'default';
  nameEl.title = profilingPlayer ? 'Click to view Profiling' : '';
  
  if (profilingPlayer) {
    nameEl.onclick = function() {
      // Store profiling player for flip
      window.currentProfilingPlayer = profilingPlayer;
      flipToProfilingCard();
    };
  } else {
    nameEl.onclick = null;
  }
  
  // Make email copyable
  if (player.email) {
    emailEl.style.cursor = 'pointer';
    emailEl.title = 'Double-click to copy email';
    makeEmailCopyable(emailEl, player.email);
  }
  
  // Show/hide Profiling flip button
  var flipBtn = document.getElementById('vipToProfilingFlipBtn');
  if (flipBtn) {
    console.log('VIP->Profiling button check:', {hasProfilingPlayer: !!profilingPlayer, email: player.email});
    if (profilingPlayer) {
      flipBtn.style.display = 'block';
      // Also store profiling player for flip
      window.currentProfilingPlayer = profilingPlayer;
      flipBtn.onclick = function() {
        window.currentProfilingPlayer = profilingPlayer;
        flipToProfilingCard();
      };
    } else {
      flipBtn.style.display = 'none';
    }
  }
  
  // Store current VIP player
  window.currentVIPPlayer = player;
  
  renderPlayerMetrics(player);
  renderPlayerDetails(player);
  
  // Update Profiling side if profiling player exists
  if (profilingPlayer) {
    var profilingNameEl = document.getElementById('profilingPlayerName');
    var profilingEmailEl = document.getElementById('profilingPlayerEmail');
    var profilingBodyEl = document.getElementById('profilingCardBody');
    
    // Show NAME in header (not email)
    var profilingPlayerName = profilingPlayer.data.name || profilingPlayer.data.email || 'Player';
    profilingNameEl.textContent = profilingPlayerName;
    profilingEmailEl.textContent = profilingPlayer.data.email || '';
    
    // Make name clickable to flip back
    profilingNameEl.style.cursor = 'pointer';
    profilingNameEl.title = 'Click to view VIP Data';
    profilingNameEl.onclick = function() {
      flipToVIPCard();
    };
    
    // Render profiling content
    renderProfilingCardContent(profilingPlayer, profilingBodyEl);
  }
  
  // Reset flip state and show modal
  flipCard.classList.remove('flipped');
  modal.classList.add('show');
}

function closePlayerProfile() {
  closeUnifiedModal();
}

/**
 * Delete player from database
 */
function deletePlayerFromModal() {
  var playerEmail = null;
  
  // Try to get email from currentProfilingPlayer
  if (window.currentProfilingPlayer && window.currentProfilingPlayer.data) {
    playerEmail = window.currentProfilingPlayer.data.email;
  }
  
  // Fallback: get from modal elements
  if (!playerEmail) {
    var emailEl = document.getElementById('vipPlayerEmail');
    if (emailEl && emailEl.textContent) {
      // Extract email from "email@example.com ‚Ä¢ VIP Dashboard" format
      playerEmail = emailEl.textContent.split('‚Ä¢')[0].trim();
    }
  }
  
  if (!playerEmail) {
    alert('Cannot delete: Player email not found');
    console.error('‚ùå Cannot delete: No player email found');
    return;
  }
  
  // Confirm deletion
  var playerName = document.getElementById('vipPlayerName').textContent || 'this player';
  var confirmed = confirm('‚ö†Ô∏è DELETE PLAYER?\n\n' + playerName + '\n' + playerEmail + '\n\nThis action cannot be undone!');
  
  if (!confirmed) {
    console.log('üö´ Delete cancelled by user');
    return;
  }
  
  console.log('üóëÔ∏è Deleting player:', playerEmail);
  
  // Disable buttons during deletion
  var deleteBtn = document.getElementById('vipDeletePlayerBtn');
  var profilingDeleteBtn = document.getElementById('profilingDeletePlayerBtn');
  if (deleteBtn) {
    deleteBtn.disabled = true;
    deleteBtn.textContent = '‚è≥ Deleting...';
  }
  if (profilingDeleteBtn) {
    profilingDeleteBtn.disabled = true;
    profilingDeleteBtn.textContent = '‚è≥ Deleting...';
  }
  
  // Call backend to delete player
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Player deleted:', result);
      
      // Close modal
      closeUnifiedModal();
      
      // Reload data
      alert('‚úÖ Player deleted successfully!');
      
      // Reload VIP Dashboard
      if (typeof loadVIPData === 'function') {
        loadVIPData();
      }
      
      // Reload Profiling
      if (typeof reloadProfilingData === 'function') {
        reloadProfilingData();
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Delete failed:', error);
      alert('‚ùå Delete failed: ' + error.message);
      
      // Re-enable buttons
      if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è DELETE';
      }
      if (profilingDeleteBtn) {
        profilingDeleteBtn.disabled = false;
        profilingDeleteBtn.textContent = 'üóëÔ∏è DELETE';
      }
    })
    .deletePlayer(playerEmail);
}

function closeUnifiedModal() {
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  
  modal.classList.remove('show');
  flipCard.classList.remove('flipped');
  
  // Clear stored players
  window.currentVIPPlayer = null;
  window.currentProfilingPlayer = null;
}

/**
 * Close unified modal on backdrop click
 */
function closeUnifiedModalOnBackdrop(event) {
  if (event.target.id === 'unifiedPlayerModal') {
    closeUnifiedModal();
  }
}

/**
 * Flip to Profiling side
 */
function flipToProfilingCard() {
  var flipCard = document.getElementById('playerFlipCard');
  
  if (!window.currentProfilingPlayer) {
    console.error('No profiling player available');
    return;
  }
  
  // Update profiling card content
  var nameEl = document.getElementById('profilingPlayerName');
  var emailEl = document.getElementById('profilingPlayerEmail');
  var bodyEl = document.getElementById('profilingCardBody');
  
  nameEl.textContent = window.currentProfilingPlayer.data.email || 'Player';
  emailEl.textContent = window.currentProfilingPlayer.data.email || '';
  
  // Make name clickable to flip back
  nameEl.style.cursor = 'pointer';
  nameEl.title = 'Click to view VIP Data';
  nameEl.onclick = function() {
    flipToVIPCard();
  };
  
  // Render profiling content
  renderProfilingCardContent(window.currentProfilingPlayer, bodyEl);
  
  // Flip the card
  flipCard.classList.add('flipped');
}

/**
 * Flip to VIP side
 */
function flipToVIPCard() {
  var flipCard = document.getElementById('playerFlipCard');
  flipCard.classList.remove('flipped');
}

/**
 * Render profiling card content
 */
function renderProfilingCardContent(player, container) {
  container.innerHTML = '';
  
  // Convert old photo URL format to thumbnail format
  var photoConverted = false;
  if (player.data.photo) {
    var photoUrl = player.data.photo;
    
    // Check if old format: https://drive.google.com/uc?export=view&id=...
    if (photoUrl.indexOf('drive.google.com/uc?export=view&id=') !== -1) {
      var fileIdMatch = photoUrl.match(/[?&]id=([^&]+)/);
      if (fileIdMatch) {
        var fileId = fileIdMatch[1];
        player.data.photo = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
        photoConverted = true;
        console.log('Converted old photo URL to thumbnail format');
      }
    }
  }
  
  // Auto-save converted photo URL
  if (photoConverted) {
    console.log('Auto-saving converted photo URL...');
    setTimeout(function() {
      saveProfilingPlayerSilent(player);
    }, 500);
  }
  
  // === TOP ROW: Upload Photo + Social icons + Big icons + Save button ===
  var topRow = document.createElement('div');
  topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(135deg,rgba(102,126,234,0.05),rgba(118,75,162,0.05));border:2px solid rgba(102,126,234,0.2);border-radius:12px 12px 0 0;flex-shrink:0;box-shadow:0 2px 8px rgba(102,126,234,0.1)';
  
  // Left: Upload Photo + Social media icons
  var leftRow = document.createElement('div');
  leftRow.style.cssText = 'display:flex;gap:12px;align-items:center;flex-wrap:wrap';
  
  // Upload Photo button
  var uploadPhotoBtn = document.createElement('button');
  uploadPhotoBtn.innerHTML = 'üì∏ Upload Photo';
  uploadPhotoBtn.style.cssText = 'padding:10px 16px;background:#667eea;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap';
  uploadPhotoBtn.onmouseover = function() { this.style.background = '#5568d3'; this.style.transform = 'translateY(-1px)'; };
  uploadPhotoBtn.onmouseout = function() { this.style.background = '#667eea'; this.style.transform = 'translateY(0)'; };
  uploadPhotoBtn.onclick = function() { uploadPlayerPhoto(player); };
  leftRow.appendChild(uploadPhotoBtn);
  
  // Separator
  var separator = document.createElement('div');
  separator.style.cssText = 'width:2px;height:32px;background:rgba(102,126,234,0.2)';
  leftRow.appendChild(separator);
  
  // Social media icons
  var socialRow = document.createElement('div');
  socialRow.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap';
  
  var socialLinks = getSocialLinks(player, profilingData.fieldConfig);
  if (socialLinks.length > 0) {
    socialLinks.forEach(function(link) {
      var socialBtn = document.createElement('a');
      socialBtn.href = link.url;
      socialBtn.target = '_blank';
      socialBtn.rel = 'noopener noreferrer';
      
      var icon = document.createElement('i');
      icon.className = link.icon;
      socialBtn.appendChild(icon);
      
      socialBtn.title = link.platform;
      socialBtn.style.cssText = 'display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:rgba(102,126,234,0.1);border-radius:8px;font-size:18px;text-decoration:none;transition:all 0.2s;cursor:pointer;color:#667eea';
      
      socialBtn.onmouseover = function() {
        this.style.background = 'rgba(102,126,234,0.2)';
        this.style.transform = 'scale(1.1)';
      };
      
      socialBtn.onmouseout = function() {
        this.style.background = 'rgba(102,126,234,0.1)';
        this.style.transform = 'scale(1)';
      };
      
      socialRow.appendChild(socialBtn);
    });
  }
  
  leftRow.appendChild(socialRow);
  topRow.appendChild(leftRow);
  
  // Right: Big icons + Save button
  var rightButtons = document.createElement('div');
  rightButtons.style.cssText = 'display:flex;gap:8px;align-items:center';
  
  // Big icons [BICON] - BO, JIRA
  var bigIconLinks = getBigIconLinks(player, profilingData.fieldConfig);
  if (bigIconLinks.length > 0) {
    bigIconLinks.forEach(function(link) {
      var bigBtn = document.createElement('a');
      bigBtn.href = link.url;
      bigBtn.target = '_blank';
      bigBtn.rel = 'noopener noreferrer';
      
      var icon = document.createElement('i');
      icon.className = link.icon;
      bigBtn.appendChild(icon);
      
      bigBtn.title = link.platform;
      bigBtn.style.cssText = 'display:flex;align-items:center;justify-content:center;width:44px;height:44px;background:rgba(102,126,234,0.1);border-radius:10px;font-size:22px;text-decoration:none;transition:all 0.2s;cursor:pointer;color:#667eea';
      
      bigBtn.onmouseover = function() {
        this.style.background = 'rgba(102,126,234,0.2)';
        this.style.transform = 'scale(1.1)';
      };
      
      bigBtn.onmouseout = function() {
        this.style.background = 'rgba(102,126,234,0.1)';
        this.style.transform = 'scale(1)';
      };
      
      rightButtons.appendChild(bigBtn);
    });
  }
  
  // Save button
  var saveBtn = document.createElement('button');
  saveBtn.textContent = 'üíæ Save';
  saveBtn.style.cssText = 'background:#667eea;border:none;color:#fff;font-size:14px;font-weight:700;cursor:pointer;padding:12px 24px;border-radius:10px;transition:all 0.2s';
  saveBtn.onmouseover = function() { this.style.background = '#5568d3'; };
  saveBtn.onmouseout = function() { this.style.background = '#667eea'; };
  saveBtn.onclick = function() { saveProfilingPlayer(player); };
  rightButtons.appendChild(saveBtn);
  
  topRow.appendChild(rightButtons);
  container.appendChild(topRow);
  
  // === ICON ROW: Photo + Flag + Gender + Age ===
  var iconRow = document.createElement('div');
  iconRow.id = 'profilingIconRow';
  iconRow.style.cssText = 'display:flex;gap:16px;justify-content:center;padding:24px;background:linear-gradient(to bottom,#f8fafc,#fff);border-bottom:1px solid #e2e8f0;flex-shrink:0';
  
  // Photo (if exists)
  if (player.data.photo) {
    console.log('Player photo URL:', player.data.photo);
    
    var photoIcon = document.createElement('div');
    photoIcon.id = 'playerPhotoIcon';
    photoIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    
    var photoBox = document.createElement('div');
    photoBox.style.cssText = 'width:80px;height:80px;border-radius:12px;overflow:hidden;border:2px solid #cbd5e1;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;background:#f8fafc;display:flex;align-items:center;justify-content:center';
    
    var photoImg = document.createElement('img');
    photoImg.src = player.data.photo;
    photoImg.style.cssText = 'width:100%;height:100%;object-fit:cover';
    
    // Handle image load error
    photoImg.onerror = function() {
      console.error('Failed to load photo:', player.data.photo);
      this.style.display = 'none';
      photoBox.innerHTML = '<div style="font-size:32px">üì∑</div>';
    };
    
    photoImg.onload = function() {
      console.log('Photo loaded successfully');
    };
    
    photoImg.onclick = function() {
      openPhotoModal(player.data.photo);
    };
    photoBox.appendChild(photoImg);
    photoIcon.appendChild(photoBox);
    
    var photoLabel = document.createElement('div');
    photoLabel.textContent = 'Photo';
    photoLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    photoIcon.appendChild(photoLabel);
    
    iconRow.appendChild(photoIcon);
  }
  
  // Flag
  var flagIcon = document.createElement('div');
  flagIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
  var flagEmoji = document.createElement('div');
  flagEmoji.textContent = getFlag(player.data.country);
  flagEmoji.style.cssText = 'width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;box-shadow:0 4px 12px rgba(0,0,0,0.08)';
  flagIcon.appendChild(flagEmoji);
  var flagLabel = document.createElement('div');
  flagLabel.textContent = player.data.country || 'Country';
  flagLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
  flagIcon.appendChild(flagLabel);
  iconRow.appendChild(flagIcon);
  
  // Gender
  var genderIcon = getGenderIcon(player.data.sex);
  if (genderIcon) {
    var genderIconEl = document.createElement('div');
    genderIconEl.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    var genderEmoji = document.createElement('div');
    genderEmoji.textContent = genderIcon;
    genderEmoji.style.cssText = 'width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;background:linear-gradient(135deg,#f8fafc,#e2e8f0);border:2px solid #cbd5e1;box-shadow:0 4px 12px rgba(0,0,0,0.08)';
    genderIconEl.appendChild(genderEmoji);
    var genderLabel = document.createElement('div');
    genderLabel.textContent = player.data.sex || 'Gender';
    genderLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    genderIconEl.appendChild(genderLabel);
    iconRow.appendChild(genderIconEl);
  }
  
  // Age (always show)
  var ageIcon = document.createElement('div');
  ageIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
  var ageEmoji = document.createElement('div');
  
  var age = null;
  if (player.data.birthday) {
    console.log('Birthday value:', player.data.birthday);
    age = calculateAge(player.data.birthday);
    console.log('Calculated age:', age);
  } else {
    console.log('No birthday field found in player.data');
  }
  
  if (age !== null) {
    ageEmoji.textContent = age;
    ageEmoji.style.cssText = 'width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:2px solid #667eea;box-shadow:0 4px 12px rgba(102,126,234,0.3)';
  } else {
    ageEmoji.textContent = '?';
    ageEmoji.style.cssText = 'width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;background:linear-gradient(135deg,#94a3b8,#64748b);color:#fff;border:2px solid #94a3b8;box-shadow:0 4px 12px rgba(148,163,184,0.3)';
  }
  
  ageIcon.appendChild(ageEmoji);
  var ageLabel = document.createElement('div');
  ageLabel.textContent = 'Age';
  ageLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
  ageIcon.appendChild(ageLabel);
  iconRow.appendChild(ageIcon);
  
  container.appendChild(iconRow);
  
  // === SECTIONS WITH TABS ===
  var sections = profilingData.fieldConfig._sections || {'General': Object.keys(profilingData.fieldConfig).filter(function(k) { return k !== '_order' && k !== '_sections'; })};
  var sectionNames = Object.keys(sections);
  
  if (sectionNames.length > 1) {
    // Section tabs
    var tabsRow = document.createElement('div');
    tabsRow.style.cssText = 'display:flex;gap:0;border-bottom:2px solid #e2e8f0;background:#f8fafc;padding:0 20px;overflow-x:auto;flex-shrink:0';
    
    sectionNames.forEach(function(sectionName, index) {
      var tab = document.createElement('button');
      tab.textContent = sectionName;
      tab.className = 'section-tab';
      tab.style.cssText = 'padding:14px 24px;border:none;background:transparent;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s;white-space:nowrap';
      
      if (index === 0) {
        tab.style.borderBottomColor = '#667eea';
        tab.style.color = '#667eea';
        profilingData.activeSection = sectionName;
      }
      
      tab.onclick = function() {
        // Remove active from all tabs
        document.querySelectorAll('.section-tab').forEach(function(t) {
          t.style.borderBottomColor = 'transparent';
          t.style.color = '#64748b';
        });
        
        // Set active
        this.style.borderBottomColor = '#667eea';
        this.style.color = '#667eea';
        profilingData.activeSection = sectionName;
        
        // Render section content
        renderSectionContent(sectionName, sections[sectionName], player, contentArea);
      };
      
      tabsRow.appendChild(tab);
    });
    
    container.appendChild(tabsRow);
  }
  
  // Content area
  var contentArea = document.createElement('div');
  contentArea.style.cssText = 'flex:1;overflow-y:auto;padding:24px';
  
  // Render first section or all fields if no sections
  if (sectionNames.length > 0) {
    renderSectionContent(sectionNames[0], sections[sectionNames[0]], player, contentArea);
  }
  
  container.appendChild(contentArea);
}

function showProfilingView() {
  console.log('üéØ showProfilingView() called');
  console.log('  - profilingInitialized:', window.profilingInitialized);
  console.log('  - profilingData.managers.length:', profilingData.managers ? profilingData.managers.length : 0);
  
  // ‚úÖ –ë–ï–ó–ü–ï–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê
  if (!profilingData.managers) {
    console.warn('‚ö†Ô∏è profilingData.managers is undefined - initializing');
    profilingData.managers = [];
  }
  
  // Deactivate all nav items
  document.querySelectorAll('.nav-item').forEach(function(i) {
    i.classList.remove('active');
  });
  
  // Hide all content views
  document.querySelectorAll('.content').forEach(function(c) {
    c.classList.remove('active');
  });
  
  // Show profiling view
  document.getElementById('profiling-view').classList.add('active');
  
  console.log('  - View switched to profiling');
  
  // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ó–∞–≤–∂–¥–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —è–∫—â–æ –Ω–µ–º–∞—î managers
  if (!window.profilingInitialized || profilingData.managers.length === 0) {
    console.log('  - Initializing Player Profiling (managers: ' + profilingData.managers.length + ')');
    initializePlayerProfiling();
    window.profilingInitialized = true;
  } else {
    console.log('  - Already initialized with ' + profilingData.managers.length + ' managers');
    console.log('  - Current managers:', profilingData.managers);
  }
}

// Player Profiling - Global State
var profilingData = {
  managers: [],
  activeManager: null,
  viewMode: 'grid',
  selectedPlayer: null,
  fieldConfig: {},
  searchQuery: '',
  typeFilter: 'ALL'  // Changed from statusFilter to typeFilter
};

/**
 * Get country flag emoji
 */
function getFlag(countryCode) {
  if (!countryCode) return 'üåê';
  
  const code = String(countryCode).toUpperCase();
  const flagMap = {
    'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™',
    'FR': 'üá´üá∑', 'ES': 'üá™üá∏', 'IT': 'üáÆüáπ', 'BR': 'üáßüá∑', 'MX': 'üá≤üáΩ',
    'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IN': 'üáÆüá≥', 'RU': 'üá∑üá∫', 'KR': 'üá∞üá∑',
    'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞', 'FI': 'üá´üáÆ',
    'PL': 'üáµüá±', 'UA': 'üá∫üá¶', 'CZ': 'üá®üáø', 'AT': 'üá¶üáπ', 'CH': 'üá®üá≠',
    'BE': 'üáßüá™', 'PT': 'üáµüáπ', 'GR': 'üá¨üá∑', 'TR': 'üáπüá∑', 'IL': 'üáÆüá±',
    'SA': 'üá∏üá¶', 'AE': 'üá¶üá™', 'EG': 'üá™üá¨', 'ZA': 'üáøüá¶', 'NG': 'üá≥üá¨',
    'KE': 'üá∞üá™', 'AR': 'üá¶üá∑', 'CL': 'üá®üá±', 'CO': 'üá®üá¥', 'PE': 'üáµüá™',
    'VE': 'üáªüá™', 'TH': 'üáπüá≠', 'VN': 'üáªüá≥', 'ID': 'üáÆüá©', 'MY': 'üá≤üáæ',
    'SG': 'üá∏üá¨', 'PH': 'üáµüá≠', 'NZ': 'üá≥üáø', 'IE': 'üáÆüá™', 'HK': 'üá≠üá∞'
  };
  
  return flagMap[code] || 'üåê';
}

/**
 * Get gender icon
 */
function getGenderIcon(gender) {
  if (!gender) return 'üë§';
  
  const g = String(gender).toLowerCase();
  if (g === 'm' || g === 'male') return 'üë®';
  if (g === 'f' || g === 'female') return 'üë©';
  return 'üë§';
}

/**
 * Find player in Profiling by email
 */
function findProfilingPlayerByEmail(email) {
  if (!email || !profilingData || !profilingData.managers) return null;
  
  for (var i = 0; i < profilingData.managers.length; i++) {
    var manager = profilingData.managers[i];
    if (!manager.players) continue;
    
    for (var j = 0; j < manager.players.length; j++) {
      var player = manager.players[j];
      if (player.data && player.data.email && player.data.email.toLowerCase() === email.toLowerCase()) {
        return player;
      }
    }
  }
  
  return null;
}

/**
 * Find VIP player by email
 */
function findVIPPlayerByEmail(email) {
  if (!email || !vipAllPlayers) return null;
  
  var allPlayers = (vipAllPlayers.vip || []).concat(vipAllPlayers.silentVip || []);
  
  for (var i = 0; i < allPlayers.length; i++) {
    if (allPlayers[i].email && allPlayers[i].email.toLowerCase() === email.toLowerCase()) {
      return allPlayers[i];
    }
  }
  
  return null;
}

/**
 * Get social media icon
 */
function getSocialIcon(fieldName) {
  var name = fieldName.toLowerCase();
  
  // Font Awesome icon classes
  var icons = {
    'whatsapp': 'fa-brands fa-whatsapp',
    'telegram': 'fa-brands fa-telegram',
    'signal': 'fas fa-lock',  // Signal doesn't have brand icon
    'messenger': 'fa-brands fa-facebook-messenger',
    'facebook': 'fa-brands fa-facebook',
    'instagram': 'fa-brands fa-instagram',
    'intercom': 'fas fa-comment-dots',
    'viber': 'fa-brands fa-viber',
    'wechat': 'fa-brands fa-weixin',
    'twitter': 'fa-brands fa-twitter',
    'x': 'fa-brands fa-x-twitter',
    'linkedin': 'fa-brands fa-linkedin',
    'tiktok': 'fa-brands fa-tiktok',
    'snapchat': 'fa-brands fa-snapchat',
    'discord': 'fa-brands fa-discord',
    'skype': 'fa-brands fa-skype',
    'reddit': 'fa-brands fa-reddit',
    'youtube': 'fa-brands fa-youtube',
    'twitch': 'fa-brands fa-twitch',
    'pinterest': 'fa-brands fa-pinterest',
    'vk': 'fa-brands fa-vk',
    'line': 'fa-brands fa-line'
  };
  
  for (var key in icons) {
    if (name.indexOf(key) !== -1) {
      return icons[key];
    }
  }
  
  return 'fas fa-link';  // Default link icon
}

/**
 * Get big icon for [BICON] fields
 */
function getBigIcon(fieldName) {
  var name = fieldName.toLowerCase();
  
  // Big icons mapping
  var icons = {
    'bo': 'fas fa-user-shield',           // Back Office
    'jira': 'fab fa-jira',                // JIRA
    'backoffice': 'fas fa-user-shield',
    'back office': 'fas fa-user-shield'
  };
  
  for (var key in icons) {
    if (name.indexOf(key) !== -1) {
      return icons[key];
    }
  }
  
  return 'fas fa-external-link-alt';
}

/**
 * Get big icon links from player data
 */
function getBigIconLinks(player, fieldConfig) {
  var links = [];
  
  Object.keys(fieldConfig).forEach(function(key) {
    var field = fieldConfig[key];
    if (!field || !field.label) return;
    
    // Check if field label starts with [BICON]
    if (field.label.indexOf('[BICON]') === 0) {
      var value = player.data[key];
      if (value && value.trim() !== '' && value !== 'false') {
        // Extract platform name
        var platformName = field.label.replace('[BICON]', '').trim().split(' ')[0];
        
        links.push({
          platform: platformName,
          url: value,
          icon: getBigIcon(platformName),
          key: key
        });
      }
    }
  });
  
  return links;
}

/**
 * Extract social media links from player data
 */
function getSocialLinks(player, fieldConfig) {
  var links = [];
  
  Object.keys(fieldConfig).forEach(function(key) {
    var field = fieldConfig[key];
    if (!field || !field.label) return;
    
    // Check if field label starts with [ICON]
    if (field.label.indexOf('[ICON]') === 0) {
      var value = player.data[key];
      if (value && value.trim() !== '' && value !== 'false') {
        // Extract platform name - clean label without [ICON]
        var cleanLabel = field.label.replace('[ICON]', '').trim();
        var platformName = cleanLabel.split(' ')[0];
        
        links.push({
          platform: platformName,
          url: value,
          icon: getSocialIcon(platformName),
          key: key,
          cleanLabel: cleanLabel  // Store clean label without [ICON]
        });
      }
    }
  });
  
  return links;
}

/**
 * Calculate age from DOB
 */
function calculateAge(dob) {
  if (!dob) return null;
  
  var birthDate;
  
  // Parse different date formats
  if (typeof dob === 'string') {
    // DD.MM.YYYY format
    if (dob.indexOf('.') !== -1) {
      var parts = dob.split('.');
      if (parts.length === 3) {
        birthDate = new Date(parts[2], parts[1] - 1, parts[0]);
      }
    }
    // YYYY-MM-DD format
    else if (dob.indexOf('-') !== -1) {
      birthDate = new Date(dob);
    }
    else {
      birthDate = new Date(dob);
    }
  } else if (dob instanceof Date) {
    birthDate = dob;
  }
  
  if (!birthDate || isNaN(birthDate.getTime())) return null;
  
  var today = new Date();
  var age = today.getFullYear() - birthDate.getFullYear();
  var monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  return age;
}

function initializePlayerProfiling() {
  console.log('üöÄ Initializing Player Profiling...');
  
  // Check if data already loaded during splash
  if (profilingData.managers && profilingData.managers.length > 0) {
    console.log('‚úÖ Using preloaded Player Profiling data');
    renderProfilingManagerTabs();
    populateTypeFilters();  // NEW: Populate status filters
    selectProfilingManager(profilingData.managers[0].name);
    return;
  }
  
  // Load data from Google Apps Script
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(data) {
        console.log('‚úÖ Player Profiling data loaded');
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: data –Ω–µ null
        if (!data) {
          console.error('‚ùå Backend returned null');
          showProfilingEmptyState();
          return;
        }
        
        if (data.error) {
          console.error('Error from backend:', data.error);
          showProfilingEmptyState();
          return;
        }
        
        profilingData.managers = data.managers || [];
        profilingData.fieldConfig = data.fieldConfig || {};
        
        console.log('üìä Loaded ' + profilingData.managers.length + ' managers');
        
        // Render immediately
        renderProfilingManagerTabs();
        populateTypeFilters();  // NEW: Populate status filters
        
        if (profilingData.managers.length > 0) {
          selectProfilingManager(profilingData.managers[0].name);
        } else {
          showProfilingEmptyState();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load Player Profiling data:', error);
        showProfilingEmptyState();
      })
      .getPlayerProfilingData();
  } else {
    console.warn('Google Apps Script not available - showing empty state');
    showProfilingEmptyState();
  }
}

/**
 * Load profiling data during splash screen (returns Promise)
 */
function loadProfilingData() {
  return new Promise((resolve) => {
    console.log('üì• Preloading Player Profiling data...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('‚úÖ Player Profiling data preloaded');
          console.log('üìä Raw backend data:', data);
          
          // ‚úÖ –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê #1: data –Ω–µ null/undefined
          if (!data) {
            console.error('‚ùå Backend returned null/undefined');
            profilingData.managers = [];
            profilingData.fieldConfig = {};
            resolve();
            return;
          }
          
          // ‚úÖ –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê #2: data.managers —ñ—Å–Ω—É—î
          if (!data.managers || !Array.isArray(data.managers)) {
            console.warn('‚ö†Ô∏è Invalid managers - using empty array');
            profilingData.managers = [];
          } else {
            profilingData.managers = data.managers;
            console.log('üìä Loaded ' + data.managers.length + ' managers');
          }
          
          // ‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê #3: fieldConfig
          if (!data.fieldConfig) {
            profilingData.fieldConfig = {};
          } else {
            profilingData.fieldConfig = data.fieldConfig;
          }
          
          resolve();
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Failed to load Player Profiling:', error);
          profilingData.managers = [];
          profilingData.fieldConfig = {};
          resolve();
        })
        .getPlayerProfilingData();
    } else {
      console.warn('‚ö†Ô∏è Google Script not available');
      resolve();
    }
  });
}

/**
 * Reload profiling data (after photo upload)
 */
function reloadProfilingData() {
  console.log('üîÑ Reloading Player Profiling data...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(data) {
        console.log('‚úÖ Player Profiling data reloaded');
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê
        if (!data) {
          console.error('‚ùå Backend returned null');
          profilingData.managers = [];
          profilingData.fieldConfig = {};
          return;
        }
        
        if (data.error) {
          console.error('Error from backend:', data.error);
          profilingData.managers = [];
          profilingData.fieldConfig = {};
          return;
        }
        
        profilingData.managers = data.managers || [];
        profilingData.fieldConfig = data.fieldConfig || {};
        
        if (profilingData.managers.length > 0) {
          console.log('üìä Reloaded ' + profilingData.managers.length + ' managers');
        }
        
        // Re-render if needed
        if (profilingData.activeManager && profilingData.managers.length > 0) {
          var manager = profilingData.managers.find(function(m) {
            return m.name === profilingData.activeManager;
          });
          
          if (manager && manager.players) {
            renderProfilingPlayers();
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to reload:', error);
        profilingData.managers = [];
        profilingData.fieldConfig = {};
      })
      .getPlayerProfilingData();
  }
}

function showProfilingEmptyState() {
  var container = document.getElementById('profilingPlayersContainer');
  var emptyState = document.getElementById('profilingEmptyState');
  
  if (container) container.style.display = 'none';
  if (emptyState) emptyState.style.display = 'block';
}

function renderProfilingManagerTabs() {
  var container = document.getElementById('profilingManagerTabs');
  if (!container) return;
  
  container.innerHTML = '';
  
  profilingData.managers.forEach(function(manager, index) {
    var tab = document.createElement('button');
    tab.textContent = manager.name;
    tab.className = 'manager-tab' + (index === 0 ? ' active' : '');
    tab.style.cssText = 'padding:10px 20px;margin-right:6px;border-radius:10px;background:transparent;border:1px solid #e2e8f0;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;white-space:nowrap';
    
    if (index === 0) {
      tab.style.background = 'rgba(102,126,234,0.15)';
      tab.style.color = '#667eea';
      tab.style.borderColor = 'rgba(102,126,234,0.3)';
    }
    
    tab.onclick = function() {
      selectProfilingManager(manager.name);
    };
    
    container.appendChild(tab);
  });
}

function selectProfilingManager(managerName) {
  console.log('üéØ selectProfilingManager called with:', managerName);
  console.log('  - Current activeManager:', profilingData.activeManager);
  
  profilingData.activeManager = managerName;
  
  console.log('  - Set activeManager to:', profilingData.activeManager);
  console.log('  - Available managers:', profilingData.managers);
  
  // Update tab styles
  var tabs = document.querySelectorAll('#profilingManagerTabs button');
  tabs.forEach(function(tab) {
    if (tab.textContent === managerName) {
      tab.style.background = 'rgba(102,126,234,0.15)';
      tab.style.color = '#667eea';
      tab.style.borderColor = 'rgba(102,126,234,0.3)';
    } else {
      tab.style.background = 'transparent';
      tab.style.color = '#64748b';
      tab.style.borderColor = '#e2e8f0';
    }
  });
  
  renderProfilingPlayers();
}

function renderProfilingPlayers() {
  console.log('üé® renderProfilingPlayers() called');
  console.log('  - profilingData.managers:', profilingData.managers);
  console.log('  - profilingData.activeManager:', profilingData.activeManager);
  
  var container = document.getElementById('profilingPlayersContainer');
  var emptyState = document.getElementById('profilingEmptyState');
  
  if (!container) {
    console.log('‚ö†Ô∏è profilingPlayersContainer not found!');
    return;
  }
  
  container.innerHTML = '';
  container.style.display = 'grid';
  if (emptyState) emptyState.style.display = 'none';
  
  var manager = profilingData.managers.find(function(m) {
    return m.name === profilingData.activeManager;
  });
  
  console.log('  - manager found:', manager);
  if (manager) {
    console.log('  - manager.players:', manager.players);
    console.log('  - manager.players.length:', manager.players ? manager.players.length : 'N/A');
    if (manager.players && manager.players.length > 0) {
      console.log('  - first player:', manager.players[0]);
      console.log('  - first player tags:', manager.players[0].tags);
    }
  }
  
  if (!manager || !manager.players || manager.players.length === 0) {
    console.log('‚ùå No manager or no players - showing empty state');
    if (manager && !manager.players) {
      console.error('üîß BACKEND ISSUE: manager.players is undefined!');
      console.error('üîß Backend getPlayerProfilingData() must return:');
      console.error('üîß   {managers: [{name: "Ann", players: [...]}]}');
    }
    container.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  console.log('‚úÖ Manager has', manager.players.length, 'players');
  
  var players = manager.players;
  
  // Apply type filter
  if (profilingData.typeFilter && profilingData.typeFilter !== 'ALL') {
    players = players.filter(function(player) {
      var type = getPlayerType(player);
      return type === profilingData.typeFilter;
    });
  }
  
  // Apply search filter
  if (profilingData.searchQuery) {
    players = players.filter(function(player) {
      var searchText = Object.values(player.data).join(' ').toLowerCase();
      return searchText.includes(profilingData.searchQuery);
    });
  }
  
  if (players.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b"><div style="font-size:48px;margin-bottom:12px">üîç</div><div style="font-size:16px;font-weight:600">No players found</div></div>';
    return;
  }
  
  players.forEach(function(player) {
    var card = createProfilingPlayerCard(player);
    container.appendChild(card);
  });
}

/**
 * Get player type from various possible field names
 * Looks for: Type, type, Status, status, Type [PREV], Status [PREV], etc
 */
function getPlayerType(player) {
  if (!player) {
    console.log('‚ö†Ô∏è getPlayerType: player is null/undefined');
    return '';
  }
  
  // ‚úÖ FIX: Use tags like in retention filtering
  if (player.tags && player.tags.length > 0) {
    console.log('‚úÖ getPlayerType: Using tags', player.tags);
    const playerType = getPlayerTypeFromTags(player.tags);
    console.log('  ‚Üí playerType:', playerType);
    if (playerType && playerType !== 'UNKNOWN') {
      return playerType;
    }
  } else {
    console.log('‚ö†Ô∏è getPlayerType: No tags or empty tags', {hasTags: !!player.tags, tagsLength: player.tags?.length});
  }
  
  // Fallback to player.data fields (if backend provides them)
  if (!player.data) {
    console.log('‚ö†Ô∏è getPlayerType: No player.data, returning empty');
    return '';
  }
  
  var possibleFields = [
    'type',
    'Type',
    'TYPE',
    'Type [PREV]',
    'type [prev]',
    'Type [prev]',
    'status',
    'Status',
    'STATUS',
    'Status [PREV]',
    'status [prev]',
    'Status [prev]'
  ];
  
  for (var i = 0; i < possibleFields.length; i++) {
    var field = possibleFields[i];
    if (player.data[field]) {
      console.log('‚úÖ getPlayerType: Found in player.data[' + field + ']:', player.data[field]);
      return String(player.data[field]).trim();
    }
  }
  
  console.log('‚ö†Ô∏è getPlayerType: No type found anywhere, returning empty');
  return '';
}

/**
 * Get all unique type values from all players
 */
function getAllTypeValues() {
  var typeSet = new Set();
  
  if (!profilingData || !profilingData.managers) return [];
  
  profilingData.managers.forEach(function(manager) {
    if (!manager.players) return;
    
    manager.players.forEach(function(player) {
      var type = getPlayerType(player);
      if (type) {
        typeSet.add(type);
      }
    });
  });
  
  var types = Array.from(typeSet).sort();
  console.log('üìä Found type values:', types);
  return types;
}

/**
 * Populate type filter dropdown and tabs
 */
function populateTypeFilters() {
  var types = getAllTypeValues();
  
  if (types.length === 0) {
    console.log('‚ö†Ô∏è No type values found');
    return;
  }
  
  // Populate dropdown
  var dropdown = document.getElementById('profilingTypeFilter');
  if (dropdown) {
    dropdown.innerHTML = '<option value="ALL">All Types</option>';
    types.forEach(function(type) {
      var option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      dropdown.appendChild(option);
    });
    console.log('‚úÖ Type dropdown populated with', types.length, 'options');
  }
  
  // Populate tabs
  var tabsContainer = document.getElementById('profilingTypeTabs');
  if (tabsContainer) {
    tabsContainer.innerHTML = '';
    
    // Add ALL tab
    var allTab = document.createElement('button');
    allTab.className = 'profiling-type-tab active';
    allTab.setAttribute('data-type', 'ALL');
    allTab.textContent = 'ALL';
    allTab.onclick = function() { switchProfilingTypeTab('ALL'); };
    allTab.style.cssText = 'padding:8px 16px;background:none;border:none;font-size:13px;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s';
    tabsContainer.appendChild(allTab);
    
    // Add type tabs
    types.forEach(function(type) {
      var tab = document.createElement('button');
      tab.className = 'profiling-type-tab';
      tab.setAttribute('data-type', type);
      tab.textContent = type;
      tab.onclick = function() { switchProfilingTypeTab(type); };
      tab.style.cssText = 'padding:8px 16px;background:none;border:none;font-size:13px;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s';
      tabsContainer.appendChild(tab);
    });
    
    console.log('‚úÖ Type tabs populated with', types.length, 'tabs');
  }
}

/**
 * Switch Profiling Type Tab
 */
function switchProfilingTypeTab(type) {
  console.log('üîÑ Switching to Profiling type:', type);
  
  // Update active class
  document.querySelectorAll('.profiling-type-tab').forEach(function(btn) {
    if (btn.getAttribute('data-type') === type) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Update dropdown
  var dropdown = document.getElementById('profilingTypeFilter');
  if (dropdown) {
    dropdown.value = type;
  }
  
  // Update filter and re-render
  profilingData.typeFilter = type;
  renderProfilingPlayers();
}

/**
 * Handle Profiling Type Filter dropdown
 */
function handleProfilingTypeFilter() {
  var dropdown = document.getElementById('profilingTypeFilter');
  if (!dropdown) return;
  
  var type = dropdown.value;
  console.log('üîΩ Dropdown changed to:', type);
  
  // Update tabs
  document.querySelectorAll('.profiling-type-tab').forEach(function(btn) {
    if (btn.getAttribute('data-type') === type) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Update filter and re-render
  profilingData.typeFilter = type;
  renderProfilingPlayers();
}

function createProfilingPlayerCard(player) {
  var card = document.createElement('div');
  card.style.cssText = 'background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;animation:fadeIn 0.3s ease';
  
  card.onmouseover = function() {
    this.style.borderColor = '#667eea';
    this.style.transform = 'translateY(-2px)';
    this.style.boxShadow = '0 4px 16px rgba(0,0,0,0.1)';
  };
  
  card.onmouseout = function() {
    this.style.borderColor = '#e2e8f0';
    this.style.transform = 'translateY(0)';
    this.style.boxShadow = 'none';
  };
  
  card.onclick = function() {
    openProfilingPlayer(player);
  };
  
  // Get preview fields
  var previewFields = [];
  
  Object.keys(profilingData.fieldConfig).forEach(function(key) {
    var field = profilingData.fieldConfig[key];
    
    if (field && field.preview && player.data[key]) {
      previewFields.push({
        label: field.label,
        value: player.data[key]
      });
    }
  });
  
  // Header with photo/flag + NAME (not email!)
  var header = document.createElement('div');
  header.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:12px';
  
  var iconElement = document.createElement('div');
  iconElement.style.cssText = 'width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:2px solid #e2e8f0;flex-shrink:0;overflow:hidden';
  
  // Show photo if exists, otherwise show flag
  var hasPhoto = player.data.photo && typeof player.data.photo === 'string' && player.data.photo.trim() !== '';
  
  if (hasPhoto) {
    console.log('üñºÔ∏è Preview card for', player.data.email, 'has photo:', player.data.photo);
    var photoImg = document.createElement('img');
    // Add cache busting timestamp
    var photoUrl = player.data.photo.trim();
    if (photoUrl.indexOf('?') === -1) {
      photoUrl += '?t=' + Date.now();
    } else {
      photoUrl += '&t=' + Date.now();
    }
    photoImg.src = photoUrl;
    photoImg.style.cssText = 'width:100%;height:100%;object-fit:cover';
    photoImg.onerror = function() {
      // Fallback to flag if photo fails to load
      console.log('‚ùå Photo failed to load for', player.data.email);
      iconElement.innerHTML = '';
      iconElement.style.fontSize = '32px';
      iconElement.textContent = getFlag(player.data.country);
    };
    iconElement.appendChild(photoImg);
  } else {
    console.log('üì≠ Preview card for', player.data.email, 'no photo (value:', player.data.photo, ')');
    iconElement.style.fontSize = '32px';
    iconElement.textContent = getFlag(player.data.country);
  }
  
  header.appendChild(iconElement);
  
  var info = document.createElement('div');
  info.style.cssText = 'flex:1;min-width:0;display:flex;flex-direction:column;gap:2px';
  
  // NAME (main text)
  var playerName = document.createElement('div');
  playerName.textContent = player.data.name || player.data.email || 'No name';
  playerName.style.cssText = 'font-size:14px;font-weight:800;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
  info.appendChild(playerName);
  
  // EMAIL (secondary text, copyable on double-click)
  if (player.data.email) {
    var emailEl = document.createElement('div');
    emailEl.textContent = player.data.email;
    emailEl.style.cssText = 'font-size:11px;font-weight:600;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer';
    emailEl.title = 'Double-click to copy';
    
    // Make email copyable
    makeEmailCopyable(emailEl, player.data.email);
    
    info.appendChild(emailEl);
  }
  
  header.appendChild(info);
  card.appendChild(header);
  
  // Preview fields
  var stats = document.createElement('div');
  stats.style.cssText = 'display:flex;flex-direction:column;gap:8px';
  
  if (previewFields.length > 0) {
    previewFields.slice(0, 3).forEach(function(field) {
      var stat = createProfilingStat(field.label, field.value);
      stats.appendChild(stat);
    });
  } else {
    // Fallback - show some basic info if no preview fields
    if (player.data.name) {
      var nameStat = createProfilingStat('Name', player.data.name);
      stats.appendChild(nameStat);
    }
    if (player.data.country) {
      var countryStat = createProfilingStat('Country', player.data.country);
      stats.appendChild(countryStat);
    }
    if (player.data.status) {
      var statusStat = createProfilingStat('Status', player.data.status);
      stats.appendChild(statusStat);
    }
  }
  
  card.appendChild(stats);
  
  return card;
}

function createProfilingStat(label, value) {
  var stat = document.createElement('div');
  stat.style.cssText = 'display:flex;justify-content:space-between;align-items:center;gap:8px';
  
  var labelEl = document.createElement('div');
  labelEl.textContent = label;
  labelEl.style.cssText = 'font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
  stat.appendChild(labelEl);
  
  var valueEl = document.createElement('div');
  valueEl.textContent = value;
  valueEl.style.cssText = 'font-size:12px;font-weight:600;color:#1e293b;text-align:right';
  stat.appendChild(valueEl);
  
  return stat;
}

function showProfilingPlayerDetail(player) {
  // Get fresh player data from profilingData (not cached)
  var freshPlayer = null;
  if (profilingData && profilingData.managers) {
    profilingData.managers.forEach(function(manager) {
      manager.players.forEach(function(p) {
        if (p.data.email === player.data.email) {
          freshPlayer = p;
        }
      });
    });
  }
  
  // Use fresh data if found, otherwise use provided player
  if (freshPlayer) {
    console.log('‚úÖ Using fresh player data for:', player.data.email);
    player = freshPlayer;
  } else {
    console.log('‚ö†Ô∏è Using cached player data for:', player.data.email);
  }
  
  // CRITICAL: Clear avatars FIRST to prevent caching
  var profilingAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (profilingAvatar) {
    profilingAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared Profiling avatar');
  }
  
  var vipAvatar = document.querySelector('.flip-card-front .unified-card-avatar');
  if (vipAvatar) {
    vipAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared VIP avatar');
  }
  
  // Store profiling player
  window.currentProfilingPlayer = player;
  
  // Convert old photo URL format to thumbnail format
  if (player.data.photo) {
    var photoUrl = player.data.photo;
    
    // Check if old format: https://drive.google.com/uc?export=view&id=...
    if (photoUrl.indexOf('drive.google.com/uc?export=view&id=') !== -1) {
      var fileIdMatch = photoUrl.match(/[?&]id=([^&]+)/);
      if (fileIdMatch) {
        var fileId = fileIdMatch[1];
        player.data.photo = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
        console.log('Converted old photo URL to thumbnail format');
      }
    }
  }
  
  // Try to find VIP player by email
  var vipPlayer = player.data.email ? findVIPPlayerByEmail(player.data.email) : null;
  window.currentVIPPlayer = vipPlayer;
  
  // Open unified modal on Profiling side
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  
  // Update Profiling side
  var nameEl = document.getElementById('profilingPlayerName');
  var emailEl = document.getElementById('profilingPlayerEmail');
  var bodyEl = document.getElementById('profilingCardBody');
  
  // Show NAME in header (not email)
  var playerName = player.data.name || player.data.email || 'Player';
  nameEl.textContent = playerName;
  emailEl.textContent = player.data.email || '';
  
  // Update header avatar with photo if exists
  setTimeout(function() {
    var avatarEl = document.querySelector('.flip-card-back .unified-card-avatar');
    var hasPhoto = player.data.photo && typeof player.data.photo === 'string' && player.data.photo.trim() !== '';
    
    if (avatarEl && hasPhoto) {
      avatarEl.innerHTML = '';
      var img = document.createElement('img');
      // Add cache busting timestamp
      var photoUrl = player.data.photo.trim();
      if (photoUrl.indexOf('?') === -1) {
        photoUrl += '?t=' + Date.now();
      } else {
        photoUrl += '&t=' + Date.now();
      }
      img.src = photoUrl;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;cursor:pointer';
      img.onclick = function() {
        openPhotoModal(player.data.photo);
      };
      img.onerror = function() {
        console.log('‚ùå Failed to load photo:', photoUrl);
        avatarEl.textContent = getFlag(player.data.country) || 'üë§';
      };
      avatarEl.appendChild(img);
    }
  }, 100);
  
  // Make name clickable to flip to VIP if exists
  if (vipPlayer) {
    nameEl.style.cursor = 'pointer';
    nameEl.title = 'Click to view VIP Data';
    nameEl.onclick = function() {
      flipToVIPCard();
    };
  } else {
    nameEl.style.cursor = 'default';
    nameEl.title = '';
    nameEl.onclick = null;
  }
  
  // Render profiling content
  renderProfilingCardContent(player, bodyEl);
  
  // Show/hide VIP flip button
  var flipBtn = document.getElementById('profilingToVIPFlipBtn');
  if (flipBtn) {
    console.log('Profiling->VIP button check:', {hasVIPPlayer: !!vipPlayer, email: player.data.email});
    if (vipPlayer) {
      flipBtn.style.display = 'block';
    } else {
      flipBtn.style.display = 'none';
    }
  }
  
  // Update VIP side if player exists
  if (vipPlayer) {
    var vipNameEl = document.getElementById('vipPlayerName');
    var vipEmailEl = document.getElementById('vipPlayerEmail');
    
    var playerName = ((vipPlayer.first_name || '') + ' ' + (vipPlayer.last_name || '')).trim() || 'Unknown Player';
    
    vipNameEl.textContent = playerName;
    vipEmailEl.textContent = vipPlayer.email + ' ‚Ä¢ VIP Dashboard';
    
    if (vipPlayer.email) {
      vipEmailEl.style.cursor = 'pointer';
      vipEmailEl.title = 'Double-click to copy email';
      makeEmailCopyable(vipEmailEl, vipPlayer.email);
    }
    
    renderPlayerMetrics(vipPlayer);
    renderPlayerDetails(vipPlayer);
  }
  
  // Show modal on Profiling side (flipped)
  flipCard.classList.add('flipped');
  modal.classList.add('show');
}

/**
 * Render section content
 */
function renderSectionContent(sectionName, sectionFields, player, container) {
  container.innerHTML = '';
  
  // Section title
  var sectionTitle = document.createElement('div');
  sectionTitle.textContent = sectionName;
  sectionTitle.style.cssText = 'font-size:18px;font-weight:800;color:#1e293b;margin-bottom:24px;display:flex;align-items:center;gap:10px';
  
  var sectionIconEl = document.createElement('span');
  sectionIconEl.textContent = getSectionIcon(sectionName);
  sectionIconEl.style.cssText = 'font-size:24px';
  sectionTitle.insertBefore(sectionIconEl, sectionTitle.firstChild);
  
  container.appendChild(sectionTitle);
  
  // Fields grid
  var fieldsGrid = document.createElement('div');
  fieldsGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px';
  
  sectionFields.forEach(function(key) {
    if (key === '_order' || key === '_sections') return;
    
    var fieldInfo = profilingData.fieldConfig[key];
    if (!fieldInfo) return;
    
    var fieldEl = createEditableField(key, fieldInfo, player);
    fieldsGrid.appendChild(fieldEl);
  });
  
  container.appendChild(fieldsGrid);
}

/**
 * Get section icon based on section name
 */
function getSectionIcon(sectionName) {
  var icons = {
    'main info': 'üìã',
    'communication': 'üí¨',
    'personal info': 'üë§',
    'finance': 'üí∞',
    'gameplay': 'üéÆ',
    'contact info': 'üìû',
    'general': 'üìÑ',
    'player info': 'üë•'
  };
  
  var key = sectionName.toLowerCase();
  return icons[key] || 'üìå';
}

/**
 * Create editable field
 */
function createEditableField(key, fieldInfo, player) {
  var fieldEl = document.createElement('div');
  fieldEl.style.cssText = 'display:flex;flex-direction:column;gap:8px';
  
  // Clean label - remove [ICON] and [BICON] prefixes FIRST
  var cleanLabel = fieldInfo.label
    .replace('[ICON]', '')
    .replace('[BICON]', '')
    .trim();
  
  // Special handling for email - full width
  if (key === 'email') {
    fieldEl.style.gridColumn = '1 / -1';
  }
  
  // Special handling for comments - full width, special styling
  var isCommentsField = key.toLowerCase() === 'comments' || cleanLabel.toLowerCase().indexOf('comment') !== -1;
  if (isCommentsField) {
    fieldEl.style.gridColumn = '1 / -1';
    fieldEl.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
    fieldEl.style.padding = '20px';
    fieldEl.style.borderRadius = '12px';
    fieldEl.style.border = '2px solid #fcd34d';
    fieldEl.style.boxShadow = '0 2px 8px rgba(252,211,77,0.2)';
  }
  
  var label = document.createElement('div');
  
  // Add icon for comments field
  if (isCommentsField) {
    var commentIcon = document.createElement('span');
    commentIcon.innerHTML = 'üí¨ ';
    commentIcon.style.cssText = 'font-size:16px;margin-right:4px';
    label.appendChild(commentIcon);
    
    var labelText = document.createElement('span');
    labelText.textContent = cleanLabel;
    label.appendChild(labelText);
    
    label.style.cssText = 'font-size:13px;font-weight:800;color:#92400e;text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center';
  } else {
    label.textContent = cleanLabel;
    label.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
  }
  
  fieldEl.appendChild(label);
  
  var currentValue = player.data[key] || '';
  
  // Check if this is an [ICON] or [BICON] field with a link
  var isIconField = fieldInfo.label.indexOf('[ICON]') === 0;
  var isBigIconField = fieldInfo.label.indexOf('[BICON]') === 0;
  
  if ((isIconField || isBigIconField) && currentValue && currentValue.trim() !== '' && currentValue !== 'false') {
    // Show icon button instead of input
    var iconBtn = document.createElement('a');
    iconBtn.href = currentValue;
    iconBtn.target = '_blank';
    iconBtn.rel = 'noopener noreferrer';
    
    // Create Font Awesome icon
    var icon = document.createElement('i');
    var platformName = cleanLabel.split(' ')[0];
    icon.className = isBigIconField ? getBigIcon(platformName) : getSocialIcon(platformName);
    iconBtn.appendChild(icon);
    
    // Add text label
    var textSpan = document.createElement('span');
    textSpan.textContent = platformName;
    textSpan.style.marginLeft = '8px';
    iconBtn.appendChild(textSpan);
    
    iconBtn.style.cssText = 'display:flex;align-items:center;padding:12px 14px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff;text-decoration:none;font-size:13px;font-weight:600;transition:all 0.2s;cursor:pointer';
    
    iconBtn.onmouseover = function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 4px 12px rgba(102,126,234,0.3)';
    };
    
    iconBtn.onmouseout = function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'none';
    };
    
    // Add edit button
    var editBtn = document.createElement('button');
    editBtn.textContent = '‚úé';
    editBtn.title = 'Edit link';
    editBtn.style.cssText = 'margin-top:8px;padding:8px 12px;background:rgba(102,126,234,0.1);border:2px solid #e2e8f0;border-radius:6px;color:#667eea;font-size:14px;cursor:pointer;transition:all 0.2s';
    
    editBtn.onclick = function(e) {
      e.preventDefault();
      // Replace icon button with input
      var input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #667eea;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
      
      input.onfocus = function() {
        this.style.borderColor = '#667eea';
        this.style.boxShadow = '0 0 0 3px rgba(102,126,234,0.1)';
      };
      
      input.onblur = function() {
        this.style.borderColor = '#e2e8f0';
        this.style.boxShadow = 'none';
      };
      
      input.onchange = function() {
        player.data[key] = this.value;
        profilingData.selectedPlayer = player;
      };
      
      fieldEl.removeChild(iconBtn);
      fieldEl.removeChild(editBtn);
      fieldEl.appendChild(input);
      input.focus();
    };
    
    fieldEl.appendChild(iconBtn);
    fieldEl.appendChild(editBtn);
    
    return fieldEl;
  }
  
  // Create input based on field type
  var input;
  
  if (fieldInfo.type === 'dropdown' && fieldInfo.options) {
    input = document.createElement('select');
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s';
    
    // Add empty placeholder option first
    var emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = '‚Äî';
    input.appendChild(emptyOpt);
    
    // Add other options
    var hasSelectedValue = false;
    fieldInfo.options.forEach(function(option) {
      var opt = document.createElement('option');
      opt.value = option;
      opt.textContent = option;
      if (option === currentValue && currentValue) {
        opt.selected = true;
        hasSelectedValue = true;
      }
      input.appendChild(opt);
    });
    
    // If no value selected, select empty option
    if (!hasSelectedValue || !currentValue) {
      emptyOpt.selected = true;
    }
  } else if (fieldInfo.type === 'checkbox') {
    input = document.createElement('input');
    input.type = 'checkbox';
    input.checked = currentValue === 'true' || currentValue === true;
    input.style.cssText = 'width:24px;height:24px;cursor:pointer';
  } else if (fieldInfo.type === 'date') {
    input = document.createElement('input');
    input.type = 'date';
    input.value = formatDateForInput(currentValue);
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
  } else if (isCommentsField) {
    // Use textarea for comments
    input = document.createElement('textarea');
    input.value = currentValue;
    input.rows = 6;
    input.style.cssText = 'padding:14px 16px;background:#fff;border:2px solid #fbbf24;border-radius:10px;color:#1e293b;font-size:14px;font-weight:500;transition:all 0.2s;resize:vertical;min-height:120px;line-height:1.6;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif';
    input.placeholder = 'Add your comments here...';
  } else {
    input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
  }
  
  input.onfocus = function() {
    if (isCommentsField) {
      this.style.borderColor = '#f59e0b';
      this.style.boxShadow = '0 0 0 4px rgba(251,191,36,0.2)';
    } else {
      this.style.borderColor = '#667eea';
      this.style.boxShadow = '0 0 0 3px rgba(102,126,234,0.1)';
    }
  };
  
  input.onblur = function() {
    if (isCommentsField) {
      this.style.borderColor = '#fbbf24';
      this.style.boxShadow = 'none';
    } else {
      this.style.borderColor = '#e2e8f0';
      this.style.boxShadow = 'none';
    }
  };
  
  // Store changes
  input.onchange = function() {
    var newValue = this.type === 'checkbox' ? this.checked : this.value;
    player.data[key] = newValue;
    profilingData.selectedPlayer = player;
  };
  
  fieldEl.appendChild(input);
  
  return fieldEl;
}

/**
 * Format date for input field
 */
function formatDateForInput(dateValue) {
  if (!dateValue) return '';
  
  // DD.MM.YYYY ‚Üí YYYY-MM-DD
  if (typeof dateValue === 'string' && dateValue.indexOf('.') !== -1) {
    var parts = dateValue.split('.');
    if (parts.length === 3) {
      return parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
    }
  }
  
  return dateValue;
}

/**
 * Save player data
 */
/**
 * Upload player photo to Google Drive
 */
function uploadPlayerPhoto(player) {
  // Create file input
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    
    // Check file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showToast('‚ùå File too large! Max 5MB');
      return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
      showToast('‚ùå Please select an image file');
      return;
    }
    
    showToast('üì§ Uploading photo...');
    
    // Read file as base64
    var reader = new FileReader();
    reader.onload = function(event) {
      var base64Data = event.target.result.split(',')[1];
      
      // Upload to Google Drive via backend
      google.script.run
        .withSuccessHandler(function(photoUrl) {
          showToast('‚úÖ Photo uploaded!');
          
          console.log('Photo uploaded for player:', player.data.email);
          console.log('Photo URL:', photoUrl);
          
          // Update THIS player's data
          player.data.photo = photoUrl;
          
          // Update avatars in current modal
          updatePlayerAvatars(player, photoUrl);
          
          // Save to sheet UPLOAD column (silent save)
          saveProfilingPlayerSilent(player);
          
          // Reload profiling data to update preview cards
          setTimeout(function() {
            reloadProfilingData();
          }, 1000);
        })
        .withFailureHandler(function(error) {
          console.error('Upload error:', error);
          showToast('‚ùå Upload failed: ' + error);
        })
        .uploadPlayerPhoto(player.data.email, base64Data, file.name);
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
}

/**
 * Update all player avatars with photo
 */
function updatePlayerAvatars(player, photoUrl) {
  console.log('Updating avatars with photo URL:', photoUrl);
  
  // Add cache busting to photoUrl
  if (photoUrl.indexOf('?') === -1) {
    photoUrl += '?t=' + Date.now();
  } else {
    photoUrl += '&t=' + Date.now();
  }
  
  // Update header avatar
  var headerAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (headerAvatar) {
    headerAvatar.innerHTML = '';
    
    var img = document.createElement('img');
    img.src = photoUrl;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;cursor:pointer';
    
    img.onerror = function() {
      console.error('Header avatar failed to load:', photoUrl);
      this.style.display = 'none';
      headerAvatar.innerHTML = '<div style="font-size:32px">üë§</div>';
    };
    
    img.onload = function() {
      console.log('Header avatar loaded successfully');
    };
    
    img.onclick = function() {
      openPhotoModal(player.data.photo);  // Use original URL without timestamp
    };
    
    headerAvatar.appendChild(img);
  }
  
  // Update Icon Row avatar (create new photo box)
  var iconRow = document.getElementById('profilingIconRow');
  if (iconRow) {
    // Remove old photo if exists
    var oldPhoto = document.getElementById('playerPhotoIcon');
    if (oldPhoto) oldPhoto.remove();
    
    // Add photo icon
    var photoIcon = document.createElement('div');
    photoIcon.id = 'playerPhotoIcon';
    photoIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    
    var photoBox = document.createElement('div');
    photoBox.style.cssText = 'width:80px;height:80px;border-radius:12px;overflow:hidden;border:2px solid #cbd5e1;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;background:#f8fafc;display:flex;align-items:center;justify-content:center';
    
    // Add loading placeholder
    photoBox.innerHTML = '<div style="font-size:24px;color:#94a3b8">‚è≥</div>';
    
    var photoImg = document.createElement('img');
    photoImg.src = photoUrl;
    photoImg.style.cssText = 'width:100%;height:100%;object-fit:cover;display:none';
    
    photoImg.onerror = function() {
      console.error('Icon Row photo failed to load:', photoUrl);
      photoBox.innerHTML = '<div style="font-size:32px">üì∑</div>';
    };
    
    photoImg.onload = function() {
      console.log('Icon Row photo loaded successfully');
      photoBox.innerHTML = '';
      this.style.display = 'block';
      photoBox.appendChild(this);
    };
    
    photoImg.onclick = function() {
      openPhotoModal(player.data.photo);  // Use original URL without timestamp
    };
    
    photoBox.appendChild(photoImg);
    photoIcon.appendChild(photoBox);
    
    var photoLabel = document.createElement('div');
    photoLabel.textContent = 'Photo';
    photoLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    photoIcon.appendChild(photoLabel);
    
    // Insert as first icon
    iconRow.insertBefore(photoIcon, iconRow.firstChild);
  }
}

/**
 * Open photo in modal
 */
function openPhotoModal(photoUrl) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px';
  
  modal.onclick = function() {
    modal.remove();
  };
  
  var img = document.createElement('img');
  img.src = photoUrl;
  img.style.cssText = 'max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5)';
  img.onclick = function(e) {
    e.stopPropagation();
  };
  
  modal.appendChild(img);
  document.body.appendChild(modal);
}

function saveProfilingPlayer(player) {
  var saveBtn = event.target;
  saveBtn.disabled = true;
  saveBtn.textContent = '‚è≥ Saving...';
  
  var dataToSave = {
    sheetName: player.sheetName,
    rowIndex: player.rowIndex
  };
  
  // Copy all data fields
  Object.keys(player.data).forEach(function(key) {
    dataToSave[key] = player.data[key];
  });
  
  // Map photo to upload column
  if (player.data.photo) {
    dataToSave.upload = player.data.photo;
    console.log('üì∏ Mapping photo to UPLOAD column:');
    console.log('  Player:', player.data.email);
    console.log('  Photo URL:', player.data.photo);
    console.log('  Row:', player.rowIndex);
  } else {
    console.log('‚ö†Ô∏è No photo to save for player:', player.data.email);
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      saveBtn.textContent = '‚úÖ Saved!';
      setTimeout(function() {
        saveBtn.textContent = 'üíæ Save';
        saveBtn.disabled = false;
      }, 2000);
    })
    .withFailureHandler(function(error) {
      saveBtn.textContent = '‚ùå Error!';
      saveBtn.disabled = false;
      console.error('Failed to save player:', error);
      alert('Failed to save player: ' + error);
    })
    .updatePlayerProfiling(dataToSave);
}

/**
 * Silent save (no UI feedback) - used for auto-saving converted photo URLs
 */
function saveProfilingPlayerSilent(player) {
  var dataToSave = {
    sheetName: player.sheetName,
    rowIndex: player.rowIndex
  };
  
  // Copy all data fields
  Object.keys(player.data).forEach(function(key) {
    dataToSave[key] = player.data[key];
  });
  
  // Map photo to upload column
  if (player.data.photo) {
    dataToSave.upload = player.data.photo;
    console.log('Mapping photo to UPLOAD column (silent):', player.data.photo);
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Photo URL saved silently to UPLOAD column');
    })
    .withFailureHandler(function(error) {
      console.error('Failed to save photo URL:', error);
    })
    .updatePlayerProfiling(dataToSave);
}

function toggleProfilingView() {
  var container = document.getElementById('profilingPlayersContainer');
  var btn = document.getElementById('profilingViewToggle');
  var icon = document.getElementById('profilingViewIcon');
  
  if (!container || !btn || !icon) return;
  
  if (profilingData.viewMode === 'grid') {
    profilingData.viewMode = 'list';
    container.style.gridTemplateColumns = '1fr';
    icon.textContent = '‚ò∞';
    btn.innerHTML = '<span id="profilingViewIcon">‚ò∞</span> List View';
  } else {
    profilingData.viewMode = 'grid';
    container.style.gridTemplateColumns = 'repeat(auto-fill,minmax(280px,1fr))';
    icon.textContent = '‚äû';
    btn.innerHTML = '<span id="profilingViewIcon">‚äû</span> Grid View';
  }
}

/**
 * Toggle Analytics view
 */
function toggleProfilingAnalytics() {
  var playersContainer = document.getElementById('profilingPlayersContainer');
  var analyticsContainer = document.getElementById('profilingAnalyticsContainer');
  var btn = document.getElementById('profilingAnalyticsBtn');
  
  if (!playersContainer || !analyticsContainer || !btn) return;
  
  if (analyticsContainer.style.display === 'none') {
    // Show analytics
    playersContainer.style.display = 'none';
    analyticsContainer.style.display = 'block';
    btn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
    btn.style.color = '#fff';
    btn.style.border = 'none';
    
    // Render analytics
    renderProfilingAnalytics();
  } else {
    // Show players
    playersContainer.style.display = 'grid';
    analyticsContainer.style.display = 'none';
    btn.style.background = 'rgba(16,185,129,0.1)';
    btn.style.color = '#059669';
    btn.style.border = '1px solid rgba(16,185,129,0.3)';
  }
}

/**
 * Render Analytics view with 6 configurable charts
 */
function renderProfilingAnalytics() {
  var container = document.getElementById('profilingAnalyticsContainer');
  if (!container) return;
  
  console.log('üìä Rendering Profiling Analytics...');
  
  // Initialize charts state
  if (!profilingData.charts) {
    profilingData.charts = new Array(6).fill(null);
    profilingData.chartsPerRow = 3;
  }
  
  container.innerHTML = '';
  container.style.cssText = 'padding:20px;overflow-y:auto';
  
  // Analytics header
  var header = document.createElement('div');
  header.style.cssText = 'margin-bottom:20px';
  header.innerHTML = '<div style="font-size:20px;font-weight:800;color:#1e293b;margin-bottom:8px">üìä Player Analytics</div>' +
    '<div style="font-size:13px;color:#64748b">Distribution analysis across all player attributes</div>';
  container.appendChild(header);
  
  // Grid selector
  var gridSelector = document.createElement('div');
  gridSelector.style.cssText = 'display:flex;align-items:center;gap:10px;margin-bottom:20px;padding:10px 16px;background:#fff;border:1px solid #e2e8f0;border-radius:12px';
  
  gridSelector.innerHTML = '<div style="font-size:11px;font-weight:700;color:#64748b;white-space:nowrap;text-transform:uppercase;letter-spacing:0.05em">Layout:</div>' +
    '<div id="gridSelectorButtons" style="display:flex;gap:4px;background:#f8fafc;padding:3px;border-radius:8px;border:1px solid #e2e8f0"></div>';
  
  container.appendChild(gridSelector);
  
  // Add grid selector buttons
  var buttonsContainer = gridSelector.querySelector('#gridSelectorButtons');
  [1, 2, 3, 4, 5, 6].forEach(function(cols) {
    var btn = document.createElement('button');
    btn.dataset.cols = cols;
    btn.style.cssText = 'padding:5px 12px;background:transparent;border:none;border-radius:6px;color:#64748b;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s';
    
    if (cols === 1) btn.innerHTML = '<span style="font-size:14px">‚ñê</span>';
    else if (cols === 2) btn.innerHTML = '<span style="font-size:14px">‚ñê‚ñê</span>';
    else if (cols === 3) {
      btn.innerHTML = '<span style="font-size:14px">‚ñê‚ñê‚ñê</span>';
      btn.style.background = '#3B82F6';
      btn.style.color = '#fff';
      btn.classList.add('active');
    }
    else if (cols === 4) btn.innerHTML = '<span style="font-size:14px">‚ñê‚ñê‚ñê</span><span style="font-size:10px;opacity:0.7">‚ñê</span>';
    else if (cols === 5) btn.innerHTML = '<span style="font-size:14px">‚ñê‚ñê‚ñê</span><span style="font-size:10px;opacity:0.7">‚ñê‚ñê</span>';
    else if (cols === 6) btn.innerHTML = '<span style="font-size:14px">‚ñê‚ñê‚ñê</span><span style="font-size:10px;opacity:0.7">‚ñê‚ñê‚ñê</span>';
    
    btn.onmouseover = function() {
      if (!this.classList.contains('active')) {
        this.style.background = '#f1f5f9';
        this.style.color = '#1e293b';
      }
    };
    
    btn.onmouseout = function() {
      if (!this.classList.contains('active')) {
        this.style.background = 'transparent';
        this.style.color = '#64748b';
      }
    };
    
    btn.onclick = function() {
      var buttons = buttonsContainer.querySelectorAll('button');
      buttons.forEach(function(b) {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = '#64748b';
      });
      
      this.classList.add('active');
      this.style.background = '#3B82F6';
      this.style.color = '#fff';
      
      setChartsPerRow(parseInt(this.dataset.cols));
    };
    
    buttonsContainer.appendChild(btn);
  });
  
  // Charts grid
  var chartsGrid = document.createElement('div');
  chartsGrid.id = 'profilingChartsGrid';
  chartsGrid.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);gap:20px;transition:grid-template-columns 0.3s ease';
  container.appendChild(chartsGrid);
  
  // Create 6 chart cards
  for (var i = 0; i < 6; i++) {
    var chartCard = document.createElement('div');
    chartCard.style.cssText = 'background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;display:flex;flex-direction:column;gap:16px;box-shadow:0 1px 3px rgba(0,0,0,0.05);transition:all 0.3s ease;position:relative;overflow:hidden';
    
    if (i >= 3) {
      chartCard.style.display = 'none';
    }
    
    // Controls
    var controls = document.createElement('div');
    controls.style.cssText = 'display:flex;gap:12px;align-items:center';
    
    // Field selector
    var select = document.createElement('select');
    select.dataset.chartIndex = i;
    select.style.cssText = 'flex:1;padding:8px 12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:12px;font-weight:600;outline:none;transition:all 0.2s';
    
    var emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = '-- Select Field --';
    select.appendChild(emptyOpt);
    
    // Get analytics fields
    var fieldsOrder = profilingData.fieldConfig._order || Object.keys(profilingData.fieldConfig);
    fieldsOrder.forEach(function(fieldKey) {
      if (fieldKey === '_order' || fieldKey === '_sections' || fieldKey === 'email') return;
      
      var fieldInfo = profilingData.fieldConfig[fieldKey];
      if (fieldInfo && fieldInfo.analytics) {
        var option = document.createElement('option');
        option.value = fieldKey;
        option.textContent = fieldInfo.label;
        select.appendChild(option);
      }
    });
    
    select.onchange = function() {
      var chartIndex = parseInt(this.dataset.chartIndex);
      var card = this.closest('[data-chart-card]');
      var activeTypeBtn = card.querySelector('.chart-type-btn-active');
      var chartType = activeTypeBtn ? activeTypeBtn.dataset.type : 'pie';
      if (this.value) {
        renderProfilingChart(chartIndex, this.value, chartType);
      }
    };
    
    controls.appendChild(select);
    
    // Chart type toggle
    var typeToggle = document.createElement('div');
    typeToggle.style.cssText = 'display:flex;gap:4px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:4px';
    
    var pieBtn = document.createElement('button');
    pieBtn.textContent = 'ü•ß Pie';
    pieBtn.dataset.type = 'pie';
    pieBtn.dataset.chartIndex = i;
    pieBtn.style.cssText = 'padding:6px 12px;background:#3B82F6;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s';
    pieBtn.classList.add('chart-type-btn-active');
    
    pieBtn.onclick = function() {
      var chartIndex = parseInt(this.dataset.chartIndex);
      var card = this.closest('[data-chart-card]');
      var selectEl = card.querySelector('select');
      var fieldKey = selectEl.value;
      
      var buttons = card.querySelectorAll('[data-type]');
      buttons.forEach(function(b) {
        b.classList.remove('chart-type-btn-active');
        b.style.background = 'transparent';
        b.style.color = '#64748b';
      });
      
      this.classList.add('chart-type-btn-active');
      this.style.background = '#3B82F6';
      this.style.color = '#fff';
      
      if (fieldKey) renderProfilingChart(chartIndex, fieldKey, 'pie');
    };
    
    typeToggle.appendChild(pieBtn);
    
    var barBtn = document.createElement('button');
    barBtn.textContent = 'üìä Bar';
    barBtn.dataset.type = 'bar';
    barBtn.dataset.chartIndex = i;
    barBtn.style.cssText = 'padding:6px 12px;background:transparent;border:none;border-radius:6px;color:#64748b;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s';
    
    barBtn.onclick = function() {
      var chartIndex = parseInt(this.dataset.chartIndex);
      var card = this.closest('[data-chart-card]');
      var selectEl = card.querySelector('select');
      var fieldKey = selectEl.value;
      
      var buttons = card.querySelectorAll('[data-type]');
      buttons.forEach(function(b) {
        b.classList.remove('chart-type-btn-active');
        b.style.background = 'transparent';
        b.style.color = '#64748b';
      });
      
      this.classList.add('chart-type-btn-active');
      this.style.background = '#3B82F6';
      this.style.color = '#fff';
      
      if (fieldKey) renderProfilingChart(chartIndex, fieldKey, 'bar');
    };
    
    typeToggle.appendChild(barBtn);
    controls.appendChild(typeToggle);
    chartCard.appendChild(controls);
    
    // Chart container
    var chartContainer = document.createElement('div');
    chartContainer.style.cssText = 'height:300px;position:relative';
    chartContainer.id = 'profilingChart-' + i;
    
    var emptyState = document.createElement('div');
    emptyState.style.cssText = 'height:300px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:#64748b';
    emptyState.innerHTML = '<div style="font-size:48px;opacity:0.5">üìä</div>' +
      '<div style="font-size:14px;font-weight:600">Select a field to view distribution</div>';
    chartContainer.appendChild(emptyState);
    
    chartCard.appendChild(chartContainer);
    chartCard.dataset.chartCard = i;
    chartsGrid.appendChild(chartCard);
  }
}

/**
 * Set charts per row
 */
function setChartsPerRow(cols) {
  profilingData.chartsPerRow = cols;
  
  var container = document.getElementById('profilingChartsGrid');
  if (!container) return;
  
  container.style.gridTemplateColumns = 'repeat(' + cols + ',1fr)';
  
  // Show/hide chart cards
  var chartCards = container.querySelectorAll('[data-chart-card]');
  var visibleCount = cols === 1 ? 1 : cols === 2 ? 2 : cols === 3 ? 3 : cols === 4 ? 4 : cols === 5 ? 5 : 6;
  
  chartCards.forEach(function(card, index) {
    card.style.display = index < visibleCount ? 'flex' : 'none';
  });
}

/**
 * Render single chart with Canvas API
 */
function renderProfilingChart(index, fieldKey, chartType) {
  var container = document.getElementById('profilingChart-' + index);
  if (!container) return;
  
  container.innerHTML = '<canvas></canvas>';
  var canvas = container.querySelector('canvas');
  
  // Get all players
  var allPlayers = [];
  profilingData.managers.forEach(function(manager) {
    if (manager.players) {
      allPlayers = allPlayers.concat(manager.players);
    }
  });
  
  // Count distribution
  var distribution = {};
  allPlayers.forEach(function(player) {
    var value = player.data[fieldKey];
    var displayValue = 'Unknown';
    
    if (value === true || value === 'TRUE' || value === 'true') {
      displayValue = 'Yes';
    } else if (value === false || value === 'FALSE' || value === 'false') {
      displayValue = 'No';
    } else if (value !== null && value !== undefined && value !== '') {
      displayValue = String(value);
    }
    
    distribution[displayValue] = (distribution[displayValue] || 0) + 1;
  });
  
  var labels = Object.keys(distribution);
  var data = Object.values(distribution);
  var total = data.reduce(function(sum, val) { return sum + val; }, 0);
  
  var ctx = canvas.getContext('2d');
  canvas.width = container.clientWidth;
  canvas.height = 280;
  
  // Color palette
  var colors = [
    '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444',
    '#06B6D4', '#EC4899', '#6366F1', '#14B8A6', '#F97316'
  ];
  
  if (chartType === 'pie') {
    // Draw pie chart
    var centerX = canvas.width / 2;
    var centerY = canvas.height / 2;
    var radius = Math.min(centerX, centerY) - 40;
    var currentAngle = -Math.PI / 2;
    
    data.forEach(function(value, i) {
      var sliceAngle = (value / total) * 2 * Math.PI;
      
      ctx.fillStyle = colors[i % colors.length];
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
      ctx.closePath();
      ctx.fill();
      
      // Draw percentage text
      var midAngle = currentAngle + sliceAngle / 2;
      var textX = centerX + Math.cos(midAngle) * (radius * 0.7);
      var textY = centerY + Math.sin(midAngle) * (radius * 0.7);
      var percentage = ((value / total) * 100).toFixed(1);
      
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(percentage + '%', textX, textY);
      ctx.font = '10px sans-serif';
      ctx.fillText('(' + value + ')', textX, textY + 14);
      
      currentAngle += sliceAngle;
    });
  } else {
    // Draw bar chart with animation
    var padding = 50;
    var chartWidth = canvas.width - padding * 2;
    var chartHeight = canvas.height - padding * 2;
    var barWidth = chartWidth / labels.length;
    var maxValue = Math.max.apply(Math, data);
    
    // Animation
    var progress = 0;
    var duration = 600;
    var startTime = Date.now();
    
    var animate = function() {
      var elapsed = Date.now() - startTime;
      progress = Math.min(elapsed / duration, 1);
      
      var eased = 1 - Math.pow(1 - progress, 3);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      data.forEach(function(value, i) {
        var targetHeight = (value / maxValue) * chartHeight;
        var barHeight = targetHeight * eased;
        var x = padding + i * barWidth;
        var y = canvas.height - padding - barHeight;
        
        ctx.fillStyle = colors[i % colors.length];
        ctx.fillRect(x + 5, y, barWidth - 10, barHeight);
        
        if (progress === 1) {
          if (barHeight > 30) {
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(value, x + barWidth / 2, y + 20);
          } else {
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(value, x + barWidth / 2, y - 10);
          }
        }
        
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        var label = labels[i].length > 15 ? labels[i].substring(0, 15) + '...' : labels[i];
        ctx.fillText(label, x + barWidth / 2, canvas.height - padding + 25);
      });
      
      ctx.strokeStyle = 'rgba(0,0,0,0.15)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    };
    
    animate();
  }
  
  // Create legend before canvas
  var legend = document.createElement('div');
  legend.style.cssText = 'display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e2e8f0';
  
  labels.forEach(function(label, i) {
    var item = document.createElement('div');
    item.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:11px;color:#64748b';
    
    var colorBox = document.createElement('div');
    colorBox.style.cssText = 'width:12px;height:12px;border-radius:3px;flex-shrink:0;background:' + colors[i % colors.length];
    item.appendChild(colorBox);
    
    var labelEl = document.createElement('span');
    labelEl.style.fontWeight = '600';
    labelEl.textContent = label;
    item.appendChild(labelEl);
    
    var valueEl = document.createElement('span');
    valueEl.style.color = '#94a3b8';
    valueEl.textContent = '(' + data[i] + ')';
    item.appendChild(valueEl);
    
    legend.appendChild(item);
  });
  
  container.insertBefore(legend, canvas);
}

// Player Profiling Search
var profilingSearch = document.getElementById('profilingSearchInput');
if (profilingSearch) {
  profilingSearch.addEventListener('input', function() {
    profilingData.searchQuery = this.value.toLowerCase();
    renderProfilingPlayers();
  });
}

function openProfilingAddModal() {
  if (!profilingData.activeManager) {
    alert('Please select a manager first');
    return;
  }
  
  // Create modal
  var modal = document.createElement('div');
  modal.id = 'profilingAddModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center';
  
  var modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:#fff;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)';
  
  var header = document.createElement('div');
  header.style.cssText = 'padding:24px;border-bottom:2px solid #e2e8f0;background:linear-gradient(135deg,#10b981,#059669);display:flex;justify-content:space-between;align-items:center';
  
  var title = document.createElement('h2');
  title.textContent = '‚ûï Add New Player - ' + profilingData.activeManager;
  title.style.cssText = 'margin:0;color:#fff;font-size:20px;font-weight:800';
  header.appendChild(title);
  
  var closeBtn = document.createElement('button');
  closeBtn.textContent = '√ó';
  closeBtn.style.cssText = 'background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:32px;cursor:pointer;width:40px;height:40px;border-radius:8px;transition:all 0.2s';
  closeBtn.onclick = function() { modal.remove(); };
  closeBtn.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.3)'; };
  closeBtn.onmouseout = function() { this.style.background = 'rgba(255,255,255,0.2)'; };
  header.appendChild(closeBtn);
  
  modalContent.appendChild(header);
  
  var body = document.createElement('div');
  body.style.cssText = 'padding:24px';
  
  var fieldsGrid = document.createElement('div');
  fieldsGrid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:16px 20px';
  
  var fieldsOrder = profilingData.fieldConfig._order || Object.keys(profilingData.fieldConfig);
  
  fieldsOrder.forEach(function(key) {
    if (key === '_order' || key === '_sections') return;
    
    var fieldInfo = profilingData.fieldConfig[key];
    if (!fieldInfo) return;
    
    var fieldEl = document.createElement('div');
    fieldEl.style.cssText = 'display:flex;flex-direction:column;gap:6px';
    
    if (key === 'email') {
      fieldEl.style.gridColumn = '1 / -1';
    }
    
    var label = document.createElement('div');
    label.textContent = fieldInfo.label + (key === 'email' ? ' *' : '');
    label.style.cssText = 'font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
    fieldEl.appendChild(label);
    
    var input;
    if (fieldInfo.type === 'checkbox') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.dataset.field = key;
    } else if (fieldInfo.type === 'dropdown' && fieldInfo.options) {
      input = document.createElement('select');
      input.dataset.field = key;
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
      
      var emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '-- Select --';
      input.appendChild(emptyOpt);
      
      fieldInfo.options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        input.appendChild(option);
      });
    } else if (fieldInfo.type === 'date') {
      input = document.createElement('input');
      input.type = 'date';
      input.dataset.field = key;
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.dataset.field = key;
      input.placeholder = 'Enter ' + fieldInfo.label.toLowerCase();
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
      
      if (key === 'email') {
        input.required = true;
      }
    }
    
    fieldEl.appendChild(input);
    fieldsGrid.appendChild(fieldEl);
  });
  
  body.appendChild(fieldsGrid);
  modalContent.appendChild(body);
  
  var footer = document.createElement('div');
  footer.style.cssText = 'padding:20px 24px;border-top:1px solid #e2e8f0;display:flex;gap:12px;justify-content:flex-end';
  
  var cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cssText = 'padding:10px 24px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-weight:700;cursor:pointer';
  cancelBtn.onclick = function() { modal.remove(); };
  footer.appendChild(cancelBtn);
  
  var saveBtn = document.createElement('button');
  saveBtn.textContent = 'üíæ Save Player';
  saveBtn.style.cssText = 'padding:10px 24px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer';
  saveBtn.onclick = function() {
    saveProfilingNewPlayer(modal);
  };
  footer.appendChild(saveBtn);
  
  modalContent.appendChild(footer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}

function saveProfilingNewPlayer(modal) {
  var inputs = modal.querySelectorAll('input, select');
  var newPlayerData = {
    sheetName: profilingData.activeManager
  };
  
  var emailProvided = false;
  
  inputs.forEach(function(input) {
    var fieldKey = input.dataset.field;
    
    if (input.type === 'checkbox') {
      newPlayerData[fieldKey] = input.checked;
    } else {
      newPlayerData[fieldKey] = input.value;
      
      if (fieldKey === 'email' && input.value) {
        emailProvided = true;
      }
    }
  });
  
  if (!emailProvided) {
    alert('‚ùå Email is required!');
    return;
  }
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function() {
        alert('‚úÖ Player added successfully!');
        modal.remove();
        
        // Reload data
        initializePlayerProfiling();
      })
      .withFailureHandler(function(error) {
        alert('‚ùå Error: ' + error.message);
      })
      .addPlayerProfiling(newPlayerData);
  } else {
    alert('Google Apps Script not available');
  }
}

function renderPlayerMetrics(player) {
  var container = document.getElementById('vipPlayerMetrics');
  
  var metrics = [
    {
      section: 'Lifetime',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.lifetime_deposit_sum_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.lifetime_cashout_sum_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0), format: 'inout'},
        {icon: 'üî¢', label: 'Deposit Count', value: player.lifetime_deposit_count_total || 0, format: 'number'}
      ]
    },
    {
      section: 'Last 30 Days',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.deposit_sum_last_30_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.cashout_sum_last_30_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0), format: 'inout'},
        {icon: 'üî¢', label: 'Deposit Count', value: player.deposit_count_last_30_total || 0, format: 'number'}
      ]
    },
    {
      section: 'Last 7 Days',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.deposit_sum_last_7_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.cashout_sum_last_7_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0), format: 'inout'}
      ]
    },
    {
      section: 'Player Info',
      items: [
        {icon: 'üåç', label: 'Country', value: player.country || 'Unknown', format: 'text'},
        {icon: 'üë§', label: 'Gender', value: player.gender || 'Unknown', format: 'text'},
        {icon: 'üí¨', label: 'Locale', value: player.locale || 'Unknown', format: 'text'}
      ]
    }
  ];
  
  var html = '';
  
  metrics.forEach(function(section) {
    html += '<div style="margin-bottom:24px">';
    html += '<h4 style="font-size:14px;font-weight:600;color:#64748b;margin:0 0 12px 0;text-transform:uppercase;letter-spacing:0.5px">' + section.section + '</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">';
    
    section.items.forEach(function(metric) {
      var displayValue = '';
      var valueColor = '#1e293b';
      var bgColor = '#f8fafc';
      
      if (metric.format === 'currency') {
        displayValue = '‚Ç¨' + metric.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        bgColor = '#ffffff';
      } else if (metric.format === 'number') {
        displayValue = Math.round(metric.value).toLocaleString();
        bgColor = '#ffffff';
      } else if (metric.format === 'inout') {
        displayValue = '‚Ç¨' + Math.abs(metric.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (metric.value >= 0) {
          valueColor = '#10b981';
          bgColor = '#f0fdf4';
        } else {
          valueColor = '#ef4444';
          bgColor = '#fef2f2';
        }
      } else {
        displayValue = metric.value;
        bgColor = '#ffffff';
      }
      
      html += '<div style="background:' + bgColor + ';padding:12px;border-radius:8px;border:1px solid #e2e8f0;transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">';
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
      html += '<span style="font-size:16px">' + metric.icon + '</span>';
      html += '<span style="font-size:11px;color:#64748b;font-weight:600">' + metric.label + '</span>';
      html += '</div>';
      html += '<div style="font-size:20px;font-weight:700;color:' + valueColor + '">' + displayValue + '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function renderPlayerDetails(player) {
  var container = document.getElementById('vipPlayerDetails');
  
  // Helper function to format date of birth
  function formatDateOfBirth(dob) {
    if (!dob) return '‚Äî';
    
    // If it's a Unix timestamp (number)
    if (typeof dob === 'number' || (typeof dob === 'string' && /^\d+$/.test(dob))) {
      var timestamp = parseInt(dob);
      if (isNaN(timestamp)) return '‚Äî';
      
      // Unix timestamp in seconds
      var date = timestamp < 10000000000 ? new Date(timestamp * 1000) : new Date(timestamp);
      
      if (isNaN(date.getTime())) return '‚Äî';
      
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      
      // Calculate age
      var today = new Date();
      var age = today.getFullYear() - year;
      if (today.getMonth() < date.getMonth() || 
          (today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) {
        age--;
      }
      
      return day + '.' + month + '.' + year + ' (age: ' + age + ')';
    }
    
    return dob;
  }
  
  var sections = [
    {
      title: 'üë§ Personal Information',
      icon: 'üë§',
      fields: [
        {label: 'Player ID', value: (player.id || '').replace('slotornado:', ''), link: true, icon: 'üÜî'},
        {label: 'First Name', value: player.first_name, icon: '‚úèÔ∏è'},
        {label: 'Last Name', value: player.last_name, icon: '‚úèÔ∏è'},
        {label: 'Email', value: player.email, icon: 'üìß'},
        {label: 'Phone', value: player.phone, icon: 'üìû'},
        {label: 'Gender', value: player.gender, icon: '‚ö•'},
        {label: 'Date of Birth', value: formatDateOfBirth(player.date_of_birth), icon: 'üéÇ'}
      ]
    },
    {
      title: 'üè¶ Account Details',
      icon: 'üè¶',
      fields: [
        {label: 'Registration Date', value: formatUnixTimestamp(player.created_at), icon: 'üìÖ'},
        {label: 'Last Visit', value: formatUnixTimestamp(player._last_visit), icon: 'üïí'},
        {label: 'Country', value: player.country, icon: 'üåç'},
        {label: 'Currency', value: player.currency, icon: 'üí∞'},
        {label: 'Locale', value: player.locale, icon: 'üåê'},
        {label: 'Disabled', value: player.disabled ? 'Yes' : 'No', icon: player.disabled ? 'üö´' : '‚úÖ'}
      ]
    },
    {
      title: 'üëë VIP & Marketing',
      icon: 'üëë',
      fields: [
        {label: 'Manager', value: getPlayerManager(player), icon: 'üë®‚Äçüíº'},
        {label: 'Tags', value: player.tags, icon: 'üè∑Ô∏è'},
        {label: 'Agreed to Promotions', value: player.agreed_to_partner_promotions ? 'Yes' : 'No', icon: player.agreed_to_partner_promotions ? '‚úÖ' : '‚ùå'},
        {label: 'Receive Promos', value: player.receive_promos ? 'Yes' : 'No', icon: player.receive_promos ? '‚úÖ' : '‚ùå'},
        {label: 'Receive SMS Promos', value: player.receive_sms_promos ? 'Yes' : 'No', icon: player.receive_sms_promos ? '‚úÖ' : '‚ùå'}
      ]
    },
    {
      title: 'üíµ Financial Metrics - All Periods',
      icon: 'üíµ',
      fields: [
        {label: 'Deposit Sum (Lifetime)', value: '‚Ç¨' + (player.lifetime_deposit_sum_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üí≥'},
        {label: 'Cashout Sum (Lifetime)', value: '‚Ç¨' + Math.abs(player.lifetime_cashout_sum_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üí∏'},
        {label: 'Deposit Count (Lifetime)', value: (player.lifetime_deposit_count_total || 0).toLocaleString(), icon: 'üî¢'},
        {label: 'Cashout Count (Lifetime)', value: (player.lifetime_cashout_count_total || 0).toLocaleString(), icon: 'üî¢'},
        {label: 'Deposit Sum (90 Days)', value: '‚Ç¨' + (player.deposit_sum_last_90_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (30 Days)', value: '‚Ç¨' + (player.deposit_sum_last_30_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (7 Days)', value: '‚Ç¨' + (player.deposit_sum_last_7_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (Yesterday)', value: '‚Ç¨' + (player.deposit_sum_previous_day_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'}
      ]
    }
  ];
  
  var html = '';
  
  sections.forEach(function(section, idx) {
    // Section header with gradient background
    html += '<div style="margin-bottom:' + (idx < sections.length - 1 ? '28px' : '0') + '">';
    html += '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:12px 16px;margin-bottom:16px;border-radius:12px 12px 0 0;box-shadow:0 2px 8px rgba(102,126,234,0.2)">';
    html += '<h4 style="font-size:15px;font-weight:700;color:#fff;margin:0;letter-spacing:0.5px">' + section.title + '</h4>';
    html += '</div>';
    
    // Fields table with modern design
    html += '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:0 0 12px 12px;overflow:hidden">';
    html += '<table style="width:100%;border-collapse:collapse">';
    html += '<tbody>';
    
    section.fields.forEach(function(field, fieldIdx) {
      var value = field.value || '‚Äî';
      
      // Format link if needed
      if (field.link && value !== '‚Äî') {
        value = '<a href="https://backoffice.slotornado-bivu.com/backend/players/' + value + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px" onmouseover="this.style.color=\'#5568d3\'" onmouseout="this.style.color=\'#667eea\'"><span style="font-size:14px">üîó</span> ' + value + '</a>';
      }
      
      var rowBg = fieldIdx % 2 === 0 ? '#ffffff' : '#f8fafc';
      var borderBottom = fieldIdx < section.fields.length - 1 ? 'border-bottom:1px solid #f1f5f9' : '';
      
      html += '<tr style="background:' + rowBg + ';transition:all 0.2s" onmouseover="this.style.background=\'#f0f4ff\'" onmouseout="this.style.background=\'' + rowBg + '\'">';
      html += '<td style="padding:14px 16px;' + borderBottom + '">';
      html += '<div style="display:flex;align-items:center;gap:10px">';
      html += '<span style="font-size:18px;opacity:0.8">' + field.icon + '</span>';
      html += '<span style="font-weight:600;color:#64748b;font-size:13px">' + field.label + '</span>';
      html += '</div>';
      html += '</td>';
      html += '<td style="padding:14px 16px;color:#1e293b;font-size:14px;font-weight:500;' + borderBottom + '">' + value + '</td>';
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

</script>

<!-- Metric Modal -->
<div id="metricModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center" onclick="if(event.target.id==='metricModal') closeMetricModal()">
  <div style="background:#fff;border-radius:12px;max-width:95%;max-height:90vh;width:1400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:2px solid #e2e8f0">
      <h2 id="metricModalTitle" style="margin:0;font-size:24px;font-weight:700;color:#1e293b"></h2>
      <button onclick="closeMetricModal()" style="background:none;border:none;font-size:32px;color:#64748b;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.2s" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">√ó</button>
    </div>
    <div id="metricModalBody" style="padding:24px;overflow-y:auto;flex:1"></div>
  </div>
</div>

<div id="pieChartModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center" onclick="if(event.target.id==='pieChartModal') closePieModal()">
  <div style="background:#fff;border-radius:12px;max-width:95%;max-height:90vh;width:1400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:2px solid #e2e8f0">
      <h2 id="pieChartModalTitle" style="margin:0;font-size:24px;font-weight:700;color:#1e293b"></h2>
      <button onclick="closePieChartModal()" style="background:none;border:none;font-size:32px;color:#64748b;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.2s" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">√ó</button>
    </div>
    <div style="padding:24px;overflow-y:auto;flex:1">
      <div style="display:flex;flex-direction:column;gap:24px">
        <div style="display:flex;justify-content:center;align-items:center">
          <div style="width:400px;height:400px;position:relative">
            <canvas id="pieChartModalCanvas"></canvas>
          </div>
        </div>
        <div style="display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="font-size:16px;font-weight:600;color:#1e293b;margin:0">
              <span id="pieFilterIndicator"></span>Players Breakdown
            </h3>
            <div style="position:relative">
              <button id="pieColumnSelectorBtn" onclick="togglePieColumnSelector(event)" style="background:#667eea;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">
                ‚öôÔ∏è Columns
              </button>
              <div id="pieColumnSelector" style="display:none;position:absolute;top:100%;right:0;margin-top:8px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:16px;width:280px;max-height:500px;overflow-y:auto;z-index:10000"></div>
            </div>
          </div>
          <div style="overflow:auto;border:1px solid #e2e8f0;border-radius:8px">
            <table class="metric-table" style="width:100%;border-collapse:collapse">
              <thead id="pieModalTableHeader"></thead>
              <tbody id="pieModalTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Unified Flip Card Modal -->
<div id="unifiedPlayerModal" class="unified-flip-modal" onclick="closeUnifiedModalOnBackdrop(event)">
  <div class="flip-card-container" onclick="event.stopPropagation()">
    <div class="flip-card" id="playerFlipCard">
      
      <!-- VIP Side (Front) -->
      <div class="flip-card-side flip-card-front">
        <div class="unified-card-header">
          <div class="unified-card-title-area">
            <div class="unified-card-avatar">üë§</div>
            <div class="unified-card-title-text">
              <h2 id="vipPlayerName">Player Name</h2>
              <p id="vipPlayerEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="61110d0018041321040c00080d4f020e0c">[email&#160;protected]</a></p>
            </div>
          </div>
          <div class="unified-card-header-actions">
            <button class="flip-toggle-btn" id="vipToProfilingFlipBtn" onclick="flipToProfilingCard()" style="display:none">
              üëë View Profiling
            </button>
            <button class="unified-card-delete" id="vipDeletePlayerBtn" onclick="deletePlayerFromModal()" style="background:#ef4444;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
              üóëÔ∏è DELETE
            </button>
            <button class="unified-card-close" onclick="closeUnifiedModal()">√ó</button>
          </div>
        </div>
        <div class="unified-card-body">
          <div style="display:flex;flex-direction:column;gap:24px">
            <div>
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0 0 16px 0">üìä Key Metrics</h3>
              <div id="vipPlayerMetrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px"></div>
            </div>
            <div>
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0 0 16px 0">üìã Detailed Information</h3>
              <div id="vipPlayerDetails" style="overflow:auto;border:1px solid var(--border);border-radius:8px"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profiling Side (Back) -->
      <div class="flip-card-side flip-card-back">
        <div class="unified-card-header">
          <div class="unified-card-title-area">
            <div class="unified-card-avatar">üëë</div>
            <div class="unified-card-title-text">
              <h2 id="profilingPlayerName">Player Name</h2>
              <p id="profilingPlayerEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dbabb7baa2bea99bbeb6bab2b7f5b8b4b6">[email&#160;protected]</a></p>
            </div>
          </div>
          <div class="unified-card-header-actions">
            <button class="flip-toggle-btn" id="profilingToVIPFlipBtn" onclick="flipToVIPCard()">
              üìä View VIP Data
            </button>
            <button class="unified-card-delete" id="profilingDeletePlayerBtn" onclick="deletePlayerFromModal()" style="background:#ef4444;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
              üóëÔ∏è DELETE
            </button>
            <button class="unified-card-close" onclick="closeUnifiedModal()">√ó</button>
          </div>
        </div>
        <div class="unified-card-body" id="profilingCardBody">
          <!-- Profiling content will be inserted here -->
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Filter Overlays -->
<div class="filter-overlay" id="depositFilterOverlay" onclick="closeDepositFilterSidebar()"></div>
<div class="filter-overlay" id="retentionFilterOverlay" onclick="closeRetentionFilterSidebar()"></div>

<!-- Deposit Filter Sidebar -->
<div class="filter-sidebar" id="depositFilterSidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <span>üîç</span>
      <span>Deposit Filters</span>
    </div>
    <div class="sidebar-subtitle">Filter conversion data</div>
    <button class="close-sidebar-btn" onclick="closeDepositFilterSidebar()">√ó</button>
  </div>
  
  <div class="sidebar-body">
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üìã</span>
        <span>Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search types..." id="depositTypeSearch">
      <div class="sidebar-filter-list" id="depositVipTypeFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üë§</span>
        <span>Manager</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search managers..." id="depositManagerSearch">
      <div class="sidebar-filter-list" id="depositManagerFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üéØ</span>
        <span>Traffic Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search traffic..." id="depositTrafficSearch">
      <div class="sidebar-filter-list" id="depositTrafficFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üåç</span>
        <span>Country</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search countries..." id="depositCountrySearch">
      <div class="sidebar-filter-list" id="depositCountryFilters"></div>
    </div>
  </div>
  
  <div class="sidebar-footer">
    <button class="sidebar-btn-apply" onclick="applyDepositFilters()">‚úÖ Apply Filters</button>
    <button class="sidebar-btn-clear" onclick="clearDepositFilters()">üîÑ Clear All</button>
  </div>
</div>

<!-- Retention Filter Sidebar -->
<div class="filter-sidebar" id="retentionFilterSidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <span>üîç</span>
      <span>Retention Filters</span>
    </div>
    <div class="sidebar-subtitle">Filter cohort data</div>
    <button class="close-sidebar-btn" onclick="closeRetentionFilterSidebar()">√ó</button>
  </div>
  
  <div class="sidebar-body">
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üìã</span>
        <span>Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search types..." id="retentionTypeSearch">
      <div class="sidebar-filter-list" id="retentionVipTypeFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üë§</span>
        <span>Manager</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search managers..." id="retentionManagerSearch">
      <div class="sidebar-filter-list" id="retentionManagerFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üéØ</span>
        <span>Traffic Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search traffic..." id="retentionTrafficSearch">
      <div class="sidebar-filter-list" id="retentionTrafficFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üåç</span>
        <span>Country</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search countries..." id="retentionCountrySearch">
      <div class="sidebar-filter-list" id="retentionCountryFilters"></div>
    </div>
  </div>
  
  <div class="sidebar-footer">
    <button class="sidebar-btn-apply" onclick="applyRetentionFilters()">‚úÖ Apply Filters</button>
    <button class="sidebar-btn-clear" onclick="clearRetentionFilters()">üîÑ Clear All</button>
  </div>
</div>

</body>
</html>
