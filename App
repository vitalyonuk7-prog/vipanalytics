<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"><base target="_top">
<title>Slotornado Analytics</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå™Ô∏è</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<!-- Font Awesome –¥–ª—è —ñ–∫–æ–Ω–æ–∫ —Å–æ—Ü–º–µ—Ä–µ–∂ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --surface: #ffffff;
  --surface-elevated: #f8fafc;
  --border: #e2e8f0;
  --text-primary: #1e293b;
  --text-muted: #64748b;
  --accent-primary: #667eea;
  --accent-danger: #ef4444;
}

canvas{z-index:0}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f7fa;color:#2d3748;height:100vh;margin:0;overflow-x:hidden}

#splash{position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:1;transition:opacity 0.5s}
#splash.hide{opacity:0;pointer-events:none}
.splash-content{text-align:center}
.splash-logo{font-size:48px;font-weight:900;margin-bottom:20px;color:#fff}
.splash-spinner{width:60px;height:60px;margin:0 auto 20px;border:5px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes saveGlow{0%,100%{box-shadow:0 0 8px rgba(102,126,234,0.3)}50%{box-shadow:0 0 20px rgba(102,126,234,0.6)}}
@keyframes marqueeScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.splash-text{font-size:16px;color:rgba(255,255,255,0.9)}

.container{display:flex;height:100vh}
.sidebar{width:280px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;flex-shrink:0;box-shadow:2px 0 10px rgba(0,0,0,0.02);transition:width 0.3s cubic-bezier(0.4,0,0.2,1)}
.sidebar.collapsed{width:70px}
.sidebar.collapsed .player-search-container{opacity:0;height:0;overflow:hidden;padding:0;border:none}
.sidebar.collapsed .profiling-btn{margin:6px auto !important;padding:0 !important;display:flex !important;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px !important;position:relative}
.sidebar.collapsed .profiling-btn > div{justify-content:center}
.sidebar.collapsed .sidebar-btn-label{display:none !important}
.sidebar.collapsed .profiling-btn > div > span{font-size:22px !important;margin:0}
.sidebar.collapsed .sidebar-bottom-btn:hover::after{content:attr(data-tooltip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#1e293b;color:#fff;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;z-index:1000;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.sidebar.collapsed .sidebar-bottom-btn:hover::before{content:'';position:absolute;left:calc(100% + 4px);top:50%;transform:translateY(-50%);border:6px solid transparent;border-right-color:#1e293b;z-index:1000;pointer-events:none}
.sidebar.collapsed .logo{opacity:1;font-size:28px;overflow:visible;text-align:center;padding:0;white-space:nowrap}
.sidebar.collapsed .logo .logo-text{display:none}
.sidebar.collapsed .subtitle{display:none}
.sidebar.collapsed .nav-item span:not(.nav-icon){opacity:0;width:0;overflow:hidden;white-space:nowrap;transition:opacity 0.2s,width 0.2s}
.sidebar.collapsed .nav-item{justify-content:center;padding:14px;position:relative}
.sidebar.collapsed .nav-item .nav-icon{font-size:22px}
.sidebar.collapsed .nav-item:hover::after{content:attr(data-tooltip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#1e293b;color:#fff;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;z-index:1000;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.sidebar.collapsed .nav-item:hover::before{content:'';position:absolute;left:calc(100% + 4px);top:50%;transform:translateY(-50%);border:6px solid transparent;border-right-color:#1e293b;z-index:1000;pointer-events:none}
.sidebar.collapsed .sidebar-submenu{display:none !important}
.sidebar.collapsed .sidebar-submenu-toggle{display:none}
.sidebar.collapsed .sidebar-nav{padding:8px}
.sidebar.collapsed .nav-item .dash-type-count{display:none}
.sidebar-toggle{position:absolute;top:20px;left:calc(100% + 8px);width:30px;height:30px;background:#667eea;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:14px;font-weight:700;box-shadow:0 2px 8px rgba(102,126,234,0.4);transition:all 0.2s;z-index:100}
.sidebar-toggle:hover{transform:scale(1.15);background:#764ba2;box-shadow:0 4px 12px rgba(118,75,162,0.5)}
.sidebar-toggle:active{transform:scale(1.05)}
.sidebar.collapsed .sidebar-bottom-section{padding-top:8px;border-top:1px solid #e2e8f0}
/* Profiling search suggestions */
.prof-search-suggest{position:absolute;top:100%;left:0;right:0;z-index:9999;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;margin-top:4px;max-height:280px;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,0.15);display:none}
.prof-search-suggest.open{display:block}
.prof-search-suggest-item{padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.1s;border-bottom:1px solid #f8fafc}
.prof-search-suggest-item:last-child{border-bottom:none}
.prof-search-suggest-item:hover{background:rgba(102,126,234,0.06)}
.prof-search-suggest-item .pss-name{font-weight:700;font-size:13px;color:#1e293b}
.prof-search-suggest-item .pss-email{font-size:11px;color:#94a3b8}
.prof-search-suggest-item .pss-type{padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;background:rgba(102,126,234,0.1);color:#667eea;margin-left:auto}
.sidebar-header{padding:24px;border-bottom:1px solid #e2e8f0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);position:relative;transition:padding 0.3s}
.sidebar.collapsed .sidebar-header{padding:20px 0}
.logo{font-size:24px;font-weight:900;margin-bottom:6px;color:#fff;cursor:pointer;user-select:none}
.subtitle{font-size:11px;color:rgba(255,255,255,0.9);text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
.sidebar-nav{padding:16px;flex:1;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;margin-bottom:6px;border-radius:8px;cursor:pointer;color:#64748b;font-weight:600;transition:all 0.2s;font-size:14px}
.nav-item:hover{background:#f1f5f9;color:#475569}
.nav-item.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.nav-icon{font-size:18px}
.sidebar-submenu{display:none;flex-direction:column;margin:0 0 8px 0;padding:0;background:transparent}.sidebar-submenu.open{display:flex}.sidebar-submenu-item{display:flex;align-items:center;gap:10px;padding:10px 16px 10px 48px;color:#94a3b8;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;border-radius:6px;margin:0 8px}.sidebar-submenu-item:hover{background:rgba(102,126,234,0.08);color:#667eea}.sidebar-submenu-item.active{background:rgba(102,126,234,0.12);color:#667eea;font-weight:600}.sidebar-submenu-item-icon{font-size:14px}.sidebar-submenu-toggle{margin-left:auto;font-size:10px;color:#94a3b8;transition:transform 0.3s ease;display:inline-block}.sidebar-submenu-toggle.open{transform:rotate(180deg)}.sidebar-submenu-toggle:hover{color:#667eea}

.main-wrapper{flex:1;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden}
.filters-bar{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px 32px;border-bottom:2px solid rgba(255,255,255,0.3);box-shadow:0 2px 10px rgba(0,0,0,0.1);position:relative;overflow:visible}
.filters-grid{display:grid;grid-template-columns:repeat(5,1fr) auto;gap:12px;align-items:end;position:relative}
.filter-group{background:rgba(255,255,255,0.15);padding:12px;border-radius:8px;backdrop-filter:blur(10px)}
.filter-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;opacity:0.9;color:#fff}
.filter-select{position:relative}
.filter-chip{padding:8px 16px;background:rgba(255,255,255,0.25);border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;border:2px solid transparent;color:#fff;min-height:36px;display:flex;align-items:center;justify-content:center}
.filter-chip:hover{background:rgba(255,255,255,0.35)}
.filter-chip.selected{background:#fff;color:#667eea;border-color:#fff}
.filter-dropdown{position:relative;min-width:200px;z-index:100}
.filter-dropdown-toggle{padding:10px 16px;background:rgba(255,255,255,0.95);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid rgba(255,255,255,0.3);color:#1e293b;display:flex;align-items:center;justify-content:space-between;gap:8px;transition:all 0.2s}
.filter-dropdown-toggle:hover{background:#fff;border-color:#667eea}
.filter-dropdown-toggle.active{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}
.filter-dropdown-toggle .count{background:#667eea;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700}
.filter-dropdown-menu{position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-height:300px;overflow-y:auto;overflow-x:hidden;z-index:9999;display:none;padding:8px}
.filter-search-input{width:100%;padding:8px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;margin-bottom:8px;outline:none;transition:border-color 0.2s}
.filter-search-input:focus{border-color:#667eea}
.filter-items-container{max-height:240px;overflow-y:auto}
.filter-dropdown-menu.open{display:block}
.filter-dropdown-item{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:8px;transition:background 0.2s;font-size:13px;color:#1e293b}
.filter-dropdown-item:hover{background:#f1f5f9}
.filter-checkbox{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.filter-checkbox.checked{background:#667eea;border-color:#667eea;color:#fff}
.filter-checkbox.checked::before{content:'‚úì';font-size:12px;font-weight:700}
.filter-chip input{display:none}
.filter-actions{display:flex;flex-direction:column;gap:8px}
.btn-filter{padding:12px 24px;border-radius:10px;border:2px solid #fff;background:#fff;color:#667eea;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap;min-height:44px}
.btn-filter:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,255,255,0.3)}
.btn-clear{background:rgba(255,255,255,0.15);color:#fff;border-color:rgba(255,255,255,0.5)}
.btn-clear:hover{background:rgba(255,255,255,0.25)}

.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:40px 0 !important;background:#f5f7fa;min-height:0;width:100%;box-sizing:border-box;max-width:1800px;margin:0 auto}
.content{display:none;width:100%;box-sizing:border-box;padding:0 80px !important}
.content.active{display:block;width:100%;box-sizing:border-box;padding:0 80px !important}
h1{font-size:32px;margin-bottom:8px;color:#1e293b;font-weight:900}
.desc{color:#64748b;margin-bottom:24px;font-size:15px}

.chart-section{margin-bottom:24px;background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.chart-title{font-size:17px;font-weight:800;color:#1e293b}
.metric-selector{display:flex;gap:8px;flex-wrap:wrap}
.metric-btn{padding:8px 16px;border-radius:10px;border:1.5px solid #e2e8f0;background:#fff;color:#64748b;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s}
.metric-btn:hover{border-color:#667eea;color:#667eea;background:#f5f3ff}
.metric-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(102,126,234,0.25)}
.chart-container{height:380px;position:relative;z-index:1}

.table-wrap{overflow:auto;max-height:calc(100vh - 400px);border-radius:16px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:16px;text-align:center;border-right:1px solid #f1f5f9;border-bottom:1px solid #f1f5f9;white-space:nowrap}
th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;position:sticky;top:0;z-index:10;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}
th.row-header{left:0;z-index:20;text-align:left;min-width:160px}
th:first-child{border-top-left-radius:14px}
th:last-child{border-top-right-radius:14px}
td.row-header{position:sticky;left:0;background:linear-gradient(90deg,#fff 0%,#fff 90%,rgba(255,255,255,0));z-index:5;font-weight:700;text-align:left;color:#667eea;border-right:2px solid rgba(102,126,234,0.15)}
.cell{display:inline-block;padding:10px 14px;border-radius:10px;min-width:100px;cursor:pointer;transition:all 0.2s;font-weight:600;border:1px solid transparent}
.cell:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.15);border-color:#c7d2fe}
.count{font-size:17px;font-weight:800}
.pct{font-size:11px;opacity:0.7;margin-left:4px}
.filtered-out{opacity:0.3;pointer-events:none}

.kpi-tabs{display:flex;gap:8px;margin-bottom:24px;padding:10px;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);flex-wrap:wrap}
.kpi-tab{padding:12px 24px;border-radius:12px;border:2px solid transparent;background:#f8fafc;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s}
.kpi-tab:hover{background:#eef2ff;color:#667eea}
.kpi-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent;box-shadow:0 4px 12px rgba(102,126,234,0.3)}
.kpi-tab.compare-tab{background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(5,150,105,0.08));border:2px solid rgba(16,185,129,0.2)}
.kpi-tab.compare-tab:hover{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.15));border-color:rgba(16,185,129,0.3)}
.kpi-tab.compare-tab.active{background:linear-gradient(135deg,#10b981,#059669)!important;border-color:transparent!important;box-shadow:0 4px 14px rgba(16,185,129,0.4)!important}
.kpi-layout{display:grid;grid-template-columns:300px 1fr;gap:24px;min-height:0}
.kpi-sidebar{background:#fff;border-radius:16px;padding:24px;overflow-y:auto;box-shadow:0 2px 12px rgba(0,0,0,0.06);max-height:calc(100vh - 260px);position:sticky;top:0}
.kpi-main{display:flex;flex-direction:column;gap:24px;min-width:0}
.period-header{font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#667eea;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.period-header::before{content:'';width:4px;height:18px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:2px}
.month-group{margin-bottom:16px;border-bottom:1px solid #f1f5f9;padding-bottom:16px}
.month-group:last-child{border-bottom:none}
.month-header{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;cursor:pointer;transition:all 0.2s;margin-bottom:8px;background:#f8fafc}
.month-header:hover{background:#eef2ff;transform:translateX(4px)}
.month-header input[type="checkbox"]{margin:0;cursor:pointer;width:20px;height:20px;accent-color:#667eea}
.month-label{flex:1;font-weight:700;color:#1e293b;font-size:15px;cursor:pointer}
.month-count{font-size:11px;color:#667eea;font-weight:700;background:#eef2ff;padding:4px 12px;border-radius:12px}
.weeks-list{margin-left:28px;display:none;margin-top:8px}
.weeks-list.open{display:block}
.week-item{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;transition:all 0.2s;margin:4px 0;background:#fff;border:1px solid #f1f5f9}
.week-item:hover{background:#f8fafc;border-color:#e0e7ff;transform:translateX(4px)}
.week-item input[type="checkbox"]{margin:0;cursor:pointer;width:16px;height:16px;accent-color:#667eea}
.week-label{font-size:13px;color:#475569;cursor:pointer;flex:1}
.kpi-chart-wrap{background:#fff;border-radius:16px;padding:28px;box-shadow:0 2px 12px rgba(0,0,0,0.06);flex-shrink:0}
.kpi-table-wrap{background:#fff;border-radius:16px;padding:28px;box-shadow:0 2px 12px rgba(0,0,0,0.06);display:flex;flex-direction:column;min-height:0}
.metrics-filter{margin-bottom:20px;padding:16px;background:#f8fafc;border-radius:14px;border:1px solid #e2e8f0;transition:all 0.3s}
.metrics-filter.collapsed{padding:0;max-height:48px;overflow:hidden}
.metrics-filter.collapsed .metrics-grid{display:none}
.metrics-filter-header{font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:10px}
.metrics-filter-header:hover{background:#fff;border-radius:8px}
.metrics-filter-toggle{font-size:16px;transition:transform 0.3s}
.metrics-filter.collapsed .metrics-filter-toggle{transform:rotate(-90deg)}
.selected-metric-display{padding:22px 30px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:16px;margin-bottom:24px;box-shadow:0 4px 16px rgba(102,126,234,0.25)}
.selected-metric-label{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;opacity:0.85;margin-bottom:6px;font-weight:700}
.selected-metric-value{font-size:30px;font-weight:900;letter-spacing:-0.5px}
.compare-controls{display:flex;align-items:center;justify-content:center;gap:28px;margin-bottom:28px;padding:28px;background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.06)}
.compare-selector{display:flex;flex-direction:column;gap:8px;min-width:240px}
.compare-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1px}
.compare-dropdown{padding:14px 18px;border:2px solid #e2e8f0;border-radius:12px;font-size:15px;font-weight:600;color:#1e293b;background:#fff;cursor:pointer;transition:all 0.2s;width:100%}
.compare-dropdown:hover{border-color:#667eea}
.compare-dropdown:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}
.compare-vs{font-size:28px;font-weight:900;color:#667eea;display:flex;align-items:center;padding:0 20px}
.heatmap-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;padding:8px 12px;border-radius:8px;background:#f8fafc;border:2px solid #e2e8f0;transition:all 0.2s}
.heatmap-toggle:hover{background:#f1f5f9;border-color:#cbd5e1}
.heatmap-toggle input[type="checkbox"]{width:40px;height:20px;appearance:none;background:#cbd5e1;border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s}
.heatmap-toggle input[type="checkbox"]:checked{background:#667eea}
.heatmap-toggle input[type="checkbox"]::before{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:2px;left:2px;transition:left 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.heatmap-toggle input[type="checkbox"]:checked::before{left:22px}
.toggle-label{font-size:13px;font-weight:600;color:#64748b}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-top:8px}
.metric-check-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:all 0.2s;border:1px solid transparent}
.metric-check-item:hover{background:#fff;border-color:#e2e8f0}
.metric-check-item input{cursor:pointer;accent-color:#667eea}
.metric-check-item label{cursor:pointer;font-size:13px;color:#475569;flex:1;font-weight:600}

/* Analytics Section */
/* TOTAL Section */
.dash-total-section{background:#fff;border:1px solid #e2e8f0;border-radius:18px;padding:24px;margin-bottom:20px}
.dash-total-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.dash-total-title{font-size:18px;font-weight:900;color:#1e293b}
.dash-total-count{font-size:13px;color:#64748b;font-weight:600;background:#f1f5f9;padding:4px 14px;border-radius:20px}
.dash-total-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px}
.dash-total-card{display:flex;align-items:center;gap:14px;padding:16px 18px;background:#f8fafc;border-radius:14px;cursor:pointer;transition:all 0.2s;border:1px solid #e2e8f0}
.dash-total-card:hover{background:#eef2ff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.1)}
.dash-total-card-icon{font-size:28px}
.dash-total-card-info{display:flex;flex-direction:column}
.dash-total-card-count{font-size:28px;font-weight:900;line-height:1.1}
.dash-total-card-name{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
.dash-total-pies-title{font-size:14px;font-weight:800;color:#64748b;margin-bottom:14px;text-transform:uppercase;letter-spacing:0.5px}
/* Improved Modals */
.modal{position:fixed;inset:0;background:rgba(15,23,42,0.6);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:10001;padding:20px;overflow:auto}
.modal.open{display:flex}
.modal-card{background:#fff;border-radius:20px;width:min(1400px,96vw);max-height:92vh;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.25);animation:modalSlideIn 0.25s ease}
@keyframes modalSlideIn{from{opacity:0;transform:translateY(20px) scale(0.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid #e2e8f0;background:linear-gradient(135deg,#1e293b,#334155);border-radius:20px 20px 0 0}
.modal-title{font-size:20px;font-weight:800;color:#fff}
.modal-tools{display:flex;gap:10px}
.modal-body{flex:1;overflow:auto;padding:24px 28px}
.btn-close{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px 18px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:13px}
.btn-close:hover{background:rgba(255,255,255,0.2)}
.btn-create{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:8px 18px;border-radius:8px;cursor:pointer;font-weight:700;transition:all 0.2s;box-shadow:0 2px 8px rgba(102,126,234,0.3);font-size:13px}
.btn-create:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
.btn-create:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.metric-breakdown{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.metric-breakdown-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:14px;padding:18px;text-align:center}
.metric-breakdown-label{font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.metric-breakdown-value{font-size:24px;font-weight:900;color:#1e293b}
.metric-breakdown-subtitle{font-size:11px;color:#94a3b8;margin-top:4px}
.player-row{display:grid;grid-template-columns:2fr 1fr 1fr 1.5fr 1fr 1fr;gap:12px;padding:10px 16px;border-bottom:1px solid #f1f5f9;font-size:13px;transition:all 0.15s}
.player-row:hover{background:#eef2ff}
.players-list{max-height:500px;overflow:auto;border:1px solid #e2e8f0;border-radius:14px;background:#fff}
.analytics-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #e2e8f0}
.analytics-title{font-size:16px;font-weight:700;margin-bottom:16px;color:#1e293b}
.pies-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.pie-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;display:flex;gap:16px;align-items:center}
.pie-chart{width:150px;height:150px;flex-shrink:0}
.pie-legend{flex:1;font-size:12px}
.legend-item{display:flex;align-items:center;gap:10px;margin:6px 0;padding:6px;border-radius:6px}
.legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.players-section{margin-bottom:20px}
.section-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0}
.section-title{font-size:18px;font-weight:800;color:#1e293b}
.section-count{margin-left:auto;font-size:20px;font-weight:900;color:#667eea}
.player-row:last-child{border-bottom:none}
.player-email{color:#667eea;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px}
.player-email:hover{text-decoration:underline}
.copy-icon{opacity:0;transition:opacity 0.2s;cursor:pointer;font-size:14px}
.player-email:hover .copy-icon{opacity:1}
.player-link{color:#667eea;text-decoration:none;font-weight:600}
.player-link:hover{text-decoration:underline}
.err{color:#ef4444;padding:20px;text-align:center;font-size:14px}
.toast{position:fixed;bottom:24px;right:24px;background:#667eea;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(102,126,234,0.4);font-weight:600;font-size:14px;opacity:0;transform:translateY(20px);transition:all 0.3s;z-index:10000}
.toast.show{opacity:1;transform:translateY(0)}
#top-loader{position:fixed;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transform-origin:left;transition:transform 0.3s ease;z-index:10000}#top-loader.loading{animation:loader-progress 2s ease-in-out infinite}@keyframes loader-progress{0%{transform:scaleX(0)}50%{transform:scaleX(0.7)}100%{transform:scaleX(1);opacity:0}}
.vip-tabs-wrap{display:flex;gap:12px;margin:24px 0;padding:8px;background:#f8fafc;border-radius:12px}.vip-tab{padding:12px 24px;background:#fff;border:2px solid transparent;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;color:#64748b}.vip-tab:hover{border-color:#667eea;color:#667eea}.vip-tab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-color:transparent}
.dash-type-tabs{display:flex;gap:8px;margin-bottom:8px;padding:6px;background:#f1f5f9;border-radius:12px;flex-wrap:wrap}
.dash-type-tab{padding:10px 20px;background:#fff;border:2px solid transparent;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;color:#64748b;display:flex;align-items:center;gap:8px}
.dash-type-tab:hover{border-color:#667eea;color:#667eea}
.dash-type-tab.active{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-color:transparent;box-shadow:0 2px 8px rgba(16,185,129,0.3)}
.dash-type-tab .dash-type-count{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:800;background:rgba(255,255,255,0.2)}
.dash-type-tab:not(.active) .dash-type-count{background:rgba(100,116,139,0.1);color:#64748b}
.vip-active-filters{display:none;margin:0 0 20px 0;padding:12px 16px;background:#f0f4ff;border:1px solid #c7d2fe;border-radius:8px;font-size:13px}.vip-active-filters.visible{display:block}.vip-active-filters-title{font-weight:700;color:#4338ca;margin-bottom:8px;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}.vip-active-filters-list{display:flex;flex-wrap:wrap;gap:8px}.vip-filter-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:#fff;border:1px solid #818cf8;border-radius:6px;color:#4338ca;font-size:12px;font-weight:600}.vip-filter-tag-label{color:#64748b;font-weight:500}.vip-filter-tag-remove{cursor:pointer;color:#94a3b8;font-weight:700;transition:color 0.2s}.vip-filter-tag-remove:hover{color:#ef4444}
.vip-manager-selector{display:flex;align-items:center;gap:12px;margin:0 0 20px 0;padding:12px 16px;background:#fff;border:1px solid #e2e8f0;border-radius:8px}.vip-manager-label{font-weight:600;color:#64748b;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}.vip-manager-dropdown{flex:1;max-width:300px;padding:8px 12px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;font-weight:500;color:#1e293b;cursor:pointer;transition:all 0.2s;background:#fff}.vip-manager-dropdown:hover{border-color:#667eea}.vip-manager-dropdown:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.vip-manager-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:6px;font-size:12px;font-weight:600}.vip-manager-clear{padding:6px 12px;background:#f1f5f9;color:#64748b;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s}.vip-manager-clear:hover{background:#e2e8f0;color:#1e293b}
.period-tabs-wrap{display:flex;gap:8px;margin:16px 0;padding:6px;background:#f1f5f9;border-radius:10px;justify-content:center;max-width:560px}.period-tab{background:#fff;border:2px solid #e2e8f0;padding:6px 14px;font-size:12px;font-weight:600;color:#64748b;cursor:pointer;transition:all 0.2s;border-radius:6px;white-space:nowrap}.period-tab:hover{border-color:#667eea;color:#667eea}.period-tab.active{background:#667eea;border-color:#667eea;color:#fff;box-shadow:0 2px 6px rgba(102,126,234,0.3)}
.vip-filter-toggle{position:fixed;top:80px;right:20px;z-index:999;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 16px;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(102,126,234,0.4);transition:all 0.3s;font-size:20px}.vip-filter-toggle:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
.vip-filter-badge{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;padding:0 6px;border:2px solid #fff;box-shadow:0 2px 8px rgba(239,68,68,0.4)}
.vip-filter-sidebar{
  position:fixed;
  top:0;
  right:-400px;
  width:380px;
  height:100vh;
  background:#fff;
  box-shadow:-4px 0 24px rgba(0,0,0,0.3);
  z-index:10000;
  transition:right 0.3s ease;
  overflow-y:auto;
  overflow-x:hidden;
}
.vip-filter-sidebar.open{
  right:0;
}
.vip-filter-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  display:none;
  opacity:0;
  transition:opacity 0.3s;
}
.vip-filter-overlay.open{
  display:block;
  opacity:1;
}.vip-filter-header{position:sticky;top:0;background:#fff;padding:20px;border-bottom:2px solid #e2e8f0;z-index:10}.vip-filter-title{font-size:18px;font-weight:700;color:#1e293b;margin-bottom:4px}.vip-filter-subtitle{font-size:13px;color:#64748b}.vip-filter-close{position:absolute;top:20px;right:20px;background:none;border:none;font-size:24px;color:#64748b;cursor:pointer;padding:4px 8px;line-height:1}.vip-filter-close:hover{color:#ef4444}.vip-filter-body{padding:20px}.vip-filter-section{margin-bottom:24px}.vip-filter-section-title{font-size:14px;font-weight:600;color:#1e293b;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}.vip-filter-group{margin-bottom:16px}.vip-filter-group-label{font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;display:block}.vip-filter-items{max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;padding:8px}.vip-filter-item{display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:all 0.2s}.vip-filter-item:hover{background:#f8fafc}.vip-filter-checkbox{width:18px;height:18px;border:2px solid #cbd5e1;border-radius:4px;margin-right:10px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.vip-filter-checkbox.checked{background:#667eea;border-color:#667eea}.vip-filter-checkbox.checked::after{content:'‚úì';color:#fff;font-size:12px;font-weight:bold}.vip-filter-item-text{font-size:13px;color:#1e293b;flex:1}.vip-filter-item-count{font-size:11px;color:#64748b;background:#f1f5f9;padding:2px 8px;border-radius:10px}.vip-filter-search{width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;margin-bottom:8px}.vip-filter-search:focus{outline:none;border-color:#667eea}.vip-filter-actions{position:sticky;bottom:0;background:#fff;padding:20px;border-top:2px solid #e2e8f0}.vip-filter-actions button{width:100%;padding:12px;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;background:#f1f5f9;color:#64748b}.vip-filter-actions button:hover{background:#e2e8f0}
#vip-content{width:100%;box-sizing:border-box}
/* Dashboard Compact Hero Bar */
.dash-hero2{display:flex;align-items:center;gap:0;padding:16px 28px;background:linear-gradient(135deg,#1e293b,#334155);border-radius:16px;margin:20px 0;color:#fff;flex-wrap:wrap}
.dash-hero2-left{display:flex;align-items:baseline;gap:12px}
.dash-hero2-num{font-size:48px;font-weight:900;background:linear-gradient(135deg,#a5b4fc,#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.dash-hero2-lbl{font-size:14px;color:rgba(255,255,255,0.5);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.dash-hero2-sep{width:1px;height:40px;background:rgba(255,255,255,0.15);margin:0 24px}
.dash-hero2-inout{display:flex;align-items:center;gap:12px}
.dash-hero2-inout-lbl{font-size:11px;color:rgba(255,255,255,0.4);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.dash-hero2-inout-val{font-size:22px;font-weight:900}
.dash-hero2-mgrs{display:flex;gap:16px;margin-left:auto;flex-wrap:wrap}
.dash-hero2-mgr{font-size:13px;color:rgba(255,255,255,0.7);padding:6px 14px;background:rgba(255,255,255,0.07);border-radius:8px;white-space:nowrap}
.dash-hero2-mgr strong{color:#fff;font-size:16px;margin-right:4px}
@media(max-width:900px){.dash-hero2-sep{display:none}.dash-hero2{gap:16px}.dash-hero2-mgrs{margin-left:0;width:100%}}
/* Quick Stats Strip */
.dash-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.dash-stat{background:#fff;border:1px solid #e2e8f0;border-radius:18px;padding:22px 24px;transition:all 0.25s;cursor:pointer;position:relative;overflow:hidden}
.dash-stat:hover{border-color:#c7d2fe;box-shadow:0 8px 24px rgba(102,126,234,0.1);transform:translateY(-3px)}
.dash-stat-icon{font-size:28px;margin-bottom:12px}
.dash-stat-val{font-size:28px;font-weight:900;color:#1e293b;margin-bottom:4px}
.dash-stat-name{font-size:12px;color:#94a3b8;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
.dash-stat-bar{position:absolute;bottom:0;left:0;right:0;height:4px;background:#f1f5f9;border-radius:0 0 18px 18px;overflow:hidden}
.dash-stat-bar-fill{height:100%;border-radius:0 0 0 18px;transition:width 0.6s ease}
@media(max-width:1100px){.dash-stats{grid-template-columns:repeat(2,1fr)}}
.dash-section{background:#f8fafc;border:1px solid #e2e8f0;border-radius:20px;padding:24px;overflow:hidden}
.dash-section-title{font-size:16px;font-weight:800;color:#1e293b;margin-bottom:20px;display:flex;align-items:center;gap:10px}
/* Pie Section */
.dash-pies{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.dash-pies{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.dash-pies{grid-template-columns:1fr}}
.dash-pie-card{padding:20px;background:#fff;border-radius:16px;text-align:center;cursor:pointer;transition:all 0.2s;border:1px solid #e2e8f0}
.dash-pie-card:hover{border-color:#c7d2fe;box-shadow:0 6px 20px rgba(102,126,234,0.1);transform:translateY(-2px)}
.dash-pie-title{font-size:13px;font-weight:700;color:#64748b;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
.dash-pie-canvas{height:160px;position:relative}
.dash-pie-legend{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:10px}
.dash-pie-legend-item{font-size:11px;color:#475569;font-weight:600;display:flex;align-items:center;gap:4px}
.dash-pie-legend-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0}
/* Old vip-card compat */
.vip-cards-grid{display:none}
.vip-card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;transition:all 0.3s ease;box-sizing:border-box;cursor:pointer}.vip-card:hover{border-color:#667eea;transform:translateY(-4px);box-shadow:0 12px 24px rgba(102,126,234,0.15)}
.vip-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}.vip-card-icon{font-size:32px}.vip-card-title{font-size:16px;font-weight:600;color:#64748b}.vip-card-value{font-size:48px;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:12px 0}.vip-card-subtitle{font-size:14px;color:#94a3b8;margin-bottom:16px}.vip-card-sum{font-size:20px;font-weight:600;color:#1e293b;padding-top:16px;border-top:2px solid #f1f5f9}
#vip-metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-top:32px;width:100%;box-sizing:border-box}


/* Metric Modal Table */
.metric-table-container{overflow-x:auto;margin-top:20px}
.metric-table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border-radius:8px;overflow:hidden}
.metric-table thead{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.metric-table th{padding:12px 16px;text-align:left;font-weight:700;cursor:pointer;user-select:none;white-space:nowrap}
.metric-table th.sorted-asc::after{content:" ‚ñ≤";opacity:0.7}
.metric-table th.sorted-desc::after{content:" ‚ñº";opacity:0.7}
.metric-table td{padding:10px 16px;border-bottom:1px solid #e2e8f0;color:#1e293b}
.metric-table tbody tr:hover{background:#f8fafc}
.metric-table tbody tr:last-child td{border-bottom:none}

/* Metric breakdown cards */
.metric-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.metric-breakdown-card{background:#fff;border-radius:12px;padding:20px;border:2px solid #e2e8f0;text-align:center}
.metric-breakdown-label{font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.metric-breakdown-value{font-size:28px;font-weight:900;color:#1e293b}
.metric-breakdown-subtitle{font-size:11px;color:#94a3b8;margin-top:4px}

/* Responsive padding */
@media (max-width: 1400px) {
  .content, .content.active { padding: 0 60px !important; }
}

@media (max-width: 1024px) {
  .content, .content.active { padding: 0 40px !important; }
}

@media (max-width: 768px) {
  .content, .content.active { padding: 0 24px !important; }
}

@media (max-width: 480px) {
  .content, .content.active { padding: 0 16px !important; }
}

/* ============================================
   Social Media Icons - Brand Colors
   ============================================ */
a[title="Whatsapp"]:hover, a[title="WhatsApp"]:hover {
  background: #25D366 !important;
}

a[title="Telegram"]:hover {
  background: #0088cc !important;
}

a[title="Signal"]:hover {
  background: #3a76f0 !important;
}

a[title="Messenger"]:hover {
  background: #0084ff !important;
}

a[title="Facebook"]:hover {
  background: #1877f2 !important;
}

a[title="Instagram"]:hover {
  background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%) !important;
}

a[title="Intercom"]:hover {
  background: #0085ff !important;
}

a[title="Viber"]:hover {
  background: #665CAC !important;
}

a[title="WeChat"]:hover, a[title="Wechat"]:hover {
  background: #09B83E !important;
}

a[title="Twitter"]:hover {
  background: #1DA1F2 !important;
}

a[title="X"]:hover {
  background: #000000 !important;
}

a[title="LinkedIn"]:hover, a[title="Linkedin"]:hover {
  background: #0077b5 !important;
}

a[title="TikTok"]:hover, a[title="Tiktok"]:hover {
  background: #000000 !important;
}

a[title="Snapchat"]:hover {
  background: #FFFC00 !important;
  color: #000 !important;
}

a[title="Discord"]:hover {
  background: #5865F2 !important;
}

a[title="Skype"]:hover {
  background: #00aff0 !important;
}

a[title="Reddit"]:hover {
  background: #FF4500 !important;
}

a[title="YouTube"]:hover, a[title="Youtube"]:hover {
  background: #FF0000 !important;
}

a[title="Twitch"]:hover {
  background: #9146FF !important;
}

a[title="Pinterest"]:hover {
  background: #E60023 !important;
}

a[title="VK"]:hover {
  background: #0077FF !important;
}

a[title="Line"]:hover, a[title="LINE"]:hover {
  background: #00B900 !important;
}

/* ============================================
   Big Icons [BICON] - Brand Colors
   ============================================ */
a[title="BO"]:hover, a[title="Bo"]:hover, a[title="BackOffice"]:hover, a[title="Back Office"]:hover {
  background: #4CAF50 !important;
}

a[title="JIRA"]:hover, a[title="Jira"]:hover {
  background: #0052CC !important;
}

/* Icon size adjustments */
.fa-brands, .fas {
  line-height: 1;
}

/* ===== Unified Flip Card Modal ===== */
.unified-flip-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.unified-flip-modal.show {
  display: flex;
}

.flip-card-container {
  width: 90%;
  max-width: 1200px;
  height: 85vh;
  perspective: 2000px;
}

.flip-card {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
  transform-style: preserve-3d;
}

.flip-card.flipped {
  transform: rotateY(180deg);
}

.flip-card-side {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border: 1px solid var(--border);
}

.flip-card-front {
  transform: rotateY(0deg);
}

.flip-card-back {
  transform: rotateY(180deg);
}

.unified-card-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-bottom: 1px solid var(--border);
  padding: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.unified-card-title-area {
  display: flex;
  align-items: center;
  gap: 16px;
}

.unified-card-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}

.unified-card-title-text h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
  color: #fff;
}

.unified-card-title-text p {
  margin: 4px 0 0 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.9);
}

.unified-card-header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.flip-toggle-btn {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  backdrop-filter: blur(10px);
}

.flip-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.unified-card-close {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 32px;
  color: #fff;
}

.unified-card-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

.unified-card-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 24px;
}

.unified-card-body::-webkit-scrollbar {
  width: 6px;
}

.unified-card-body::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

@media (max-width: 768px) {
  .flip-card-container {
    width: 95%;
    height: 90vh;
  }
  
  .unified-card-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .unified-card-header-actions {
    width: 100%;
    justify-content: flex-end;
  }
}
.profiling-type-tab.active {
  color: #667eea !important;
  border-bottom-color: #667eea !important;
}
.profiling-type-tab.newcomers-tab.active {
  color: #059669 !important;
  border-bottom-color: #10b981 !important;
}

.profiling-type-tab:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

/* Filter Sidebar Styles */
.filter-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.filter-overlay.active {
  opacity: 1;
  visibility: visible;
}

.filter-sidebar {
  position: fixed;
  top: 0;
  right: -450px;
  width: 420px;
  height: 100%;
  background: #fff;
  box-shadow: -8px 0 32px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
}

.filter-sidebar.active {
  right: 0;
}

.sidebar-header {
  padding: 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  flex-shrink: 0;
}

.sidebar-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-subtitle {
  font-size: 13px;
  opacity: 0.9;
}

.close-sidebar-btn {
  position: absolute;
  top: 24px;
  right: 24px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: #fff;
  font-size: 28px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  line-height: 1;
}

.close-sidebar-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.sidebar-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}

.sidebar-filter-group {
  margin-bottom: 24px;
}

.sidebar-filter-label {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 10px;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-filter-search {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 13px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.sidebar-filter-search:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.sidebar-filter-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 6px;
  background: #f8fafc;
}

.sidebar-filter-item {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  gap: 10px;
}

.sidebar-filter-item:hover {
  background: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.sidebar-filter-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #667eea;
  margin: 0;
}

.sidebar-filter-item-label {
  flex: 1;
  cursor: pointer;
  font-size: 14px;
  color: #1e293b;
  font-weight: 500;
}

.sidebar-filter-count {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.sidebar-footer {
  padding: 20px;
  border-top: 2px solid #e2e8f0;
  background: #f8fafc;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.sidebar-btn-apply {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.sidebar-btn-apply:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.sidebar-btn-clear {
  width: 100%;
  padding: 15px;
  background: #fff;
  color: #64748b;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.sidebar-btn-clear:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.sidebar-filter-list::-webkit-scrollbar,
.sidebar-body::-webkit-scrollbar {
  width: 8px;
}

.sidebar-filter-list::-webkit-scrollbar-track,
.sidebar-body::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.sidebar-filter-list::-webkit-scrollbar-thumb,
.sidebar-body::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

.sidebar-filter-list::-webkit-scrollbar-thumb:hover,
.sidebar-body::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

@media (max-width: 768px) {
  .filter-sidebar {
    width: 100%;
    right: -100%;
  }
}

/* ===== BONUS CALCULATOR ===== */
#bonus-calc-view{padding:12px !important;position:relative}
#bonus-calc-view.active{display:flex !important;flex-direction:column}
.bc-header{display:flex;align-items:center;gap:14px;padding:12px 16px;background:#fff;border-radius:14px;border:1px solid #e2e8f0;box-shadow:0 1px 4px rgba(0,0,0,0.04);flex-shrink:0;flex-wrap:wrap}
.bc-brand{display:flex;align-items:center;gap:10px;min-width:200px}
.bc-brand-icon{width:36px;height:36px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.bc-brand-title{font-weight:800;font-size:15px;color:#1e293b;line-height:1.2}
.bc-brand-stats{font-size:10px;color:#94a3b8;display:flex;gap:10px;margin-top:1px}
.bc-brand-stats strong{color:#667eea}
.bc-email-wrap{flex:1;max-width:320px;min-width:180px;position:relative}
.bc-email-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5;pointer-events:none}
.bc-email{width:100%;padding:9px 12px 9px 32px;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:10px;color:#1e293b;font-size:13px;font-weight:600;outline:none;transition:all 0.2s}
.bc-email:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);background:#fff}
.bc-actions{display:flex;align-items:center;gap:6px}
.bc-btn-calc{padding:9px 18px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:#fff;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(102,126,234,0.3);white-space:nowrap}
.bc-btn-calc:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(102,126,234,0.4)}
.bc-btn-calc:disabled{opacity:.6;cursor:not-allowed;transform:none}
.bc-btn-icon{width:34px;height:34px;border-radius:8px;background:#f8fafc;border:1.5px solid #e2e8f0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all 0.2s;flex-shrink:0}
.bc-btn-icon:hover{background:#fff;border-color:#667eea;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.bc-tabs-row{display:flex;align-items:center;gap:8px;flex-shrink:0;overflow:hidden}
.bc-cat-tabs{display:flex;gap:4px;padding:3px;background:#f1f5f9;border-radius:10px;flex-shrink:0}
.bc-cat-tab{padding:8px 16px;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;color:#94a3b8;white-space:nowrap;user-select:none}
.bc-cat-tab:hover{color:#475569;background:rgba(255,255,255,.6)}
.bc-cat-tab.active{background:#fff;color:#667eea;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
.bc-divider{width:1px;height:24px;background:#e2e8f0;flex-shrink:0}
.bc-calc-tabs{display:flex;gap:5px;overflow-x:auto;flex:1;scrollbar-width:none}
.bc-calc-tabs::-webkit-scrollbar{display:none}
.bc-calc-tab{padding:8px 14px;border-radius:8px;background:transparent;border:1.5px solid #e2e8f0;color:#64748b;font-weight:600;font-size:12px;cursor:pointer;transition:all 0.15s;white-space:nowrap;flex-shrink:0}
.bc-calc-tab:hover{border-color:#cbd5e1;color:#1e293b;background:#f8fafc}
.bc-calc-tab.active{background:rgba(102,126,234,0.08);border-color:#667eea;color:#667eea;font-weight:700}
.bc-favorites{padding:10px 14px;background:linear-gradient(135deg,rgba(139,92,246,0.04),rgba(102,126,234,0.04));border:1px solid rgba(139,92,246,0.15);border-radius:10px;flex-shrink:0}
.bc-favorites-header{font-size:11px;font-weight:800;color:#8b5cf6;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.bc-favorites-list{display:flex;flex-wrap:wrap;gap:6px}
.bc-favorites-list .bc-fav-chip{padding:4px 10px;background:rgba(139,92,246,0.08);border-radius:20px;font-size:11px;font-weight:600;color:#6d28d9;transition:all 0.15s}
.bc-favorites-list .bc-fav-chip:hover{background:rgba(139,92,246,0.15);transform:translateY(-1px)}
.bc-content-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:12px;overflow:hidden;min-height:0}
.bc-panel{background:#fff;border-radius:14px;border:1px solid #e2e8f0;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;min-height:400px}
.bc-panel::-webkit-scrollbar{width:5px}
.bc-panel::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:3px}
.bc-panel::-webkit-scrollbar-thumb:hover{background:#cbd5e1}
.bc-panel-header{font-size:12px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;padding-bottom:10px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:6px}
.bc-panel-icon{font-size:14px}
.bc-fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.bc-field{display:flex;flex-direction:column;gap:4px}
.bc-field-label{font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.04em;display:flex;align-items:center;gap:5px}
.bc-field-label .bc-icon{font-size:12px}
.bc-note-icon{width:14px;height:14px;border-radius:50%;background:#667eea;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;font-style:italic;cursor:pointer;margin-left:auto;flex-shrink:0;transition:all 0.15s;position:relative}
.bc-note-icon:hover{background:#764ba2;transform:scale(1.1)}
.bc-note-icon:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);right:0;background:#1e293b;color:#fff;padding:8px 12px;border-radius:8px;font-size:11px;font-weight:500;font-style:normal;white-space:pre-wrap;max-width:280px;min-width:120px;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,0.2);line-height:1.4;pointer-events:none}
.bc-note-icon:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);right:4px;border:5px solid transparent;border-top-color:#1e293b;z-index:200;pointer-events:none}
/* Custom search dropdown for editor */
.bc-edit-search{position:relative}
.bc-edit-search input{width:100%;padding:9px 12px;background:#f8fafc;border:1.5px solid #e8ecf1;border-radius:8px;font-size:13px;font-weight:600;color:#1e293b;outline:none;transition:all 0.15s}
.bc-edit-search input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08);background:#fff}
.bc-edit-search-list{position:absolute;z-index:100;left:0;right:0;max-height:200px;overflow-y:auto;margin-top:4px;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.12);display:none}
.bc-edit-search-item{padding:8px 12px;cursor:pointer;transition:background 0.1s;font-size:12px;font-weight:600;color:#1e293b;border-bottom:1px solid #f8fafc}
.bc-edit-search-item:hover{background:rgba(102,126,234,0.06)}
.bc-edit-search-item:last-child{border-bottom:none}
.bc-edit-chips{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px}
.bc-edit-chips:empty{display:none;margin:0}
.bc-edit-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.2);border-radius:14px;font-size:11px;font-weight:600;color:#667eea}
.bc-edit-chip-x{cursor:pointer;font-size:13px;opacity:.6;line-height:1}
.bc-edit-chip-x:hover{opacity:1;color:#ef4444}
.bc-edit-search-item.selected{background:rgba(102,126,234,0.06);color:#667eea}
.bc-edit-search-item.selected::after{content:'‚úì';float:right;font-weight:700}
.bc-input-wrap{position:relative}
.bc-input-wrap .bc-prefix,.bc-input-wrap .bc-suffix{position:absolute;top:50%;transform:translateY(-50%);font-weight:700;font-size:13px;color:#667eea;pointer-events:none;opacity:.7}
.bc-input-wrap .bc-prefix{left:10px}
.bc-input-wrap .bc-suffix{right:10px}
.bc-input-wrap.has-prefix .bc-inp{padding-left:30px}
.bc-input-wrap.has-suffix .bc-inp{padding-right:30px}
.bc-inp{width:100%;padding:8px 10px;background:#f8fafc;border:1.5px solid #e8ecf1;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;outline:none;transition:all 0.15s;font-family:inherit}
.bc-inp:hover{border-color:#cbd5e1}
.bc-inp:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08);background:#fff}
.bc-inp.readonly{background:#f1f5f9;color:#475569;cursor:default;border-color:#e8ecf1}
.bc-rtp-search{position:relative;z-index:10}
.bc-rtp-input{width:100%;padding:9px 12px 9px 32px;background:#f8fafc;border:1.5px solid #e8ecf1;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;outline:none;transition:all 0.15s}
.bc-rtp-input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08);background:#fff}
.bc-rtp-list{position:absolute;z-index:100;left:0;right:0;max-height:300px;overflow-y:auto;margin-top:4px;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.12);min-width:320px}
.bc-rtp-item{padding:9px 12px;border-bottom:1px solid #f8fafc;cursor:pointer;transition:background 0.1s;font-size:12px;color:#1e293b}
.bc-rtp-item:hover{background:rgba(102,126,234,0.06)}
.bc-rtp-item:last-child{border-bottom:none}
.bc-rtp-item-fav{background:rgba(102,126,234,0.03);border-left:3px solid #667eea}
.bc-rtp-divider{padding:4px 12px;font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;background:#f8fafc;border-bottom:1px solid #e2e8f0;letter-spacing:.04em}
.bc-rtp-chosen{margin-top:6px;padding:6px 10px;background:rgba(102,126,234,0.08);border:1px solid rgba(102,126,234,0.15);border-radius:20px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:6px;color:#667eea}
.bc-rtp-chosen .bc-chosen-x{cursor:pointer;font-size:14px;opacity:.6;line-height:1;margin-left:2px}
.bc-rtp-chosen .bc-chosen-x:hover{opacity:1;color:#ef4444}
.bc-profit-good{background:linear-gradient(135deg,rgba(16,185,129,0.04),rgba(16,185,129,0.08));border-radius:10px;padding:8px 10px;border-left:3px solid #10b981}
.bc-profit-warn{background:linear-gradient(135deg,rgba(245,158,11,0.04),rgba(245,158,11,0.08));border-radius:10px;padding:8px 10px;border-left:3px solid #f59e0b}
.bc-profit-bad{background:linear-gradient(135deg,rgba(239,68,68,0.04),rgba(239,68,68,0.08));border-radius:10px;padding:8px 10px;border-left:3px solid #ef4444}
.bc-summary{padding:14px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border:1px solid #e2e8f0;border-radius:12px;margin-top:auto}
.bc-summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e2e8f0;font-size:13px;font-weight:800;color:#1e293b}
.bc-btn-copy{padding:5px 10px;background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.2);border-radius:6px;color:#667eea;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s}
.bc-btn-copy:hover{background:rgba(102,126,234,0.15)}
.bc-summary-line{display:flex;justify-content:space-between;padding:3px 0;font-size:12px}
.bc-summary-label{font-weight:600;color:#64748b}
.bc-summary-value{font-weight:800;color:#1e293b}
.bc-loading{display:none;position:absolute;inset:0;background:rgba(255,255,255,0.85);backdrop-filter:blur(4px);z-index:100;align-items:center;justify-content:center}
.bc-loading-inner{display:flex;align-items:center;gap:10px;padding:14px 24px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);font-size:13px;font-weight:600;color:#64748b}
.bc-spinner{width:20px;height:20px;border:2.5px solid #e2e8f0;border-top-color:#667eea;border-radius:50%;animation:spin .7s linear infinite}
.bc-toast{position:fixed;right:20px;bottom:20px;padding:12px 18px;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.1);color:#1e293b;font-weight:600;font-size:13px;opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:10000;pointer-events:none}
/* RTP Games Page */
.bc-rtp-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex-shrink:0}
.bc-rtp-search-bar{position:relative;flex:1;min-width:200px}
.bc-rtp-search-bar input{width:100%;padding:9px 12px 9px 34px;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;color:#1e293b;outline:none;transition:all 0.15s}
.bc-rtp-search-bar input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08)}
.bc-rtp-select{padding:9px 12px;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;font-size:12px;font-weight:600;color:#1e293b;outline:none;cursor:pointer;min-width:130px}
.bc-rtp-select:focus{border-color:#667eea}
.bc-rtp-stats{display:flex;gap:12px;font-size:12px;font-weight:600;color:#94a3b8;flex-shrink:0;align-items:center;flex-wrap:wrap}
.bc-rtp-stats strong{color:#667eea}
.bc-active-filters{display:flex;gap:6px;flex-wrap:wrap}
.bc-filter-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:rgba(102,126,234,0.08);border:1px solid rgba(102,126,234,0.2);border-radius:20px;font-size:11px;font-weight:600;color:#667eea}
.bc-filter-chip .bc-chip-x{cursor:pointer;font-size:13px;opacity:.6;margin-left:2px;line-height:1}
.bc-filter-chip .bc-chip-x:hover{opacity:1;color:#ef4444}
/* Favourite Slots in Profiling */
.fav-slots-container{grid-column:1/-1;padding:20px;background:linear-gradient(135deg,rgba(102,126,234,0.04),rgba(139,92,246,0.04));border:1.5px solid rgba(102,126,234,0.15);border-radius:16px;margin-top:10px}
.fav-slots-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.fav-slots-title{font-size:13px;font-weight:800;color:#667eea;text-transform:uppercase;letter-spacing:.04em;display:flex;align-items:center;gap:8px}
.fav-slots-add{padding:7px 16px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:#fff;font-weight:700;font-size:11px;cursor:pointer;transition:all 0.15s;box-shadow:0 2px 8px rgba(102,126,234,0.25)}
.fav-slots-add:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.35)}
.fav-slots-grid{display:flex;gap:10px;flex-wrap:wrap}
.fav-slot-card{display:flex;flex-direction:column;gap:6px;padding:12px 16px;background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.2s;min-width:180px;max-width:240px;position:relative;overflow:hidden}
.fav-slot-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#667eea,#764ba2);opacity:0;transition:opacity 0.2s}
.fav-slot-card:hover{border-color:#667eea;box-shadow:0 4px 16px rgba(102,126,234,0.15);transform:translateY(-2px)}
.fav-slot-card:hover::before{opacity:1}
.fav-slot-name{font-weight:700;font-size:13px;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:20px}
.fav-slot-provider{font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.03em}
.fav-slot-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-top:2px}
.fav-slot-rtp{font-weight:800;font-size:13px;color:#667eea;background:rgba(102,126,234,0.06);padding:2px 8px;border-radius:6px}
.fav-slot-remove{position:absolute;top:8px;right:8px;width:20px;height:20px;border-radius:50%;border:none;background:rgba(0,0,0,0.04);color:#cbd5e1;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;line-height:1}
.fav-slot-remove:hover{background:#fef2f2;color:#ef4444}
.fav-slot-empty{padding:24px;text-align:center;color:#94a3b8;font-size:12px;font-weight:500;width:100%}
/* Slot picker modal */
.slot-picker-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.5);backdrop-filter:blur(4px);z-index:10002;display:flex;align-items:center;justify-content:center}
.slot-picker-card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.2);width:95%;max-width:700px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.slot-picker-search{padding:16px 20px;border-bottom:1px solid #f1f5f9;display:flex;gap:8px;align-items:center}
.slot-picker-search input{flex:1;padding:9px 14px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;outline:none;transition:all 0.15s}
.slot-picker-search input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08)}
.slot-picker-list{overflow-y:auto;flex:1;padding:8px}
.slot-picker-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;transition:all 0.1s;border:1.5px solid transparent}
.slot-picker-item:hover{background:rgba(102,126,234,0.04);border-color:rgba(102,126,234,0.1)}
.slot-picker-item.selected{background:rgba(102,126,234,0.06);border-color:#667eea}
.slot-picker-item .spi-name{font-weight:700;font-size:13px;color:#1e293b}
.slot-picker-item .spi-prov{font-size:11px;color:#94a3b8;font-weight:600}
.slot-picker-item .spi-rtp{font-weight:800;font-size:12px;color:#667eea;margin-left:auto}
.bc-rtp-table{width:100%;border-collapse:separate;border-spacing:0;font-size:12px}
.bc-rtp-table thead{position:sticky;top:0;z-index:5}
.bc-rtp-table th{background:#f8fafc;padding:10px 12px;text-align:left;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;font-size:10px;border-bottom:2px solid #e2e8f0;cursor:pointer;user-select:none;white-space:nowrap;transition:background 0.15s}
.bc-rtp-table th:hover{background:#eef2ff;color:#667eea}
.bc-rtp-table th .bc-sort-arrow{margin-left:4px;font-size:10px;opacity:.4}
.bc-rtp-table th.bc-sorted .bc-sort-arrow{opacity:1;color:#667eea}
.bc-rtp-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9;color:#1e293b;font-weight:500;white-space:nowrap;transition:background 0.1s}
.bc-rtp-table tbody tr{cursor:pointer;transition:background 0.1s}
.bc-rtp-table tbody tr:hover{background:rgba(102,126,234,0.04)}
.bc-rtp-table .bc-rtp-provider{font-weight:700;color:#1e293b}
.bc-rtp-table .bc-rtp-slot{font-weight:600;color:#475569;max-width:200px;overflow:hidden;text-overflow:ellipsis}
.bc-rtp-table .bc-rtp-pct{font-weight:800;color:#667eea}
.bc-rtp-table .bc-vol-badge{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;display:inline-block}
.bc-vol-very-high{background:rgba(239,68,68,0.1);color:#dc2626}
.bc-vol-high{background:rgba(245,158,11,0.1);color:#d97706}
.bc-vol-medium-high{background:rgba(59,130,246,0.1);color:#2563eb}
.bc-vol-medium{background:rgba(16,185,129,0.1);color:#059669}
.bc-vol-low-medium{background:rgba(139,92,246,0.1);color:#7c3aed}
.bc-vol-low{background:rgba(107,114,128,0.1);color:#4b5563}
.bc-rtp-table .bc-cat-badge{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;background:#f1f5f9;color:#64748b;display:inline-block;margin:1px 2px}
.bc-rtp-table .bc-bet-cell{font-size:11px;color:#94a3b8;font-weight:600}
.bc-rtp-table .bc-actions-cell{display:flex;gap:4px}
.bc-rtp-table .bc-row-btn{width:26px;height:26px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;transition:all 0.15s}
.bc-rtp-table .bc-row-btn:hover{border-color:#667eea;background:rgba(102,126,234,0.06)}
.bc-rtp-table .bc-row-btn.bc-del:hover{border-color:#ef4444;background:rgba(239,68,68,0.06)}
/* Modals */
.bc-modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.5);backdrop-filter:blur(4px);z-index:10001;display:flex;align-items:center;justify-content:center}
.bc-modal-card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.2);max-width:600px;width:95%;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.bc-modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #f1f5f9;font-weight:800;font-size:16px;color:#1e293b}
.bc-modal-close{width:32px;height:32px;border-radius:8px;border:none;background:#f8fafc;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:#64748b;transition:all 0.15s}
.bc-modal-close:hover{background:#fef2f2;color:#ef4444}
.bc-modal-body{padding:20px;overflow-y:auto;flex:1}
.bc-modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:14px 20px;border-top:1px solid #f1f5f9}
.bc-modal-field{margin-bottom:14px}
.bc-modal-field label{display:block;font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.04em;margin-bottom:5px}
.bc-modal-field input,.bc-modal-field select{width:100%;padding:9px 12px;background:#f8fafc;border:1.5px solid #e8ecf1;border-radius:8px;font-size:13px;font-weight:600;color:#1e293b;outline:none;transition:all 0.15s}
.bc-modal-field input:focus,.bc-modal-field select:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.08);background:#fff}
.bc-modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.bc-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f8fafc;font-size:13px}
.bc-detail-row:last-child{border-bottom:none}
.bc-detail-label{font-weight:600;color:#94a3b8}
.bc-detail-value{font-weight:700;color:#1e293b;text-align:right}

/* HOME PAGE - Clean Light */
.home-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#eef2ff 0%,#f5f3ff 35%,#fdf4ff 65%,#ecfdf5 100%);z-index:10001;display:none;justify-content:center;align-items:flex-start;padding:28px;overflow-y:auto}
.home-overlay.show{display:flex}
.home-container{width:100%;max-width:1340px;margin:0 auto;animation:homeSlideIn 0.35s ease;position:relative}
@keyframes homeSlideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.home-top-bar{display:flex;align-items:center;justify-content:space-between;padding:22px 32px;background:linear-gradient(135deg,#1e293b,#334155);border-radius:24px;margin-bottom:16px;gap:24px;flex-wrap:wrap;box-shadow:0 8px 32px rgba(30,41,59,0.2)}
.home-clock{display:flex;gap:16px;align-items:center}
.home-clock-item{text-align:center}
.home-clock-label{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:rgba(255,255,255,0.5);font-weight:700}
.home-clock-time{font-size:30px;font-weight:800;color:#fff;font-variant-numeric:tabular-nums;font-family:'SF Mono',monospace}
.home-crypto{display:flex;gap:12px;align-items:center}
.home-crypto-item{background:rgba(255,255,255,0.08);padding:14px 20px;border-radius:16px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.1)}
.home-crypto-icon{font-size:28px;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.home-crypto-icon.btc{background:rgba(247,147,26,0.2);color:#f7931a}
.home-crypto-icon.eth{background:rgba(98,126,234,0.2);color:#627eea}
.home-crypto-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.4);font-weight:700}
.home-crypto-price{font-size:20px;font-weight:800;color:#fff}
.home-crypto-change{font-size:12px;font-weight:700;border-radius:8px;padding:3px 10px;margin-left:4px}
.home-crypto-change.up{color:#34d399;background:rgba(52,211,153,0.15)}
.home-crypto-change.down{color:#f87171;background:rgba(248,113,113,0.15)}
.home-close-btn{width:48px;height:48px;border-radius:16px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.15);color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.home-close-btn:hover{background:rgba(239,68,68,0.3);transform:scale(1.1)}
/* Timezone Bar */
.home-tz-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;padding:16px 20px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;box-shadow:0 2px 12px rgba(0,0,0,0.04)}
.home-tz-group{position:relative;z-index:100}
.home-tz-chip{display:flex;align-items:center;gap:10px;padding:12px 18px;background:#f8fafc;border-radius:16px;cursor:pointer;transition:all 0.2s;border:2px solid #e2e8f0}
.home-tz-chip:hover{background:#eef2ff;border-color:#c7d2fe;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.12)}
.home-tz-chip.active{background:#eef2ff;border-color:#818cf8;box-shadow:0 4px 16px rgba(102,126,234,0.2)}
.home-tz-flag{font-size:20px}
.home-tz-name{font-size:12px;color:#64748b;font-weight:800;text-transform:uppercase;letter-spacing:0.5px}
.home-tz-time{font-size:18px;color:#1e293b;font-weight:900;font-variant-numeric:tabular-nums;font-family:'SF Mono',monospace}
.home-tz-dropdown{position:absolute;top:calc(100% + 8px);left:0;background:#fff;border:1px solid #e2e8f0;border-radius:18px;padding:8px;min-width:240px;z-index:99999;display:none;box-shadow:0 20px 50px rgba(0,0,0,0.15);animation:tzDrop 0.2s ease}
.home-tz-dropdown.show{display:block}
@keyframes tzDrop{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.home-tz-drop-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-radius:14px;transition:background 0.15s}
.home-tz-drop-item:hover{background:#f1f5f9}
.home-tz-drop-city{font-size:14px;color:#475569;font-weight:700}
.home-tz-drop-time{font-size:17px;color:#1e293b;font-weight:900;font-variant-numeric:tabular-nums;font-family:'SF Mono',monospace}
/* Home Grid */
.home-grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
@media(max-width:960px){.home-grid{grid-template-columns:1fr}}
.home-main{display:flex;flex-direction:column;gap:20px}
.home-side{display:flex;flex-direction:column;gap:20px}
.home-card{background:#fff;border-radius:24px;overflow:hidden;border:1px solid #e2e8f0;box-shadow:0 2px 12px rgba(0,0,0,0.04);display:flex;flex-direction:column;transition:all 0.3s}
.home-card:hover{box-shadow:0 8px 32px rgba(0,0,0,0.08);border-color:#c7d2fe}
.home-card-header{padding:22px 28px;font-size:18px;font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid #f1f5f9;color:#1e293b;flex-shrink:0}
.home-card-count{font-size:13px;font-weight:700;color:#667eea;background:rgba(102,126,234,0.08);padding:5px 16px;border-radius:20px}
.home-card-body{padding:0}
.home-scrollable{max-height:500px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}
.home-scrollable::-webkit-scrollbar{width:5px}
.home-scrollable::-webkit-scrollbar-track{background:transparent}
.home-scrollable::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
/* Posts */
.home-post{padding:26px 32px;border-bottom:1px solid #f1f5f9;transition:background 0.15s;position:relative}
.home-post:hover{background:#fafbfe}
.home-post:last-child{border-bottom:none}
.home-post::before{content:'';position:absolute;left:0;top:16px;bottom:16px;width:4px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:0 4px 4px 0;opacity:0;transition:opacity 0.2s}
.home-post:hover::before{opacity:1}
.home-post-number{position:absolute;top:24px;right:28px;font-size:34px;font-weight:900;color:rgba(102,126,234,0.06);line-height:1}
.home-post-meta{display:flex;align-items:center;gap:10px;margin-bottom:12px;font-size:13px;color:#94a3b8;flex-wrap:wrap}
.home-post-date{display:flex;align-items:center;gap:5px;font-weight:600;color:#64748b}
.home-post-date svg{width:14px;height:14px;fill:none;stroke:#94a3b8;stroke-width:2}
.home-post-author-tag{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.08));padding:4px 16px;border-radius:20px;font-weight:700;color:#667eea;font-size:12px}
.home-post-content{font-size:16px;line-height:1.8;color:#334155;white-space:pre-line}
.home-post-content a{color:#667eea;text-decoration:none;font-weight:600}
.home-post-content a:hover{text-decoration:underline;color:#4f46e5}
.home-yt-preview{display:block;position:relative;border-radius:18px;overflow:hidden;margin:14px 0;cursor:pointer;max-width:560px;background:#0f172a;text-decoration:none;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
.home-yt-preview img{width:100%;aspect-ratio:16/9;object-fit:cover;transition:transform 0.3s;opacity:0.9}
.home-yt-preview:hover img{transform:scale(1.05);opacity:1}
.home-yt-play{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:68px;height:68px;background:rgba(255,0,0,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(255,0,0,0.3);transition:transform 0.2s}
.home-yt-preview:hover .home-yt-play{transform:translate(-50%,-50%) scale(1.1)}
.home-yt-play::after{content:'';border-style:solid;border-width:12px 0 12px 22px;border-color:transparent transparent transparent #fff;margin-left:4px}
.home-yt-title{padding:14px 18px;background:linear-gradient(135deg,#0f172a,#1e293b);color:#fff;font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.home-yt-title .yt-icon{color:#ff0000;font-size:18px;flex-shrink:0}
.home-post-img{max-width:100%;border-radius:16px;margin:12px 0;box-shadow:0 4px 16px rgba(0,0,0,0.08)}
.home-link-item{display:flex;align-items:center;gap:16px;padding:18px 24px;border-radius:16px;cursor:pointer;transition:all 0.15s;color:#334155;text-decoration:none;font-size:15px;font-weight:600}
.home-link-item:hover{background:rgba(102,126,234,0.06);color:#667eea;transform:translateX(4px)}
.home-link-icon{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0}
/* Currency converter */
.home-converter{display:flex;flex-direction:column;gap:14px;padding:22px}
.home-conv-row{display:flex;gap:10px;align-items:center}
.home-conv-input{flex:1;padding:16px 18px;border:2px solid #e2e8f0;border-radius:16px;font-size:17px;font-weight:600;outline:none;transition:border-color 0.2s;background:#fff;color:#1e293b}
.home-conv-input:focus{border-color:#667eea}
.home-conv-select{padding:16px 14px;border:2px solid #e2e8f0;border-radius:16px;font-size:15px;font-weight:700;outline:none;cursor:pointer;background:#fff;color:#1e293b;min-width:100px}
.home-conv-result{font-size:26px;font-weight:800;color:#667eea;text-align:center;padding:16px;background:linear-gradient(135deg,#f0f0ff,#faf5ff);border-radius:18px;border:1px solid rgba(102,126,234,0.12)}
.home-conv-swap{width:44px;height:44px;border-radius:50%;border:2px solid #e2e8f0;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s;flex-shrink:0;color:#64748b}
.home-conv-swap:hover{border-color:#667eea;background:#f0f0ff;transform:rotate(180deg)}
/* Home % Calculator */
.home-pct-calc{padding:22px}
.home-pct-row{display:flex;gap:10px;align-items:center;margin-bottom:16px}
.home-pct-input{flex:1;padding:16px 18px;border:2px solid #e2e8f0;border-radius:16px;font-size:18px;font-weight:700;outline:none;transition:border 0.2s;background:#fff;color:#1e293b}
.home-pct-input:focus{border-color:#667eea}
.home-pct-input::placeholder{color:#94a3b8}
.home-pct-select{padding:16px 14px;border:2px solid #e2e8f0;border-radius:16px;font-size:18px;font-weight:700;outline:none;background:#fff;color:#1e293b;cursor:pointer}
.home-pct-result{padding:22px;background:linear-gradient(135deg,#f0f0ff,#faf5ff);border-radius:18px;text-align:center;border:1px solid rgba(102,126,234,0.12)}
.home-pct-result-num{font-size:42px;font-weight:900;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.home-pct-result-label{font-size:14px;color:#94a3b8;margin-top:6px;font-weight:600}
/* FAB buttons */
.home-btn-fab{position:fixed;top:20px;right:84px;width:50px;height:50px;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;border-radius:50%;font-size:22px;cursor:pointer;box-shadow:0 4px 16px rgba(245,158,11,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
.home-btn-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(245,158,11,0.5)}
.cal-fab{position:fixed;top:20px;right:140px;width:50px;height:50px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:50%;font-size:22px;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
.cal-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(102,126,234,0.5)}
.cal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:5000;display:none;overflow-y:auto;backdrop-filter:blur(4px)}
.cal-overlay.show{display:block}
.cal-close-btn{position:fixed;top:20px;right:20px;width:44px;height:44px;border-radius:50%;border:none;background:rgba(0,0,0,0.15);color:#64748b;font-size:20px;cursor:pointer;z-index:5001;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.cal-close-btn:hover{background:rgba(0,0,0,0.25);transform:scale(1.1)}
/* Calendar */
.cal-container{padding:24px;max-width:1200px;margin:0 auto}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.cal-nav{display:flex;align-items:center;gap:12px}
.cal-nav-btn{width:40px;height:40px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;color:#334155;font-size:16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
.cal-nav-btn:hover{background:#f1f5f9;transform:scale(1.05)}
.cal-month-title{font-size:26px;font-weight:900;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.cal-today-btn{padding:8px 20px;border-radius:12px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(102,126,234,0.3)}
.cal-today-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(102,126,234,0.4)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:24px}
.cal-weekday{text-align:center;font-size:11px;font-weight:800;color:#94a3b8;padding:10px 0;text-transform:uppercase;letter-spacing:1px}
.cal-day{position:relative;min-height:110px;border-radius:14px;cursor:pointer;transition:all 0.2s;background:#fff;border:1px solid #f1f5f9;padding:6px;display:flex;flex-direction:column;overflow:hidden}
.cal-day:hover{border-color:#cbd5e1;box-shadow:0 4px 16px rgba(0,0,0,0.06);transform:translateY(-2px)}
.cal-day.empty{background:transparent;border:1px dashed #f1f5f9;cursor:default;min-height:auto}
.cal-day.empty:hover{transform:none;box-shadow:none}
.cal-day.today{border:2px solid #667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.15),0 4px 16px rgba(102,126,234,0.12);background:linear-gradient(180deg,#f5f3ff 0%,#fff 100%)}
.cal-day.today .cal-day-num{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:8px;padding:2px 8px}
.cal-day.selected{border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,0.2)}
.cal-day-num{font-size:14px;font-weight:800;color:#334155;margin-bottom:4px;padding:2px 6px;align-self:flex-start;border-radius:6px}
.cal-day-cards{display:flex;flex-direction:column;gap:3px;flex:1;overflow:hidden}
.cal-card{padding:3px 6px;border-radius:6px;font-size:10px;font-weight:700;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:all 0.15s}
.cal-card:hover{filter:brightness(0.95);transform:scale(1.02)}
.cal-card.holiday{background:#fef2f2;color:#dc2626;border-left:3px solid #dc2626}
.cal-card.promo{background:#eff6ff;color:#2563eb;border-left:3px solid #2563eb}
.cal-card.tournament{background:#ecfdf5;color:#059669;border-left:3px solid #059669}
.cal-card.vip{background:#fdf4ff;color:#a855f7;border-left:3px solid #a855f7}
.cal-card.birthday{background:#fff7ed;color:#ea580c;border-left:3px solid #ea580c}
.cal-card-more{font-size:9px;color:#94a3b8;text-align:center;padding:2px;font-weight:600}
.cal-detail-panel{background:#fff;border-radius:20px;padding:24px;box-shadow:0 4px 24px rgba(0,0,0,0.06);border:1px solid #f1f5f9}
.cal-detail-title{font-size:16px;font-weight:900;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.cal-detail-date{font-size:13px;color:#94a3b8;font-weight:600}
.cal-detail-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:14px;margin-bottom:8px;transition:all 0.15s;cursor:pointer}
.cal-detail-item:hover{transform:translateX(4px)}
.cal-detail-item.holiday{background:linear-gradient(135deg,#fef2f2,#fff1f2)}
.cal-detail-item.promo{background:linear-gradient(135deg,#eff6ff,#eef2ff)}
.cal-detail-item.tournament{background:linear-gradient(135deg,#ecfdf5,#f0fdf4)}
.cal-detail-item.vip{background:linear-gradient(135deg,#fdf4ff,#faf5ff)}
.cal-detail-item.birthday{background:linear-gradient(135deg,#fff7ed,#fffbeb)}
.cal-detail-icon{font-size:28px;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:rgba(255,255,255,0.8);flex-shrink:0}
.cal-detail-info{flex:1;min-width:0}
.cal-detail-name{font-size:14px;font-weight:800;color:#1e293b}
.cal-detail-desc{font-size:12px;color:#64748b;margin-top:3px}
.cal-detail-badge{font-size:11px;font-weight:700;padding:4px 14px;border-radius:20px;flex-shrink:0}
.cal-month-bg{min-height:100%;transition:background 0.6s ease;position:relative;overflow:hidden}
.cal-month-bg .cal-particles{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;pointer-events:none}
.cal-particle{position:absolute;bottom:-40px;animation:cal-rise linear infinite}
@keyframes cal-rise{0%{transform:translateY(0) translateX(0) rotate(0deg) scale(1);opacity:0}5%{opacity:0.25}50%{transform:translateY(-50vh) translateX(30px) rotate(180deg) scale(1.1);opacity:0.18}95%{opacity:0.08}100%{transform:translateY(-105vh) translateX(-20px) rotate(360deg) scale(0.8);opacity:0}}
.cal-legend{display:flex;gap:16px;margin-top:16px;justify-content:center;flex-wrap:wrap}
.cal-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:#64748b;font-weight:600}
.cal-legend-dot{width:10px;height:10px;border-radius:4px}
/* Event Modal */
.cal-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:6000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.cal-modal{background:#fff;border-radius:24px;width:480px;max-width:90vw;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.2);animation:cal-modal-in 0.25s ease}
@keyframes cal-modal-in{from{opacity:0;transform:scale(0.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.cal-modal-header{padding:24px;display:flex;align-items:center;gap:16px;position:relative}
.cal-modal-icon{font-size:40px;width:64px;height:64px;display:flex;align-items:center;justify-content:center;border-radius:16px;flex-shrink:0}
.cal-modal-title{font-size:20px;font-weight:900;color:#1e293b}
.cal-modal-subtitle{font-size:13px;color:#64748b;margin-top:2px}
.cal-modal-close{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;border:none;background:#f1f5f9;color:#64748b;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.cal-modal-close:hover{background:#e2e8f0}
.cal-modal-body{padding:0 24px 24px;overflow-y:auto;max-height:calc(80vh - 120px)}
.cal-modal-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f1f5f9}
.cal-modal-row:last-child{border:none}
.cal-modal-row-icon{font-size:18px;width:36px;text-align:center}
.cal-modal-row-label{font-size:12px;color:#94a3b8;min-width:80px}
.cal-modal-row-value{font-size:14px;font-weight:600;color:#1e293b}
</style>
</head>
<body>
<div id="top-loader"></div>
<div id="splash">
<div class="splash-content">
<div class="splash-logo">üå™Ô∏è Slotornado</div>
<div class="splash-spinner"></div>
<div class="splash-text">Loading analytics...</div>
</div>
</div>

<div class="container">
<div class="sidebar" id="sidebar">
<div class="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</div>
<div class="sidebar-header">
<div class="logo" onclick="toggleSidebar()"><span class="nav-icon" style="font-size:inherit">üå™Ô∏è</span><span class="logo-text"> Slotornado</span></div>
<div class="subtitle">Analytics Suite</div>
</div>

<div class="player-search-container" style="padding:16px;border-bottom:1px solid #e2e8f0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)">
  <div style="position:relative">
    <input 
      type="text" 
      id="playerSearchInput" 
      placeholder="üîç Search by name or email..." 
      style="width:100%;padding:12px 40px 12px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;outline:none"
      onkeypress="if(event.key==='Enter'){document.getElementById('sidebarSearchSuggest').classList.remove('open');searchPlayer()}"
      onfocus="this.style.borderColor='#667eea';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
      onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'"
      autocomplete="off"
    />
    <button 
      onclick="document.getElementById('sidebarSearchSuggest').classList.remove('open');searchPlayer()" 
      style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#667eea;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s;z-index:2"
      onmouseover="this.style.background='#5568d3';this.style.transform='translateY(-50%) scale(1.05)'"
      onmouseout="this.style.background='#667eea';this.style.transform='translateY(-50%) scale(1)'"
    >
      GO
    </button>
    <div class="prof-search-suggest" id="sidebarSearchSuggest"></div>
  </div>
</div>

<div class="sidebar-nav">
<div class="nav-item active" data-view="deposit" data-tooltip="Deposit Conversion">
<span class="nav-icon">üí∞</span>
<span>Deposit Conversion</span>
</div>
<div class="nav-item" data-view="retention" data-tooltip="Retention Rate">
<span class="nav-icon">üìä</span>
<span>Retention Rate</span>
</div>
<div class="nav-item" data-view="kpi" data-tooltip="KPI Dashboard">
<span class="nav-icon">üìà</span>
<span>KPI Dashboard</span>
</div>
<div class="nav-item" data-view="bonus" data-tooltip="Bonus Report">
<span class="nav-icon">üéÅ</span>
<span>Bonus Report</span>
</div>

<!-- DYNAMIC TABS WILL BE INSERTED HERE -->
<div id="dynamicTabsContainer"></div>

</div>

<!-- Bonus Calculator & Profiling Section -->
<div class="sidebar-bottom-section" style="margin-top:auto;padding-top:16px;border-top:2px solid #e2e8f0">
  <div class="profiling-btn sidebar-bottom-btn" data-tooltip="Bonus Calculator" onclick="showBonusCalcView()" style="margin:12px 8px 6px;padding:14px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:12px;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(59,130,246,0.3)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(59,130,246,0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)'">
    <div style="display:flex;align-items:center;gap:12px;color:#fff">
      <span style="font-size:24px">üíé</span>
      <div class="sidebar-btn-label" style="flex:1">
        <div style="font-weight:800;font-size:13px;line-height:1.2">Bonus Calculator</div>
        <div style="font-size:10px;opacity:0.9;margin-top:2px">Casino & Sport</div>
      </div>
    </div>
  </div>
  <div class="profiling-btn sidebar-bottom-btn" data-tooltip="Player Profiling" onclick="showProfilingView()" style="margin:12px 8px;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 12px rgba(102,126,234,0.3)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">
    <div style="display:flex;align-items:center;gap:12px;color:#fff">
      <span style="font-size:28px">üëë</span>
      <div class="sidebar-btn-label" style="flex:1">
        <div style="font-weight:800;font-size:14px;line-height:1.2">Player Profiling</div>
        <div style="font-size:11px;opacity:0.9;margin-top:2px">VIP Management</div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="main-wrapper">
<div class="main">
<div class="content active" id="deposit-view">
<h1>üí∞ Deposit Conversion</h1>
<p class="desc">FTD Players Deposit Progression Analysis</p>

<button class="open-filter-btn" onclick="openDepositFilterSidebar()" style="position:fixed;top:20px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s">
  üîç
</button>

<div class="chart-section">
<div class="chart-header">
<div class="chart-title">üìä Deposit Conversion Chart</div>
<div class="metric-selector" id="metricSelector"></div>
</div>
<div class="chart-container">
<canvas id="conversionChart"></canvas>
</div>
</div>
<div style="display:flex;justify-content:flex-end;margin-bottom:12px;padding:0 24px">
<label class="heatmap-toggle">
<input type="checkbox" id="depositHeatmapToggle" checked onchange="toggleDepositHeatmap()">
<span class="toggle-label">Show %</span>
</label>
</div>
<div class="table-wrap">
<table id="deposit-table"></table>
</div>
</div>

<div class="content" id="retention-view">
<h1>üìä Retention Rate</h1>
<p class="desc">FTD to Active Retention Analysis</p>

<button class="open-filter-btn" onclick="openRetentionFilterSidebar()" style="position:fixed;top:20px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(102,126,234,0.4);z-index:999;display:flex;align-items:center;justify-content:center;transition:all 0.3s">
  üîç
</button>

<div style="display:flex;gap:12px;margin-bottom:20px">
<button class="metric-btn active" id="retentionMonthlyTab" onclick="switchRetentionMode('monthly')" style="padding:12px 24px;font-size:14px">üìÖ Monthly</button>
<button class="metric-btn" id="retentionWeeklyTab" onclick="switchRetentionMode('weekly')" style="padding:12px 24px;font-size:14px">üìÜ Weekly</button>
</div>

<div style="margin-bottom:30px">
<div class="chart-header">
<div class="chart-title">üìä Retention Cohort Chart</div>
<div class="metric-selector" id="retentionMetricSelector"></div>
</div>
<div class="chart-container">
<canvas id="retentionChart"></canvas>
</div>
</div>

<div style="display:flex;justify-content:flex-end;margin-bottom:12px;padding:0 24px">
<label class="heatmap-toggle">
<input type="checkbox" id="retentionHeatmapToggle" checked onchange="toggleRetentionHeatmap()">
<span class="toggle-label">Show %</span>
</label>
</div>

<div class="table-wrap">
<table id="retention-table"></table>
</div>
</div>

<div class="content" id="profiling-view">
<h1>üëë VIP Player Profiling</h1>
<p class="desc">Manage and analyze VIP players</p>

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:16px">
  <div style="display:flex;gap:12px;flex:1">
    <div style="position:relative;flex:1;max-width:400px">
      <input type="text" id="profilingSearchInput" placeholder="üîç Search players..." style="width:100%;padding:10px 14px 10px 46px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;outline:none;transition:all 0.2s" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'" autocomplete="off">
      <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:#64748b;pointer-events:none">üîç</span>
      <div class="prof-search-suggest" id="profSearchSuggest"></div>
    </div>
    
    <div style="position:relative">
      <select id="profilingTypeFilter" onchange="handleProfilingTypeFilter()" style="padding:10px 16px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;font-weight:600;outline:none;cursor:pointer;min-width:150px;transition:all 0.2s" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
        <option value="ALL">All Types</option>
        <!-- Dynamic options will be populated here -->
      </select>
    </div>
  </div>
  
  <div style="display:flex;gap:12px">
    <button id="profilingAddPlayerBtn" onclick="openProfilingAddModal()" style="padding:10px 20px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:8px;color:#fff;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
      ‚ûï Add Player
    </button>
    
    <button id="profilingAnalyticsBtn" onclick="toggleProfilingAnalytics()" style="padding:10px 20px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;color:#059669;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(16,185,129,0.2)'" onmouseout="this.style.background='rgba(16,185,129,0.1)'">
      üìä Analytics
    </button>
    
    <button id="profilingViewToggle" onclick="toggleProfilingView()" style="padding:10px 20px;background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.3);border-radius:8px;color:#667eea;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(102,126,234,0.2)'" onmouseout="this.style.background='rgba(102,126,234,0.1)'">
      <span id="profilingViewIcon">‚äû</span> Grid View
    </button>
    
    <div style="position:relative;display:inline-block">
      <button id="profilingSortBtn" onclick="toggleProfilingSortMenu()" style="padding:10px 20px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;color:#d97706;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(245,158,11,0.2)'" onmouseout="this.style.background='rgba(245,158,11,0.1)'">
        üî§ Sort ‚ñæ
      </button>
      <div id="profilingSortMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.12);z-index:100;min-width:240px;overflow:hidden">
        <div onclick="setProfilingSort('alpha')" class="profiling-sort-opt" data-sort="alpha" style="padding:10px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f5f9;transition:background 0.15s">
          <span>üî§</span><span>Name A‚ÜíZ</span>
        </div>
        <div onclick="setProfilingSort('reg_date')" class="profiling-sort-opt" data-sort="reg_date" style="padding:10px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f5f9;transition:background 0.15s">
          <span>üìÖ</span><span>Registration Date</span><span id="sortDirReg" style="margin-left:auto;font-size:11px;color:#94a3b8">‚Üì New</span>
        </div>
        <div onclick="setProfilingSort('last_deposit')" class="profiling-sort-opt" data-sort="last_deposit" style="padding:10px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f5f9;transition:background 0.15s">
          <span>üí∞</span><span>Last Deposit</span><span id="sortDirDep" style="margin-left:auto;font-size:11px;color:#94a3b8">‚Üì New</span>
        </div>
        <div onclick="setProfilingSort('vip_date')" class="profiling-sort-opt" data-sort="vip_date" style="padding:10px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f1f5f9;transition:background 0.15s">
          <span>‚≠ê</span><span>VIP Confirmation</span><span id="sortDirVip" style="margin-left:auto;font-size:11px;color:#94a3b8">‚Üì New</span>
        </div>
        <div onclick="setProfilingSort('none')" class="profiling-sort-opt" data-sort="none" style="padding:10px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px;transition:background 0.15s">
          <span>‚Ü©Ô∏è</span><span>Default (no sort)</span>
        </div>
      </div>
    </div>
    
    <button id="profilingFilterBtn" onclick="openProfilingFilterSidebar()" style="padding:10px 20px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#7c3aed;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(139,92,246,0.2)'" onmouseout="this.style.background='rgba(139,92,246,0.1)'">
      üîç Filters
    </button>
  </div>
</div>

<div id="profilingManagerTabs" style="display:flex;gap:6px;overflow-x:auto;padding:4px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:12px;scrollbar-width:none">
  <!-- Manager tabs will be inserted here -->
</div>

<!-- Type Subtabs - Dynamic -->
<div id="profilingTypeTabs" style="display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:2px;flex-wrap:wrap">
  <!-- Dynamic type tabs will be inserted here -->
</div>

<div style="min-height:400px">
  <div id="profilingPlayersContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
    <!-- Player cards will be inserted here -->
  </div>
  
  <div id="profilingAnalyticsContainer" style="display:none">
    <!-- Analytics view will be inserted here -->
  </div>
  
  <div id="profilingEmptyState" style="display:none;text-align:center;padding:80px 40px;color:#64748b">
    <div style="font-size:64px;margin-bottom:20px;opacity:0.5">üë•</div>
    <div style="font-size:18px;font-weight:600;margin-bottom:8px">No PROFILING Data Found</div>
    <div style="font-size:14px;opacity:0.7;line-height:1.6">
      Please create these sheets:<br><br>
      <strong>PROFILING</strong> ‚Äî all players with email column<br>
      <strong>MANAGER</strong> ‚Äî manager name ‚Üí tags mapping<br>
      <strong>TYPE</strong> ‚Äî type name ‚Üí tags mapping<br>
    </div>
  </div>
</div>

<div id="profilingPlayerDetail" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center;padding:40px;overflow:auto">
  <!-- Player detail modal content -->
</div>

</div>

<div class="content" id="kpi-view">
<h1>üìà KPI Dashboard</h1>
<p class="desc">Monthly & weekly performance metrics</p>

<div class="kpi-tabs" id="kpiTabs"></div>

<div id="kpiNormalView">
<div class="kpi-layout">
<div class="kpi-sidebar">
<div class="period-header">üìÖ Select Periods</div>
<div id="kpiPeriods">Loading...</div>
</div>

<div class="kpi-main">
<div id="selectedMetricDisplay" class="selected-metric-display" style="display:none">
<div class="selected-metric-label">Selected Metric</div>
<div class="selected-metric-value" id="selectedMetricName">-</div>
</div>

<div class="kpi-chart-wrap">
<div class="chart-header">
<div class="metric-selector" id="kpiMetrics"></div>
</div>
<div class="chart-container"><canvas id="kpiChart"></canvas></div>
</div>

<div class="kpi-table-wrap">
<div class="metrics-filter" id="metricsFilter">
<div class="metrics-filter-header" onclick="toggleMetricsFilter()">
<span>üìä Visible Metrics</span>
<span class="metrics-filter-toggle">‚ñº</span>
</div>
<div class="metrics-grid" id="metricsFilterGrid"></div>
</div>
<div class="chart-title" style="margin-bottom:16px">üìã Data Table</div>
<div style="overflow:auto">
<table id="kpi-table"></table>
</div>
</div>
</div>
</div>
</div>

<div id="kpiCompareView" style="display:none">
<div class="compare-controls">
<div class="compare-selector">
<label class="compare-label">First Tab:</label>
<select id="compareTab1" class="compare-dropdown" onchange="renderCompareData()"></select>
</div>
<div class="compare-vs">VS</div>
<div class="compare-selector">
<label class="compare-label">Second Tab:</label>
<select id="compareTab2" class="compare-dropdown" onchange="renderCompareData()"></select>
</div>
</div>

<div class="kpi-main" style="width:100%">
<div id="compareMetricDisplay" class="selected-metric-display" style="display:none">
<div class="selected-metric-label">Comparing Metric</div>
<div class="selected-metric-value" id="compareMetricName">-</div>
</div>

<div class="kpi-chart-wrap">
<div class="chart-header">
<div class="metric-selector" id="compareMetrics"></div>
</div>
<div class="chart-container"><canvas id="compareChart"></canvas></div>
</div>

<div class="kpi-table-wrap">
<div class="chart-title" style="margin-bottom:16px">üìã Comparison Table</div>
<div style="overflow:auto">
<table id="compare-table"></table>
</div>
</div>
</div>
</div>
</div>

<div class="content" id="bonus-view">
<h1>üéÅ Bonus Report</h1>
<p class="desc">Bonus strategy analysis across all types</p>

<div style="display:flex;gap:12px;margin-bottom:20px">
<button class="metric-btn active" id="bonusMonthlyTab" onclick="switchBonusMode('monthly')">üìÖ Monthly</button>
<button class="metric-btn" id="bonusWeeklyTab" onclick="switchBonusMode('weekly')">üìÜ Weekly</button>
<button class="metric-btn" id="bonusDailyTab" onclick="switchBonusMode('daily')">üìã Daily</button>
</div>

<div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
<div style="font-weight:700;font-size:13px;color:#475569">Filter by Type:</div>
<div id="bonusTypeFilters" style="display:flex;gap:6px;flex-wrap:wrap"></div>
</div>

<div id="bonusSummaryCards" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px"></div>

<div id="bonusPieSection" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:24px"></div>

<div id="bonusColumnToggle" style="margin-bottom:12px;background:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 1px 3px rgba(0,0,0,0.05)">
<div style="display:flex;align-items:center;gap:8px;cursor:pointer" onclick="toggleBonusColPanel()">
<span style="font-weight:700;font-size:13px;color:#475569">‚öôÔ∏è Columns</span>
<span id="bonusColArrow" style="font-size:10px;color:#94a3b8">‚ñº</span>
</div>
<div id="bonusColumnChecks" style="display:none;margin-top:10px;display:none;grid-template-columns:repeat(4,1fr);gap:6px"></div>
</div>

<div class="table-wrap" style="max-height:calc(100vh - 200px)">
<table id="bonus-table"></table>
</div>
</div>

<div class="content" id="vip-view">
<h1>üìä Dashboard</h1>
<p class="desc">Unified Player Analytics</p>

<!-- Dashboard Type Tabs (Vip, Previp, etc.) -->
<div class="dash-type-tabs" id="dashTypeTabs" style="display:none"></div>

<div class="vip-tabs-wrap" style="display:none">
<button class="vip-tab active" data-tab="total" onclick="switchVIPTab('total')">TOTAL</button>
<button class="vip-tab" data-tab="vip" onclick="switchVIPTab('vip')">VIP</button>
<button class="vip-tab" data-tab="silent-vip" onclick="switchVIPTab('silent-vip')">SILENT VIP</button>
</div>

<div class="period-tabs-wrap">
<button class="period-tab" data-period="lifetime" onclick="switchPeriod('lifetime')">Lifetime</button>
<button class="period-tab active" data-period="30" onclick="switchPeriod('30')">30 days</button>
<button class="period-tab" data-period="90" onclick="switchPeriod('90')">90 days</button>
<button class="period-tab" data-period="7" onclick="switchPeriod('7')">7 days</button>
<button class="period-tab" data-period="1" onclick="switchPeriod('1')">1 day</button>
</div>

<div class="vip-active-filters" id="vipActiveFilters">
<div class="vip-active-filters-title">üîç Active Filters</div>
<div class="vip-active-filters-list" id="vipActiveFiltersList"></div>
</div>

<div class="vip-manager-selector" id="vipManagerSelector" style="display:none">
<div class="vip-manager-label">üë• By Manager</div>
<select class="vip-manager-dropdown" id="vipManagerDropdown" onchange="selectManager(this.value)">
<option value="">All Managers</option>
</select>
<div class="vip-manager-badge" id="vipManagerBadge" style="display:none"></div>
<button class="vip-manager-clear" id="vipManagerClearBtn" onclick="clearManager()" style="display:none">Clear</button>
</div>

<button class="vip-filter-toggle" onclick="toggleVIPFilterSidebar()">
üîç
<span class="vip-filter-badge" id="vip-filter-badge" style="display:none">0</span>
</button>

<!-- Filter Overlays -->
<div class="vip-filter-overlay" id="vipFilterOverlay" onclick="toggleVIPFilterSidebar()"></div>

<div class="vip-filter-sidebar" id="vipFilterSidebar">
<div class="vip-filter-header">
<div class="vip-filter-title">üîç VIP Filters</div>
<div class="vip-filter-subtitle">Instant filtering</div>
<button class="vip-filter-close" onclick="toggleVIPFilterSidebar()">√ó</button>
</div>

<div class="vip-filter-body">
<div class="vip-filter-section">
<div class="vip-filter-section-title">üè∑Ô∏è VIP Type</div>

<div class="vip-filter-group">
<div class="vip-filter-items" id="vipTypeFilterItems">
<div class="vip-filter-item" onclick="toggleVIPTypeFilter('VIP')">
<div class="vip-filter-checkbox" id="vipTypeVIP"></div>
<span class="vip-filter-item-text">VIP</span>
</div>
<div class="vip-filter-item" onclick="toggleVIPTypeFilter('Silent VIP')">
<div class="vip-filter-checkbox" id="vipTypeSilent"></div>
<span class="vip-filter-item-text">Silent VIP</span>
</div>
</div>
</div>
</div>

<div class="vip-filter-section">
<div class="vip-filter-section-title">üìä Player Attributes</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">VIP Manager</label>
<input type="text" class="vip-filter-search" id="vipManagerSearch" placeholder="Search managers...">
<div class="vip-filter-items" id="vipManagerFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Traffic Type</label>
<input type="text" class="vip-filter-search" id="vipTrafficSearch" placeholder="Search traffic types...">
<div class="vip-filter-items" id="vipTrafficFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Country</label>
<input type="text" class="vip-filter-search" id="vipCountrySearch" placeholder="Search countries...">
<div class="vip-filter-items" id="vipCountryFilterItems"></div>
</div>

<div class="vip-filter-group">
<label class="vip-filter-group-label">Currency</label>
<input type="text" class="vip-filter-search" id="vipCurrencySearch" placeholder="Search currencies...">
<div class="vip-filter-items" id="vipCurrencyFilterItems"></div>
</div>
</div>

<div class="vip-filter-section" id="vipDynamicFilters">
<div class="vip-filter-section-title">üéØ Dynamic Filters</div>
</div>
</div>

<div class="vip-filter-actions">
<button onclick="clearAllVIPFilters()">üîÑ Clear All Filters</button>
</div>
</div>

<div id="vip-content"></div>

</div>

<!-- ========== BONUS CALCULATOR VIEW ========== -->
<div class="content" id="bonus-calc-view">
<div id="bcApp" style="display:flex;flex-direction:column;height:100%;gap:12px;padding:0 20px">

  <!-- Compact header -->
  <div class="bc-header">
    <div class="bc-brand">
      <div class="bc-brand-icon">üíé</div>
      <div>
        <div class="bc-brand-title">Bonus Calculator</div>
        <div class="bc-brand-stats"><span>üé∞ <strong id="bcRtpCount">0</strong> games</span><span>üìä <strong id="bcCalcCount">0</strong> calcs</span></div>
      </div>
    </div>
    <div class="bc-email-wrap">
      <span class="bc-email-icon">üìß</span>
      <input type="email" id="bcEmailInput" class="bc-email" placeholder="Player email...">
    </div>
    <div class="bc-actions">
      <button id="bcRtpGamesBtn" onclick="bcToggleRtpPage()" class="bc-btn-icon" style="width:auto;padding:8px 14px;font-size:12px;font-weight:700;gap:4px;display:flex;align-items:center" title="RTP Games Database">üéÆ RTP</button>
      <button id="bcCalcBtn" onclick="bcCalculate()" class="bc-btn-calc">‚ö° Calculate</button>
      <button onclick="bcClearAll()" class="bc-btn-icon" title="Clear">üóëÔ∏è</button>
      <button id="bcRefreshBtn" onclick="bcRefreshConfig()" class="bc-btn-icon" title="Refresh">üîÑ</button>
    </div>
  </div>

  <!-- Category + Calculator tabs in one row -->
  <div class="bc-tabs-row">
    <div id="bcCategoryTabs" class="bc-cat-tabs"></div>
    <div class="bc-divider"></div>
    <div id="bcCalculatorTabs" class="bc-calc-tabs"></div>
  </div>

  <!-- Favorite games collapsible -->
  <div id="bcFavoriteGames" class="bc-favorites" style="display:none">
    <div class="bc-favorites-header">‚≠ê Favorite Games</div>
    <div id="bcFavoriteList" class="bc-favorites-list"></div>
  </div>

  <!-- Content grid (Calculator mode) -->
  <div class="bc-content-grid" id="bcCalcMode">
    <div class="bc-panel">
      <div class="bc-panel-header"><span class="bc-panel-icon">‚ö°</span> Input</div>
      <div id="bcInputFields"></div>
    </div>
    <div class="bc-panel bc-panel-results">
      <div class="bc-panel-header"><span class="bc-panel-icon">üìä</span> Results</div>
      <div id="bcOutputFields"></div>
      <div id="bcSummaryBox" class="bc-summary" style="display:none">
        <div class="bc-summary-header">
          <span>üìã Summary</span>
          <button onclick="bcCopySummary()" class="bc-btn-copy">Copy</button>
        </div>
        <div id="bcSummaryContent"></div>
      </div>
    </div>
  </div>

  <!-- RTP Games page -->
  <div id="bcRtpMode" style="display:none;flex:1;display:none;flex-direction:column;gap:12px;overflow:hidden;min-height:0">
    <!-- RTP toolbar -->
    <div class="bc-rtp-toolbar">
      <div class="bc-rtp-search-bar">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;opacity:.5">üîç</span>
        <input id="bcRtpSearchInput" type="search" placeholder="Search provider, slot, category..." oninput="bcRtpFilter()">
      </div>
      <select id="bcRtpProviderFilter" onchange="bcRtpFilter()" class="bc-rtp-select"><option value="">All Providers</option></select>
      <select id="bcRtpVolatilityFilter" onchange="bcRtpFilter()" class="bc-rtp-select"><option value="">All Volatility</option></select>
      <div style="margin-left:auto">
        <button onclick="bcRtpOpenEditor(0)" class="bc-btn-calc" style="font-size:12px;padding:8px 14px">+ Add Game</button>
      </div>
    </div>
    <!-- RTP stats + active filters -->
    <div class="bc-rtp-stats">
      <span id="bcRtpTotalGames">0 games</span>
      <span id="bcRtpFilteredGames"></span>
      <div id="bcRtpActiveFilters" class="bc-active-filters"></div>
    </div>
    <!-- RTP table -->
    <div class="bc-panel" style="flex:1;overflow:auto;padding:0">
      <table class="bc-rtp-table" id="bcRtpTable">
        <thead id="bcRtpThead"></thead>
        <tbody id="bcRtpTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- RTP Game Editor Modal -->
  <div id="bcRtpEditorModal" class="bc-modal-overlay" style="display:none" onclick="if(event.target===this)bcRtpCloseEditor()">
    <div class="bc-modal-card">
      <div class="bc-modal-header">
        <span id="bcRtpEditorTitle">Add Game</span>
        <button onclick="bcRtpCloseEditor()" class="bc-modal-close">‚úï</button>
      </div>
      <div class="bc-modal-body" id="bcRtpEditorBody"></div>
      <div class="bc-modal-footer">
        <button onclick="bcRtpCloseEditor()" class="bc-btn-icon" style="width:auto;padding:8px 16px;font-size:12px">Cancel</button>
        <button onclick="bcRtpSaveGame()" class="bc-btn-calc" style="font-size:12px;padding:8px 18px">üíæ Save</button>
      </div>
    </div>
  </div>

  <!-- RTP Game Detail Modal -->
  <!-- Loading -->
  <div id="bcLoading" class="bc-loading">
    <div class="bc-loading-inner">
      <div class="bc-spinner"></div>
      <span>Calculating...</span>
    </div>
  </div>

  <!-- Toast -->
  <div id="bcToast" class="bc-toast"></div>
</div>
</div>

</div>
</div>

<!-- Calendar Overlay -->
<div class="cal-overlay" id="calOverlay" onclick="if(event.target.id==='calOverlay')closeCalendar()">
  <div class="cal-month-bg" id="calMonthBg">
    <div class="cal-particles" id="calParticles"></div>
    <button class="cal-close-btn" onclick="closeCalendar()">‚úï</button>
    <div class="cal-container">
      <div class="cal-header">
        <div class="cal-nav">
          <button class="cal-nav-btn" onclick="calPrevMonth()">‚óÄ</button>
          <div class="cal-month-title" id="calMonthTitle">February 2026</div>
          <button class="cal-nav-btn" onclick="calNextMonth()">‚ñ∂</button>
        </div>
        <button class="cal-today-btn" onclick="calGoToday()">üìç Today</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="cal-detail-panel" id="calDetailPanel" style="display:none">
        <div class="cal-detail-title"><span id="calDetailIcon">üìÖ</span> <span id="calDetailDate">Select a day</span></div>
        <div id="calDetailList"></div>
      </div>
      <div class="cal-legend">
        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#dc2626"></div> Holiday</div>
        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#2563eb"></div> Promo</div>
        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#059669"></div> Tournament</div>
        <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#ea580c"></div> Birthday</div>
      </div>
    </div>
  </div>
</div>

<!-- Event Detail Modal -->
<div class="cal-modal-overlay" id="calEventModal" onclick="if(event.target.id==='calEventModal')closeCalEventModal()" style="display:none">
  <div class="cal-modal">
    <div class="cal-modal-header" id="calModalHeader">
      <div class="cal-modal-icon" id="calModalIcon">üéÑ</div>
      <div>
        <div class="cal-modal-title" id="calModalTitle">Event</div>
        <div class="cal-modal-subtitle" id="calModalSubtitle">Details</div>
      </div>
      <button class="cal-modal-close" onclick="closeCalEventModal()">‚úï</button>
    </div>
    <div class="cal-modal-body" id="calModalBody"></div>
  </div>
</div>
</div>

<div class="modal" id="modal" onclick="if(event.target===this)closeModal()">
<div class="modal-card">
<div class="modal-header">
<div class="modal-title" id="modalTitle">Players</div>
<div class="modal-tools">
<button class="btn-create" id="btnCreateSheet">üìÑ Create Sheet</button>
<button class="btn-close" onclick="closeModal()">‚úï Close</button>
</div>
</div>
<div class="modal-body" id="modalBody"></div>
</div>
</div>

<div class="modal" id="metricModal" style="display:none" onclick="if(event.target===this)closeMetricModal()">
<div class="modal-card" style="max-width:1400px;max-height:92vh">
<div class="modal-header">
<div class="modal-title" id="metricModalTitle">Metric Details</div>
<div class="modal-tools">
<button class="btn-close" onclick="closeMetricModal()">‚úï Close</button>
</div>
</div>
<div class="modal-body" id="metricModalBody" style="overflow-y:auto;max-height:calc(92vh - 80px)"></div>
</div>
</div>

<div class="toast" id="toast"></div>

<!-- Global RTP Game Detail Modal (used by both BC and Profiling) -->
<div id="bcRtpDetailModal" class="bc-modal-overlay" style="display:none" onclick="if(event.target===this)this.style.display='none'">
  <div class="bc-modal-card" style="max-width:500px">
    <div class="bc-modal-header">
      <span id="bcRtpDetailTitle">Game Details</span>
      <button onclick="document.getElementById('bcRtpDetailModal').style.display='none'" class="bc-modal-close">‚úï</button>
    </div>
    <div class="bc-modal-body" id="bcRtpDetailBody"></div>
  </div>
</div>

<!-- Add Game to Player Modal -->
<div id="bcAddToPlayerModal" class="bc-modal-overlay" style="display:none" onclick="if(event.target===this)this.style.display='none'">
  <div class="bc-modal-card" style="max-width:420px">
    <div class="bc-modal-header">
      <span id="bcAddToPlayerTitle">Add to Player</span>
      <button onclick="document.getElementById('bcAddToPlayerModal').style.display='none'" class="bc-modal-close">‚úï</button>
    </div>
    <div class="bc-modal-body" id="bcAddToPlayerBody"></div>
  </div>
</div>

<script>
// Verify Chart.js loaded
if(typeof Chart==='undefined'){
  console.error('Chart.js failed to load!');
  alert('Chart library not loaded. Please refresh the page.');
}else{
  try{
    Chart.register(ChartDataLabels);
  }catch(e){
    console.error('ChartDataLabels registration failed:',e);
  }
}

let allData=null,retentionData=null,weeklyRetentionData=null,kpiDataByTab={},vipData=null,selectedMonths=[],currentMetric='FTD',currentVIPTab='total',barChart=null,retentionChart=null,kpiChart=null,compareChart=null,currentRetentionMonth=0;
let depositFilters={type:[],manager:[],trafficType:[],country:[]};
let retentionFilters={type:[],manager:[],trafficType:[],country:[]};
let profilingFilters={};
let tagToTypeMap={}; // Global TYPE mapping from Google Sheets
let typeMapping={}; // TYPE -> [tags] mapping
let typeToTotal={}; // TYPE -> TOTAL group
let totalGroups={}; // TOTAL group -> [types]
let tagToManagerMap={}; // Global MANAGER mapping: tag ‚Üí manager name
let managerMapping={}; // Manager name ‚Üí [tags]
let allPlayersData=[];
let depositCellsLoaded = false;
let retentionCellsLoaded = false;
let playersCellMap=new Map();
let retentionPlayersCellMap=new Map();
let weeklyRetentionPlayersCellMap=new Map();
let kpiSelectedPeriods=new Set(),kpiCurrentMetric=null,kpiCurrentTab='VIP',kpiVisibleMetrics=new Set();
let compareTab1='',compareTab2='',compareCurrentMetric=null;
let heatmapShowPercent=true;
let metricFormats={};
let retentionMode='monthly';
let currentRetentionWeek=0;
const depositRanges=['FTD','2+','3+','4+','5+','6+','7+','8+','9+','10+','11-15','16-20','21-25','26-30','31-40','41-50','50+'];
const pieColors=['#667eea','#3b82f6','#f59e0b','#8b5cf6','#ef4444','#64748b','#06b6d4','#ec4899','#84cc16','#f97316'];

// ============================================
// GLOBAL: Copy email on double-click
// ============================================
function copyEmailToClipboard(email) {
  if (!email) return;
  
  // Create temporary input
  var temp = document.createElement('input');
  temp.value = email;
  temp.style.position = 'absolute';
  temp.style.left = '-9999px';
  document.body.appendChild(temp);
  temp.select();
  
  try {
    document.execCommand('copy');
    
    // Show toast notification
    showCopyToast('üìã Email copied: ' + email);
  } catch (err) {
    console.error('Failed to copy:', err);
  }
  
  document.body.removeChild(temp);
}

function showCopyToast(message) {
  var toast = document.getElementById('copyToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'copyToast';
    toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#10b981;color:#fff;padding:16px 24px;border-radius:12px;font-weight:700;font-size:14px;z-index:100000;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;pointer-events:none';
    document.body.appendChild(toast);
    
    var style = document.createElement('style');
    style.textContent = '@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }';
    document.head.appendChild(style);
  }
  
  toast.textContent = message;
  toast.style.display = 'block';
  toast.style.animation = 'slideIn 0.3s ease';
  
  setTimeout(function() {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(function() {
      toast.style.display = 'none';
    }, 300);
  }, 2000);
}

function makeEmailCopyable(element, email) {
  if (!element || !email) return;
  
  element.style.cursor = 'pointer';
  element.title = 'Double-click to copy email';
  
  element.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    copyEmailToClipboard(email);
  });
}

// Dynamic Tabs System
let dynamicTabsConfig=null;
let dynamicTabsData={};  // Stores data for each dynamic tab group

// Icon mapping for dynamic tabs
const tabIconMap={
  'vip_dashboard':'üëë',
  'previp_dashboard':'‚è∞',
  'one_day':'üìÖ',
  'retention':'üìä',
  'weekly':'üóìÔ∏è'
};

// Load dynamic tabs configuration on startup
function loadDynamicTabsConfig(){
  console.log('üîÑ Loading dynamic tabs config...');
  google.script.run
    .withSuccessHandler(function(config){
      console.log('‚úÖ Dynamic tabs config loaded:',config);
      dynamicTabsConfig=config;
      buildDynamicSidebar();
    })
    .withFailureHandler(function(err){
      console.error('‚ùå Failed to load dynamic tabs config:',err);
    })
    .getVIPTabsConfig();
}

// Build single Dashboard sidebar item from all dynamic groups
function buildDynamicSidebar(){
  if(!dynamicTabsConfig){
    console.log('‚ö†Ô∏è No dynamic tabs config available');
    return;
  }
  
  const container=document.getElementById('dynamicTabsContainer');
  if(!container){
    console.error('‚ùå dynamicTabsContainer not found!');
    return;
  }
  
  container.innerHTML='';
  
  const sortedGroups=Object.keys(dynamicTabsConfig).sort();
  if(sortedGroups.length===0) return;
  
  // Store group list globally
  window.dashboardGroups = sortedGroups.map(function(prefix){
    return { prefix: prefix, id: dynamicTabsConfig[prefix].id, displayName: dynamicTabsConfig[prefix].displayName };
  });
  
  // Create single Dashboard nav item
  const navItem=document.createElement('div');
  navItem.className='nav-item';
  navItem.dataset.view='dashboard_unified';
  navItem.dataset.dynamic='true';
  navItem.dataset.tooltip='Dashboard';
  
  const iconSpan=document.createElement('span');
  iconSpan.className='nav-icon';
  iconSpan.textContent='üìä';
  
  const labelSpan=document.createElement('span');
  labelSpan.textContent='Dashboard';
  labelSpan.style.flex='1';
  
  const toggleSpan=document.createElement('span');
  toggleSpan.className='sidebar-submenu-toggle';
  toggleSpan.id='dashboardUnifiedSubmenuToggle';
  toggleSpan.textContent='‚ñº';
  toggleSpan.onclick=function(e){
    e.stopPropagation();
    toggleDynamicSubmenu('dashboardUnified');
  };
  
  navItem.onclick=function(){
    switchToDashboardView();
  };
  
  navItem.appendChild(iconSpan);
  navItem.appendChild(labelSpan);
  navItem.appendChild(toggleSpan);
  
  const submenu=document.createElement('div');
  submenu.className='sidebar-submenu';
  submenu.id='dashboardUnifiedSubmenu';
  
  container.appendChild(navItem);
  container.appendChild(submenu);
  
  console.log('‚úÖ Unified Dashboard sidebar built with',sortedGroups.length,'groups');
}

// Switch to unified Dashboard view
function switchToDashboardView(targetGroupId){
  console.log('Switching to Dashboard view, target group:', targetGroupId || 'all');
  
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  
  const navItem=document.querySelector('.nav-item[data-view="dashboard_unified"]');
  if(navItem) navItem.classList.add('active');
  
  const vipView=document.getElementById('vip-view');
  if(vipView) vipView.classList.add('active');
  
  var groups = window.dashboardGroups || [];
  
  // Determine what to show
  if(!targetGroupId && !window.currentDashboardTab){
    // Default: first group
    targetGroupId = groups.length > 0 ? groups[0].id : '';
  }
  var tabId = targetGroupId || window.currentDashboardTab || '';
  window.currentDashboardTab = tabId;
  window.currentDashboardGroup = tabId;
  
  // Build type tabs
  buildDashboardTypeTabs(tabId);
  
  // Handle special tabs
  if(tabId === '__DASH_TOTAL__'){
    renderAggregatedDashboard(groups.map(function(g){ return g.id; }), 'TOTAL');
    return;
  }
  if(tabId.indexOf('__DASH_TG__:') === 0){
    var grpName = tabId.replace('__DASH_TG__:', '');
    var subTypes = totalGroups[grpName] || [];
    var matchIds = [];
    groups.forEach(function(g){
      if(subTypes.indexOf(g.displayName) !== -1 || subTypes.indexOf(g.id) !== -1) matchIds.push(g.id);
    });
    renderAggregatedDashboard(matchIds, grpName);
    return;
  }
  
  // Regular group
  var activeGroup = groups.find(function(g){ return g.id === tabId; }) || groups[0];
  if(activeGroup){
    window.currentDashboardGroup = activeGroup.id;
    loadAndRenderGroup(activeGroup.id);
    populateDashboardSubmenu();
  }
}

// Build type tabs (TOTAL first, then total-type groups, then individual tabs)
function buildDashboardTypeTabs(activeGroupId){
  var container = document.getElementById('dashTypeTabs');
  if(!container) return;
  
  var groups = window.dashboardGroups || [];
  if(groups.length <= 1 && Object.keys(totalGroups).length === 0){
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = '';
  
  var currentActive = window.currentDashboardTab || activeGroupId || (groups.length > 0 ? groups[0].id : '');
  var hasTG = Object.keys(totalGroups).length > 0;
  
  // Helper: is current active inside a TG?
  function getActiveTG(){
    if(currentActive && currentActive.indexOf('__DASH_TG__:') === 0) return currentActive.replace('__DASH_TG__:', '');
    // Check if individual type is part of a TG
    var g = groups.find(function(gr){ return gr.id === currentActive; });
    if(g){
      var tgKeys = Object.keys(totalGroups);
      for(var i=0;i<tgKeys.length;i++){
        var subs = totalGroups[tgKeys[i]];
        if(subs.indexOf(g.displayName)!==-1 || subs.indexOf(g.id)!==-1) return tgKeys[i];
      }
    }
    return null;
  }
  
  // ‚îÄ‚îÄ TOTAL tab ‚îÄ‚îÄ
  if(groups.length > 1){
    var totalTab = document.createElement('button');
    var isTotalActive = currentActive === '__DASH_TOTAL__';
    totalTab.className = 'dash-type-tab' + (isTotalActive ? ' active' : '');
    totalTab.dataset.dashTab = '__DASH_TOTAL__';
    var totalCount = 0;
    groups.forEach(function(g){ var td = dynamicTabsData[g.id]; if(td && td.playerCounts) totalCount += td.playerCounts.total || 0; });
    totalTab.innerHTML = 'TOTAL <span class="dash-type-count">' + totalCount + '</span>';
    totalTab.onclick = function(){
      window.currentDashboardTab = '__DASH_TOTAL__';
      window.currentDashboardGroup = '__DASH_TOTAL__';
      activateDashTab(container, this);
      hideDashSubTabs();
      renderAggregatedDashboard(groups.map(function(g){ return g.id; }), 'TOTAL');
    };
    container.appendChild(totalTab);
  }
  
  // ‚îÄ‚îÄ Type-total group tabs ‚îÄ‚îÄ
  if(hasTG){
    Object.keys(totalGroups).sort().forEach(function(grpName){
      var subTypes = totalGroups[grpName];
      var matchingGroupIds = [];
      groups.forEach(function(g){
        if(subTypes.indexOf(g.displayName) !== -1 || subTypes.indexOf(g.id) !== -1) matchingGroupIds.push(g.id);
      });
      var grpCount = 0;
      matchingGroupIds.forEach(function(gid){ var td = dynamicTabsData[gid]; if(td && td.playerCounts) grpCount += td.playerCounts.total || 0; });
      
      var tabVal = '__DASH_TG__:' + grpName;
      var isActive = currentActive === tabVal || getActiveTG() === grpName;
      var tab = document.createElement('button');
      tab.className = 'dash-type-tab' + (isActive ? ' active' : '');
      tab.dataset.dashTab = tabVal;
      tab.innerHTML = grpName + ' <span class="dash-type-count">' + grpCount + '</span>';
      tab.onclick = function(){
        window.currentDashboardTab = tabVal;
        window.currentDashboardGroup = tabVal;
        activateDashTab(container, this);
        renderAggregatedDashboard(matchingGroupIds, grpName);
        buildDashSubTabs(container, grpName, matchingGroupIds);
      };
      container.appendChild(tab);
    });
  } else {
    // No TG - show individual tabs directly
    groups.forEach(function(group){
      var isActive = currentActive === group.id;
      var tab = document.createElement('button');
      tab.className = 'dash-type-tab' + (isActive ? ' active' : '');
      tab.dataset.dashTab = group.id;
      var count = (dynamicTabsData[group.id] && dynamicTabsData[group.id].playerCounts) ? dynamicTabsData[group.id].playerCounts.total : '';
      tab.innerHTML = group.displayName + (count ? ' <span class="dash-type-count">' + count + '</span>' : '');
      tab.onclick = function(){
        window.currentDashboardTab = group.id;
        window.currentDashboardGroup = group.id;
        activateDashTab(container, this);
        hideDashSubTabs();
        loadAndRenderGroup(group.id);
      };
      container.appendChild(tab);
    });
  }
  
  // Show sub-tabs if a TG is active
  var activeTG = getActiveTG();
  if(activeTG){
    var subTypes = totalGroups[activeTG] || [];
    var matchIds = [];
    groups.forEach(function(g){
      if(subTypes.indexOf(g.displayName) !== -1 || subTypes.indexOf(g.id) !== -1) matchIds.push(g.id);
    });
    buildDashSubTabs(container, activeTG, matchIds);
  }
}

function activateDashTab(container, activeBtn){
  container.querySelectorAll('.dash-type-tab').forEach(function(t){ t.classList.remove('active'); });
  activeBtn.classList.add('active');
}

function isGroupInTotalGroup(group){
  var types = Object.values(totalGroups);
  for(var i = 0; i < types.length; i++){
    if(types[i].indexOf(group.displayName) !== -1 || types[i].indexOf(group.id) !== -1) return true;
  }
  return false;
}

function buildDashSubTabs(container, grpName, matchingGroupIds){
  var existing = document.getElementById('dashSubTypeTabs');
  if(existing) existing.remove();
  
  if(matchingGroupIds.length <= 1) return;
  
  var groups = window.dashboardGroups || [];
  var active = window.currentDashboardTab || '';
  var subRow = document.createElement('div');
  subRow.id = 'dashSubTypeTabs';
  subRow.style.cssText = 'display:flex;gap:6px;width:100%;padding:4px 0;flex-wrap:wrap';
  
  var tgVal = '__DASH_TG__:' + grpName;
  var isAllActive = active === tgVal;
  
  var allBtn = document.createElement('button');
  allBtn.style.cssText = 'padding:6px 16px;border-radius:16px;border:1.5px solid '+(isAllActive?'#667eea':'#e2e8f0')+';background:'+(isAllActive?'#667eea15':'#fff')+';color:'+(isAllActive?'#667eea':'#64748b')+';font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s';
  allBtn.textContent = 'All ' + grpName;
  allBtn.onclick = function(){
    window.currentDashboardTab = tgVal;
    window.currentDashboardGroup = tgVal;
    renderAggregatedDashboard(matchingGroupIds, grpName);
    highlightSubTab(subRow, this);
  };
  subRow.appendChild(allBtn);
  
  matchingGroupIds.forEach(function(gid){
    var g = groups.find(function(gr){ return gr.id === gid; });
    if(!g) return;
    var isSub = active === gid;
    var btn = document.createElement('button');
    var cnt = dynamicTabsData[gid] && dynamicTabsData[gid].playerCounts ? dynamicTabsData[gid].playerCounts.total : 0;
    btn.style.cssText = 'padding:6px 16px;border-radius:16px;border:1.5px solid '+(isSub?'#667eea':'#e2e8f0')+';background:'+(isSub?'#667eea15':'#fff')+';color:'+(isSub?'#667eea':'#64748b')+';font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s';
    btn.textContent = g.displayName + ' ' + cnt;
    btn.onclick = function(){
      window.currentDashboardTab = gid;
      window.currentDashboardGroup = gid;
      loadAndRenderGroup(gid);
      highlightSubTab(subRow, this);
    };
    subRow.appendChild(btn);
  });
  
  container.appendChild(subRow);
}

function highlightSubTab(row, activeBtn){
  row.querySelectorAll('button').forEach(function(b){ b.style.borderColor='#e2e8f0'; b.style.background='#fff'; b.style.color='#64748b'; });
  activeBtn.style.borderColor='#667eea'; activeBtn.style.background='#667eea15'; activeBtn.style.color='#667eea';
}

function hideDashSubTabs(){
  var el = document.getElementById('dashSubTypeTabs');
  if(el) el.remove();
}

function loadAndRenderGroup(groupId){
  if(dynamicTabsData[groupId]){
    renderDynamicTab(groupId);
  } else {
    loadDynamicTabData(groupId);
  }
}

// Aggregate data from multiple groups into one vipData-like object
function aggregateGroupsData(groupIds){
  var merged = {
    allPlayers: { vip: [], silentVip: [] },
    playerCounts: { total: 0, vip: 0, silentVip: 0 },
    metrics: { sums: {}, pies: {}, total: { count: 0, vipCount: 0, silentVipCount: 0 } },
    vocabulary: {},
    displayName: 'Aggregated'
  };
  
  groupIds.forEach(function(gid){
    var td = dynamicTabsData[gid];
    if(!td) return;
    
    // Merge players
    if(td.allPlayers){
      merged.allPlayers.vip = merged.allPlayers.vip.concat(td.allPlayers.vip || []);
      merged.allPlayers.silentVip = merged.allPlayers.silentVip.concat(td.allPlayers.silentVip || []);
    }
    
    // Merge counts
    if(td.playerCounts){
      merged.playerCounts.total += td.playerCounts.total || 0;
      merged.playerCounts.vip += td.playerCounts.vip || 0;
      merged.playerCounts.silentVip += td.playerCounts.silentVip || 0;
    }
    
    // Merge vocabulary
    if(td.vocabulary){
      Object.keys(td.vocabulary).forEach(function(k){
        if(!merged.vocabulary[k]) merged.vocabulary[k] = td.vocabulary[k];
      });
    }
    
    // Merge metrics
    if(td.metrics){
      // Sums
      if(td.metrics.sums){
        Object.keys(td.metrics.sums).forEach(function(k){
          var s = td.metrics.sums[k];
          if(!merged.metrics.sums[k]){
            merged.metrics.sums[k] = { total: 0, vip: 0, silentVip: 0, name: s.name, type: s.type };
          }
          merged.metrics.sums[k].total += s.total || 0;
          merged.metrics.sums[k].vip += s.vip || 0;
          merged.metrics.sums[k].silentVip += s.silentVip || 0;
        });
      }
      // Pies
      if(td.metrics.pies){
        Object.keys(td.metrics.pies).forEach(function(k){
          var p = td.metrics.pies[k];
          if(!merged.metrics.pies[k]) merged.metrics.pies[k] = { total: {}, vip: {}, silentVip: {} };
          ['total','vip','silentVip'].forEach(function(cat){
            if(p[cat]){
              Object.keys(p[cat]).forEach(function(v){
                merged.metrics.pies[k][cat][v] = (merged.metrics.pies[k][cat][v] || 0) + (p[cat][v] || 0);
              });
            }
          });
        });
      }
      // Total counts
      if(td.metrics.total){
        merged.metrics.total.count += td.metrics.total.count || 0;
        merged.metrics.total.vipCount += td.metrics.total.vipCount || 0;
        merged.metrics.total.silentVipCount += td.metrics.total.silentVipCount || 0;
      }
    }
  });
  
  return merged;
}

function renderAggregatedDashboard(groupIds, title){
  // Ensure all groups are loaded
  var notLoaded = groupIds.filter(function(gid){ return !dynamicTabsData[gid]; });
  if(notLoaded.length > 0){
    var vipContent = document.getElementById('vip-content');
    if(vipContent) vipContent.innerHTML = '<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚è≥</div><div style="font-size:18px;font-weight:600">Loading all data...</div></div>';
    var loadCount = 0;
    notLoaded.forEach(function(gid){
      google.script.run
        .withSuccessHandler(function(data){
          dynamicTabsData[gid] = data;
          loadCount++;
          if(loadCount >= notLoaded.length){
            doRenderAggregated(groupIds, title);
          }
        })
        .withFailureHandler(function(err){
          console.error('Failed loading', gid, err);
          loadCount++;
          if(loadCount >= notLoaded.length){
            doRenderAggregated(groupIds, title);
          }
        })
        .getVIPGroupData(gid);
    });
  } else {
    doRenderAggregated(groupIds, title);
  }
}

function doRenderAggregated(groupIds, title){
  var merged = aggregateGroupsData(groupIds);
  
  // Set as current vipData
  vipData = merged;
  window.vipAllPlayers = merged.allPlayers || null;
  currentVIPTab = 'total';
  
  // Update header
  var h1 = document.querySelector('#vip-view h1');
  if(h1) h1.textContent = title;
  
  renderVIPDashboard();
  renderVIPFilters();
  
  // Refresh tab counts
  var groups = window.dashboardGroups || [];
  buildDashboardTypeTabs(window.currentDashboardTab);
}

// Populate unified manager submenu from all groups
function populateDashboardSubmenu(){
  var submenu = document.getElementById('dashboardUnifiedSubmenu');
  var toggle = document.getElementById('dashboardUnifiedSubmenuToggle');
  if(!submenu) return;
  
  var managersSet = new Set();
  var groups = window.dashboardGroups || [];
  
  groups.forEach(function(group){
    var data = dynamicTabsData[group.id];
    if(!data || !data.allPlayers) return;
    var allPlayersList = [];
    if(data.allPlayers.vip) allPlayersList.push.apply(allPlayersList, data.allPlayers.vip);
    if(data.allPlayers.silentVip) allPlayersList.push.apply(allPlayersList, data.allPlayers.silentVip);
    allPlayersList.forEach(function(player){
      var manager = getPlayerManager(player);
      if(manager) managersSet.add(manager);
    });
  });
  
  var managers = Array.from(managersSet).sort();
  
  if(managers.length === 0){
    submenu.innerHTML = '';
    if(toggle) toggle.style.display = 'none';
    return;
  }
  
  submenu.innerHTML = '';
  managers.forEach(function(manager){
    var item = document.createElement('div');
    item.className = 'sidebar-submenu-item';
    item.innerHTML = '<span class="sidebar-submenu-item-icon">üë§</span><span>' + manager + '</span>';
    item.onclick = function(){
      var dropdown = document.getElementById('vipManagerDropdown');
      if(dropdown){
        dropdown.value = manager;
        selectManager(manager);
      }
    };
    submenu.appendChild(item);
  });
  
  if(toggle) toggle.style.display = 'inline-block';
  submenu.classList.add('open');
  if(toggle) toggle.classList.add('open');
}

// Setup click handlers for dynamic tabs
function setupDynamicNavHandlers(){
  document.querySelectorAll('.nav-item[data-dynamic="true"]').forEach(item=>{
    item.onclick=function(){
      const viewId=item.dataset.view;
      switchToDynamicView(viewId);
    };
  });
}

// Switch to dynamic view (now routes through unified dashboard)
function switchToDynamicView(groupId){
  switchToDashboardView(groupId);
}



// Toggle dynamic submenu
function toggleDynamicSubmenu(groupId){
  const submenu=document.getElementById(groupId+'Submenu');
  const toggle=document.getElementById(groupId+'SubmenuToggle');
  
  if(!submenu||!toggle)return;
  
  submenu.classList.toggle('open');
  toggle.classList.toggle('open');
}

// Load data for dynamic tab (uses cached data or fetches)
function loadDynamicTabData(groupId){
  // Check if already loaded
  if(dynamicTabsData[groupId]){
    renderDynamicTab(groupId);
    populateDashboardSubmenu();
    return;
  }
  
  console.log('üì• Loading data for',groupId,'...');
  
  const vipContent=document.getElementById('vip-content');
  if(vipContent){
    vipContent.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚è≥</div><div style="font-size:18px;font-weight:600">Loading Data...</div></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(data){
      console.log('‚úÖ Data loaded for',groupId,':',data);
      dynamicTabsData[groupId]=data;
      renderDynamicTab(groupId);
      populateDashboardSubmenu();
    })
    .withFailureHandler(function(err){
      console.error('‚ùå Failed to load data for',groupId,':',err);
      if(vipContent){
        vipContent.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">Failed to Load Data</div><div style="font-size:14px">' + err + '</div></div>';
      }
    })
    .getVIPGroupData(groupId);
}

// Reset VIP tab labels to default
function resetVIPTabLabels(){
  const vipTabBtn = document.querySelector('.vip-tab[data-tab="vip"]');
  const silentTabBtn = document.querySelector('.vip-tab[data-tab="silent-vip"]');
  
  if(vipTabBtn) vipTabBtn.textContent = 'VIP';
  if(silentTabBtn) silentTabBtn.textContent = 'SILENT VIP';
}

// Render dynamic tab (simple approach - reuse VIP Dashboard rendering)
function renderDynamicTab(groupId){
  const data=dynamicTabsData[groupId];
  
  if(!data){
    console.warn('No data for',groupId);
    return;
  }
  
  // Update header
  var h1 = document.querySelector('#vip-view h1');
  if(h1){
    var displayName = data.displayName || 'Dashboard';
    h1.textContent = displayName;
  }
  
  // Handle VIP/SILENT VIP sub-tabs visibility
  const vipTabBtn = document.querySelector('.vip-tab[data-tab="vip"]');
  const silentTabBtn = document.querySelector('.vip-tab[data-tab="silent-vip"]');
  const hasSilent = data.playerCounts && data.playerCounts.silentVip > 0;
  
  if(vipTabBtn) {
    vipTabBtn.textContent = hasSilent ? 'VIP' : 'ALL';
    vipTabBtn.style.display = hasSilent ? '' : 'none';
  }
  if(silentTabBtn) {
    silentTabBtn.textContent = 'SILENT VIP';
    silentTabBtn.style.display = hasSilent ? '' : 'none';
  }
  
  // Set vipData
  vipData=data;
  window.vipAllPlayers = data.allPlayers || null;
  
  currentVIPTab='total';
  
  // Render VIP Dashboard
  renderVIPDashboard();
  renderVIPFilters();
  
  // Populate manager submenu
  populateDynamicSubmenu(groupId,data);
}

// Populate manager submenu for dynamic tab (now uses unified dashboard)
function populateDynamicSubmenu(groupId,data){
  // Just refresh the unified submenu
  populateDashboardSubmenu();
}

document.querySelectorAll('.nav-item:not([data-dynamic])').forEach(item=>{item.onclick=()=>{
document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
item.classList.add('active');
const view=item.dataset.view;
document.getElementById(view+'-view').classList.add('active');
if(view==='retention'){
switchRetentionMode('monthly');
}else if(view==='deposit'){
renderBarChart();
renderDepositTable();
}else if(view==='kpi'){
if(kpiCurrentTab){
  renderKpiSidebar();
  renderKpiMetrics();
  if(kpiCurrentMetric && kpiSelectedPeriods.size > 0){
    renderKpiChart();
    renderKpiTable();
  }
}
}else if(view==='bonus'){
  if(!bonusDataLoaded) loadBonusData();
  else renderBonusReport();
}else if(view==='vip'){
resetVIPTabLabels();
renderVIPDashboard();
}
}});

loadData();

/**
 * Preload filter options (managers, traffic types) during splash
 */
function loadFilterOptions() {
  return new Promise((resolve) => {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(options) {
          if (options && !options.error) {
            vipManagerMapping = options.managerMapping || {};
            vipTrafficMapping = options.trafficMapping || {};
            availableManagers = options.managers || [];
            window._filterOptionsPreloaded = true;
            console.log('‚úÖ Filter options preloaded:', availableManagers.length, 'managers,', Object.keys(vipTrafficMapping).length, 'traffic types');
          }
          resolve();
        })
        .withFailureHandler(function(err) {
          console.error('‚ùå Failed to preload filter options:', err);
          resolve();
        })
        .getVIPFilterOptions();
    } else {
      resolve();
    }
  });
}

function loadData(){
  Promise.all([
    loadTypeMapping(),
    loadDepositData(),
    loadRetentionData(),
    loadWeeklyRetentionData(),
    loadKpiData(),
    loadProfilingData(),
    loadDynamicTabsConfigAsync(),  // ‚úÖ Unified dashboard loads all VIP/Previp data
    loadFilterOptions(),
    loadBonusCalcConfig(),
    preloadHomeData(),
    preloadCryptoRates(),
    preloadBirthdays(),
    preloadPromoPlan()
  ]).then(()=>{
    document.getElementById('splash').classList.add('hide');
    setupGlobalClickHandler();
    renderInitialFilters();
    renderBarChart();
    renderDepositTable();
    
    // ‚úÖ Open Home page by default
    setTimeout(function() { openHomePage(); }, 300);
    
    // ‚úÖ Seed global filters from VIP data immediately (don't wait for cell batches)
    seedGlobalFiltersFromVIP();
    
    setTimeout(()=>{
      loadAllPlayersForFilters();
      loadAllRetentionPlayersForFilters();
    },2000);
  });
}

/**
 * Seed global filters immediately from VIP data (don't wait for cell batch loading)
 */
function seedGlobalFiltersFromVIP() {
  if (!window.vipAllPlayers) return;
  
  var allVipPlayers = [];
  if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
    allVipPlayers = allVipPlayers.concat(vipAllPlayers.vip);
  }
  if (vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
    allVipPlayers = allVipPlayers.concat(vipAllPlayers.silentVip);
  }
  
  if (allVipPlayers.length === 0) return;
  
  // Push VIP players into allPlayersData if empty
  if (allPlayersData.length === 0) {
    allPlayersData.push.apply(allPlayersData, allVipPlayers);
    console.log('‚úÖ Seeded allPlayersData from VIP:', allVipPlayers.length, 'players');
    renderGlobalFilters();
  }
}

// Async: Load unified dashboard data (replaces old dynamic tabs system)
function loadDynamicTabsConfigAsync(){
  return new Promise((resolve)=>{
    console.log('üîÑ Loading unified dashboard data...');
    google.script.run
      .withSuccessHandler(function(result){
        console.log('‚úÖ Unified dashboard loaded:', result);
        if(result && !result.error && result.types && result.typesData){
          window.unifiedDashboard = result;
          
          // Build fake dynamicTabsConfig for compatibility
          dynamicTabsConfig = {};
          result.types.forEach(function(typeName){
            var td = result.typesData[typeName];
            dynamicTabsConfig[typeName] = {
              id: td.groupId,
              displayName: td.displayName,
              sheets: []
            };
            // Store data directly
            dynamicTabsData[td.groupId] = td;
          });
          
          // Build sidebar
          buildDynamicSidebar();
          populateDashboardSubmenu();
          
          // Seed vipAllPlayers for global filters
          var allP = [];
          result.types.forEach(function(typeName){
            var td = result.typesData[typeName];
            if(td.allPlayers){
              if(td.allPlayers.vip) allP.push.apply(allP, td.allPlayers.vip);
              if(td.allPlayers.silentVip) allP.push.apply(allP, td.allPlayers.silentVip);
            }
          });
          window.vipAllPlayers = { vip: allP, silentVip: [] };
          
          // Set initial vipData to first type for compatibility
          if(result.types.length > 0){
            var firstId = result.typesData[result.types[0]].groupId;
            vipData = dynamicTabsData[firstId];
          }
        }
        resolve();
      })
      .withFailureHandler(function(err){
        console.error('‚ùå Failed to load dashboard:',err);
        resolve();
      })
      .getUnifiedDashboardData();
  });
}

// Legacy compat - no longer needed
function loadAllDynamicTabsData(){
  return Promise.resolve();
}


function switchRetentionMode(mode){
retentionMode=mode;
document.getElementById('retentionMonthlyTab').classList.toggle('active',mode==='monthly');
document.getElementById('retentionWeeklyTab').classList.toggle('active',mode==='weekly');
if(mode==='monthly'){
if(retentionData&&retentionData.rows&&retentionData.rows.length>0){
renderRetentionMetricSelector();
renderRetentionChart();
renderRetentionTable();
}else{
document.getElementById('retention-table').innerHTML='<div class="err">No monthly retention data available</div>';
}
}else{
if(weeklyRetentionData&&weeklyRetentionData.rows&&weeklyRetentionData.rows.length>0){
renderWeeklyRetentionMetricSelector();
renderWeeklyRetentionChart();
renderWeeklyRetentionTable();
}else{
document.getElementById('retentionMetricSelector').innerHTML='';
document.getElementById('retention-table').innerHTML='<div class="err">No weekly retention sheets found. Create sheets with format: DD.MM - DD.MM FTD / DD.MM - DD.MM ACTIVE</div>';
if(retentionChart)retentionChart.destroy();
}
}
}

function parseWeekDate(weekStr){const parts=weekStr.split('-');if(parts.length!==2)return null;const startParts=parts[0].trim().split('.');if(startParts.length!==2)return null;const day=parseInt(startParts[0]);const month=parseInt(startParts[1]);const year=month>=7?2024:2025;return new Date(year,month-1,day)}
function sortWeeklyData(data){console.log('=== SORT WEEKLY DATA DEBUG ===');if(!data||!data.weeks||!data.rows){console.log('No data to sort');return data}console.log('ORIGINAL data:',JSON.parse(JSON.stringify(data)));const weekDates=data.weeks.map(w=>({week:w,date:parseWeekDate(w),dateStr:parseWeekDate(w)?parseWeekDate(w).toISOString():'null'}));console.log('Week dates:',weekDates);weekDates.sort((a,b)=>{if(!a.date||!b.date)return 0;return a.date-b.date});const sortedWeeks=weekDates.map(w=>w.week);console.log('SORTED weeks:',sortedWeeks);const originalWeeks=data.weeks;const sortedRows=data.rows.map(row=>{const originalFtdIdx=originalWeeks.indexOf(row.week);const sortedFtdIdx=sortedWeeks.indexOf(row.week);console.log('Processing row ' + row.week + ': originalFtdIdx=' + originalFtdIdx + ', sortedFtdIdx=' + sortedFtdIdx);const newRow={week:row.week,ftdCount:row.ftdCount,retention:[]};for(let i=0;i<sortedWeeks.length;i++){const targetWeek=sortedWeeks[sortedFtdIdx+i];if(!targetWeek){console.log('  i=' + i + ': targetWeek undefined, push {0,0}');newRow.retention.push({count:0,pct:0});continue}const targetOriginalIdx=originalWeeks.indexOf(targetWeek);const originalOffset=targetOriginalIdx-originalFtdIdx;console.log('  i=' + i + ': targetWeek=' + targetWeek + ', targetOriginalIdx=' + targetOriginalIdx + ', originalOffset=' + originalOffset);if(originalOffset>=0&&originalOffset<row.retention.length){console.log('    -> use retention[' + originalOffset + ']:',row.retention[originalOffset]);newRow.retention.push(row.retention[originalOffset])}else{console.log('    -> offset invalid, push {0,0}');newRow.retention.push({count:0,pct:0})}}console.log('Result retention for ' + row.week + ':',newRow.retention);return newRow});sortedRows.sort((a,b)=>{const aDate=parseWeekDate(a.week);const bDate=parseWeekDate(b.week);if(!aDate||!bDate)return 0;return aDate-bDate});console.log('SORTED rows:',sortedRows);console.log('=== END DEBUG ===');return{weeks:sortedWeeks,rows:sortedRows}}
function loadWeeklyRetentionData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{if(!data||!data.rows){console.warn('Weekly retention: no data');weeklyRetentionData={weeks:[],rows:[]};resolve();return}weeklyRetentionData=data;console.log('Weekly retention loaded:',weeklyRetentionData);resolve()}).withFailureHandler(err=>{console.error('Weekly retention error:',err);weeklyRetentionData={weeks:[],rows:[]};resolve()}).getWeeklyRetentionData()})}

function renderWeeklyRetentionMetricSelector(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.rows||data.rows.length===0){console.warn('No weekly retention data for selector');return}const container=document.getElementById('retentionMetricSelector');container.innerHTML='';const maxWeeks=data.weeks?data.weeks.length:0;for(let i=0;i<maxWeeks;i++){const btn=document.createElement('button');btn.className='metric-btn'+(i===currentRetentionWeek?' active':'');btn.textContent='Week +'+i;btn.onclick=()=>{currentRetentionWeek=i;document.querySelectorAll('#retentionMetricSelector .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderWeeklyRetentionChart()};container.appendChild(btn)}}

function renderWeeklyRetentionChart(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.rows||data.rows.length===0){console.warn('No weekly retention data for chart');return}if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('retentionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let weekIdx=0;data.rows.forEach((row,rowIdx)=>{const retentionIdx=rowIdx+currentRetentionWeek;if(!row.retention||retentionIdx>=row.retention.length)return;const cell=row.retention[retentionIdx];let pct=cell?cell.pct:0;labels.push(row.week+' FTD');chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[weekIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);weekIdx++});if(retentionChart)retentionChart.destroy();retentionChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:'Weekly Retention (Week +'+currentRetentionWeek+')',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function renderWeeklyRetentionTable(){const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);const data=hasFilters?filterRetentionData(weeklyRetentionData,retentionFilters,"weekly"):weeklyRetentionData;if(!data||!data.weeks||data.weeks.length===0){console.warn('No weekly retention data for table');return}const table=document.getElementById('retention-table');const maxOffset=Math.max(...data.rows.map(r=>r.retention?r.retention.length:0));let html='<thead><tr><th class="row-header">FTD Week ‚Üì / Active Week ‚Üí</th>';data.weeks.forEach(w=>html+='<th>' + w + '</th>');html+='</tr></thead><tbody>';data.rows.forEach((row,rowIdx)=>{html+='<tr><td class="row-header">' + row.week + ' FTD</td>';data.weeks.forEach((activeWeek,colIdx)=>{if(colIdx<rowIdx){html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}else{if(row.retention&&colIdx<row.retention.length){const cell=row.retention[colIdx];let count=cell?cell.count:0,pct=cell?cell.pct:0;const retOffset=colIdx-rowIdx;const bg=retentionHeatmapColor(pct,retOffset,maxOffset),fg=getTextColor(bg);const display=heatmapShowPercent?(pct*100).toFixed(1) + '%':count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + ';cursor:pointer" data-ftd-week="' + row.week + '" data-active-week="' + activeWeek + '">' + display + '</span></td>'}else{html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}}});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell[data-ftd-week]').forEach(cell=>{cell.onclick=()=>openWeeklyRetentionModal(cell.dataset.ftdWeek,cell.dataset.activeWeek)})}

function openWeeklyRetentionModal(ftdWeek,activeWeek){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=ftdWeek + ' FTD ‚Üí ' + activeWeek + ' ACTIVE';document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=ftdWeek + '|' + activeWeek;const cachedData=retentionPlayersCellMap.get(cellKey);if(cachedData){console.log('Using cached weekly data for:',cellKey,cachedData);currentModalData=cachedData;currentFilteredData=applyFiltersToData(cachedData,retentionFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching weekly modal data for:',ftdWeek,'‚Üí',activeWeek);google.script.run.withSuccessHandler(data=>{console.log('Weekly modal data received:',data);console.log('Achieved count:',data.achieved?data.achieved.length:0);console.log('FTD total:',data.total);currentModalData=data;currentFilteredData=applyFiltersToData(data,retentionFilters);console.log('Filtered data:',currentFilteredData);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Weekly modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayersRetentionWeekly({ftdWeek,activeWeek})}

function renderInitialFilters(){
if(!allData||!retentionData){
setTimeout(renderInitialFilters,500);
return;
}
const vipSet=new Set();
const mgrSet=new Set();
const trafficSet=new Set();
const countrySet=new Set();
google.script.run.withSuccessHandler(data=>{
data.forEach(p=>{
const vip=getVipType(p.tags);
const mgr=getManager(p.tags);
if(vip)vipSet.add(vip);
if(mgr)mgrSet.add(mgr);
if(p.trafficType)trafficSet.add(p.trafficType);
if(p.country)countrySet.add(p.country);
});
const vips=[...vipSet].sort();
const mgrs=[...mgrSet].sort();
const traffic=[...trafficSet].sort();
const countries=[...countrySet].sort();
renderFilterDropdown('depositVipTypeFilters',vips,'vipType','All Types','deposit');
renderFilterDropdown('depositManagerFilters',mgrs,'manager','All Managers','deposit');
renderFilterDropdown('depositTrafficFilters',traffic,'trafficType','All Traffic','deposit');
renderFilterDropdown('depositCountryFilters',countries,'country','All Countries','deposit');
renderFilterDropdown('retentionVipTypeFilters',vips,'vipType','All Types','retention');
renderFilterDropdown('retentionManagerFilters',mgrs,'manager','All Managers','retention');
renderFilterDropdown('retentionTrafficFilters',traffic,'trafficType','All Traffic','retention');
renderFilterDropdown('retentionCountryFilters',countries,'country','All Countries','retention');
}).withFailureHandler(err=>{
console.error('Filter data load error:',err);
const basicVip=['VIP','Silent','Super VIP'];
const basicMgr=['Ann','Vlad','Kate','Max'];
renderFilterDropdown('depositVipTypeFilters',basicVip,'vipType','All Types','deposit');
renderFilterDropdown('depositManagerFilters',basicMgr,'manager','All Managers','deposit');
renderFilterDropdown('depositTrafficFilters',[],'trafficType','All Traffic','deposit');
renderFilterDropdown('depositCountryFilters',[],'country','All Countries','deposit');
renderFilterDropdown('retentionVipTypeFilters',basicVip,'vipType','All Types','retention');
renderFilterDropdown('retentionManagerFilters',basicMgr,'manager','All Managers','retention');
renderFilterDropdown('retentionTrafficFilters',[],'trafficType','All Traffic','retention');
renderFilterDropdown('retentionCountryFilters',[],'country','All Countries','retention');
}).getAllPlayersForFilters();
}

function setupGlobalClickHandler(){document.addEventListener('click',()=>{document.querySelectorAll('.filter-dropdown-menu').forEach(menu=>menu.classList.remove('open'));document.querySelectorAll('.filter-dropdown-toggle').forEach(toggle=>toggle.classList.remove('active'))})}

function loadDepositData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{allData=data;selectedMonths=[...data.months];renderMonthFilters(data.months);renderMetricSelector();renderBarChart();renderDepositTable();resolve()}).withFailureHandler(err=>{alert('Error: '+err.message);resolve()}).getDepositConversionData()})}

function loadRetentionData(){
  console.log('üì• Loading Monthly Retention Data...');
  return new Promise((resolve)=>{
    google.script.run
      .withSuccessHandler(data=>{
        console.log('‚úÖ Monthly Retention Data received:', {
          hasData: !!data,
          months: data?.months,
          rowsCount: data?.rows?.length,
          firstRow: data?.rows?.[0]
        });
        retentionData=data;
        renderRetentionMetricSelector();
        renderRetentionChart();
        renderRetentionTable();
        resolve();
      })
      .withFailureHandler(err=>{
        console.error('‚ùå Failed to load Monthly Retention Data:', err);
        document.getElementById('retention-table').parentElement.innerHTML='<div class="err">Error: '+err+'</div>';
        resolve();
      })
      .getRetentionData();
  });
}

function loadKpiData(){return new Promise((resolve)=>{google.script.run.withSuccessHandler(data=>{console.log('KPI data received:',data);if(!data){document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">Error: No data returned</div>';resolve();return}if(data.error){document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">Error: '+data.error+'</div>';resolve();return}if(data.tabs && Object.keys(data.tabs).length>0){kpiDataByTab=data.tabs;if(data.metricFormats){metricFormats=data.metricFormats}const tabs=Object.keys(kpiDataByTab);kpiCurrentTab=tabs[0];renderKpiTabs();renderKpiSidebar();renderKpiMetrics();renderMetricsFilter()}else{document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">No [VIP] or [TOTAL] sheets found. Check sheet names!</div>'}resolve()}).withFailureHandler(err=>{console.error('KPI load error:',err);document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444;padding:20px">Error: '+err.message+'</div>';resolve()}).kpiLoadProject()})}

function loadAllPlayersForFilters(){return new Promise((resolve)=>{if(!allData){setTimeout(()=>loadAllPlayersForFilters().then(resolve),500);return}const requests=[];allData.months.forEach(month=>{allData.rows.forEach(row=>{requests.push({month:month,range:row.range})})});const BATCH_SIZE=5;let batchIndex=0;console.log('üì• Loading ALL deposit cells:',requests.length,'total');function loadNextBatch(){const start=batchIndex*BATCH_SIZE;const end=Math.min(start+BATCH_SIZE,requests.length);if(start>=requests.length){console.log('‚úÖ All deposit cells loaded');console.log('üîß Setting depositCellsLoaded = true');depositCellsLoaded = true;console.log('üîß Calling tryEnrichRetentionPlayers() from deposit...');tryEnrichRetentionPlayers();renderGlobalFilters();resolve();return}const batch=requests.slice(start,end);let batchCompleted=0;let timeoutId;console.log('‚è≥ Loading batch',batchIndex+1,'/',Math.ceil(requests.length/BATCH_SIZE),'(size:',batch.length,')');timeoutId=setTimeout(function(){if(batchCompleted<batch.length){console.error('‚è±Ô∏è Batch',batchIndex+1,'TIMEOUT! Only',batchCompleted,'/',batch.length,'completed');batchIndex++;loadNextBatch()}},15000);batch.forEach(req=>{const k=req.month + '|' + req.range;google.script.run.withSuccessHandler(function(data){const players=data.achieved||[];playersCellMap.set(k,data);allPlayersData.push(...players);batchCompleted++;console.log('  ‚úì Cell completed (',batchCompleted,'/',batch.length,') key:',k,'players:',players.length);if(batchCompleted===batch.length){clearTimeout(timeoutId);console.log('  ‚úÖ Batch',batchIndex+1,'complete! Moving to next...');batchIndex++;setTimeout(loadNextBatch,500)}}).withFailureHandler(function(error){console.error('  ‚ùå Cell failed! key:',k,'error:',error);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);console.log('  ‚ö†Ô∏è Batch',batchIndex+1,'complete with errors! Moving to next...');batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayers({month:req.month,depositRange:req.range})})}loadNextBatch()})}

function loadAllRetentionPlayersForFilters(){return new Promise((resolve)=>{if(!retentionData){setTimeout(()=>loadAllRetentionPlayersForFilters().then(resolve),500);return}const requests=[];retentionData.rows.forEach((row,rowIdx)=>{const ftdMonth=row.month;for(let i=rowIdx;i<retentionData.months.length;i++){const activeMonth=retentionData.months[i];requests.push({ftdMonth:ftdMonth,activeMonth:activeMonth,type:'monthly'})}});if(weeklyRetentionData&&weeklyRetentionData.rows){weeklyRetentionData.rows.forEach((row,rowIdx)=>{const ftdWeek=row.week;for(let i=rowIdx;i<weeklyRetentionData.weeks.length;i++){const activeWeek=weeklyRetentionData.weeks[i];requests.push({ftdPeriod:ftdWeek,activePeriod:activeWeek,type:'weekly'})}})}const BATCH_SIZE=10;let batchIndex=0;console.log('üì• Loading ALL retention cells:',requests.length,'total');function loadNextBatch(){const start=batchIndex*BATCH_SIZE;const end=Math.min(start+BATCH_SIZE,requests.length);if(start>=requests.length){console.log('‚úÖ All retention cells loaded');
console.log('üîß Setting retentionCellsLoaded = true');
retentionCellsLoaded = true;
console.log('üîß Calling tryEnrichRetentionPlayers() from retention...');
tryEnrichRetentionPlayers();
renderGlobalFilters();resolve();return}const batch=requests.slice(start,end);let batchCompleted=0;let timeoutId;console.log('‚è≥ Loading batch',batchIndex+1,'/',Math.ceil(requests.length/BATCH_SIZE));timeoutId=setTimeout(function(){if(batchCompleted<batch.length){console.error('‚è±Ô∏è Retention batch',batchIndex+1,'TIMEOUT! Only',batchCompleted,'/',batch.length,'completed');batchIndex++;loadNextBatch()}},15000);batch.forEach(req=>{if(req.type==='monthly'){const k=req.ftdMonth + '|' + req.activeMonth;google.script.run.withSuccessHandler(function(data){retentionPlayersCellMap.set(k,data);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);batchIndex++;setTimeout(loadNextBatch,500)}}).withFailureHandler(function(error){console.error('‚ùå Retention cell failed:',k,error);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayersRetention({ftdMonth:req.ftdMonth,activeMonth:req.activeMonth})}else{const k=req.ftdPeriod + '|' + req.activePeriod;google.script.run.withSuccessHandler(function(data){retentionPlayersCellMap.set(k,data);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);batchIndex++;setTimeout(loadNextBatch,500)}}).withFailureHandler(function(error){console.error('‚ùå Weekly retention cell failed:',k,error);batchCompleted++;if(batchCompleted===batch.length){clearTimeout(timeoutId);batchIndex++;setTimeout(loadNextBatch,500)}}).getCellPlayersRetentionWeekly({ftdWeek:req.ftdPeriod,activeWeek:req.activePeriod})}})}loadNextBatch()})}

/**
 * Try to enrich retention players with tags from deposit cells
 * Only runs when BOTH deposit and retention cells are loaded
 */
function tryEnrichRetentionPlayers() {
  console.log('üöÄ tryEnrichRetentionPlayers() CALLED!');
  console.log('  - depositCellsLoaded:', depositCellsLoaded);
  console.log('  - retentionCellsLoaded:', retentionCellsLoaded);
  console.log('  - allPlayersData.length:', allPlayersData.length);
  console.log('  - retentionPlayersCellMap.size:', retentionPlayersCellMap.size);
  
  // Check if both loading processes are complete
  if (!depositCellsLoaded || !retentionCellsLoaded) {
    console.log('‚è≥ Waiting for all cells to load before enrichment...');
    console.log('  - Deposit cells loaded:', depositCellsLoaded);
    console.log('  - Retention cells loaded:', retentionCellsLoaded);
    return;
  }
  
  console.log('üîÑ Enriching retention players with tags...');
  
  // üîç DIAGNOSTIC: Sample deposit player
  if (allPlayersData.length > 0) {
    console.log('üîç Sample DEPOSIT player:', allPlayersData[0]);
    console.log('  - email:', allPlayersData[0].email);
    console.log('  - playerId:', allPlayersData[0].playerId);
    console.log('  - tags:', allPlayersData[0].tags);
    console.log('  - Object.keys:', Object.keys(allPlayersData[0]));
  }
  
  // üîç DIAGNOSTIC: Sample retention player
  const firstCell = retentionPlayersCellMap.values().next().value;
  if (firstCell && firstCell.achieved && firstCell.achieved.length > 0) {
    console.log('üîç Sample RETENTION player:', firstCell.achieved[0]);
    console.log('  - email:', firstCell.achieved[0].email);
    console.log('  - playerId:', firstCell.achieved[0].playerId);
    console.log('  - tags:', firstCell.achieved[0].tags);
    console.log('  - Object.keys:', Object.keys(firstCell.achieved[0]));
  }
  
  const playerTagsMap = new Map();
  let playersWithTags = 0;
  let playersWithoutTags = 0;
  let playersWithoutKey = 0;
  
  allPlayersData.forEach(p => {
    const key = p.email || p.playerId;
    if (key) {
      if (p.tags && p.tags.length > 0) {
        playersWithTags++;
        playerTagsMap.set(key, {
          tags: p.tags,
          trafficType: p.trafficType,
          country: p.country
        });
      } else {
        playersWithoutTags++;
      }
    } else {
      playersWithoutKey++;
    }
  });
  
  console.log('üìä allPlayersData analysis:');
  console.log('  - Total:', allPlayersData.length);
  console.log('  - With tags:', playersWithTags);
  console.log('  - Without tags:', playersWithoutTags);
  console.log('  - Without email/playerId:', playersWithoutKey);
  console.log('  - Tags map size:', playerTagsMap.size);
  
  // üîç Show first 5 keys from deposit map
  const sampleKeys = [...playerTagsMap.keys()].slice(0, 5);
  console.log('üîç Sample DEPOSIT keys (first 5):', sampleKeys);
  
  if (playerTagsMap.size === 0) {
    console.warn('‚ö†Ô∏è No tags found in allPlayersData - enrichment will not work!');
    return;
  }
  
  let enrichedCount = 0;
  let notFoundCount = 0;
  let retentionKeysNotFound = [];
  
  retentionPlayersCellMap.forEach((cellData, cellKey) => {
    if (!cellData) return;
    
    // Enrich achieved players
    if (cellData.achieved) {
      cellData.achieved.forEach(p => {
        const key = p.email || p.playerId;
        if (!key) {
          console.warn('‚ö†Ô∏è Retention player without key:', p);
          notFoundCount++;
          return;
        }
        
        const enrichData = playerTagsMap.get(key);
        if (enrichData) {
          if (!p.tags || p.tags.length === 0) {
            p.tags = enrichData.tags;
            enrichedCount++;
          }
          if (!p.trafficType) p.trafficType = enrichData.trafficType;
          if (!p.country) p.country = enrichData.country;
        } else {
          notFoundCount++;
          if (retentionKeysNotFound.length < 5) {
            retentionKeysNotFound.push(key);
          }
        }
      });
    }
    
    // Enrich dropped players
    if (cellData.dropped) {
      cellData.dropped.forEach(p => {
        const key = p.email || p.playerId;
        if (!key) {
          notFoundCount++;
          return;
        }
        
        const enrichData = playerTagsMap.get(key);
        if (enrichData) {
          if (!p.tags || p.tags.length === 0) {
            p.tags = enrichData.tags;
            enrichedCount++;
          }
          if (!p.trafficType) p.trafficType = enrichData.trafficType;
          if (!p.country) p.country = enrichData.country;
        } else {
          notFoundCount++;
          if (retentionKeysNotFound.length < 5) {
            retentionKeysNotFound.push(key);
          }
        }
      });
    }
  });
  
  console.log('‚úÖ Enrichment complete:');
  console.log('  - Enriched:', enrichedCount, 'players');
  console.log('  - Not found in map:', notFoundCount, 'players');
  console.log('üîç Sample RETENTION keys NOT FOUND (first 5):', retentionKeysNotFound);
  const successRate = playerTagsMap.size > 0 ? ((enrichedCount / (enrichedCount + notFoundCount) * 100).toFixed(1) + '%') : '0%';
  console.log('  - Success rate:', successRate);
  
  // Re-render retention if filters are active
  const hasRetentionFilters = Object.values(retentionFilters).some(arr=>arr.length>0);
  if(hasRetentionFilters){
    console.log('üîÑ Re-rendering retention with filters after enrichment');
    if(retentionMode==='monthly'){
      renderRetentionChart();
      renderRetentionTable();
    }else{
      renderWeeklyRetentionChart();
      renderWeeklyRetentionTable();
    }
  }
}

function renderGlobalFilters(){
  const typesSet=new Set();
  const managersSet=new Set();
  const trafficTypesSet=new Set();
  const countriesSet=new Set();
  
  // Collect unique values from allPlayersData
  allPlayersData.forEach(p=>{
    const playerType=getPlayerTypeFromTags(p.tags); // ‚úÖ FIX: Use TYPE sheet mapping
    const mgr=getManager(p.tags);
    if(playerType && playerType !== 'UNKNOWN')typesSet.add(playerType);
    if(mgr)managersSet.add(mgr);
    if(p.trafficType)trafficTypesSet.add(p.trafficType);
    if(p.country)countriesSet.add(p.country);
  });
  
  // Collect unique values from retentionPlayersCellMap
  retentionPlayersCellMap.forEach(cellData=>{
    if(!cellData)return;
    const achieved=cellData.achieved||[];
    const dropped=cellData.dropped||[];
    [...achieved,...dropped].forEach(p=>{
      const playerType=getPlayerTypeFromTags(p.tags); // ‚úÖ FIX: Use TYPE sheet mapping
      const mgr=getManager(p.tags);
      if(playerType && playerType !== 'UNKNOWN')typesSet.add(playerType);
      if(mgr)managersSet.add(mgr);
      if(p.trafficType)trafficTypesSet.add(p.trafficType);
      if(p.country)countriesSet.add(p.country);
    });
  });
  
  // üîç ANALYZE ALL UNIQUE TAGS IN THE DATABASE
  const allTagsSet = new Set();
  
  // Collect tags from allPlayersData
  allPlayersData.forEach(p => {
    if (p.tags) {
      let tagsArray = [];
      if (Array.isArray(p.tags)) {
        tagsArray = p.tags;
      } else if (typeof p.tags === 'string') {
        if (p.tags.trim().startsWith('[')) {
          try {
            tagsArray = JSON.parse(p.tags);
          } catch (e) {
            tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
          }
        } else {
          tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
        }
      }
      tagsArray.forEach(tag => {
        if (tag && String(tag).trim() !== '') {
          allTagsSet.add(String(tag).toLowerCase());
        }
      });
    }
  });
  
  // Collect tags from retentionPlayersCellMap
  retentionPlayersCellMap.forEach(cellData => {
    if (!cellData) return;
    const achieved = cellData.achieved || [];
    const dropped = cellData.dropped || [];
    [...achieved, ...dropped].forEach(p => {
      if (p.tags) {
        let tagsArray = [];
        if (Array.isArray(p.tags)) {
          tagsArray = p.tags;
        } else if (typeof p.tags === 'string') {
          if (p.tags.trim().startsWith('[')) {
            try {
              tagsArray = JSON.parse(p.tags);
            } catch (e) {
              tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
            }
          } else {
            tagsArray = p.tags.split(',').map(t => t.trim()).filter(t => t !== '');
          }
        }
        tagsArray.forEach(tag => {
          if (tag && String(tag).trim() !== '') {
            allTagsSet.add(String(tag).toLowerCase());
          }
        });
      }
    });
  });
  
  const allTags = [...allTagsSet].sort();
  
  // üîç Count players with valid TYPE tags
  let playersWithValidTags = 0;
  let playersWithoutValidTags = 0;
  
  const checkPlayer = (p) => {
    const playerType = getPlayerTypeFromTags(p.tags);
    if (playerType && playerType !== 'UNKNOWN') {
      playersWithValidTags++;
    } else if (p.tags && p.tags !== '' && p.tags !== '[]') {
      playersWithoutValidTags++;
    }
  };
  
  allPlayersData.forEach(checkPlayer);
  retentionPlayersCellMap.forEach(cellData => {
    if (!cellData) return;
    const achieved = cellData.achieved || [];
    const dropped = cellData.dropped || [];
    [...achieved, ...dropped].forEach(checkPlayer);
  });
  
  console.log('üîç ===== ALL UNIQUE TAGS ANALYSIS =====');
  console.log('üìä Total unique tags found:', allTags.length);
  console.log('üìã All tags (lowercase):', allTags);
  console.log('üó∫Ô∏è TYPE mapping available:', Object.keys(tagToTypeMap));
  console.log('‚ùå Tags NOT in TYPE mapping:', allTags.filter(tag => !tagToTypeMap[tag]));
  console.log('‚úÖ Tags IN TYPE mapping:', allTags.filter(tag => tagToTypeMap[tag]));
  console.log('üë• Players with VALID tags (in TYPE sheet):', playersWithValidTags);
  console.log('üë• Players with INVALID tags (not in TYPE sheet):', playersWithoutValidTags);
  console.log('üìä Ratio:', (playersWithValidTags / (playersWithValidTags + playersWithoutValidTags) * 100).toFixed(1) + '%');
  console.log('======================================');
  
  const types=[...typesSet].sort();
  const managers=[...managersSet].sort();
  const trafficTypes=[...trafficTypesSet].sort();
  const countries=[...countriesSet].sort();
  
  // Render filters for Deposit
  renderSidebarFilterItems('depositVipTypeFilters',types,'type','deposit');
  renderSidebarFilterItems('depositManagerFilters',managers,'manager','deposit');
  renderSidebarFilterItems('depositTrafficFilters',trafficTypes,'trafficType','deposit');
  renderSidebarFilterItems('depositCountryFilters',countries,'country','deposit');
  
  // Render filters for Retention
  renderSidebarFilterItems('retentionVipTypeFilters',types,'type','retention');
  renderSidebarFilterItems('retentionManagerFilters',managers,'manager','retention');
  renderSidebarFilterItems('retentionTrafficFilters',trafficTypes,'trafficType','retention');
  renderSidebarFilterItems('retentionCountryFilters',countries,'country','retention');
  
  console.log('‚úÖ Global filters rendered:', {
    types: types.length,
    managers: managers.length,
    trafficTypes: trafficTypes.length,
    countries: countries.length
  });
}


function renderFilterDropdown(containerId,values,filterKey,label,view){const container=document.getElementById(containerId);if(!container)return;container.innerHTML='';const dropdown=document.createElement('div');dropdown.className='filter-dropdown';const toggle=document.createElement('div');toggle.className='filter-dropdown-toggle';toggle.innerHTML='<span>' + label + '</span><span style="display:flex;align-items:center;gap:6px"><span class="count" style="display:none">0</span><span style="font-size:10px">‚ñº</span></span>';const menu=document.createElement('div');menu.className='filter-dropdown-menu';const searchInput=document.createElement('input');searchInput.type='text';searchInput.className='filter-search-input';searchInput.placeholder='Search...';searchInput.onclick=(e)=>e.stopPropagation();menu.appendChild(searchInput);const itemsContainer=document.createElement('div');itemsContainer.className='filter-items-container';values.forEach(value=>{const item=document.createElement('div');item.className='filter-dropdown-item';item.dataset.value=value.toLowerCase();const checkbox=document.createElement('div');checkbox.className='filter-checkbox';const text=document.createElement('span');text.textContent=value;item.appendChild(checkbox);item.appendChild(text);item.onclick=(e)=>{e.stopPropagation();const isChecked=checkbox.classList.toggle('checked');if(filterKey==='months'){toggleMonth(value,view)}else{updateFilter(filterKey,value,isChecked,view)}const checkedCount=itemsContainer.querySelectorAll('.filter-checkbox.checked').length;const countSpan=toggle.querySelector('.count');if(checkedCount>0&&checkedCount<values.length){countSpan.textContent=checkedCount;countSpan.style.display='block'}else if(checkedCount===values.length){countSpan.style.display='none'}else{countSpan.textContent=checkedCount;countSpan.style.display='block'}};itemsContainer.appendChild(item)});menu.appendChild(itemsContainer);searchInput.oninput=()=>{const searchTerm=searchInput.value.toLowerCase();itemsContainer.querySelectorAll('.filter-dropdown-item').forEach(item=>{const matches=item.dataset.value.includes(searchTerm);item.style.display=matches?'flex':'none'})};toggle.onclick=(e)=>{e.stopPropagation();const allMenus=document.querySelectorAll('.filter-dropdown-menu');allMenus.forEach(m=>{if(m!==menu)m.classList.remove('open')});menu.classList.toggle('open');toggle.classList.toggle('active');if(menu.classList.contains('open')){searchInput.value='';searchInput.focus();itemsContainer.querySelectorAll('.filter-dropdown-item').forEach(item=>item.style.display='flex')}};menu.onclick=(e)=>{e.stopPropagation()};dropdown.appendChild(toggle);dropdown.appendChild(menu);container.appendChild(dropdown)}

function matchesDepositFilters(player,filters){
  if(!filters)return true;
  
  const hasFilters = filters.type?.length > 0 || filters.manager?.length > 0 || 
                     filters.trafficType?.length > 0 || filters.country?.length > 0;
  
  // Check TYPE filter
  if(filters.type&&filters.type.length>0){
    const playerType=getPlayerTypeFromTags(player.tags); // ‚úÖ FIX: Use new function
    if(!filters.type.includes(playerType)){
      if(hasFilters && Math.random() < 0.01) { // Log 1% of filtered players
        console.log('‚ùå Deposit: Player filtered by TYPE:', {
          playerType,
          allowedTypes: filters.type,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Manager filter
  if(filters.manager&&filters.manager.length>0){
    const mgr=getManager(player.tags);
    if(!filters.manager.includes(mgr)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Manager:', {
          manager: mgr,
          allowedManagers: filters.manager,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Traffic Type filter
  if(filters.trafficType&&filters.trafficType.length>0){
    if(!filters.trafficType.includes(player.trafficType)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Traffic:', {
          traffic: player.trafficType,
          allowedTraffic: filters.trafficType
        });
      }
      return false;
    }
  }
  
  // Check Country filter
  if(filters.country&&filters.country.length>0){
    if(!filters.country.includes(player.country)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Deposit: Player filtered by Country:', {
          country: player.country,
          allowedCountries: filters.country
        });
      }
      return false;
    }
  }
  
  return true;
}

function filterDepositData(baseData, filters) {
  if (!baseData || !allPlayersData || allPlayersData.length === 0) return baseData;
  
  console.log('üîç filterDepositData called:', {
    filters,
    monthsCount: baseData.months?.length,
    rowsCount: baseData.rows?.length,
    playersCellMapSize: playersCellMap.size
  });
  
  // Helper to extract player array from cellMap entry (which stores {achieved:[...], dropped:[...]} objects)
  function getPlayersFromCell(cellKey) {
    const cellData = playersCellMap.get(cellKey);
    if (!cellData) return [];
    if (Array.isArray(cellData)) return cellData;
    return [...(cellData.achieved || []), ...(cellData.dropped || [])];
  }
  
  const result = {
    months: baseData.months,
    rows: []
  };
  
  let totalPlayersBefore = 0;
  let totalPlayersAfter = 0;
  
  baseData.rows.forEach((rowData, rowIdx) => {
    const newRow = {
      range: rowData.range,
      cells: []
    };
    
    baseData.months.forEach((month, monthIdx) => {
      // Get FTD players - extract array from stored object
      const totalFtd = getPlayersFromCell(month + '|FTD');
      const filteredFtd = totalFtd.filter(p => matchesDepositFilters(p, filters));
      const ftdCount = filteredFtd.length;
      
      // Create FTD email set for intersection
      const ftdEmailSet = new Set(filteredFtd.map(p => p.email || p.playerId));
      
      const cellKey = month + '|' + rowData.range;
      const cellPlayers = getPlayersFromCell(cellKey);
      totalPlayersBefore += cellPlayers.length;
      
      // Filter by deposit filters AND must be in FTD
      const filteredPlayers = cellPlayers.filter(p => {
        const playerEmail = p.email || p.playerId;
        return matchesDepositFilters(p, filters) && ftdEmailSet.has(playerEmail);
      });
      
      totalPlayersAfter += filteredPlayers.length;
      
      const count = filteredPlayers.length;
      const pct = ftdCount > 0 ? count / ftdCount : 0;
      
      if (rowIdx === 0 && monthIdx === 0) {
        console.log('üìä First cell filtering:', {
          month,
          range: rowData.range,
          playersBefore: cellPlayers.length,
          playersAfter: filteredPlayers.length,
          ftdBefore: totalFtd.length,
          ftdAfter: ftdCount,
          filters
        });
      }
      
      newRow.cells.push({count: count, pct: pct});
    });
    
    result.rows.push(newRow);
  });
  
  console.log('‚úÖ Deposit filtering complete:', {
    totalPlayersBefore,
    totalPlayersAfter,
    filtered: totalPlayersBefore - totalPlayersAfter,
    filterRate: totalPlayersBefore > 0 ? ((totalPlayersBefore - totalPlayersAfter) / totalPlayersBefore * 100).toFixed(1) + '%' : '0%'
  });
  
  return result;
}
function matchesRetentionFilters(player,filters){
  if(!filters)return true;
  
  const hasFilters = filters.type?.length > 0 || filters.manager?.length > 0 || 
                     filters.trafficType?.length > 0 || filters.country?.length > 0;
  
  // Check TYPE filter
  if(filters.type&&filters.type.length>0){
    const playerType=getPlayerTypeFromTags(player.tags); // ‚úÖ FIX: Use new function
    if(!filters.type.includes(playerType)){
      if(hasFilters && Math.random() < 0.01) { // Log 1% of filtered players
        console.log('‚ùå Retention: Player filtered by TYPE:', {
          playerType,
          allowedTypes: filters.type,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Manager filter
  if(filters.manager&&filters.manager.length>0){
    const mgr=getManager(player.tags);
    if(!filters.manager.includes(mgr)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Manager:', {
          manager: mgr,
          allowedManagers: filters.manager,
          tags: player.tags
        });
      }
      return false;
    }
  }
  
  // Check Traffic Type filter
  if(filters.trafficType&&filters.trafficType.length>0){
    if(!filters.trafficType.includes(player.trafficType)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Traffic:', {
          traffic: player.trafficType,
          allowedTraffic: filters.trafficType
        });
      }
      return false;
    }
  }
  
  // Check Country filter
  if(filters.country&&filters.country.length>0){
    if(!filters.country.includes(player.country)){
      if(hasFilters && Math.random() < 0.01) {
        console.log('‚ùå Retention: Player filtered by Country:', {
          country: player.country,
          allowedCountries: filters.country
        });
      }
      return false;
    }
  }
  
  return true;
}

function filterRetentionData(baseData, filters, mode) {
  console.log('üîç filterRetentionData ENTRY:', {
    baseDataExists: !!baseData,
    baseDataType: typeof baseData,
    filtersExists: !!filters,
    mode
  });
  
  if (!baseData) {
    console.log('‚ùå filterRetentionData: baseData is null/undefined, returning early');
    return baseData;
  }
  
  // ‚úÖ FIX: Check if retentionPlayersCellMap has data
  if (retentionPlayersCellMap.size === 0) {
    console.log('‚ö†Ô∏è filterRetentionData: retentionPlayersCellMap is empty, returning baseData as-is');
    return baseData;
  }
  
  const periodField = mode === 'weekly' ? 'week' : 'month';
  const periodsKey = mode === 'weekly' ? 'weeks' : 'months';
  
  console.log('üîç filterRetentionData called:', {
    mode,
    filters,
    periodsCount: baseData[periodsKey]?.length,
    rowsCount: baseData.rows?.length,
    mapSize: retentionPlayersCellMap.size
  });
  
  const result = {
    [periodsKey]: baseData[periodsKey],
    rows: []
  };
  
  let totalFtdBefore = 0;
  let totalFtdAfter = 0;
  
  baseData.rows.forEach((rowData, rowIdx) => {
    const newRow = {
      [periodField]: rowData[periodField],
      ftdCount: 0,
      retention: []
    };
    
    const ftdKey = rowData[periodField] + '|' + rowData[periodField];
    const ftdCellData = retentionPlayersCellMap.get(ftdKey);
    
    // Debug first row
    if (rowIdx === 0) {
      console.log('üîç Checking first row:', {
        period: rowData[periodField],
        ftdKey: ftdKey,
        hasCellData: !!ftdCellData,
        cellMapSize: retentionPlayersCellMap.size,
        cellMapKeys: Array.from(retentionPlayersCellMap.keys()).slice(0, 3)
      });
    }
    
    if (ftdCellData) {
      const ftdPlayers = [...(ftdCellData.achieved || []), ...(ftdCellData.dropped || [])];
      totalFtdBefore += ftdPlayers.length;
      
      const filteredFtdPlayers = ftdPlayers.filter(p => matchesRetentionFilters(p, filters));
      totalFtdAfter += filteredFtdPlayers.length;
      
      newRow.ftdCount = filteredFtdPlayers.length;
      
      // Track filtered FTD player IDs for retention matching
      const filteredFtdIds = new Set(filteredFtdPlayers.map(p => String(p.id || p.email || '').trim()));
      
      // Log first period to see what's happening
      if (rowIdx === 0) {
        console.log('üìä First period filtering:', {
          period: rowData[periodField],
          ftdBefore: ftdPlayers.length,
          ftdAfter: filteredFtdPlayers.length,
          filters
        });
        
        if (ftdPlayers.length > 0 && filteredFtdPlayers.length === 0) {
          console.log('‚ö†Ô∏è All FTD players filtered out! Checking first player:', {
            player: ftdPlayers[0],
            playerType: getPlayerTypeFromTags(ftdPlayers[0].tags),
            manager: getManager(ftdPlayers[0].tags),
            traffic: ftdPlayers[0].trafficType,
            country: ftdPlayers[0].country
          });
        }
      }
      
      baseData[periodsKey].forEach((activePeriod, colIdx) => {
        if (colIdx < rowIdx) {
          // Weekly uses absolute indexing (retention[colIdx]) - needs padding
          // Monthly uses relative indexing (retention[origColIdx - rowIdx]) - NO padding
          if (mode === 'weekly') {
            newRow.retention.push({count: 0, pct: 0});
          }
          return;
        }
        
        const retKey = rowData[periodField] + '|' + activePeriod;
        const retCellData = retentionPlayersCellMap.get(retKey);
        
        if (retCellData) {
          // Only count achieved players who are also in filtered FTD set
          const achievedPlayers = (retCellData.achieved || []).filter(p => {
            var pid = String(p.id || p.email || '').trim();
            return filteredFtdIds.has(pid);
          });
          const count = achievedPlayers.length;
          const pct = newRow.ftdCount > 0 ? count / newRow.ftdCount : 0;
          newRow.retention.push({count: count, pct: pct});
        } else {
          newRow.retention.push({count: 0, pct: 0});
        }
      });
    } else {
      // ‚ö†Ô∏è No cell data - use baseData values
      newRow.ftdCount = rowData.ftdCount || 0;
      newRow.retention = rowData.retention || baseData[periodsKey].map(() => ({count: 0, pct: 0}));
    }
    
    result.rows.push(newRow);
  });
  
  console.log('‚úÖ Retention filtering complete:', {
    totalFtdBefore,
    totalFtdAfter,
    filtered: totalFtdBefore - totalFtdAfter,
    filterRate: totalFtdBefore > 0 ? ((totalFtdBefore - totalFtdAfter) / totalFtdBefore * 100).toFixed(1) + '%' : '0%'
  });
  
  return result;
}
function updateFilter(filterKey,value,checked,view){
  console.log('üîç updateFilter called:', {filterKey, value, checked, view});
  
  const filters=view==='deposit'?depositFilters:retentionFilters;
  
  if(checked){
    if(!filters[filterKey].includes(value)){
      filters[filterKey].push(value);
    }
  }else{
    filters[filterKey]=filters[filterKey].filter(v=>v!==value);
  }
  
  console.log('üìä Current filters:', view==='deposit'?depositFilters:retentionFilters);
  
  if(view==='deposit'){
    renderBarChart();
    renderDepositTable();
  }else if(view==='retention'){
    if(retentionMode==='monthly'){
      renderRetentionChart();
      renderRetentionTable();
    }else{
      renderWeeklyRetentionChart();
      renderWeeklyRetentionTable();
    }
  }
}

function applyFilters(){renderBarChart();renderDepositTable();if(retentionMode==='monthly'){if(retentionData)renderRetentionTable()}else{if(weeklyRetentionData)renderWeeklyRetentionTable()}showToast('üîç Filters applied!')}

function clearDepositFilters(){
  depositFilters={type:[],manager:[],trafficType:[],country:[]};
  document.querySelectorAll('#depositVipTypeFilters .sidebar-filter-checkbox, #depositManagerFilters .sidebar-filter-checkbox, #depositTrafficFilters .sidebar-filter-checkbox, #depositCountryFilters .sidebar-filter-checkbox').forEach(checkbox=>checkbox.checked=false);
  renderBarChart();
  renderDepositTable();
  closeDepositFilterSidebar();
  showToast('üîÑ Filters cleared');
}

function clearRetentionFilters(){
  retentionFilters={type:[],manager:[],trafficType:[],country:[]};
  document.querySelectorAll('#retentionVipTypeFilters .sidebar-filter-checkbox, #retentionManagerFilters .sidebar-filter-checkbox, #retentionTrafficFilters .sidebar-filter-checkbox, #retentionCountryFilters .sidebar-filter-checkbox').forEach(checkbox=>checkbox.checked=false);
  if(retentionMode==='monthly'){
    renderRetentionChart();
    renderRetentionTable();
  }else{
    renderWeeklyRetentionChart();
    renderWeeklyRetentionTable();
  }
  closeRetentionFilterSidebar();
  showToast('üîÑ Filters cleared');
}

function renderMonthFilters(months){renderFilterDropdown('depositMonthFilters',months,'months','All Months','deposit');renderFilterDropdown('retentionMonthFilters',months,'months','All Months','retention');setTimeout(()=>{document.querySelectorAll('#depositMonthFilters .filter-checkbox, #retentionMonthFilters .filter-checkbox').forEach(checkbox=>{checkbox.classList.add('checked')});document.querySelectorAll('#depositMonthFilters .count, #retentionMonthFilters .count').forEach(countSpan=>{if(countSpan)countSpan.style.display='none'})},0)}

function toggleMonth(month,view){const idx=selectedMonths.indexOf(month);if(idx>-1)selectedMonths.splice(idx,1);else selectedMonths.push(month);renderBarChart();renderDepositTable();if(retentionData){renderRetentionChart();renderRetentionTable()}}

function renderMetricSelector(){const container=document.getElementById('metricSelector');container.innerHTML='';depositRanges.forEach(range=>{const btn=document.createElement('button');btn.className='metric-btn'+(range===currentMetric?' active':'');btn.textContent=range;btn.onclick=()=>{currentMetric=range;document.querySelectorAll('.metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBarChart()};container.appendChild(btn)})}

function renderRetentionMetricSelector(){
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  if(!data||!data.rows||data.rows.length===0)return;const container=document.getElementById('retentionMetricSelector');container.innerHTML='';const maxMonths=Math.max(...data.rows.map(r=>r.retention.length));for(let i=0;i<maxMonths;i++){const btn=document.createElement('button');btn.className='metric-btn'+(i===currentRetentionMonth?' active':'');btn.textContent='Month '+i;btn.onclick=()=>{currentRetentionMonth=i;document.querySelectorAll('#retentionMetricSelector .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderRetentionChart()};container.appendChild(btn)}}

function renderRetentionChart(){
  console.log('üìä renderRetentionChart called');
  console.log('üìä retentionData:', retentionData ? {rows: retentionData.rows?.length, months: retentionData.months?.length} : 'NULL');
  console.log('üìä selectedMonths:', selectedMonths);
  console.log('üìä currentRetentionMonth:', currentRetentionMonth);
  
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  console.log('üìä hasFilters:', hasFilters);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  console.log('üìä canFilter:', canFilter, '(mapSize:', retentionPlayersCellMap.size, ')');
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  console.log('üìä data after filtering:', data ? {rowsCount: data.rows?.length, monthsCount: data.months?.length} : 'NULL');
  
  if(!data||!data.rows||data.rows.length===0){
    console.log('‚ö†Ô∏è No retention data for chart - stopping render');
    return;
  }if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('retentionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;data.rows.forEach((row,rowIdx)=>{if(selectedMonths.includes(row.month)&&currentRetentionMonth<row.retention.length){const cell=row.retention[currentRetentionMonth];let pct=cell.pct;labels.push(row.month+' FTD');chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}});if(retentionChart)retentionChart.destroy();retentionChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:'Retention (Month '+currentRetentionMonth+')',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function renderBarChart(){if(!allData||selectedMonths.length===0)return;if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById('conversionChart');if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;const hasFilters=Object.values(depositFilters).some(arr=>arr.length>0);let data=allData;if(hasFilters){data=filterDepositData(allData,depositFilters)}const metricRow=data.rows.find(r=>r.range===currentMetric);if(!metricRow)return;let labels=[],chartData=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;data.months.forEach((month,idx)=>{if(selectedMonths.includes(month)){let pct=metricRow.cells[idx].pct;labels.push(month);chartData.push(parseFloat((pct*100).toFixed(2)));const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}});if(barChart)barChart.destroy();barChart=new Chart(canvas,{type:'bar',data:{labels:labels,datasets:[{label:currentMetric+' (%)',data:chartData,backgroundColor:colors,borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:(value)=>value.toFixed(1)+'%',color:'#1e293b',font:{weight:'bold',size:12}}},scales:{y:{beginAtZero:true,max:100,grace:'10%',ticks:{callback:v=>v+'%'},grid:{color:'#f1f5f9'}},x:{grid:{display:false}}}}})}

function heatmapColor(pct){const p=Math.max(0,Math.min(1,pct));const colors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];return colors[Math.floor(p*9)]}
function depositHeatmapColor(pct,rowIndex,maxRows){const p=Math.max(0,Math.min(1,pct));const baseColors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];const darkenOffset=Math.floor((rowIndex/(maxRows-1||1))*2);const adjustedColors=baseColors.map((_,idx)=>baseColors[Math.min(9,idx+darkenOffset)]);const colorIdx=Math.floor(p*9);return adjustedColors[colorIdx]}
function retentionHeatmapColor(pct,columnOffset,maxOffset){const p=Math.max(0,Math.min(1,pct));const colors=['#f8fafc','#e0e7ff','#c7d2fe','#a5b4fc','#818cf8','#6366f1','#4f46e5','#4338ca','#3730a3','#312e81'];const baseIdx=Math.floor(p*9);const lightenFactor=columnOffset/(maxOffset||1);const lightenAmount=Math.floor(lightenFactor*3);const finalIdx=Math.max(0,baseIdx-lightenAmount);return colors[finalIdx]}

function getTextColor(bg){const hex=bg.replace('#','');const r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);return((r*299+g*587+b*114)/1000)>155?'#1e293b':'#f8fafc'}

function toggleDepositHeatmap(){
  heatmapShowPercent=document.getElementById('depositHeatmapToggle').checked;
  renderDepositTable();
}

function toggleRetentionHeatmap(){
  heatmapShowPercent=document.getElementById('retentionHeatmapToggle').checked;
  if(retentionMode==='monthly'){
    renderRetentionTable();
  }else{
    renderWeeklyRetentionTable();
  }
}

function renderDepositTable(){const hasFilters=Object.values(depositFilters).some(arr=>arr.length>0);const data=hasFilters?filterDepositData(allData,depositFilters):allData;if(!data||selectedMonths.length===0)return;const table=document.getElementById('deposit-table');const recalculated=[];data.rows.forEach(row=>{const rowData={range:row.range,cells:[]};row.cells.forEach((cell,idx)=>{const month=data.months[idx];if(selectedMonths.includes(month)){rowData.cells.push({month,count:cell.count,pct:cell.pct})}});recalculated.push(rowData)});const allPcts=recalculated.flatMap(r=>r.cells.map(c=>c.pct));const maxPct=Math.max(...allPcts,0.01);const maxRows=recalculated.length;let html='<thead><tr><th class="row-header">Deposits ‚Üì / Month ‚Üí</th>';selectedMonths.forEach(month=>html+='<th>' + month + '</th>');html+='</tr></thead><tbody>';recalculated.forEach((rowData,rowIdx)=>{html+='<tr><td class="row-header">'+rowData.range+'</td>';rowData.cells.forEach(cellData=>{const bg=depositHeatmapColor(cellData.pct/maxPct,rowIdx,maxRows),fg=getTextColor(bg);const display=heatmapShowPercent?(cellData.pct*100).toFixed(1) + '%':cellData.count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + '" data-month="' + cellData.month + '" data-range="' + rowData.range + '">' + display + '</span></td>'});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell').forEach(cell=>{cell.onclick=()=>openCellModal(cell.dataset.month,cell.dataset.range)})}


function renderRetentionTable(){
  console.log('üìä renderRetentionTable called');
  
  const hasFilters=Object.values(retentionFilters).some(arr=>arr.length>0);
  console.log('üìä hasFilters:', hasFilters);
  
  // ‚úÖ FIX: Don't filter if retentionPlayersCellMap is empty
  const canFilter = hasFilters && retentionPlayersCellMap.size > 0;
  console.log('üìä canFilter:', canFilter, '(mapSize:', retentionPlayersCellMap.size, ')');
  
  const data=canFilter?filterRetentionData(retentionData,retentionFilters,"monthly"):retentionData;
  
  console.log('üìä data after filtering:', data ? {rowsCount: data.rows?.length, monthsCount: data.months?.length} : 'null');
  
  if(!data)return;const table=document.getElementById('retention-table');const filteredMonths=data.months.filter(m=>selectedMonths.includes(m));const maxOffset=Math.max(...data.rows.map(r=>r.retention?r.retention.length:0));let html='<thead><tr><th class="row-header">FTD Month ‚Üì / Active Month ‚Üí</th>';filteredMonths.forEach(m=>html+='<th>' + m + '</th>');html+='</tr></thead><tbody>';data.rows.forEach((row,rowIdx)=>{if(!selectedMonths.includes(row.month))return;html+='<tr><td class="row-header">' + row.month + ' FTD</td>';filteredMonths.forEach((activeMonth,colIdx)=>{const origColIdx=data.months.indexOf(activeMonth);if(origColIdx<rowIdx){html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}else{const retIdx=origColIdx-rowIdx;if(retIdx<row.retention.length){const cell=row.retention[retIdx];let count=cell.count,pct=cell.pct;const bg=retentionHeatmapColor(pct,retIdx,maxOffset),fg=getTextColor(bg);const display=heatmapShowPercent?(pct*100).toFixed(1) + '%':count;html+='<td><span class="cell" style="background:' + bg + ';color:' + fg + ';cursor:pointer" data-ftd-month="' + row.month + '" data-active-month="' + activeMonth + '">' + display + '</span></td>'}else{html+='<td><span class="cell" style="background:#f8fafc;color:#cbd5e1;cursor:default">‚Äî</span></td>'}}});html+='</tr>'});html+='</tbody>';table.innerHTML=html;table.querySelectorAll('.cell[data-ftd-month]').forEach(cell=>{cell.onclick=()=>openRetentionModal(cell.dataset.ftdMonth,cell.dataset.activeMonth)})}

function renderKpiTabs(){
  const container=document.getElementById('kpiTabs');
  container.innerHTML='';
  
  Object.keys(kpiDataByTab).forEach(tab=>{
    const tabBtn=document.createElement('div');
    tabBtn.className='kpi-tab'+(tab===kpiCurrentTab?' active':'');
    tabBtn.textContent=tab;
    tabBtn.onclick=()=>{
      // Switch to new tab
      kpiCurrentTab=tab;
      document.querySelectorAll('.kpi-tab').forEach(b=>b.classList.remove('active'));
      tabBtn.classList.add('active');
      
      // DON'T clear kpiSelectedPeriods - keep them for all tabs!
      console.log('üîÑ Switched to', tab, '- keeping', kpiSelectedPeriods.size, 'selected periods');
      
      kpiVisibleMetrics.clear();
      document.getElementById('kpiNormalView').style.display='block';
      document.getElementById('kpiCompareView').style.display='none';
      renderKpiSidebar();
      renderKpiMetrics();
      renderMetricsFilter();
    };
    container.appendChild(tabBtn);
  });
  
  const compareBtn=document.createElement('div');
  compareBtn.className='kpi-tab compare-tab';
  compareBtn.textContent='üîÑ Compare';
  compareBtn.style.marginLeft='auto';
  compareBtn.onclick=()=>{
    document.querySelectorAll('.kpi-tab').forEach(b=>b.classList.remove('active'));
    compareBtn.classList.add('active');
    document.getElementById('kpiNormalView').style.display='none';
    document.getElementById('kpiCompareView').style.display='block';
    if(!window.compareInitialized){
      initCompareView();
      window.compareInitialized=true;
    }
  };
  container.appendChild(compareBtn);
}

function renderKpiSidebar(){
  const kpiData=kpiDataByTab[kpiCurrentTab];
  if(!kpiData||!kpiData.months){
    document.getElementById('kpiPeriods').innerHTML='<div style="color:#ef4444">No data</div>';
    return;
  }
  
  const container=document.getElementById('kpiPeriods');
  container.innerHTML='';
  
  // Render all months and weeks
  kpiData.months.forEach((m,idx)=>{
    const monthGroup=document.createElement('div');
    monthGroup.className='month-group';
    
    const monthHeader=document.createElement('div');
    monthHeader.className='month-header';
    monthHeader.style.cursor='pointer';
    monthHeader.onclick=()=>toggleMonthExpand(idx);
    
    const monthCheckbox=document.createElement('input');
    monthCheckbox.type='checkbox';
    monthCheckbox.id='kpi-m-'+m.ym;
    monthCheckbox.onclick=(e)=>{e.stopPropagation();toggleKpiMonth('M:'+m.ym)};
    
    const monthLabel=document.createElement('span');
    monthLabel.className='month-label';
    monthLabel.textContent=m.label;
    
    const monthCount=document.createElement('span');
    monthCount.className='month-count';
    monthCount.textContent=m.weeks.length+' wk';
    
    monthHeader.appendChild(monthCheckbox);
    monthHeader.appendChild(monthLabel);
    monthHeader.appendChild(monthCount);
    
    const weeksList=document.createElement('div');
    weeksList.className='weeks-list';
    weeksList.id='weeks-'+idx;
    
    m.weeks.forEach((w,wi)=>{
      const wKey='W:'+m.ym+':'+wi;
      const weekItem=document.createElement('div');
      weekItem.className='week-item';
      
      const weekCheckbox=document.createElement('input');
      weekCheckbox.type='checkbox';
      weekCheckbox.id='kpi-w-'+wKey;
      weekCheckbox.onclick=()=>toggleKpiPeriod(wKey);
      
      const weekLabel=document.createElement('label');
      weekLabel.className='week-label';
      weekLabel.htmlFor='kpi-w-'+wKey;
      weekLabel.textContent=w.label;
      
      weekItem.appendChild(weekCheckbox);
      weekItem.appendChild(weekLabel);
      weeksList.appendChild(weekItem);
    });
    
    monthGroup.appendChild(monthHeader);
    monthGroup.appendChild(weeksList);
    container.appendChild(monthGroup);
  });
  
  // Restore checkboxes from GLOBAL kpiSelectedPeriods
  if (kpiSelectedPeriods.size > 0) {
    console.log('üîÑ Applying', kpiSelectedPeriods.size, 'global periods to', kpiCurrentTab, 'tab');
    
    var appliedCount = 0;
    
    // Restore month checkboxes (only if they exist in this tab)
    kpiData.months.forEach((m) => {
      const mKey = 'M:' + m.ym;
      if (kpiSelectedPeriods.has(mKey)) {
        const cb = document.getElementById('kpi-m-' + m.ym);
        if (cb) {
          cb.checked = true;
          appliedCount++;
        }
      }
    });
    
    // Restore week checkboxes (only if they exist in this tab)
    kpiData.months.forEach((m) => {
      m.weeks.forEach((w, wi) => {
        const wKey = 'W:' + m.ym + ':' + wi;
        if (kpiSelectedPeriods.has(wKey)) {
          const cb = document.getElementById('kpi-w-' + wKey);
          if (cb) {
            cb.checked = true;
            appliedCount++;
          }
        }
      });
    });
    
    console.log('‚úÖ Applied', appliedCount, 'periods to', kpiCurrentTab, 'tab');
  } else {
    // First time - select last 3 months by default
    console.log('üÜï No global periods - selecting last 3 months by default');
    kpiData.months.slice(-3).forEach((m)=>{
      const cb=document.getElementById('kpi-m-'+m.ym);
      if(cb){
        cb.checked=true;
        kpiSelectedPeriods.add('M:'+m.ym);
      }
    });
  }
  
  renderKpiChart();
  renderKpiTable();
}

function toggleMonthExpand(idx){document.getElementById('weeks-'+idx).classList.toggle('open')}

function toggleKpiMonth(key){const cb=document.getElementById('kpi-m-'+key.substring(2));if(cb&&cb.checked){kpiSelectedPeriods.add(key)}else{kpiSelectedPeriods.delete(key)}renderKpiChart();renderKpiTable()}

function toggleKpiPeriod(key){const cb=document.getElementById('kpi-w-'+key);if(cb&&cb.checked){kpiSelectedPeriods.add(key)}else{kpiSelectedPeriods.delete(key)}renderKpiChart();renderKpiTable()}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
  const toggle = document.querySelector('.sidebar-toggle');
  if(document.getElementById('sidebar').classList.contains('collapsed')){
    toggle.textContent = '‚ñ∂';
  }else{
    toggle.textContent = '‚óÄ';
  }
}

function toggleMetricsFilter(){
  document.getElementById('metricsFilter').classList.toggle('collapsed');
}

function renderKpiMetrics(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiData.metrics)return;const container=document.getElementById('kpiMetrics');container.innerHTML='';const metrics=kpiData.metrics.slice(0,20);metrics.forEach((m,i)=>{const btn=document.createElement('button');btn.className='metric-btn'+(i===0&&!kpiCurrentMetric?' active':'')+(m===kpiCurrentMetric?' active':'');btn.textContent=m;btn.onclick=()=>{kpiCurrentMetric=m;document.querySelectorAll('#kpiMetrics .metric-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderKpiChart();document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=m};container.appendChild(btn)});if(!kpiCurrentMetric&&metrics.length>0){kpiCurrentMetric=metrics[0];document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=metrics[0]}else if(kpiCurrentMetric){document.getElementById('selectedMetricDisplay').style.display='block';document.getElementById('selectedMetricName').textContent=kpiCurrentMetric}}

function renderMetricsFilter(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiData.metrics)return;const container=document.getElementById('metricsFilterGrid');container.innerHTML='';kpiData.metrics.forEach((metric,idx)=>{const item=document.createElement('div');item.className='metric-check-item';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.id='metric-vis-'+idx;checkbox.checked=kpiVisibleMetrics.has(metric)||idx<5;if(checkbox.checked)kpiVisibleMetrics.add(metric);checkbox.onchange=()=>{if(checkbox.checked){kpiVisibleMetrics.add(metric)}else{kpiVisibleMetrics.delete(metric)}renderKpiTable()};const label=document.createElement('label');label.htmlFor='metric-vis-'+idx;label.textContent=metric;item.appendChild(checkbox);item.appendChild(label);container.appendChild(item)})}

function renderKpiChart(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData||!kpiCurrentMetric||kpiSelectedPeriods.size===0)return;if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const ctx=document.getElementById('kpiChart').getContext('2d');const labels=[],values=[],colors=[];const monthGradients=[['#667eea','#764ba2'],['#f093fb','#f5576c'],['#4facfe','#00f2fe'],['#43e97b','#38f9d7'],['#fa709a','#fee140'],['#30cfd0','#330867'],['#a8edea','#fed6e3'],['#ff9a9e','#fecfef'],['#ffecd2','#fcb69f'],['#ff6e7f','#bfe9ff'],['#e0c3fc','#8ec5fc'],['#f093fb','#f5576c']];let monthIdx=0;kpiData.months.forEach(m=>{const mKey='M:'+m.ym;if(kpiSelectedPeriods.has(mKey)){labels.push(m.label);const val=m.monthly[kpiCurrentMetric]||m.sumWeeks[kpiCurrentMetric]||0;values.push(val);const grad=ctx.createLinearGradient(0,0,0,400);const colorPair=monthGradients[monthIdx%monthGradients.length];grad.addColorStop(0,colorPair[0]);grad.addColorStop(1,colorPair[1]);colors.push(grad);monthIdx++}m.weeks.forEach((w,wi)=>{const wKey='W:'+m.ym+':'+wi;if(kpiSelectedPeriods.has(wKey)){labels.push(w.label);values.push(w.weekly[kpiCurrentMetric]||0);const colorPair=monthGradients[(monthIdx-1)%monthGradients.length];const lightColor=lightenColor(colorPair[0],0.3);colors.push(lightColor)}})});const config={type:'bar',data:{labels,datasets:[{data:values,backgroundColor:colors,borderRadius:8,barPercentage:0.6,categoryPercentage:0.7}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30,bottom:10}},plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',color:'#1e293b',font:{weight:'bold',size:11},formatter:(v)=>formatKpiValue(kpiCurrentMetric,v)}},scales:{y:{beginAtZero:true,grace:'10%',grid:{color:'#f1f5f9'},ticks:{font:{weight:'600'},color:'#64748b',callback:(v)=>formatKpiValue(kpiCurrentMetric,v)}},x:{grid:{display:false},ticks:{font:{weight:'600',size:10},color:'#64748b'}}}}};if(kpiChart)kpiChart.destroy();kpiChart=new Chart(ctx,config)}

function lightenColor(hex,percent){const num=parseInt(hex.replace('#',''),16);const amt=Math.round(2.55*percent*100);const R=(num>>16)+amt;const G=(num>>8&0x00FF)+amt;const B=(num&0x0000FF)+amt;return '#'+(0x1000000+(R<255?R<1?0:R:255)*0x10000+(G<255?G<1?0:G:255)*0x100+(B<255?B<1?0:B:255)).toString(16).slice(1)}

function renderKpiTable(){const kpiData=kpiDataByTab[kpiCurrentTab];if(!kpiData)return;const table=document.getElementById('kpi-table');const visibleMetrics=kpiVisibleMetrics.size>0?[...kpiVisibleMetrics]:kpiData.metrics.slice(0,5);let html='<thead><tr><th>Period</th>';visibleMetrics.forEach(m=>html+='<th>'+escapeHtml(m)+'</th>');html+='</tr></thead><tbody>';kpiData.months.forEach(m=>{const mKey='M:'+m.ym;if(kpiSelectedPeriods.has(mKey)){html+='<tr><td style="font-weight:700;color:#667eea">'+escapeHtml(m.label)+'</td>';visibleMetrics.forEach(metric=>{const val=m.monthly[metric]||m.sumWeeks[metric]||0;html+='<td style="font-weight:700">'+formatKpiValue(metric,val)+'</td>'});html+='</tr>'}m.weeks.forEach((w,wi)=>{const wKey='W:'+m.ym+':'+wi;if(kpiSelectedPeriods.has(wKey)){html+='<tr><td style="padding-left:24px;color:#64748b">'+escapeHtml(w.label)+'</td>';visibleMetrics.forEach(metric=>{html+='<td>'+formatKpiValue(metric,w.weekly[metric]||0)+'</td>'});html+='</tr>'}})});html+='</tbody>';table.innerHTML=html}

function formatKpiValue(metric,val){const format=metricFormats[metric];if(format){if(format==='%')return(val||0).toFixed(2)+'%';if(format==='eur')return'‚Ç¨'+(val||0).toFixed(2);if(format==='count')return Math.round(val||0).toLocaleString();return Math.round(val||0).toLocaleString()}const m=String(metric).toLowerCase();if(m.includes('rate')||m.includes('percent')||m.includes('conversion')||m.includes('hold'))return(val||0).toFixed(2)+'%';if(m.includes('arpu')||m.includes('amount')||m.includes('sum')||m.includes('ggr')||m.includes('ngr')||m.includes('cashout'))return'‚Ç¨'+(val||0).toFixed(2);return Math.round(val||0).toLocaleString()}

function openRetentionModal(ftdMonth,activeMonth){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=ftdMonth + ' FTD ‚Üí ' + activeMonth + ' Active';document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=ftdMonth + '|' + activeMonth;const cachedData=retentionPlayersCellMap.get(cellKey);if(cachedData){console.log('Using cached monthly data for:',cellKey,cachedData);currentModalData=cachedData;currentFilteredData=applyFiltersToData(cachedData,retentionFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching monthly modal data for:',ftdMonth,'‚Üí',activeMonth);google.script.run.withSuccessHandler(data=>{console.log('Monthly modal data received:',data);currentModalData=data;currentFilteredData=applyFiltersToData(data,retentionFilters);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Monthly modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayersRetention({ftdMonth,activeMonth})}

let currentModalData=null;
let currentFilteredData=null;
function openCellModal(month,depositRange){const modal=document.getElementById('modal');document.getElementById('modalTitle').textContent=month + ' ‚Ä¢ ' + depositRange;document.getElementById('modalBody').innerHTML='<div style="text-align:center;padding:40px;color:#64748b">Loading...</div>';modal.classList.add('open');const cellKey=month + '|' + depositRange;const cachedData=playersCellMap.get(cellKey);if(cachedData){console.log('Using cached deposit data for:',cellKey);console.log('  - Cached type:', typeof cachedData, Array.isArray(cachedData) ? 'array' : 'object');console.log('  - Cached achieved:', cachedData.achieved ? cachedData.achieved.length : (Array.isArray(cachedData) ? cachedData.length : 0));console.log('  - Cached dropped:', cachedData.dropped ? cachedData.dropped.length : 0);let data;if(Array.isArray(cachedData)){console.warn('‚ö†Ô∏è Old cache format - no dropped data');data={achieved:cachedData,dropped:[],month:month,range:depositRange,total:cachedData.length,totalAchieved:cachedData.length,totalDropped:0}}else{data=cachedData}currentModalData=data;currentFilteredData=applyFiltersToData(data,depositFilters);console.log('Filtered from cache:',currentFilteredData);renderModalContent(currentFilteredData);return}console.log('Fetching deposit modal data for:',month,depositRange);google.script.run.withSuccessHandler(data=>{console.log('Deposit modal data received:',data);console.log('  - Achieved:', data.achieved ? data.achieved.length : 0);console.log('  - Dropped:', data.dropped ? data.dropped.length : 0);playersCellMap.set(cellKey, data);console.log('‚úÖ Cached deposit data for:', cellKey);currentModalData=data;currentFilteredData=applyFiltersToData(data,depositFilters);renderModalContent(currentFilteredData)}).withFailureHandler(err=>{console.error('Deposit modal error:',err);document.getElementById('modalBody').innerHTML='<div class="err">Error: '+err+'</div>'}).getCellPlayers({month,depositRange})}

function closeModal(){document.getElementById('modal').classList.remove('open');currentModalData=null}

function applyFiltersToData(data,filters){
  const achievedOriginal=deduplicatePlayers(data.achieved||[]);
  const droppedOriginal=deduplicatePlayers(data.dropped||[]);
  
  let filtered={
    achieved:achievedOriginal,
    dropped:droppedOriginal,
    month:data.month,
    range:data.range,
    totalAchieved:achievedOriginal.length,
    totalDropped:droppedOriginal.length
  };
  
  // ‚úÖ FIX: Support both 'type' and 'vipType' keys
  const typeFilter = filters.type || filters.vipType || [];
  if(typeFilter.length>0){
    filtered.achieved=filtered.achieved.filter(p=>typeFilter.includes(getPlayerTypeFromTags(p.tags)));
    filtered.dropped=filtered.dropped.filter(p=>typeFilter.includes(getPlayerTypeFromTags(p.tags)));
  }
  
  if(filters.manager && filters.manager.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.manager.includes(getManager(p.tags)));
    filtered.dropped=filtered.dropped.filter(p=>filters.manager.includes(getManager(p.tags)));
  }
  
  if(filters.trafficType && filters.trafficType.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.trafficType.includes(p.trafficType));
    filtered.dropped=filtered.dropped.filter(p=>filters.trafficType.includes(p.trafficType));
  }
  
  if(filters.country && filters.country.length>0){
    filtered.achieved=filtered.achieved.filter(p=>filters.country.includes(p.country));
    filtered.dropped=filtered.dropped.filter(p=>filters.country.includes(p.country));
  }
  
  return filtered;
}

/**
 * DEPRECATED: Use getPlayerTypeFromTags() instead
 * Kept for backwards compatibility but redirects to new function
 */
function getVipType(tags){
  return getPlayerTypeFromTags(tags);
}

function getManager(tags){
  if(!tags)return'';
  
  // ‚úÖ Use dynamic vipManagerMapping from MANAGER sheet
  if(vipManagerMapping && Object.keys(vipManagerMapping).length > 0) {
    var tagsArray = [];
    if(Array.isArray(tags)) {
      tagsArray = tags;
    } else if(typeof tags === 'string') {
      try { tagsArray = JSON.parse(tags); } catch(e) { tagsArray = [tags]; }
    }
    
    for(var i = 0; i < tagsArray.length; i++) {
      var tag = String(tagsArray[i]).toLowerCase().trim();
      if(vipManagerMapping[tag]) return vipManagerMapping[tag];
    }
  }
  
  return '';
}

/**
 * Get player TYPE from tags attribute using TYPE sheet mapping
 * This function uses tagToTypeMap loaded from Google Sheets TYPE sheet
 */
function getPlayerTypeFromTags(tags) {
  // ‚úÖ Handle empty strings
  if (!tags || tags === '' || tags === '[]') return 'UNKNOWN';
  
  // If tagToTypeMap is loaded and not empty, use it
  if (tagToTypeMap && Object.keys(tagToTypeMap).length > 0) {
    // Parse tags - can be string, JSON array, or comma-separated
    let tagsArray = [];
    
    if (Array.isArray(tags)) {
      tagsArray = tags.filter(t => t && String(t).trim() !== ''); // Filter empty
    } else if (typeof tags === 'string') {
      // ‚úÖ Skip empty strings
      if (tags.trim() === '') return 'UNKNOWN';
      
      // Try parse as JSON first
      if (tags.trim().startsWith('[')) {
        try {
          tagsArray = JSON.parse(tags);
          tagsArray = tagsArray.filter(t => t && String(t).trim() !== ''); // Filter empty
        } catch (e) {
          // Not JSON, split by comma
          tagsArray = tags.split(',').map(t => t.trim()).filter(t => t !== '');
        }
      } else {
        // Split by comma
        tagsArray = tags.split(',').map(t => t.trim()).filter(t => t !== '');
      }
    } else {
      tagsArray = [String(tags)];
    }
    
    // ‚úÖ Skip if no valid tags
    if (tagsArray.length === 0) return 'UNKNOWN';
    
    // Check each tag against tagToTypeMap (case-insensitive)
    for (let i = 0; i < tagsArray.length; i++) {
      let tag = String(tagsArray[i]).trim().toLowerCase(); // ‚úÖ LOWERCASE
      if (tagToTypeMap[tag]) {
        // Debug first match (only log 1% to avoid spam)
        if (Math.random() < 0.01) {
          console.log('‚úÖ TYPE match:', tag, '‚Üí', tagToTypeMap[tag]);
        }
        return tagToTypeMap[tag];
      }
    }
    
    // ‚ö†Ô∏è ENHANCED DEBUG: Show ALL unmatched tags to find the problem
    if (tagsArray.length > 0) {
      console.warn('‚ö†Ô∏è No TYPE match!', {
        inputTags: tagsArray,
        inputTagsLowercase: tagsArray.map(t => String(t).toLowerCase()),
        availableTags: Object.keys(tagToTypeMap),
        tagToTypeMap: tagToTypeMap
      });
    }
    
    return 'UNKNOWN';
  }
  
  // Fallback if tagToTypeMap not loaded
  return getPlayerTypeFallback(tags);
}

/**
 * Fallback function for TYPE determination when TYPE sheet is not loaded
 * Based on hardcoded rules
 */
function getPlayerTypeFallback(tags) {
  if (!tags) return 'UNKNOWN';
  
  var tagsStr = String(tags).toLowerCase();
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥ –ù–ê–ô–ë–Ü–õ–¨–® –°–ü–ï–¶–ò–§–Ü–ß–ù–û–ì–û –¥–æ –ó–ê–ì–ê–õ–¨–ù–û–ì–û
  
  // PRE-VIP: ann_pre_vip (–ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ü–ï–†–ï–î VIP, –±–æ –º—ñ—Å—Ç–∏—Ç—å 'vip')
  if (tagsStr.includes('ann_pre_vip')) {
    return 'PRE-VIP';
  }
  
  // VIP: ann_vip, kevin_vip, dominic_vip
  if (tagsStr.includes('ann_vip') || tagsStr.includes('kevin_vip') || 
      tagsStr.includes('dominic_vip')) {
    return 'VIP';
  }
  
  // SILENT PRE-VIP: pre_ann
  if (tagsStr.includes('pre_ann')) {
    return 'SILENT PRE-VIP';
  }
  
  // SILENT VIP: ann (–∞–ª–µ –Ω–µ ann_vip —ñ –Ω–µ ann_pre_vip)
  if (tagsStr.includes('ann') && !tagsStr.includes('ann_vip') && !tagsStr.includes('ann_pre_vip')) {
    return 'SILENT VIP';
  }
  
  // VIP: –ø—Ä–æ—Å—Ç–æ 'vip' tag (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –æ–∫—Ä–µ–º–∏–π tag, –Ω–µ —á–∞—Å—Ç–∏–Ω–∞ —ñ–Ω—à–æ–≥–æ)
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ 'vip' –ù–ï —î —á–∞—Å—Ç–∏–Ω–æ—é pre_vip –∞–±–æ _vip
  var tagsArray = tagsStr.split(',').map(t => t.trim());
  if (tagsArray.includes('vip')) {
    return 'VIP';
  }
  
  return 'UNKNOWN';
}

/**
 * Load TYPE mapping from Google Sheets
 * This should be called during app initialization
 */
function loadTypeMapping() {
  return new Promise((resolve) => {
    console.log('üìã Loading TYPE mapping from Google Sheets...');
    
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      console.log('‚ö†Ô∏è Not in Apps Script environment - using fallback TYPE detection');
      resolve();
      return;
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.error) {
          console.error('‚ùå Error loading TYPE mapping:', result.error);
          resolve();
          return;
        }
        
        tagToTypeMap = result.tagToType || {};
        typeMapping = result.typeMapping || {};
        typeToTotal = result.typeToTotal || {};
        totalGroups = result.totalGroups || {};
        
        console.log('‚úÖ TYPE mapping loaded:', {
          types: Object.keys(typeMapping),
          tagsCount: Object.keys(tagToTypeMap).length,
          totalGroups: Object.keys(totalGroups)
        });
        
        if (typeof renderGlobalFilters === 'function') {
          renderGlobalFilters();
        }
        
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to load TYPE mapping:', error);
        resolve();
      })
      .getTypeMapping();
  });
}

function createBackofficeLink(id){if(!id)return'';return'https://backoffice.slotornado-bivu.com/backend/players/'+String(id).replace('slotornado:','').trim()}

function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>showToast('üìã Copied: '+text)).catch(err=>console.error(err))}

function showToast(msg){const toast=document.getElementById('toast');toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000)}
function loadVIPData(){return new Promise((resolve)=>{console.log('Loading VIP data...');google.script.run.withSuccessHandler(data=>{console.log('VIP data received:',data);if(!data){console.error('No data received from backend');vipData={error:'No data received from backend'};renderVIPDashboard();resolve();return}if(data.error){console.error('Backend error:',data.error);vipData={error:data.error};renderVIPDashboard();resolve();return}vipData=data;window.vipAllPlayers=data.allPlayers||null;console.log('VIP data loaded successfully:',{playerCounts:data.playerCounts,allPlayers:vipAllPlayers?'‚úì':'‚úó',vocabulary:data.vocabulary?Object.keys(data.vocabulary).length:0,metrics:data.metrics?'‚úì':'‚úó'});renderVIPDashboard();renderVIPFilters();resolve()}).withFailureHandler(err=>{console.error('Failed to load VIP data:',err);vipData={error:'Failed to load VIP data: '+err.message};renderVIPDashboard();resolve()}).getVIPDashboardData()})}

let currentPeriod='30'
function getMetricIdForPeriod(baseMetric,period){const mapping={deposit_sum:{lifetime:'lifetime_deposit_sum_total','90':'deposit_sum_last_90_total','30':'deposit_sum_last_30_total','7':'deposit_sum_last_7_total','1':'deposit_sum_previous_day_total'},cashout_sum:{lifetime:'lifetime_cashout_sum_total','90':'cashout_sum_last_90_total','30':'cashout_sum_last_30_total','7':'cashout_sum_last_7_total','1':'cashout_sum_previous_day_total'},deposit_count:{lifetime:'lifetime_deposit_count_total','90':'deposit_count_last_90_total','30':'deposit_count_last_30_total','7':'deposit_count_last_7_total','1':'deposit_count_previous_day_total'},cashout_count:{lifetime:'lifetime_cashout_count_total','90':'cashout_count_last_90_total','30':'cashout_count_last_30_total','7':'cashout_count_last_7_total','1':'cashout_count_previous_day_total'}};return mapping[baseMetric]?mapping[baseMetric][period]:null}

function isCorePeriodMetric(metricId){const patterns=[/_deposit_sum_/,/_cashout_sum_/,/_deposit_count_/,/_cashout_count_/];return patterns.some(p=>p.test(metricId))}

function getBaseMetricType(metricId){if(metricId.includes('deposit_sum'))return'deposit_sum';if(metricId.includes('cashout_sum'))return'cashout_sum';if(metricId.includes('deposit_count'))return'deposit_count';if(metricId.includes('cashout_count'))return'cashout_count';return null}

function switchPeriod(period){currentPeriod=period;document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));document.querySelector('.period-tab[data-period="' + period + '"]').classList.add('active');renderVIPDashboard()}


function switchVIPTab(tab){
  currentVIPTab=tab;
  
  // Update active class on tabs
  document.querySelectorAll('.vip-tab').forEach(function(btn) {
    if (btn.getAttribute('data-tab') === tab) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  console.log('üîÑ Switched to VIP tab:', tab);
  renderVIPDashboard();
}


let vipFilters={manager:[],trafficType:[],country:[],currency:[],vipType:[]}
let vipDynamicFilters={}
// Use window.vipAllPlayers for global access
window.vipAllPlayers=null
let vipManagerMapping={}
let vipTrafficMapping={}
let currentManager=null
let availableManagers=[]

function getPlayerManager(player){
  if(!player||!player.tags||!Array.isArray(player.tags))return'';
  
  // Find all matching tags
  const matches=[];
  for(let i=0;i<player.tags.length;i++){
    const tag=String(player.tags[i]).toLowerCase().trim();
    if(vipManagerMapping[tag]){
      matches.push({
        tag:tag,
        manager:vipManagerMapping[tag],
        priority:tag.length  // Longer tags = more specific
      });
    }
  }
  
  if(matches.length===0)return'';
  
  // Sort by priority (longer/more specific tags first)
  matches.sort((a,b)=>b.priority-a.priority);
  
  // Return most specific match
  return matches[0].manager;
}

function getStagPrefix(fullStag){if(!fullStag)return'';const stagStr=String(fullStag);const idx=stagStr.indexOf('_');return idx>0?stagStr.substring(0,idx):stagStr}

function toggleVIPFilterSidebar(){
  console.log('üîç Toggle VIP Filter');
  const sidebar=document.getElementById('vipFilterSidebar');
  const overlay=document.getElementById('vipFilterOverlay');
  if(!sidebar){console.error('‚ùå VIP sidebar not found!');return;}
  if(!overlay){console.error('‚ùå VIP overlay not found!');return;}
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('open');
  
  const isOpen=sidebar.classList.contains('open');
  console.log('‚úÖ VIP sidebar toggled, open:', isOpen);
  
  if(isOpen){
    console.log('  - Sidebar position:', window.getComputedStyle(sidebar).right);
    console.log('  - Sidebar z-index:', window.getComputedStyle(sidebar).zIndex);
  }
}

// Deposit Sidebar Functions
function openDepositFilterSidebar(){
  console.log('üîç Opening Deposit Filter Sidebar');
  document.getElementById('depositFilterSidebar').classList.add('active');
  document.getElementById('depositFilterOverlay').classList.add('active');
  document.body.style.overflow='hidden';
  setupDepositSidebarSearch();
}

function closeDepositFilterSidebar(){
  console.log('üîç Closing Deposit Filter Sidebar');
  document.getElementById('depositFilterSidebar').classList.remove('active');
  document.getElementById('depositFilterOverlay').classList.remove('active');
  document.body.style.overflow='';
}

// Retention Sidebar Functions
function openRetentionFilterSidebar(){
  console.log('üîç Opening Retention Filter Sidebar');
  document.getElementById('retentionFilterSidebar').classList.add('active');
  document.getElementById('retentionFilterOverlay').classList.add('active');
  document.body.style.overflow='hidden';
  setupRetentionSidebarSearch();
}

function closeRetentionFilterSidebar(){
  console.log('üîç Closing Retention Filter Sidebar');
  document.getElementById('retentionFilterSidebar').classList.remove('active');
  document.getElementById('retentionFilterOverlay').classList.remove('active');
  document.body.style.overflow='';
}

// Setup search for Deposit sidebar
function setupDepositSidebarSearch(){
  const filters=['Type','Manager','Traffic','Country'];
  filters.forEach(function(filter){
    const search=document.getElementById('deposit'+filter+'Search');
    const list=document.getElementById('deposit'+filter.replace('Type','VipType')+'Filters');
    if(search&&list){
      search.oninput=function(){
        const term=this.value.toLowerCase();
        Array.from(list.children).forEach(function(item){
          const label=item.querySelector('.sidebar-filter-item-label');
          if(label){
            const text=label.textContent.toLowerCase();
            item.style.display=text.includes(term)?'flex':'none';
          }
        });
      };
    }
  });
}

// Setup search for Retention sidebar
function setupRetentionSidebarSearch(){
  const filters=['Type','Manager','Traffic','Country'];
  filters.forEach(function(filter){
    const search=document.getElementById('retention'+filter+'Search');
    const list=document.getElementById('retention'+filter.replace('Type','VipType')+'Filters');
    if(search&&list){
      search.oninput=function(){
        const term=this.value.toLowerCase();
        Array.from(list.children).forEach(function(item){
          const label=item.querySelector('.sidebar-filter-item-label');
          if(label){
            const text=label.textContent.toLowerCase();
            item.style.display=text.includes(term)?'flex':'none';
          }
        });
      };
    }
  });
}

// Close sidebars on Escape key
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeDepositFilterSidebar();
    closeRetentionFilterSidebar();
  }
});

function renderSidebarFilterItems(containerId,values,filterKey,view){
  const container=document.getElementById(containerId);
  if(!container)return;
  
  container.innerHTML='';
  
  if(!values||values.length===0){
    container.innerHTML='<div style="padding:10px;text-align:center;color:#94a3b8;font-size:12px">No options</div>';
    return;
  }
  
  const currentFilters=view==='retention'?retentionFilters[filterKey]:depositFilters[filterKey];
  
  values.forEach((value,index)=>{
    if(!value||value==='')return;
    
    // Create item container
    const item=document.createElement('div');
    item.className='sidebar-filter-item';
    
    // Create checkbox
    const checkbox=document.createElement('input');
    checkbox.type='checkbox';
    checkbox.className='sidebar-filter-checkbox';
    checkbox.id=view+'_'+filterKey+'_'+index;
    if(currentFilters&&currentFilters.includes(value)){
      checkbox.checked=true;
    }
    
    // Create label
    const label=document.createElement('label');
    label.className='sidebar-filter-item-label';
    label.htmlFor=view+'_'+filterKey+'_'+index;
    label.textContent=value;
    
    // Create count badge (placeholder - will be updated with actual count)
    const count=document.createElement('span');
    count.className='sidebar-filter-count';
    count.textContent='0';
    count.style.display='none'; // Hide for now, will show when we have counts
    
    // Add click handler - only update filter object, don't re-render
    checkbox.onchange=function(){
      const filters=view==='deposit'?depositFilters:retentionFilters;
      if(this.checked){
        if(!filters[filterKey].includes(value)){
          filters[filterKey].push(value);
        }
      }else{
        filters[filterKey]=filters[filterKey].filter(v=>v!==value);
      }
      console.log('‚úÖ Filter updated:', view, filterKey, '=', value, 'checked:', this.checked);
      console.log('üìä Current', view, 'filters:', JSON.stringify(filters, null, 2));
    };
    
    // Assemble item
    item.appendChild(checkbox);
    item.appendChild(label);
    item.appendChild(count);
    
    container.appendChild(item);
  });
}

function applyDepositFilters(){
  console.log('‚úÖ Applying Deposit Filters');
  console.log('üìä Deposit filters:', depositFilters);
  
  const hasFilters = Object.values(depositFilters).some(arr=>arr.length>0);
  if(hasFilters && playersCellMap.size === 0){
    showToast('‚è≥ Player data still loading... Filters will work after loading completes. Please try again in a moment.');
    closeDepositFilterSidebar();
    return;
  }
  
  renderBarChart();
  renderDepositTable();
  closeDepositFilterSidebar();
  showToast('‚úÖ Filters applied');
}

function applyRetentionFilters(){
  console.log('===== APPLYING RETENTION FILTERS =====');
  console.log('üìä Types selected:', retentionFilters.type);
  console.log('üë§ Managers selected:', retentionFilters.manager);
  console.log('üéØ Traffic selected:', retentionFilters.trafficType);
  console.log('üåç Countries selected:', retentionFilters.country);
  console.log('======================================');
  
  const hasFilters = Object.values(retentionFilters).some(arr=>arr.length>0);
  if(hasFilters && retentionPlayersCellMap.size === 0){
    showToast('‚è≥ Player data still loading... Filters will work after loading completes. Please try again in a moment.');
    closeRetentionFilterSidebar();
    return;
  }
  
  if(retentionMode==='monthly'){
    renderRetentionChart();
    renderRetentionTable();
  }else{
    renderWeeklyRetentionChart();
    renderWeeklyRetentionTable();
  }
  closeRetentionFilterSidebar();
  showToast('‚úÖ Filters applied');
}

function toggleVIPTypeFilter(vipType){const checkbox=vipType==='VIP'?document.getElementById('vipTypeVIP'):document.getElementById('vipTypeSilent');checkbox.classList.toggle('checked');const checked=checkbox.classList.contains('checked');updateVIPFilter('vipType',vipType,checked)}

function selectManager(managerName){currentManager=managerName||null;updateManagerUI();applyManagerFilter()}

function clearManager(){currentManager=null;document.getElementById('vipManagerDropdown').value='';updateManagerUI();applyManagerFilter()}

function updateManagerUI(){const badge=document.getElementById('vipManagerBadge');const clearBtn=document.getElementById('vipManagerClearBtn');if(currentManager){badge.textContent='üë§ '+currentManager;badge.style.display='inline-flex';clearBtn.style.display='block'}else{badge.style.display='none';clearBtn.style.display='none'}}

function applyManagerFilter(){if(!vipAllPlayers)return;console.log('üéØ Applying manager filter:',currentManager);let filteredPlayers=vipAllPlayers;if(currentManager){filteredPlayers={vip:vipAllPlayers.vip.filter(p=>getPlayerManager(p)===currentManager),silentVip:vipAllPlayers.silentVip.filter(p=>getPlayerManager(p)===currentManager)};console.log('Filtered by manager:',filteredPlayers.vip.length,'VIP +',filteredPlayers.silentVip.length,'Silent VIP')}const finalFiltered=filterVIPData(filteredPlayers,vipFilters);const vocabulary=vipData.vocabulary||{};const newMetrics=calculateVIPMetricsClient(finalFiltered.vip,finalFiltered.silentVip,vocabulary);vipData.metrics=newMetrics;vipData.playerCounts={total:finalFiltered.vip.length+finalFiltered.silentVip.length,vip:finalFiltered.vip.length,silentVip:finalFiltered.silentVip.length};renderVIPDashboard()}

function populateManagerDropdown(){console.log('üîß populateManagerDropdown called with',availableManagers.length,'managers');const dropdown=document.getElementById('vipManagerDropdown');const selector=document.getElementById('vipManagerSelector');if(!availableManagers||availableManagers.length===0){console.log('‚ö†Ô∏è No managers available, hiding selector');selector.style.display='none';return}console.log('‚úÖ Showing manager selector with managers:',availableManagers);selector.style.display='flex';dropdown.innerHTML='<option value="">All Managers</option>';availableManagers.forEach(manager=>{const option=document.createElement('option');option.value=manager;option.textContent=manager;dropdown.appendChild(option)});console.log('‚úÖ Manager dropdown populated')}

function toggleVIPSubmenu(){console.log('üîÑ toggleVIPSubmenu called');const submenu=document.getElementById('vipSubmenu');const toggle=document.getElementById('vipSubmenuToggle');if(!submenu||!toggle){console.error('‚ùå Submenu or toggle not found');return}submenu.classList.toggle('open');toggle.classList.toggle('open');console.log('Submenu open:',submenu.classList.contains('open'))}

function populateVIPSubmenu(){console.log('üîß populateVIPSubmenu called');console.log('availableManagers:',availableManagers);const submenu=document.getElementById('vipSubmenu');if(!submenu){console.error('‚ùå VIP submenu element not found');return}const toggle=document.getElementById('vipSubmenuToggle');if(!toggle){console.error('‚ùå VIP submenu toggle not found');return}if(!availableManagers||availableManagers.length===0){console.log('‚ö†Ô∏è No managers available - check if TAGS sheet has data and VIP players have tags');submenu.innerHTML='<div style="padding:10px 16px 10px 48px;color:#94a3b8;font-size:12px;font-style:italic">No managers found<br><span style="font-size:11px">Check TAGS sheet & player tags</span></div>';toggle.style.display='inline-block';return}let html='';availableManagers.forEach(manager=>{html+='<div class="sidebar-submenu-item" onclick="selectManagerFromSidebar(manager)"><span class="sidebar-submenu-item-icon">üë§</span><span>' + manager + '</span></div>'});submenu.innerHTML=html;toggle.style.display='inline-block';console.log('‚úÖ VIP submenu populated with',availableManagers.length,'managers:',availableManagers)}

function selectManagerFromSidebar(manager){console.log('üìå Selected manager from sidebar:',manager);currentManager=manager;document.getElementById('vipManagerDropdown').value=manager;updateManagerUI();applyManagerFilter();document.querySelectorAll('.sidebar-submenu-item').forEach(item=>item.classList.remove('active'));event.target.closest('.sidebar-submenu-item').classList.add('active')}

function filterVIPData(allPlayers,filters){if(!allPlayers)return{vip:[],silentVip:[]};let vipFiltered=allPlayers.vip||[];let silentFiltered=allPlayers.silentVip||[];const allFilters={...filters,...vipDynamicFilters};const hasFilters=Object.values(allFilters).some(arr=>arr&&arr.length>0);if(!hasFilters)return allPlayers;const applyFilters=(players,playerType)=>{return players.filter(player=>{if(allFilters.vipType&&allFilters.vipType.length>0){if(!allFilters.vipType.includes(playerType))return false}if(allFilters.manager&&allFilters.manager.length>0){const playerManager=getPlayerManager(player);if(!allFilters.manager.includes(playerManager))return false}if(allFilters.trafficType&&allFilters.trafficType.length>0){const stagPrefix=getStagPrefix(player.stag);const playerTraffic=vipTrafficMapping[stagPrefix]||'';if(!allFilters.trafficType.includes(playerTraffic))return false}if(allFilters.country&&allFilters.country.length>0){if(!allFilters.country.includes(String(player.country||'').trim()))return false}if(allFilters.currency&&allFilters.currency.length>0){if(!allFilters.currency.includes(String(player.currency||'').trim()))return false}for(const key in allFilters){if(!['manager','trafficType','country','currency','vipType'].includes(key)&&allFilters[key]&&allFilters[key].length>0){let value=String(player[key]||'').trim();if(key==='gender'){const g=value.toLowerCase();value=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}if(!allFilters[key].includes(value))return false}}return true})};return{vip:applyFilters(vipFiltered,'VIP'),silentVip:applyFilters(silentFiltered,'Silent VIP')}}

function calculateVIPMetricsClient(vipPlayers,silentPlayers,vocabulary){const allPlayers=vipPlayers.concat(silentPlayers);const metrics={sums:{},pies:{},total:{count:allPlayers.length,vipCount:vipPlayers.length,silentVipCount:silentPlayers.length}};Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.type==='dash sum'||metric.type==='dash count'){let totalSum=0,vipSum=0,silentSum=0;vipPlayers.forEach(p=>{const val=Number(p[metricId]||0);vipSum+=val;totalSum+=val});silentPlayers.forEach(p=>{const val=Number(p[metricId]||0);silentSum+=val;totalSum+=val});metrics.sums[metricId]={total:totalSum,vip:vipSum,silentVip:silentSum,name:metric.name,type:metric.type}}else if(metric.type==='dash pie'){const totalDist={},vipDist={},silentDist={};vipPlayers.forEach(p=>{let val=String(p[metricId]||'Unknown').trim();if(metricId==='gender'){const g=val.toLowerCase();val=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}vipDist[val]=(vipDist[val]||0)+1;totalDist[val]=(totalDist[val]||0)+1});silentPlayers.forEach(p=>{let val=String(p[metricId]||'Unknown').trim();if(metricId==='gender'){const g=val.toLowerCase();val=g==='m'||g==='male'?'Male':g==='f'||g==='female'?'Female':'Unknown'}silentDist[val]=(silentDist[val]||0)+1;totalDist[val]=(totalDist[val]||0)+1});metrics.pies[metricId]={total:totalDist,vip:vipDist,silentVip:silentDist}}});return metrics}

function renderVIPFilters(){if(!vipData||!vipData.metrics||!vipData.metrics.pies)return;const pies=vipData.metrics.pies;const vocabulary=vipData.vocabulary||{};const countries=pies.country?Object.keys(pies.country.total).sort():[];const currencies=pies.currency?Object.keys(pies.currency.total).sort():[];renderVIPFilterItems('vipCountryFilterItems','vipCountrySearch','country',countries);renderVIPFilterItems('vipCurrencyFilterItems','vipCurrencySearch','currency',currencies);function applyFilterOpts(options){if(!options||options.error)return;vipManagerMapping=options.managerMapping||vipManagerMapping;vipTrafficMapping=options.trafficMapping||vipTrafficMapping;availableManagers=options.managers||availableManagers;renderVIPFilterItems('vipManagerFilterItems','vipManagerSearch','manager',availableManagers);renderVIPFilterItems('vipTrafficFilterItems','vipTrafficSearch','trafficType',options.trafficTypes||[]);populateManagerDropdown();populateVIPSubmenu()}if(window._filterOptionsPreloaded&&availableManagers.length>0){console.log('Using preloaded filter options');applyFilterOpts({managers:availableManagers,trafficTypes:[...new Set(Object.values(vipTrafficMapping))].sort(),managerMapping:vipManagerMapping,trafficMapping:vipTrafficMapping})}else{google.script.run.withSuccessHandler(function(options){applyFilterOpts(options)}).withFailureHandler(function(err){console.error('Failed filter options:',err)}).getVIPFilterOptions()}const dynamicSection=document.getElementById('vipDynamicFilters');let dynamicHTML='';let hasDynamicFilters=false;Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.filter==='filter'&&metric.type==='dash pie'&&pies[metricId]&&metricId!=='country'&&metricId!=='currency'){if(!hasDynamicFilters){dynamicHTML+='<div class="vip-filter-section-title">üéØ Dynamic Filters</div>';hasDynamicFilters=true}const values=Object.keys(pies[metricId].total).sort();const displayName=metric.name||metricId;if(!vipDynamicFilters[metricId])vipDynamicFilters[metricId]=[];dynamicHTML+='<div class="vip-filter-group"><label class="vip-filter-group-label">' + displayName + '</label><input type="text" class="vip-filter-search" id="vip' + metricId + 'Search" placeholder="Search..."><div class="vip-filter-items" id="vip' + metricId + 'FilterItems"></div></div>'}});dynamicSection.innerHTML=dynamicHTML;Object.keys(vocabulary).forEach(metricId=>{const metric=vocabulary[metricId];if(metric.filter==='filter'&&metric.type==='dash pie'&&pies[metricId]&&metricId!=='country'&&metricId!=='currency'){const values=Object.keys(pies[metricId].total).sort();renderVIPFilterItems('vip' + metricId + 'FilterItems','vip' + metricId + 'Search',metricId,values)}});updateVIPFilterBadge()}

function renderVIPFilterItems(containerId,searchId,filterKey,values){const container=document.getElementById(containerId);if(!container)return;const search=document.getElementById(searchId);container.innerHTML='';if(!values||values.length===0){container.innerHTML='<div style="padding:10px;text-align:center;color:#94a3b8;font-size:12px">No options available</div>';return}const currentFilters=filterKey in vipFilters?vipFilters[filterKey]:vipDynamicFilters[filterKey]||[];values.forEach(value=>{if(!value||value==='')return;const item=document.createElement('div');item.className='vip-filter-item';const checkbox=document.createElement('div');checkbox.className='vip-filter-checkbox';if(currentFilters.includes(value)){checkbox.classList.add('checked')}const text=document.createElement('span');text.className='vip-filter-item-text';text.textContent=value;item.appendChild(checkbox);item.appendChild(text);item.onclick=()=>{checkbox.classList.toggle('checked');updateVIPFilter(filterKey,value,checkbox.classList.contains('checked'))};container.appendChild(item)});if(search){search.oninput=()=>{const term=search.value.toLowerCase();container.querySelectorAll('.vip-filter-item').forEach(item=>{const text=item.querySelector('.vip-filter-item-text').textContent.toLowerCase();item.style.display=text.includes(term)?'flex':'none'})}}}

function updateVIPFilter(filterKey,value,checked){if(filterKey in vipFilters){if(checked){if(!vipFilters[filterKey].includes(value))vipFilters[filterKey].push(value)}else{vipFilters[filterKey]=vipFilters[filterKey].filter(v=>v!==value)}}else{if(!vipDynamicFilters[filterKey])vipDynamicFilters[filterKey]=[];if(checked){if(!vipDynamicFilters[filterKey].includes(value))vipDynamicFilters[filterKey].push(value)}else{vipDynamicFilters[filterKey]=vipDynamicFilters[filterKey].filter(v=>v!==value)}}updateVIPFilterBadge();updateActiveFiltersDisplay();applyManagerFilter()}

function updateActiveFiltersDisplay(){const allFilters={...vipFilters,...vipDynamicFilters};const container=document.getElementById('vipActiveFilters');const list=document.getElementById('vipActiveFiltersList');if(!container||!list)return;const filterLabels={vipType:'VIP Type',manager:'Manager',trafficType:'Traffic Type',country:'Country',currency:'Currency'};const vocabulary=vipData?.vocabulary||{};let html='';let hasFilters=false;Object.keys(allFilters).forEach(key=>{const values=allFilters[key];if(values&&values.length>0){hasFilters=true;const label=filterLabels[key]||vocabulary[key]?.name||key;values.forEach(val=>{html+='<div class="vip-filter-tag"><span class="vip-filter-tag-label">' + label + ':</span> ' + val + '<span class="vip-filter-tag-remove" onclick="removeFilter(key,val)">√ó</span></div>'})}});if(hasFilters){list.innerHTML=html;container.classList.add('visible')}else{container.classList.remove('visible')}}

function removeFilter(filterKey,value){if(filterKey==='vipType'){const checkbox=value==='VIP'?document.getElementById('vipTypeVIP'):document.getElementById('vipTypeSilent');if(checkbox)checkbox.classList.remove('checked')}else{const checkboxes=document.querySelectorAll('.vip-filter-checkbox');checkboxes.forEach(cb=>{const item=cb.parentElement;const text=item.querySelector('.vip-filter-item-text');if(text&&text.textContent===value){cb.classList.remove('checked')}})}updateVIPFilter(filterKey,value,false)}

function updateVIPFilterBadge(){const allFilters={...vipFilters,...vipDynamicFilters};let count=0;Object.values(allFilters).forEach(arr=>{if(arr&&arr.length>0)count+=arr.length});const badge=document.getElementById('vip-filter-badge');if(badge){if(count>0){badge.textContent=count;badge.style.display='inline-block'}else{badge.style.display='none'}}}

function clearAllVIPFilters(){vipFilters={manager:[],trafficType:[],country:[],currency:[],vipType:[]};vipDynamicFilters={};currentManager=null;document.getElementById('vipManagerDropdown').value='';updateManagerUI();document.querySelectorAll('.vip-filter-checkbox').forEach(cb=>cb.classList.remove('checked'));updateVIPFilterBadge();updateActiveFiltersDisplay();applyManagerFilter();showToast('üîÑ Filters cleared')}
function renderVIPDashboard(){console.log('Rendering VIP Dashboard...');const container=document.getElementById('vip-content');if(!vipData){container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚è≥</div><div style="font-size:18px;font-weight:600">Loading VIP Data...</div></div>';return}if(vipData.error){container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600;margin-bottom:10px">Dashboard Unavailable</div><div style="font-size:14px;max-width:600px;margin:0 auto">'+vipData.error+'</div></div>';return}if(!vipData.metrics){container.innerHTML='<div style="padding:40px;text-align:center;color:#64748b"><div style="font-size:48px;margin-bottom:20px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:600">No Metrics Available</div></div>';return}const metrics=vipData.metrics;const depId=getMetricIdForPeriod('deposit_sum',currentPeriod);const cashId=getMetricIdForPeriod('cashout_sum',currentPeriod);const depM=metrics.sums[depId];const cashM=metrics.sums[cashId];function gv(m,t){if(!m)return 0;return(t==='total'?m.total:t==='vip'?m.vip:m.silentVip)||0}function fc(v){return'‚Ç¨'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}let dep=gv(depM,currentVIPTab);let cash=gv(cashM,currentVIPTab);if(currentPeriod!=='lifetime')cash=Math.abs(cash);const inout=dep-cash;const tc=metrics.total.count;
let mgrCounts={};if(vipAllPlayers){const allP=[...(vipAllPlayers.vip||[]),...(vipAllPlayers.silentVip||[])];allP.forEach(p=>{const mgr=getPlayerManager(p)||'Unassigned';mgrCounts[mgr]=(mgrCounts[mgr]||0)+1})}
const mgrEntries=Object.entries(mgrCounts).sort((a,b)=>b[1]-a[1]);
let h='';
// Hero bar
h+='<div class="dash-hero2">';
h+='<div class="dash-hero2-left"><span class="dash-hero2-num">'+tc+'</span><span class="dash-hero2-lbl">Players</span></div>';
h+='<div class="dash-hero2-sep"></div>';
h+='<div class="dash-hero2-inout"><span class="dash-hero2-inout-lbl">INOUT</span><span class="dash-hero2-inout-val" style="color:'+(inout>=0?'#34d399':'#f87171')+'">'+(inout>=0?'+':'-')+fc(inout)+'</span></div>';
h+='<div class="dash-hero2-sep"></div>';
h+='<div class="dash-hero2-mgrs">';
mgrEntries.forEach(function(e){h+='<span class="dash-hero2-mgr"><strong>'+e[1]+'</strong> '+e[0]+'</span>'});
h+='</div></div>';
// ‚ïê‚ïê‚ïê SMART CARDS based on active tab level ‚ïê‚ïê‚ïê
var groups=window.dashboardGroups||[];
var hasTG=Object.keys(totalGroups).length>0;
var activeTab=window.currentDashboardTab||'';
h+='<div id="dashLevelCards"></div>';
// Quick stats (only for individual type)
h+='<div class="dash-stats" id="dashQuickStats"></div>';
// Pies
h+='<div class="dash-section" style="margin-top:20px"><div class="dash-section-title">üç© Distribution</div><div class="dash-pies" id="dashPies"></div></div>';
container.innerHTML=h;
renderDashLevelCards();
renderDashQuickStats();
renderDashPies()}

function getGroupInout(groupId){
  var td=dynamicTabsData[groupId];
  if(!td||!td.metrics||!td.metrics.sums)return 0;
  var sums=td.metrics.sums;
  var depId=getMetricIdForPeriod('deposit_sum',currentPeriod);
  var cashId=getMetricIdForPeriod('cashout_sum',currentPeriod);
  var dep=sums[depId]?sums[depId].total||0:0;
  var cash=sums[cashId]?sums[cashId].total||0:0;
  if(currentPeriod!=='lifetime')cash=Math.abs(cash);
  return dep-cash;
}
function fmtInout(v){var sign=v>=0?'+':'-';var color=v>=0?'#10b981':'#ef4444';return'<span style="color:'+color+';font-weight:700">'+sign+'‚Ç¨'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})+'</span>'}

function renderDashLevelCards(){
  var el=document.getElementById('dashLevelCards');
  if(!el)return;
  var groups=window.dashboardGroups||[];
  var hasTG=Object.keys(totalGroups).length>0;
  var activeTab=window.currentDashboardTab||'';
  var h='';
  var tgColors={'PRE-VIP':'#3b82f6','VIP':'#f59e0b'};
  var defaultColors=['#667eea','#8b5cf6','#06b6d4','#ec4899','#f97316','#10b981'];

  function getColor(name,idx){ return tgColors[name.toUpperCase()]||defaultColors[idx%defaultColors.length]; }

  if(activeTab==='__DASH_TOTAL__'&&hasTG){
    // ‚ïê‚ïê TOTAL VIEW ‚ïê‚ïê
    // Build TG info array
    var tgList=[];
    Object.keys(totalGroups).sort().forEach(function(grpName,gi){
      var subTypes=totalGroups[grpName];
      var items=[];var grpCount=0;var grpInout=0;
      groups.forEach(function(g){
        if(subTypes.indexOf(g.displayName)!==-1||subTypes.indexOf(g.id)!==-1){
          var td=dynamicTabsData[g.id];
          var cnt=(td&&td.playerCounts)?td.playerCounts.total:0;
          var io=getGroupInout(g.id);
          grpCount+=cnt; grpInout+=io;
          items.push({name:g.displayName,count:cnt,inout:io,id:g.id});
        }
      });
      tgList.push({name:grpName,count:grpCount,inout:grpInout,items:items,color:getColor(grpName,gi)});
    });

    // Layout: pair TGs with ‚â§2 types into rows of 2, others get full row
    var rows=[];var buffer=null;
    tgList.forEach(function(tg){
      if(tg.items.length<=2){
        if(buffer){rows.push([buffer,tg]);buffer=null}
        else{buffer=tg}
      } else {
        if(buffer){rows.push([buffer]);buffer=null}
        rows.push([tg]);
      }
    });
    if(buffer)rows.push([buffer]);

    rows.forEach(function(row){
      var isFull=row.length===1;
      h+='<div style="display:flex;gap:20px;margin-bottom:20px'+(isFull?'':';align-items:stretch')+'">';
      row.forEach(function(tg){
        var w=isFull&&row[0].items.length<=2?'50%':'';
        h+='<div style="flex:1;'+(w?'max-width:'+w+';':'')+'min-width:0">';
        // ‚îÄ‚îÄ TG Header Card ‚îÄ‚îÄ
        h+='<div onclick="switchToDashTab(\'__DASH_TG__:'+tg.name+'\')" style="background:linear-gradient(135deg,'+tg.color+'08,'+tg.color+'15);border:2px solid '+tg.color+'30;border-radius:20px;padding:28px 32px;cursor:pointer;transition:all 0.3s;margin-bottom:14px" onmouseover="this.style.transform=\'translateY(-4px)\';this.style.boxShadow=\'0 12px 32px '+tg.color+'20\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">';
        h+='<div style="display:flex;justify-content:space-between;align-items:center">';
        h+='<div><div style="font-size:12px;font-weight:800;color:'+tg.color+';text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;opacity:0.7">Type Total</div>';
        h+='<div style="font-size:22px;font-weight:900;color:#1e293b">'+tg.name+'</div></div>';
        h+='<div style="text-align:right"><div style="font-size:42px;font-weight:900;color:'+tg.color+';line-height:1">'+tg.count+'</div>';
        h+='<div style="font-size:13px;margin-top:4px">'+fmtInout(tg.inout)+'</div></div>';
        h+='</div></div>';
        // ‚îÄ‚îÄ Type sub-cards ‚îÄ‚îÄ
        h+='<div style="display:grid;grid-template-columns:repeat('+Math.min(tg.items.length,3)+',1fr);gap:12px">';
        tg.items.forEach(function(item){
          h+='<div onclick="event.stopPropagation();switchToDashTab(\''+item.id+'\')" style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:20px 22px;cursor:pointer;transition:all 0.25s;border-top:3px solid '+tg.color+'40" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 6px 20px rgba(0,0,0,0.06)\';this.style.borderTopColor=\''+tg.color+'\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\';this.style.borderTopColor=\''+tg.color+'40\'">';
          h+='<div style="display:flex;justify-content:space-between;align-items:center">';
          h+='<div><div style="font-size:14px;font-weight:700;color:#334155">'+item.name+'</div>';
          h+='<div style="font-size:12px;color:#94a3b8;margin-top:6px">INOUT '+fmtInout(item.inout)+'</div></div>';
          h+='<div style="font-size:28px;font-weight:800;color:'+tg.color+'">'+item.count+'</div>';
          h+='</div></div>';
        });
        h+='</div></div>';
      });
      h+='</div>';
    });

  } else if(activeTab.indexOf('__DASH_TG__:')===0 && hasTG){
    // ‚ïê‚ïê TYPE-TOTAL VIEW: show sub-type cards ‚ïê‚ïê
    var grpName=activeTab.replace('__DASH_TG__:','');
    var subTypes=totalGroups[grpName]||[];
    var color=getColor(grpName,0);
    var matchItems=[];
    groups.forEach(function(g){
      if(subTypes.indexOf(g.displayName)!==-1||subTypes.indexOf(g.id)!==-1){
        var td=dynamicTabsData[g.id];
        var cnt=(td&&td.playerCounts)?td.playerCounts.total:0;
        var io=getGroupInout(g.id);
        matchItems.push({name:g.displayName,count:cnt,inout:io,id:g.id});
      }
    });
    h+='<div style="display:grid;grid-template-columns:repeat('+Math.min(matchItems.length,3)+',1fr);gap:20px;margin-bottom:28px">';
    matchItems.forEach(function(item){
      h+='<div onclick="switchToDashTab(\''+item.id+'\')" style="background:linear-gradient(135deg,'+color+'06,'+color+'12);border:2px solid '+color+'25;border-radius:20px;padding:28px 32px;cursor:pointer;transition:all 0.3s" onmouseover="this.style.transform=\'translateY(-4px)\';this.style.boxShadow=\'0 12px 32px '+color+'20\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center">';
      h+='<div><div style="font-size:18px;font-weight:800;color:#1e293b">'+item.name+'</div>';
      h+='<div style="font-size:13px;color:#94a3b8;margin-top:8px">INOUT '+fmtInout(item.inout)+'</div></div>';
      h+='<div style="font-size:40px;font-weight:900;color:'+color+'">'+item.count+'</div>';
      h+='</div></div>';
    });
    h+='</div>';
  }

  el.innerHTML=h;
}
function switchToDashTab(groupId){
  var container=document.getElementById('dashTypeTabs');
  if(!container)return;
  var btns=container.querySelectorAll('.dash-type-tab');
  btns.forEach(function(btn){
    if(btn.dataset.dashTab===groupId) btn.click();
  });
}
function renderTotalPies(){
  var container=document.getElementById('dashTotalPies');
  if(!container)return;
  var groups=window.dashboardGroups||[];
  // Aggregate pie data across all tabs
  var aggregated={};
  groups.forEach(function(g){
    var td=dynamicTabsData[g.id];
    if(!td||!td.metrics||!td.metrics.pies)return;
    var vocab=td.vocabulary||{};
    Object.keys(vocab).forEach(function(id){
      if(vocab[id].type!=='dash pie')return;
      var pd=td.metrics.pies[id];
      if(!pd)return;
      var dist=pd.total||{};
      if(!aggregated[id])aggregated[id]={name:vocab[id].name||id,data:{}};
      Object.keys(dist).forEach(function(k){
        aggregated[id].data[k]=(aggregated[id].data[k]||0)+(dist[k]||0);
      });
    });
  });
  // If no aggregated data from dynamicTabsData, use current vipData
  if(Object.keys(aggregated).length===0&&vipData&&vipData.metrics&&vipData.metrics.pies){
    var vocab=vipData.vocabulary||{};
    Object.keys(vocab).forEach(function(id){
      if(vocab[id].type!=='dash pie')return;
      var pd=vipData.metrics.pies[id];
      if(!pd)return;
      var dist=pd.total||{};
      if(Object.keys(dist).length>0){aggregated[id]={name:vocab[id].name||id,data:dist}}
    });
  }
  var pieKeys=Object.keys(aggregated);
  if(pieKeys.length===0){container.innerHTML='';return}
  var h='<div class="dash-total-pies-title">üåç Total Distribution (all tabs)</div><div class="dash-pies">';
  pieKeys.forEach(function(id){
    var m=aggregated[id];
    var canvasId='tpie_'+id.replace(/[^a-z0-9]/gi,'_');
    h+='<div class="dash-pie-card"><div class="dash-pie-title">'+m.name+'</div><div class="dash-pie-canvas"><canvas id="'+canvasId+'"></canvas></div><div class="dash-pie-legend" id="'+canvasId+'_legend"></div></div>';
  });
  h+='</div>';
  container.innerHTML=h;
  setTimeout(function(){
    pieKeys.forEach(function(id){
      var canvasId='tpie_'+id.replace(/[^a-z0-9]/gi,'_');
      renderDashPieChart(canvasId,aggregated[id].data);
    });
  },150);
}
function renderDashQuickStats(){if(!vipData||!vipData.metrics)return;var activeTab=window.currentDashboardTab||'';var isAggregate=activeTab==='__DASH_TOTAL__'||activeTab.indexOf('__DASH_TG__:')===0;const sums=vipData.metrics.sums;const vocabulary=vipData.vocabulary||{};const grid=document.getElementById('dashQuickStats');if(!grid)return;if(isAggregate){grid.innerHTML='';return}const coreOrder=['deposit_sum','cashout_sum','deposit_count','cashout_count'];const coreIcons=['üí∞','üí∏','üì•','üì§'];const coreColors=['#10b981','#ef4444','#667eea','#f59e0b'];const extraIcons=['üìä','üìà','üíé','üéØ','üî¢','‚≠ê','üèÜ','üíµ','üé≤','üìâ'];const extraColors=['#8b5cf6','#06b6d4','#ec4899','#14b8a6','#f97316','#6366f1','#d946ef','#0ea5e9','#84cc16','#f43f5e'];let h='';
// Core metrics first
coreOrder.forEach((key,i)=>{const id=getMetricIdForPeriod(key,currentPeriod);const m=sums[id];if(!m)return;let v=0;if(currentVIPTab==='total')v=m.total||0;else if(currentVIPTab==='vip')v=m.vip||0;else v=m.silentVip||0;if(key==='cashout_sum'&&currentPeriod!=='lifetime')v=Math.abs(v);const fmt=key.includes('sum')?'‚Ç¨'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0}):Math.round(v).toLocaleString();const mType=key.includes('sum')?'currency':'number';const maxV=Math.max(Math.abs(m.total||0),Math.abs(m.vip||0),Math.abs(m.silentVip||0),1);const pct=Math.min(100,Math.abs(v)/maxV*100);h+='<div class="dash-stat" data-metric-id="'+id+'" data-metric-name="'+(m.name||key)+'" data-metric-type="'+mType+'" onclick="openMetricModalFromCard(this)"><div class="dash-stat-icon">'+coreIcons[i]+'</div><div class="dash-stat-val">'+fmt+'</div><div class="dash-stat-name">'+(m.name||key)+'</div><div class="dash-stat-bar"><div class="dash-stat-bar-fill" style="width:'+pct+'%;background:'+coreColors[i]+'"></div></div></div>'});
// Additional vocabulary metrics
var coreIds=coreOrder.map(function(k){return getMetricIdForPeriod(k,currentPeriod)});var extraIdx=0;Object.keys(sums).forEach(function(id){if(coreIds.indexOf(id)!==-1)return;var m=sums[id];if(!m)return;var v=0;if(currentVIPTab==='total')v=m.total||0;else if(currentVIPTab==='vip')v=m.vip||0;else v=m.silentVip||0;var mType=(m.type==='dash sum'||id.includes('sum'))?'currency':'number';var fmt=mType==='currency'?'‚Ç¨'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0}):Math.round(v).toLocaleString();var maxV=Math.max(Math.abs(m.total||0),Math.abs(m.vip||0),Math.abs(m.silentVip||0),1);var pct=Math.min(100,Math.abs(v)/maxV*100);var icon=extraIcons[extraIdx%extraIcons.length];var color=extraColors[extraIdx%extraColors.length];extraIdx++;h+='<div class="dash-stat" data-metric-id="'+id+'" data-metric-name="'+(m.name||id)+'" data-metric-type="'+mType+'" onclick="openMetricModalFromCard(this)"><div class="dash-stat-icon">'+icon+'</div><div class="dash-stat-val">'+fmt+'</div><div class="dash-stat-name">'+(m.name||id)+'</div><div class="dash-stat-bar"><div class="dash-stat-bar-fill" style="width:'+pct+'%;background:'+color+'"></div></div></div>'});grid.innerHTML=h}
function renderDashMetrics(){}
function renderDashPies(){if(!vipData||!vipData.metrics||!vipData.metrics.pies)return;const pies=vipData.metrics.pies;const vocabulary=vipData.vocabulary||{};const container=document.getElementById('dashPies');if(!container)return;const pieMetrics=[];Object.keys(vocabulary).forEach(id=>{if(vocabulary[id].type==='dash pie'&&pies[id])pieMetrics.push({id,name:vocabulary[id].name||id})});if(pieMetrics.length===0){container.innerHTML='<div style="padding:20px;text-align:center;color:#94a3b8">No distribution data</div>';return}let h='';pieMetrics.forEach(m=>{const canvasId='dpie_'+m.id.replace(/[^a-z0-9]/gi,'_');h+='<div class="dash-pie-card" data-metric-id="'+m.id+'" data-metric-name="'+m.name+'" onclick="openPieChartModal(this.dataset.metricId,this.dataset.metricName)"><div class="dash-pie-title">'+m.name+'</div><div class="dash-pie-canvas"><canvas id="'+canvasId+'"></canvas></div><div class="dash-pie-legend" id="'+canvasId+'_legend"></div></div>'});container.innerHTML=h;setTimeout(()=>{pieMetrics.forEach(m=>{const pd=pies[m.id];if(!pd)return;let dist=currentVIPTab==='total'?pd.total:currentVIPTab==='vip'?pd.vip:pd.silentVip;if(!dist||Object.keys(dist).length===0)return;const canvasId='dpie_'+m.id.replace(/[^a-z0-9]/gi,'_');renderDashPieChart(canvasId,dist)})},100)}
function renderDashPieChart(canvasId,dist){const canvas=document.getElementById(canvasId);if(!canvas||typeof Chart==='undefined')return;const labels=Object.keys(dist).sort((a,b)=>(dist[b]||0)-(dist[a]||0));const values=labels.map(l=>dist[l]||0);const total=values.reduce((a,b)=>a+b,0);const palette=['#667eea','#a855f7','#f59e0b','#ef4444','#10b981','#06b6d4','#ec4899','#8b5cf6','#f97316','#14b8a6','#6366f1','#d946ef'];const legendEl=document.getElementById(canvasId+'_legend');if(legendEl){let lh='';labels.slice(0,8).forEach((l,i)=>{const pct=total>0?((values[i]/total)*100).toFixed(0):'0';lh+='<span class="dash-pie-legend-item"><span class="dash-pie-legend-dot" style="background:'+palette[i%palette.length]+'"></span>'+l+': '+values[i]+' ('+pct+'%)</span>'});legendEl.innerHTML=lh}new Chart(canvas,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:palette.slice(0,labels.length),borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:false},datalabels:{display:false}}}})}
function renderVIPMetricsGrid(){}
function renderVIPPieChart(canvasId,distribution,metricName){if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}const canvas=document.getElementById(canvasId);if(!canvas){console.error('Canvas not found:',canvasId);return}const ctx=canvas.getContext('2d');if(!ctx)return;function improveLabel(label,metricName){const labelStr=String(label).trim();if(metricName.toLowerCase().includes('gender')){if(labelStr.toLowerCase()==='m'||labelStr.toLowerCase()==='male')return'Male';if(labelStr.toLowerCase()==='f'||labelStr.toLowerCase()==='female')return'Female'}if(labelStr===''||labelStr==='null'||labelStr==='undefined')return'Unknown';return labelStr}const improvedDist={};Object.keys(distribution).forEach(key=>{const improvedKey=improveLabel(key,metricName);improvedDist[improvedKey]=(improvedDist[improvedKey]||0)+distribution[key]});const sortedEntries=Object.entries(improvedDist).sort((a,b)=>b[1]-a[1]);const labels=sortedEntries.map(([k])=>k);const values=sortedEntries.map(([,v])=>v);const colors=['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe','#43e97b','#38f9d7','#fa709a','#fee140','#30cfd0','#330867','#a8edea','#fed6e3','#ff9a9e','#fecfef'];new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:values,backgroundColor:colors.slice(0,labels.length),borderColor:'#fff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,layout:{padding:10},plugins:{legend:{position:'bottom',labels:{padding:10,font:{size:11},generateLabels:function(chart){const data=chart.data;if(data.labels.length&&data.datasets.length){return data.labels.map((label,i)=>{const value=data.datasets[0].data[i];const total=data.datasets[0].data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return{text:label+': '+value+' ('+percentage+'%)',fillStyle:data.datasets[0].backgroundColor[i],hidden:false,index:i}})}}}},tooltip:{callbacks:{label:function(context){const label=context.label||'';const value=context.parsed;const total=context.dataset.data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return' '+label+': '+value+' ('+percentage+'%)'}}}}}})};

// Metric Modal Functions


function openMetricModalFromCard(element) {
  console.log('üîµ openMetricModalFromCard called', element);
  const metricId = element.getAttribute('data-metric-id');
  const metricName = element.getAttribute('data-metric-name');
  const metricType = element.getAttribute('data-metric-type');
  console.log('üîµ Modal data:', {metricId, metricName, metricType});
  openMetricModal(metricId, metricName, metricType);
}

function handlePieClickWrapper(evt) {
  const canvas = evt.target;
  const metricId = canvas.getAttribute('data-metric-id');
  const metricName = canvas.getAttribute('data-metric-name');
  handlePieClick(evt, metricId, metricName);
}

// ============================================
// PERFECT MODAL FUNCTIONS - NO SYNTAX ERRORS
// ============================================

let metricModalSort = {column: null, direction: 'desc'};
let currentModalPlayers = [];
let visibleColumns = {
  name: true,
  email: true,
  link: true,
  vipType: true,
  manager: true,
  country: true,
  filterValue: true,
  deposit_sum_lifetime: true,
  cashout_sum_lifetime: true,
  deposit_count_lifetime: true,
  cashout_count_lifetime: true,
  inout_lifetime: true,
  deposit_sum_1d: true,
  cashout_sum_1d: true,
  deposit_count_1d: true,
  cashout_count_1d: true,
  inout_1d: true,
  deposit_sum_7d: true,
  cashout_sum_7d: true,
  deposit_count_7d: true,
  cashout_count_7d: true,
  inout_7d: true,
  deposit_sum_30d: true,
  cashout_sum_30d: true,
  deposit_count_30d: true,
  cashout_count_30d: true,
  inout_30d: true,
  deposit_sum_90d: true,
  cashout_sum_90d: true,
  deposit_count_90d: true,
  cashout_count_90d: true,
  inout_90d: true,
  value: true
};


function formatMetricValue(value, type) {
  if (type === 'currency') {
    return '‚Ç¨' + (value || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  } else {
    return Math.round(value || 0).toLocaleString();
  }
}

function openMetricModal(metricId, metricName, metricType) {
  console.log('üü¢ openMetricModal called with:', {metricId, metricName, metricType});
  console.log('üü¢ vipAllPlayers:', vipAllPlayers ? 'Loaded ‚úì' : 'NOT loaded ‚úó');
  console.log('üü¢ vipData:', vipData ? 'Loaded ‚úì' : 'NOT loaded ‚úó');
  
  if (!vipAllPlayers) {
    alert('Player data not loaded yet');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var title = document.getElementById('metricModalTitle');
  var body = document.getElementById('metricModalBody');
  
  title.textContent = metricName;
  
  var metricData = vipData.metrics.sums[metricId];
  
  if (!metricData) {
    body.innerHTML = '<div style="padding:40px;text-align:center;color:#64748b">Metric data not available</div>';
    modal.style.display = 'flex';
    return;
  }
  
  var activeFilters = getActiveFilters();
  
  var html = '';
  
  if (activeFilters.length > 0) {
    html += '<div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px 16px;margin-bottom:20px">';
    html += '<div style="font-size:13px;font-weight:600;color:#1e40af;margin-bottom:6px">üîç Applied Filters:</div>';
    html += '<div style="font-size:12px;color:#1e40af">' + activeFilters.join(' ‚Ä¢ ') + '</div>';
    html += '</div>';
  }
  
  html += '<div class="metric-breakdown">';
  html += '<div class="metric-breakdown-card">';
  html += '<div class="metric-breakdown-label">Total</div>';
  html += '<div class="metric-breakdown-value">' + formatMetricValue(metricData.total || 0, metricType) + '</div>';
  html += '<div class="metric-breakdown-subtitle">All Players</div>';
  html += '</div>';
  
  var depId2 = getMetricIdForPeriod('deposit_sum', currentPeriod);
  var cashId2 = getMetricIdForPeriod('cashout_sum', currentPeriod);
  var depM2 = vipData.metrics.sums[depId2];
  var cashM2 = vipData.metrics.sums[cashId2];
  if (depM2) {
    html += '<div class="metric-breakdown-card">';
    html += '<div class="metric-breakdown-label">üí∞ Deposits</div>';
    html += '<div class="metric-breakdown-value">' + formatMetricValue(depM2.total || 0, 'currency') + '</div>';
    html += '<div class="metric-breakdown-subtitle">' + currentPeriod + '</div>';
    html += '</div>';
  }
  if (cashM2) {
    var cashVal = Math.abs(cashM2.total || 0);
    html += '<div class="metric-breakdown-card">';
    html += '<div class="metric-breakdown-label">üí∏ Cashouts</div>';
    html += '<div class="metric-breakdown-value">' + formatMetricValue(cashVal, 'currency') + '</div>';
    html += '<div class="metric-breakdown-subtitle">' + currentPeriod + '</div>';
    html += '</div>';
  }
  html += '</div>';
  
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">';
  html += '<div style="position:relative">';
  html += '<button onclick="toggleColumnSelector(event)" style="background:#667eea;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üëÅÔ∏è Columns</button>';
  html += '<div id="columnSelector" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:200px;z-index:1000"></div>';
  html += '</div>';
  html += '<button onclick="createSheetFromModal()" style="background:#10b981;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üìä Create Sheet</button>';
  html += '</div>';
  
  html += '<h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:24px 0 16px 0">üìã Players Breakdown</h3>';
  html += '<div class="metric-table-container" style="overflow-x:auto;max-height:500px">';
  html += '<table class="metric-table" id="modalTable" style="width:100%;min-width:1800px">';
  html += '<thead style="position:sticky;top:0;background:#fff;z-index:10"><tr id="modalTableHeader"></tr></thead>';
  html += '<tbody id="metricTableBody"></tbody>';
  html += '</table>';
  html += '</div>';
  
  body.innerHTML = html;
  
  modal.dataset.metricId = metricId;
  modal.dataset.metricName = metricName;
  modal.dataset.metricType = metricType;
  
  renderMetricTable(metricId, metricType);
  
  modal.style.display = 'flex';
}

function renderMetricTable(metricId, metricType) {
  var tbody = document.getElementById('metricTableBody');
  var thead = document.getElementById('modalTableHeader');
  if (!tbody || !thead) return;
  
  var periodSuffix = getPeriodSuffix(currentPeriod);
  var vocabulary = vipData.vocabulary || {};
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (vipFilters) {
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filteredVip = filteredVip.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
      filteredSilent = filteredSilent.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
    }
    if (vipFilters.currency && vipFilters.currency.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.currency.includes(p.currency || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.currency.includes(p.currency || ''); });
    }
  }
  
  if (currentVIPTab === 'vip') {
    filteredSilent = [];
  } else if (currentVIPTab === 'silent-vip') {
    filteredVip = [];
  }
  
  var players = [];
  
  filteredVip.forEach(function(player) {
    var value = player[metricId] || 0;
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      value: value,
      rawPlayer: player
    });
  });
  
  filteredSilent.forEach(function(player) {
    var value = player[metricId] || 0;
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'Silent VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      value: value,
      rawPlayer: player
    });
  });
  
  if (metricModalSort.column) {
    players.sort(function(a, b) {
      var col = metricModalSort.column;
      var valA = a[col];
      var valB = b[col];
      
      var numericCols = ['value', 
        'deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime',
        'deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d',
        'deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d',
        'deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d',
        'deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d'
      ];
      
      if (numericCols.includes(col)) {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      } else {
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
      }
      
      if (valA < valB) return metricModalSort.direction === 'asc' ? -1 : 1;
      if (valA > valB) return metricModalSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
  }
  
  currentModalPlayers = players;
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  function getVocabLabel(key) {
    if (vocabulary[key] && vocabulary[key].name) {
      return vocabulary[key].name;
    }
    return null;
  }
  
  var depSumLifetimeLabel = getVocabLabel('lifetime_deposit_sum_total') || 'Deposit Sum (LT)';
  var cashSumLifetimeLabel = getVocabLabel('lifetime_cashout_sum_total') || 'Cashout Sum (LT)';
  var depCountLifetimeLabel = getVocabLabel('lifetime_deposit_count_total') || 'Deposit Count (LT)';
  var cashCountLifetimeLabel = getVocabLabel('lifetime_cashout_count_total') || 'Cashout Count (LT)';
  
  var depSum1dLabel = getVocabLabel('deposit_sum_previous_day_total') || 'Deposit Sum (1d)';
  var cashSum1dLabel = getVocabLabel('cashout_sum_previous_day_total') || 'Cashout Sum (1d)';
  var depCount1dLabel = getVocabLabel('deposit_count_previous_day_total') || 'Deposit Count (1d)';
  var cashCount1dLabel = getVocabLabel('cashout_count_previous_day_total') || 'Cashout Count (1d)';
  
  var depSum7dLabel = getVocabLabel('deposit_sum_last_7_total') || 'Deposit Sum (7d)';
  var cashSum7dLabel = getVocabLabel('cashout_sum_last_7_total') || 'Cashout Sum (7d)';
  var depCount7dLabel = getVocabLabel('deposit_count_last_7_total') || 'Deposit Count (7d)';
  var cashCount7dLabel = getVocabLabel('cashout_count_last_7_total') || 'Cashout Count (7d)';
  
  var depSum30dLabel = getVocabLabel('deposit_sum_last_30_total') || 'Deposit Sum (30d)';
  var cashSum30dLabel = getVocabLabel('cashout_sum_last_30_total') || 'Cashout Sum (30d)';
  var depCount30dLabel = getVocabLabel('deposit_count_last_30_total') || 'Deposit Count (30d)';
  var cashCount30dLabel = getVocabLabel('cashout_count_last_30_total') || 'Cashout Count (30d)';
  
  var depSum90dLabel = getVocabLabel('deposit_sum_last_90_total') || 'Deposit Sum (90d)';
  var cashSum90dLabel = getVocabLabel('cashout_sum_last_90_total') || 'Cashout Sum (90d)';
  var depCount90dLabel = getVocabLabel('deposit_count_last_90_total') || 'Deposit Count (90d)';
  var cashCount90dLabel = getVocabLabel('cashout_count_last_90_total') || 'Cashout Count (90d)';
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    
    {key: 'deposit_sum_lifetime', label: depSumLifetimeLabel, width: '140px'},
    {key: 'cashout_sum_lifetime', label: cashSumLifetimeLabel, width: '140px'},
    {key: 'deposit_count_lifetime', label: depCountLifetimeLabel, width: '140px'},
    {key: 'cashout_count_lifetime', label: cashCountLifetimeLabel, width: '140px'},
    {key: 'inout_lifetime', label: 'INOUT (LT)', width: '140px'},
    
    {key: 'deposit_sum_1d', label: depSum1dLabel, width: '140px'},
    {key: 'cashout_sum_1d', label: cashSum1dLabel, width: '140px'},
    {key: 'deposit_count_1d', label: depCount1dLabel, width: '140px'},
    {key: 'cashout_count_1d', label: cashCount1dLabel, width: '140px'},
    {key: 'inout_1d', label: 'INOUT (1d)', width: '140px'},
    
    {key: 'deposit_sum_7d', label: depSum7dLabel, width: '140px'},
    {key: 'cashout_sum_7d', label: cashSum7dLabel, width: '140px'},
    {key: 'deposit_count_7d', label: depCount7dLabel, width: '140px'},
    {key: 'cashout_count_7d', label: cashCount7dLabel, width: '140px'},
    {key: 'inout_7d', label: 'INOUT (7d)', width: '140px'},
    
    {key: 'deposit_sum_30d', label: depSum30dLabel, width: '140px'},
    {key: 'cashout_sum_30d', label: cashSum30dLabel, width: '140px'},
    {key: 'deposit_count_30d', label: depCount30dLabel, width: '140px'},
    {key: 'cashout_count_30d', label: cashCount30dLabel, width: '140px'},
    {key: 'inout_30d', label: 'INOUT (30d)', width: '140px'},
    
    {key: 'deposit_sum_90d', label: depSum90dLabel, width: '140px'},
    {key: 'cashout_sum_90d', label: cashSum90dLabel, width: '140px'},
    {key: 'deposit_count_90d', label: depCount90dLabel, width: '140px'},
    {key: 'cashout_count_90d', label: cashCount90dLabel, width: '140px'},
    {key: 'inout_90d', label: 'INOUT (90d)', width: '140px'},
    
    {key: 'value', label: 'Value', width: '140px'}
  ];
  
  var headerHtml = '';
  
  columns.forEach(function(col) {
    if (visibleColumns[col.key]) {
      var sortIndicator = metricModalSort.column === col.key ? (metricModalSort.direction === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      var clickHandler = col.key !== 'link' ? 'onclick="sortMetricTable(\'' + col.key + '\')"' : '';
      var cursorStyle = col.key !== 'link' ? 'cursor:pointer;' : '';
      var bgColor = col.key === 'value' ? 'background:#f0fdf4;' : '';
      headerHtml += '<th ' + clickHandler + ' style="min-width:' + col.width + ';' + cursorStyle + bgColor + '">' + col.label + ' ' + sortIndicator + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var totals = {
    deposit_sum_lifetime: 0,
    cashout_sum_lifetime: 0,
    deposit_count_lifetime: 0,
    cashout_count_lifetime: 0,
    inout_lifetime: 0,
    deposit_sum_1d: 0,
    cashout_sum_1d: 0,
    deposit_count_1d: 0,
    cashout_count_1d: 0,
    inout_1d: 0,
    deposit_sum_7d: 0,
    cashout_sum_7d: 0,
    deposit_count_7d: 0,
    cashout_count_7d: 0,
    inout_7d: 0,
    deposit_sum_30d: 0,
    cashout_sum_30d: 0,
    deposit_count_30d: 0,
    cashout_count_30d: 0,
    inout_30d: 0,
    deposit_sum_90d: 0,
    cashout_sum_90d: 0,
    deposit_count_90d: 0,
    cashout_count_90d: 0,
    inout_90d: 0,
    value: 0
  };
  
  var bodyHtml = '';
  players.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = '';
      
      switch(col.key) {
        case 'name':
          cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
          cellStyle = 'font-weight:600';
          break;
        case 'email':
          cellContent = player.email;
          cellStyle = 'font-size:12px;color:#64748b';
          break;
        case 'link':
          if (player.link) {
            cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
          } else {
            cellContent = '‚Äî';
          }
          break;
        case 'vipType':
          var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
          var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
          cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
          break;
        case 'manager':
          cellContent = player.manager;
          break;
        case 'country':
          cellContent = player.country;
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_1d':
        case 'deposit_sum_7d':
        case 'deposit_sum_30d':
        case 'deposit_sum_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_1d':
        case 'cashout_sum_7d':
        case 'cashout_sum_30d':
        case 'cashout_sum_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'deposit_count_lifetime':
        case 'cashout_count_lifetime':
        case 'deposit_count_1d':
        case 'cashout_count_1d':
        case 'deposit_count_7d':
        case 'cashout_count_7d':
        case 'deposit_count_30d':
        case 'cashout_count_30d':
        case 'deposit_count_90d':
        case 'cashout_count_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          cellContent = (player[col.key] || 0).toLocaleString();
          cellStyle = 'text-align:right';
          break;
        case 'inout_lifetime':
        case 'inout_1d':
        case 'inout_7d':
        case 'inout_30d':
        case 'inout_90d':
          totals[col.key] += parseFloat(player[col.key]) || 0;
          var inoutValue = player[col.key] || 0;
          var inoutColor = inoutValue >= 0 ? '#10b981' : '#ef4444';
          cellContent = '‚Ç¨' + Math.abs(inoutValue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right;font-weight:700;color:' + inoutColor + ';background:#f0fdf4';
          break;
        case 'value':
          totals.value += parseFloat(player.value) || 0;
          cellContent = formatMetricValue(player.value, metricType);
          cellStyle = 'text-align:right;font-weight:700;background:#f0fdf4';
          break;
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  });
  
  if (players.length > 0) {
    bodyHtml += '<tr style="background:#f1f5f9;font-weight:700;border-top:2px solid #cbd5e1">';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = 'padding:12px 8px;';
      
      switch(col.key) {
        case 'name':
          cellContent = 'TOTAL';
          cellStyle += 'font-weight:700;color:#1e293b';
          break;
        case 'email':
        case 'link':
        case 'vipType':
        case 'manager':
        case 'country':
          cellContent = '';
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_1d':
        case 'deposit_sum_7d':
        case 'deposit_sum_30d':
        case 'deposit_sum_90d':
          cellContent = '‚Ç¨' + totals[col.key].toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_1d':
        case 'cashout_sum_7d':
        case 'cashout_sum_30d':
        case 'cashout_sum_90d':
          cellContent = '‚Ç¨' + Math.abs(totals[col.key]).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'deposit_count_lifetime':
        case 'cashout_count_lifetime':
        case 'deposit_count_1d':
        case 'cashout_count_1d':
        case 'deposit_count_7d':
        case 'cashout_count_7d':
        case 'deposit_count_30d':
        case 'cashout_count_30d':
        case 'deposit_count_90d':
        case 'cashout_count_90d':
          cellContent = Math.round(totals[col.key]).toLocaleString();
          cellStyle += 'text-align:right;color:#0f766e';
          break;
        case 'inout_lifetime':
        case 'inout_1d':
        case 'inout_7d':
        case 'inout_30d':
        case 'inout_90d':
          var totalInout = totals[col.key];
          var inoutColor = totalInout >= 0 ? '#10b981' : '#ef4444';
          cellContent = '‚Ç¨' + Math.abs(totalInout).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle += 'text-align:right;font-weight:700;background:#e0f2fe;color:' + inoutColor;
          break;
        case 'value':
          cellContent = formatMetricValue(totals.value, metricType);
          cellStyle += 'text-align:right;background:#e0f2fe;color:#075985';
          break;
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  }
  
  if (players.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key]; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players match current filters</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function getPeriodSuffix(period) {
  var map = {
    'lifetime': 'lifetime',
    '30': 'last_30_total',
    '30d': 'last_30_total',
    '90': 'last_90_total',
    '90d': 'last_90_total',
    '180': 'last_180_total',
    '180d': 'last_180_total',
    '365': 'last_365_total',
    '365d': 'last_365_total',
    '1': 'previous_day_total',
    '1d': 'previous_day_total',
    '7': 'last_7_total',
    '7d': 'last_7_total',
    '14': 'last_14_total',
    '14d': 'last_14_total'
  };
  return map[period] || 'lifetime';
}

function getPeriodLabel(period) {
  var map = {
    'lifetime': 'LT',
    '30d': '30d',
    '90d': '90d',
    '180d': '180d',
    '365d': '365d',
    '1d': '1d',
    '7d': '7d',
    '14d': '14d'
  };
  return map[period] || 'LT';
}

function toggleColumnSelector(event) {
  event.stopPropagation();
  var selector = document.getElementById('columnSelector');
  
  if (selector.style.display === 'none') {
    var html = '<div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:12px">Select Columns</div>';
    
    var columnGroups = [
      {title: 'Basic Info', columns: ['name', 'email', 'link', 'vipType', 'manager', 'country']},
      {title: 'Lifetime Metrics', columns: ['deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime']},
      {title: '1 Day Metrics', columns: ['deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d']},
      {title: '7 Days Metrics', columns: ['deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d']},
      {title: '30 Days Metrics', columns: ['deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d']},
      {title: '90 Days Metrics', columns: ['deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d']},
      {title: 'Current Value', columns: ['value']}
    ];
    
    var labels = {
      name: 'Player Name',
      email: 'Email',
      link: 'Link',
      vipType: 'Type',
      manager: 'Manager',
      country: 'Country',
      deposit_sum_lifetime: 'Deposit Sum (LT)',
      cashout_sum_lifetime: 'Cashout Sum (LT)',
      deposit_count_lifetime: 'Deposit Count (LT)',
      cashout_count_lifetime: 'Cashout Count (LT)',
      inout_lifetime: 'INOUT (LT)',
      deposit_sum_1d: 'Deposit Sum (1d)',
      cashout_sum_1d: 'Cashout Sum (1d)',
      deposit_count_1d: 'Deposit Count (1d)',
      cashout_count_1d: 'Cashout Count (1d)',
      inout_1d: 'INOUT (1d)',
      deposit_sum_7d: 'Deposit Sum (7d)',
      cashout_sum_7d: 'Cashout Sum (7d)',
      deposit_count_7d: 'Deposit Count (7d)',
      cashout_count_7d: 'Cashout Count (7d)',
      inout_7d: 'INOUT (7d)',
      deposit_sum_30d: 'Deposit Sum (30d)',
      cashout_sum_30d: 'Cashout Sum (30d)',
      deposit_count_30d: 'Deposit Count (30d)',
      cashout_count_30d: 'Cashout Count (30d)',
      inout_30d: 'INOUT (30d)',
      deposit_sum_90d: 'Deposit Sum (90d)',
      cashout_sum_90d: 'Cashout Sum (90d)',
      deposit_count_90d: 'Deposit Count (90d)',
      cashout_count_90d: 'Cashout Count (90d)',
      inout_90d: 'INOUT (90d)',
      value: 'Metric Value'
    };
    
    columnGroups.forEach(function(group) {
      html += '<div style="margin-bottom:16px">';
      html += '<div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">' + group.title + '</div>';
      group.columns.forEach(function(col) {
        var checked = visibleColumns[col] ? 'checked' : '';
        html += '<label style="display:block;margin:4px 0;cursor:pointer;font-size:13px">';
        html += '<input type="checkbox" ' + checked + ' onchange="toggleColumn(\'' + col + '\')" style="margin-right:6px">';
        html += labels[col];
        html += '</label>';
      });
      html += '</div>';
    });
    
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0">';
    html += '<button onclick="selectAllColumns()" style="background:#667eea;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:8px">Select All</button>';
    html += '<button onclick="deselectAllColumns()" style="background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px">Deselect All</button>';
    html += '</div>';
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    
    setTimeout(function() {
      document.addEventListener('click', closeColumnSelector);
    }, 100);
  } else {
    selector.style.display = 'none';
  }
}

function closeColumnSelector(event) {
  var selector = document.getElementById('columnSelector');
  if (selector && !selector.contains(event.target)) {
    selector.style.display = 'none';
    document.removeEventListener('click', closeColumnSelector);
  }
}

function toggleColumn(columnKey) {
  visibleColumns[columnKey] = !visibleColumns[columnKey];
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
}

function selectAllColumns() {
  Object.keys(visibleColumns).forEach(function(key) { 
    visibleColumns[key] = true; 
  });
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
  toggleColumnSelector(new Event('click'));
}

function deselectAllColumns() {
  Object.keys(visibleColumns).forEach(function(key) {
    if (['name', 'email', 'link'].includes(key)) {
      visibleColumns[key] = true;
    } else {
      visibleColumns[key] = false;
    }
  });
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
  toggleColumnSelector(new Event('click'));
}

function getActiveFilters() {
  var filters = [];
  
  if (currentManager) {
    filters.push('Manager: ' + currentManager);
  }
  
  if (vipFilters) {
    if (vipFilters.manager && vipFilters.manager.length > 0) {
      filters.push('Manager: ' + vipFilters.manager.join(', '));
    }
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filters.push('Traffic: ' + vipFilters.trafficType.join(', '));
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filters.push('Country: ' + vipFilters.country.join(', '));
    }
    if (vipFilters.currency && vipFilters.currency.length > 0) {
      filters.push('Currency: ' + vipFilters.currency.join(', '));
    }
  }
  
  if (currentPeriod && currentPeriod !== 'lifetime') {
    filters.push('Period: ' + currentPeriod);
  }
  
  if (currentVIPTab && currentVIPTab !== 'total') {
    filters.push('Tab: ' + (currentVIPTab === 'vip' ? 'VIP Only' : 'Silent VIP Only'));
  }
  
  return filters;
}

function sortMetricTable(column) {
  if (metricModalSort.column === column) {
    metricModalSort.direction = metricModalSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    metricModalSort.column = column;
    metricModalSort.direction = 'desc';
  }
  
  var modal = document.getElementById('metricModal');
  var metricId = modal.dataset.metricId;
  var metricType = modal.dataset.metricType;
  
  renderMetricTable(metricId, metricType);
}

function createSheetFromModal() {
  if (!currentModalPlayers || currentModalPlayers.length === 0) {
    alert('No data to export');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var metricName = modal.dataset.metricName || 'Metric Export';
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Creating...';
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  var exportData = [];
  
  var header = [];
  if (visibleColumns.name) header.push('Player');
  if (visibleColumns.email) header.push('Email');
  if (visibleColumns.link) header.push('Link');
  if (visibleColumns.vipType) header.push('Type');
  if (visibleColumns.manager) header.push('Manager');
  if (visibleColumns.country) header.push('Country');
  if (visibleColumns.deposit_sum_lifetime) header.push('Deposit Sum (LT)');
  if (visibleColumns.cashout_sum_lifetime) header.push('Cashout Sum (LT)');
  if (visibleColumns.deposit_count_lifetime) header.push('Deposit Count (LT)');
  if (visibleColumns.cashout_count_lifetime) header.push('Cashout Count (LT)');
  if (visibleColumns.deposit_sum_period) header.push('Deposit Sum (' + periodLabel + ')');
  if (visibleColumns.cashout_sum_period) header.push('Cashout Sum (' + periodLabel + ')');
  if (visibleColumns.deposit_count_period) header.push('Deposit Count (' + periodLabel + ')');
  if (visibleColumns.cashout_count_period) header.push('Cashout Count (' + periodLabel + ')');
  if (visibleColumns.value) header.push(metricName);
  
  exportData.push(header);
  
  currentModalPlayers.forEach(function(player) {
    var row = [];
    if (visibleColumns.name) row.push(player.name.trim() || 'Unknown');
    if (visibleColumns.email) row.push(player.email);
    if (visibleColumns.link) row.push(player.link || '');
    if (visibleColumns.vipType) row.push(player.vipType);
    if (visibleColumns.manager) row.push(player.manager);
    if (visibleColumns.country) row.push(player.country);
    if (visibleColumns.deposit_sum_lifetime) row.push(player.deposit_sum_lifetime || 0);
    if (visibleColumns.cashout_sum_lifetime) row.push(Math.abs(player.cashout_sum_lifetime || 0));
    if (visibleColumns.deposit_count_lifetime) row.push(player.deposit_count_lifetime || 0);
    if (visibleColumns.cashout_count_lifetime) row.push(player.cashout_count_lifetime || 0);
    if (visibleColumns.deposit_sum_period) row.push(player.deposit_sum_period || 0);
    if (visibleColumns.cashout_sum_period) row.push(Math.abs(player.cashout_sum_period || 0));
    if (visibleColumns.deposit_count_period) row.push(player.deposit_count_period || 0);
    if (visibleColumns.cashout_count_period) row.push(player.cashout_count_period || 0);
    if (visibleColumns.value) row.push(player.value);
    
    exportData.push(row);
  });
  
  google.script.run
    .withSuccessHandler(function(url) {
      btn.disabled = false;
      btn.textContent = '‚úÖ Sheet Created!';
      
      if (url) {
        window.open(url, '_blank');
      }
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .withFailureHandler(function(error) {
      btn.disabled = false;
      btn.textContent = '‚ùå Error';
      alert('Failed to create sheet: ' + error.message);
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .createExportSheet(metricName, exportData);
}

function openPieModal(metricId, metricName, segmentName) {
  console.log('Opening pie modal:', metricId, metricName, segmentName);
  
  if (!vipAllPlayers) {
    alert('Player data not loaded yet');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var title = document.getElementById('metricModalTitle');
  var body = document.getElementById('metricModalBody');
  
  title.textContent = metricName + ' - ' + segmentName;
  
  var activeFilters = getActiveFilters();
  
  var html = '';
  
  if (activeFilters.length > 0) {
    html += '<div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px 16px;margin-bottom:20px">';
    html += '<div style="font-size:13px;font-weight:600;color:#1e40af;margin-bottom:6px">üîç Applied Filters:</div>';
    html += '<div style="font-size:12px;color:#1e40af">' + activeFilters.join(' ‚Ä¢ ') + '</div>';
    html += '</div>';
  }
  
  html += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:20px">';
  html += '<h3 style="font-size:16px;font-weight:700;color:#1e293b;margin:0 0 8px 0">Segment: ' + segmentName + '</h3>';
  html += '<div style="font-size:14px;color:#64748b">Showing players in this segment</div>';
  html += '</div>';
  
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0">';
  html += '<div style="position:relative">';
  html += '<button onclick="toggleColumnSelector(event)" style="background:#667eea;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üëÅÔ∏è Columns</button>';
  html += '<div id="columnSelector" style="display:none;position:absolute;top:45px;left:0;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:200px;z-index:1000"></div>';
  html += '</div>';
  html += '<button onclick="createSheetFromPieModal()" style="background:#10b981;padding:10px 20px;border-radius:6px;color:#fff;font-weight:600;border:none;cursor:pointer;font-size:14px">üìä Create Sheet</button>';
  html += '</div>';
  
  html += '<h3 style="font-size:18px;font-weight:700;color:#1e293b;margin:24px 0 16px 0">üìã Players in this segment</h3>';
  html += '<div class="metric-table-container" style="overflow-x:auto;max-height:500px">';
  html += '<table class="metric-table" id="modalTable" style="width:100%;min-width:1800px">';
  html += '<thead style="position:sticky;top:0;background:#fff;z-index:10"><tr id="modalTableHeader"></tr></thead>';
  html += '<tbody id="metricTableBody"></tbody>';
  html += '</table>';
  html += '</div>';
  
  body.innerHTML = html;
  
  modal.dataset.metricId = metricId;
  modal.dataset.metricName = metricName + ' - ' + segmentName;
  modal.dataset.segmentName = segmentName;
  modal.dataset.isPie = 'true';
  
  renderPieSegmentPlayers(metricId, segmentName);
  
  modal.style.display = 'flex';
}

function renderPieSegmentPlayers(metricId, segmentName) {
  var tbody = document.getElementById('metricTableBody');
  var thead = document.getElementById('modalTableHeader');
  if (!tbody || !thead) return;
  
  var periodSuffix = getPeriodSuffix(currentPeriod);
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (currentVIPTab === 'vip') {
    filteredSilent = [];
  } else if (currentVIPTab === 'silent-vip') {
    filteredVip = [];
  }
  
  var allPlayers = [];
  filteredVip.forEach(function(p) { 
    var playerCopy = {};
    for (var key in p) playerCopy[key] = p[key];
    playerCopy.vipType = 'VIP';
    allPlayers.push(playerCopy);
  });
  filteredSilent.forEach(function(p) { 
    var playerCopy = {};
    for (var key in p) playerCopy[key] = p[key];
    playerCopy.vipType = 'Silent VIP';
    allPlayers.push(playerCopy);
  });
  
  var segmentPlayers = allPlayers.filter(function(player) {
    var playerValue = player[metricId];
    return String(playerValue) === String(segmentName);
  });
  
  currentModalPlayers = segmentPlayers.map(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    return {
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: player.vipType,
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      deposit_sum_lifetime: player.deposit_sum_lifetime || 0,
      cashout_sum_lifetime: player.cashout_sum_lifetime || 0,
      deposit_count_lifetime: player.deposit_count_lifetime || 0,
      cashout_count_lifetime: player.cashout_count_lifetime || 0,
      deposit_sum_period: player['deposit_sum_' + periodSuffix] || 0,
      cashout_sum_period: player['cashout_sum_' + periodSuffix] || 0,
      deposit_count_period: player['deposit_count_' + periodSuffix] || 0,
      cashout_count_period: player['cashout_count_' + periodSuffix] || 0,
      rawPlayer: player  // Store original player object with all data
    };
  });
  
  var periodLabel = getPeriodLabel(currentPeriod);
  var headerHtml = '';
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    {key: 'deposit_sum_lifetime', label: 'Dep Sum (LT)', width: '140px'},
    {key: 'cashout_sum_lifetime', label: 'Cash Sum (LT)', width: '140px'},
    {key: 'deposit_count_lifetime', label: 'Dep Count (LT)', width: '140px'},
    {key: 'cashout_count_lifetime', label: 'Cash Count (LT)', width: '140px'},
    {key: 'deposit_sum_period', label: 'Dep Sum (' + periodLabel + ')', width: '140px'},
    {key: 'cashout_sum_period', label: 'Cash Sum (' + periodLabel + ')', width: '140px'},
    {key: 'deposit_count_period', label: 'Dep Count (' + periodLabel + ')', width: '140px'},
    {key: 'cashout_count_period', label: 'Cash Count (' + periodLabel + ')', width: '140px'}
  ];
  
  columns.forEach(function(col) {
    if (visibleColumns[col.key]) {
      headerHtml += '<th style="min-width:' + col.width + '">' + col.label + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var bodyHtml = '';
  currentModalPlayers.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (!visibleColumns[col.key]) return;
      
      var cellContent = '';
      var cellStyle = '';
      
      switch(col.key) {
        case 'name':
          cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
          cellStyle = 'font-weight:600';
          break;
        case 'email':
          cellContent = player.email;
          cellStyle = 'font-size:12px;color:#64748b';
          break;
        case 'link':
          if (player.link) {
            cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
          } else {
            cellContent = '‚Äî';
          }
          break;
        case 'vipType':
          var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
          var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
          cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
          break;
        case 'manager':
          cellContent = player.manager;
          break;
        case 'country':
          cellContent = player.country;
          break;
        case 'deposit_sum_lifetime':
        case 'deposit_sum_period':
          cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        case 'cashout_sum_lifetime':
        case 'cashout_sum_period':
          cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
          cellStyle = 'text-align:right';
          break;
        default:
          cellContent = (player[col.key] || 0).toLocaleString();
          cellStyle = 'text-align:right';
      }
      
      bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
    });
    
    bodyHtml += '</tr>';
  });
  
  if (currentModalPlayers.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key]; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players in this segment</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function createSheetFromPieModal() {
  if (!currentModalPlayers || currentModalPlayers.length === 0) {
    alert('No data to export');
    return;
  }
  
  var modal = document.getElementById('metricModal');
  var metricName = modal.dataset.metricName || 'Pie Export';
  
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = '‚è≥ Creating...';
  
  var periodLabel = getPeriodLabel(currentPeriod);
  
  var exportData = [];
  
  var header = [];
  if (visibleColumns.name) header.push('Player');
  if (visibleColumns.email) header.push('Email');
  if (visibleColumns.link) header.push('Link');
  if (visibleColumns.vipType) header.push('Type');
  if (visibleColumns.manager) header.push('Manager');
  if (visibleColumns.country) header.push('Country');
  if (visibleColumns.deposit_sum_lifetime) header.push('Deposit Sum (LT)');
  if (visibleColumns.cashout_sum_lifetime) header.push('Cashout Sum (LT)');
  if (visibleColumns.deposit_count_lifetime) header.push('Deposit Count (LT)');
  if (visibleColumns.cashout_count_lifetime) header.push('Cashout Count (LT)');
  if (visibleColumns.deposit_sum_period) header.push('Deposit Sum (' + periodLabel + ')');
  if (visibleColumns.cashout_sum_period) header.push('Cashout Sum (' + periodLabel + ')');
  if (visibleColumns.deposit_count_period) header.push('Deposit Count (' + periodLabel + ')');
  if (visibleColumns.cashout_count_period) header.push('Cashout Count (' + periodLabel + ')');
  
  exportData.push(header);
  
  currentModalPlayers.forEach(function(player) {
    var row = [];
    if (visibleColumns.name) row.push(player.name.trim() || 'Unknown');
    if (visibleColumns.email) row.push(player.email);
    if (visibleColumns.link) row.push(player.link || '');
    if (visibleColumns.vipType) row.push(player.vipType);
    if (visibleColumns.manager) row.push(player.manager);
    if (visibleColumns.country) row.push(player.country);
    if (visibleColumns.deposit_sum_lifetime) row.push(player.deposit_sum_lifetime || 0);
    if (visibleColumns.cashout_sum_lifetime) row.push(Math.abs(player.cashout_sum_lifetime || 0));
    if (visibleColumns.deposit_count_lifetime) row.push(player.deposit_count_lifetime || 0);
    if (visibleColumns.cashout_count_lifetime) row.push(player.cashout_count_lifetime || 0);
    if (visibleColumns.deposit_sum_period) row.push(player.deposit_sum_period || 0);
    if (visibleColumns.cashout_sum_period) row.push(Math.abs(player.cashout_sum_period || 0));
    if (visibleColumns.deposit_count_period) row.push(player.deposit_count_period || 0);
    if (visibleColumns.cashout_count_period) row.push(player.cashout_count_period || 0);
    
    exportData.push(row);
  });
  
  google.script.run
    .withSuccessHandler(function(url) {
      btn.disabled = false;
      btn.textContent = '‚úÖ Sheet Created!';
      
      if (url) {
        window.open(url, '_blank');
      }
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .withFailureHandler(function(error) {
      btn.disabled = false;
      btn.textContent = '‚ùå Error';
      alert('Failed to create sheet: ' + error.message);
      
      setTimeout(function() {
        btn.textContent = 'üìä Create Sheet';
      }, 3000);
    })
    .createExportSheet(metricName, exportData);
}

function handlePieClickWrapper(evt) {
  var canvas = evt.target;
  var metricId = canvas.getAttribute('data-metric-id');
  var metricName = canvas.getAttribute('data-metric-name');
  handlePieClick(evt, metricId, metricName);
}

function handlePieClick(evt, metricId, metricName) {
  var canvas = evt.target;
  var chart = Chart.getChart(canvas);
  
  if (!chart) return;
  
  var points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
  
  if (points.length > 0) {
    var firstPoint = points[0];
    var label = chart.data.labels[firstPoint.index];
    
    console.log('Clicked pie segment:', label);
    openPieModal(metricId, metricName, label);
  }
}

function closeMetricModal() {
  var modal = document.getElementById('metricModal');
  modal.style.display = 'none';
  metricModalSort = {column: null, direction: 'desc'};
  currentModalPlayers = [];
}


function hideLoader(){const loader=document.getElementById('top-loader');loader.classList.remove('loading')}

function deduplicatePlayers(players){const seen=new Map();players.forEach(p=>{if(!seen.has(p.id)){seen.set(p.id,p)}});return Array.from(seen.values())}

function renderModalContent(data){
  console.log('üìä renderModalContent called with data:', data);
  console.log('  - data.achieved:', data.achieved ? data.achieved.length : 'undefined');
  console.log('  - data.dropped:', data.dropped ? data.dropped.length : 'undefined');
  console.log('  - data.totalAchieved:', data.totalAchieved);
  console.log('  - data.totalDropped:', data.totalDropped);
  
  const achievedUnique=deduplicatePlayers(data.achieved||[]);
  const droppedUnique=deduplicatePlayers(data.dropped||[]);
  
  console.log('  - achievedUnique:', achievedUnique.length);
  console.log('  - droppedUnique:', droppedUnique.length);
  
  if (droppedUnique.length > 0) {
    console.log('  - First dropped player:', droppedUnique[0]);
  } else {
    console.log('  - ‚ö†Ô∏è No dropped players!');
  }
  
  const hasFilters=data.totalAchieved!==achievedUnique.length||data.totalDropped!==droppedUnique.length;let html='<div class="analytics-section"><div class="analytics-title">üìä Analytics'+(hasFilters?' (Filtered)':'')+'</div><div class="pies-grid">';const allPlayers=[...achievedUnique,...droppedUnique];if(allPlayers.length>0){html+=createPieCard('Countries','c1',groupBy(allPlayers,p=>p.country||'Unknown'));html+=createPieCard('Status','c2',groupBy(allPlayers,p=>(p.status==='none'||!p.status)?'Active':'Disabled'));html+=createPieCard('Achievement','c3',[{label:'Achieved',value:achievedUnique.length},{label:'Dropped',value:droppedUnique.length}])}html+='</div></div>';html+='<div class="players-section"><div class="section-header"><div class="section-title">‚úÖ Achieved</div><div class="section-count">'+achievedUnique.length+(hasFilters?' / '+data.totalAchieved:'')+'</div></div>';if(achievedUnique.length>0){html+='<div class="players-list"><div class="player-row" style="font-weight:700;background:#f8fafc;border-bottom:2px solid #667eea"><div>Email</div><div>Country</div><div>Status</div><div>Link</div><div>Manager</div><div>Type</div></div>';achievedUnique.forEach(p=>{const email=p.email||p.id||'N/A';html+='<div class="player-row"><div class="player-email" onclick="copyToClipboard(escapeHtml(email))">' + escapeHtml(email) + '<span class="copy-icon">üìã</span></div><div>' + escapeHtml(p.country||'N/A') + '</div><div style="font-size:11px">' + escapeHtml(String(p.status||'none').toLowerCase()==='none'?'active':p.status) + '</div><div><a href="' + createBackofficeLink(p.id) + '" target="_blank" class="player-link">Open</a></div><div>' + escapeHtml(getManager(p.tags)||'-') + '</div><div style="font-size:11px;color:#64748b">' + escapeHtml(p.trafficType||'-') + '</div></div>'});html+='</div>'}else{html+='<div style="padding:20px;text-align:center;color:#64748b">No players</div>'}html+='</div>';html+='<div class="players-section"><div class="section-header"><div class="section-title">‚ùå Dropped</div><div class="section-count">'+droppedUnique.length+(hasFilters?' / '+data.totalDropped:'')+'</div></div>';if(droppedUnique.length>0){html+='<div class="players-list"><div class="player-row" style="font-weight:700;background:#fef2f2;border-bottom:2px solid #ef4444"><div>Email</div><div>Country</div><div>Status</div><div>Link</div><div>Manager</div><div>Type</div></div>';droppedUnique.forEach(p=>{const email=p.email||p.id||'N/A';html+='<div class="player-row"><div class="player-email" onclick="copyToClipboard(escapeHtml(email))">' + escapeHtml(email) + '<span class="copy-icon">üìã</span></div><div>' + escapeHtml(p.country||'N/A') + '</div><div style="font-size:11px">' + escapeHtml(String(p.status||'none').toLowerCase()==='none'?'active':p.status) + '</div><div><a href="' + createBackofficeLink(p.id) + '" target="_blank" class="player-link">Open</a></div><div>' + escapeHtml(getManager(p.tags)||'-') + '</div><div style="font-size:11px;color:#64748b">' + escapeHtml(p.trafficType||'-') + '</div></div>'});html+='</div>'}else{html+='<div style="padding:20px;text-align:center;color:#64748b">All achieved!</div>'}html+='</div>';document.getElementById('modalBody').innerHTML=html;setTimeout(()=>{if(allPlayers.length>0){try{renderPieChart('c1',groupBy(allPlayers,p=>p.country||'Unknown'));renderPieChart('c2',groupBy(allPlayers,p=>(p.status==='none'||!p.status)?'Active':'Disabled'));renderPieChart('c3',[{label:'Achieved',value:achievedUnique.length},{label:'Dropped',value:droppedUnique.length}])}catch(e){console.error('Error rendering pie charts:',e)}}},100)}

function createPieCard(title,id,data){return'<div class="pie-card"><div class="pie-chart"><canvas id="' + id + '"></canvas></div><div class="pie-legend"><div style="font-weight:700;margin-bottom:10px;color:#1e293b;font-size:14px">' + title + '</div><div id="' + id + 'Legend"></div></div></div>'}

function groupBy(arr,fn){const map={};arr.forEach(item=>{const key=fn(item)||'Unknown';map[key]=(map[key]||0)+1});return Object.keys(map).map(label=>({label,value:map[label]})).sort((a,b)=>b.value-a.value)}

function renderPieChart(id,data){
  try{
    console.log('üé® Rendering pie chart:', id, 'with data:', data);
    const canvas=document.getElementById(id);
    if(!canvas||!data||data.length===0){
      console.log('‚ö†Ô∏è Cannot render pie chart - missing canvas or data');
      return;
    }
    const ctx=canvas.getContext('2d');
    if(!ctx)return;
    if(typeof Chart==='undefined'){
      console.error('Chart.js not loaded');
      return;
    }
    
    const labels=data.map(d=>d.label);
    const values=data.map(d=>d.value);
    const colors=data.map((_,i)=>pieColors[i%pieColors.length]);
    
    var chartInstance = new Chart(ctx,{
      type:'doughnut',
      data:{
        labels,
        datasets:[{
          data:values,
          backgroundColor:colors,
          borderColor:'#fff',
          borderWidth:3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:true,
        onClick: function(event, activeElements) {
          console.log('üñ±Ô∏è Chart clicked! Active elements:', activeElements.length);
          if (activeElements.length > 0) {
            var index = activeElements[0].index;
            var selectedLabel = labels[index];
            console.log('üìä Pie segment clicked:', selectedLabel, 'at index:', index);
            
            // Use the scroll function
            scrollToRetentionSection(selectedLabel);
          } else {
            console.log('‚ö†Ô∏è No active element clicked');
          }
        },
        plugins:{
          legend:{display:false},
          datalabels:{display:false},
          tooltip:{
            callbacks:{
              label: function(context) {
                var label = context.label || '';
                var value = context.parsed;
                var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                var percentage = ((value / total) * 100).toFixed(1);
                return ' ' + label + ': ' + value + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
    
    console.log('‚úÖ Pie chart created:', id);
    
    const legendEl=document.getElementById(id+'Legend');
    if(legendEl){
      let html='';
      data.forEach((d,i)=>{
        var escapedLabel = d.label.replace(/'/g, "\\'");
        html+='<div class="legend-item" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'rgba(102,126,234,0.1)\'" onmouseout="this.style.background=\'\'" onclick="console.log(\'Legend clicked:\',\'' + escapedLabel + '\');scrollToRetentionSection(\'' + escapedLabel + '\')">';
        html+='<div class="legend-dot" style="background:' + colors[i] + '"></div>';
        html+='<div style="flex:1;font-size:12px;font-weight:500">' + escapeHtml(d.label) + '</div>';
        html+='<div style="font-weight:800;font-size:13px;color:#667eea">' + d.value + '</div>';
        html+='</div>';
      });
      legendEl.innerHTML=html;
      console.log('‚úÖ Legend created for:', id);
    }
  }catch(e){
    console.error('‚ùå renderPieChart error:',e);
  }
}

function scrollToRetentionSection(sectionName) {
  console.log('üìç scrollToRetentionSection called with:', sectionName);
  
  // Wait for modal content to be rendered
  setTimeout(function() {
    // Try multiple selectors
    var selectors = [
      '.section-title',
      '.section-header .section-title',
      '[class*="section-title"]'
    ];
    
    var found = false;
    
    for (var s = 0; s < selectors.length; s++) {
      var sections = document.querySelectorAll(selectors[s]);
      console.log('üîç Trying selector:', selectors[s], 'found:', sections.length, 'sections');
      
      if (sections.length > 0) {
        for (var i = 0; i < sections.length; i++) {
          var text = sections[i].textContent || sections[i].innerText;
          console.log('  Section', i, ':', text);
          
          if (text.includes(sectionName)) {
            console.log('  ‚úÖ Match found! Scrolling...');
            found = true;
            
            // Get the parent section
            var section = sections[i].closest('.players-section') || sections[i].parentElement.parentElement;
            
            if (section) {
              // Scroll to section
              section.scrollIntoView({behavior: 'smooth', block: 'start'});
              
              // Highlight the section briefly
              var originalBg = section.style.background || '';
              section.style.transition = 'background 0.3s';
              section.style.background = 'rgba(102, 126, 234, 0.1)';
              setTimeout(function() {
                section.style.background = originalBg;
              }, 1500);
            }
            break;
          }
        }
        if (found) break;
      }
    }
    
    if (!found) {
      console.log('‚ùå Section not found:', sectionName);
      console.log('Available sections:', document.querySelectorAll('.section-title'));
    }
  }, 200); // Wait 200ms for modal to render
}

document.getElementById('btnCreateSheet').onclick=()=>{if(!currentFilteredData)return;const btn=document.getElementById('btnCreateSheet');btn.disabled=true;btn.textContent='‚è≥ Creating...';const achievedUnique=deduplicatePlayers(currentFilteredData.achieved||[]);const droppedUnique=deduplicatePlayers(currentFilteredData.dropped||[]);google.script.run.withSuccessHandler(result=>{btn.disabled=false;btn.textContent='‚úÖ Created!';setTimeout(()=>btn.textContent='üìÑ Create Sheet',2000);if(result.url)window.open(result.url,'_blank')}).withFailureHandler(err=>{btn.disabled=false;btn.textContent='‚ùå Error';alert('Error: '+err);setTimeout(()=>btn.textContent='üìÑ Create Sheet',2000)}).createPlayersSheet({title:currentModalData.month + ' ' + currentModalData.range,achieved:achievedUnique,dropped:droppedUnique})};

function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}

function initCompareView(){
  if(!kpiDataByTab||Object.keys(kpiDataByTab).length===0)return;
  
  const tabs=Object.keys(kpiDataByTab);
  const dropdown1=document.getElementById('compareTab1');
  const dropdown2=document.getElementById('compareTab2');
  
  dropdown1.innerHTML='';
  dropdown2.innerHTML='';
  
  tabs.forEach(tab=>{
    const opt1=document.createElement('option');
    opt1.value=tab;
    opt1.textContent=tab;
    dropdown1.appendChild(opt1);
    
    const opt2=document.createElement('option');
    opt2.value=tab;
    opt2.textContent=tab;
    dropdown2.appendChild(opt2);
  });
  
  compareTab1=tabs[0]||'';
  compareTab2=tabs[1]||tabs[0]||'';
  dropdown1.value=compareTab1;
  dropdown2.value=compareTab2;
  
  renderCompareMetrics();
  renderCompareData();
}

function renderCompareMetrics(){
  if(!kpiDataByTab||!compareTab1)return;
  
  const data1=kpiDataByTab[compareTab1];
  if(!data1||!data1.metrics)return;
  
  const container=document.getElementById('compareMetrics');
  container.innerHTML='';
  
  const metrics=data1.metrics.slice(0,20);
  metrics.forEach((m,i)=>{
    const btn=document.createElement('button');
    btn.className='metric-btn'+(i===0&&!compareCurrentMetric?' active':'')+(m===compareCurrentMetric?' active':'');
    btn.textContent=m;
    btn.onclick=()=>{
      compareCurrentMetric=m;
      document.querySelectorAll('#compareMetrics .metric-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderCompareChart();
      renderCompareTable();
      document.getElementById('compareMetricDisplay').style.display='block';
      document.getElementById('compareMetricName').textContent=m;
    };
    container.appendChild(btn);
  });
  
  if(!compareCurrentMetric&&metrics.length>0){
    compareCurrentMetric=metrics[0];
    document.getElementById('compareMetricDisplay').style.display='block';
    document.getElementById('compareMetricName').textContent=metrics[0];
  }
}

function renderCompareData(){
  compareTab1=document.getElementById('compareTab1').value;
  compareTab2=document.getElementById('compareTab2').value;
  renderCompareMetrics();
  renderCompareChart();
  renderCompareTable();
}

function renderCompareChart(){
  if(!compareCurrentMetric||!compareTab1||!compareTab2)return;
  if(typeof Chart==='undefined'){console.error('Chart.js not loaded');return}
  
  const data1=kpiDataByTab[compareTab1];
  const data2=kpiDataByTab[compareTab2];
  if(!data1||!data2)return;
  
  const ctx=document.getElementById('compareChart').getContext('2d');
  const labels=[];
  const values1=[];
  const values2=[];
  
  data1.months.forEach(m=>{
    labels.push(m.label);
    const val1=m.monthly[compareCurrentMetric]||m.sumWeeks[compareCurrentMetric]||0;
    values1.push(val1);
  });
  
  data2.months.forEach((m,i)=>{
    const val2=m.monthly[compareCurrentMetric]||m.sumWeeks[compareCurrentMetric]||0;
    if(values2.length<data1.months.length){
      values2.push(val2);
    }
  });
  
  while(values2.length<values1.length){
    values2.push(0);
  }
  
  const config={
    type:'bar',
    data:{
      labels,
      datasets:[
        {
          label:compareTab1,
          data:values1,
          backgroundColor:'#667eea',
          borderRadius:8,
          barPercentage:0.6
        },
        {
          label:compareTab2,
          data:values2,
          backgroundColor:'#764ba2',
          borderRadius:8,
          barPercentage:0.6
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:30,bottom:10}},
      plugins:{
        legend:{display:true,position:'top'},
        datalabels:{
          anchor:'end',
          align:'end',
          color:'#1e293b',
          font:{weight:'bold',size:10},
          formatter:(v)=>formatKpiValue(compareCurrentMetric,v)
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grace:'10%',
          grid:{color:'#f1f5f9'},
          ticks:{
            font:{weight:'600'},
            color:'#64748b',
            callback:(v)=>formatKpiValue(compareCurrentMetric,v)
          }
        },
        x:{
          grid:{display:false},
          ticks:{font:{weight:'600',size:10},color:'#64748b'}
        }
      }
    }
  };
  
  if(compareChart)compareChart.destroy();
  compareChart=new Chart(ctx,config);
}

function renderCompareTable(){
  if(!compareCurrentMetric||!compareTab1||!compareTab2)return;
  
  const data1=kpiDataByTab[compareTab1];
  const data2=kpiDataByTab[compareTab2];
  if(!data1||!data2)return;
  
  const table=document.getElementById('compare-table');
  let html='<thead><tr><th>Period</th><th>'+escapeHtml(compareTab1)+'</th><th>'+escapeHtml(compareTab2)+'</th><th>Difference</th></tr></thead><tbody>';
  
  data1.months.forEach((m1,i)=>{
    const val1=m1.monthly[compareCurrentMetric]||m1.sumWeeks[compareCurrentMetric]||0;
    const m2=data2.months[i];
    const val2=m2?(m2.monthly[compareCurrentMetric]||m2.sumWeeks[compareCurrentMetric]||0):0;
    const diff=val1-val2;
    const diffPct=val2>0?(diff/val2)*100:0;
    const diffColor=diff>0?'#10b981':diff<0?'#ef4444':'#64748b';
    
    html+='<tr>';
    html+='<td style="font-weight:700;color:#667eea">'+escapeHtml(m1.label)+'</td>';
    html+='<td style="font-weight:700">'+formatKpiValue(compareCurrentMetric,val1)+'</td>';
    html+='<td style="font-weight:700">'+formatKpiValue(compareCurrentMetric,val2)+'</td>';
    html+='<td style="font-weight:700;color:'+diffColor+'">';
    html+=(diff>0?'+':'')+formatKpiValue(compareCurrentMetric,diff);
    html+=' ('+diffPct.toFixed(1)+'%)</td>';
    html+='</tr>';
  });
  
  html+='</tbody>';
  table.innerHTML=html;
}

let currentPieMetricId = null;
let currentPieMetricName = null;
let currentPieFilter = null;
let pieChartInstance = null;
let pieSortColumn = null;
let pieSortDirection = 'desc';

function openPieChartModal(metricId, metricName) {
  currentPieMetricId = metricId;
  currentPieMetricName = metricName;
  currentPieFilter = null;
  
  var modal = document.getElementById('pieChartModal');
  var title = document.getElementById('pieChartModalTitle');
  
  title.textContent = metricName;
  modal.style.display = 'flex';
  
  renderPieChartInModal();
  renderPieModalTable();
}

function closePieChartModal() {
  var modal = document.getElementById('pieChartModal');
  modal.style.display = 'none';
  
  if (pieChartInstance) {
    pieChartInstance.destroy();
    pieChartInstance = null;
  }
  
  currentPieMetricId = null;
  currentPieMetricName = null;
  currentPieFilter = null;
}

function renderPieChartInModal() {
  if (!vipData || !vipData.metrics || !vipData.metrics.pies) return;
  
  var pieData = vipData.metrics.pies[currentPieMetricId];
  if (!pieData) return;
  
  var distribution = null;
  if (currentVIPTab === 'total') {
    distribution = pieData.total;
  } else if (currentVIPTab === 'vip') {
    distribution = pieData.vip;
  } else {
    distribution = pieData.silentVip;
  }
  
  if (!distribution || Object.keys(distribution).length === 0) return;
  
  function improveLabel(label) {
    var labelStr = String(label).trim();
    if (currentPieMetricName.toLowerCase().includes('gender')) {
      if (labelStr.toLowerCase() === 'm' || labelStr.toLowerCase() === 'male') return 'Male';
      if (labelStr.toLowerCase() === 'f' || labelStr.toLowerCase() === 'female') return 'Female';
    }
    if (labelStr === '' || labelStr === 'null' || labelStr === 'undefined') return 'Unknown';
    return labelStr;
  }
  
  var improvedDist = {};
  Object.keys(distribution).forEach(function(key) {
    var improvedKey = improveLabel(key);
    improvedDist[improvedKey] = (improvedDist[improvedKey] || 0) + distribution[key];
  });
  
  var sortedEntries = Object.entries(improvedDist).sort(function(a, b) { return b[1] - a[1]; });
  var labels = sortedEntries.map(function(e) { return e[0]; });
  var values = sortedEntries.map(function(e) { return e[1]; });
  
  var colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#fa709a', '#fee140', '#30cfd0', '#330867', '#a8edea', '#fed6e3', '#ff9a9e', '#fecfef'];
  
  var canvas = document.getElementById('pieChartModalCanvas');
  var ctx = canvas.getContext('2d');
  
  if (pieChartInstance) {
    pieChartInstance.destroy();
  }
  
  pieChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      onClick: function(event, activeElements) {
        if (activeElements.length > 0) {
          var index = activeElements[0].index;
          var selectedLabel = labels[index];
          currentPieFilter = selectedLabel;
          renderPieModalTable();
        } else {
          currentPieFilter = null;
          renderPieModalTable();
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 10,
            font: { size: 11 },
            generateLabels: function(chart) {
              var data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map(function(label, i) {
                  var value = data.datasets[0].data[i];
                  var total = data.datasets[0].data.reduce(function(a, b) { return a + b; }, 0);
                  var percentage = ((value / total) * 100).toFixed(1);
                  return {
                    text: label + ': ' + value + ' (' + percentage + '%)',
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              var label = context.label || '';
              var value = context.parsed;
              var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
              var percentage = ((value / total) * 100).toFixed(1);
              return ' ' + label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

function renderPieModalTable() {
  var tbody = document.getElementById('pieModalTableBody');
  var thead = document.getElementById('pieModalTableHeader');
  if (!tbody || !thead) return;
  
  var filteredVip = vipAllPlayers.vip || [];
  var filteredSilent = vipAllPlayers.silentVip || [];
  
  if (currentManager) {
    filteredVip = filteredVip.filter(function(p) { return getPlayerManager(p) === currentManager; });
    filteredSilent = filteredSilent.filter(function(p) { return getPlayerManager(p) === currentManager; });
  }
  
  if (vipFilters) {
    if (vipFilters.trafficType && vipFilters.trafficType.length > 0) {
      filteredVip = filteredVip.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
      filteredSilent = filteredSilent.filter(function(p) {
        var traffic = p.trafficType || p.traffic_type || p.type || '';
        return vipFilters.trafficType.includes(traffic);
      });
    }
    if (vipFilters.country && vipFilters.country.length > 0) {
      filteredVip = filteredVip.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
      filteredSilent = filteredSilent.filter(function(p) { return vipFilters.country.includes(p.country || ''); });
    }
  }
  
  if (currentPieFilter) {
    var filterField = currentPieMetricId;
    filteredVip = filteredVip.filter(function(p) {
      var value = String(p[filterField] || '').trim();
      if (value === '' || value === 'null' || value === 'undefined') value = 'Unknown';
      return value === currentPieFilter;
    });
    filteredSilent = filteredSilent.filter(function(p) {
      var value = String(p[filterField] || '').trim();
      if (value === '' || value === 'null' || value === 'undefined') value = 'Unknown';
      return value === currentPieFilter;
    });
  }
  
  var filterIndicator = document.getElementById('pieFilterIndicator');
  if (filterIndicator) {
    if (currentPieFilter) {
      filterIndicator.innerHTML = '<span style="background:#667eea;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;margin-right:8px">Filter: ' + currentPieFilter + '</span>';
    } else {
      filterIndicator.innerHTML = '';
    }
  }
  
  var players = [];
  
  filteredVip.forEach(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      filterValue: player[currentPieMetricId] || '‚Äî',
      rawPlayer: player
    });
  });
  
  filteredSilent.forEach(function(player) {
    var rawId = player.id || player.player_id || '';
    var playerId = rawId.replace('slotornado:', '');
    
    players.push({
      name: (player.first_name || '') + ' ' + (player.last_name || ''),
      email: player.email || '‚Äî',
      id: playerId,
      link: playerId ? 'https://backoffice.slotornado-bivu.com/backend/players/' + playerId : '',
      vipType: 'Silent VIP',
      manager: getPlayerManager(player) || '‚Äî',
      country: player.country || '‚Äî',
      
      deposit_sum_lifetime: player.lifetime_deposit_sum_total || 0,
      cashout_sum_lifetime: player.lifetime_cashout_sum_total || 0,
      deposit_count_lifetime: player.lifetime_deposit_count_total || 0,
      cashout_count_lifetime: player.lifetime_cashout_count_total || 0,
      inout_lifetime: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0),
      
      deposit_sum_1d: player.deposit_sum_previous_day_total || 0,
      cashout_sum_1d: player.cashout_sum_previous_day_total || 0,
      deposit_count_1d: player.deposit_count_previous_day_total || 0,
      cashout_count_1d: player.cashout_count_previous_day_total || 0,
      inout_1d: (player.deposit_sum_previous_day_total || 0) - Math.abs(player.cashout_sum_previous_day_total || 0),
      
      deposit_sum_7d: player.deposit_sum_last_7_total || 0,
      cashout_sum_7d: player.cashout_sum_last_7_total || 0,
      deposit_count_7d: player.deposit_count_last_7_total || 0,
      cashout_count_7d: player.cashout_count_last_7_total || 0,
      inout_7d: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0),
      
      deposit_sum_30d: player.deposit_sum_last_30_total || 0,
      cashout_sum_30d: player.cashout_sum_last_30_total || 0,
      deposit_count_30d: player.deposit_count_last_30_total || 0,
      cashout_count_30d: player.cashout_count_last_30_total || 0,
      inout_30d: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0),
      
      deposit_sum_90d: player.deposit_sum_last_90_total || 0,
      cashout_sum_90d: player.cashout_sum_last_90_total || 0,
      deposit_count_90d: player.deposit_count_last_90_total || 0,
      cashout_count_90d: player.cashout_count_last_90_total || 0,
      inout_90d: (player.deposit_sum_last_90_total || 0) - Math.abs(player.cashout_sum_last_90_total || 0),
      
      filterValue: player[currentPieMetricId] || '‚Äî',
      rawPlayer: player
    });
  });
  
  if (pieSortColumn) {
    players.sort(function(a, b) {
      var valA = a[pieSortColumn];
      var valB = b[pieSortColumn];
      
      var numericCols = ['deposit_sum_lifetime', 'cashout_sum_lifetime', 'deposit_count_lifetime', 'cashout_count_lifetime', 'inout_lifetime',
        'deposit_sum_1d', 'cashout_sum_1d', 'deposit_count_1d', 'cashout_count_1d', 'inout_1d',
        'deposit_sum_7d', 'cashout_sum_7d', 'deposit_count_7d', 'cashout_count_7d', 'inout_7d',
        'deposit_sum_30d', 'cashout_sum_30d', 'deposit_count_30d', 'cashout_count_30d', 'inout_30d',
        'deposit_sum_90d', 'cashout_sum_90d', 'deposit_count_90d', 'cashout_count_90d', 'inout_90d'];
      
      if (numericCols.includes(pieSortColumn)) {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      } else {
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
      }
      
      if (valA < valB) return pieSortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return pieSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }
  
  var columns = [
    {key: 'name', label: 'Player', width: '150px'},
    {key: 'email', label: 'Email', width: '200px'},
    {key: 'link', label: 'Link', width: '80px'},
    {key: 'vipType', label: 'Type', width: '100px'},
    {key: 'manager', label: 'Manager', width: '100px'},
    {key: 'country', label: 'Country', width: '80px'},
    {key: 'filterValue', label: currentPieMetricName, width: '120px'},
    
    {key: 'deposit_sum_lifetime', label: 'Dep Sum (LT)', width: '140px'},
    {key: 'cashout_sum_lifetime', label: 'Cash Sum (LT)', width: '140px'},
    {key: 'deposit_count_lifetime', label: 'Dep Count (LT)', width: '140px'},
    {key: 'cashout_count_lifetime', label: 'Cash Count (LT)', width: '140px'},
    {key: 'inout_lifetime', label: 'INOUT (LT)', width: '140px'},
    
    {key: 'deposit_sum_1d', label: 'Dep Sum (1d)', width: '140px'},
    {key: 'cashout_sum_1d', label: 'Cash Sum (1d)', width: '140px'},
    {key: 'deposit_count_1d', label: 'Dep Count (1d)', width: '140px'},
    {key: 'cashout_count_1d', label: 'Cash Count (1d)', width: '140px'},
    {key: 'inout_1d', label: 'INOUT (1d)', width: '140px'},
    
    {key: 'deposit_sum_7d', label: 'Dep Sum (7d)', width: '140px'},
    {key: 'cashout_sum_7d', label: 'Cash Sum (7d)', width: '140px'},
    {key: 'deposit_count_7d', label: 'Dep Count (7d)', width: '140px'},
    {key: 'cashout_count_7d', label: 'Cash Count (7d)', width: '140px'},
    {key: 'inout_7d', label: 'INOUT (7d)', width: '140px'},
    
    {key: 'deposit_sum_30d', label: 'Dep Sum (30d)', width: '140px'},
    {key: 'cashout_sum_30d', label: 'Cash Sum (30d)', width: '140px'},
    {key: 'deposit_count_30d', label: 'Dep Count (30d)', width: '140px'},
    {key: 'cashout_count_30d', label: 'Cash Count (30d)', width: '140px'},
    {key: 'inout_30d', label: 'INOUT (30d)', width: '140px'},
    
    {key: 'deposit_sum_90d', label: 'Dep Sum (90d)', width: '140px'},
    {key: 'cashout_sum_90d', label: 'Cash Sum (90d)', width: '140px'},
    {key: 'deposit_count_90d', label: 'Dep Count (90d)', width: '140px'},
    {key: 'cashout_count_90d', label: 'Cash Count (90d)', width: '140px'},
    {key: 'inout_90d', label: 'INOUT (90d)', width: '140px'}
  ];
  
  var headerHtml = '';
  columns.forEach(function(col) {
    if (visibleColumns[col.key] !== false) {
      var sortIndicator = pieSortColumn === col.key ? (pieSortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      var clickHandler = col.key !== 'link' ? 'onclick="sortPieTable(\'' + col.key + '\')"' : '';
      var cursorStyle = col.key !== 'link' ? 'cursor:pointer;' : '';
      var bgColor = col.key === 'filterValue' ? 'background:#f0fdf4;' : '';
      headerHtml += '<th ' + clickHandler + ' style="min-width:' + col.width + ';' + cursorStyle + bgColor + '">' + col.label + ' ' + sortIndicator + '</th>';
    }
  });
  
  thead.innerHTML = headerHtml;
  
  var bodyHtml = '';
  players.forEach(function(player) {
    bodyHtml += '<tr>';
    
    columns.forEach(function(col) {
      if (visibleColumns[col.key] !== false) {
        var cellContent = '';
        var cellStyle = '';
        
        switch(col.key) {
          case 'name':
            cellContent = '<span style="cursor:pointer;color:#667eea;text-decoration:underline" onclick="openPlayerProfile(' + JSON.stringify(player.rawPlayer).replace(/"/g, '&quot;') + ', \'VIP Dashboard\')">' + (player.name.trim() || 'Unknown') + '</span>';
            cellStyle = 'font-weight:600';
            break;
          case 'email':
            cellContent = player.email;
            cellStyle = 'font-size:12px;color:#64748b';
            break;
          case 'link':
            if (player.link) {
              cellContent = '<a href="' + player.link + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600">üîó Open</a>';
            } else {
              cellContent = '‚Äî';
            }
            break;
          case 'vipType':
            var bgColor = player.vipType === 'VIP' ? '#dbeafe' : '#fef3c7';
            var textColor = player.vipType === 'VIP' ? '#1e40af' : '#92400e';
            cellContent = '<span style="background:' + bgColor + ';color:' + textColor + ';padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">' + player.vipType + '</span>';
            break;
          case 'manager':
            cellContent = player.manager;
            break;
          case 'country':
            cellContent = player.country;
            break;
          case 'filterValue':
            cellContent = player.filterValue;
            cellStyle = 'font-weight:600;background:#f0fdf4';
            break;
          case 'deposit_sum_lifetime':
          case 'deposit_sum_1d':
          case 'deposit_sum_7d':
          case 'deposit_sum_30d':
          case 'deposit_sum_90d':
            cellContent = '‚Ç¨' + (player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right';
            break;
          case 'cashout_sum_lifetime':
          case 'cashout_sum_1d':
          case 'cashout_sum_7d':
          case 'cashout_sum_30d':
          case 'cashout_sum_90d':
            cellContent = '‚Ç¨' + Math.abs(player[col.key] || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right';
            break;
          case 'deposit_count_lifetime':
          case 'cashout_count_lifetime':
          case 'deposit_count_1d':
          case 'cashout_count_1d':
          case 'deposit_count_7d':
          case 'cashout_count_7d':
          case 'deposit_count_30d':
          case 'cashout_count_30d':
          case 'deposit_count_90d':
          case 'cashout_count_90d':
            cellContent = (player[col.key] || 0).toLocaleString();
            cellStyle = 'text-align:right';
            break;
          case 'inout_lifetime':
          case 'inout_1d':
          case 'inout_7d':
          case 'inout_30d':
          case 'inout_90d':
            var inoutValue = player[col.key] || 0;
            var inoutColor = inoutValue >= 0 ? '#10b981' : '#ef4444';
            cellContent = '‚Ç¨' + Math.abs(inoutValue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            cellStyle = 'text-align:right;font-weight:700;color:' + inoutColor + ';background:#f0fdf4';
            break;
        }
        
        bodyHtml += '<td style="' + cellStyle + '">' + cellContent + '</td>';
      }
    });
    
    bodyHtml += '</tr>';
  });
  
  if (players.length === 0) {
    var colCount = columns.filter(function(c) { return visibleColumns[c.key] !== false; }).length;
    bodyHtml = '<tr><td colspan="' + colCount + '" style="text-align:center;padding:40px;color:#64748b">No players match current filter</td></tr>';
  }
  
  tbody.innerHTML = bodyHtml;
}

function sortPieTable(column) {
  if (pieSortColumn === column) {
    pieSortDirection = pieSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    pieSortColumn = column;
    pieSortDirection = 'desc';
  }
  renderPieModalTable();
}

function togglePieColumnSelector(event) {
  event.stopPropagation();
  var selector = document.getElementById('pieColumnSelector');
  
  if (selector.style.display === 'none') {
    selector.innerHTML = '<div style="font-size:13px;color:#64748b">Column selection coming soon...</div>';
    selector.style.display = 'block';
    
    setTimeout(function() {
      document.addEventListener('click', closePieColumnSelector);
    }, 100);
  } else {
    selector.style.display = 'none';
  }
}

function closePieColumnSelector(event) {
  var selector = document.getElementById('pieColumnSelector');
  if (selector && !selector.contains(event.target)) {
    selector.style.display = 'none';
    document.removeEventListener('click', closePieColumnSelector);
  }
}

function formatUnixTimestamp(timestamp) {
  if (!timestamp || timestamp === 0 || timestamp === '0') return '‚Äî';
  
  // –Ø–∫—â–æ —Ü–µ –≤–∂–µ —Å—Ç—Ä–æ–∫–∞ –∑ –¥–∞—Ç–æ—é (–º—ñ—Å—Ç–∏—Ç—å –¥–µ—Ñ—ñ—Å –∞–±–æ —Å–ª–µ—à)
  if (typeof timestamp === 'string' && (timestamp.includes('-') || timestamp.includes('/'))) {
    return timestamp;
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ —á–∏—Å–ª–æ
  var ts = parseInt(timestamp);
  if (isNaN(ts)) return timestamp;
  
  // Unix timestamp –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö (—è–∫—â–æ –º–µ–Ω—à–µ 10000000000, —Ç–æ —Ü–µ —Å–µ–∫—É–Ω–¥–∏)
  var date = ts < 10000000000 ? new Date(ts * 1000) : new Date(ts);
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –¥–∞—Ç–∞ –≤–∞–ª—ñ–¥–Ω–∞
  if (isNaN(date.getTime())) return timestamp;
  
  // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É
  var year = date.getFullYear();
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var day = String(date.getDate()).padStart(2, '0');
  var hours = String(date.getHours()).padStart(2, '0');
  var minutes = String(date.getMinutes()).padStart(2, '0');
  
  return day + '.' + month + '.' + year + ' ' + hours + ':' + minutes;
}

function searchPlayer() {
  var input = document.getElementById('playerSearchInput');
  var email = input.value.trim().toLowerCase();
  
  if (!email) {
    showSearchMessage('Please enter an email address', 'warning');
    return;
  }
  
  var foundPlayer = null;
  var foundIn = null;
  
  // Search in VIP
  if (vipAllPlayers && vipAllPlayers.vip) {
    for (var i = 0; i < vipAllPlayers.vip.length; i++) {
      var player = vipAllPlayers.vip[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'VIP';
        break;
      }
    }
  }
  
  // Search in Silent VIP
  if (!foundPlayer && vipAllPlayers && vipAllPlayers.silentVip) {
    for (var i = 0; i < vipAllPlayers.silentVip.length; i++) {
      var player = vipAllPlayers.silentVip[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'Silent VIP';
        break;
      }
    }
  }
  
  // Search in Retention
  if (!foundPlayer && allRetentionData) {
    for (var i = 0; i < allRetentionData.length; i++) {
      var player = allRetentionData[i];
      if (player.email && player.email.toLowerCase().includes(email)) {
        foundPlayer = player;
        foundIn = 'Retention';
        break;
      }
    }
  }
  
  if (foundPlayer) {
    openPlayerProfile(foundPlayer, foundIn);
    input.value = '';
  } else {
    showSearchMessage('Player not found: ' + email, 'error');
  }
}

function showSearchMessage(message, type) {
  var input = document.getElementById('playerSearchInput');
  var originalBorderColor = input.style.borderColor;
  
  if (type === 'error') {
    input.style.borderColor = '#ef4444';
    input.placeholder = message;
  } else if (type === 'warning') {
    input.style.borderColor = '#f59e0b';
    input.placeholder = message;
  }
  
  setTimeout(function() {
    input.style.borderColor = originalBorderColor;
    input.placeholder = 'üîç Search by name or email...';
  }, 2000);
}

// Sidebar live search suggestions
(function(){
  var searchInput = document.getElementById('playerSearchInput');
  var suggestBox = document.getElementById('sidebarSearchSuggest');
  if(!searchInput || !suggestBox) return;
  
  var timer = null;
  searchInput.addEventListener('input', function(){
    var q = this.value.toLowerCase().trim();
    clearTimeout(timer);
    if(!q || q.length < 2){ suggestBox.classList.remove('open'); return; }
    
    timer = setTimeout(function(){
      var matches = [];
      
      // Search VIP players
      function searchVipList(list, source){
        if(!list) return;
        for(var i=0; i<list.length && matches.length<8; i++){
          var p = list[i];
          var email = String(p.email||'').toLowerCase();
          var name = String(p.name||p.first_name||'').toLowerCase();
          var id = String(p.id||'').toLowerCase();
          if(email.indexOf(q)!==-1 || name.indexOf(q)!==-1 || id.indexOf(q)!==-1){
            matches.push({player:p, source:source, email:p.email||'', name:p.name||p.first_name||'', id:p.id||''});
          }
        }
      }
      
      if(window.vipAllPlayers){
        searchVipList(vipAllPlayers.vip, 'VIP');
        searchVipList(vipAllPlayers.silentVip, 'Silent VIP');
      }
      
      // Search profiling players
      if(matches.length < 8 && window.profilingData && profilingData.allPlayers){
        for(var i=0; i<profilingData.allPlayers.length && matches.length<8; i++){
          var pp = profilingData.allPlayers[i];
          var d = pp.data || pp;
          var em = String(d.email||d.EMAIL||'').toLowerCase();
          var nm = String(d.name||'').toLowerCase();
          var pid = String(d.id||d.ID||'').toLowerCase();
          if(em.indexOf(q)!==-1 || nm.indexOf(q)!==-1 || pid.indexOf(q)!==-1){
            // Avoid duplicates by email
            if(!matches.some(function(m){ return m.email.toLowerCase() === em; })){
              matches.push({player:pp, source:'Profiling', email:d.email||d.EMAIL||'', name:d.name||'', id:d.id||d.ID||'', isProfiling:true});
            }
          }
        }
      }
      
      if(matches.length === 0){ suggestBox.classList.remove('open'); return; }
      
      suggestBox.innerHTML = '';
      matches.forEach(function(m){
        var div = document.createElement('div');
        div.className = 'prof-search-suggest-item';
        div.innerHTML = '<div><div class="pss-name">' + escapeHtml(m.name || m.id || 'Unknown') + '</div><div class="pss-email">' + escapeHtml(m.email) + '</div></div><span class="pss-type">' + escapeHtml(m.source) + '</span>';
        div.onmousedown = function(e){
          e.preventDefault();
          suggestBox.classList.remove('open');
          searchInput.value = '';
          if(m.isProfiling){
            openProfilingPlayer(m.player);
          } else {
            openPlayerProfile(m.player, m.source);
          }
        };
        suggestBox.appendChild(div);
      });
      suggestBox.classList.add('open');
    }, 150);
  });
  
  searchInput.addEventListener('blur', function(){ setTimeout(function(){ suggestBox.classList.remove('open'); }, 200); });
  searchInput.addEventListener('focus', function(){ if(this.value.length >= 2) this.dispatchEvent(new Event('input')); });
})();

/**
 * Open player profile by email (searches in vipAllPlayers)
 */
/**
 * Open player profile from Profiling section
 * Uses profiling player object directly, tries to find VIP data
 */
/**
 * Shared: set up player card header consistently for both VIP and Profiling sides
 * @param {string} side - 'front' (VIP) or 'back' (Profiling)
 * @param {object} opts - {name, email, type, country, photoUrl}
 */
function setupCardHeader(side, opts) {
  var nameId = side === 'front' ? 'vipPlayerName' : 'profilingPlayerName';
  var emailId = side === 'front' ? 'vipPlayerEmail' : 'profilingPlayerEmail';
  var avatarSel = '.flip-card-' + side + ' .unified-card-avatar';
  
  var nameEl = document.getElementById(nameId);
  var emailEl = document.getElementById(emailId);
  var avatarEl = document.querySelector(avatarSel);
  
  // Name
  if (nameEl) nameEl.textContent = opts.name || 'Unknown Player';
  
  // Email + Type
  if (emailEl) {
    var subtitle = opts.email || '';
    if (opts.type) subtitle += (subtitle ? ' ‚Ä¢ ' : '') + opts.type;
    emailEl.textContent = subtitle;
    if (opts.email) makeEmailCopyable(emailEl, opts.email);
  }
  
  // Avatar: photo ‚Üí flag ‚Üí üë§
  if (avatarEl) {
    var flag = opts.country ? getFlag(opts.country) : '';
    avatarEl.innerHTML = flag || 'üë§';
    avatarEl.style.fontSize = flag ? '36px' : '32px';
    
    if (opts.photoUrl && typeof opts.photoUrl === 'string' && opts.photoUrl.trim()) {
      setTimeout(function() {
        var el = document.querySelector(avatarSel);
        if (!el) return;
        el.innerHTML = '';
        var img = document.createElement('img');
        var url = opts.photoUrl.trim();
        img.src = url + (url.indexOf('?') === -1 ? '?t=' : '&t=') + Date.now();
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%';
        img.onerror = function() { el.innerHTML = flag || 'üë§'; el.style.fontSize = flag ? '36px' : '32px'; };
        el.appendChild(img);
      }, 100);
    }
  }
}

function openProfilingPlayer(profilingPlayer) {
  if (!profilingPlayer || !profilingPlayer.data) {
    console.error('‚ùå Invalid profiling player:', profilingPlayer);
    alert('Cannot open player: Invalid data');
    return;
  }
  
  var email = profilingPlayer.data.email || profilingPlayer.data.EMAIL || profilingPlayer.data['EMAIL [PREV]'];
  
  if (!email) {
    console.error('‚ùå No email found in profiling player:', profilingPlayer);
    alert('Cannot open player: Email not found');
    return;
  }
  
  console.log('üîç Opening profiling player:', email);
  
  // Store profiling player
  window.currentProfilingPlayer = profilingPlayer;
  
  // Try to find VIP player data
  var vipPlayer = null;
  
  if (window.vipAllPlayers) {
    if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
      vipPlayer = vipAllPlayers.vip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
    }
    if (!vipPlayer && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
      vipPlayer = vipAllPlayers.silentVip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
    }
  }
  
  window.currentVIPPlayer = vipPlayer || null;
  
  // ‚úÖ Prepare Profiling side (back)
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  
  // Clear avatars
  var profilingAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (profilingAvatar) profilingAvatar.innerHTML = 'üë§';
  var vipAvatar = document.querySelector('.flip-card-front .unified-card-avatar');
  if (vipAvatar) vipAvatar.innerHTML = 'üë§';
  
  // Build header info
  var playerName = profilingPlayer.data.name || ((profilingPlayer.data.first_name || '') + ' ' + (profilingPlayer.data.last_name || '')).trim() || profilingPlayer.data.email || 'Player';
  var playerEmail = profilingPlayer.data.email || '';
  var playerType = getPlayerTypeFromTags(profilingPlayer.tags) || '';
  var playerCountry = profilingPlayer.data.country || profilingPlayer.data.COUNTRY || '';
  var playerPhoto = profilingPlayer.data.photo || '';
  
  // Setup Profiling side header
  setupCardHeader('back', { name: playerName, email: playerEmail, type: playerType, country: playerCountry, photoUrl: playerPhoto });
  
  // Setup VIP side header too (in case flip)
  if (vipPlayer) {
    var vipName = vipPlayer.name || ((vipPlayer.first_name || '') + ' ' + (vipPlayer.last_name || '')).trim() || playerName;
    var vipType = getPlayerTypeFromTags(vipPlayer.tags) || playerType;
    var vipCountry = vipPlayer.country || playerCountry;
    setupCardHeader('front', { name: vipName, email: playerEmail, type: vipType, country: vipCountry, photoUrl: playerPhoto });
  }
  
  var nameEl = document.getElementById('profilingPlayerName');
  var emailEl = document.getElementById('profilingPlayerEmail');
  var bodyEl = document.getElementById('profilingCardBody');
  
  // Make name clickable to flip to VIP
  if (vipPlayer) {
    nameEl.style.cursor = 'pointer';
    nameEl.title = 'Click to view VIP Data';
    nameEl.onclick = function() { flipToVIPCard(); };
  } else {
    nameEl.style.cursor = 'default';
    nameEl.title = '';
    nameEl.onclick = null;
  }
  
  // Render profiling content
  renderProfilingCardContent(profilingPlayer, bodyEl);
  
  // Show/hide VIP flip button - always show, VIP side will show message if no data
  var flipBtn = document.getElementById('profilingToVIPFlipBtn');
  if (flipBtn) {
    flipBtn.style.display = 'block';
  }
  
  // ‚úÖ Prepare VIP side (front) - metrics & details
  if (vipPlayer) {
    var vipFlipBtn = document.getElementById('vipToProfilingFlipBtn');
    if (vipFlipBtn) vipFlipBtn.style.display = 'block';
    
    renderPlayerMetrics(vipPlayer);
    renderPlayerDetails(vipPlayer);
  } else {
    var vipFlipBtn = document.getElementById('vipToProfilingFlipBtn');
    if (vipFlipBtn) {
      vipFlipBtn.style.display = 'block';
      vipFlipBtn.onclick = function() { flipToProfilingCard(); };
    }
    
    var vipMetrics = document.getElementById('vipPlayerMetrics');
    if (vipMetrics) vipMetrics.innerHTML = '<div style="padding:60px;text-align:center;color:#94a3b8;grid-column:1/-1"><div style="font-size:64px;margin-bottom:16px">üìä</div><div style="font-size:18px;font-weight:700">No VIP Data Available</div><div style="font-size:14px;margin-top:8px">This player is not in VIP Dashboard</div></div>';
  }
  
  // ‚úÖ KEY: Show modal with Profiling side (flipped)
  flipCard.classList.add('flipped');
  modal.classList.add('show');
}

function openPlayerProfileByEmail(email, foundIn) {
  console.log('üîç Opening player by email:', email, 'from:', foundIn);
  
  // Search in vipAllPlayers first
  var player = null;
  
  if (window.vipAllPlayers) {
    console.log('üìä vipAllPlayers structure:', {
      hasVip: !!vipAllPlayers.vip,
      hasSilentVip: !!vipAllPlayers.silentVip,
      vipCount: vipAllPlayers.vip ? vipAllPlayers.vip.length : 0,
      silentCount: vipAllPlayers.silentVip ? vipAllPlayers.silentVip.length : 0
    });
    
    // Search in vip array
    if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
      player = vipAllPlayers.vip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
      
      if (player) {
        console.log('‚úÖ Found player in vipAllPlayers.vip:', player.name);
      }
    }
    
    // Search in silentVip array if not found
    if (!player && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
      player = vipAllPlayers.silentVip.find(function(p) {
        return p.email && p.email.toLowerCase() === email.toLowerCase();
      });
      
      if (player) {
        console.log('‚úÖ Found player in vipAllPlayers.silentVip:', player.name);
      }
    }
  } else {
    console.log('‚ö†Ô∏è vipAllPlayers not available');
  }
  
  // If not found, search in vipData
  if (!player && window.vipData) {
    console.log('üîç Searching in vipData...');
    var statusLists = ['slvip', 'vip', 'new', 'churned', 'other'];
    statusLists.forEach(function(status) {
      if (vipData[status] && Array.isArray(vipData[status])) {
        var found = vipData[status].find(function(p) {
          return p.email && p.email.toLowerCase() === email.toLowerCase();
        });
        if (found) {
          console.log('‚úÖ Found player in vipData.' + status);
          player = found;
        }
      }
    });
  }
  
  // If still not found, search in profilingData
  if (!player && window.profilingData && profilingData.allPlayers) {
    console.log('üîç Searching in profilingData.allPlayers...');
    var found = profilingData.allPlayers.find(function(p) {
      return p.data && p.data.email && p.data.email.toLowerCase() === email.toLowerCase();
    });
    if (found) {
      console.log('‚úÖ Found player in profilingData');
      player = {
        email: found.data.email || found.data.EMAIL || found.data['EMAIL [PREV]'],
        name: found.data.name || found.data.Name || found.data['Name [PREV]'] || 'Unknown',
        first_name: found.data.first_name || found.data['First Name'] || '',
        last_name: found.data.last_name || found.data['Last Name'] || '',
        country: found.data.country || found.data.Country || '',
        id: found.data.id || found.data.ID || found.data['Player ID'],
        profilingData: found.data,
        fromProfiling: true
      };
    }
  }
  
  if (!player) {
    console.error('‚ùå Player not found:', email);
    alert('Player not found: ' + email);
    return;
  }
  
  // Call regular openPlayerProfile with found player
  openPlayerProfile(player, foundIn);
}

function openPlayerProfile(player, foundIn) {
  console.log('üîç Opening player profile:', {
    email: player.email,
    name: player.name || (player.first_name + ' ' + player.last_name),
    foundIn: foundIn,
    hasAllFields: !!(player.deposits && player.bets)
  });
  
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  var nameEl = document.getElementById('vipPlayerName');
  var emailEl = document.getElementById('vipPlayerEmail');
  
  // CRITICAL: Clear avatars FIRST to prevent caching
  var vipAvatar = document.querySelector('.flip-card-front .unified-card-avatar');
  if (vipAvatar) vipAvatar.innerHTML = 'üë§';
  var profilingAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (profilingAvatar) profilingAvatar.innerHTML = 'üë§';
  
  // Find full VIP player data if we only have partial data
  var fullVIPPlayer = player;
  if (player.email && (!player.deposits || !player.bets)) {
    if (window.vipAllPlayers) {
      var found = null;
      if (vipAllPlayers.vip && Array.isArray(vipAllPlayers.vip)) {
        found = vipAllPlayers.vip.find(function(p) {
          return p.email && p.email.toLowerCase() === player.email.toLowerCase();
        });
      }
      if (!found && vipAllPlayers.silentVip && Array.isArray(vipAllPlayers.silentVip)) {
        found = vipAllPlayers.silentVip.find(function(p) {
          return p.email && p.email.toLowerCase() === player.email.toLowerCase();
        });
      }
      if (found) fullVIPPlayer = found;
    }
    if (!fullVIPPlayer.deposits && window.vipData) {
      var statusLists = ['slvip', 'vip', 'new', 'churned', 'other'];
      statusLists.forEach(function(status) {
        if (vipData[status] && Array.isArray(vipData[status])) {
          var found = vipData[status].find(function(p) {
            return p.email && p.email.toLowerCase() === player.email.toLowerCase();
          });
          if (found) fullVIPPlayer = found;
        }
      });
    }
  }
  
  // Use fullVIPPlayer from now on
  player = fullVIPPlayer;
  
  // Find profiling player for photo and cross-data
  var profilingPlayer = player.email ? findProfilingPlayerByEmail(player.email) : null;
  if (profilingPlayer && profilingData && profilingData.allPlayers) {
    var freshPlayer = profilingData.allPlayers.find(function(p) {
      return p.data && p.data.email === player.email;
    });
    if (freshPlayer) profilingPlayer = freshPlayer;
  }
  
  // Build consistent header info
  var playerName = player.name || ((player.first_name || '') + ' ' + (player.last_name || '')).trim() || 'Unknown Player';
  var playerEmail = player.email || 'No email';
  var playerType = getPlayerTypeFromTags(player.tags) || foundIn || '';
  var playerCountry = player.country || (profilingPlayer ? (profilingPlayer.data.country || profilingPlayer.data.COUNTRY || '') : '');
  var playerPhoto = profilingPlayer ? (profilingPlayer.data.photo || '') : '';
  
  // Setup VIP side header (front)
  setupCardHeader('front', { name: playerName, email: playerEmail, type: playerType, country: playerCountry, photoUrl: playerPhoto });
  
  // Setup Profiling side header too (in case flip)
  if (profilingPlayer) {
    var profName = profilingPlayer.data.name || ((profilingPlayer.data.first_name || '') + ' ' + (profilingPlayer.data.last_name || '')).trim() || playerName;
    var profType = getPlayerTypeFromTags(profilingPlayer.tags) || playerType;
    var profCountry = profilingPlayer.data.country || profilingPlayer.data.COUNTRY || playerCountry;
    setupCardHeader('back', { name: profName, email: playerEmail, type: profType, country: profCountry, photoUrl: playerPhoto });
  }
  
  nameEl.style.cursor = profilingPlayer ? 'pointer' : 'default';
  nameEl.title = profilingPlayer ? 'Click to view Profiling' : '';
  
  if (profilingPlayer) {
    nameEl.onclick = function() {
      window.currentProfilingPlayer = profilingPlayer;
      flipToProfilingCard();
    };
  } else {
    nameEl.onclick = null;
  }
  
  // Show/hide Profiling flip button
  var flipBtn = document.getElementById('vipToProfilingFlipBtn');
  if (flipBtn) {
    console.log('VIP->Profiling button check:', {hasProfilingPlayer: !!profilingPlayer, email: player.email});
    if (profilingPlayer) {
      flipBtn.style.display = 'block';
      // Also store profiling player for flip
      window.currentProfilingPlayer = profilingPlayer;
      flipBtn.onclick = function() {
        window.currentProfilingPlayer = profilingPlayer;
        flipToProfilingCard();
      };
    } else {
      flipBtn.style.display = 'none';
    }
  }
  
  // Store current VIP player
  window.currentVIPPlayer = player;
  
  renderPlayerMetrics(player);
  renderPlayerDetails(player);
  
  // Update Profiling side if profiling player exists
  if (profilingPlayer) {
    var profilingNameEl = document.getElementById('profilingPlayerName');
    var profilingEmailEl = document.getElementById('profilingPlayerEmail');
    var profilingBodyEl = document.getElementById('profilingCardBody');
    
    // Show NAME in header (not email)
    var profilingPlayerName = profilingPlayer.data.name || profilingPlayer.data.email || 'Player';
    profilingNameEl.textContent = profilingPlayerName;
    profilingEmailEl.textContent = profilingPlayer.data.email || '';
    profilingEmailEl.style.cursor = 'pointer';
    profilingEmailEl.title = 'Double-click to copy email';
    profilingEmailEl.ondblclick = function(e) { e.stopPropagation(); copyEmailToClipboard(profilingPlayer.data.email); };
    
    // Make name clickable to flip back
    profilingNameEl.style.cursor = 'pointer';
    profilingNameEl.title = 'Click to view VIP Data';
    profilingNameEl.onclick = function() {
      flipToVIPCard();
    };
    
    // Render profiling content
    renderProfilingCardContent(profilingPlayer, profilingBodyEl);
  }
  
  // Reset flip state and show modal
  flipCard.classList.remove('flipped');
  modal.classList.add('show');
}

function closePlayerProfile() {
  closeUnifiedModal();
}

/**
 * Delete player from database
 */
function deletePlayerFromModal() {
  var playerEmail = null;
  
  // Try to get email from currentProfilingPlayer
  if (window.currentProfilingPlayer && window.currentProfilingPlayer.data) {
    playerEmail = window.currentProfilingPlayer.data.email;
  }
  
  // Fallback: get from modal elements
  if (!playerEmail) {
    var emailEl = document.getElementById('vipPlayerEmail');
    if (emailEl && emailEl.textContent) {
      // Extract email from "email@example.com ‚Ä¢ VIP Dashboard" format
      playerEmail = emailEl.textContent.split('‚Ä¢')[0].trim();
    }
  }
  
  if (!playerEmail) {
    alert('Cannot delete: Player email not found');
    console.error('‚ùå Cannot delete: No player email found');
    return;
  }
  
  // Confirm deletion
  var playerName = (document.getElementById('profilingPlayerName') || document.getElementById('vipPlayerName') || {}).textContent || 'this player';
  var confirmed = confirm('‚ö†Ô∏è DELETE PLAYER?\n\n' + playerName + '\n' + playerEmail + '\n\nThis action cannot be undone!');
  
  if (!confirmed) {
    console.log('üö´ Delete cancelled by user');
    return;
  }
  
  console.log('üóëÔ∏è Deleting player:', playerEmail);
  
  // Disable buttons during deletion
  var deleteBtn = document.getElementById('vipDeletePlayerBtn');
  var profilingDeleteBtn = document.getElementById('profilingDeletePlayerBtn');
  if (deleteBtn) {
    deleteBtn.disabled = true;
    deleteBtn.textContent = '‚è≥ Deleting...';
  }
  if (profilingDeleteBtn) {
    profilingDeleteBtn.disabled = true;
    profilingDeleteBtn.textContent = '‚è≥ Deleting...';
  }
  
  // Call backend to delete player
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Player deleted:', result);
      
      // Close modal
      closeUnifiedModal();
      
      // Reload data
      alert('‚úÖ Player deleted successfully!');
      
      // Reload VIP Dashboard
      if (typeof loadVIPData === 'function') {
        loadVIPData();
      }
      
      // Reload Profiling
      if (typeof reloadProfilingData === 'function') {
        reloadProfilingData();
      }
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Delete failed:', error);
      alert('‚ùå Delete failed: ' + error.message);
      
      // Re-enable buttons
      if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è DELETE';
      }
      if (profilingDeleteBtn) {
        profilingDeleteBtn.disabled = false;
        profilingDeleteBtn.textContent = 'üóëÔ∏è DELETE';
      }
    })
    .deletePlayer(playerEmail);
}

function closeUnifiedModal() {
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  
  modal.classList.remove('show');
  flipCard.classList.remove('flipped');
  
  // Clear stored players
  window.currentVIPPlayer = null;
  window.currentProfilingPlayer = null;
}

/**
 * Close unified modal on backdrop click
 */
function closeUnifiedModalOnBackdrop(event) {
  if (event.target.id === 'unifiedPlayerModal') {
    closeUnifiedModal();
  }
}

/**
 * Flip to Profiling side
 */
function flipToProfilingCard() {
  var flipCard = document.getElementById('playerFlipCard');
  
  if (!window.currentProfilingPlayer) {
    console.error('No profiling player available');
    return;
  }
  
  // Update profiling card content
  var nameEl = document.getElementById('profilingPlayerName');
  var emailEl = document.getElementById('profilingPlayerEmail');
  var bodyEl = document.getElementById('profilingCardBody');
  
  nameEl.textContent = window.currentProfilingPlayer.data.email || 'Player';
  emailEl.textContent = window.currentProfilingPlayer.data.email || '';
  emailEl.style.cursor = 'pointer';
  emailEl.title = 'Double-click to copy email';
  emailEl.ondblclick = function(e) { e.stopPropagation(); copyEmailToClipboard(window.currentProfilingPlayer.data.email); };
  
  // Make name clickable to flip back
  nameEl.style.cursor = 'pointer';
  nameEl.title = 'Click to view VIP Data';
  nameEl.onclick = function() {
    flipToVIPCard();
  };
  
  // Render profiling content
  renderProfilingCardContent(window.currentProfilingPlayer, bodyEl);
  
  // Flip the card
  flipCard.classList.add('flipped');
}

/**
 * Flip to VIP side
 */
function flipToVIPCard() {
  var flipCard = document.getElementById('playerFlipCard');
  flipCard.classList.remove('flipped');
}

/**
 * Render profiling card content
 */
function renderProfilingCardContent(player, container) {
  container.innerHTML = '';
  
  // Ensure photo alias is set
  if (!player.data.photo) {
    var foundPhoto = getPlayerPhoto(player.data);
    if (foundPhoto) player.data.photo = foundPhoto;
  }
  
  // Convert old photo URL format to thumbnail format
  var photoConverted = false;
  if (player.data.photo) {
    var photoUrl = player.data.photo;
    if (photoUrl.indexOf('drive.google.com/uc?export=view&id=') !== -1) {
      var fileIdMatch = photoUrl.match(/[?&]id=([^&]+)/);
      if (fileIdMatch) {
        var fileId = fileIdMatch[1];
        player.data.photo = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
        photoConverted = true;
      }
    }
  }
  if (photoConverted) {
    setTimeout(function() { saveProfilingPlayerSilent(player); }, 500);
  }
  
  // === ATTENTION / NEWCOMER MARQUEE BANNER ===
  var _attention = null;
  var _isNewcomer = false;
  try { _attention = getPlayerAttention(player); } catch(e) {}
  try { _isNewcomer = isNewcomer(player); } catch(e) {}
  
  var modalMarqueeText = null;
  var modalMarqueeColor = null;
  var modalMarqueeIcon = '\u26A0\uFE0F';
  
  if (_attention) {
    modalMarqueeText = _attention.message;
    modalMarqueeColor = _attention.color;
  } else if (_isNewcomer) {
    modalMarqueeText = 'NEWCOMER \u2014 NO JIRA LINK';
    modalMarqueeColor = '#10b981';
    modalMarqueeIcon = '\uD83C\uDD95';
  }
  
  if (modalMarqueeText) {
    var modalBanner = document.createElement('div');
    modalBanner.style.cssText = 'background:' + modalMarqueeColor + ';overflow:hidden;display:flex;align-items:center;height:28px;flex-shrink:0';
    var bannerInner = document.createElement('div');
    bannerInner.textContent = (modalMarqueeIcon + ' ' + modalMarqueeText + ' ').repeat(8);
    bannerInner.style.cssText = 'white-space:nowrap;color:#fff;font-size:11px;font-weight:800;letter-spacing:1px;animation:marqueeScroll 14s linear infinite';
    modalBanner.appendChild(bannerInner);
    container.appendChild(modalBanner);
  }
  
  // === TOP TOOLBAR ===
  var topRow = document.createElement('div');
  topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-bottom:1px solid #e2e8f0;flex-shrink:0;gap:12px';
  
  var leftRow = document.createElement('div');
  leftRow.style.cssText = 'display:flex;gap:8px;align-items:center;flex-wrap:wrap';
  
  var uploadPhotoBtn = document.createElement('button');
  uploadPhotoBtn.innerHTML = '\uD83D\uDCF8 Photo';
  uploadPhotoBtn.style.cssText = 'padding:8px 14px;background:rgba(102,126,234,0.08);color:#667eea;border:1px solid rgba(102,126,234,0.2);border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap';
  uploadPhotoBtn.onmouseover = function() { this.style.background = 'rgba(102,126,234,0.15)'; };
  uploadPhotoBtn.onmouseout = function() { this.style.background = 'rgba(102,126,234,0.08)'; };
  uploadPhotoBtn.onclick = function() { uploadPlayerPhoto(player); };
  leftRow.appendChild(uploadPhotoBtn);
  
  var socialLinks = getSocialLinks(player, profilingData.fieldConfig);
  if (socialLinks.length > 0) {
    socialLinks.forEach(function(link) {
      var socialBtn = document.createElement('a');
      socialBtn.href = link.url; socialBtn.target = '_blank'; socialBtn.rel = 'noopener noreferrer';
      var icon = document.createElement('i'); icon.className = link.icon; socialBtn.appendChild(icon);
      socialBtn.title = link.platform;
      socialBtn.style.cssText = 'display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:rgba(102,126,234,0.06);border-radius:50%;font-size:15px;text-decoration:none;transition:all 0.2s;cursor:pointer;color:#667eea;border:1px solid rgba(102,126,234,0.1)';
      socialBtn.onmouseover = function() { this.style.background = 'rgba(102,126,234,0.15)'; this.style.transform = 'scale(1.1)'; };
      socialBtn.onmouseout = function() { this.style.background = 'rgba(102,126,234,0.06)'; this.style.transform = 'scale(1)'; };
      leftRow.appendChild(socialBtn);
    });
  }
  topRow.appendChild(leftRow);
  
  var rightButtons = document.createElement('div');
  rightButtons.style.cssText = 'display:flex;gap:8px;align-items:center';
  
  var bigIconLinks = getBigIconLinks(player, profilingData.fieldConfig);
  if (bigIconLinks.length > 0) {
    bigIconLinks.forEach(function(link) {
      var bigBtn = document.createElement('a');
      bigBtn.href = link.url; bigBtn.target = '_blank'; bigBtn.rel = 'noopener noreferrer';
      var icon = document.createElement('i'); icon.className = link.icon; bigBtn.appendChild(icon);
      var textSpan = document.createElement('span');
      textSpan.textContent = link.platform;
      textSpan.style.cssText = 'font-size:11px;font-weight:700;margin-left:6px';
      bigBtn.appendChild(textSpan);
      bigBtn.title = link.platform;
      bigBtn.style.cssText = 'display:flex;align-items:center;padding:6px 14px;background:rgba(102,126,234,0.06);border-radius:20px;font-size:16px;text-decoration:none;transition:all 0.2s;cursor:pointer;color:#667eea;border:1px solid rgba(102,126,234,0.15)';
      bigBtn.onmouseover = function() { this.style.background = 'rgba(102,126,234,0.15)'; };
      bigBtn.onmouseout = function() { this.style.background = 'rgba(102,126,234,0.06)'; };
      rightButtons.appendChild(bigBtn);
    });
    var sep = document.createElement('div');
    sep.style.cssText = 'width:1px;height:24px;background:#e2e8f0';
    rightButtons.appendChild(sep);
  }
  
  var deleteBtn = document.createElement('button');
  deleteBtn.innerHTML = '\uD83D\uDDD1\uFE0F Delete';
  deleteBtn.style.cssText = 'padding:8px 14px;background:rgba(239,68,68,0.06);color:#ef4444;border:1px solid rgba(239,68,68,0.15);border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap';
  deleteBtn.onmouseover = function() { this.style.background = 'rgba(239,68,68,0.12)'; this.style.borderColor = 'rgba(239,68,68,0.3)'; };
  deleteBtn.onmouseout = function() { this.style.background = 'rgba(239,68,68,0.06)'; this.style.borderColor = 'rgba(239,68,68,0.15)'; };
  deleteBtn.onclick = function() { deletePlayerFromModal(); };
  rightButtons.appendChild(deleteBtn);
  
  var saveBtn = document.createElement('button');
  saveBtn.id = 'profilingSaveBtn';
  saveBtn.innerHTML = '\uD83D\uDCBE Save';
  saveBtn.style.cssText = 'padding:8px 18px;background:#e2e8f0;color:#94a3b8;border:1px solid #cbd5e1;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s;white-space:nowrap';
  saveBtn.onclick = function() { saveProfilingPlayer(player); };
  rightButtons.appendChild(saveBtn);
  
  topRow.appendChild(rightButtons);
  container.appendChild(topRow);
  
  window._profilingDirty = false;
  
  // === ICON ROW ===
  var iconRow = document.createElement('div');
  iconRow.id = 'profilingIconRow';
  iconRow.style.cssText = 'display:flex;gap:20px;justify-content:center;padding:20px;background:#fff;flex-shrink:0';
  
  var hasAnyIcon = false;
  
  function findData(searchKeys) {
    var keys = Object.keys(player.data);
    for (var s = 0; s < searchKeys.length; s++) {
      var term = searchKeys[s].toLowerCase();
      for (var k = 0; k < keys.length; k++) {
        if (keys[k].toLowerCase() === term && player.data[keys[k]] && String(player.data[keys[k]]).trim() !== '') return player.data[keys[k]];
      }
    }
    return null;
  }
  
  var detailPhotoUrl = getPlayerPhoto(player.data);
  if (detailPhotoUrl) {
    hasAnyIcon = true;
    var photoIcon = document.createElement('div');
    photoIcon.id = 'playerPhotoIcon';
    photoIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    var photoBox = document.createElement('div');
    photoBox.style.cssText = 'width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.05);cursor:pointer;background:#f8fafc;display:flex;align-items:center;justify-content:center';
    var photoImg = document.createElement('img');
    photoImg.src = detailPhotoUrl;
    photoImg.style.cssText = 'width:100%;height:100%;object-fit:cover';
    photoImg.onerror = function() { this.style.display = 'none'; photoBox.innerHTML = '<div style="font-size:32px">\uD83D\uDCF7</div>'; };
    photoImg.onclick = function() { openPhotoModal(detailPhotoUrl); };
    photoBox.appendChild(photoImg); photoIcon.appendChild(photoBox);
    var photoLabel = document.createElement('div');
    photoLabel.textContent = 'Photo';
    photoLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    photoIcon.appendChild(photoLabel);
    iconRow.appendChild(photoIcon);
  }
  
  var countryVal = findData(['country', 'Country']);
  if (countryVal && String(countryVal).trim() !== '') {
    hasAnyIcon = true;
    var flagIcon = document.createElement('div');
    flagIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    var flagEmoji = document.createElement('div');
    flagEmoji.textContent = getFlag(countryVal);
    flagEmoji.style.cssText = 'width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:36px;background:#f8fafc;border:2px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.05)';
    flagIcon.appendChild(flagEmoji);
    var flagLabel = document.createElement('div');
    flagLabel.textContent = countryVal;
    flagLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    flagIcon.appendChild(flagLabel);
    iconRow.appendChild(flagIcon);
  }
  
  var sexVal = findData(['sex', 'Sex', 'gender', 'Gender']);
  if (sexVal && String(sexVal).trim() !== '') {
    var genderIcon = getGenderIcon(sexVal);
    if (genderIcon) {
      hasAnyIcon = true;
      var genderIconEl = document.createElement('div');
      genderIconEl.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
      var genderEmoji = document.createElement('div');
      genderEmoji.textContent = genderIcon;
      genderEmoji.style.cssText = 'width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:36px;background:#f8fafc;border:2px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.05)';
      genderIconEl.appendChild(genderEmoji);
      var genderLabel = document.createElement('div');
      genderLabel.textContent = sexVal;
      genderLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
      genderIconEl.appendChild(genderLabel);
      iconRow.appendChild(genderIconEl);
    }
  }
  
  var birthdayVal = findData(['birthday', 'Birthday', 'date of birth', 'Date of Birth', 'dob', 'DOB', 'birth_date']);
  if (birthdayVal && String(birthdayVal).trim() !== '') {
    var age = calculateAge(birthdayVal);
    if (age !== null) {
      hasAnyIcon = true;
      var ageIconWrap = document.createElement('div');
      ageIconWrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
      var ageEmoji = document.createElement('div');
      ageEmoji.textContent = age;
      ageEmoji.style.cssText = 'width:60px;height:60px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:2px solid #667eea;box-shadow:0 2px 8px rgba(102,126,234,0.2)';
      ageIconWrap.appendChild(ageEmoji);
      var ageLabel = document.createElement('div');
      ageLabel.textContent = 'Age';
      ageLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
      ageIconWrap.appendChild(ageLabel);
      iconRow.appendChild(ageIconWrap);
    }
  }
  
  if (hasAnyIcon) container.appendChild(iconRow);
  
  // === SECTIONS WITH TABS ===
  var sections = profilingData.fieldConfig._sections || {'General': Object.keys(profilingData.fieldConfig).filter(function(k) { return k !== '_order' && k !== '_sections'; })};
  var sectionNames = Object.keys(sections);
  
  if (sectionNames.length > 1) {
    var tabsRow = document.createElement('div');
    tabsRow.style.cssText = 'display:flex;gap:0;border-bottom:2px solid #e2e8f0;background:#f8fafc;padding:0 20px;overflow-x:auto;flex-shrink:0';
    sectionNames.forEach(function(sectionName, index) {
      var tab = document.createElement('button');
      tab.textContent = sectionName;
      tab.className = 'section-tab';
      tab.style.cssText = 'padding:14px 24px;border:none;background:transparent;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s;white-space:nowrap';
      if (index === 0) {
        tab.style.borderBottomColor = '#667eea';
        tab.style.color = '#667eea';
        profilingData.activeSection = sectionName;
      }
      tab.onclick = function() {
        document.querySelectorAll('.section-tab').forEach(function(t) {
          t.style.borderBottomColor = 'transparent'; t.style.color = '#64748b';
        });
        this.style.borderBottomColor = '#667eea'; this.style.color = '#667eea';
        profilingData.activeSection = sectionName;
        renderSectionContent(sectionName, sections[sectionName], player, contentArea);
      };
      tabsRow.appendChild(tab);
    });
    container.appendChild(tabsRow);
  }
  
  var contentArea = document.createElement('div');
  contentArea.style.cssText = 'flex:1;overflow-y:auto;padding:24px';
  if (sectionNames.length > 0) {
    renderSectionContent(sectionNames[0], sections[sectionNames[0]], player, contentArea);
  }
  container.appendChild(contentArea);
}

function showProfilingView() {
  if (!profilingData.managers) profilingData.managers = [];
  if (!profilingData.allPlayers) profilingData.allPlayers = [];
  
  document.querySelectorAll('.nav-item').forEach(function(i) { i.classList.remove('active'); });
  document.querySelectorAll('.content').forEach(function(c) { c.classList.remove('active'); });
  document.getElementById('profiling-view').classList.add('active');
  
  if (!window.profilingInitialized || profilingData.allPlayers.length === 0) {
    initializePlayerProfiling();
    window.profilingInitialized = true;
  }
}

// Player Profiling - Global State
var profilingData = {
  allPlayers: [],
  managers: [],
  activeManager: null,
  viewMode: 'grid',
  selectedPlayer: null,
  fieldConfig: {},
  searchQuery: '',
  typeFilter: 'ALL',
  sortAlpha: false,
  sortField: null,
  sortDirection: 'desc',
  attentionRules: []
};

/**
 * Get country flag emoji
 */
function getFlag(countryCode) {
  if (!countryCode) return 'üåê';
  
  const code = String(countryCode).toUpperCase();
  const flagMap = {
    'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™',
    'FR': 'üá´üá∑', 'ES': 'üá™üá∏', 'IT': 'üáÆüáπ', 'BR': 'üáßüá∑', 'MX': 'üá≤üáΩ',
    'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IN': 'üáÆüá≥', 'RU': 'üá∑üá∫', 'KR': 'üá∞üá∑',
    'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞', 'FI': 'üá´üáÆ',
    'PL': 'üáµüá±', 'UA': 'üá∫üá¶', 'CZ': 'üá®üáø', 'AT': 'üá¶üáπ', 'CH': 'üá®üá≠',
    'BE': 'üáßüá™', 'PT': 'üáµüáπ', 'GR': 'üá¨üá∑', 'TR': 'üáπüá∑', 'IL': 'üáÆüá±',
    'SA': 'üá∏üá¶', 'AE': 'üá¶üá™', 'EG': 'üá™üá¨', 'ZA': 'üáøüá¶', 'NG': 'üá≥üá¨',
    'KE': 'üá∞üá™', 'AR': 'üá¶üá∑', 'CL': 'üá®üá±', 'CO': 'üá®üá¥', 'PE': 'üáµüá™',
    'VE': 'üáªüá™', 'TH': 'üáπüá≠', 'VN': 'üáªüá≥', 'ID': 'üáÆüá©', 'MY': 'üá≤üáæ',
    'SG': 'üá∏üá¨', 'PH': 'üáµüá≠', 'NZ': 'üá≥üáø', 'IE': 'üáÆüá™', 'HK': 'üá≠üá∞'
  };
  
  return flagMap[code] || 'üåê';
}

/**
 * Get gender icon
 */
function getGenderIcon(gender) {
  if (!gender) return 'üë§';
  
  const g = String(gender).toLowerCase();
  if (g === 'm' || g === 'male') return 'üë®';
  if (g === 'f' || g === 'female') return 'üë©';
  return 'üë§';
}

/**
 * Find player in Profiling by email
 */
function findProfilingPlayerByEmail(email) {
  if (!email || !profilingData || !profilingData.allPlayers) return null;
  
  var lowerEmail = email.toLowerCase();
  for (var i = 0; i < profilingData.allPlayers.length; i++) {
    var player = profilingData.allPlayers[i];
    if (player.data && player.data.email && player.data.email.toLowerCase() === lowerEmail) {
      return player;
    }
  }
  
  return null;
}

/**
 * Find VIP player by email
 */
function findVIPPlayerByEmail(email) {
  if (!email || !vipAllPlayers) return null;
  
  var allPlayers = (vipAllPlayers.vip || []).concat(vipAllPlayers.silentVip || []);
  
  for (var i = 0; i < allPlayers.length; i++) {
    if (allPlayers[i].email && allPlayers[i].email.toLowerCase() === email.toLowerCase()) {
      return allPlayers[i];
    }
  }
  
  return null;
}

/**
 * Get social media icon
 */
function getSocialIcon(fieldName) {
  var name = fieldName.toLowerCase();
  
  // Font Awesome icon classes
  var icons = {
    'whatsapp': 'fa-brands fa-whatsapp',
    'telegram': 'fa-brands fa-telegram',
    'signal': 'fas fa-lock',  // Signal doesn't have brand icon
    'messenger': 'fa-brands fa-facebook-messenger',
    'facebook': 'fa-brands fa-facebook',
    'instagram': 'fa-brands fa-instagram',
    'intercom': 'fas fa-comment-dots',
    'viber': 'fa-brands fa-viber',
    'wechat': 'fa-brands fa-weixin',
    'twitter': 'fa-brands fa-twitter',
    'x': 'fa-brands fa-x-twitter',
    'linkedin': 'fa-brands fa-linkedin',
    'tiktok': 'fa-brands fa-tiktok',
    'snapchat': 'fa-brands fa-snapchat',
    'discord': 'fa-brands fa-discord',
    'skype': 'fa-brands fa-skype',
    'reddit': 'fa-brands fa-reddit',
    'youtube': 'fa-brands fa-youtube',
    'twitch': 'fa-brands fa-twitch',
    'pinterest': 'fa-brands fa-pinterest',
    'vk': 'fa-brands fa-vk',
    'line': 'fa-brands fa-line'
  };
  
  for (var key in icons) {
    if (name.indexOf(key) !== -1) {
      return icons[key];
    }
  }
  
  return 'fas fa-link';  // Default link icon
}

/**
 * Get big icon for [BICON] fields
 */
function getBigIcon(fieldName) {
  var name = fieldName.toLowerCase();
  
  // Big icons mapping
  var icons = {
    'bo': 'fas fa-user-shield',           // Back Office
    'jira': 'fab fa-jira',                // JIRA
    'backoffice': 'fas fa-user-shield',
    'back office': 'fas fa-user-shield'
  };
  
  for (var key in icons) {
    if (name.indexOf(key) !== -1) {
      return icons[key];
    }
  }
  
  return 'fas fa-external-link-alt';
}

/**
 * Get big icon links from player data
 */
function getBigIconLinks(player, fieldConfig) {
  var links = [];
  
  Object.keys(fieldConfig).forEach(function(key) {
    var field = fieldConfig[key];
    if (!field || !field.label) return;
    
    // Check if field label starts with [BICON]
    if (field.label.indexOf('[BICON]') === 0) {
      var value = player.data[key];
      if (value && value.trim() !== '' && value !== 'false') {
        // Extract platform name
        var platformName = field.label.replace('[BICON]', '').trim().split(' ')[0];
        
        links.push({
          platform: platformName,
          url: value,
          icon: getBigIcon(platformName),
          key: key
        });
      }
    }
  });
  
  return links;
}

/**
 * Extract social media links from player data
 */
function getSocialLinks(player, fieldConfig) {
  var links = [];
  
  Object.keys(fieldConfig).forEach(function(key) {
    var field = fieldConfig[key];
    if (!field || !field.label) return;
    
    // Check if field label starts with [ICON]
    if (field.label.indexOf('[ICON]') === 0) {
      var value = player.data[key];
      if (value && value.trim() !== '' && value !== 'false') {
        // Extract platform name - clean label without [ICON]
        var cleanLabel = field.label.replace('[ICON]', '').trim();
        var platformName = cleanLabel.split(' ')[0];
        
        links.push({
          platform: platformName,
          url: value,
          icon: getSocialIcon(platformName),
          key: key,
          cleanLabel: cleanLabel  // Store clean label without [ICON]
        });
      }
    }
  });
  
  return links;
}

/**
 * Calculate age from DOB
 */
function calculateAge(dob) {
  if (!dob) return null;
  
  var birthDate;
  
  // Parse different date formats
  if (typeof dob === 'string') {
    // DD.MM.YYYY format
    if (dob.indexOf('.') !== -1) {
      var parts = dob.split('.');
      if (parts.length === 3) {
        birthDate = new Date(parts[2], parts[1] - 1, parts[0]);
      }
    }
    // YYYY-MM-DD format
    else if (dob.indexOf('-') !== -1) {
      birthDate = new Date(dob);
    }
    else {
      birthDate = new Date(dob);
    }
  } else if (dob instanceof Date) {
    birthDate = dob;
  }
  
  if (!birthDate || isNaN(birthDate.getTime())) return null;
  
  var today = new Date();
  var age = today.getFullYear() - birthDate.getFullYear();
  var monthDiff = today.getMonth() - birthDate.getMonth();
  
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  return age;
}

function initializePlayerProfiling() {
  console.log('üöÄ Initializing Player Profiling...');
  
  // Check if data already loaded during splash
  if (profilingData.allPlayers && profilingData.allPlayers.length > 0) {
    console.log('‚úÖ Using preloaded Player Profiling data (' + profilingData.allPlayers.length + ' players)');
    fillProfilingTagsFromVIP();
    renderProfilingManagerTabs();
    populateTypeFilters();
    if (profilingData.managers.length > 0) {
      selectProfilingManager(profilingData.managers[0]);
    }
    return;
  }
  
  // Load data from Google Apps Script
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(data) {
        if (!data || data.error) {
          console.error('‚ùå Error:', data ? data.error : 'null');
          showProfilingEmptyState();
          return;
        }
        
        // Store MANAGER mapping
        if (data.managerMapping) {
          tagToManagerMap = data.managerMapping.tagToManager || {};
          managerMapping = data.managerMapping.managerMapping || {};
        }
        
        profilingData.allPlayers = wrapProfilingPlayers(data.players || []);
        profilingData.managers = Object.keys(managerMapping).sort();
        profilingData.fieldConfig = data.fieldConfig || {};
          profilingData.attentionRules = data.attentionRules || [];
        
        // ‚úÖ Fill missing tags from VIP data
        fillProfilingTagsFromVIP();
        
        console.log('üìä Loaded ' + profilingData.allPlayers.length + ' players, ' + profilingData.managers.length + ' managers');
        
        renderProfilingManagerTabs();
        populateTypeFilters();
        
        if (profilingData.managers.length > 0) {
          selectProfilingManager(profilingData.managers[0]);
        } else {
          showProfilingEmptyState();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load Player Profiling data:', error);
        showProfilingEmptyState();
      })
      .getPlayerProfilingData();
  } else {
    showProfilingEmptyState();
  }
}

/**
 * Load profiling data during splash screen (returns Promise)
 */
/**
 * Get photo URL from player data - checks multiple possible column names
 */
function getPlayerPhoto(playerData) {
  if (!playerData) return '';
  var possibleKeys = ['photo', 'Photo', 'PHOTO', 'upload', 'Upload', 'UPLOAD', 
    'Photo (Main Info)', 'Upload (Main Info)', 'photo (main info)'];
  for (var i = 0; i < possibleKeys.length; i++) {
    var val = playerData[possibleKeys[i]];
    if (val && typeof val === 'string' && val.trim() !== '' && val !== 'false') {
      return val.trim();
    }
  }
  // Also search all keys containing photo or upload
  var keys = Object.keys(playerData);
  for (var j = 0; j < keys.length; j++) {
    var k = keys[j].toLowerCase();
    if ((k.indexOf('photo') !== -1 || k.indexOf('upload') !== -1) && k.indexOf('icon') === -1 && k.indexOf('bicon') === -1) {
      var v = playerData[keys[j]];
      if (v && typeof v === 'string' && v.trim() !== '' && v !== 'false' && (v.indexOf('http') !== -1 || v.indexOf('drive.google') !== -1)) {
        return v.trim();
      }
    }
  }
  return '';
}

/**
 * Get manager name from player tags using MANAGER sheet mapping
 */
function getPlayerManagerFromTags(tags) {
  if (!tags || !tagToManagerMap || Object.keys(tagToManagerMap).length === 0) return '';
  
  var tagsArray = [];
  if (Array.isArray(tags)) {
    tagsArray = tags;
  } else if (typeof tags === 'string') {
    if (tags.trim().startsWith('[')) {
      try { tagsArray = JSON.parse(tags); } catch(e) { tagsArray = tags.split(',').map(function(t) { return t.trim(); }); }
    } else {
      tagsArray = tags.split(',').map(function(t) { return t.trim(); });
    }
  }
  
  for (var i = 0; i < tagsArray.length; i++) {
    var tag = String(tagsArray[i]).toLowerCase().trim();
    if (tagToManagerMap[tag]) return tagToManagerMap[tag];
  }
  return '';
}

/**
 * Wrap flat player objects from backend into {data: {...}, tags: [...]} format
 * Now takes flat array of players (not managers)
 */
function wrapProfilingPlayers(players) {
  if (!players || !Array.isArray(players)) return [];
  
  function normalizeKey(key) {
    var s = String(key);
    s = s.replace(/^\[.*?\]\s*/g, '');
    s = s.replace(/\s*\[.*?\]\s*$/g, '');
    s = s.replace(/^\*\s*/, '');
    s = s.replace(/\s*\(.*?\)\s*$/g, '');
    return s.trim().toLowerCase();
  }
  
  return players.map(function(player) {
    if (player._originalKeys) return player;
    
    var tags = player.tags || [];
    if (!Array.isArray(tags)) {
      if (typeof tags === 'string' && tags.trim()) {
        try {
          var parsed = JSON.parse(tags);
          tags = Array.isArray(parsed) ? parsed : [tags];
        } catch(e) {
          tags = tags.trim() ? [tags] : [];
        }
      } else {
        tags = [];
      }
    }
    
    var data = {};
    var originalKeys = Object.keys(player).filter(function(k) { return k !== '_rowIndex' && k !== 'tags'; });
    
    originalKeys.forEach(function(key) {
      data[key] = player[key];
      var norm = normalizeKey(key);
      if (norm && norm !== key.toLowerCase().trim() && data[norm] === undefined) {
        data[norm] = player[key];
      }
      var lower = key.toLowerCase().trim();
      if (lower !== key && data[lower] === undefined) {
        data[lower] = player[key];
      }
    });
    
    data.tags = tags;
    
    if (!data.photo) {
      var photoUrl = getPlayerPhoto(data);
      if (photoUrl) data.photo = photoUrl;
    }
    
    return {
      data: data,
      tags: tags,
      _originalKeys: originalKeys,
      rowIndex: player._rowIndex || null,
      sheetName: 'PROFILING'
    };
  });
}

/**
 * Fill missing tags in profiling players from VIP data (cross-reference by email)
 */
function fillProfilingTagsFromVIP() {
  console.log('üîÑ fillProfilingTagsFromVIP called');
  console.log('  - profilingData.allPlayers:', profilingData.allPlayers ? profilingData.allPlayers.length : 'null');
  console.log('  - window.vipAllPlayers:', window.vipAllPlayers ? 'exists' : 'null');
  
  if (!profilingData.allPlayers) return;
  
  // Build email ‚Üí tags map from VIP data
  var emailTagsMap = {};
  
  // Source 1: vipAllPlayers
  if (window.vipAllPlayers) {
    var vipSources = Object.keys(vipAllPlayers);
    console.log('  - VIP sources:', vipSources);
    vipSources.forEach(function(src) {
      var arr = vipAllPlayers[src];
      if (!arr || !Array.isArray(arr)) return;
      var count = 0;
      arr.forEach(function(p) {
        var email = (p.email || '').toLowerCase().trim();
        if (email && p.tags) {
          var tags = p.tags;
          if (typeof tags === 'string') {
            try { tags = JSON.parse(tags); } catch(e) { tags = [tags]; }
          }
          if (Array.isArray(tags) && tags.length > 0) {
            emailTagsMap[email] = tags;
            count++;
          }
        }
      });
      console.log('  - Source "' + src + '": ' + (arr.length || 0) + ' players, ' + count + ' with tags');
    });
  }
  
  // Source 2: allPlayersData (global retention data)
  if (window.allPlayersData && Array.isArray(allPlayersData)) {
    var retentionCount = 0;
    allPlayersData.forEach(function(p) {
      var email = (p.email || '').toLowerCase().trim();
      if (email && p.tags && !emailTagsMap[email]) {
        var tags = p.tags;
        if (typeof tags === 'string') {
          try { tags = JSON.parse(tags); } catch(e) { tags = [tags]; }
        }
        if (Array.isArray(tags) && tags.length > 0) {
          emailTagsMap[email] = tags;
          retentionCount++;
        }
      }
    });
    console.log('  - allPlayersData: added ' + retentionCount + ' more tag mappings');
  }
  
  console.log('  - Total email‚Üítags mappings: ' + Object.keys(emailTagsMap).length);
  
  // Sample first 3
  var sample = Object.entries(emailTagsMap).slice(0, 3);
  console.log('  - Sample:', sample);
  
  var filled = 0;
  var noMatch = 0;
  profilingData.allPlayers.forEach(function(player) {
    if (!player.tags || player.tags.length === 0) {
      var email = (player.data.email || '').toLowerCase().trim();
      var vipTags = emailTagsMap[email];
      if (vipTags) {
        player.tags = vipTags;
        player.data.tags = vipTags;
        filled++;
      } else {
        noMatch++;
      }
    }
  });
  
  console.log('‚úÖ fillProfilingTagsFromVIP result: filled=' + filled + ', noMatch=' + noMatch + ', alreadyHadTags=' + (profilingData.allPlayers.length - filled - noMatch));
}

function loadProfilingData() {
  return new Promise((resolve) => {
    console.log('üì• Preloading Player Profiling data...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('‚úÖ Player Profiling data preloaded');
          
          if (!data) {
            console.error('‚ùå Backend returned null/undefined');
            profilingData.allPlayers = [];
            profilingData.managers = [];
            profilingData.fieldConfig = {};
            resolve();
            return;
          }
          
          // ‚úÖ Store MANAGER mapping
          if (data.managerMapping) {
            console.log('üìä Raw managerMapping from backend:', JSON.stringify(data.managerMapping).substring(0, 500));
            tagToManagerMap = data.managerMapping.tagToManager || {};
            managerMapping = data.managerMapping.managerMapping || {};
            console.log('üìä Manager mapping:', Object.keys(managerMapping), 'Tags:', Object.keys(tagToManagerMap));
          } else {
            console.warn('‚ö†Ô∏è No managerMapping in backend response!');
          }
          
          // ‚úÖ Wrap flat player list
          profilingData.allPlayers = wrapProfilingPlayers(data.players || []);
          console.log('üìä Loaded ' + profilingData.allPlayers.length + ' players');
          
          // ‚úÖ Build managers list from MANAGER sheet mapping
          profilingData.managers = Object.keys(managerMapping).sort();
          console.log('üìä Managers from MANAGER sheet:', profilingData.managers);
          
          profilingData.fieldConfig = data.fieldConfig || {};
          profilingData.attentionRules = data.attentionRules || [];
          
          // ‚úÖ Fill missing tags from VIP data
          fillProfilingTagsFromVIP();
          
          resolve();
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Failed to load Player Profiling:', error);
          profilingData.allPlayers = [];
          profilingData.managers = [];
          profilingData.fieldConfig = {};
          resolve();
        })
        .getPlayerProfilingData();
    } else {
      console.warn('‚ö†Ô∏è Google Script not available');
      resolve();
    }
  });
}

/**
 * Reload profiling data (after photo upload)
 */
function reloadProfilingData() {
  console.log('üîÑ Reloading Player Profiling data...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(data) {
        if (!data || data.error) {
          console.error('‚ùå Reload error:', data ? data.error : 'null');
          return;
        }
        
        if (data.managerMapping) {
          tagToManagerMap = data.managerMapping.tagToManager || {};
          managerMapping = data.managerMapping.managerMapping || {};
        }
        
        profilingData.allPlayers = wrapProfilingPlayers(data.players || []);
        profilingData.managers = Object.keys(managerMapping).sort();
        profilingData.fieldConfig = data.fieldConfig || {};
          profilingData.attentionRules = data.attentionRules || [];
        
        fillProfilingTagsFromVIP();
        
        console.log('üìä Reloaded ' + profilingData.allPlayers.length + ' players');
        
        if (profilingData.activeManager) {
          renderProfilingPlayers();
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Failed to reload:', error);
      })
      .getPlayerProfilingData();
  }
}

function showProfilingEmptyState() {
  var container = document.getElementById('profilingPlayersContainer');
  var emptyState = document.getElementById('profilingEmptyState');
  
  if (container) container.style.display = 'none';
  if (emptyState) emptyState.style.display = 'block';
}

function renderProfilingManagerTabs() {
  var container = document.getElementById('profilingManagerTabs');
  if (!container) return;
  
  container.innerHTML = '';
  
  profilingData.managers.forEach(function(managerName) {
    var count = countPlayersForManager(managerName);
    var isActive = managerName === profilingData.activeManager;
    
    var tab = document.createElement('button');
    tab.className = 'manager-tab' + (isActive ? ' active' : '');
    tab.style.cssText = 'padding:10px 20px;margin-right:6px;border-radius:10px;background:' + (isActive ? 'rgba(102,126,234,0.15)' : 'transparent') + ';border:1px solid ' + (isActive ? 'rgba(102,126,234,0.3)' : '#e2e8f0') + ';color:' + (isActive ? '#667eea' : '#64748b') + ';font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;white-space:nowrap;display:flex;align-items:center;gap:8px';
    
    var nameSpan = document.createElement('span');
    nameSpan.textContent = managerName;
    tab.appendChild(nameSpan);
    
    var badge = document.createElement('span');
    badge.textContent = count;
    badge.style.cssText = 'font-size:11px;font-weight:800;min-width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:11px;padding:0 6px;background:' + (isActive ? 'rgba(102,126,234,0.2)' : 'rgba(100,116,139,0.12)') + ';color:' + (isActive ? '#667eea' : '#64748b');
    tab.appendChild(badge);
    
    tab.onclick = function() { selectProfilingManager(managerName); };
    container.appendChild(tab);
  });
}

/**
 * Count newcomers: VIP or SILENT VIP players with empty JIRA link
 */
function countNewcomers() {
  if (!profilingData || !profilingData.allPlayers) return 0;
  return profilingData.allPlayers.filter(function(p) { return isNewcomer(p); }).length;
}

/**
 * Check if player matches any ATTENTION rule by tags
 * Returns matching rule {error, message, color} or null
 */
function getPlayerAttention(player) {
  try {
    var rules = profilingData.attentionRules || [];
    if (!rules.length) return null;
    
    var playerTags = (player.tags || []).map(function(t) { return String(t || '').toLowerCase().trim(); });
    if (!playerTags.length) return null;
    
    for (var r = 0; r < rules.length; r++) {
      var rule = rules[r];
      var ruleTags = rule.tags || [];
      for (var t = 0; t < ruleTags.length; t++) {
        if (playerTags.indexOf(ruleTags[t]) !== -1) {
          return rule;
        }
      }
    }
  } catch(e) { console.error('getPlayerAttention error:', e); }
  return null;
}

/**
 * Check if player is a newcomer (VIP/SILENT VIP + no JIRA link)
 */
function isNewcomer(player) {
  try {
    var type = getPlayerType(player);
    if (!type) return false;
    var t = String(type).toUpperCase();
    if (t !== 'VIP' && t !== 'SILENT VIP') return false;
    
    // Check if JIRA [BICON] field is empty
    var jiraEmpty = true;
    if (profilingData.fieldConfig) {
      Object.keys(profilingData.fieldConfig).forEach(function(key) {
        if (key.charAt(0) === '_') return;
        var field = profilingData.fieldConfig[key];
        if (field && field.label && field.label.indexOf('[BICON]') === 0 && field.label.toLowerCase().indexOf('jira') !== -1) {
          var val = player.data[key];
          if (val && String(val).trim() !== '' && val !== 'false') {
            jiraEmpty = false;
          }
        }
      });
    }
    
    return jiraEmpty;
  } catch(e) { console.error('isNewcomer error:', e); return false; }
}

/**
 * Count newcomers within current active manager
 */
function countNewcomersForManager() {
  try {
    var mgrName = profilingData.activeManager;
    var mgrTags = managerMapping[mgrName] || [];
    if (!mgrTags.length || !profilingData.allPlayers) return 0;
    
    return profilingData.allPlayers.filter(function(player) {
      var playerTags = (player.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
      var inManager = false;
      for (var i = 0; i < playerTags.length; i++) {
        if (mgrTags.indexOf(playerTags[i]) !== -1) { inManager = true; break; }
      }
      return inManager && isNewcomer(player);
    }).length;
  } catch(e) { console.error('countNewcomersForManager error:', e); return 0; }
}

/**
 * Count players belonging to a manager (by tag matching)
 */
function countPlayersForManager(mgrName) {
  var mgrTags = managerMapping[mgrName] || [];
  if (!mgrTags.length || !profilingData.allPlayers) return 0;
  return profilingData.allPlayers.filter(function(player) {
    var playerTags = (player.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    var inManager = false;
    for (var i = 0; i < playerTags.length; i++) {
      if (mgrTags.indexOf(playerTags[i]) !== -1) { inManager = true; break; }
    }
    if (!inManager) return false;
    // Apply dynamic sidebar filters
    var keys = Object.keys(profilingFilters);
    for (var k = 0; k < keys.length; k++) {
      var fKey = keys[k];
      if (profilingFilters[fKey].length === 0) continue;
      var val = String(player.data[fKey] || '').trim();
      if (profilingFilters[fKey].indexOf(val) === -1) return false;
    }
    return true;
  }).length;
}

/**
 * Count players for a type within current manager
 */
function countPlayersForType(typeName) {
  var mgrName = profilingData.activeManager;
  if (!profilingData.allPlayers) return 0;
  
  var mgrTags = managerMapping[mgrName] || [];
  if (!mgrTags.length) return 0;
  
  var basePlayers = profilingData.allPlayers.filter(function(player) {
    var playerTags = (player.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    for (var i = 0; i < playerTags.length; i++) {
      if (mgrTags.indexOf(playerTags[i]) !== -1) return true;
    }
    return false;
  });
  
  return basePlayers.filter(function(player) {
    if (typeName === '__NEWCOMERS__') return isNewcomer(player);
    if (typeName !== 'ALL') {
      var type = getPlayerType(player);
      if (type !== typeName) return false;
    }
    // Apply dynamic sidebar filters
    var keys = Object.keys(profilingFilters);
    for (var k = 0; k < keys.length; k++) {
      var fKey = keys[k];
      if (profilingFilters[fKey].length === 0) continue;
      var val = String(player.data[fKey] || '').trim();
      if (profilingFilters[fKey].indexOf(val) === -1) return false;
    }
    return true;
  }).length;
}

function selectProfilingManager(managerName) {
  console.log('üéØ selectProfilingManager called with:', managerName);
  profilingData.activeManager = managerName;
  profilingData.typeFilter = 'ALL'; // Reset type filter
  
  renderProfilingManagerTabs();
  populateTypeFilters(); // Re-populate with new newcomers count
  
  renderProfilingPlayers();
}

/**
 * Update count badges on type tabs (called when manager changes)
 */
function updateTypeTabCounts() {
  document.querySelectorAll('.profiling-type-tab').forEach(function(tab) {
    var type = tab.getAttribute('data-type');
    if (!type) return;
    var count = 0;
    if (type === '__NEWCOMERS__') count = countNewcomersForManager();
    else if (type.indexOf('__TOTAL__:') === 0) count = countPlayersForTotalGroup(type.replace('__TOTAL__:', ''));
    else count = countPlayersForType(type);
    var badge = tab.querySelector('span');
    if (badge) badge.textContent = count;
  });
}

function renderProfilingPlayers() {
  var container = document.getElementById('profilingPlayersContainer');
  var emptyState = document.getElementById('profilingEmptyState');
  
  if (!container) return;
  
  container.innerHTML = '';
  if (emptyState) emptyState.style.display = 'none';
  
  // ‚úÖ Filter allPlayers by active manager using MANAGER sheet tag mapping
  var managerName = profilingData.activeManager;
  var managerTags = managerMapping[managerName] || [];
  
  var players = (profilingData.allPlayers || []).filter(function(player) {
    if (!managerTags.length) return false;
    var playerTags = (player.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    for (var i = 0; i < playerTags.length; i++) {
      if (managerTags.indexOf(playerTags[i]) !== -1) return true;
    }
    return false;
  });
  console.log('üîç Manager filter:', players.length, 'matched');
  
  // Apply type filter
  if (profilingData.typeFilter === '__NEWCOMERS__') {
    players = players.filter(function(player) { return isNewcomer(player); });
  } else if (profilingData.typeFilter && profilingData.typeFilter.indexOf('__TOTAL__:') === 0) {
    var groupName = profilingData.typeFilter.replace('__TOTAL__:', '');
    var groupTypes = totalGroups[groupName] || [];
    players = players.filter(function(player) {
      var type = getPlayerType(player);
      return groupTypes.indexOf(type) !== -1;
    });
  } else if (profilingData.typeFilter && profilingData.typeFilter !== 'ALL') {
    players = players.filter(function(player) {
      var type = getPlayerType(player);
      return type === profilingData.typeFilter;
    });
  }
  
  // Apply search filter
  if (profilingData.searchQuery) {
    players = players.filter(function(player) {
      var keys = player._originalKeys || Object.keys(player.data);
      var searchText = keys.map(function(k) { return String(player.data[k] || ''); }).join(' ').toLowerCase();
      return searchText.includes(profilingData.searchQuery);
    });
  }
  
  // Apply sidebar filters (dynamic from * fields)
  var hasActiveFilters = false;
  Object.keys(profilingFilters).forEach(function(k) { if (profilingFilters[k].length > 0) hasActiveFilters = true; });
  
  if (hasActiveFilters) {
    players = players.filter(function(player) {
      var keys = Object.keys(profilingFilters);
      for (var i = 0; i < keys.length; i++) {
        var fKey = keys[i];
        if (profilingFilters[fKey].length === 0) continue;
        var val = String(player.data[fKey] || '').trim();
        if (profilingFilters[fKey].indexOf(val) === -1) return false;
      }
      return true;
    });
  }
  
  if (players.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#64748b"><div style="font-size:48px;margin-bottom:12px">üîç</div><div style="font-size:16px;font-weight:600">No players found</div></div>';
    return;
  }
  
  // Sort based on selected field
  var sortField = profilingData.sortField;
  if (sortField === 'alpha' || profilingData.sortAlpha) {
    players.sort(function(a, b) {
      var nameA = (a.data.name || a.data.email || '').toLowerCase();
      var nameB = (b.data.name || b.data.email || '').toLowerCase();
      return nameA.localeCompare(nameB);
    });
  } else if (sortField === 'reg_date' || sortField === 'last_deposit' || sortField === 'vip_date') {
    var searchTerms = {
      'reg_date': ['registration date', 'reg_date', 'registration'],
      'last_deposit': ['last time deposit', 'last_deposit', 'last deposit', 'lastdeposit'],
      'vip_date': ['vip confirmation date', 'vip_confirmation_date', 'vip date', 'vip_date']
    };
    var terms = searchTerms[sortField] || [];
    
    players.sort(function(a, b) {
      var valA = findFieldValue(a.data, terms);
      var valB = findFieldValue(b.data, terms);
      var dateA = parseDateField(valA);
      var dateB = parseDateField(valB);
      return profilingData.sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
    });
  }
  
  // === RENDER based on view mode ===
  if (profilingData.viewMode === 'table') {
    container.style.display = 'block';
    container.style.gridTemplateColumns = '';
    container.style.gap = '';
    renderProfilingTable(players, container);
  } else {
    var isListView = profilingData.viewMode === 'list';
    container.style.display = 'grid';
    if (isListView) {
      container.style.gridTemplateColumns = '1fr';
      container.style.gap = '4px';
    } else {
      container.style.gridTemplateColumns = 'repeat(auto-fill,minmax(280px,1fr))';
      container.style.gap = '12px';
    }
    players.forEach(function(player) {
      var card = createProfilingPlayerCard(player, isListView);
      container.appendChild(card);
    });
  }
}

/**
 * Render profiling players as a table
 */
// Table view state
var profilingTableState = {
  sortKey: null,
  sortDir: 'asc',
  columnOrder: null,
  dragCol: null,
  hiddenCols: {} // key ‚Üí true if hidden
};

function renderProfilingTable(players, container) {
  if (!players.length) return;
  
  var defaultColKeys = [];
  var colLabels = {};
  var colFieldInfo = {};
  var order = profilingData.fieldConfig._order || [];
  
  order.forEach(function(key) {
    if (key.charAt(0) === '_') return;
    var field = profilingData.fieldConfig[key];
    if (!field) return;
    var lbl = (field.label || key).toLowerCase();
    if (lbl === 'tags' || lbl === 'tag') return;
    if (field.label && field.label.indexOf('[ICON]') === 0) return;
    if (field.label && field.label.indexOf('[BICON]') === 0) return;
    if (lbl.indexOf('upload') !== -1 || lbl.indexOf('_last_') !== -1 || key.charAt(0) === '_') return;
    defaultColKeys.push(key);
    colLabels[key] = field.label.replace(/\[PREV\]/g,'').replace(/^\*\s*/,'').trim();
    colFieldInfo[key] = field;
  });
  defaultColKeys.unshift('__type__');
  colLabels['__type__'] = 'Type';
  colFieldInfo['__type__'] = { type: 'text' };
  
  var colKeys;
  if (profilingTableState.columnOrder && profilingTableState.columnOrder.length === defaultColKeys.length) {
    colKeys = profilingTableState.columnOrder;
  } else {
    colKeys = defaultColKeys.slice();
    profilingTableState.columnOrder = colKeys.slice();
  }
  
  var visibleCols = colKeys.filter(function(k) { return !profilingTableState.hiddenCols[k]; });
  
  // Sort
  var sortedPlayers = players.slice();
  if (profilingTableState.sortKey) {
    var sk = profilingTableState.sortKey;
    var sd = profilingTableState.sortDir;
    var isDateCol = sk !== '__type__' && (
      (colFieldInfo[sk] && colFieldInfo[sk].type === 'date') ||
      (colLabels[sk] && colLabels[sk].toLowerCase().indexOf('date') !== -1)
    );
    
    sortedPlayers.sort(function(a, b) {
      var va, vb;
      if (sk === '__type__') {
        va = (getPlayerType(a) || '').toLowerCase();
        vb = (getPlayerType(b) || '').toLowerCase();
      } else {
        va = String(a.data[sk] || '');
        vb = String(b.data[sk] || '');
      }
      if (isDateCol) {
        var da = parseDateField(va) || 0;
        var db = parseDateField(vb) || 0;
        return sd === 'asc' ? da - db : db - da;
      }
      var na = parseFloat(va), nb = parseFloat(vb);
      if (!isNaN(na) && !isNaN(nb) && va.trim() !== '' && vb.trim() !== '') {
        return sd === 'asc' ? na - nb : nb - na;
      }
      var da2 = parseDateField(va), db2 = parseDateField(vb);
      if (da2 && db2) return sd === 'asc' ? da2 - db2 : db2 - da2;
      va = va.toLowerCase(); vb = vb.toLowerCase();
      if (va < vb) return sd === 'asc' ? -1 : 1;
      if (va > vb) return sd === 'asc' ? 1 : -1;
      return 0;
    });
  }
  
  // === TOOLBAR ===
  var toolbar = document.createElement('div');
  toolbar.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap';
  
  // Column filter
  var colFilterWrap = document.createElement('div');
  colFilterWrap.style.cssText = 'position:relative';
  var colFilterBtn = document.createElement('button');
  var hiddenCount = Object.keys(profilingTableState.hiddenCols).filter(function(k) { return profilingTableState.hiddenCols[k]; }).length;
  colFilterBtn.innerHTML = 'üîß Columns' + (hiddenCount ? ' <span style="background:#ef4444;color:#fff;font-size:10px;padding:1px 5px;border-radius:8px">' + hiddenCount + ' hidden</span>' : '');
  colFilterBtn.style.cssText = 'padding:8px 14px;background:rgba(102,126,234,0.08);color:#667eea;border:1px solid rgba(102,126,234,0.2);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer';
  
  var colDropdown = document.createElement('div');
  colDropdown.style.cssText = 'display:none;position:absolute;top:100%;left:0;margin-top:4px;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.12);z-index:100;max-height:400px;overflow-y:auto;min-width:220px;padding:8px 0';
  
  var selectBar = document.createElement('div');
  selectBar.style.cssText = 'display:flex;gap:8px;padding:6px 12px;border-bottom:1px solid #f1f5f9;margin-bottom:4px';
  var allColBtn = document.createElement('button');
  allColBtn.textContent = 'Show All';
  allColBtn.style.cssText = 'padding:3px 10px;background:#667eea;color:#fff;border:none;border-radius:4px;font-size:11px;font-weight:700;cursor:pointer';
  allColBtn.onclick = function(e) { e.stopPropagation(); profilingTableState.hiddenCols = {}; renderProfilingPlayers(); };
  var minBtn = document.createElement('button');
  minBtn.textContent = 'Minimal';
  minBtn.style.cssText = 'padding:3px 10px;background:#f1f5f9;color:#64748b;border:none;border-radius:4px;font-size:11px;font-weight:700;cursor:pointer';
  minBtn.onclick = function(e) { e.stopPropagation(); colKeys.forEach(function(k, i) { if (i > 3) profilingTableState.hiddenCols[k] = true; }); renderProfilingPlayers(); };
  selectBar.appendChild(allColBtn);
  selectBar.appendChild(minBtn);
  colDropdown.appendChild(selectBar);
  
  colKeys.forEach(function(key) {
    var row = document.createElement('label');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 12px;cursor:pointer;font-size:12px;color:#334155;transition:background 0.1s';
    row.onmouseover = function() { this.style.background = '#f8fafc'; };
    row.onmouseout = function() { this.style.background = ''; };
    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !profilingTableState.hiddenCols[key];
    cb.style.cssText = 'width:14px;height:14px;accent-color:#667eea;cursor:pointer';
    cb.onchange = (function(k) { return function(e) { e.stopPropagation(); if (this.checked) delete profilingTableState.hiddenCols[k]; else profilingTableState.hiddenCols[k] = true; renderProfilingPlayers(); }; })(key);
    row.appendChild(cb);
    var txt = document.createElement('span');
    txt.textContent = colLabels[key];
    row.appendChild(txt);
    colDropdown.appendChild(row);
  });
  
  colFilterBtn.onclick = function(e) { e.stopPropagation(); colDropdown.style.display = colDropdown.style.display === 'none' ? 'block' : 'none'; };
  colFilterWrap.appendChild(colFilterBtn);
  colFilterWrap.appendChild(colDropdown);
  toolbar.appendChild(colFilterWrap);
  
  // Close dropdown on outside click
  document.addEventListener('click', function closeColDrop(e) {
    if (!colFilterWrap.contains(e.target)) colDropdown.style.display = 'none';
  });
  
  // Create Spreadsheet
  var exportBtn = document.createElement('button');
  exportBtn.innerHTML = 'üì§ Create Spreadsheet';
  exportBtn.style.cssText = 'padding:8px 14px;background:rgba(16,185,129,0.08);color:#059669;border:1px solid rgba(16,185,129,0.2);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s';
  exportBtn.onmouseover = function() { this.style.background = 'rgba(16,185,129,0.15)'; };
  exportBtn.onmouseout = function() { this.style.background = 'rgba(16,185,129,0.08)'; };
  exportBtn.onclick = function() { exportProfilingToSpreadsheet(sortedPlayers, visibleCols, colLabels); };
  toolbar.appendChild(exportBtn);
  
  var countLabel = document.createElement('span');
  countLabel.textContent = sortedPlayers.length + ' players \u00B7 ' + visibleCols.length + '/' + colKeys.length + ' columns';
  countLabel.style.cssText = 'font-size:11px;color:#94a3b8;font-weight:600;margin-left:auto';
  toolbar.appendChild(countLabel);
  container.appendChild(toolbar);
  
  // === TABLE ===
  var wrapper = document.createElement('div');
  wrapper.style.cssText = 'overflow-x:auto;border:1px solid #e2e8f0;border-radius:10px;background:#fff;max-height:70vh;overflow-y:auto';
  
  var table = document.createElement('table');
  table.style.cssText = 'width:100%;border-collapse:collapse;font-size:12px';
  
  var thead = document.createElement('thead');
  var headerRow = document.createElement('tr');
  headerRow.style.cssText = 'background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;position:sticky;top:0;z-index:2';
  
  visibleCols.forEach(function(key, colIdx) {
    var th = document.createElement('th');
    th.setAttribute('data-col', key);
    th.setAttribute('draggable', 'true');
    var isSorted = profilingTableState.sortKey === key;
    var isDateCol = key !== '__type__' && ((colFieldInfo[key] && colFieldInfo[key].type === 'date') || (colLabels[key] && colLabels[key].toLowerCase().indexOf('date') !== -1));
    var arrow = '';
    if (isSorted) {
      if (isDateCol) arrow = profilingTableState.sortDir === 'asc' ? ' \u2191Old' : ' \u2193New';
      else arrow = profilingTableState.sortDir === 'asc' ? ' \u25B2' : ' \u25BC';
    }
    th.textContent = colLabels[key] + arrow;
    th.style.cssText = 'padding:10px 12px;text-align:left;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;white-space:nowrap;border-bottom:2px solid rgba(255,255,255,0.2);cursor:pointer;user-select:none;transition:background 0.15s';
    if (isSorted) th.style.background = 'rgba(255,255,255,0.15)';
    th.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.1)'; };
    th.onmouseout = function() { this.style.background = isSorted ? 'rgba(255,255,255,0.15)' : ''; };
    th.onclick = function() {
      if (profilingTableState.sortKey === key) profilingTableState.sortDir = profilingTableState.sortDir === 'asc' ? 'desc' : 'asc';
      else { profilingTableState.sortKey = key; profilingTableState.sortDir = isDateCol ? 'desc' : 'asc'; }
      renderProfilingPlayers();
    };
    th.ondragstart = function(e) { profilingTableState.dragCol = colIdx; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', colIdx); this.style.opacity = '0.5'; };
    th.ondragend = function() { this.style.opacity = '1'; };
    th.ondragover = function(e) { e.preventDefault(); this.style.borderLeft = '3px solid #fbbf24'; };
    th.ondragleave = function() { this.style.borderLeft = ''; };
    th.ondrop = function(e) {
      e.preventDefault(); this.style.borderLeft = '';
      var from = profilingTableState.dragCol, to = colIdx;
      if (from === to) return;
      var c = profilingTableState.columnOrder.slice();
      var m = c.splice(from, 1)[0]; c.splice(to, 0, m);
      profilingTableState.columnOrder = c;
      renderProfilingPlayers();
    };
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  var tbody = document.createElement('tbody');
  sortedPlayers.forEach(function(player, idx) {
    var _att = null, _nc = false;
    try { _att = getPlayerAttention(player); } catch(e) {}
    try { _nc = isNewcomer(player); } catch(e) {}
    var tr = document.createElement('tr');
    var rowBg = idx % 2 === 0 ? '#fff' : '#f8fafc';
    if (_att) rowBg = hexToRgba(_att.color, 0.06);
    else if (_nc) rowBg = 'rgba(16,185,129,0.06)';
    tr.style.cssText = 'background:' + rowBg + ';transition:background 0.15s';
    tr.onmouseover = function() { this.style.background = 'rgba(102,126,234,0.06)'; };
    tr.onmouseout = function() { this.style.background = rowBg; };
    
    visibleCols.forEach(function(key) {
      var td = document.createElement('td');
      td.style.cssText = 'padding:6px 10px;border-bottom:1px solid #f1f5f9;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#334155;font-size:12px';
      if (key === '__type__') {
        var v = getPlayerType(player) || '';
        var tc = {'VIP':'#667eea','SILENT VIP':'#8b5cf6','PRE VIP':'#f59e0b','CHURNED VIP':'#ef4444'};
        td.style.color = tc[v.toUpperCase()] || '#64748b';
        td.style.fontWeight = '700';
        td.textContent = v;
        td.style.cursor = 'pointer';
        td.onclick = function() { openProfilingPlayer(player); };
      } else {
        var v = player.data[key] || '';
        td.textContent = v;
        if (v && String(v).indexOf('@') !== -1) {
          td.style.color = '#667eea'; td.style.cursor = 'copy'; td.title = 'Double-click to copy';
          td.ondblclick = function(e) { e.stopPropagation(); copyToClipboard(String(v)); };
        } else {
          td.style.cursor = 'text';
          td.onclick = (function(tdEl, fk, pr) { return function(e) {
            e.stopPropagation();
            if (tdEl.querySelector('input,select')) return;
            var fi = profilingData.fieldConfig[fk]; var cv = pr.data[fk] || ''; var inp;
            var cl = fi ? (fi.label || '').toLowerCase() : '';
            var isD = (fi && fi.type === 'date') || cl.indexOf('date') !== -1;
            if (fi && fi.type === 'dropdown' && fi.options) {
              inp = document.createElement('select');
              inp.style.cssText = 'width:100%;padding:4px 6px;border:2px solid #667eea;border-radius:4px;font-size:12px;background:#fff';
              var eo = document.createElement('option'); eo.value = ''; eo.textContent = '\u2014'; inp.appendChild(eo);
              fi.options.forEach(function(o) { var op = document.createElement('option'); op.value = o; op.textContent = o; if (o === cv) op.selected = true; inp.appendChild(op); });
            } else if (isD) {
              inp = document.createElement('input'); inp.type = 'date'; inp.value = formatDateForInput(cv);
              inp.style.cssText = 'width:100%;padding:4px 6px;border:2px solid #667eea;border-radius:4px;font-size:12px';
            } else {
              inp = document.createElement('input'); inp.type = 'text'; inp.value = cv;
              inp.style.cssText = 'width:100%;padding:4px 6px;border:2px solid #667eea;border-radius:4px;font-size:12px';
            }
            tdEl.textContent = ''; tdEl.appendChild(inp); inp.focus(); if (inp.select) inp.select();
            var commit = function() {
              var nv = inp.value;
              if (nv !== cv) { pr.data[fk] = nv; markProfilingDirty(); profilingData.selectedPlayer = pr; }
              tdEl.textContent = nv || '';
              tdEl.style.background = (!nv && fk.toLowerCase() !== 'id' && fk.charAt(0) !== '_') ? 'rgba(239,68,68,0.05)' : '';
            };
            inp.onblur = commit;
            inp.onkeydown = function(ev) { if (ev.key === 'Enter') inp.blur(); if (ev.key === 'Escape') { inp.value = cv; inp.blur(); } };
          }; })(td, key, player);
        }
        if (!v && key.toLowerCase() !== 'id' && key.charAt(0) !== '_') td.style.background = 'rgba(239,68,68,0.05)';
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrapper.appendChild(table);
  container.appendChild(wrapper);
}

function exportProfilingToSpreadsheet(players, colKeys, colLabels) {
  if (!players.length) { showToast('No players to export'); return; }
  var headers = colKeys.map(function(k) { return colLabels[k] || k; });
  var rows = players.map(function(p) {
    return colKeys.map(function(k) {
      if (k === '__type__') return getPlayerType(p) || '';
      return p.data[k] || '';
    });
  });
  showToast('\uD83D\uDCE4 Creating spreadsheet...');
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.url) { showToast('\u2705 Spreadsheet created!'); window.open(result.url, '_blank'); }
        else showToast('\u2705 Created! Check Google Drive');
      })
      .withFailureHandler(function(err) { showToast('\u274C Export failed'); console.error(err); })
      .exportProfilingToSheet(headers, rows);
  } else { showToast('\u274C Not available in preview'); }
}



/**
 * Get player type from various possible field names
 * Looks for: Type, type, Status, status, Type [PREV], Status [PREV], etc
 */
function getPlayerType(player) {
  if (!player) return '';
  
  // ‚úÖ ONLY use tags ‚Üí TYPE sheet mapping
  if (player.tags && player.tags.length > 0) {
    var playerType = getPlayerTypeFromTags(player.tags);
    if (playerType && playerType !== 'UNKNOWN') {
      return playerType;
    }
  }
  
  return '';
}

/**
 * Get all unique type values from all players
 */
function getAllTypeValues() {
  var typeSet = new Set();
  
  if (!profilingData || !profilingData.allPlayers) return [];
  
  profilingData.allPlayers.forEach(function(player) {
    var type = getPlayerType(player);
    if (type) typeSet.add(type);
  });
  
  return Array.from(typeSet).sort();
}

/**
 * Populate type filter dropdown and tabs
 */
function populateTypeFilters() {
  var types = [];
  if (window.typeMapping && Object.keys(typeMapping).length > 0) {
    types = Object.keys(typeMapping).sort();
  } else {
    types = getAllTypeValues();
  }
  
  // Populate dropdown
  var dropdown = document.getElementById('profilingTypeFilter');
  if (dropdown) {
    dropdown.innerHTML = '<option value="ALL">All Types</option>';
    types.forEach(function(type) {
      var option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      dropdown.appendChild(option);
    });
  }
  
  var tabsContainer = document.getElementById('profilingTypeTabs');
  if (!tabsContainer) return;
  tabsContainer.innerHTML = '';
  
  var hasTotalGroups = Object.keys(totalGroups).length > 0;
  
  // ‚îÄ‚îÄ ALL tab ‚îÄ‚îÄ
  var allCount = countPlayersForType('ALL');
  var allTab = createTypeTab('ALL', 'ALL', allCount, '#667eea');
  tabsContainer.appendChild(allTab);
  
  // ‚îÄ‚îÄ NEWCOMERS tab ‚îÄ‚îÄ
  try {
    var ncCount = countNewcomersForManager();
    var ncTab = createTypeTab('__NEWCOMERS__', 'üÜï New', ncCount, '#10b981');
    tabsContainer.appendChild(ncTab);
  } catch(e) {}
  
  if (hasTotalGroups) {
    // ‚îÄ‚îÄ TOTAL GROUP tabs ‚îÄ‚îÄ
    Object.keys(totalGroups).sort().forEach(function(groupName) {
      var groupTypes = totalGroups[groupName];
      var groupCount = countPlayersForTotalGroup(groupName);
      var tab = createTypeTab('__TOTAL__:' + groupName, groupName, groupCount, '#8b5cf6');
      tabsContainer.appendChild(tab);
    });
    
    // ‚îÄ‚îÄ Sub-tabs row ‚îÄ‚îÄ
    var subRow = document.createElement('div');
    subRow.id = 'profilingSubTypeTabs';
    subRow.style.cssText = 'display:none;gap:4px;padding:4px 0;flex-wrap:wrap;width:100%';
    tabsContainer.appendChild(subRow);
    
    // If a total group is active, show sub-tabs
    var activeFilter = profilingData.typeFilter || 'ALL';
    if (activeFilter.indexOf('__TOTAL__:') === 0) {
      var activeGroup = activeFilter.replace('__TOTAL__:', '');
      renderSubTypeTabs(subRow, activeGroup);
    } else if (activeFilter !== 'ALL' && activeFilter !== '__NEWCOMERS__' && typeToTotal[activeFilter]) {
      // A specific sub-type is selected
      renderSubTypeTabs(subRow, typeToTotal[activeFilter]);
    }
  } else {
    // No total groups ‚Üí flat type tabs
    types.forEach(function(type) {
      var typeCount = countPlayersForType(type);
      var tab = createTypeTab(type, type, typeCount, '#667eea');
      tabsContainer.appendChild(tab);
    });
  }
  
  updateActiveTabStyles();
}

function createTypeTab(value, label, count, color) {
  var isActive = profilingData.typeFilter === value;
  var btn = document.createElement('button');
  btn.className = 'profiling-type-tab' + (isActive ? ' active' : '');
  btn.setAttribute('data-type', value);
  btn.innerHTML = label + ' <span style="font-size:10px;font-weight:800;min-width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border-radius:9px;padding:0 5px;background:' + (isActive ? color + '22' : 'rgba(100,116,139,0.1)') + ';color:' + (isActive ? color : '#94a3b8') + ';margin-left:4px">' + count + '</span>';
  btn.style.cssText = 'padding:8px 16px;background:none;border:none;font-size:13px;font-weight:700;color:' + (isActive ? color : '#64748b') + ';cursor:pointer;border-bottom:3px solid ' + (isActive ? color : 'transparent') + ';transition:all 0.2s;display:flex;align-items:center;gap:2px;white-space:nowrap';
  btn.onclick = function() { switchProfilingTypeTab(value); };
  return btn;
}

function renderSubTypeTabs(container, groupName) {
  container.style.display = 'flex';
  container.innerHTML = '';
  var groupTypes = totalGroups[groupName] || [];
  var activeFilter = profilingData.typeFilter || '';
  
  // "All in group" sub-tab
  var allGroupVal = '__TOTAL__:' + groupName;
  var isAllGroup = activeFilter === allGroupVal;
  var allBtn = document.createElement('button');
  allBtn.className = 'profiling-sub-tab' + (isAllGroup ? ' active' : '');
  allBtn.innerHTML = '‚àë All ' + groupName;
  allBtn.style.cssText = 'padding:5px 12px;border-radius:16px;border:1.5px solid ' + (isAllGroup ? '#8b5cf6' : '#e2e8f0') + ';background:' + (isAllGroup ? '#8b5cf622' : '#fff') + ';color:' + (isAllGroup ? '#8b5cf6' : '#64748b') + ';font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s';
  allBtn.onclick = function() { switchProfilingTypeTab(allGroupVal); };
  container.appendChild(allBtn);
  
  groupTypes.forEach(function(type) {
    var isSub = activeFilter === type;
    var cnt = countPlayersForType(type);
    var btn = document.createElement('button');
    btn.className = 'profiling-sub-tab' + (isSub ? ' active' : '');
    btn.innerHTML = type + ' <span style="font-size:9px;color:' + (isSub ? '#667eea' : '#94a3b8') + '">' + cnt + '</span>';
    btn.style.cssText = 'padding:5px 12px;border-radius:16px;border:1.5px solid ' + (isSub ? '#667eea' : '#e2e8f0') + ';background:' + (isSub ? '#667eea18' : '#fff') + ';color:' + (isSub ? '#667eea' : '#64748b') + ';font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s';
    btn.onclick = function() { switchProfilingTypeTab(type); };
    container.appendChild(btn);
  });
}

function updateActiveTabStyles() {
  var active = profilingData.typeFilter || 'ALL';
  document.querySelectorAll('.profiling-type-tab').forEach(function(btn) {
    var val = btn.getAttribute('data-type');
    var isActive = val === active;
    // Also highlight total group tab when a sub-type of that group is selected
    if (!isActive && val && val.indexOf('__TOTAL__:') === 0) {
      var grp = val.replace('__TOTAL__:', '');
      if (typeToTotal[active] === grp) isActive = true;
    }
    btn.classList.toggle('active', isActive);
    if (isActive) {
      btn.style.borderBottomColor = val === '__NEWCOMERS__' ? '#10b981' : '#667eea';
      btn.style.color = val === '__NEWCOMERS__' ? '#059669' : '#667eea';
    } else {
      btn.style.borderBottomColor = 'transparent';
      btn.style.color = val === '__NEWCOMERS__' ? '#10b981' : '#64748b';
    }
  });
}

function countPlayersForTotalGroup(groupName) {
  var groupTypes = totalGroups[groupName] || [];
  var mgrName = profilingData.activeManager;
  if (!profilingData.allPlayers) return 0;
  var mgrTags = managerMapping[mgrName] || [];
  if (!mgrTags.length) return 0;
  return profilingData.allPlayers.filter(function(player) {
    var playerTags = (player.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    var inMgr = false;
    for (var i = 0; i < playerTags.length; i++) { if (mgrTags.indexOf(playerTags[i]) !== -1) { inMgr = true; break; } }
    if (!inMgr) return false;
    var type = getPlayerType(player);
    return groupTypes.indexOf(type) !== -1;
  }).length;
}

/**
 * Switch Profiling Type Tab
 */
function switchProfilingTypeTab(type) {
  console.log('üîÑ Switching to Profiling type:', type);
  profilingData.typeFilter = type;
  
  // Re-render sub-tabs if total group selected
  var subRow = document.getElementById('profilingSubTypeTabs');
  if (subRow) {
    if (type.indexOf('__TOTAL__:') === 0) {
      var groupName = type.replace('__TOTAL__:', '');
      renderSubTypeTabs(subRow, groupName);
    } else if (type !== 'ALL' && type !== '__NEWCOMERS__' && typeToTotal[type]) {
      renderSubTypeTabs(subRow, typeToTotal[type]);
    } else {
      subRow.style.display = 'none';
      subRow.innerHTML = '';
    }
  }
  
  updateActiveTabStyles();
  renderProfilingPlayers();
}

/**
 * Handle Profiling Type Filter dropdown
 */
function handleProfilingTypeFilter() {
  var dropdown = document.getElementById('profilingTypeFilter');
  if (!dropdown) return;
  
  var type = dropdown.value;
  console.log('üîΩ Dropdown changed to:', type);
  
  // Update tabs
  document.querySelectorAll('.profiling-type-tab').forEach(function(btn) {
    if (btn.getAttribute('data-type') === type) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Update filter and re-render
  profilingData.typeFilter = type;
  renderProfilingPlayers();
}

/**
 * Find a field value from player data by searching multiple possible key names (case-insensitive)
 */
function findFieldValue(data, searchTerms) {
  if (!data) return '';
  var keys = Object.keys(data);
  for (var t = 0; t < searchTerms.length; t++) {
    var term = searchTerms[t].toLowerCase();
    for (var k = 0; k < keys.length; k++) {
      if (keys[k].toLowerCase().indexOf(term) !== -1) {
        return data[keys[k]] || '';
      }
    }
  }
  return '';
}

/**
 * Parse date from various string formats
 * Handles: DD.MM.YYYY, YYYY-MM-DD, MM/DD/YYYY, ISO, etc
 */
function parseDateField(val) {
  if (!val || String(val).trim() === '') return 0;
  var s = String(val).trim();
  
  // DD.MM.YYYY or DD.MM.YY
  var dotMatch = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);
  if (dotMatch) {
    var y = dotMatch[3].length === 2 ? 2000 + parseInt(dotMatch[3]) : parseInt(dotMatch[3]);
    return new Date(y, parseInt(dotMatch[2]) - 1, parseInt(dotMatch[1])).getTime() || 0;
  }
  
  // Try native Date parse
  var d = new Date(s);
  return isNaN(d.getTime()) ? 0 : d.getTime();
}

/**
 * Convert hex color to rgba
 */
function hexToRgba(hex, alpha) {
  try {
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    var r = parseInt(hex.substring(0,2), 16);
    var g = parseInt(hex.substring(2,4), 16);
    var b = parseInt(hex.substring(4,6), 16);
    return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
  } catch(e) { return 'rgba(239,68,68,' + alpha + ')'; }
}

function createProfilingPlayerCard(player, isListView) {
  var card = document.createElement('div');
  var _isNewcomer = false;
  var _attention = null;
  try { _isNewcomer = isNewcomer(player); } catch(e) {}
  try { _attention = getPlayerAttention(player); } catch(e) {}
  
  // Priority: Attention rule > Newcomer green > default
  var attColor = _attention ? _attention.color : null;
  var borderDefault, borderHover, bgColor, shadowHover;
  
  if (attColor) {
    borderDefault = attColor;
    borderHover = attColor;
    bgColor = hexToRgba(attColor, 0.06);
    shadowHover = '0 2px 12px ' + hexToRgba(attColor, 0.25);
  } else if (_isNewcomer) {
    borderDefault = '#34d399';
    borderHover = '#10b981';
    bgColor = 'rgba(16,185,129,0.08)';
    shadowHover = '0 2px 12px rgba(16,185,129,0.25)';
  } else {
    borderDefault = '#e2e8f0';
    borderHover = '#667eea';
    bgColor = '#fff';
    shadowHover = '0 2px 8px rgba(0,0,0,0.08)';
  }
  
  // Marquee text: attention or newcomer
  var _marqueeText = null;
  var _marqueeColor = null;
  var _marqueeIcon = '‚ö†Ô∏è';
  if (_attention) {
    _marqueeText = _attention.message;
    _marqueeColor = _attention.color;
  } else if (_isNewcomer) {
    _marqueeText = 'NEWCOMER ‚Äî NO JIRA LINK';
    _marqueeColor = '#10b981';
    _marqueeIcon = 'üÜï';
  }
  
  card.onmouseover = function() {
    this.style.borderColor = borderHover;
    this.style.boxShadow = shadowHover;
  };
  card.onmouseout = function() {
    this.style.borderColor = borderDefault;
    this.style.boxShadow = 'none';
  };
  card.onclick = function() {
    openProfilingPlayer(player);
  };
  
  // ‚úÖ Collect only [PREV] fields for preview
  var previewFields = [];
  Object.keys(profilingData.fieldConfig).forEach(function(key) {
    if (key.charAt(0) === '_') return;
    var field = profilingData.fieldConfig[key];
    if (field && field.preview && player.data[key] && String(player.data[key]).trim() !== '') {
      previewFields.push({ label: field.label, value: player.data[key] });
    }
  });
  
  // ‚úÖ Name as primary, email as secondary
  var displayName = player.data.name || '';
  var displayEmail = player.data.email || '';
  var primaryText = displayName || displayEmail || 'Unknown';
  var secondaryText = displayName ? displayEmail : '';
  
  // Photo/flag
  var photoUrl = getPlayerPhoto(player.data);
  
  if (isListView) {
    // ‚ïê‚ïê‚ïê COMPACT LIST VIEW ‚Äî single row ‚ïê‚ïê‚ïê
    card.style.cssText = 'background:' + bgColor + ';border:' + (_marqueeText ? '2px' : '1px') + ' solid ' + borderDefault + ';border-radius:8px;padding:10px 16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden';
    
    // Marquee banner (attention or newcomer)
    if (_marqueeText) {
      var marquee = document.createElement('div');
      marquee.style.cssText = 'position:absolute;top:0;left:0;right:0;height:20px;background:' + _marqueeColor + ';overflow:hidden;display:flex;align-items:center;border-radius:7px 7px 0 0';
      var marqueeInner = document.createElement('div');
      marqueeInner.textContent = (_marqueeIcon + ' ' + _marqueeText + ' ').repeat(6);
      marqueeInner.style.cssText = 'white-space:nowrap;color:#fff;font-size:10px;font-weight:800;letter-spacing:1px;animation:marqueeScroll 12s linear infinite';
      marquee.appendChild(marqueeInner);
      card.appendChild(marquee);
      card.style.paddingTop = '28px';
    }
    
    // Icon (small)
    var icon = document.createElement('div');
    icon.style.cssText = 'width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:1px solid #e2e8f0;flex-shrink:0;overflow:hidden;font-size:24px';
    if (photoUrl) {
      var img = document.createElement('img');
      img.src = photoUrl + (photoUrl.indexOf('?') === -1 ? '?t=' : '&t=') + Date.now();
      img.style.cssText = 'width:100%;height:100%;object-fit:cover';
      img.onerror = function() { icon.textContent = getFlag(player.data.country); };
      icon.appendChild(img);
    } else {
      icon.textContent = getFlag(player.data.country);
    }
    card.appendChild(icon);
    
    // Name + email
    var nameBlock = document.createElement('div');
    nameBlock.style.cssText = 'min-width:180px;max-width:220px;flex-shrink:0';
    var nameEl = document.createElement('div');
    nameEl.textContent = primaryText;
    nameEl.style.cssText = 'font-size:13px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
    nameBlock.appendChild(nameEl);
    if (secondaryText) {
      var emailEl = document.createElement('div');
      emailEl.textContent = secondaryText;
      emailEl.style.cssText = 'font-size:10px;color:#94a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
      makeEmailCopyable(emailEl, displayEmail);
      nameBlock.appendChild(emailEl);
    }
    card.appendChild(nameBlock);
    
    // ‚úÖ Type label badge (list view)
    var playerTypeList = getPlayerType(player);
    if (playerTypeList) {
      var typeBadgeList = document.createElement('span');
      var tcList = {
        'VIP': {bg:'#fef3c7',color:'#92400e',border:'#fcd34d'},
        'SILENT VIP': {bg:'#e0e7ff',color:'#3730a3',border:'#a5b4fc'},
        'PRE VIP': {bg:'#dcfce7',color:'#166534',border:'#86efac'},
        'CHURNED VIP': {bg:'#fee2e2',color:'#991b1b',border:'#fca5a5'}
      }[playerTypeList.toUpperCase()] || {bg:'#f1f5f9',color:'#475569',border:'#cbd5e1'};
      typeBadgeList.textContent = playerTypeList;
      typeBadgeList.style.cssText = 'font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;background:'+tcList.bg+';color:'+tcList.color+';border:1px solid '+tcList.border+';white-space:nowrap;text-transform:uppercase;letter-spacing:0.05em;flex-shrink:0';
      card.appendChild(typeBadgeList);
    }
    
    // Preview fields inline
    var fieldsRow = document.createElement('div');
    fieldsRow.style.cssText = 'flex:1;display:flex;gap:16px;align-items:center;justify-content:flex-end;overflow:hidden';
    previewFields.forEach(function(f) {
      var chip = document.createElement('span');
      chip.style.cssText = 'font-size:11px;color:#64748b;white-space:nowrap;display:flex;gap:4px;align-items:center';
      chip.innerHTML = '<span style="font-weight:700;color:#94a3b8;text-transform:uppercase;font-size:9px;letter-spacing:0.05em">' + f.label + '</span> <span style="color:#334155;font-weight:600">' + f.value + '</span>';
      fieldsRow.appendChild(chip);
    });
    card.appendChild(fieldsRow);
    
  } else {
    // ‚ïê‚ïê‚ïê GRID VIEW ‚Äî card ‚ïê‚ïê‚ïê
    card.style.cssText = 'background:' + bgColor + ';border:' + (_marqueeText ? '2px' : '1px') + ' solid ' + borderDefault + ';border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;animation:fadeIn 0.3s ease;position:relative;overflow:hidden';
    
    // Marquee banner (attention or newcomer)
    if (_marqueeText) {
      var marquee = document.createElement('div');
      marquee.style.cssText = 'position:absolute;top:0;left:0;right:0;height:22px;background:' + _marqueeColor + ';overflow:hidden;display:flex;align-items:center;border-radius:11px 11px 0 0';
      var marqueeInner = document.createElement('div');
      marqueeInner.textContent = (_marqueeIcon + ' ' + _marqueeText + ' ').repeat(6);
      marqueeInner.style.cssText = 'white-space:nowrap;color:#fff;font-size:10px;font-weight:800;letter-spacing:1px;animation:marqueeScroll 12s linear infinite';
      marquee.appendChild(marqueeInner);
      card.appendChild(marquee);
      card.style.paddingTop = '30px';
    }
    
    // Header: icon + name/email
    var header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:12px';
    
    var iconEl = document.createElement('div');
    iconEl.style.cssText = 'width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border:2px solid #e2e8f0;flex-shrink:0;overflow:hidden;font-size:32px';
    if (photoUrl) {
      var img2 = document.createElement('img');
      img2.src = photoUrl + (photoUrl.indexOf('?') === -1 ? '?t=' : '&t=') + Date.now();
      img2.style.cssText = 'width:100%;height:100%;object-fit:cover';
      img2.onerror = function() { iconEl.textContent = getFlag(player.data.country); };
      iconEl.appendChild(img2);
    } else {
      iconEl.textContent = getFlag(player.data.country);
    }
    header.appendChild(iconEl);
    
    var info = document.createElement('div');
    info.style.cssText = 'flex:1;min-width:0';
    var nameEl2 = document.createElement('div');
    nameEl2.textContent = primaryText;
    nameEl2.style.cssText = 'font-size:14px;font-weight:800;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
    info.appendChild(nameEl2);
    if (secondaryText) {
      var emailEl2 = document.createElement('div');
      emailEl2.textContent = secondaryText;
      emailEl2.style.cssText = 'font-size:11px;font-weight:600;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer';
      emailEl2.title = 'Double-click to copy';
      makeEmailCopyable(emailEl2, displayEmail);
      info.appendChild(emailEl2);
    }
    header.appendChild(info);
    
    // ‚úÖ Type label badge
    var playerType = getPlayerType(player);
    if (playerType) {
      var typeBadge = document.createElement('div');
      var typeColors = {
        'VIP': {bg:'#fef3c7',color:'#92400e',border:'#fcd34d'},
        'SILENT VIP': {bg:'#e0e7ff',color:'#3730a3',border:'#a5b4fc'},
        'PRE VIP': {bg:'#dcfce7',color:'#166534',border:'#86efac'},
        'CHURNED VIP': {bg:'#fee2e2',color:'#991b1b',border:'#fca5a5'}
      };
      var tc = typeColors[playerType.toUpperCase()] || {bg:'#f1f5f9',color:'#475569',border:'#cbd5e1'};
      typeBadge.textContent = playerType;
      typeBadge.style.cssText = 'font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;background:'+tc.bg+';color:'+tc.color+';border:1px solid '+tc.border+';white-space:nowrap;text-transform:uppercase;letter-spacing:0.05em';
      header.appendChild(typeBadge);
    }
    
    card.appendChild(header);
    
    // Preview fields
    if (previewFields.length > 0) {
      var stats = document.createElement('div');
      stats.style.cssText = 'display:flex;flex-direction:column;gap:6px';
      previewFields.slice(0, 4).forEach(function(f) {
        var stat = createProfilingStat(f.label, f.value);
        stats.appendChild(stat);
      });
      card.appendChild(stats);
    }
  }
  
  return card;
}

function createProfilingStat(label, value) {
  var stat = document.createElement('div');
  stat.style.cssText = 'display:flex;justify-content:space-between;align-items:center;gap:8px';
  
  var labelEl = document.createElement('div');
  labelEl.textContent = label;
  labelEl.style.cssText = 'font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
  stat.appendChild(labelEl);
  
  var valueEl = document.createElement('div');
  valueEl.textContent = value;
  valueEl.style.cssText = 'font-size:12px;font-weight:600;color:#1e293b;text-align:right';
  stat.appendChild(valueEl);
  
  return stat;
}

function showProfilingPlayerDetail(player) {
  // Get fresh player data from profilingData (not cached)
  var freshPlayer = null;
  if (profilingData && profilingData.allPlayers) {
    freshPlayer = profilingData.allPlayers.find(function(p) {
      return p.data && p.data.email === player.data.email;
    }) || null;
  }
  
  // Use fresh data if found, otherwise use provided player
  if (freshPlayer) {
    console.log('‚úÖ Using fresh player data for:', player.data.email);
    player = freshPlayer;
  } else {
    console.log('‚ö†Ô∏è Using cached player data for:', player.data.email);
  }
  
  // CRITICAL: Clear avatars FIRST to prevent caching
  var profilingAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (profilingAvatar) {
    profilingAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared Profiling avatar');
  }
  
  var vipAvatar = document.querySelector('.flip-card-front .unified-card-avatar');
  if (vipAvatar) {
    vipAvatar.innerHTML = 'üë§';
    console.log('üßπ Cleared VIP avatar');
  }
  
  // Store profiling player
  window.currentProfilingPlayer = player;
  
  // Ensure photo alias
  if (!player.data.photo) {
    var foundPhoto = getPlayerPhoto(player.data);
    if (foundPhoto) player.data.photo = foundPhoto;
  }
  
  // Convert old photo URL format to thumbnail format
  if (player.data.photo) {
    var photoUrl = player.data.photo;
    
    // Check if old format: https://drive.google.com/uc?export=view&id=...
    if (photoUrl.indexOf('drive.google.com/uc?export=view&id=') !== -1) {
      var fileIdMatch = photoUrl.match(/[?&]id=([^&]+)/);
      if (fileIdMatch) {
        var fileId = fileIdMatch[1];
        player.data.photo = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
        console.log('Converted old photo URL to thumbnail format');
      }
    }
  }
  
  // Try to find VIP player by email
  var vipPlayer = player.data.email ? findVIPPlayerByEmail(player.data.email) : null;
  window.currentVIPPlayer = vipPlayer;
  
  // Open unified modal on Profiling side
  var modal = document.getElementById('unifiedPlayerModal');
  var flipCard = document.getElementById('playerFlipCard');
  
  // Update Profiling side
  var nameEl = document.getElementById('profilingPlayerName');
  var emailEl = document.getElementById('profilingPlayerEmail');
  var bodyEl = document.getElementById('profilingCardBody');
  
  // Show NAME in header (not email)
  var playerName = player.data.name || player.data.email || 'Player';
  nameEl.textContent = playerName;
  emailEl.textContent = player.data.email || '';
  
  // Update header avatar with photo if exists
  setTimeout(function() {
    var avatarEl = document.querySelector('.flip-card-back .unified-card-avatar');
    var hasPhoto = player.data.photo && typeof player.data.photo === 'string' && player.data.photo.trim() !== '';
    
    if (avatarEl && hasPhoto) {
      avatarEl.innerHTML = '';
      var img = document.createElement('img');
      // Add cache busting timestamp
      var photoUrl = player.data.photo.trim();
      if (photoUrl.indexOf('?') === -1) {
        photoUrl += '?t=' + Date.now();
      } else {
        photoUrl += '&t=' + Date.now();
      }
      img.src = photoUrl;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;cursor:pointer';
      img.onclick = function() {
        openPhotoModal(player.data.photo);
      };
      img.onerror = function() {
        console.log('‚ùå Failed to load photo:', photoUrl);
        avatarEl.textContent = getFlag(player.data.country) || 'üë§';
      };
      avatarEl.appendChild(img);
    }
  }, 100);
  
  // Make name clickable to flip to VIP if exists
  if (vipPlayer) {
    nameEl.style.cursor = 'pointer';
    nameEl.title = 'Click to view VIP Data';
    nameEl.onclick = function() {
      flipToVIPCard();
    };
  } else {
    nameEl.style.cursor = 'default';
    nameEl.title = '';
    nameEl.onclick = null;
  }
  
  // Render profiling content
  renderProfilingCardContent(player, bodyEl);
  
  // Show/hide VIP flip button
  var flipBtn = document.getElementById('profilingToVIPFlipBtn');
  if (flipBtn) {
    console.log('Profiling->VIP button check:', {hasVIPPlayer: !!vipPlayer, email: player.data.email});
    if (vipPlayer) {
      flipBtn.style.display = 'block';
    } else {
      flipBtn.style.display = 'none';
    }
  }
  
  // Update VIP side if player exists
  if (vipPlayer) {
    var vipNameEl = document.getElementById('vipPlayerName');
    var vipEmailEl = document.getElementById('vipPlayerEmail');
    
    var playerName = ((vipPlayer.first_name || '') + ' ' + (vipPlayer.last_name || '')).trim() || 'Unknown Player';
    
    vipNameEl.textContent = playerName;
    vipEmailEl.textContent = vipPlayer.email + ' ‚Ä¢ VIP Dashboard';
    
    if (vipPlayer.email) {
      vipEmailEl.style.cursor = 'pointer';
      vipEmailEl.title = 'Double-click to copy email';
      makeEmailCopyable(vipEmailEl, vipPlayer.email);
    }
    
    renderPlayerMetrics(vipPlayer);
    renderPlayerDetails(vipPlayer);
  }
  
  // Show modal on Profiling side (flipped)
  flipCard.classList.add('flipped');
  modal.classList.add('show');
}

/**
 * Render section content
/**
 * Render section content
 */
function renderSectionContent(sectionName, sectionFields, player, container) {
  container.innerHTML = '';
  
  var sectionTitle = document.createElement('div');
  sectionTitle.textContent = sectionName;
  sectionTitle.style.cssText = 'font-size:18px;font-weight:800;color:#1e293b;margin-bottom:24px;display:flex;align-items:center;gap:10px';
  var sectionIconEl = document.createElement('span');
  sectionIconEl.textContent = getSectionIcon(sectionName);
  sectionIconEl.style.cssText = 'font-size:24px';
  sectionTitle.insertBefore(sectionIconEl, sectionTitle.firstChild);
  container.appendChild(sectionTitle);
  
  var fieldsGrid = document.createElement('div');
  fieldsGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px';
  sectionFields.forEach(function(key) {
    if (key === '_order' || key === '_sections') return;
    var fieldInfo = profilingData.fieldConfig[key];
    if (!fieldInfo) return;
    fieldsGrid.appendChild(createEditableField(key, fieldInfo, player));
  });
  container.appendChild(fieldsGrid);
  
  // Inject FAVOURITE SLOTS block into GAMEPLAY section
  if (sectionName.toLowerCase() === 'gameplay') {
    container.appendChild(createFavouriteSlotsBlock(player));
  }
}

function getSectionIcon(sectionName) {
  var icons = {'main info':'\uD83D\uDCCB','communication':'\uD83D\uDCAC','personal info':'\uD83D\uDC64','finance':'\uD83D\uDCB0','gameplay':'\uD83C\uDFAE','contact info':'\uD83D\uDCDE','general':'\uD83D\uDCC4','player info':'\uD83D\uDC65'};
  return icons[sectionName.toLowerCase()] || '\uD83D\uDCCC';
}

function createEditableField(key, fieldInfo, player) {
  var fieldEl = document.createElement('div');
  fieldEl.style.cssText = 'display:flex;flex-direction:column;gap:8px';
  
  var cleanLabel = fieldInfo.label.replace('[ICON]', '').replace('[BICON]', '').trim();
  
  if (key === 'email') fieldEl.style.gridColumn = '1 / -1';
  
  var isCommentsField = key.toLowerCase() === 'comments' || cleanLabel.toLowerCase().indexOf('comment') !== -1;
  if (isCommentsField) {
    fieldEl.style.gridColumn = '1 / -1';
    fieldEl.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
    fieldEl.style.padding = '20px';
    fieldEl.style.borderRadius = '12px';
    fieldEl.style.border = '2px solid #fcd34d';
    fieldEl.style.boxShadow = '0 2px 8px rgba(252,211,77,0.2)';
  }
  
  var label = document.createElement('div');
  if (isCommentsField) {
    var commentIcon = document.createElement('span');
    commentIcon.innerHTML = '\uD83D\uDCAC ';
    commentIcon.style.cssText = 'font-size:16px;margin-right:4px';
    label.appendChild(commentIcon);
    var labelText = document.createElement('span');
    labelText.textContent = cleanLabel;
    label.appendChild(labelText);
    label.style.cssText = 'font-size:13px;font-weight:800;color:#92400e;text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center';
  } else {
    label.textContent = cleanLabel;
    label.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
  }
  fieldEl.appendChild(label);
  
  var currentValue = player.data[key] || '';
  
  var isIconField = fieldInfo.label.indexOf('[ICON]') === 0;
  var isBigIconField = fieldInfo.label.indexOf('[BICON]') === 0;
  
  if ((isIconField || isBigIconField) && currentValue && currentValue.trim() !== '' && currentValue !== 'false') {
    var iconBtn = document.createElement('a');
    iconBtn.href = currentValue; iconBtn.target = '_blank'; iconBtn.rel = 'noopener noreferrer';
    var icon = document.createElement('i');
    var platformName = cleanLabel.split(' ')[0];
    icon.className = isBigIconField ? getBigIcon(platformName) : getSocialIcon(platformName);
    iconBtn.appendChild(icon);
    var textSpan = document.createElement('span');
    textSpan.textContent = platformName; textSpan.style.marginLeft = '8px';
    iconBtn.appendChild(textSpan);
    iconBtn.style.cssText = 'display:flex;align-items:center;padding:12px 14px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff;text-decoration:none;font-size:13px;font-weight:600;transition:all 0.2s;cursor:pointer';
    iconBtn.onmouseover = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 4px 12px rgba(102,126,234,0.3)'; };
    iconBtn.onmouseout = function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = 'none'; };
    
    var editBtn = document.createElement('button');
    editBtn.textContent = '\u270E'; editBtn.title = 'Edit link';
    editBtn.style.cssText = 'margin-top:8px;padding:8px 12px;background:rgba(102,126,234,0.1);border:2px solid #e2e8f0;border-radius:6px;color:#667eea;font-size:14px;cursor:pointer;transition:all 0.2s';
    editBtn.onclick = function(e) {
      e.preventDefault();
      var input = document.createElement('input'); input.type = 'text'; input.value = currentValue;
      input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #667eea;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
      input.onfocus = function() { this.style.borderColor = '#667eea'; this.style.boxShadow = '0 0 0 3px rgba(102,126,234,0.1)'; };
      input.onblur = function() { this.style.borderColor = '#e2e8f0'; this.style.boxShadow = 'none'; };
      input.onchange = function() { player.data[key] = this.value; profilingData.selectedPlayer = player; markProfilingDirty(); };
      fieldEl.removeChild(iconBtn); fieldEl.removeChild(editBtn); fieldEl.appendChild(input); input.focus();
    };
    fieldEl.appendChild(iconBtn); fieldEl.appendChild(editBtn);
    return fieldEl;
  }
  
  var input;
  var effectiveType = fieldInfo.type;
  if (effectiveType !== 'date' && cleanLabel.toLowerCase().indexOf('date') !== -1) effectiveType = 'date';
  
  if (effectiveType === 'dropdown' && fieldInfo.options) {
    input = document.createElement('select');
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s';
    var emptyOpt = document.createElement('option'); emptyOpt.value = ''; emptyOpt.textContent = '\u2014'; input.appendChild(emptyOpt);
    var hasSelectedValue = false;
    fieldInfo.options.forEach(function(option) {
      var opt = document.createElement('option'); opt.value = option; opt.textContent = option;
      if (option === currentValue && currentValue) { opt.selected = true; hasSelectedValue = true; }
      input.appendChild(opt);
    });
    if (!hasSelectedValue || !currentValue) emptyOpt.selected = true;
  } else if (effectiveType === 'checkbox') {
    input = document.createElement('input'); input.type = 'checkbox';
    input.checked = currentValue === 'true' || currentValue === true;
    input.style.cssText = 'width:24px;height:24px;cursor:pointer';
  } else if (effectiveType === 'date') {
    input = document.createElement('input'); input.type = 'date';
    input.value = formatDateForInput(currentValue);
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
  } else if (isCommentsField) {
    input = document.createElement('textarea'); input.value = currentValue; input.rows = 6;
    input.style.cssText = 'padding:14px 16px;background:#fff;border:2px solid #fbbf24;border-radius:10px;color:#1e293b;font-size:14px;font-weight:500;transition:all 0.2s;resize:vertical;min-height:120px;line-height:1.6;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif';
    input.placeholder = 'Add your comments here...';
  } else {
    input = document.createElement('input'); input.type = 'text'; input.value = currentValue;
    input.style.cssText = 'padding:12px 14px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:13px;font-weight:600;transition:all 0.2s';
  }
  
  input.onfocus = function() {
    if (isCommentsField) { this.style.borderColor = '#f59e0b'; this.style.boxShadow = '0 0 0 4px rgba(251,191,36,0.2)'; }
    else { this.style.borderColor = '#667eea'; this.style.boxShadow = '0 0 0 3px rgba(102,126,234,0.1)'; }
  };
  input.onblur = function() {
    if (isCommentsField) { this.style.borderColor = '#fbbf24'; this.style.boxShadow = 'none'; }
    else { this.style.borderColor = '#e2e8f0'; this.style.boxShadow = 'none'; }
  };
  input.onchange = function() {
    var newValue = this.type === 'checkbox' ? this.checked : this.value;
    player.data[key] = newValue; profilingData.selectedPlayer = player; markProfilingDirty();
  };
  fieldEl.appendChild(input);
  
  if (currentValue && String(currentValue).indexOf('@') !== -1 && input.type !== 'checkbox') {
    input.style.cursor = 'pointer'; input.title = 'Double-click to copy email';
    input.addEventListener('dblclick', function(e) { e.stopPropagation(); copyEmailToClipboard(String(currentValue)); });
  }
  
  var isInternalField = key.charAt(0) === '_' || key.toLowerCase().indexOf('_last_') !== -1 || key.toLowerCase().indexOf('upload') !== -1 || key.toLowerCase() === 'id' || key.toLowerCase() === 'email';
  var isEmpty = !currentValue || String(currentValue).trim() === '' || currentValue === '\u2014';
  if (isEmpty && !isCommentsField && !isInternalField && input.type !== 'checkbox') {
    input.style.borderColor = '#fca5a5';
    input.style.background = '#fef2f2';
    input.onfocus = function() { this.style.borderColor = '#ef4444'; this.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.1)'; };
    input.onblur = function() {
      var val = this.type === 'checkbox' ? this.checked : this.value;
      if (!val || String(val).trim() === '' || val === '\u2014') {
        this.style.borderColor = '#fca5a5'; this.style.background = '#fef2f2'; this.style.boxShadow = 'none';
      } else {
        this.style.borderColor = '#e2e8f0'; this.style.background = '#fff'; this.style.boxShadow = 'none';
      }
    };
    var origChange = input.onchange;
    input.onchange = function() {
      var val = this.type === 'checkbox' ? this.checked : this.value;
      if (val && String(val).trim() !== '' && val !== '\u2014') {
        this.style.borderColor = '#e2e8f0'; this.style.background = '#fff';
      }
      player.data[key] = val; profilingData.selectedPlayer = player; markProfilingDirty();
    };
  }
  
  return fieldEl;
}


function formatDateForInput(dateValue) {
  if (!dateValue) return '';
  
  // DD.MM.YYYY ‚Üí YYYY-MM-DD
  if (typeof dateValue === 'string' && dateValue.indexOf('.') !== -1) {
    var parts = dateValue.split('.');
    if (parts.length === 3) {
      return parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
    }
  }
  
  return dateValue;
}

// ==================== FAVOURITE SLOTS IN PROFILING ====================
var favSlotsState = { email: null, slots: [], loading: false };

function createFavouriteSlotsBlock(player) {
  var box = document.createElement('div');
  box.className = 'fav-slots-container';
  box.id = 'favSlotsBlock';
  
  var header = document.createElement('div');
  header.className = 'fav-slots-header';
  header.innerHTML = '<div class="fav-slots-title">üé∞ Favourite Slots</div>';
  var addBtn = document.createElement('button');
  addBtn.className = 'fav-slots-add';
  addBtn.textContent = '+ Add Slot';
  addBtn.onclick = function() { openSlotPicker(); };
  header.appendChild(addBtn);
  box.appendChild(header);
  
  var grid = document.createElement('div');
  grid.className = 'fav-slots-grid';
  grid.id = 'favSlotsGrid';
  box.appendChild(grid);
  
  var email = player.data.email || player.data.Email || '';
  
  // Always reset state for new player
  favSlotsState.email = email;
  favSlotsState.slots = [];
  favSlotsState.loading = false;
  
  if (email) {
    favSlotsState.loading = true;
    addBtn.disabled = true;
    addBtn.style.opacity = '0.5';
    grid.innerHTML = '<div class="fav-slot-empty">Loading favourites...</div>';
    google.script.run
      .withSuccessHandler(function(slots) {
        // Only update if still same player
        if (favSlotsState.email !== email) return;
        // Merge: keep any slots added while loading
        var existing = favSlotsState.slots.slice();
        favSlotsState.slots = (slots || []).slice();
        existing.forEach(function(s) {
          if (!favSlotsState.slots.some(function(x){ return x.toLowerCase() === s.toLowerCase(); })) {
            favSlotsState.slots.push(s);
          }
        });
        favSlotsState.loading = false;
        addBtn.disabled = false;
        addBtn.style.opacity = '1';
        renderFavSlotCards();
      })
      .withFailureHandler(function() {
        if (favSlotsState.email !== email) return;
        favSlotsState.loading = false;
        addBtn.disabled = false;
        addBtn.style.opacity = '1';
        renderFavSlotCards();
      })
      .getPlayerFavouriteSlots(email);
  } else {
    grid.innerHTML = '<div class="fav-slot-empty">No email ‚Äî cannot load favourites</div>';
  }
  
  return box;
}

function findRtpGame(slotName) {
  var rtpGames = (bcState.config && bcState.config.rtpGames) || [];
  return rtpGames.find(function(g) {
    return g.slot && g.slot.toLowerCase() === slotName.toLowerCase();
  }) || null;
}

function renderFavSlotCards() {
  var grid = document.getElementById('favSlotsGrid');
  if (!grid) return;
  grid.innerHTML = '';
  
  if (!favSlotsState.slots.length) {
    grid.innerHTML = '<div class="fav-slot-empty">No favourite slots yet. Click "+ Add Slot" to add.</div>';
    return;
  }
  
  favSlotsState.slots.forEach(function(slotName, idx) {
    var game = findRtpGame(slotName);
    
    var card = document.createElement('div');
    card.className = 'fav-slot-card';
    card.onclick = function(e) {
      if (e.target.classList.contains('fav-slot-remove')) return;
      showSlotDetailModal(game || { slot: slotName, provider: '', rtpPct: '?', volatility: '', category: '' });
    };
    
    var nameEl = document.createElement('div');
    nameEl.className = 'fav-slot-name';
    nameEl.textContent = slotName;
    nameEl.title = slotName;
    card.appendChild(nameEl);
    
    var provEl = document.createElement('div');
    provEl.className = 'fav-slot-provider';
    provEl.textContent = game ? game.provider : 'Unknown provider';
    card.appendChild(provEl);
    
    var meta = document.createElement('div');
    meta.className = 'fav-slot-meta';
    
    var rtpSpan = document.createElement('span');
    rtpSpan.className = 'fav-slot-rtp';
    rtpSpan.textContent = game ? game.rtpPct + '%' : '‚Äî';
    meta.appendChild(rtpSpan);
    
    if (game && game.volatility) {
      var volSpan = document.createElement('span');
      var cls = 'bc-vol-' + String(game.volatility).toLowerCase().replace(/\s+/g,'-').replace(/[^a-z-]/g,'');
      volSpan.className = 'bc-vol-badge ' + cls;
      volSpan.textContent = game.volatility;
      meta.appendChild(volSpan);
    }
    card.appendChild(meta);
    
    var removeBtn = document.createElement('button');
    removeBtn.className = 'fav-slot-remove';
    removeBtn.innerHTML = '‚úï';
    removeBtn.title = 'Remove';
    removeBtn.onclick = function(e) {
      e.stopPropagation();
      favSlotsState.slots.splice(idx, 1);
      renderFavSlotCards();
      saveFavSlots();
    };
    card.appendChild(removeBtn);
    
    grid.appendChild(card);
  });
}

function showSlotDetailModal(game) {
  var body = document.getElementById('bcRtpDetailBody');
  var title = document.getElementById('bcRtpDetailTitle');
  if (!body || !title) return;
  
  title.textContent = 'üéÆ ' + (game.slot || 'Game');
  var html = '<div style="text-align:center;margin-bottom:16px"><span style="font-size:28px;font-weight:800;color:#667eea">' + (game.rtpPct || '?') + (game.rtpPct && game.rtpPct !== '?' ? '%' : '') + '</span></div>';
  
  var fields = [
    ['Provider', game.provider],
    ['Slot', game.slot],
    ['RTP', game.rtpPct ? game.rtpPct + '%' : ''],
    ['Volatility', game.volatility],
    ['Category', game.category]
  ];
  fields.forEach(function(pair) {
    if (!pair[1]) return;
    var displayVal = pair[1];
    if (pair[0] === 'Volatility') {
      var cls = 'bc-vol-' + String(pair[1]).toLowerCase().replace(/\s+/g,'-').replace(/[^a-z-]/g,'');
      displayVal = '<span class="bc-vol-badge ' + cls + '">' + pair[1] + '</span>';
    } else if (pair[0] === 'Category') {
      displayVal = String(pair[1]).split(/[,\s]+/).filter(Boolean).map(function(c){return '<span class="bc-cat-badge">' + c + '</span>'}).join(' ');
    }
    html += '<div class="bc-detail-row"><span class="bc-detail-label">' + pair[0] + '</span><span class="bc-detail-value">' + displayVal + '</span></div>';
  });
  
  if (game.betLevels && game.betLevels.length) {
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #f1f5f9">';
    html += '<div style="font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:10px">Bet Levels</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px">';
    game.betLevels.forEach(function(bl) {
      html += '<div style="text-align:center;padding:6px 4px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px"><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase">LVL ' + bl.level + '</div><div style="font-size:14px;font-weight:800;color:#1e293b;margin-top:2px">' + bl.value + '</div></div>';
    });
    html += '</div></div>';
  }
  
  body.innerHTML = html;
  document.getElementById('bcRtpDetailModal').style.display = 'flex';
}

function openSlotPicker() {
  var rtpGames = (bcState.config && bcState.config.rtpGames) || [];
  if (!rtpGames.length) {
    alert('RTP games database not loaded yet. Try again in a moment.');
    return;
  }
  
  var overlay = document.createElement('div');
  overlay.className = 'slot-picker-overlay';
  overlay.id = 'slotPickerOverlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  
  var card = document.createElement('div');
  card.className = 'slot-picker-card';
  
  var searchBar = document.createElement('div');
  searchBar.className = 'slot-picker-search';
  searchBar.innerHTML = '<span style="font-size:20px">üé∞</span><input id="slotPickerSearch" type="search" placeholder="Search slot name or provider...">';
  var closeBtn = document.createElement('button');
  closeBtn.className = 'bc-modal-close';
  closeBtn.textContent = '‚úï';
  closeBtn.onclick = function() { overlay.remove(); };
  searchBar.appendChild(closeBtn);
  card.appendChild(searchBar);
  
  var list = document.createElement('div');
  list.className = 'slot-picker-list';
  list.id = 'slotPickerList';
  card.appendChild(list);
  
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  
  function renderPickerList(q) {
    var lq = (q || '').toLowerCase();
    var filtered = rtpGames.filter(function(g) {
      if (!lq) return true;
      return (g.provider && g.provider.toLowerCase().indexOf(lq) !== -1) ||
             (g.slot && g.slot.toLowerCase().indexOf(lq) !== -1) ||
             (g.category && g.category.toLowerCase().indexOf(lq) !== -1);
    }).slice(0, 100);
    
    list.innerHTML = '';
    if (!filtered.length) {
      list.innerHTML = '<div style="padding:30px;text-align:center;color:#94a3b8">No games found</div>';
      return;
    }
    
    filtered.forEach(function(game) {
      var alreadyAdded = favSlotsState.slots.some(function(s) { return s.toLowerCase() === game.slot.toLowerCase(); });
      
      var item = document.createElement('div');
      item.className = 'slot-picker-item' + (alreadyAdded ? ' selected' : '');
      
      var info = document.createElement('div');
      var volHtml = game.volatility ? ' ¬∑ <span class="bc-vol-badge bc-vol-' + String(game.volatility).toLowerCase().replace(/\s+/g,'-').replace(/[^a-z-]/g,'') + '">' + game.volatility + '</span>' : '';
      info.innerHTML = '<div class="spi-name">' + game.slot + (alreadyAdded ? ' <span style="color:#10b981;font-size:11px">‚úì added</span>' : '') + '</div><div class="spi-prov">' + game.provider + volHtml + '</div>';
      item.appendChild(info);
      
      var rtp = document.createElement('span');
      rtp.className = 'spi-rtp';
      rtp.textContent = game.rtpPct + '%';
      item.appendChild(rtp);
      
      if (!alreadyAdded) {
        item.onclick = function() {
          favSlotsState.slots.push(game.slot);
          renderFavSlotCards();
          saveFavSlots();
          renderPickerList(document.getElementById('slotPickerSearch').value);
        };
      }
      
      list.appendChild(item);
    });
  }
  
  renderPickerList('');
  var searchInput = document.getElementById('slotPickerSearch');
  searchInput.focus();
  searchInput.oninput = function() { renderPickerList(this.value); };
}

function saveFavSlots() {
  if (!favSlotsState.email) return;
  google.script.run
    .withSuccessHandler(function() {})
    .withFailureHandler(function(err) { console.error('saveFavSlots error:', err); })
    .savePlayerFavouriteSlots(favSlotsState.email, favSlotsState.slots);
}

// "Add to Player" from RTP Games table
function bcRtpAddToPlayer(slotName) {
  var body = document.getElementById('bcAddToPlayerBody');
  var title = document.getElementById('bcAddToPlayerTitle');
  title.textContent = '‚ûï Add "' + slotName + '" to Player';
  
  body.innerHTML = '<div class="bc-modal-field"><label>Player Email</label>' +
    '<input id="bcAddToPlayerEmail" type="email" placeholder="player@example.com" autocomplete="off">' +
    '</div>' +
    '<div id="bcAddToPlayerStatus" style="margin-top:8px"></div>' +
    '<div style="margin-top:14px;display:flex;justify-content:flex-end">' +
    '<button onclick="bcRtpDoAddToPlayer(\'' + slotName.replace(/'/g,"\\'") + '\')" class="bc-btn-calc" style="font-size:12px;padding:8px 18px">‚ûï Add</button></div>';
  
  document.getElementById('bcAddToPlayerModal').style.display = 'flex';
  setTimeout(function(){ document.getElementById('bcAddToPlayerEmail').focus(); }, 100);
}

function bcRtpDoAddToPlayer(slotName) {
  var email = (document.getElementById('bcAddToPlayerEmail').value || '').trim();
  if (!email || email.indexOf('@') === -1) {
    document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#ef4444;font-size:12px;font-weight:600">Enter a valid email</span>';
    return;
  }
  document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#94a3b8;font-size:12px">‚è≥ Loading...</span>';
  
  // Load existing slots, add new one, save
  google.script.run
    .withSuccessHandler(function(existingSlots) {
      var slots = existingSlots || [];
      if (slots.some(function(s){ return s.toLowerCase() === slotName.toLowerCase(); })) {
        document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#f59e0b;font-size:12px;font-weight:600">‚ö†Ô∏è Already in favourites</span>';
        return;
      }
      slots.push(slotName);
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#10b981;font-size:12px;font-weight:600">‚úÖ Added!</span>';
          // If same player is open in profiling, refresh
          if (favSlotsState.email && favSlotsState.email.toLowerCase() === email.toLowerCase()) {
            favSlotsState.slots = slots;
            renderFavSlotCards();
          }
          setTimeout(function(){ document.getElementById('bcAddToPlayerModal').style.display = 'none'; }, 800);
        })
        .withFailureHandler(function(err) {
          document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#ef4444;font-size:12px;font-weight:600">Error: ' + err.message + '</span>';
        })
        .savePlayerFavouriteSlots(email, slots);
    })
    .withFailureHandler(function(err) {
      document.getElementById('bcAddToPlayerStatus').innerHTML = '<span style="color:#ef4444;font-size:12px;font-weight:600">Error: ' + err.message + '</span>';
    })
    .getPlayerFavouriteSlots(email);
}

/**
 * Save player data
 */
/**
 * Upload player photo to Google Drive
 */
function uploadPlayerPhoto(player) {
  // Create file input
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    
    // Check file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showToast('‚ùå File too large! Max 5MB');
      return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
      showToast('‚ùå Please select an image file');
      return;
    }
    
    showToast('üì§ Uploading photo...');
    
    // Read file as base64
    var reader = new FileReader();
    reader.onload = function(event) {
      var base64Data = event.target.result.split(',')[1];
      
      // Upload to Google Drive via backend
      google.script.run
        .withSuccessHandler(function(photoUrl) {
          showToast('‚úÖ Photo uploaded!');
          
          console.log('Photo uploaded for player:', player.data.email);
          console.log('Photo URL:', photoUrl);
          
          // Update THIS player's data
          player.data.photo = photoUrl;
          
          // Update avatars in current modal
          updatePlayerAvatars(player, photoUrl);
          
          // Save to sheet UPLOAD column (silent save)
          saveProfilingPlayerSilent(player);
          
          // Reload profiling data to update preview cards
          setTimeout(function() {
            reloadProfilingData();
          }, 1000);
        })
        .withFailureHandler(function(error) {
          console.error('Upload error:', error);
          showToast('‚ùå Upload failed: ' + error);
        })
        .uploadPlayerPhoto(player.data.email, base64Data, file.name);
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
}

/**
 * Update all player avatars with photo
 */
function updatePlayerAvatars(player, photoUrl) {
  console.log('Updating avatars with photo URL:', photoUrl);
  
  // Add cache busting to photoUrl
  if (photoUrl.indexOf('?') === -1) {
    photoUrl += '?t=' + Date.now();
  } else {
    photoUrl += '&t=' + Date.now();
  }
  
  // Update header avatar
  var headerAvatar = document.querySelector('.flip-card-back .unified-card-avatar');
  if (headerAvatar) {
    headerAvatar.innerHTML = '';
    
    var img = document.createElement('img');
    img.src = photoUrl;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;cursor:pointer';
    
    img.onerror = function() {
      console.error('Header avatar failed to load:', photoUrl);
      this.style.display = 'none';
      headerAvatar.innerHTML = '<div style="font-size:32px">üë§</div>';
    };
    
    img.onload = function() {
      console.log('Header avatar loaded successfully');
    };
    
    img.onclick = function() {
      openPhotoModal(player.data.photo);  // Use original URL without timestamp
    };
    
    headerAvatar.appendChild(img);
  }
  
  // Update Icon Row avatar (create new photo box)
  var iconRow = document.getElementById('profilingIconRow');
  if (iconRow) {
    // Remove old photo if exists
    var oldPhoto = document.getElementById('playerPhotoIcon');
    if (oldPhoto) oldPhoto.remove();
    
    // Add photo icon
    var photoIcon = document.createElement('div');
    photoIcon.id = 'playerPhotoIcon';
    photoIcon.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px';
    
    var photoBox = document.createElement('div');
    photoBox.style.cssText = 'width:60px;height:60px;border-radius:14px;overflow:hidden;border:2px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.05);cursor:pointer;background:#f8fafc;display:flex;align-items:center;justify-content:center';
    
    // Add loading placeholder
    photoBox.innerHTML = '<div style="font-size:24px;color:#94a3b8">‚è≥</div>';
    
    var photoImg = document.createElement('img');
    photoImg.src = photoUrl;
    photoImg.style.cssText = 'width:100%;height:100%;object-fit:cover;display:none';
    
    photoImg.onerror = function() {
      console.error('Icon Row photo failed to load:', photoUrl);
      photoBox.innerHTML = '<div style="font-size:32px">üì∑</div>';
    };
    
    photoImg.onload = function() {
      console.log('Icon Row photo loaded successfully');
      photoBox.innerHTML = '';
      this.style.display = 'block';
      photoBox.appendChild(this);
    };
    
    photoImg.onclick = function() {
      openPhotoModal(player.data.photo);  // Use original URL without timestamp
    };
    
    photoBox.appendChild(photoImg);
    photoIcon.appendChild(photoBox);
    
    var photoLabel = document.createElement('div');
    photoLabel.textContent = 'Photo';
    photoLabel.style.cssText = 'font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase';
    photoIcon.appendChild(photoLabel);
    
    // Insert as first icon
    iconRow.insertBefore(photoIcon, iconRow.firstChild);
  }
}

/**
 * Open photo in modal
 */
function openPhotoModal(photoUrl) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px';
  
  modal.onclick = function() {
    modal.remove();
  };
  
  var img = document.createElement('img');
  img.src = photoUrl;
  img.style.cssText = 'max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5)';
  img.onclick = function(e) {
    e.stopPropagation();
  };
  
  modal.appendChild(img);
  document.body.appendChild(modal);
}

/**
 * Mark profiling card as dirty ‚Üí glow Save button
 */
function markProfilingDirty() {
  window._profilingDirty = true;
  var btn = document.getElementById('profilingSaveBtn');
  if (btn) {
    btn.style.background = '#667eea';
    btn.style.color = '#fff';
    btn.style.borderColor = '#667eea';
    btn.style.boxShadow = '0 0 12px rgba(102,126,234,0.4)';
    btn.style.animation = 'none';
    void btn.offsetWidth;
    btn.style.animation = 'saveGlow 1.5s ease-in-out infinite';
    btn.innerHTML = 'üíæ Save *';
  }
  
  // Show floating save bar for table view
  if (profilingData.viewMode === 'table') {
    showTableSaveBar();
  }
}

function showTableSaveBar() {
  var existing = document.getElementById('tableSaveBar');
  if (existing) return; // already visible
  
  var bar = document.createElement('div');
  bar.id = 'tableSaveBar';
  bar.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#667eea,#764ba2);padding:12px 24px;border-radius:12px;box-shadow:0 4px 20px rgba(102,126,234,0.4);display:flex;align-items:center;gap:16px;z-index:9999;animation:fadeIn 0.3s ease';
  
  var text = document.createElement('span');
  text.textContent = 'Unsaved changes';
  text.style.cssText = 'color:#fff;font-size:13px;font-weight:600';
  bar.appendChild(text);
  
  var saveBtn = document.createElement('button');
  saveBtn.innerHTML = 'üíæ Save';
  saveBtn.style.cssText = 'padding:8px 20px;background:#fff;color:#667eea;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s';
  saveBtn.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
  saveBtn.onmouseout = function() { this.style.transform = 'scale(1)'; };
  saveBtn.onclick = function() {
    if (profilingData.selectedPlayer) {
      saveProfilingPlayer(profilingData.selectedPlayer);
    }
    hideTableSaveBar();
  };
  bar.appendChild(saveBtn);
  
  var cancelBtn = document.createElement('button');
  cancelBtn.textContent = '‚úï';
  cancelBtn.style.cssText = 'padding:6px 10px;background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer';
  cancelBtn.onclick = function() { hideTableSaveBar(); };
  bar.appendChild(cancelBtn);
  
  document.body.appendChild(bar);
}

function hideTableSaveBar() {
  var bar = document.getElementById('tableSaveBar');
  if (bar) bar.remove();
}

/**
 * Reset dirty state
 */
function resetProfilingDirty() {
  window._profilingDirty = false;
  hideTableSaveBar();
  var btn = document.getElementById('profilingSaveBtn');
  if (btn) {
    btn.style.background = '#e2e8f0';
    btn.style.color = '#94a3b8';
    btn.style.borderColor = '#cbd5e1';
    btn.style.boxShadow = 'none';
    btn.style.animation = 'none';
    btn.innerHTML = 'üíæ Save';
  }
}

function saveProfilingPlayer(player) {
  var saveBtn = document.getElementById('profilingSaveBtn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '‚è≥ Saving...';
    saveBtn.style.animation = 'none';
  }
  
  var dataToSave = {
    sheetName: player.sheetName,
    rowIndex: player.rowIndex
  };
  
  // Copy only ORIGINAL data fields (not normalized aliases)
  var keysToSave = player._originalKeys || Object.keys(player.data);
  keysToSave.forEach(function(key) {
    dataToSave[key] = player.data[key];
  });
  
  // Map photo to upload column
  if (player.data.photo) {
    dataToSave.upload = player.data.photo;
    console.log('üì∏ Mapping photo to UPLOAD column:');
    console.log('  Player:', player.data.email);
    console.log('  Photo URL:', player.data.photo);
    console.log('  Row:', player.rowIndex);
  } else {
    console.log('‚ö†Ô∏è No photo to save for player:', player.data.email);
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (saveBtn) {
        saveBtn.innerHTML = '‚úÖ Saved!';
        saveBtn.style.background = '#10b981';
        saveBtn.style.color = '#fff';
        saveBtn.style.borderColor = '#10b981';
        saveBtn.style.boxShadow = 'none';
      }
      showToast('‚úÖ Player saved!');
      // Refresh tabs & player list to reflect changes
      renderProfilingManagerTabs();
      populateTypeFilters();
      renderProfilingPlayers();
      setTimeout(function() {
        resetProfilingDirty();
        if (saveBtn) saveBtn.disabled = false;
      }, 1500);
    })
    .withFailureHandler(function(error) {
      if (saveBtn) {
        saveBtn.innerHTML = '‚ùå Error!';
        saveBtn.style.background = '#ef4444';
        saveBtn.style.color = '#fff';
        saveBtn.disabled = false;
      }
      showToast('‚ùå Save failed!');
      console.error('Failed to save player:', error);
      setTimeout(function() { markProfilingDirty(); }, 2000);
    })
    .updatePlayerProfiling(dataToSave);
}

/**
 * Silent save (no UI feedback) - used for auto-saving converted photo URLs
 */
function saveProfilingPlayerSilent(player) {
  var dataToSave = {
    sheetName: player.sheetName,
    rowIndex: player.rowIndex
  };
  
  // Copy only ORIGINAL data fields (not normalized aliases)
  var keysToSave = player._originalKeys || Object.keys(player.data);
  keysToSave.forEach(function(key) {
    dataToSave[key] = player.data[key];
  });
  
  // Map photo to upload column
  if (player.data.photo) {
    dataToSave.upload = player.data.photo;
    console.log('Mapping photo to UPLOAD column (silent):', player.data.photo);
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Photo URL saved silently to UPLOAD column');
    })
    .withFailureHandler(function(error) {
      console.error('Failed to save photo URL:', error);
    })
    .updatePlayerProfiling(dataToSave);
}

// ‚ïê‚ïê‚ïê PROFILING FILTERS ‚ïê‚ïê‚ïê
function openProfilingFilterSidebar() {
  populateProfilingFilterSidebar();
  document.getElementById('profilingFilterSidebar').classList.add('active');
  document.getElementById('profilingFilterOverlay').classList.add('active');
}
function closeProfilingFilterSidebar() {
  document.getElementById('profilingFilterSidebar').classList.remove('active');
  document.getElementById('profilingFilterOverlay').classList.remove('active');
  renderProfilingPlayers();
  renderProfilingManagerTabs();
  updateTypeTabCounts();
}

function populateProfilingFilterSidebar() {
  var sidebarBody = document.querySelector('#profilingFilterSidebar .sidebar-body');
  if (!sidebarBody) { console.error('Sidebar body not found'); return; }
  sidebarBody.innerHTML = '';
  
  var fieldValues = {};
  var fieldLabels = {};
  
  if (profilingData.fieldConfig) {
    Object.keys(profilingData.fieldConfig).forEach(function(key) {
      if (key.charAt(0) === '_') return;
      var field = profilingData.fieldConfig[key];
      if (!field) return;
      
      var isStarred = field.starred || key.charAt(0) === '*';
      if (!isStarred) return;
      
      var cleanLabel = (field.label || key)
        .replace(/\[ICON\]/g, '').replace(/\[BICON\]/g, '').replace(/\[PREV\]/g, '').replace(/^\*\s*/, '').trim();
      
      var lower = cleanLabel.toLowerCase();
      if (lower === 'email' || lower === 'name' || lower.indexOf('comment') !== -1) return;
      if (field.label && (field.label.indexOf('[ICON]') === 0 || field.label.indexOf('[BICON]') === 0)) return;
      
      fieldValues[key] = new Set();
      fieldLabels[key] = cleanLabel;
    });
  }
  
  console.log('Sidebar: found', Object.keys(fieldValues).length, 'starred fields:', Object.keys(fieldLabels));
  
  (profilingData.allPlayers || []).forEach(function(p) {
    Object.keys(fieldValues).forEach(function(key) {
      var val = p.data[key];
      if (val && String(val).trim() !== '' && String(val).trim() !== 'false') {
        fieldValues[key].add(String(val).trim());
      }
    });
  });
  
  Object.keys(fieldValues).forEach(function(key) {
    if (!profilingFilters[key]) profilingFilters[key] = [];
  });
  
  Object.keys(fieldValues).forEach(function(key) {
    var values = Array.from(fieldValues[key]).sort();
    if (values.length === 0 || values.length > 100) return;
    
    var group = document.createElement('div');
    group.className = 'sidebar-filter-group';
    
    var label = document.createElement('div');
    label.className = 'sidebar-filter-label';
    label.innerHTML = '<span>\u{1f3f7}\ufe0f</span><span>' + fieldLabels[key] + '</span>';
    group.appendChild(label);
    
    var safeId = 'profFilter_' + key.replace(/[^a-zA-Z0-9]/g, '_');
    
    if (values.length > 6) {
      var searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.className = 'sidebar-filter-search';
      searchInput.placeholder = 'Search ' + fieldLabels[key].toLowerCase() + '...';
      searchInput.setAttribute('data-list', safeId);
      searchInput.oninput = function() {
        var query = this.value.toLowerCase();
        var listEl = document.getElementById(this.getAttribute('data-list'));
        if (!listEl) return;
        Array.from(listEl.children).forEach(function(lbl) {
          lbl.style.display = lbl.textContent.toLowerCase().indexOf(query) !== -1 ? 'flex' : 'none';
        });
      };
      group.appendChild(searchInput);
    }
    
    var list = document.createElement('div');
    list.className = 'sidebar-filter-list';
    list.id = safeId;
    
    values.forEach(function(val) {
      var checked = (profilingFilters[key] || []).indexOf(val) !== -1;
      var lbl = document.createElement('label');
      lbl.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;font-size:13px;color:#334155';
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = checked;
      cb.className = 'sidebar-filter-checkbox';
      cb.style.cssText = 'width:16px;height:16px;cursor:pointer;accent-color:#667eea';
      cb.onchange = (function(k, v) {
        return function() {
          if (!profilingFilters[k]) profilingFilters[k] = [];
          if (this.checked) {
            if (profilingFilters[k].indexOf(v) === -1) profilingFilters[k].push(v);
          } else {
            profilingFilters[k] = profilingFilters[k].filter(function(x) { return x !== v; });
          }
        };
      })(key, val);
      lbl.appendChild(cb);
      var txt = document.createElement('span');
      txt.textContent = val;
      lbl.appendChild(txt);
      list.appendChild(lbl);
    });
    
    group.appendChild(list);
    sidebarBody.appendChild(group);
  });
  
  var activeCount = 0;
  Object.keys(profilingFilters).forEach(function(k) { activeCount += (profilingFilters[k] || []).length; });
  var btn = document.getElementById('profilingFilterBtn');
  if (btn) {
    btn.innerHTML = activeCount > 0 ? 'Filters (' + activeCount + ')' : 'Filters';
    if (activeCount > 0) {
      btn.style.background = 'rgba(139,92,246,0.2)';
      btn.style.borderColor = '#7c3aed';
    } else {
      btn.style.background = 'rgba(139,92,246,0.1)';
      btn.style.borderColor = 'rgba(139,92,246,0.3)';
    }
  }
}

function renderProfilingFilterList(containerId, values, filterKey) {
  var container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  values.forEach(function(val) {
    var checked = profilingFilters[filterKey].indexOf(val) !== -1;
    var label = document.createElement('label');
    label.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;font-size:13px;color:#334155';
    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = checked;
    cb.className = 'sidebar-filter-checkbox';
    cb.style.cssText = 'width:16px;height:16px;cursor:pointer;accent-color:#667eea';
    cb.onchange = function() {
      if (this.checked) {
        if (profilingFilters[filterKey].indexOf(val) === -1) profilingFilters[filterKey].push(val);
      } else {
        profilingFilters[filterKey] = profilingFilters[filterKey].filter(function(v) { return v !== val; });
      }
    };
    label.appendChild(cb);
    var text = document.createElement('span');
    text.textContent = val;
    label.appendChild(text);
    container.appendChild(label);
  });
}

function filterProfilingSidebarList(input, containerId) {
  var query = input.value.toLowerCase();
  var container = document.getElementById(containerId);
  if (!container) return;
  Array.from(container.children).forEach(function(label) {
    var text = label.textContent.toLowerCase();
    label.style.display = text.indexOf(query) !== -1 ? 'flex' : 'none';
  });
}

function clearProfilingFilters() {
  // Reset all filter keys
  Object.keys(profilingFilters).forEach(function(k) { profilingFilters[k] = []; });
  profilingFilters = {};
  document.querySelectorAll('#profilingFilterSidebar .sidebar-filter-checkbox').forEach(function(cb) { cb.checked = false; });
  var btn = document.getElementById('profilingFilterBtn');
  if (btn) {
    btn.innerHTML = 'üîç Filters';
    btn.style.background = 'rgba(139,92,246,0.1)';
    btn.style.borderColor = 'rgba(139,92,246,0.3)';
  }
  renderProfilingPlayers();
  renderProfilingManagerTabs();
  updateTypeTabCounts();
}

function toggleProfilingView() {
  var container = document.getElementById('profilingPlayersContainer');
  var btn = document.getElementById('profilingViewToggle');
  
  if (!container || !btn) return;
  
  if (profilingData.viewMode === 'grid') {
    profilingData.viewMode = 'list';
    btn.innerHTML = '<span id="profilingViewIcon">‚ò∞</span> List';
  } else if (profilingData.viewMode === 'list') {
    profilingData.viewMode = 'table';
    btn.innerHTML = '<span id="profilingViewIcon">üìä</span> Table';
  } else {
    profilingData.viewMode = 'grid';
    btn.innerHTML = '<span id="profilingViewIcon">‚äû</span> Grid';
  }
  
  renderProfilingPlayers();
}

/**
 * Toggle alphabetical sort
 */
function toggleProfilingSortMenu() {
  var menu = document.getElementById('profilingSortMenu');
  if (!menu) return;
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  
  // Highlight active sort
  var currentSort = profilingData.sortField || 'none';
  menu.querySelectorAll('.profiling-sort-opt').forEach(function(opt) {
    if (opt.dataset.sort === currentSort) {
      opt.style.background = '#f0f4ff';
      opt.style.fontWeight = '700';
    } else {
      opt.style.background = '';
      opt.style.fontWeight = '';
    }
    opt.onmouseover = function() { this.style.background = '#f8fafc'; };
    opt.onmouseout = function() { this.style.background = this.dataset.sort === currentSort ? '#f0f4ff' : ''; };
  });
  
  // Close on outside click
  setTimeout(function() {
    document.addEventListener('click', function closeSort(e) {
      if (!menu.contains(e.target) && e.target.id !== 'profilingSortBtn') {
        menu.style.display = 'none';
        document.removeEventListener('click', closeSort);
      }
    });
  }, 10);
}

function setProfilingSort(field) {
  var menu = document.getElementById('profilingSortMenu');
  
  // Toggle direction if same date field clicked again
  var isDateField = ['reg_date','last_deposit','vip_date'].indexOf(field) !== -1;
  if (isDateField && profilingData.sortField === field) {
    profilingData.sortDirection = profilingData.sortDirection === 'desc' ? 'asc' : 'desc';
  } else {
    profilingData.sortDirection = 'desc'; // default: newest first
  }
  
  if (menu) menu.style.display = 'none';
  
  profilingData.sortField = field === 'none' ? null : field;
  profilingData.sortAlpha = (field === 'alpha');
  
  var btn = document.getElementById('profilingSortBtn');
  if (btn) {
    var dir = profilingData.sortDirection === 'desc' ? '‚Üì' : '‚Üë';
    var labels = {alpha:'üî§ A‚ÜíZ', reg_date:'üìÖ Reg ' + dir, last_deposit:'üí∞ Deposit ' + dir, vip_date:'‚≠ê VIP ' + dir, none:'üî§ Sort ‚ñæ'};
    btn.innerHTML = (labels[field] || 'üî§ Sort ‚ñæ') + (field !== 'none' ? ' ‚úì' : ' ‚ñæ');
    if (field !== 'none') {
      btn.style.background = 'rgba(245,158,11,0.25)';
      btn.style.borderColor = '#d97706';
    } else {
      btn.style.background = 'rgba(245,158,11,0.1)';
      btn.style.borderColor = 'rgba(245,158,11,0.3)';
    }
  }
  
  // Update direction arrows in menu
  var dirLabel = profilingData.sortDirection === 'desc' ? '‚Üì New first' : '‚Üë Old first';
  ['sortDirReg','sortDirDep','sortDirVip'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.textContent = dirLabel;
  });
  
  renderProfilingPlayers();
}

/**
 * Toggle Analytics view
 */
function toggleProfilingAnalytics() {
  var playersContainer = document.getElementById('profilingPlayersContainer');
  var analyticsContainer = document.getElementById('profilingAnalyticsContainer');
  var btn = document.getElementById('profilingAnalyticsBtn');
  
  if (!playersContainer || !analyticsContainer || !btn) return;
  
  if (analyticsContainer.style.display === 'none') {
    // Show analytics
    playersContainer.style.display = 'none';
    analyticsContainer.style.display = 'block';
    btn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
    btn.style.color = '#fff';
    btn.style.border = 'none';
    
    // Render analytics
    renderProfilingAnalytics();
  } else {
    // Show players
    playersContainer.style.display = '';
    renderProfilingPlayers();
    analyticsContainer.style.display = 'none';
    btn.style.background = 'rgba(16,185,129,0.1)';
    btn.style.color = '#059669';
    btn.style.border = '1px solid rgba(16,185,129,0.3)';
  }
}

/**
 * Render Analytics view ‚Äî improved with summary cards + better charts
 */
function renderProfilingAnalytics() {
  var container = document.getElementById('profilingAnalyticsContainer');
  if (!container) return;
  
  if (!profilingData.charts) {
    profilingData.charts = new Array(6).fill(null);
    profilingData.chartsPerRow = 3;
  }
  
  container.innerHTML = '';
  container.style.cssText = 'padding:20px;overflow-y:auto;max-height:calc(100vh - 200px)';
  
  // Get current filtered players
  var managerName = profilingData.activeManager;
  var managerTags = managerMapping[managerName] || [];
  var players = (profilingData.allPlayers || []).filter(function(p) {
    var pt = (p.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    for (var i = 0; i < pt.length; i++) if (managerTags.indexOf(pt[i]) !== -1) return true;
    return false;
  });
  
  // === SUMMARY CARDS ===
  var summaryRow = document.createElement('div');
  summaryRow.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:24px';
  
  // Count stats
  var typeCounts = {};
  var countryCounts = {};
  var newcomerCount = 0;
  players.forEach(function(p) {
    var t = getPlayerType(p) || 'Unknown';
    typeCounts[t] = (typeCounts[t] || 0) + 1;
    var c = p.data.country || p.data.Country || p.data.COUNTRY || '';
    if (c) countryCounts[c] = (countryCounts[c] || 0) + 1;
    try { if (isNewcomer(p)) newcomerCount++; } catch(e) {}
  });
  
  var summaryCards = [
    { label: 'Total Players', value: players.length, icon: 'üë•', color: '#667eea' },
    { label: 'Countries', value: Object.keys(countryCounts).length, icon: 'üåç', color: '#06b6d4' },
    { label: 'Newcomers', value: newcomerCount, icon: 'üÜï', color: '#10b981' }
  ];
  
  // Add TOTAL group counts first, then sub-types
  var hasTG = Object.keys(totalGroups).length > 0;
  var tgColors = {'VIP':'#f59e0b','PRE-VIP':'#3b82f6','PRE VIP':'#3b82f6'};
  var subColors = {'VIP':'#f59e0b','SILENT VIP':'#8b5cf6','PRE-VIP':'#3b82f6','SILENT PRE-VIP':'#a855f7','CHURNED VIP':'#ef4444'};
  if (hasTG) {
    Object.keys(totalGroups).sort().forEach(function(grp) {
      var grpTypes = totalGroups[grp];
      var grpCount = 0;
      grpTypes.forEach(function(t) { grpCount += (typeCounts[t] || 0); });
      summaryCards.push({ label: '‚àë ' + grp, value: grpCount, icon: 'üìä', color: tgColors[grp.toUpperCase()] || '#8b5cf6' });
      grpTypes.sort().forEach(function(t) {
        summaryCards.push({ label: '  ' + t, value: typeCounts[t] || 0, icon: 'üëë', color: subColors[t.toUpperCase()] || '#64748b' });
      });
    });
  } else {
    Object.keys(typeCounts).sort().forEach(function(t) {
      summaryCards.push({ label: t, value: typeCounts[t], icon: 'üëë', color: subColors[t.toUpperCase()] || '#64748b' });
    });
  }
  
  summaryCards.forEach(function(card) {
    var el = document.createElement('div');
    el.style.cssText = 'background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;display:flex;align-items:center;gap:12px;transition:all 0.2s;cursor:default';
    el.onmouseover = function() { this.style.transform = 'translateY(-2px)'; this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.06)'; };
    el.onmouseout = function() { this.style.transform = ''; this.style.boxShadow = ''; };
    
    var iconEl = document.createElement('div');
    iconEl.textContent = card.icon;
    iconEl.style.cssText = 'width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;background:' + hexToRgba(card.color, 0.1);
    el.appendChild(iconEl);
    
    var textBlock = document.createElement('div');
    var valEl = document.createElement('div');
    valEl.textContent = card.value;
    valEl.style.cssText = 'font-size:22px;font-weight:800;color:' + card.color;
    textBlock.appendChild(valEl);
    var lblEl = document.createElement('div');
    lblEl.textContent = card.label;
    lblEl.style.cssText = 'font-size:11px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:0.03em';
    textBlock.appendChild(lblEl);
    el.appendChild(textBlock);
    
    summaryRow.appendChild(el);
  });
  container.appendChild(summaryRow);
  
  // === TOOLBAR: Layout + chart count ===
  var toolbar = document.createElement('div');
  toolbar.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:10px 16px;background:#fff;border:1px solid #e2e8f0;border-radius:12px';
  
  var layoutLabel = document.createElement('span');
  layoutLabel.textContent = 'Charts:';
  layoutLabel.style.cssText = 'font-size:12px;font-weight:700;color:#64748b';
  toolbar.appendChild(layoutLabel);
  
  var layoutGroup = document.createElement('div');
  layoutGroup.style.cssText = 'display:flex;gap:3px;background:#f1f5f9;padding:3px;border-radius:8px';
  
  [{ cols: 1, label: '1' }, { cols: 2, label: '2' }, { cols: 3, label: '3' }].forEach(function(opt) {
    var btn = document.createElement('button');
    btn.textContent = opt.label;
    var isActive = (profilingData.chartsPerRow || 3) === opt.cols;
    btn.style.cssText = 'width:32px;height:28px;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.15s;' +
      (isActive ? 'background:#667eea;color:#fff' : 'background:transparent;color:#64748b');
    btn.onclick = function() {
      profilingData.chartsPerRow = opt.cols;
      renderProfilingAnalytics();
    };
    layoutGroup.appendChild(btn);
  });
  toolbar.appendChild(layoutGroup);
  
  var totalInfo = document.createElement('span');
  totalInfo.textContent = players.length + ' players from ' + managerName;
  totalInfo.style.cssText = 'font-size:11px;color:#94a3b8;font-weight:600;margin-left:auto';
  toolbar.appendChild(totalInfo);
  container.appendChild(toolbar);
  
  // === CHARTS GRID ===
  var numCharts = profilingData.chartsPerRow || 3;
  var chartsGrid = document.createElement('div');
  chartsGrid.id = 'profilingChartsGrid';
  chartsGrid.style.cssText = 'display:grid;grid-template-columns:repeat(' + numCharts + ',1fr);gap:16px';
  container.appendChild(chartsGrid);
  
  // Auto-select analytics fields
  var analyticsFields = [];
  var fo = profilingData.fieldConfig._order || Object.keys(profilingData.fieldConfig);
  fo.forEach(function(fk) {
    if (fk === '_order' || fk === '_sections' || fk === 'email') return;
    var fi = profilingData.fieldConfig[fk];
    if (fi && fi.analytics) analyticsFields.push({ key: fk, label: fi.label });
  });
  
  for (var i = 0; i < numCharts; i++) {
    var chartCard = document.createElement('div');
    chartCard.style.cssText = 'background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:0 1px 3px rgba(0,0,0,0.04);transition:box-shadow 0.2s';
    chartCard.onmouseover = function() { this.style.boxShadow = '0 4px 16px rgba(0,0,0,0.08)'; };
    chartCard.onmouseout = function() { this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.04)'; };
    chartCard.dataset.chartCard = i;
    
    // Controls row
    var controls = document.createElement('div');
    controls.style.cssText = 'display:flex;gap:8px;align-items:center';
    
    var select = document.createElement('select');
    select.dataset.chartIndex = i;
    select.style.cssText = 'flex:1;padding:8px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;color:#1e293b;font-size:12px;font-weight:600;outline:none;cursor:pointer';
    
    var emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = '‚Äî Select field ‚Äî';
    select.appendChild(emptyOpt);
    
    analyticsFields.forEach(function(af) {
      var opt = document.createElement('option');
      opt.value = af.key;
      opt.textContent = af.label;
      select.appendChild(opt);
    });
    
    // Auto-select first N fields
    if (analyticsFields[i]) {
      select.value = analyticsFields[i].key;
    }
    
    select.onchange = function() {
      var ci = parseInt(this.dataset.chartIndex);
      var card = this.closest('[data-chart-card]');
      var activeBtn = card.querySelector('.chart-type-active');
      var ct = activeBtn ? activeBtn.dataset.type : 'donut';
      if (this.value) renderProfilingChart(ci, this.value, ct);
    };
    controls.appendChild(select);
    
    // Chart type toggle (donut / bar)
    var toggle = document.createElement('div');
    toggle.style.cssText = 'display:flex;gap:2px;background:#f1f5f9;padding:3px;border-radius:8px';
    
    ['donut', 'bar'].forEach(function(type, tIdx) {
      var btn = document.createElement('button');
      btn.dataset.type = type;
      btn.dataset.chartIndex = i;
      btn.textContent = type === 'donut' ? '‚óâ' : '‚ñ•';
      btn.title = type === 'donut' ? 'Donut chart' : 'Bar chart';
      var isFirst = tIdx === 0;
      btn.style.cssText = 'width:30px;height:26px;border:none;border-radius:6px;font-size:14px;cursor:pointer;transition:all 0.15s;' +
        (isFirst ? 'background:#667eea;color:#fff' : 'background:transparent;color:#94a3b8');
      if (isFirst) btn.classList.add('chart-type-active');
      
      btn.onclick = function() {
        var ci = parseInt(this.dataset.chartIndex);
        var card = this.closest('[data-chart-card]');
        card.querySelectorAll('[data-type]').forEach(function(b) {
          b.classList.remove('chart-type-active');
          b.style.background = 'transparent'; b.style.color = '#94a3b8';
        });
        this.classList.add('chart-type-active');
        this.style.background = '#667eea'; this.style.color = '#fff';
        var sel = card.querySelector('select');
        if (sel.value) renderProfilingChart(ci, sel.value, type);
      };
      toggle.appendChild(btn);
    });
    controls.appendChild(toggle);
    chartCard.appendChild(controls);
    
    // Chart area
    var chartArea = document.createElement('div');
    chartArea.id = 'profilingChart-' + i;
    chartArea.style.cssText = 'height:260px;position:relative';
    
    if (!analyticsFields[i]) {
      chartArea.innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#cbd5e1;font-size:13px;font-weight:600">Select a field above</div>';
    }
    chartCard.appendChild(chartArea);
    chartsGrid.appendChild(chartCard);
  }
  
  // Auto-render charts for pre-selected fields
  for (var j = 0; j < numCharts; j++) {
    if (analyticsFields[j]) {
      renderProfilingChart(j, analyticsFields[j].key, 'donut');
    }
  }
}

/**
 * Render single chart ‚Äî donut or bar
 */
function renderProfilingChart(index, fieldKey, chartType) {
  var container = document.getElementById('profilingChart-' + index);
  if (!container) return;
  
  container.innerHTML = '';
  
  // Get filtered players (same filter as current manager)
  var managerTags = managerMapping[profilingData.activeManager] || [];
  var allPlayers = (profilingData.allPlayers || []).filter(function(p) {
    var pt = (p.tags || []).map(function(t) { return String(t).toLowerCase().trim(); });
    for (var i = 0; i < pt.length; i++) if (managerTags.indexOf(pt[i]) !== -1) return true;
    return false;
  });
  
  // Count distribution
  var distribution = {};
  allPlayers.forEach(function(p) {
    var v = p.data[fieldKey];
    var dv = 'Empty';
    if (v === true || v === 'TRUE' || v === 'true') dv = 'Yes';
    else if (v === false || v === 'FALSE' || v === 'false') dv = 'No';
    else if (v !== null && v !== undefined && String(v).trim() !== '') dv = String(v);
    distribution[dv] = (distribution[dv] || 0) + 1;
  });
  
  // Sort by count descending
  var entries = Object.keys(distribution).map(function(k) { return { label: k, value: distribution[k] }; });
  entries.sort(function(a, b) { return b.value - a.value; });
  
  var labels = entries.map(function(e) { return e.label; });
  var data = entries.map(function(e) { return e.value; });
  var total = data.reduce(function(s, v) { return s + v; }, 0);
  
  var colors = ['#667eea','#8b5cf6','#10b981','#f59e0b','#ef4444','#06b6d4','#ec4899','#6366f1','#14b8a6','#f97316','#84cc16','#a855f7'];
  
  // Legend
  var legend = document.createElement('div');
  legend.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px 12px;margin-bottom:8px';
  
  labels.forEach(function(label, i) {
    var item = document.createElement('div');
    item.style.cssText = 'display:flex;align-items:center;gap:4px;font-size:11px;color:#475569';
    var dot = document.createElement('span');
    dot.style.cssText = 'width:8px;height:8px;border-radius:2px;flex-shrink:0;background:' + colors[i % colors.length];
    item.appendChild(dot);
    var pct = total > 0 ? ((data[i] / total) * 100).toFixed(0) : 0;
    var txt = document.createElement('span');
    txt.innerHTML = '<b>' + label + '</b> ' + data[i] + ' <span style="color:#94a3b8">(' + pct + '%)</span>';
    item.appendChild(txt);
    legend.appendChild(item);
  });
  container.appendChild(legend);
  
  // Canvas
  var canvas = document.createElement('canvas');
  container.appendChild(canvas);
  
  var ctx = canvas.getContext('2d');
  canvas.width = container.clientWidth || 300;
  canvas.height = 220;
  var dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.width * dpr;
  canvas.height = 220 * dpr;
  canvas.style.width = (canvas.width / dpr) + 'px';
  canvas.style.height = '220px';
  ctx.scale(dpr, dpr);
  var W = canvas.width / dpr, H = 220;
  
  if (chartType === 'donut' || chartType === 'pie') {
    // DONUT CHART
    var cx = W / 2, cy = H / 2;
    var outerR = Math.min(cx, cy) - 10;
    var innerR = outerR * 0.55;
    var angle = -Math.PI / 2;
    
    data.forEach(function(v, i) {
      var sliceAngle = (v / total) * 2 * Math.PI;
      ctx.fillStyle = colors[i % colors.length];
      ctx.beginPath();
      ctx.arc(cx, cy, outerR, angle, angle + sliceAngle);
      ctx.arc(cx, cy, innerR, angle + sliceAngle, angle, true);
      ctx.closePath();
      ctx.fill();
      
      // Separator line
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(cx + Math.cos(angle) * innerR, cy + Math.sin(angle) * innerR);
      ctx.lineTo(cx + Math.cos(angle) * outerR, cy + Math.sin(angle) * outerR);
      ctx.stroke();
      
      angle += sliceAngle;
    });
    
    // Center text
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold ' + Math.round(outerR * 0.28) + 'px system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(total, cx, cy - 6);
    ctx.fillStyle = '#94a3b8';
    ctx.font = '600 11px system-ui, sans-serif';
    ctx.fillText('players', cx, cy + 14);
    
  } else {
    // BAR CHART
    var padL = 40, padR = 10, padT = 10, padB = 40;
    var chartW = W - padL - padR;
    var chartH = H - padT - padB;
    var maxVal = Math.max.apply(null, data) || 1;
    var barCount = data.length;
    var barW = Math.min(chartW / barCount, 60);
    var gap = barCount > 1 ? (chartW - barW * barCount) / (barCount - 1) : 0;
    var offsetX = padL + (chartW - (barW * barCount + gap * (barCount - 1))) / 2;
    
    // Grid lines
    ctx.strokeStyle = '#f1f5f9';
    ctx.lineWidth = 1;
    for (var g = 0; g <= 4; g++) {
      var gy = padT + chartH - (chartH * g / 4);
      ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(W - padR, gy); ctx.stroke();
      ctx.fillStyle = '#94a3b8';
      ctx.font = '10px system-ui, sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      ctx.fillText(Math.round(maxVal * g / 4), padL - 6, gy);
    }
    
    // Bars with animation
    var startTime = Date.now();
    var duration = 500;
    
    var animateBars = function() {
      var elapsed = Date.now() - startTime;
      var progress = Math.min(elapsed / duration, 1);
      var eased = 1 - Math.pow(1 - progress, 3);
      
      ctx.clearRect(padL, 0, W, H - padB + 5);
      
      // Redraw grid
      ctx.strokeStyle = '#f1f5f9'; ctx.lineWidth = 1;
      for (var g2 = 0; g2 <= 4; g2++) {
        var gy2 = padT + chartH - (chartH * g2 / 4);
        ctx.beginPath(); ctx.moveTo(padL, gy2); ctx.lineTo(W - padR, gy2); ctx.stroke();
      }
      
      data.forEach(function(v, i) {
        var barH = (v / maxVal) * chartH * eased;
        var x = offsetX + i * (barW + gap);
        var y = padT + chartH - barH;
        var r = Math.min(4, barW / 4);
        
        // Rounded top bar
        ctx.fillStyle = colors[i % colors.length];
        ctx.beginPath();
        ctx.moveTo(x, padT + chartH);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.lineTo(x + barW - r, y);
        ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
        ctx.lineTo(x + barW, padT + chartH);
        ctx.closePath();
        ctx.fill();
        
        // Value on top
        if (progress >= 0.8) {
          ctx.fillStyle = '#1e293b';
          ctx.font = 'bold 11px system-ui, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(v, x + barW / 2, y - 4);
        }
        
        // Label below
        ctx.fillStyle = '#64748b';
        ctx.font = '600 10px system-ui, sans-serif';
        ctx.textAlign = 'center';
        var lbl = labels[i].length > 10 ? labels[i].substring(0, 9) + '‚Ä¶' : labels[i];
        ctx.fillText(lbl, x + barW / 2, padT + chartH + 16);
      });
      
      if (progress < 1) requestAnimationFrame(animateBars);
    };
    animateBars();
  }
}

// Player Profiling Search
var profilingSearch = document.getElementById('profilingSearchInput');
var profSuggest = document.getElementById('profSearchSuggest');
if (profilingSearch && profSuggest) {
  var suggestTimer = null;
  
  profilingSearch.addEventListener('input', function() {
    var q = this.value.toLowerCase().trim();
    profilingData.searchQuery = q;
    
    clearTimeout(suggestTimer);
    if (!q || q.length < 2) {
      profSuggest.classList.remove('open');
      renderProfilingPlayers();
      return;
    }
    
    suggestTimer = setTimeout(function() {
      var players = profilingData.allPlayers || [];
      var matches = [];
      for (var i = 0; i < players.length && matches.length < 8; i++) {
        var p = players[i];
        var d = p.data || p;
        var name = String(d.name || d.first_name || '').toLowerCase();
        var email = String(d.email || d.EMAIL || '').toLowerCase();
        var id = String(d.id || d.ID || '').toLowerCase();
        if (name.indexOf(q) !== -1 || email.indexOf(q) !== -1 || id.indexOf(q) !== -1) {
          matches.push(p);
        }
      }
      
      if (matches.length === 0) {
        profSuggest.classList.remove('open');
        renderProfilingPlayers();
        return;
      }
      
      profSuggest.innerHTML = '';
      matches.forEach(function(p) {
        var div = document.createElement('div');
        div.className = 'prof-search-suggest-item';
        var d = p.data || p;
        var pName = d.name || ((d.first_name || '') + ' ' + (d.last_name || '')).trim();
        var pEmail = d.email || d.EMAIL || '';
        var pType = getPlayerTypeFromTags(p.tags || d.tags) || '';
        div.innerHTML = '<div><div class="pss-name">' + escapeHtml(pName || d.id || '') + '</div><div class="pss-email">' + escapeHtml(pEmail) + '</div></div>' + (pType ? '<span class="pss-type">' + escapeHtml(pType) + '</span>' : '');
        div.onmousedown = function(e) {
          e.preventDefault();
          profilingSearch.value = pEmail || pName;
          profilingData.searchQuery = (pEmail || pName).toLowerCase();
          profSuggest.classList.remove('open');
          renderProfilingPlayers();
          setTimeout(function() { openProfilingPlayer(p); }, 100);
        };
        profSuggest.appendChild(div);
      });
      profSuggest.classList.add('open');
      renderProfilingPlayers();
    }, 150);
  });
  
  profilingSearch.addEventListener('blur', function() {
    setTimeout(function() { profSuggest.classList.remove('open'); }, 200);
  });
  profilingSearch.addEventListener('focus', function() {
    if (this.value.length >= 2) this.dispatchEvent(new Event('input'));
  });
}

function openProfilingAddModal() {
  if (!profilingData.activeManager) {
    alert('Please select a manager first');
    return;
  }
  
  // Create modal
  var modal = document.createElement('div');
  modal.id = 'profilingAddModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center';
  
  var modalContent = document.createElement('div');
  modalContent.style.cssText = 'background:#fff;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)';
  
  var header = document.createElement('div');
  header.style.cssText = 'padding:24px;border-bottom:2px solid #e2e8f0;background:linear-gradient(135deg,#10b981,#059669);display:flex;justify-content:space-between;align-items:center';
  
  var title = document.createElement('h2');
  title.textContent = '‚ûï Add New Player - ' + profilingData.activeManager;
  title.style.cssText = 'margin:0;color:#fff;font-size:20px;font-weight:800';
  header.appendChild(title);
  
  var closeBtn = document.createElement('button');
  closeBtn.textContent = '√ó';
  closeBtn.style.cssText = 'background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:32px;cursor:pointer;width:40px;height:40px;border-radius:8px;transition:all 0.2s';
  closeBtn.onclick = function() { modal.remove(); };
  closeBtn.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.3)'; };
  closeBtn.onmouseout = function() { this.style.background = 'rgba(255,255,255,0.2)'; };
  header.appendChild(closeBtn);
  
  modalContent.appendChild(header);
  
  var body = document.createElement('div');
  body.style.cssText = 'padding:24px';
  
  var fieldsGrid = document.createElement('div');
  fieldsGrid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:16px 20px';
  
  var fieldsOrder = profilingData.fieldConfig._order || Object.keys(profilingData.fieldConfig);
  
  fieldsOrder.forEach(function(key) {
    if (key === '_order' || key === '_sections') return;
    
    var fieldInfo = profilingData.fieldConfig[key];
    if (!fieldInfo) return;
    
    var fieldEl = document.createElement('div');
    fieldEl.style.cssText = 'display:flex;flex-direction:column;gap:6px';
    
    if (key === 'email') {
      fieldEl.style.gridColumn = '1 / -1';
    }
    
    var label = document.createElement('div');
    label.textContent = fieldInfo.label + (key === 'email' ? ' *' : '');
    label.style.cssText = 'font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.05em';
    fieldEl.appendChild(label);
    
    var input;
    if (fieldInfo.type === 'checkbox') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.dataset.field = key;
    } else if (fieldInfo.type === 'dropdown' && fieldInfo.options) {
      input = document.createElement('select');
      input.dataset.field = key;
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
      
      var emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '-- Select --';
      input.appendChild(emptyOpt);
      
      fieldInfo.options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        input.appendChild(option);
      });
    } else if (fieldInfo.type === 'date') {
      input = document.createElement('input');
      input.type = 'date';
      input.dataset.field = key;
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.dataset.field = key;
      input.placeholder = 'Enter ' + fieldInfo.label.toLowerCase();
      input.style.cssText = 'padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;outline:none';
      
      if (key === 'email') {
        input.required = true;
      }
    }
    
    fieldEl.appendChild(input);
    fieldsGrid.appendChild(fieldEl);
  });
  
  body.appendChild(fieldsGrid);
  modalContent.appendChild(body);
  
  var footer = document.createElement('div');
  footer.style.cssText = 'padding:20px 24px;border-top:1px solid #e2e8f0;display:flex;gap:12px;justify-content:flex-end';
  
  var cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cssText = 'padding:10px 24px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;font-weight:700;cursor:pointer';
  cancelBtn.onclick = function() { modal.remove(); };
  footer.appendChild(cancelBtn);
  
  var saveBtn = document.createElement('button');
  saveBtn.textContent = 'üíæ Save Player';
  saveBtn.style.cssText = 'padding:10px 24px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer';
  saveBtn.onclick = function() {
    saveProfilingNewPlayer(modal);
  };
  footer.appendChild(saveBtn);
  
  modalContent.appendChild(footer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}

function saveProfilingNewPlayer(modal) {
  var inputs = modal.querySelectorAll('input, select');
  var newPlayerData = {
    sheetName: profilingData.activeManager
  };
  
  var emailProvided = false;
  
  inputs.forEach(function(input) {
    var fieldKey = input.dataset.field;
    
    if (input.type === 'checkbox') {
      newPlayerData[fieldKey] = input.checked;
    } else {
      newPlayerData[fieldKey] = input.value;
      
      if (fieldKey === 'email' && input.value) {
        emailProvided = true;
      }
    }
  });
  
  if (!emailProvided) {
    alert('‚ùå Email is required!');
    return;
  }
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function() {
        alert('‚úÖ Player added successfully!');
        modal.remove();
        
        // Reload data
        initializePlayerProfiling();
      })
      .withFailureHandler(function(error) {
        alert('‚ùå Error: ' + error.message);
      })
      .addPlayerProfiling(newPlayerData);
  } else {
    alert('Google Apps Script not available');
  }
}

function renderPlayerMetrics(player) {
  var container = document.getElementById('vipPlayerMetrics');
  
  var metrics = [
    {
      section: 'Lifetime',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.lifetime_deposit_sum_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.lifetime_cashout_sum_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.lifetime_deposit_sum_total || 0) - Math.abs(player.lifetime_cashout_sum_total || 0), format: 'inout'},
        {icon: 'üî¢', label: 'Deposit Count', value: player.lifetime_deposit_count_total || 0, format: 'number'}
      ]
    },
    {
      section: 'Last 30 Days',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.deposit_sum_last_30_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.cashout_sum_last_30_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.deposit_sum_last_30_total || 0) - Math.abs(player.cashout_sum_last_30_total || 0), format: 'inout'},
        {icon: 'üî¢', label: 'Deposit Count', value: player.deposit_count_last_30_total || 0, format: 'number'}
      ]
    },
    {
      section: 'Last 7 Days',
      items: [
        {icon: 'üí∞', label: 'Deposit Sum', value: player.deposit_sum_last_7_total || 0, format: 'currency'},
        {icon: 'üí∏', label: 'Cashout Sum', value: Math.abs(player.cashout_sum_last_7_total || 0), format: 'currency'},
        {icon: 'üéØ', label: 'INOUT', value: (player.deposit_sum_last_7_total || 0) - Math.abs(player.cashout_sum_last_7_total || 0), format: 'inout'}
      ]
    },
    {
      section: 'Player Info',
      items: [
        {icon: 'üåç', label: 'Country', value: player.country || 'Unknown', format: 'text'},
        {icon: 'üë§', label: 'Gender', value: player.gender || 'Unknown', format: 'text'},
        {icon: 'üí¨', label: 'Locale', value: player.locale || 'Unknown', format: 'text'}
      ]
    }
  ];
  
  var html = '';
  
  metrics.forEach(function(section) {
    html += '<div style="margin-bottom:24px">';
    html += '<h4 style="font-size:14px;font-weight:600;color:#64748b;margin:0 0 12px 0;text-transform:uppercase;letter-spacing:0.5px">' + section.section + '</h4>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">';
    
    section.items.forEach(function(metric) {
      var displayValue = '';
      var valueColor = '#1e293b';
      var bgColor = '#f8fafc';
      
      if (metric.format === 'currency') {
        displayValue = '‚Ç¨' + metric.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        bgColor = '#ffffff';
      } else if (metric.format === 'number') {
        displayValue = Math.round(metric.value).toLocaleString();
        bgColor = '#ffffff';
      } else if (metric.format === 'inout') {
        displayValue = '‚Ç¨' + Math.abs(metric.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (metric.value >= 0) {
          valueColor = '#10b981';
          bgColor = '#f0fdf4';
        } else {
          valueColor = '#ef4444';
          bgColor = '#fef2f2';
        }
      } else {
        displayValue = metric.value;
        bgColor = '#ffffff';
      }
      
      html += '<div style="background:' + bgColor + ';padding:12px;border-radius:8px;border:1px solid #e2e8f0;transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">';
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">';
      html += '<span style="font-size:16px">' + metric.icon + '</span>';
      html += '<span style="font-size:11px;color:#64748b;font-weight:600">' + metric.label + '</span>';
      html += '</div>';
      html += '<div style="font-size:20px;font-weight:700;color:' + valueColor + '">' + displayValue + '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function renderPlayerDetails(player) {
  var container = document.getElementById('vipPlayerDetails');
  
  // Helper function to format date of birth
  function formatDateOfBirth(dob) {
    if (!dob) return '‚Äî';
    
    // If it's a Unix timestamp (number)
    if (typeof dob === 'number' || (typeof dob === 'string' && /^\d+$/.test(dob))) {
      var timestamp = parseInt(dob);
      if (isNaN(timestamp)) return '‚Äî';
      
      // Unix timestamp in seconds
      var date = timestamp < 10000000000 ? new Date(timestamp * 1000) : new Date(timestamp);
      
      if (isNaN(date.getTime())) return '‚Äî';
      
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      
      // Calculate age
      var today = new Date();
      var age = today.getFullYear() - year;
      if (today.getMonth() < date.getMonth() || 
          (today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) {
        age--;
      }
      
      return day + '.' + month + '.' + year + ' (age: ' + age + ')';
    }
    
    return dob;
  }
  
  var sections = [
    {
      title: 'üë§ Personal Information',
      icon: 'üë§',
      fields: [
        {label: 'Player ID', value: (player.id || '').replace('slotornado:', ''), link: true, icon: 'üÜî'},
        {label: 'First Name', value: player.first_name, icon: '‚úèÔ∏è'},
        {label: 'Last Name', value: player.last_name, icon: '‚úèÔ∏è'},
        {label: 'Email', value: player.email, icon: 'üìß'},
        {label: 'Phone', value: player.phone, icon: 'üìû'},
        {label: 'Gender', value: player.gender, icon: '‚ö•'},
        {label: 'Date of Birth', value: formatDateOfBirth(player.date_of_birth), icon: 'üéÇ'}
      ]
    },
    {
      title: 'üè¶ Account Details',
      icon: 'üè¶',
      fields: [
        {label: 'Registration Date', value: formatUnixTimestamp(player.created_at), icon: 'üìÖ'},
        {label: 'Last Visit', value: formatUnixTimestamp(player._last_visit), icon: 'üïí'},
        {label: 'Country', value: player.country, icon: 'üåç'},
        {label: 'Currency', value: player.currency, icon: 'üí∞'},
        {label: 'Locale', value: player.locale, icon: 'üåê'},
        {label: 'Disabled', value: player.disabled ? 'Yes' : 'No', icon: player.disabled ? 'üö´' : '‚úÖ'}
      ]
    },
    {
      title: 'üëë VIP & Marketing',
      icon: 'üëë',
      fields: [
        {label: 'Manager', value: getPlayerManager(player), icon: 'üë®‚Äçüíº'},
        {label: 'Tags', value: player.tags, icon: 'üè∑Ô∏è'},
        {label: 'Agreed to Promotions', value: player.agreed_to_partner_promotions ? 'Yes' : 'No', icon: player.agreed_to_partner_promotions ? '‚úÖ' : '‚ùå'},
        {label: 'Receive Promos', value: player.receive_promos ? 'Yes' : 'No', icon: player.receive_promos ? '‚úÖ' : '‚ùå'},
        {label: 'Receive SMS Promos', value: player.receive_sms_promos ? 'Yes' : 'No', icon: player.receive_sms_promos ? '‚úÖ' : '‚ùå'}
      ]
    },
    {
      title: 'üíµ Financial Metrics - All Periods',
      icon: 'üíµ',
      fields: [
        {label: 'Deposit Sum (Lifetime)', value: '‚Ç¨' + (player.lifetime_deposit_sum_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üí≥'},
        {label: 'Cashout Sum (Lifetime)', value: '‚Ç¨' + Math.abs(player.lifetime_cashout_sum_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üí∏'},
        {label: 'Deposit Count (Lifetime)', value: (player.lifetime_deposit_count_total || 0).toLocaleString(), icon: 'üî¢'},
        {label: 'Cashout Count (Lifetime)', value: (player.lifetime_cashout_count_total || 0).toLocaleString(), icon: 'üî¢'},
        {label: 'Deposit Sum (90 Days)', value: '‚Ç¨' + (player.deposit_sum_last_90_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (30 Days)', value: '‚Ç¨' + (player.deposit_sum_last_30_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (7 Days)', value: '‚Ç¨' + (player.deposit_sum_last_7_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'},
        {label: 'Deposit Sum (Yesterday)', value: '‚Ç¨' + (player.deposit_sum_previous_day_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}), icon: 'üìä'}
      ]
    }
  ];
  
  var html = '';
  
  sections.forEach(function(section, idx) {
    // Section header with gradient background
    html += '<div style="margin-bottom:' + (idx < sections.length - 1 ? '28px' : '0') + '">';
    html += '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:12px 16px;margin-bottom:16px;border-radius:12px 12px 0 0;box-shadow:0 2px 8px rgba(102,126,234,0.2)">';
    html += '<h4 style="font-size:15px;font-weight:700;color:#fff;margin:0;letter-spacing:0.5px">' + section.title + '</h4>';
    html += '</div>';
    
    // Fields table with modern design
    html += '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:0 0 12px 12px;overflow:hidden">';
    html += '<table style="width:100%;border-collapse:collapse">';
    html += '<tbody>';
    
    section.fields.forEach(function(field, fieldIdx) {
      var value = field.value || '‚Äî';
      
      // Format link if needed
      if (field.link && value !== '‚Äî') {
        value = '<a href="https://backoffice.slotornado-bivu.com/backend/players/' + value + '" target="_blank" style="color:#667eea;text-decoration:none;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px" onmouseover="this.style.color=\'#5568d3\'" onmouseout="this.style.color=\'#667eea\'"><span style="font-size:14px">üîó</span> ' + value + '</a>';
      }
      
      var rowBg = fieldIdx % 2 === 0 ? '#ffffff' : '#f8fafc';
      var borderBottom = fieldIdx < section.fields.length - 1 ? 'border-bottom:1px solid #f1f5f9' : '';
      
      html += '<tr style="background:' + rowBg + ';transition:all 0.2s" onmouseover="this.style.background=\'#f0f4ff\'" onmouseout="this.style.background=\'' + rowBg + '\'">';
      html += '<td style="padding:14px 16px;' + borderBottom + '">';
      html += '<div style="display:flex;align-items:center;gap:10px">';
      html += '<span style="font-size:18px;opacity:0.8">' + field.icon + '</span>';
      html += '<span style="font-weight:600;color:#64748b;font-size:13px">' + field.label + '</span>';
      html += '</div>';
      html += '</td>';
      html += '<td style="padding:14px 16px;color:#1e293b;font-size:14px;font-weight:500;' + borderBottom + '">' + value + '</td>';
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

// ==================== BONUS CALCULATOR ====================
var bcState = {
  config: null, category: null, activeSheet: null, activeCalc: null,
  inputs: {}, thresholds: {}, initialized: false
};

// Preload during splash
function loadBonusCalcConfig() {
  return new Promise(function(resolve) {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data) {
          bcState.config = data;
          bcState.initialized = true;
          // Build thresholds
          (data.casino || []).concat(data.sport || []).forEach(function(calc) {
            if (calc.isFB) return;
            var tm = {};
            (calc.fields || []).forEach(function(f) {
              if (f.threshold !== null && f.threshold !== undefined) tm[f.label.toUpperCase()] = f.threshold;
            });
            bcState.thresholds[calc.sheet] = tm;
          });
        }
        resolve();
      })
      .withFailureHandler(function() { resolve(); })
      .getConfig();
  });
}

function showBonusCalcView() {
  document.querySelectorAll('.nav-item').forEach(function(i) { i.classList.remove('active'); });
  document.querySelectorAll('.content').forEach(function(c) { c.classList.remove('active'); });
  document.getElementById('bonus-calc-view').classList.add('active');
  bcInitUI();
}

function bcInitUI() {
  if (!bcState.config) return;
  var data = bcState.config;
  document.getElementById('bcRtpCount').textContent = (data.rtpGames || []).length;
  document.getElementById('bcCalcCount').textContent = (data.casino || []).length + (data.sport || []).length;
  bcBuildCategoryTabs(data);
  if (!bcState.activeSheet) {
    if (data.casino && data.casino.length) bcSelectCategory('casino');
    else if (data.sport && data.sport.length) bcSelectCategory('sport');
  }
  // Email listener (once)
  var emailInput = document.getElementById('bcEmailInput');
  if (!emailInput._bcInit) {
    emailInput._bcInit = true;
    var timer = null;
    emailInput.addEventListener('input', function() {
      clearTimeout(timer);
      var email = this.value.trim();
      timer = setTimeout(function() {
        if (email && email.indexOf('@') !== -1) {
          google.script.run.withSuccessHandler(function(slots) {
            var box = document.getElementById('bcFavoriteGames');
            if (slots && slots.length) {
              var list = document.getElementById('bcFavoriteList');
              list.innerHTML = '';
              var rtpGames = (bcState.config && bcState.config.rtpGames) || [];
              slots.forEach(function(slotName) {
                var game = rtpGames.find(function(g){ return g.slot && g.slot.toLowerCase() === slotName.toLowerCase(); });
                var chip = document.createElement('span');
                chip.className = 'bc-fav-chip';
                chip.style.cursor = game ? 'pointer' : 'default';
                chip.textContent = slotName + (game ? ' ¬∑ ' + game.rtpPct + '%' : '');
                if (game) chip.onclick = function() { showSlotDetailModal(game); };
                list.appendChild(chip);
              });
              box.style.display = 'block';
            } else box.style.display = 'none';
          }).withFailureHandler(function(){
            document.getElementById('bcFavoriteGames').style.display = 'none';
          }).getPlayerFavouriteSlots(email);
        } else document.getElementById('bcFavoriteGames').style.display = 'none';
      }, 500);
    });
    // Enter to calculate
    emailInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); bcCalculate(); }
    });
  }
}

function bcToast(msg, type) {
  var t = document.getElementById('bcToast');
  t.textContent = msg;
  t.style.opacity = '1'; t.style.transform = 'translateY(0)';
  t.style.borderColor = type === 'error' ? '#ef4444' : '#10b981';
  setTimeout(function() { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; }, 2500);
}

function bcBuildCategoryTabs(data) {
  var c = document.getElementById('bcCategoryTabs');
  c.innerHTML = '';
  [['casino','üé∞ Casino'],['sport','‚öΩ Sport']].forEach(function(pair) {
    if (!data[pair[0]] || !data[pair[0]].length) return;
    var t = document.createElement('div');
    t.className = 'bc-cat-tab'; t.textContent = pair[1];
    t.dataset.category = pair[0];
    t.onclick = function() { bcSelectCategory(pair[0]); };
    c.appendChild(t);
  });
}

function bcSelectCategory(cat) {
  bcState.category = cat;
  document.querySelectorAll('.bc-cat-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.category === cat); });
  var calcs = bcState.config[cat] || [];
  bcBuildCalcTabs(calcs);
  if (calcs.length) {
    var sh = calcs[0].isFB ? calcs[0].variants[0].sheet : calcs[0].sheet;
    if (!bcState.activeSheet || !calcs.some(function(c){ return c.isFB ? c.variants.some(function(v){return v.sheet===bcState.activeSheet}) : c.sheet===bcState.activeSheet; })) {
      bcSelectCalc(sh);
    }
  }
}

function bcBuildCalcTabs(calcs) {
  var c = document.getElementById('bcCalculatorTabs');
  c.innerHTML = '';
  calcs.forEach(function(calc) {
    var t = document.createElement('div');
    t.className = 'bc-calc-tab';
    t.textContent = calc.displayName;
    var sh = calc.isFB ? calc.variants[0].sheet : calc.sheet;
    t.dataset.sheet = sh;
    t.onclick = function() { bcSelectCalc(sh); };
    c.appendChild(t);
  });
}

function bcSelectCalc(sheetName) {
  bcState.activeSheet = sheetName;
  if (!bcState.inputs[sheetName]) bcState.inputs[sheetName] = {};
  document.querySelectorAll('.bc-calc-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.sheet === sheetName); });
  var calc = bcFindCalc(sheetName);
  bcState.activeCalc = calc;
  if (calc) bcRenderFields(calc);
  document.getElementById('bcSummaryBox').style.display = 'none';
}

function bcFindCalc(sheet) {
  var all = (bcState.config.casino||[]).concat(bcState.config.sport||[]);
  for (var i=0;i<all.length;i++) {
    if (all[i].isFB) { for (var v=0;v<all[i].variants.length;v++) { if (all[i].variants[v].sheet===sheet) return all[i].variants[v]; } }
    else if (all[i].sheet===sheet) return all[i];
  }
  return null;
}

function bcParseLabel(label) {
  var clean = label;
  var currency = false, percent = false, info = false, fs = false;
  clean = clean.replace(/\[‚Ç¨\]\s*/g, function(){ currency = true; return ''; });
  clean = clean.replace(/\[%\]\s*/g, function(){ percent = true; return ''; });
  clean = clean.replace(/\[INFO\]\s*/g, function(){ info = true; return ''; });
  clean = clean.replace(/\[FS\]\s*/g, function(){ fs = true; return ''; });
  clean = clean.replace(/\[CASH\]\s*/g, '');
  clean = clean.replace(/\[ALL\]\s*/g, '');
  clean = clean.replace(/\[RESULT\]\s*/g, '');
  clean = clean.replace(/\[[^\]]*\]\s*/g, ''); // strip any other brackets
  clean = clean.trim();
  return { clean: clean, currency: currency, percent: percent, info: info, fs: fs };
}

function bcRenderFields(calc) {
  var iC=document.getElementById('bcInputFields'), oC=document.getElementById('bcOutputFields');
  iC.innerHTML=''; oC.innerHTML='';
  var iG=document.createElement('div'); iG.className='bc-fields-grid';
  var oG=document.createElement('div'); oG.className='bc-fields-grid';
  var inputs=bcState.inputs[bcState.activeSheet]||{};
  (calc.fields||[]).forEach(function(f) {
    var parsed = bcParseLabel(f.label);
    if (parsed.info) return; // skip INFO fields
    
    var el=document.createElement('div'); el.className='bc-field';
    var lbl=document.createElement('div'); lbl.className='bc-field-label';
    var ico = parsed.currency?'üí∞':parsed.percent?'üìà':parsed.fs?'üé∞':/rtp/i.test(parsed.clean)?'üìä':/wager|wgr|rollover/i.test(parsed.clean)?'üîÑ':'üìù';
    lbl.innerHTML='<span class="bc-icon">'+ico+'</span> '+parsed.clean;
    el.appendChild(lbl);

    if(f.note){
      var infoBtn=document.createElement('span');
      infoBtn.className='bc-note-icon';
      infoBtn.textContent='i';
      infoBtn.setAttribute('data-tip',f.note);
      lbl.appendChild(infoBtn);
    }

    if(f.hasFormula){
      var w=bcWrapParsed(parsed);
      var inp=document.createElement('input');
      inp.className='bc-inp readonly'; inp.readOnly=true;
      inp.id='bcOut_'+bcId(f.a1);
      if(f.bold) inp.style.fontWeight='800';
      w.appendChild(inp);
      el.appendChild(w);
      if(/PROFIT/i.test(parsed.clean)) el.dataset.profit='true';
      if(f.cellBgColor){
        el.style.backgroundColor=f.cellBgColor;
        el.style.border='2px solid '+f.cellBgColor;
        el.style.padding='8px 10px';
        el.style.borderRadius='10px';
      }
      oG.appendChild(el);
    } else {
      if(calc.isFS&&/rtp/i.test(parsed.clean)) { el.appendChild(bcRTPDrop(f,inputs)); el.style.gridColumn='1 / -1'; }
      var w2=bcWrapParsed(parsed);
      var inp2=document.createElement('input');
      inp2.className='bc-inp'; inp2.type='number'; inp2.step='any';
      inp2.setAttribute('inputmode','decimal');
      // Pre-fill default value from sheet
      if(inputs[f.a1]!=null) inp2.value=inputs[f.a1];
      else if(f.value!==null&&f.value!==''){var dv=Number(f.value);if(!isNaN(dv)){inp2.value=dv;inputs[f.a1]=parsed.percent&&dv>=1?dv/100:dv}}
      else inp2.value='';
      inp2.id='bcInp_'+bcId(f.a1); inp2.placeholder='0';
      inp2.oninput=(function(a,pct){return function(){var v=Number(this.value);if(isNaN(v)||this.value==='')delete inputs[a];else inputs[a]=pct&&v>=1?v/100:v}})(f.a1,parsed.percent);
      inp2.onkeydown=function(e){if(e.key==='Enter'){e.preventDefault();bcCalculate()}};
      w2.appendChild(inp2); el.appendChild(w2);
      iG.appendChild(el);
    }
  });
  iC.appendChild(iG); oC.appendChild(oG);
}

function bcWrapParsed(parsed) {
  var w=document.createElement('div'); w.className='bc-input-wrap';
  if(parsed.currency){w.classList.add('has-prefix');var p=document.createElement('span');p.className='bc-prefix';p.textContent='‚Ç¨';w.appendChild(p)}
  else if(parsed.percent){w.classList.add('has-suffix');var s=document.createElement('span');s.className='bc-suffix';s.textContent='%';w.appendChild(s)}
  else if(parsed.fs){w.classList.add('has-suffix');var s2=document.createElement('span');s2.className='bc-suffix';s2.textContent='FS';w.appendChild(s2)}
  return w;
}

function bcRTPDrop(field, inputs) {
  var box=document.createElement('div'); box.className='bc-rtp-search';
  var si=document.createElement('span');
  si.style.cssText='position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;z-index:1;opacity:.5';
  si.textContent='üîç'; box.appendChild(si);
  var inp=document.createElement('input'); inp.className='bc-rtp-input';
  inp.type='search'; inp.placeholder='Search game...'; inp.autocomplete='off'; box.appendChild(inp);
  var list=document.createElement('div'); list.className='bc-rtp-list'; list.style.display='none'; box.appendChild(list);
  var chosen=document.createElement('div'); chosen.className='bc-rtp-chosen'; chosen.style.display='none'; box.appendChild(chosen);

  // Get current player email from calculator
  var emailInp = document.getElementById('bcEmailInput');
  var playerEmail = emailInp ? (emailInp.value || '').trim() : '';

  function selectGame(g) {
    var rtpVal = Number(g.rtpPct);
    // Sheet stores RTP as decimal (0.9623), not percentage (96.23)
    var decimalRtp = rtpVal >= 1 ? rtpVal / 100 : rtpVal;
    inputs[field.a1] = decimalRtp;
    chosen.innerHTML = '‚úì ' + g.provider + ' ‚Äî ' + g.slot + ' (' + g.rtpPct + '%) <span class="bc-chosen-x" title="Clear">‚úï</span>';
    chosen.style.display = 'inline-flex';
    list.style.display = 'none'; inp.value = '';
    // Set the number input to decimal value so oninput handler stays consistent
    var mi = document.getElementById('bcInp_' + bcId(field.a1));
    if (mi) { mi.value = decimalRtp; mi.readOnly = true; mi.style.opacity = '0.5'; }

    // Replace MIN BET / BET LVL field with dropdown of bet levels
    if (g.betLevels && g.betLevels.length) {
      var allInputs = document.querySelectorAll('.bc-field');
      allInputs.forEach(function(fieldEl) {
        var label = (fieldEl.querySelector('.bc-field-label') || {}).textContent || '';
        var cleanLabel = label.replace(/[üí∞üìàüé∞üìäüîÑüìù‚ÑπÔ∏è]/g, '').trim().toLowerCase();
        if (/min.?bet|bet.?lvl|bet.?level|min.?stake/i.test(cleanLabel)) {
          var betInput = fieldEl.querySelector('input.bc-inp:not(.readonly)');
          if (betInput) {
            // Create dropdown
            var sel = document.createElement('select');
            sel.className = 'bc-inp';
            sel.id = betInput.id;
            sel.style.cssText = 'cursor:pointer;font-weight:700;padding:8px 12px';
            var optEmpty = document.createElement('option');
            optEmpty.value = ''; optEmpty.textContent = 'Select bet level...'; sel.appendChild(optEmpty);
            g.betLevels.forEach(function(bl) {
              var opt = document.createElement('option');
              opt.value = bl.value;
              opt.textContent = 'LVL ' + bl.level + ' ‚Äî ' + bl.value + ' ‚Ç¨';
              sel.appendChild(opt);
            });
            sel.value = g.betLevels[0].value;
            var initA1 = betInput.id.replace('bcInp_', '');
            sel.onchange = function() {
              var v = Number(this.value);
              if (!isNaN(v) && this.value !== '') inputs[initA1] = v;
              else delete inputs[initA1];
            };
            inputs[initA1] = Number(g.betLevels[0].value);
            
            var wrap = betInput.closest('.bc-input-wrap');
            if (wrap) {
              wrap.replaceChild(sel, betInput);
            } else {
              betInput.parentNode.replaceChild(sel, betInput);
            }
            // Store ref for clear
            sel.dataset.originalType = 'input';
          }
        }
      });
    }

    // X button handler
    chosen.querySelector('.bc-chosen-x').onclick = function(e) {
      e.stopPropagation();
      delete inputs[field.a1];
      chosen.style.display = 'none';
      var mi2 = document.getElementById('bcInp_' + bcId(field.a1));
      if (mi2) { mi2.value = ''; mi2.readOnly = false; mi2.style.opacity = '1'; }
      // Restore MIN BET to input
      var allFields = document.querySelectorAll('.bc-field');
      allFields.forEach(function(fieldEl) {
        var label = (fieldEl.querySelector('.bc-field-label') || {}).textContent || '';
        var cleanLabel = label.replace(/[üí∞üìàüé∞üìäüîÑüìù‚ÑπÔ∏è]/g, '').trim().toLowerCase();
        if (/min.?bet|bet.?lvl|bet.?level|min.?stake/i.test(cleanLabel)) {
          var sel = fieldEl.querySelector('select.bc-inp');
          if (sel) {
            var newInp = document.createElement('input');
            newInp.className = 'bc-inp';
            newInp.type = 'number';
            newInp.step = 'any';
            newInp.setAttribute('inputmode', 'decimal');
            newInp.id = sel.id;
            newInp.placeholder = '0';
            var a1 = sel.id.replace('bcInp_', '');
            delete inputs[a1];
            newInp.oninput = function() {
              var v = Number(this.value);
              if (isNaN(v) || this.value === '') delete inputs[a1];
              else inputs[a1] = v;
            };
            newInp.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); bcCalculate(); } };
            var wrap = sel.closest('.bc-input-wrap');
            if (wrap) wrap.replaceChild(newInp, sel);
            else sel.parentNode.replaceChild(newInp, sel);
          }
        }
      });
    };
  }

  function upd(q) {
    list.innerHTML = '';
    var lq = (q || '').toLowerCase();
    var allGames = (bcState.config.rtpGames || []);

    // Get favourites for current player
    var favSlots = [];
    var favChips = document.querySelectorAll('#bcFavoriteList .bc-fav-chip');
    favChips.forEach(function(c) {
      var text = c.textContent.split('¬∑')[0].trim(); // "SlotName ¬∑ 96.00%" ‚Üí "SlotName"
      if (text) favSlots.push(text.toLowerCase());
    });

    var favGames = [], otherGames = [];
    allGames.forEach(function(g) {
      if (lq && (g.provider || '').toLowerCase().indexOf(lq) === -1 && (g.slot || '').toLowerCase().indexOf(lq) === -1) return;
      if (favSlots.some(function(fs) { return g.slot && g.slot.toLowerCase() === fs; })) favGames.push(g);
      else otherGames.push(g);
    });

    // Render favourites section
    if (favGames.length) {
      var divider = document.createElement('div');
      divider.className = 'bc-rtp-divider';
      divider.textContent = '‚≠ê Favourite Games';
      list.appendChild(divider);
      favGames.forEach(function(g) {
        var it = document.createElement('div');
        it.className = 'bc-rtp-item bc-rtp-item-fav';
        it.innerHTML = '<strong>' + g.provider + '</strong> ‚Äî ' + g.slot + ' <span style="color:#667eea;font-weight:700">(' + g.rtpPct + '%)</span>' + (g.volatility ? ' <span style="color:#94a3b8;font-size:11px">[' + g.volatility + ']</span>' : '');
        it.onmousedown = function(e) { e.preventDefault(); selectGame(g); };
        list.appendChild(it);
      });
    }

    // Render other games
    if (otherGames.length) {
      if (favGames.length) {
        var divider2 = document.createElement('div');
        divider2.className = 'bc-rtp-divider';
        divider2.textContent = 'üé∞ All Games';
        list.appendChild(divider2);
      }
      otherGames.slice(0, 60).forEach(function(g) {
        var it = document.createElement('div');
        it.className = 'bc-rtp-item';
        it.innerHTML = '<strong>' + g.provider + '</strong> ‚Äî ' + g.slot + ' <span style="color:#667eea;font-weight:700">(' + g.rtpPct + '%)</span>' + (g.volatility ? ' <span style="color:#94a3b8;font-size:11px">[' + g.volatility + ']</span>' : '');
        it.onmousedown = function(e) { e.preventDefault(); selectGame(g); };
        list.appendChild(it);
      });
    }

    if (!favGames.length && !otherGames.length) {
      list.innerHTML = '<div style="padding:16px;text-align:center;color:#94a3b8;font-size:12px">No games found</div>';
    }
  }
  inp.addEventListener('focus', function() { upd(''); list.style.display = 'block'; });
  inp.addEventListener('input', function() { upd(this.value); list.style.display = 'block'; });
  document.addEventListener('click', function(e) { if (!box.contains(e.target)) list.style.display = 'none'; });
  return box;
}

function bcCalculate() {
  if(!bcState.activeSheet||!bcState.config)return;
  var btn=document.getElementById('bcCalcBtn');
  btn.textContent='‚è≥ ...'; btn.disabled=true;
  document.getElementById('bcLoading').style.display='flex';
  google.script.run
    .withSuccessHandler(function(result){
      btn.innerHTML='‚ö° Calculate'; btn.disabled=false;
      document.getElementById('bcLoading').style.display='none';
      (result.result||[]).forEach(function(f){
        var o=document.getElementById('bcOut_'+bcId(f.a1)); if(!o)return;
        o.value=f.value||'';
        var el=o.closest('.bc-field');
        if(el){
          // Remove old profit classes and inline styles
          el.classList.remove('bc-profit-good','bc-profit-warn','bc-profit-bad');
          el.style.backgroundColor='';
          el.style.border='';
          el.style.padding='';
          el.style.borderRadius='';
          // Apply actual cell background from sheet
          if(f.cellBgColor){
            el.style.backgroundColor=f.cellBgColor;
            el.style.border='2px solid '+f.cellBgColor;
            el.style.padding='8px 10px';
            el.style.borderRadius='10px';
          }
        }
      });
      bcBuildSummary(result.result||[]);
      bcToast('‚úÖ Done!','success');
    })
    .withFailureHandler(function(err){
      btn.innerHTML='‚ö° Calculate'; btn.disabled=false;
      document.getElementById('bcLoading').style.display='none';
      bcToast('Error: '+err.message,'error');
    })
    .compute(bcState.activeSheet, bcState.inputs[bcState.activeSheet]||{});
}

function bcClearAll() {
  bcState.inputs[bcState.activeSheet]={};
  document.querySelectorAll('#bcInputFields .bc-inp').forEach(function(i){i.value=''});
  document.querySelectorAll('#bcOutputFields .bc-inp').forEach(function(i){i.value=''});
  document.querySelectorAll('#bonus-calc-view .bc-field').forEach(function(f){f.classList.remove('bc-profit-good','bc-profit-warn','bc-profit-bad');f.style.backgroundColor='';f.style.border='';f.style.padding='';f.style.borderRadius=''});
  document.getElementById('bcSummaryBox').style.display='none';
  bcToast('üóëÔ∏è Cleared!','success');
}

function bcBuildSummary(results) {
  var c=document.getElementById('bcSummaryContent'); c.innerHTML='';
  var lines=[];
  var email=document.getElementById('bcEmailInput').value.trim();
  if(email){
    var el=document.createElement('div'); el.className='bc-summary-line';
    el.style.cssText='border-bottom:1px solid #e2e8f0;padding-bottom:6px;margin-bottom:6px';
    el.innerHTML='<span class="bc-summary-label">üìß Player:</span><span class="bc-summary-value" style="color:#667eea">'+email+'</span>';
    c.appendChild(el); lines.push('Player: '+email);
  }
  results.forEach(function(f){
    var el=document.createElement('div'); el.className='bc-summary-line';
    var p=bcParseLabel(f.label);
    var v=bcFmt(f.label,f.value||'');
    el.innerHTML='<span class="bc-summary-label">'+p.clean+':</span><span class="bc-summary-value">'+v+'</span>';
    c.appendChild(el); lines.push(p.clean+': '+v);
  });
  var box=document.getElementById('bcSummaryBox');
  box.style.display=results.length?'block':'none';
  box.dataset.copy=lines.join('\n');
}

function bcFmt(l,v){var s=String(v||'').trim();var p=bcParseLabel(l);if(p.currency)return/^‚Ç¨/.test(s)?s:(s?'‚Ç¨'+s:'');if(p.percent)return/%$/.test(s)?s:(s?s+'%':'');if(p.fs)return/FS$/i.test(s)?s:(s?s+' FS':'');return s}

function bcCopySummary(){var t=document.getElementById('bcSummaryBox').dataset.copy||'';if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(t).then(function(){bcToast('üìã Copied!','success')}).catch(function(){bcFC(t)});else bcFC(t)}
function bcFC(t){var a=document.createElement('textarea');a.value=t;a.style.cssText='position:fixed;opacity:0';document.body.appendChild(a);a.select();try{document.execCommand('copy');bcToast('üìã Copied!','success')}catch(e){bcToast('Failed','error')}document.body.removeChild(a)}

function bcRefreshConfig(){
  var btn=document.getElementById('bcRefreshBtn');
  btn.style.animation='spin 1s linear infinite';
  google.script.run.withSuccessHandler(function(){
    google.script.run.withSuccessHandler(function(data){
      if(data){bcState.config=data;bcState.thresholds={};(data.casino||[]).concat(data.sport||[]).forEach(function(c){if(c.isFB)return;var tm={};(c.fields||[]).forEach(function(f){if(f.threshold!==null&&f.threshold!==undefined)tm[f.label.toUpperCase()]=f.threshold});bcState.thresholds[c.sheet]=tm})}
      bcInitUI(); btn.style.animation=''; bcToast('‚úÖ Refreshed!','success');
    }).withFailureHandler(function(err){btn.style.animation='';bcToast('Error: '+err.message,'error')}).getConfig();
  }).withFailureHandler(function(){btn.style.animation=''}).clearCache();
}

function bcId(s){return String(s||'').replace(/[^a-z0-9]+/gi,'_')}

// ==================== RTP GAMES PAGE ====================
var bcRtp = {
  games: [],
  headers: [],
  filtered: [],
  sortCol: null,
  sortDir: 'asc',
  loaded: false,
  editRow: 0
};

function bcToggleRtpPage() {
  var calcMode = document.getElementById('bcCalcMode');
  var rtpMode = document.getElementById('bcRtpMode');
  var btn = document.getElementById('bcRtpGamesBtn');
  var tabsRow = document.querySelector('.bc-tabs-row');
  var favBox = document.getElementById('bcFavoriteGames');
  var calcBtn = document.getElementById('bcCalcBtn');
  
  if (rtpMode.style.display === 'flex') {
    // Back to calculator
    rtpMode.style.display = 'none';
    calcMode.style.display = '';
    btn.style.background = '#f8fafc';
    btn.style.borderColor = '#e2e8f0';
    btn.style.color = '#1e293b';
    tabsRow.style.display = '';
    if (favBox.dataset.wasShown === 'true') favBox.style.display = 'block';
    calcBtn.style.display = '';
  } else {
    // Show RTP Games
    calcMode.style.display = 'none';
    rtpMode.style.display = 'flex';
    btn.style.background = 'rgba(102,126,234,0.1)';
    btn.style.borderColor = '#667eea';
    btn.style.color = '#667eea';
    tabsRow.style.display = 'none';
    favBox.dataset.wasShown = favBox.style.display !== 'none' ? 'true' : 'false';
    favBox.style.display = 'none';
    calcBtn.style.display = 'none';
    
    if (!bcRtp.loaded) {
      bcRtpLoadData();
    }
  }
}

function bcRtpLoadData() {
  document.getElementById('bcRtpTbody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:#94a3b8"><div class="bc-spinner" style="margin:0 auto 10px"></div>Loading RTP Games...</td></tr>';
  google.script.run
    .withSuccessHandler(function(data) {
      bcRtp.headers = data.headers || [];
      bcRtp.games = data.games || [];
      bcRtp.loaded = true;
      bcRtpBuildFilters();
      bcRtpFilter();
      document.getElementById('bcRtpTotalGames').innerHTML = '<strong>' + bcRtp.games.length + '</strong> games';
    })
    .withFailureHandler(function(err) {
      document.getElementById('bcRtpTbody').innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:#ef4444">Error: ' + err.message + '</td></tr>';
    })
    .getRTPGamesFullData();
}

function bcRtpBuildFilters() {
  var providers = {}, volatilities = {};
  bcRtp.games.forEach(function(g) {
    var p = g['PROVIDER'] || g['Provider'] || '';
    var v = g['VOLATILITY'] || g['Volatility'] || '';
    if (p) providers[p] = true;
    if (v) volatilities[v] = true;
  });
  var pSel = document.getElementById('bcRtpProviderFilter');
  pSel.innerHTML = '<option value="">All Providers</option>';
  Object.keys(providers).sort().forEach(function(p) {
    pSel.innerHTML += '<option value="' + p + '">' + p + ' (' + bcRtp.games.filter(function(g){return (g['PROVIDER']||g['Provider'])===p}).length + ')</option>';
  });
  var vSel = document.getElementById('bcRtpVolatilityFilter');
  vSel.innerHTML = '<option value="">All Volatility</option>';
  Object.keys(volatilities).sort().forEach(function(v) {
    vSel.innerHTML += '<option value="' + v + '">' + v + '</option>';
  });
}

function bcRtpFilter() {
  var q = (document.getElementById('bcRtpSearchInput').value || '').toLowerCase();
  var prov = document.getElementById('bcRtpProviderFilter').value;
  var vol = document.getElementById('bcRtpVolatilityFilter').value;
  
  bcRtp.filtered = bcRtp.games.filter(function(g) {
    if (prov && (g['PROVIDER']||g['Provider']||'') !== prov) return false;
    if (vol && (g['VOLATILITY']||g['Volatility']||'') !== vol) return false;
    if (q) {
      var searchStr = bcRtp.headers.map(function(h){return String(g[h]||'')}).join(' ').toLowerCase();
      if (searchStr.indexOf(q) === -1) return false;
    }
    return true;
  });
  
  if (bcRtp.sortCol) bcRtpSort(bcRtp.sortCol, false);
  else bcRtpRenderTable();
  
  var stat = document.getElementById('bcRtpFilteredGames');
  if (bcRtp.filtered.length !== bcRtp.games.length) {
    stat.innerHTML = '(showing <strong>' + bcRtp.filtered.length + '</strong>)';
  } else stat.textContent = '';
  
  // Active filter chips
  var chips = document.getElementById('bcRtpActiveFilters');
  chips.innerHTML = '';
  if (q) chips.innerHTML += '<span class="bc-filter-chip">üîç "' + q + '" <span class="bc-chip-x" onclick="document.getElementById(\'bcRtpSearchInput\').value=\'\';bcRtpFilter()">‚úï</span></span>';
  if (prov) chips.innerHTML += '<span class="bc-filter-chip">üè¢ ' + prov + ' <span class="bc-chip-x" onclick="document.getElementById(\'bcRtpProviderFilter\').value=\'\';bcRtpFilter()">‚úï</span></span>';
  if (vol) chips.innerHTML += '<span class="bc-filter-chip">üìä ' + vol + ' <span class="bc-chip-x" onclick="document.getElementById(\'bcRtpVolatilityFilter\').value=\'\';bcRtpFilter()">‚úï</span></span>';
}

function bcRtpSort(col, toggle) {
  if (toggle !== false) {
    if (bcRtp.sortCol === col) bcRtp.sortDir = bcRtp.sortDir === 'asc' ? 'desc' : 'asc';
    else { bcRtp.sortCol = col; bcRtp.sortDir = 'asc'; }
  }
  
  bcRtp.filtered.sort(function(a, b) {
    var va = a[col] || '', vb = b[col] || '';
    // Try numeric
    var na = parseFloat(String(va).replace('%','').replace(',','.')),
        nb = parseFloat(String(vb).replace('%','').replace(',','.'));
    if (!isNaN(na) && !isNaN(nb)) {
      return bcRtp.sortDir === 'asc' ? na - nb : nb - na;
    }
    va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
    if (va < vb) return bcRtp.sortDir === 'asc' ? -1 : 1;
    if (va > vb) return bcRtp.sortDir === 'asc' ? 1 : -1;
    return 0;
  });
  bcRtpRenderTable();
}

function bcRtpRenderTable() {
  // Show columns: PROVIDER, SLOT, RTP, VOLATILITY, CATEGORY, BET LVLs, actions
  var mainCols = ['PROVIDER','SLOT','RTP','VOLATILITY','CATEGORY'];
  var visibleHeaders = [];
  var hUpper = bcRtp.headers.map(function(h){return h.toUpperCase()});
  
  mainCols.forEach(function(mc) {
    var idx = hUpper.indexOf(mc);
    if (idx !== -1) visibleHeaders.push(bcRtp.headers[idx]);
  });
  // Add BET LVL columns
  bcRtp.headers.forEach(function(h) {
    if (h.toUpperCase().indexOf('BET LVL') === 0) visibleHeaders.push(h);
  });
  
  // Header
  var thead = document.getElementById('bcRtpThead');
  var thRow = '<tr>';
  thRow += '<th style="width:100px"></th>';
  thRow += '<th style="width:40px">#</th>';
  visibleHeaders.forEach(function(h) {
    var isSorted = bcRtp.sortCol === h;
    var arrow = isSorted ? (bcRtp.sortDir === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï';
    thRow += '<th class="' + (isSorted ? 'bc-sorted' : '') + '" onclick="bcRtpSort(\'' + h.replace(/'/g,"\\'") + '\')">' + h + ' <span class="bc-sort-arrow">' + arrow + '</span></th>';
  });
  thRow += '</tr>';
  thead.innerHTML = thRow;
  
  // Body
  var tbody = document.getElementById('bcRtpTbody');
  if (!bcRtp.filtered.length) {
    tbody.innerHTML = '<tr><td colspan="' + (visibleHeaders.length + 2) + '" style="text-align:center;padding:40px;color:#94a3b8">No games found</td></tr>';
    return;
  }
  
  var html = '';
  bcRtp.filtered.forEach(function(game, idx) {
    html += '<tr onclick="bcRtpShowDetail(' + idx + ')">';
    html += '<td onclick="event.stopPropagation()"><div class="bc-actions-cell">';
    html += '<button class="bc-row-btn" onclick="bcRtpAddToPlayer(\'' + (game['SLOT']||game['Slot']||'').replace(/'/g,"\\'") + '\')" title="Add to player">‚ûï</button>';
    html += '<button class="bc-row-btn" onclick="bcRtpOpenEditor(' + game._row + ')" title="Edit">‚úèÔ∏è</button>';
    html += '<button class="bc-row-btn bc-del" onclick="bcRtpDelete(' + game._row + ',' + idx + ')" title="Delete">üóëÔ∏è</button>';
    html += '</div></td>';
    html += '<td style="color:#cbd5e1;font-size:10px;font-weight:600">' + (idx + 1) + '</td>';
    visibleHeaders.forEach(function(h) {
      var val = game[h] || '';
      var hu = h.toUpperCase();
      if (hu === 'PROVIDER') html += '<td class="bc-rtp-provider">' + val + '</td>';
      else if (hu === 'SLOT') html += '<td class="bc-rtp-slot" title="' + val + '">' + val + '</td>';
      else if (hu === 'RTP') html += '<td class="bc-rtp-pct">' + val + '</td>';
      else if (hu === 'VOLATILITY') {
        var cls = 'bc-vol-' + String(val).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z-]/g,'');
        html += '<td><span class="bc-vol-badge ' + cls + '">' + val + '</span></td>';
      }
      else if (hu === 'CATEGORY') {
        var cats = String(val).split(/[,\s]+/).filter(Boolean);
        html += '<td>' + cats.map(function(c){return '<span class="bc-cat-badge">' + c + '</span>'}).join('') + '</td>';
      }
      else if (hu.indexOf('BET LVL') === 0) html += '<td class="bc-bet-cell">' + (val || '‚Äî') + '</td>';
      else html += '<td>' + val + '</td>';
    });
    html += '</tr>';
  });
  tbody.innerHTML = html;
}

function bcRtpShowDetail(idx) {
  var game = bcRtp.filtered[idx];
  if (!game) return;
  var body = document.getElementById('bcRtpDetailBody');
  var title = document.getElementById('bcRtpDetailTitle');
  title.textContent = 'üéÆ ' + (game['SLOT']||game['Slot']||'Game');
  
  var rtp = game['RTP']||game['Rtp']||'';
  var html = '<div style="text-align:center;margin-bottom:16px"><span style="font-size:28px;font-weight:800;color:#667eea">' + rtp + '</span></div>';
  
  // Main fields
  var mainKeys = ['PROVIDER','SLOT','RTP','VOLATILITY','CATEGORY'];
  var hUpper = bcRtp.headers.map(function(h){return h.toUpperCase()});
  mainKeys.forEach(function(mk) {
    var hIdx = hUpper.indexOf(mk);
    if (hIdx === -1) return;
    var h = bcRtp.headers[hIdx];
    var val = game[h] || '';
    if (!val) return;
    var displayVal = val;
    if (mk === 'VOLATILITY') {
      var cls = 'bc-vol-' + String(val).toLowerCase().replace(/\s+/g,'-').replace(/[^a-z-]/g,'');
      displayVal = '<span class="bc-vol-badge ' + cls + '">' + val + '</span>';
    } else if (mk === 'CATEGORY') {
      displayVal = String(val).split(/[,\s]+/).filter(Boolean).map(function(c){return '<span class="bc-cat-badge">' + c + '</span>'}).join(' ');
    }
    html += '<div class="bc-detail-row"><span class="bc-detail-label">' + h + '</span><span class="bc-detail-value">' + displayVal + '</span></div>';
  });
  
  // Bet levels as grid
  var betHeaders = bcRtp.headers.filter(function(h){return h.toUpperCase().indexOf('BET LVL')===0});
  var betVals = betHeaders.filter(function(h){return game[h] && game[h] !== ''});
  if (betVals.length) {
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #f1f5f9">';
    html += '<div style="font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:10px">Bet Levels</div>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:6px">';
    betVals.forEach(function(h) {
      var lvl = h.toUpperCase().replace('BET LVL','').trim();
      html += '<div style="text-align:center;padding:6px 4px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px"><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase">LVL ' + lvl + '</div><div style="font-size:14px;font-weight:800;color:#1e293b;margin-top:2px">' + game[h] + '</div></div>';
    });
    html += '</div></div>';
  }
  
  html += '<div style="margin-top:16px;display:flex;gap:8px;justify-content:center">';
  html += '<button onclick="bcRtpOpenEditor(' + game._row + ');document.getElementById(\'bcRtpDetailModal\').style.display=\'none\'" class="bc-btn-calc" style="font-size:12px;padding:8px 16px">‚úèÔ∏è Edit</button>';
  html += '</div>';
  
  body.innerHTML = html;
  document.getElementById('bcRtpDetailModal').style.display = 'flex';
}

function bcRtpOpenEditor(rowNum) {
  bcRtp.editRow = rowNum;
  var title = document.getElementById('bcRtpEditorTitle');
  var body = document.getElementById('bcRtpEditorBody');
  
  var game = null;
  if (rowNum > 0) {
    game = bcRtp.games.find(function(g){return g._row === rowNum});
    title.textContent = '‚úèÔ∏è Edit Game';
  } else {
    title.textContent = '‚ûï Add New Game';
  }
  
  var mainFields = ['PROVIDER','SLOT','RTP','VOLATILITY','CATEGORY'];
  var betFields = bcRtp.headers.filter(function(h){return h.toUpperCase().indexOf('BET LVL')===0});
  
  var provs = {}, vols = {}, cats = {};
  bcRtp.games.forEach(function(g){
    var p=g['PROVIDER']||g['Provider']||'';if(p)provs[p]=true;
    var v=g['VOLATILITY']||g['Volatility']||'';if(v)vols[v]=true;
    var c=g['CATEGORY']||g['Category']||'';
    if(c) String(c).split(/[,\s]+/).filter(Boolean).forEach(function(cc){cats[cc]=true});
  });
  
  var html = '<div class="bc-modal-grid">';
  mainFields.forEach(function(fName) {
    var hIdx = bcRtp.headers.findIndex(function(h){return h.toUpperCase()===fName});
    var hName = hIdx !== -1 ? bcRtp.headers[hIdx] : fName;
    var val = game ? (game[hName] || '') : '';
    
    html += '<div class="bc-modal-field">';
    html += '<label>' + hName + '</label>';
    
    if (fName === 'PROVIDER') {
      html += '<div class="bc-edit-search" id="bcEditProviderWrap"><input id="bcRtpEdit_PROVIDER" type="text" value="' + val + '" placeholder="Search provider..." autocomplete="off"><div class="bc-edit-search-list" id="bcEditProviderList"></div></div>';
    } else if (fName === 'VOLATILITY') {
      html += '<select id="bcRtpEdit_' + fName + '">';
      html += '<option value="">Select...</option>';
      ['very-high','high','medium-high','medium','low-medium','low'].forEach(function(v){
        html += '<option value="' + v + '"' + (val===v?' selected':'') + '>' + v + '</option>';
      });
      Object.keys(vols).sort().forEach(function(v){
        if(['very-high','high','medium-high','medium','low-medium','low'].indexOf(v)===-1)
          html += '<option value="' + v + '"' + (val===v?' selected':'') + '>' + v + '</option>';
      });
      html += '</select>';
    } else if (fName === 'RTP') {
      html += '<input id="bcRtpEdit_' + fName + '" type="text" value="' + String(val).replace('%','') + '" placeholder="96.50" inputmode="decimal" onkeydown="bcPreventComma(event)" oninput="bcFixDecimal(this)">';
    } else if (fName === 'CATEGORY') {
      html += '<div class="bc-edit-search" id="bcEditCategoryWrap"><div class="bc-edit-chips" id="bcEditCategoryChips"></div><input id="bcRtpEdit_CATEGORY" type="text" placeholder="Search category..." autocomplete="off"><input type="hidden" id="bcRtpEdit_CATEGORY_VAL" value="' + val + '"><div class="bc-edit-search-list" id="bcEditCategoryList"></div></div>';
    } else {
      html += '<input id="bcRtpEdit_' + fName + '" type="text" value="' + val + '" placeholder="' + hName + '...">';
    }
    html += '</div>';
  });
  html += '</div>';
  
  if (betFields.length) {
    html += '<div style="margin-top:16px;padding-top:14px;border-top:1px solid #f1f5f9"><label style="display:block;font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:10px">üé∞ Bet Levels</label>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px">';
    betFields.forEach(function(h) {
      var val = game ? (game[h] || '') : '';
      var lvl = h.toUpperCase().replace('BET LVL','').trim();
      html += '<div class="bc-modal-field" style="margin:0"><label>LVL ' + lvl + '</label><input id="bcRtpEdit_BET_' + lvl + '" type="text" value="' + val + '" placeholder="0" style="text-align:center" inputmode="decimal" onkeydown="bcPreventComma(event)" oninput="bcFixDecimal(this)"></div>';
    });
    html += '</div></div>';
  }
  
  body.innerHTML = html;
  
  // Attach custom search dropdowns
  bcInitEditSearchDropdown('bcRtpEdit_PROVIDER', 'bcEditProviderList', 'bcEditProviderWrap', Object.keys(provs).sort());
  bcInitEditMultiSelect('bcRtpEdit_CATEGORY', 'bcEditCategoryList', 'bcEditCategoryWrap', 'bcEditCategoryChips', 'bcRtpEdit_CATEGORY_VAL', Object.keys(cats).sort());
  
  document.getElementById('bcRtpEditorModal').style.display = 'flex';
  setTimeout(function(){var f=document.getElementById('bcRtpEdit_PROVIDER');if(f)f.focus()},100);
}

function bcInitEditSearchDropdown(inputId, listId, wrapId, items) {
  var inp = document.getElementById(inputId);
  var list = document.getElementById(listId);
  var wrap = document.getElementById(wrapId);
  if (!inp || !list || !wrap) return;
  
  function render(q) {
    var lq = (q || '').toLowerCase();
    list.innerHTML = '';
    var filtered = items.filter(function(item) {
      return !lq || item.toLowerCase().indexOf(lq) !== -1;
    });
    if (!filtered.length) {
      list.innerHTML = '<div style="padding:10px;text-align:center;color:#94a3b8;font-size:11px">No matches</div>';
      return;
    }
    filtered.forEach(function(item) {
      var div = document.createElement('div');
      div.className = 'bc-edit-search-item';
      div.textContent = item;
      div.onmousedown = function(e) {
        e.preventDefault();
        inp.value = item;
        list.style.display = 'none';
      };
      list.appendChild(div);
    });
  }
  
  inp.addEventListener('focus', function() { render(this.value); list.style.display = 'block'; });
  inp.addEventListener('input', function() { render(this.value); list.style.display = 'block'; });
  document.addEventListener('click', function(e) { if (!wrap.contains(e.target)) list.style.display = 'none'; });
}

function bcInitEditMultiSelect(inputId, listId, wrapId, chipsId, hiddenId, items) {
  var inp = document.getElementById(inputId);
  var list = document.getElementById(listId);
  var wrap = document.getElementById(wrapId);
  var chipsEl = document.getElementById(chipsId);
  var hidden = document.getElementById(hiddenId);
  if (!inp || !list || !wrap || !chipsEl || !hidden) return;
  
  // Parse initial value
  var selected = (hidden.value || '').split(/[,\s]+/).filter(Boolean);
  
  function syncHidden() {
    hidden.value = selected.join(' ');
  }
  
  function renderChips() {
    chipsEl.innerHTML = '';
    selected.forEach(function(cat, idx) {
      var chip = document.createElement('span');
      chip.className = 'bc-edit-chip';
      chip.innerHTML = cat + ' <span class="bc-edit-chip-x">‚úï</span>';
      chip.querySelector('.bc-edit-chip-x').onclick = function(e) {
        e.stopPropagation();
        selected.splice(idx, 1);
        syncHidden();
        renderChips();
        render(inp.value);
      };
      chipsEl.appendChild(chip);
    });
  }
  
  function render(q) {
    var lq = (q || '').toLowerCase();
    list.innerHTML = '';
    var filtered = items.filter(function(item) {
      return !lq || item.toLowerCase().indexOf(lq) !== -1;
    });
    if (!filtered.length && lq) {
      // Allow adding new category
      var addDiv = document.createElement('div');
      addDiv.className = 'bc-edit-search-item';
      addDiv.innerHTML = '‚ûï Add "<strong>' + q + '</strong>"';
      addDiv.onmousedown = function(e) {
        e.preventDefault();
        if (selected.indexOf(q) === -1) selected.push(q);
        syncHidden(); renderChips(); inp.value = ''; render('');
      };
      list.appendChild(addDiv);
      return;
    }
    filtered.forEach(function(item) {
      var div = document.createElement('div');
      var isSelected = selected.indexOf(item) !== -1;
      div.className = 'bc-edit-search-item' + (isSelected ? ' selected' : '');
      div.textContent = item;
      div.onmousedown = function(e) {
        e.preventDefault();
        if (isSelected) {
          selected.splice(selected.indexOf(item), 1);
        } else {
          selected.push(item);
        }
        syncHidden(); renderChips(); inp.value = ''; render('');
      };
      list.appendChild(div);
    });
  }
  
  renderChips();
  inp.addEventListener('focus', function() { render(this.value); list.style.display = 'block'; });
  inp.addEventListener('input', function() { render(this.value); list.style.display = 'block'; });
  document.addEventListener('click', function(e) { if (!wrap.contains(e.target)) list.style.display = 'none'; });
}

// Prevent comma input, enforce dots for decimals
function bcPreventComma(e) {
  if (e.key === ',') { e.preventDefault(); e.target.value += '.'; }
}
function bcFixDecimal(el) {
  el.value = el.value.replace(/,/g, '.');
}

function bcRtpCloseEditor() {
  document.getElementById('bcRtpEditorModal').style.display = 'none';
}

function bcRtpSaveGame() {
  var mainFields = ['PROVIDER','SLOT','RTP','VOLATILITY','CATEGORY'];
  var betFields = bcRtp.headers.filter(function(h){return h.toUpperCase().indexOf('BET LVL')===0});
  
  var gameData = {};
  mainFields.forEach(function(fName) {
    var hIdx = bcRtp.headers.findIndex(function(h){return h.toUpperCase()===fName});
    var hName = hIdx !== -1 ? bcRtp.headers[hIdx] : fName;
    if (fName === 'CATEGORY') {
      var hid = document.getElementById('bcRtpEdit_CATEGORY_VAL');
      gameData[hName] = hid ? hid.value.trim() : '';
    } else {
      var el = document.getElementById('bcRtpEdit_' + fName);
      if (el) gameData[hName] = el.value.trim();
    }
  });
  betFields.forEach(function(h) {
    var lvl = h.toUpperCase().replace('BET LVL','').trim();
    var el = document.getElementById('bcRtpEdit_BET_' + lvl);
    if (el) gameData[h] = el.value.trim();
  });
  
  // Validate
  if (!gameData[bcRtp.headers.find(function(h){return h.toUpperCase()==='PROVIDER'})||'PROVIDER'] || 
      !gameData[bcRtp.headers.find(function(h){return h.toUpperCase()==='SLOT'})||'SLOT']) {
    bcToast('Provider and Slot are required!', 'error');
    return;
  }
  
  var saveBtn = document.querySelector('#bcRtpEditorModal .bc-btn-calc');
  saveBtn.textContent = '‚è≥ Saving...'; saveBtn.disabled = true;
  
  google.script.run
    .withSuccessHandler(function(result) {
      saveBtn.textContent = 'üíæ Save'; saveBtn.disabled = false;
      bcRtpCloseEditor();
      bcToast('‚úÖ Game saved!', 'success');
      // Reload data
      bcRtp.loaded = false;
      bcRtpLoadData();
      // Also refresh config for RTP dropdown in calculator
      google.script.run.withSuccessHandler(function(d){if(d){bcState.config=d}}).getConfig();
    })
    .withFailureHandler(function(err) {
      saveBtn.textContent = 'üíæ Save'; saveBtn.disabled = false;
      bcToast('Error: ' + err.message, 'error');
    })
    .saveRTPGame(bcRtp.editRow, gameData);
}

function bcRtpDelete(rowNum, idx) {
  var game = bcRtp.filtered[idx];
  if (!game) return;
  if (!confirm('Delete "' + (game['SLOT']||game['Slot']||'this game') + '"?')) return;
  
  google.script.run
    .withSuccessHandler(function() {
      bcToast('üóëÔ∏è Deleted!', 'success');
      bcRtp.loaded = false;
      bcRtpLoadData();
    })
    .withFailureHandler(function(err) {
      bcToast('Error: ' + err.message, 'error');
    })
    .deleteRTPGame(rowNum);
}

// ===================== HOME PAGE =====================
var homeClockInterval = null;
var homeCryptoRates = {};
var homeDataCache = null;

function preloadHomeData() {
  return new Promise(function(resolve) {
    if (typeof google === 'undefined' || !google.script) { resolve(); return; }
    google.script.run
      .withSuccessHandler(function(data) {
        if (data && !data.error) homeDataCache = data;
        resolve();
      })
      .withFailureHandler(function() { resolve(); })
      .getHomeData();
  });
}

function preloadCryptoRates() {
  return new Promise(function(resolve) {
    if (typeof google === 'undefined' || !google.script) { resolve(); return; }
    google.script.run
      .withSuccessHandler(function(rates) {
        if (rates) homeCryptoRates = rates;
        resolve();
      })
      .withFailureHandler(function() { resolve(); })
      .getCryptoAndForexRates();
  });
}

var birthdaysCache = null;
var promoPlanCache = null;

function preloadBirthdays() {
  return new Promise(function(resolve) {
    if (typeof google === 'undefined' || !google.script) { resolve(); return; }
    google.script.run
      .withSuccessHandler(function(data) { birthdaysCache = data; resolve(); })
      .withFailureHandler(function() { resolve(); })
      .getUpcomingBirthdays();
  });
}

function preloadPromoPlan() {
  return new Promise(function(resolve) {
    if (typeof google === 'undefined' || !google.script) { resolve(); return; }
    google.script.run
      .withSuccessHandler(function(data) { promoPlanCache = data; resolve(); })
      .withFailureHandler(function() { resolve(); })
      .getPromoPlan();
  });
}

function openHomePage() {
  document.getElementById('homeOverlay').classList.add('show');
  startHomeClocks();
  
  // Use cached data or reload
  if (homeDataCache) {
    renderPosts(document.getElementById('homeNews'), homeDataCache.news, 'homeNewsCount');
    renderPosts(document.getElementById('homeBlog'), homeDataCache.blog, 'homeBlogCount');
    renderLinks(document.getElementById('homeLinks'), homeDataCache.links);
  } else {
    loadHomeData();
  }
  
  if (homeCryptoRates && homeCryptoRates.rates) {
    updateCryptoDisplay(homeCryptoRates);
    convertCurrency();
  } else {
    loadCryptoData();
  }
}

function closeHomePage() {
  document.getElementById('homeOverlay').classList.remove('show');
  if (homeClockInterval) clearInterval(homeClockInterval);
}

function startHomeClocks() {
  function update() {
    var now = new Date();
    var utc = now.toLocaleTimeString('uk-UA', { timeZone: 'UTC', hour12: false });
    var kyiv = now.toLocaleTimeString('uk-UA', { timeZone: 'Europe/Kiev', hour12: false });
    document.getElementById('homeClockUTC').textContent = utc;
    document.getElementById('homeClockKyiv').textContent = kyiv;
    // Timezone chips
    var zones = {
      'tzSydney': 'Australia/Sydney', 'tzAuckland': 'Pacific/Auckland',
      'tzToronto': 'America/Toronto', 'tzBerlin': 'Europe/Berlin',
      'tzVienna': 'Europe/Vienna', 'tzZurich': 'Europe/Zurich',
      // Dropdown extras
      'tzSydney2': 'Australia/Sydney', 'tzBrisbane': 'Australia/Brisbane',
      'tzPerth': 'Australia/Perth', 'tzAdelaide': 'Australia/Adelaide',
      'tzToronto2': 'America/Toronto', 'tzWinnipeg': 'America/Winnipeg',
      'tzCalgary': 'America/Edmonton', 'tzVancouver': 'America/Vancouver'
    };
    for (var id in zones) {
      var el = document.getElementById(id);
      if (el) el.textContent = now.toLocaleTimeString('uk-UA', { timeZone: zones[id], hour: '2-digit', minute: '2-digit', hour12: false });
    }
  }
  update();
  if (homeClockInterval) clearInterval(homeClockInterval);
  homeClockInterval = setInterval(update, 1000);
}

function toggleTzDrop(group) {
  var dd = group.querySelector('.home-tz-dropdown');
  if (!dd) return;
  var wasOpen = dd.classList.contains('show');
  // Close all
  document.querySelectorAll('.home-tz-dropdown.show').forEach(function(d) { d.classList.remove('show'); });
  document.querySelectorAll('.home-tz-chip.active').forEach(function(c) { c.classList.remove('active'); });
  if (!wasOpen) {
    dd.classList.add('show');
    group.querySelector('.home-tz-chip').classList.add('active');
  }
}
// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.home-tz-group')) {
    document.querySelectorAll('.home-tz-dropdown.show').forEach(function(d) { d.classList.remove('show'); });
    document.querySelectorAll('.home-tz-chip.active').forEach(function(c) { c.classList.remove('active'); });
  }
});

var emojiMap = {
  ':sparkles:':'‚ú®',':dollar:':'üíµ',':fire:':'üî•',':rocket:':'üöÄ',':star:':'‚≠ê',':warning:':'‚ö†Ô∏è',
  ':check:':'‚úÖ',':cross:':'‚ùå',':heart:':'‚ù§Ô∏è',':thumbsup:':'üëç',':thumbsdown:':'üëé',':tada:':'üéâ',
  ':eyes:':'üëÄ',':wave:':'üëã',':100:':'üíØ',':gem:':'üíé',':crown:':'üëë',':money:':'üí∞',
  ':chart:':'üìà',':red_circle:':'üî¥',':green_circle:':'üü¢',':blue_circle:':'üîµ',':bell:':'üîî',
  ':bulb:':'üí°',':link:':'üîó',':lock:':'üîí',':unlock:':'üîì',':calendar:':'üìÖ',':clock:':'üïê',
  ':trophy:':'üèÜ',':muscle:':'üí™',':pray:':'üôè',':clap:':'üëè',':point_right:':'üëâ',':boom:':'üí•',
  ':x:':'‚ùå',':white_check_mark:':'‚úÖ',':arrow_right:':'‚û°Ô∏è',':arrow_left:':'‚¨ÖÔ∏è',':arrow_up:':'‚¨ÜÔ∏è',':arrow_down:':'‚¨áÔ∏è',
  ':moneybag:':'üí∞',':chart_with_upwards_trend:':'üìà',':chart_with_downwards_trend:':'üìâ',':mega:':'üì£',':loudspeaker:':'üì¢',
  ':new:':'üÜï',':bangbang:':'‚ÄºÔ∏è',':question:':'‚ùì',':exclamation:':'‚ùó',':heavy_check_mark:':'‚úîÔ∏è'
};

function parseEmojis(text) {
  return text.replace(/:[a-z_]+:/g, function(m) { return emojiMap[m] || m; });
}

function renderPostContent(text) {
  // Extract URLs BEFORE escaping to preserve them
  var placeholders = [];
  var idx = 0;
  
  function ph(html) {
    var token = '\x00PH' + (idx++) + '\x00';
    placeholders.push({ token: token, html: html });
    return token;
  }
  
  // 1) YouTube links ‚Üí preview (before escape)
  text = text.replace(/https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)[^\s]*/g, function(url, id) {
    return ph('<a class="home-yt-preview" href="' + url + '" target="_blank" rel="noopener">' +
      '<div style="position:relative"><img src="https://img.youtube.com/vi/' + id + '/hqdefault.jpg" alt="Video"><div class="home-yt-play"></div></div>' +
      '<div class="home-yt-title"><span class="yt-icon">‚ñ∂</span><span id="yt-title-' + id + '">YouTube Video</span></div></a>');
  });
  
  // 2) Image URLs ‚Üí inline (before escape)
  text = text.replace(/(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp)(?:\?[^\s]*)?)/gi, function(url) {
    return ph('<img class="home-post-img" src="' + url + '" alt="" onerror="this.style.display=\'none\'">');
  });
  
  // 3) Other URLs ‚Üí links (before escape)
  text = text.replace(/https?:\/\/[^\s]+/g, function(url) {
    var short = url.length > 70 ? url.substring(0, 67) + '...' : url;
    return ph('<a href="' + url + '" target="_blank" rel="noopener">' + short + '</a>');
  });
  
  // 4) Now escape remaining text safely
  text = parseEmojis(escapeHtml(text));
  
  // 5) Restore placeholders
  placeholders.forEach(function(p) {
    text = text.replace(p.token, p.html);
  });
  
  return text;
}

function extractAuthor(text) {
  var lines = text.trim().split('\n').filter(function(l) { return l.trim(); });
  if (lines.length < 2) return { content: text, author: '' };
  var last = lines[lines.length - 1].trim();
  if (last.length < 50 && !last.match(/https?:\/\//) && last.split(' ').length <= 4 && last.match(/^[A-Z–ê-–Ø–Ü–á–Ñ“ê]/)) {
    return { content: lines.slice(0, -1).join('\n'), author: last };
  }
  return { content: text, author: '' };
}

function renderPosts(container, posts, countElId) {
  // Update count badge
  var countEl = document.getElementById(countElId);
  if (countEl) countEl.textContent = posts ? posts.length + ' post' + (posts.length !== 1 ? 's' : '') : '0';
  
  if (!posts || posts.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:40px;font-size:14px">No posts yet</div>';
    return;
  }
  container.innerHTML = '';
  posts.forEach(function(post, idx) {
    var parsed = extractAuthor(post.content);
    var author = post.author || parsed.author;
    if (author === 'Unknown' || author === 'unknown') author = '';
    var content = post.author ? post.content : parsed.content;
    
    var div = document.createElement('div');
    div.className = 'home-post';
    
    // Post number watermark
    var numHtml = '<div class="home-post-number">#' + (idx + 1) + '</div>';
    
    // Meta: date + author
    var metaHtml = '';
    var hasMeta = post.date || author;
    if (hasMeta) {
      metaHtml = '<div class="home-post-meta">';
      if (post.date) metaHtml += '<span class="home-post-date"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ' + escapeHtml(post.date) + '</span>';
      if (author) metaHtml += '<span class="home-post-author-tag">‚úçÔ∏è ' + escapeHtml(author) + '</span>';
      metaHtml += '</div>';
    }
    
    div.innerHTML = numHtml + metaHtml + '<div class="home-post-content">' + renderPostContent(content) + '</div>';
    container.appendChild(div);
  });
  
  // Fetch YouTube video titles via noembed
  var ytTitles = container.querySelectorAll('[id^="yt-title-"]');
  ytTitles.forEach(function(el) {
    var videoId = el.id.replace('yt-title-', '');
    fetchYouTubeTitle(videoId, el);
  });
}

function fetchYouTubeTitle(videoId, el) {
  try {
    var url = 'https://noembed.com/embed?url=https://www.youtube.com/watch?v=' + videoId;
    fetch(url)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data && data.title) el.textContent = data.title;
      })
      .catch(function() {});
  } catch(e) {}
}

function renderLinks(container, links) {
  if (!links || links.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px">No links yet</div>';
    return;
  }
  container.innerHTML = '';
  var icons = ['üìã','üìä','üìÅ','üåê','üìé','üìå','üóÇÔ∏è','üìë'];
  links.forEach(function(link, i) {
    var a = document.createElement('a');
    a.className = 'home-link-item';
    a.href = link.url || '#';
    a.target = '_blank';
    a.rel = 'noopener';
    a.innerHTML = '<div class="home-link-icon">' + icons[i % icons.length] + '</div><span>' + escapeHtml(parseEmojis(link.label)) + '</span>';
    container.appendChild(a);
  });
}

function loadHomeData() {
  if (typeof google === 'undefined' || !google.script) return;
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data || data.error) return;
      renderPosts(document.getElementById('homeNews'), data.news, 'homeNewsCount');
      renderPosts(document.getElementById('homeBlog'), data.blog, 'homeBlogCount');
      renderLinks(document.getElementById('homeLinks'), data.links);
    })
    .withFailureHandler(function(e) { console.error('Home data error:', e); })
    .getHomeData();
}

function loadCryptoData() {
  if (typeof google !== 'undefined' && google.script) {
    google.script.run
      .withSuccessHandler(function(rates) {
        if (rates) {
          homeCryptoRates = rates;
          updateCryptoDisplay(rates);
          convertCurrency();
        }
      })
      .withFailureHandler(function() { console.log('Crypto fetch failed'); })
      .getCryptoAndForexRates();
  }
}

function updateCryptoDisplay(rates) {
  var btcEl = document.getElementById('homeBtcPrice');
  var ethEl = document.getElementById('homeEthPrice');
  if (rates.btcEur) {
    var chg = rates.btcChange !== undefined ? '<span class="home-crypto-change '+(rates.btcChange>=0?'up':'down')+'">'+(rates.btcChange>=0?'+':'')+rates.btcChange.toFixed(1)+'%</span>' : '';
    btcEl.innerHTML = '<span class="home-crypto-icon btc">‚Çø</span><div><div class="home-crypto-label">Bitcoin</div><span class="home-crypto-price">‚Ç¨' + Number(rates.btcEur).toLocaleString('de-DE',{maximumFractionDigits:0}) + '</span>' + chg + '</div>';
  }
  if (rates.ethEur) {
    var chg2 = rates.ethChange !== undefined ? '<span class="home-crypto-change '+(rates.ethChange>=0?'up':'down')+'">'+(rates.ethChange>=0?'+':'')+rates.ethChange.toFixed(1)+'%</span>' : '';
    ethEl.innerHTML = '<span class="home-crypto-icon eth">Œû</span><div><div class="home-crypto-label">Ethereum</div><span class="home-crypto-price">‚Ç¨' + Number(rates.ethEur).toLocaleString('de-DE',{maximumFractionDigits:0}) + '</span>' + chg2 + '</div>';
  }
}

function convertCurrency() {
  var amount = parseFloat(document.getElementById('homeConvAmount').value) || 0;
  var from = document.getElementById('homeConvFrom').value;
  var to = document.getElementById('homeConvTo').value;
  var resultEl = document.getElementById('homeConvResult');
  if (!homeCryptoRates || !homeCryptoRates.rates) { resultEl.textContent = '‚Äî'; return; }
  var r = homeCryptoRates.rates;
  var fromRate = r[from] || 1;
  var toRate = r[to] || 1;
  var result = amount / fromRate * toRate;
  var decimals = (to==='BTC'||from==='BTC') ? 8 : (to==='ETH'||from==='ETH') ? 6 : 2;
  var symbols = {EUR:'‚Ç¨',USD:'$',AUD:'A$',NZD:'N$',CAD:'C$',BTC:'‚Çø',ETH:'Œû'};
  resultEl.textContent = (symbols[to]||'') + ' ' + result.toLocaleString('de-DE',{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
}

function swapCurrency() {
  var f = document.getElementById('homeConvFrom');
  var t = document.getElementById('homeConvTo');
  var tmp = f.value; f.value = t.value; t.value = tmp;
  convertCurrency();
}

// ===================== PERCENTAGE CALCULATOR =====================
function calcPercent() {
  var num = parseFloat(document.getElementById('homePctNumber').value) || 0;
  var pct = parseFloat(document.getElementById('homePctPercent').value) || 10;
  var result = (num * pct / 100);
  document.getElementById('homePctResult').textContent = result % 1 === 0 ? result.toLocaleString() : result.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('homePctLabel').textContent = pct + '% of ' + num.toLocaleString();
}

// ===================== CALENDAR OVERLAY =====================
function openCalendar() {
  document.getElementById('calOverlay').classList.add('show');
  initCalendar();
}
function closeCalendar() {
  document.getElementById('calOverlay').classList.remove('show');
}

// ===================== EVENT DETAIL MODAL =====================
function openCalEventModal(ev) {
  var modal = document.getElementById('calEventModal');
  var typeConfig = {
    'Holiday': { icon: 'üéÑ', bg: '#fef2f2', color: '#dc2626' },
    'Promo': { icon: 'üéØ', bg: '#eff6ff', color: '#2563eb' },
    'Tournament': { icon: 'üèÜ', bg: '#ecfdf5', color: '#059669' },
    'VIP Event': { icon: 'üëë', bg: '#fdf4ff', color: '#a855f7' }
  };
  var tc = typeConfig[ev.type] || { icon: 'üìå', bg: '#f8fafc', color: '#64748b' };
  
  document.getElementById('calModalIcon').textContent = tc.icon;
  document.getElementById('calModalIcon').style.background = tc.bg;
  document.getElementById('calModalTitle').textContent = ev.event;
  document.getElementById('calModalSubtitle').textContent = ev.type || 'Event';
  document.getElementById('calModalHeader').style.borderBottom = '3px solid ' + tc.color;
  
  var html = '';
  html += '<div class="cal-modal-row"><div class="cal-modal-row-icon">üìÖ</div><div class="cal-modal-row-label">Date</div><div class="cal-modal-row-value">' + escapeHtml(ev.date) + ' (' + escapeHtml(ev.dayOfWeek || '') + ')</div></div>';
  html += '<div class="cal-modal-row"><div class="cal-modal-row-icon">üè∑Ô∏è</div><div class="cal-modal-row-label">Type</div><div class="cal-modal-row-value"><span style="background:' + tc.bg + ';color:' + tc.color + ';padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700">' + escapeHtml(ev.type) + '</span></div></div>';
  if (ev.description) html += '<div class="cal-modal-row"><div class="cal-modal-row-icon">üìù</div><div class="cal-modal-row-label">Description</div><div class="cal-modal-row-value">' + escapeHtml(ev.description) + '</div></div>';
  if (ev.status) {
    var statusColors = { 'Planned': '#3b82f6', 'In Progress': '#f59e0b', 'Done': '#10b981', 'Cancelled': '#ef4444' };
    var sc = statusColors[ev.status] || '#94a3b8';
    html += '<div class="cal-modal-row"><div class="cal-modal-row-icon">üìä</div><div class="cal-modal-row-label">Status</div><div class="cal-modal-row-value"><span style="color:' + sc + ';font-weight:800">‚óè ' + escapeHtml(ev.status) + '</span></div></div>';
  }
  if (ev.daysUntil !== undefined) {
    var daysText = ev.isToday ? 'üéØ Today!' : ev.isPast ? ev.daysUntil + ' days ago' : 'in ' + ev.daysUntil + ' days';
    html += '<div class="cal-modal-row"><div class="cal-modal-row-icon">‚è≥</div><div class="cal-modal-row-label">Countdown</div><div class="cal-modal-row-value">' + daysText + '</div></div>';
  }
  
  document.getElementById('calModalBody').innerHTML = html;
  modal.style.display = 'flex';
}

function closeCalEventModal() {
  document.getElementById('calEventModal').style.display = 'none';
}

// ===================== BIRTHDAY CALENDAR =====================
function renderBirthdays(data) {
  var el = document.getElementById('homeBirthdays');
  if (!el || !data || !data.birthdays) return;
  
  var bdays = data.birthdays;
  if (bdays.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px">No birthdays found. Add a Birthday column to PROFILING sheet.</div>';
    return;
  }
  
  var countEl = document.getElementById('homeBirthdayCount');
  if (countEl) countEl.textContent = bdays.length;
  
  var html = '';
  bdays.forEach(function(b) {
    var badge = '';
    if (b.isToday) {
      badge = '<span style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;margin-left:6px;animation:pulse 1.5s infinite">üéÇ TODAY!</span>';
    } else if (b.daysUntil <= 7) {
      badge = '<span style="background:#fef3c7;color:#d97706;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px">in ' + b.daysUntil + 'd</span>';
    } else if (b.daysUntil <= 30) {
      badge = '<span style="background:#e0e7ff;color:#667eea;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px">in ' + b.daysUntil + 'd</span>';
    } else {
      badge = '<span style="background:#f1f5f9;color:#94a3b8;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px">in ' + b.daysUntil + 'd</span>';
    }
    
    var countryFlag = b.country ? '<span style="margin-left:4px;font-size:11px;color:#94a3b8">' + escapeHtml(b.country) + '</span>' : '';
    var ageInfo = b.age ? '<span style="font-size:10px;color:#94a3b8;margin-left:4px">(' + b.age + ' y.o.)</span>' : '';
    
    html += '<div class="home-birthday-item' + (b.isToday ? ' today' : '') + '" onclick="openBirthdayPlayer(\'' + escapeHtml(b.email).replace(/'/g, "\\'") + '\')" title="Click to open player card">' +
      '<div class="home-birthday-date">' + escapeHtml(b.birthday) + '</div>' +
      '<div class="home-birthday-info">' +
        '<div class="home-birthday-name">' + escapeHtml(b.name) + ageInfo + countryFlag + badge + '</div>' +
      '</div>' +
    '</div>';
  });
  
  el.innerHTML = html;
}

function openBirthdayPlayer(email) {
  if (!email) return;
  closeHomePage();
  closeCalendar();
  showProfilingView();
  setTimeout(function() {
    var searchInput = document.getElementById('profilingSearchInput');
    if (searchInput) {
      searchInput.value = email;
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      searchInput.focus();
    }
  }, 800);
}

// ===================== PROMO PLAN =====================
function renderPromoPlan(data) {
  var el = document.getElementById('homePromo');
  if (!el || !data || !data.events) return;
  
  var events = data.events;
  if (events.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px">No events found.</div>';
    return;
  }
  
  var countEl = document.getElementById('homePromoCount');
  var upcoming = events.filter(function(e) { return !e.isPast; });
  if (countEl) countEl.textContent = upcoming.length;
  
  var html = '';
  var lastMonth = '';
  events.forEach(function(ev) {
    // Month separator
    var month = ev.dateShort.split(' ')[1] || '';
    if (month !== lastMonth) {
      html += '<div style="font-size:10px;font-weight:800;text-transform:uppercase;color:#667eea;padding:8px 0 4px;border-bottom:1px solid #f1f5f9;margin-bottom:4px">' + escapeHtml(month) + '</div>';
      lastMonth = month;
    }
    
    var typeColors = {
      'Holiday': { bg: '#fef3c7', color: '#d97706', icon: 'üéÑ' },
      'Promo': { bg: '#e0e7ff', color: '#667eea', icon: 'üéØ' },
      'Tournament': { bg: '#d1fae5', color: '#059669', icon: 'üèÜ' },
      'VIP Event': { bg: '#fce7f3', color: '#db2777', icon: 'üëë' },
      'Other': { bg: '#f1f5f9', color: '#64748b', icon: 'üìå' }
    };
    var tc = typeColors[ev.type] || typeColors['Other'];
    
    var statusBadge = '';
    if (ev.status) {
      var statusColors = { 'Planned': '#3b82f6', 'In Progress': '#f59e0b', 'Done': '#10b981', 'Cancelled': '#ef4444' };
      var sc = statusColors[ev.status] || '#94a3b8';
      statusBadge = '<span style="font-size:9px;font-weight:700;color:' + sc + ';margin-left:6px">‚óè ' + escapeHtml(ev.status) + '</span>';
    }
    
    var daysBadge = '';
    if (ev.isToday) {
      daysBadge = '<span style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px">TODAY</span>';
    } else if (!ev.isPast && ev.daysUntil <= 7) {
      daysBadge = '<span style="background:#fef3c7;color:#d97706;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px">in ' + ev.daysUntil + 'd</span>';
    } else if (!ev.isPast && ev.daysUntil <= 30) {
      daysBadge = '<span style="background:#e0e7ff;color:#667eea;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px">in ' + ev.daysUntil + 'd</span>';
    }
    
    var opacity = ev.isPast ? 'opacity:0.45;' : '';
    
    html += '<div class="home-promo-item" style="' + opacity + '">' +
      '<div class="home-promo-date">' +
        '<div style="font-size:14px;font-weight:800;color:#334155">' + escapeHtml(ev.dateShort.split(' ')[0]) + '</div>' +
        '<div style="font-size:9px;color:#94a3b8;text-transform:uppercase">' + escapeHtml(ev.dayOfWeek) + '</div>' +
      '</div>' +
      '<div class="home-promo-info">' +
        '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">' +
          '<span>' + tc.icon + '</span>' +
          '<span style="font-weight:700;font-size:12px;color:#1e293b">' + escapeHtml(ev.event) + '</span>' +
          '<span style="background:' + tc.bg + ';color:' + tc.color + ';font-size:9px;font-weight:700;padding:1px 6px;border-radius:8px">' + escapeHtml(ev.type) + '</span>' +
          statusBadge +
        '</div>' +
        (ev.description ? '<div style="font-size:11px;color:#94a3b8;margin-top:2px">' + escapeHtml(ev.description) + '</div>' : '') +
      '</div>' +
      '<div class="home-promo-badge">' + daysBadge + '</div>' +
    '</div>';
  });
  
  el.innerHTML = html;
}

// ===================== FULL CALENDAR VIEW =====================
var calYear, calMonth, calEvents = [], calBirthdays = [], calSelectedDay = null;

var calMonthThemes = {
  0:  { bg: 'linear-gradient(135deg,#f0f4ff,#e8edf5)', accent: 'linear-gradient(135deg,#64748b,#475569)', particles: ['‚ùÑÔ∏è','‚õÑ','‚ú®','üåü'] },
  1:  { bg: 'linear-gradient(135deg,#faf5ff,#f3e8ff)', accent: 'linear-gradient(135deg,#a855f7,#7c3aed)', particles: ['üíú','üíï','‚ú®','üå∏'] },
  2:  { bg: 'linear-gradient(135deg,#ecfdf5,#f0fdf4)', accent: 'linear-gradient(135deg,#059669,#10b981)', particles: ['üå±','üçÄ','üåø','‚òòÔ∏è'] },
  3:  { bg: 'linear-gradient(135deg,#fefce8,#fef9c3)', accent: 'linear-gradient(135deg,#d97706,#f59e0b)', particles: ['üå∑','üê£','üåº','ü¶ã'] },
  4:  { bg: 'linear-gradient(135deg,#f0fdf4,#ecfdf5)', accent: 'linear-gradient(135deg,#16a34a,#22c55e)', particles: ['üå∫','üåª','üå∏','üåø'] },
  5:  { bg: 'linear-gradient(135deg,#eff6ff,#e0f2fe)', accent: 'linear-gradient(135deg,#0284c7,#38bdf8)', particles: ['‚òÄÔ∏è','üåä','üèñÔ∏è','üêö'] },
  6:  { bg: 'linear-gradient(135deg,#fff7ed,#fef3c7)', accent: 'linear-gradient(135deg,#ea580c,#f97316)', particles: ['üî•','‚òÄÔ∏è','üå¥','üçâ'] },
  7:  { bg: 'linear-gradient(135deg,#fffbeb,#fef3c7)', accent: 'linear-gradient(135deg,#d97706,#eab308)', particles: ['üåª','‚òÄÔ∏è','üåæ','üèñÔ∏è'] },
  8:  { bg: 'linear-gradient(135deg,#fef9c3,#fed7aa)', accent: 'linear-gradient(135deg,#b45309,#d97706)', particles: ['üçÇ','üçÅ','üéí','üìö'] },
  9:  { bg: 'linear-gradient(135deg,#eef2ff,#e0e7ff)', accent: 'linear-gradient(135deg,#6366f1,#4f46e5)', particles: ['üéÉ','üëª','üï∏Ô∏è','ü¶á'] },
  10: { bg: 'linear-gradient(135deg,#f8fafc,#f1f5f9)', accent: 'linear-gradient(135deg,#64748b,#475569)', particles: ['üåßÔ∏è','üçÇ','üïØÔ∏è','üçÅ'] },
  11: { bg: 'linear-gradient(135deg,#ecfdf5,#f0f9ff)', accent: 'linear-gradient(135deg,#059669,#0d9488)', particles: ['üéÑ','üéÖ','‚≠ê','üéÅ'] }
};

function initCalendar() {
  var now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth();
  
  if (promoPlanCache && promoPlanCache.events) calEvents = promoPlanCache.events;
  if (birthdaysCache && birthdaysCache.birthdays) calBirthdays = birthdaysCache.birthdays;
  
  // Also load fresh if caches empty
  if (!calEvents.length) {
    google.script.run.withSuccessHandler(function(d) {
      if (d && d.events) { calEvents = d.events; renderCalendar(); }
    }).getPromoPlan();
  }
  if (!calBirthdays.length) {
    google.script.run.withSuccessHandler(function(d) {
      if (d && d.birthdays) { calBirthdays = d.birthdays; renderCalendar(); }
    }).getUpcomingBirthdays();
  }
  
  renderCalendar();
}

function calPrevMonth() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
function calNextMonth() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); }
function calGoToday() { var n = new Date(); calYear = n.getFullYear(); calMonth = n.getMonth(); renderCalendar(); }

function renderCalendar() {
  var theme = calMonthThemes[calMonth];
  var bg = document.getElementById('calMonthBg');
  bg.style.background = theme.bg;
  
  document.getElementById('calMonthTitle').style.setProperty('--cal-accent', theme.accent);
  document.getElementById('calMonthTitle').style.background = theme.accent;
  document.getElementById('calMonthTitle').style.webkitBackgroundClip = 'text';
  document.getElementById('calMonthTitle').style.webkitTextFillColor = 'transparent';
  
  var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = monthNames[calMonth] + ' ' + calYear;
  
  renderCalParticles(theme.particles);
  
  var grid = document.getElementById('calGrid');
  var weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  var html = weekdays.map(function(d) { return '<div class="cal-weekday">' + d + '</div>'; }).join('');
  
  var firstDay = new Date(calYear, calMonth, 1).getDay();
  firstDay = firstDay === 0 ? 6 : firstDay - 1;
  var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  var today = new Date();
  var isCurrentMonth = today.getFullYear() === calYear && today.getMonth() === calMonth;
  
  for (var e = 0; e < firstDay; e++) {
    html += '<div class="cal-day empty"></div>';
  }
  
  for (var d = 1; d <= daysInMonth; d++) {
    var classes = ['cal-day'];
    var isToday = isCurrentMonth && d === today.getDate();
    if (isToday) classes.push('today');
    
    var dayEvents = getEventsForDay(d, calMonth, calYear);
    var dayBdays = getBirthdaysForDay(d, calMonth);
    var totalItems = dayEvents.length + dayBdays.length;
    
    var cardsHtml = '';
    var maxCards = 3;
    var shown = 0;
    
    dayBdays.forEach(function(b) {
      if (shown >= maxCards) return;
      cardsHtml += '<div class="cal-card birthday" title="' + escapeHtml(b.name) + '">üéÇ ' + escapeHtml(b.name.split(' ')[0]) + '</div>';
      shown++;
    });
    
    dayEvents.forEach(function(ev) {
      if (shown >= maxCards) return;
      var cardType = (ev.type || 'Other').toLowerCase();
      if (cardType === 'vip event') cardType = 'vip';
      var icons = { holiday:'üéÑ', promo:'üéØ', tournament:'üèÜ', vip:'üëë' };
      cardsHtml += '<div class="cal-card ' + cardType + '" title="' + escapeHtml(ev.event) + '">' + (icons[cardType]||'üìå') + ' ' + escapeHtml(ev.event) + '</div>';
      shown++;
    });
    
    if (totalItems > maxCards) {
      cardsHtml += '<div class="cal-card-more">+' + (totalItems - maxCards) + ' more</div>';
    }
    
    html += '<div class="' + classes.join(' ') + '" onclick="calSelectDay(' + d + ')">' +
      '<div class="cal-day-num">' + d + '</div>' +
      '<div class="cal-day-cards">' + cardsHtml + '</div>' +
    '</div>';
  }
  
  grid.innerHTML = html;
  
  if (isCurrentMonth) {
    calSelectDay(today.getDate());
  } else {
    calSelectDay(1);
  }
}

function getEventsForDay(day, month, year) {
  return calEvents.filter(function(ev) {
    var parts = ev.date.split('.');
    return parts.length === 3 && parseInt(parts[0]) === day && parseInt(parts[1]) === (month + 1) && parseInt(parts[2]) === year;
  });
}

function getBirthdaysForDay(day, month) {
  return calBirthdays.filter(function(b) {
    var parts = b.birthday.split('.');
    return parts.length >= 2 && parseInt(parts[0]) === day && parseInt(parts[1]) === (month + 1);
  });
}

function calSelectDay(day) {
  calSelectedDay = day;
  document.querySelectorAll('.cal-day').forEach(function(d) { d.classList.remove('selected'); });
  var allDays = document.querySelectorAll('.cal-day:not(.empty)');
  if (allDays[day - 1]) allDays[day - 1].classList.add('selected');
  
  var events = getEventsForDay(day, calMonth, calYear);
  var bdays = getBirthdaysForDay(day, calMonth);
  var panel = document.getElementById('calDetailPanel');
  var list = document.getElementById('calDetailList');
  
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var dt = new Date(calYear, calMonth, day);
  document.getElementById('calDetailDate').textContent = dayNames[dt.getDay()] + ', ' + day + ' ' + monthNames[calMonth] + ' ' + calYear;
  
  if (events.length === 0 && bdays.length === 0) {
    document.getElementById('calDetailIcon').textContent = 'üìÖ';
    list.innerHTML = '<div style="text-align:center;color:#94a3b8;font-size:13px;padding:24px">No events on this day</div>';
    panel.style.display = 'block';
    return;
  }
  
  document.getElementById('calDetailIcon').textContent = 'üìå';
  var html = '';
  
  bdays.forEach(function(b) {
    html += '<div class="cal-detail-item birthday" onclick="openBirthdayPlayer(\'' + escapeHtml(b.email).replace(/'/g, "\\'") + '\')">' +
      '<div class="cal-detail-icon">üéÇ</div>' +
      '<div class="cal-detail-info">' +
        '<div class="cal-detail-name">' + escapeHtml(b.name) + '</div>' +
        '<div class="cal-detail-desc">' + (b.age ? 'Turns ' + b.age + ' years old' : 'Birthday') + (b.country ? ' ¬∑ ' + escapeHtml(b.country) : '') + '</div>' +
      '</div>' +
      '<div class="cal-detail-badge" style="background:#fff7ed;color:#ea580c">üéÇ Birthday</div>' +
    '</div>';
  });
  
  events.forEach(function(ev, idx) {
    var typeConfig = {
      'Holiday': { icon: 'üéÑ', badge_bg: '#fef2f2', badge_color: '#dc2626' },
      'Promo': { icon: 'üéØ', badge_bg: '#eff6ff', badge_color: '#2563eb' },
      'Tournament': { icon: 'üèÜ', badge_bg: '#ecfdf5', badge_color: '#059669' },
      'VIP Event': { icon: 'üëë', badge_bg: '#fdf4ff', badge_color: '#a855f7' }
    };
    var tc = typeConfig[ev.type] || { icon: 'üìå', badge_bg: '#f8fafc', badge_color: '#64748b' };
    var itemClass = (ev.type || 'other').toLowerCase().replace(' ', '');
    if (itemClass === 'vipevent') itemClass = 'vip';
    
    html += '<div class="cal-detail-item ' + itemClass + '" onclick="openCalEventFromDay(' + day + ',' + idx + ')" style="cursor:pointer">' +
      '<div class="cal-detail-icon">' + tc.icon + '</div>' +
      '<div class="cal-detail-info">' +
        '<div class="cal-detail-name">' + escapeHtml(ev.event) + '</div>' +
        (ev.description ? '<div class="cal-detail-desc">' + escapeHtml(ev.description) + '</div>' : '') +
      '</div>' +
      '<div class="cal-detail-badge" style="background:' + tc.badge_bg + ';color:' + tc.badge_color + '">' + escapeHtml(ev.type) + '</div>' +
    '</div>';
  });
  
  list.innerHTML = html;
  panel.style.display = 'block';
}

function openCalEventFromDay(day, idx) {
  var events = getEventsForDay(day, calMonth, calYear);
  if (events[idx]) openCalEventModal(events[idx]);
}

function renderCalParticles(emojis) {
  var container = document.getElementById('calParticles');
  container.innerHTML = '';
  for (var i = 0; i < 20; i++) {
    var p = document.createElement('div');
    p.className = 'cal-particle';
    p.textContent = emojis[i % emojis.length];
    p.style.left = (Math.random() * 95) + '%';
    p.style.fontSize = (16 + Math.random() * 20) + 'px';
    p.style.animationDuration = (10 + Math.random() * 20) + 's';
    p.style.animationDelay = (-Math.random() * 20) + 's';
    p.style.opacity = '0';
    container.appendChild(p);
  }
}
// ==========================================
// BONUS REPORT
// ==========================================
var bonusDataLoaded = false;
var bonusMode = 'monthly';
var bonusRawData = { monthly: null, weekly: null, daily: null };
var bonusActiveTypes = [];
var bonusAllTypes = [];
var bonusChartInstances = [];
var bonusExpandedPeriods = {};
var bonusVisibleCols = { countIssued:true, totalInEUR:true, countCancelled:false, countWagerDone:false, depositEUR:false, betsEUR:true, countActive:false, currencyList:false };

var BONUS_ALL_COLS = [
  { key: 'countIssued', label: 'Count' },
  { key: 'totalInEUR', label: 'Total EUR' },
  { key: 'countCancelled', label: 'Cancelled' },
  { key: 'countWagerDone', label: 'Wager Done' },
  { key: 'depositEUR', label: 'Deposit EUR' },
  { key: 'betsEUR', label: 'Bets EUR' },
  { key: 'countActive', label: 'Active' },
  { key: 'currencyList', label: 'Currencies' }
];

var MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function switchBonusMode(mode) {
  bonusMode = mode;
  ['monthly','weekly','daily'].forEach(function(m) {
    var tab = document.getElementById('bonus' + m.charAt(0).toUpperCase() + m.slice(1) + 'Tab');
    if (tab) tab.classList.toggle('active', m === mode);
  });
  bonusExpandedPeriods = {};
  if (bonusRawData[mode]) {
    renderBonusReport();
  } else {
    loadBonusSheetData(mode);
  }
}

function loadBonusData() {
  document.getElementById('bonus-table').innerHTML = '<tr><td style="text-align:center;padding:40px;color:#64748b">Loading bonus data...</td></tr>';
  loadBonusSheetData('monthly');
}

function loadBonusSheetData(mode) {
  var sheetMap = { monthly: 'BONUS REPORT [MONTHLY]', weekly: 'BONUS REPORT [WEEKLY]', daily: 'BONUS REPORT [DAILY]' };
  document.getElementById('bonus-table').innerHTML = '<tr><td style="text-align:center;padding:40px;color:#64748b">Loading ' + mode + ' data...</td></tr>';
  google.script.run
    .withSuccessHandler(function(data) {
      if (data && !data.error) {
        bonusRawData[mode] = data;
        bonusDataLoaded = true;
        renderBonusReport();
      } else {
        document.getElementById('bonus-table').innerHTML = '<tr><td style="text-align:center;padding:40px;color:#ef4444">Error: ' + (data ? data.error : 'No data') + '</td></tr>';
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('bonus-table').innerHTML = '<tr><td style="text-align:center;padding:40px;color:#ef4444">Error: ' + err + '</td></tr>';
    })
    .getBonusReportData(sheetMap[mode]);
}

function formatBonusPeriod(raw) {
  if (!raw) return '';
  var s = String(raw).trim();
  var d = new Date(s);
  if (!isNaN(d.getTime())) {
    if (bonusMode === 'monthly') return MONTH_NAMES[d.getMonth()] + ' ' + d.getFullYear();
    var dd = String(d.getDate()).padStart(2,'0');
    var mm = String(d.getMonth()+1).padStart(2,'0');
    return dd + '.' + mm + '.' + d.getFullYear();
  }
  return s;
}

function renderBonusReport() {
  var data = bonusRawData[bonusMode];
  if (!data || !data.rows) return;

  var rows = data.rows.filter(function(r) {
    return r.title && r.title.indexOf('Strategy total') === -1 && r.title.indexOf('Aggregated') === -1 && r.type;
  });
  rows.forEach(function(r) { r.periodFmt = formatBonusPeriod(r.period); });

  var typeSet = {};
  rows.forEach(function(r) { if (r.type) typeSet[r.type] = true; });
  bonusAllTypes = Object.keys(typeSet).sort();
  if (bonusActiveTypes.length === 0) bonusActiveTypes = bonusAllTypes.slice();

  renderBonusTypeFilters();
  var filtered = rows.filter(function(r) { return bonusActiveTypes.indexOf(r.type) !== -1; });

  // Aggregate by formatted period + type + title
  var aggMap = {};
  filtered.forEach(function(r) {
    var key = r.periodFmt + '||' + r.type + '||' + r.title;
    if (!aggMap[key]) {
      aggMap[key] = { period: r.periodFmt, type: r.type, title: r.title, currencies: {},
        countIssued:0, countCancelled:0, countWagerDone:0, depositEUR:0, betsEUR:0, totalInEUR:0, countActive:0 };
    }
    var a = aggMap[key];
    if (r.currency) a.currencies[r.currency] = true;
    a.countIssued += r.countIssued || 0;
    a.countCancelled += r.countCancelled || 0;
    a.countWagerDone += r.countWagerDone || 0;
    a.depositEUR += r.depositEUR || 0;
    a.betsEUR += r.betsEUR || 0;
    a.totalInEUR += r.totalInEUR || 0;
    a.countActive += r.countActive || 0;
  });
  var aggRows = Object.keys(aggMap).map(function(k) {
    var a = aggMap[k]; a.currencyList = Object.keys(a.currencies).sort().join(', '); return a;
  });

  // Group by period preserving order
  var periodGroups = {};
  var periodOrder = [];
  aggRows.forEach(function(r) {
    if (!periodGroups[r.period]) { periodGroups[r.period] = []; periodOrder.push(r.period); }
    periodGroups[r.period].push(r);
  });

  renderBonusSummary(filtered);
  renderBonusPies(filtered);
  renderBonusColumnToggle();
  renderBonusTable(periodGroups, periodOrder);
}

function renderBonusTypeFilters() {
  var container = document.getElementById('bonusTypeFilters');
  var allActive = bonusActiveTypes.length === bonusAllTypes.length;
  var html = '<button onclick="toggleBonusType(\'ALL\')" style="padding:6px 14px;border-radius:8px;border:1.5px solid ' + (allActive ? '#667eea' : '#e2e8f0') + ';background:' + (allActive ? 'linear-gradient(135deg,#667eea,#764ba2)' : '#fff') + ';color:' + (allActive ? '#fff' : '#64748b') + ';font-size:12px;font-weight:700;cursor:pointer">ALL</button>';
  var tc = getBonusTypeColors();
  bonusAllTypes.forEach(function(t) {
    var active = bonusActiveTypes.indexOf(t) !== -1;
    var col = tc[t] || '#667eea';
    html += '<button onclick="toggleBonusType(\'' + t.replace(/'/g, "\\'") + '\')" style="padding:6px 14px;border-radius:8px;border:1.5px solid ' + (active ? col : '#e2e8f0') + ';background:' + (active ? col : '#fff') + ';color:' + (active ? '#fff' : '#64748b') + ';font-size:12px;font-weight:700;cursor:pointer;transition:all .2s">' + t + '</button>';
  });
  container.innerHTML = html;
}

function toggleBonusType(type) {
  if (type === 'ALL') {
    bonusActiveTypes = bonusActiveTypes.length === bonusAllTypes.length ? [] : bonusAllTypes.slice();
  } else {
    var idx = bonusActiveTypes.indexOf(type);
    if (idx === -1) bonusActiveTypes.push(type); else bonusActiveTypes.splice(idx, 1);
  }
  renderBonusReport();
}

function getBonusTypeColors() {
  return { 'Deposit':'#667eea','Freespins result':'#f472b6','Groups updated':'#34d399','Manual':'#fbbf24','No deposit':'#94a3b8','Personal':'#a78bfa','Rakeback':'#fb923c','Scheduler':'#22d3ee' };
}

function renderBonusColumnToggle() {
  var grid = document.getElementById('bonusColumnChecks');
  if (!grid) return;
  var html = '';
  BONUS_ALL_COLS.forEach(function(c) {
    var ch = bonusVisibleCols[c.key] ? 'checked' : '';
    html += '<label style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:#475569;cursor:pointer;padding:4px 0">';
    html += '<input type="checkbox" ' + ch + ' onchange="toggleBonusCol(\'' + c.key + '\',this.checked)" style="accent-color:#667eea">';
    html += c.label + '</label>';
  });
  grid.innerHTML = html;
}

function toggleBonusCol(key, val) {
  bonusVisibleCols[key] = val;
  renderBonusReport();
}

function toggleBonusColPanel() {
  var grid = document.getElementById('bonusColumnChecks');
  var arrow = document.getElementById('bonusColArrow');
  if (!grid) return;
  var open = grid.style.display === 'grid';
  grid.style.display = open ? 'none' : 'grid';
  if (arrow) arrow.textContent = open ? '‚ñº' : '‚ñ≤';
}

function renderBonusSummary(rows) {
  var ti=0,tc=0,te=0,tb=0;
  rows.forEach(function(r) { ti+=r.totalInEUR||0; tc+=r.countIssued||0; te+=r.totalInEUR||0; tb+=r.betsEUR||0; });
  var cards = [
    { label:'Total Issued (EUR)', value:'‚Ç¨'+ti.toLocaleString('en',{maximumFractionDigits:0}), icon:'üí∞', color:'#667eea' },
    { label:'Count Issued', value:tc.toLocaleString(), icon:'üìä', color:'#f472b6' },
    { label:'Total in EUR', value:'‚Ç¨'+te.toLocaleString('en',{maximumFractionDigits:0}), icon:'üí∂', color:'#34d399' },
    { label:'Bets in EUR', value:'‚Ç¨'+tb.toLocaleString('en',{maximumFractionDigits:0}), icon:'üé∞', color:'#a78bfa' }
  ];
  var html = '';
  cards.forEach(function(c) {
    html += '<div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:4px solid '+c.color+'">';
    html += '<div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:8px">'+c.icon+' '+c.label+'</div>';
    html += '<div style="font-size:22px;font-weight:800;color:#1e293b">'+c.value+'</div></div>';
  });
  document.getElementById('bonusSummaryCards').innerHTML = html;
}

function renderBonusPies(rows) {
  bonusChartInstances.forEach(function(c){c.destroy();}); bonusChartInstances=[];
  var tc = getBonusTypeColors();
  var byType = {};
  rows.forEach(function(r) {
    if (!byType[r.type]) byType[r.type]={totalInEUR:0,countIssued:0,betsEUR:0};
    byType[r.type].totalInEUR+=r.totalInEUR||0; byType[r.type].countIssued+=r.countIssued||0; byType[r.type].betsEUR+=r.betsEUR||0;
  });
  function sd(key){ var it=Object.keys(byType).map(function(t){return{label:t,value:byType[t][key]};}).filter(function(i){return i.value>0;}); it.sort(function(a,b){return b.value-a.value;}); return it; }
  var pies=[
    {title:'Total EUR by Type',key:'totalInEUR',fmt:function(v){return '‚Ç¨'+v.toLocaleString('en',{maximumFractionDigits:0});}},
    {title:'Count Issued by Type',key:'countIssued',fmt:function(v){return v.toLocaleString();}},
    {title:'Bets EUR by Type',key:'betsEUR',fmt:function(v){return '‚Ç¨'+v.toLocaleString('en',{maximumFractionDigits:0});}}
  ];
  var container=document.getElementById('bonusPieSection'); var html='';
  pies.forEach(function(p,i){
    html+='<div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)">';
    html+='<div style="font-size:14px;font-weight:800;color:#1e293b;margin-bottom:16px;text-align:center">'+p.title+'</div>';
    html+='<div style="display:flex;align-items:center;gap:16px"><canvas id="bonusPie'+i+'" style="max-width:180px;max-height:180px;flex-shrink:0"></canvas>';
    html+='<div id="bonusPieLegend'+i+'" style="flex:1;font-size:12px"></div></div></div>';
  });
  container.innerHTML=html;
  pies.forEach(function(p,idx){
    var items=sd(p.key); var labels=items.map(function(i){return i.label;}); var vals=items.map(function(i){return i.value;});
    var colors=labels.map(function(l){return tc[l]||'#667eea';}); var total=vals.reduce(function(a,b){return a+b;},0);
    var ctx=document.getElementById('bonusPie'+idx); if(!ctx)return;
    var chart=new Chart(ctx.getContext('2d'),{type:'doughnut',data:{labels:labels,datasets:[{data:vals,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:true,cutout:'55%',plugins:{legend:{display:false},
        tooltip:{callbacks:{label:function(c){var pct=total?((c.raw/total)*100).toFixed(1):0;return c.label+': '+p.fmt(c.raw)+' ('+pct+'%)';}}}}
      }});
    bonusChartInstances.push(chart);
    var lh='';
    items.forEach(function(item){ var pct=total?((item.value/total)*100).toFixed(1):0; var col=tc[item.label]||'#667eea';
      lh+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
      lh+='<span style="width:10px;height:10px;border-radius:3px;background:'+col+';flex-shrink:0"></span>';
      lh+='<span style="color:#475569;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+item.label+'</span>';
      lh+='<span style="color:#1e293b;font-weight:800;white-space:nowrap">'+pct+'%</span></div>';
    });
    document.getElementById('bonusPieLegend'+idx).innerHTML=lh;
  });
}

function toggleBonusPeriod(period) {
  bonusExpandedPeriods[period] = !bonusExpandedPeriods[period];
  renderBonusReport();
}

function renderBonusTable(periodGroups, periodOrder) {
  var table = document.getElementById('bonus-table');
  var tc = getBonusTypeColors();
  var visCols = BONUS_ALL_COLS.filter(function(c){ return bonusVisibleCols[c.key]; });
  var numKeys = ['countIssued','totalInEUR','countCancelled','countWagerDone','depositEUR','betsEUR','countActive'];

  var html = '<thead><tr><th style="text-align:left;min-width:160px">Period</th><th style="text-align:left">Type</th><th style="text-align:left;min-width:180px">Title</th>';
  visCols.forEach(function(c){ html+='<th>'+c.label+'</th>'; });
  html += '</tr></thead><tbody>';

  periodOrder.forEach(function(period) {
    var group = periodGroups[period];
    var isExp = bonusExpandedPeriods[period];

    // Compute period totals
    var tots = {}; BONUS_ALL_COLS.forEach(function(c){ tots[c.key] = c.key==='currencyList' ? {} : 0; });
    group.forEach(function(r) {
      BONUS_ALL_COLS.forEach(function(c) {
        if (c.key==='currencyList') { if(r.currencyList) r.currencyList.split(', ').forEach(function(cu){if(cu)tots.currencyList[cu]=true;}); }
        else { tots[c.key] += r[c.key]||0; }
      });
    });
    tots.currencyList = Object.keys(tots.currencyList).sort().join(', ');

    // Period header row
    html += '<tr onclick="toggleBonusPeriod(\'' + period.replace(/'/g,"\\'") + '\')" style="cursor:pointer;background:linear-gradient(90deg,#f8fafc,#eef2ff);font-weight:700">';
    html += '<td style="white-space:nowrap;color:#1e293b;font-weight:800"><span style="display:inline-block;width:18px;font-size:11px;color:#667eea">' + (isExp?'‚ñº':'‚ñ∂') + '</span>' + period + ' <span style="color:#94a3b8;font-weight:600;font-size:11px">(' + group.length + ')</span></td>';
    html += '<td colspan="2" style="color:#94a3b8;font-size:11px;font-style:italic">' + (isExp?'':'click to expand') + '</td>';
    visCols.forEach(function(c) {
      var val = tots[c.key];
      if (c.key==='currencyList') { html+='<td style="font-size:11px;color:#64748b">'+val+'</td>'; }
      else if (numKeys.indexOf(c.key)!==-1) { html+='<td style="text-align:right;font-weight:800;color:#1e293b;font-variant-numeric:tabular-nums">'+(typeof val==='number'&&val!==0?val.toLocaleString('en',{maximumFractionDigits:2}):'‚Äî')+'</td>'; }
      else { html+='<td>'+(val||'')+'</td>'; }
    });
    html += '</tr>';

    // Detail rows if expanded
    if (isExp) {
      group.forEach(function(r) {
        var col = tc[r.type]||'#667eea';
        html += '<tr style="background:#fff">';
        html += '<td></td>';
        html += '<td><span style="display:inline-block;padding:2px 8px;border-radius:5px;background:'+col+'18;color:'+col+';font-weight:700;font-size:11px;white-space:nowrap">'+r.type+'</span></td>';
        html += '<td style="font-size:13px;color:#334155;white-space:nowrap">'+r.title+'</td>';
        visCols.forEach(function(c) {
          var val=r[c.key];
          if(c.key==='currencyList'){html+='<td style="font-size:11px;color:#64748b">'+(val||'')+'</td>';}
          else if(numKeys.indexOf(c.key)!==-1){html+='<td style="text-align:right;font-weight:600;font-variant-numeric:tabular-nums;color:#475569">'+(typeof val==='number'&&val!==0?val.toLocaleString('en',{maximumFractionDigits:2}):'<span style="color:#cbd5e1">‚Äî</span>')+'</td>';}
          else{html+='<td style="font-size:13px">'+(val||'')+'</td>';}
        });
        html += '</tr>';
      });
    }
  });

  html += '</tbody>';
  table.innerHTML = html;
}

</script>

<!-- Metric Modal -->

<div id="pieChartModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center" onclick="if(event.target.id==='pieChartModal') closePieChartModal()">
  <div style="background:#fff;border-radius:12px;max-width:95%;max-height:90vh;width:1400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:2px solid #e2e8f0">
      <h2 id="pieChartModalTitle" style="margin:0;font-size:24px;font-weight:700;color:#1e293b"></h2>
      <button onclick="closePieChartModal()" style="background:none;border:none;font-size:32px;color:#64748b;cursor:pointer;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.2s" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">√ó</button>
    </div>
    <div style="padding:24px;overflow-y:auto;flex:1">
      <div style="display:flex;flex-direction:column;gap:24px">
        <div style="display:flex;justify-content:center;align-items:center">
          <div style="width:400px;height:400px;position:relative">
            <canvas id="pieChartModalCanvas"></canvas>
          </div>
        </div>
        <div style="display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="font-size:16px;font-weight:600;color:#1e293b;margin:0">
              <span id="pieFilterIndicator"></span>Players Breakdown
            </h3>
            <div style="position:relative">
              <button id="pieColumnSelectorBtn" onclick="togglePieColumnSelector(event)" style="background:#667eea;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600">
                ‚öôÔ∏è Columns
              </button>
              <div id="pieColumnSelector" style="display:none;position:absolute;top:100%;right:0;margin-top:8px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:16px;width:280px;max-height:500px;overflow-y:auto;z-index:10000"></div>
            </div>
          </div>
          <div style="overflow:auto;border:1px solid #e2e8f0;border-radius:8px">
            <table class="metric-table" style="width:100%;border-collapse:collapse">
              <thead id="pieModalTableHeader"></thead>
              <tbody id="pieModalTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Unified Flip Card Modal -->
<!-- HOME Button -->
<button class="cal-fab" onclick="openCalendar()" title="Calendar">üìÖ</button>
<button class="home-btn-fab" onclick="openHomePage()" title="Home">üè†</button>

<!-- HOME Overlay -->
<div class="home-overlay" id="homeOverlay" onclick="if(event.target.id==='homeOverlay')closeHomePage()">
<div class="home-container">
  <!-- Top Bar -->
  <div class="home-top-bar">
    <div class="home-clock">
      <div class="home-clock-item">
        <div class="home-clock-label">üá∫üá¶ KYIV</div>
        <div class="home-clock-time" id="homeClockKyiv">--:--:--</div>
      </div>
      <div style="width:1px;height:32px;background:rgba(255,255,255,0.15)"></div>
      <div class="home-clock-item">
        <div class="home-clock-label">üåê UTC</div>
        <div class="home-clock-time" id="homeClockUTC">--:--:--</div>
      </div>
    </div>
    <div class="home-crypto" id="homeCrypto">
      <div class="home-crypto-item" id="homeBtcPrice">
        <span class="home-crypto-icon btc">‚Çø</span>
        <div><div class="home-crypto-label">Bitcoin</div><span class="home-crypto-price">Loading...</span></div>
      </div>
      <div class="home-crypto-item" id="homeEthPrice">
        <span class="home-crypto-icon eth">Œû</span>
        <div><div class="home-crypto-label">Ethereum</div><span class="home-crypto-price">Loading...</span></div>
      </div>
    </div>
    <button class="home-close-btn" onclick="closeHomePage()">‚úï</button>
  </div>
  <!-- Timezone Bar -->
  <div class="home-tz-bar" id="homeTzBar">
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá¶üá∫</span><span class="home-tz-name">Australia</span><span class="home-tz-time" id="tzSydney">--:--</span></div>
      <div class="home-tz-dropdown">
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üèôÔ∏è Sydney</span><span class="home-tz-drop-time" id="tzSydney2">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üå¥ Brisbane</span><span class="home-tz-drop-time" id="tzBrisbane">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üèñÔ∏è Perth</span><span class="home-tz-drop-time" id="tzPerth">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üé≠ Adelaide</span><span class="home-tz-drop-time" id="tzAdelaide">--:--</span></div>
      </div>
    </div>
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá≥üáø</span><span class="home-tz-name">N. Zealand</span><span class="home-tz-time" id="tzAuckland">--:--</span></div>
    </div>
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá®üá¶</span><span class="home-tz-name">Canada</span><span class="home-tz-time" id="tzToronto">--:--</span></div>
      <div class="home-tz-dropdown">
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üèôÔ∏è Toronto (ET)</span><span class="home-tz-drop-time" id="tzToronto2">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üåæ Winnipeg (CT)</span><span class="home-tz-drop-time" id="tzWinnipeg">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üèîÔ∏è Calgary (MT)</span><span class="home-tz-drop-time" id="tzCalgary">--:--</span></div>
        <div class="home-tz-drop-item"><span class="home-tz-drop-city">üåä Vancouver (PT)</span><span class="home-tz-drop-time" id="tzVancouver">--:--</span></div>
      </div>
    </div>
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá©üá™</span><span class="home-tz-name">Germany</span><span class="home-tz-time" id="tzBerlin">--:--</span></div>
    </div>
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá¶üáπ</span><span class="home-tz-name">Austria</span><span class="home-tz-time" id="tzVienna">--:--</span></div>
    </div>
    <div class="home-tz-group" onclick="toggleTzDrop(this)">
      <div class="home-tz-chip"><span class="home-tz-flag">üá®üá≠</span><span class="home-tz-name">Switzerland</span><span class="home-tz-time" id="tzZurich">--:--</span></div>
    </div>
  </div>

  <div class="home-grid">
    <div class="home-main">
      <!-- News -->
      <div class="home-card">
        <div class="home-card-header"><span>üì∞ News</span><span class="home-card-count" id="homeNewsCount"></span></div>
        <div class="home-card-body home-scrollable" id="homeNews"><div style="text-align:center;color:#94a3b8;padding:40px">Loading...</div></div>
      </div>
      <!-- Blog -->
      <div class="home-card">
        <div class="home-card-header"><span>üìù Blog</span><span class="home-card-count" id="homeBlogCount"></span></div>
        <div class="home-card-body home-scrollable" id="homeBlog"><div style="text-align:center;color:#94a3b8;padding:40px">Loading...</div></div>
      </div>
    </div>
    <div class="home-side">
      <!-- Percentage Calculator -->
      <div class="home-card">
        <div class="home-card-header">üìä Percentage Calculator</div>
        <div class="home-card-body">
          <div class="home-pct-calc">
            <div class="home-pct-row">
              <input type="number" class="home-pct-input" id="homePctNumber" placeholder="Enter number..." oninput="calcPercent()">
              <select class="home-pct-select" id="homePctPercent" onchange="calcPercent()">
                <option value="5">5%</option><option value="10" selected>10%</option><option value="15">15%</option><option value="20">20%</option><option value="25">25%</option><option value="30">30%</option><option value="50">50%</option><option value="75">75%</option><option value="100">100%</option>
              </select>
            </div>
            <div class="home-pct-result">
              <div class="home-pct-result-num" id="homePctResult">0</div>
              <div class="home-pct-result-label" id="homePctLabel">10% of 0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="home-card">
        <div class="home-card-header">üîó Useful Links</div>
        <div class="home-card-body" id="homeLinks" style="padding:10px"></div>
      </div>
      <div class="home-card">
        <div class="home-card-header">üí± Currency Converter</div>
        <div class="home-card-body">
          <div class="home-converter">
            <div class="home-conv-row">
              <input type="number" class="home-conv-input" id="homeConvAmount" value="100" oninput="convertCurrency()">
              <select class="home-conv-select" id="homeConvFrom" onchange="convertCurrency()">
                <option value="EUR">EUR ‚Ç¨</option><option value="USD">USD $</option><option value="AUD">AUD A$</option><option value="NZD">NZD N$</option><option value="CAD">CAD C$</option><option value="BTC">BTC ‚Çø</option><option value="ETH">ETH Œû</option>
              </select>
            </div>
            <div style="text-align:center"><button class="home-conv-swap" onclick="swapCurrency()">‚áÖ</button></div>
            <div class="home-conv-row">
              <select class="home-conv-select" id="homeConvTo" onchange="convertCurrency()">
                <option value="USD">USD $</option><option value="EUR" selected>EUR ‚Ç¨</option><option value="AUD">AUD A$</option><option value="NZD">NZD N$</option><option value="CAD">CAD C$</option><option value="BTC">BTC ‚Çø</option><option value="ETH">ETH Œû</option>
              </select>
            </div>
            <div class="home-conv-result" id="homeConvResult">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<div id="unifiedPlayerModal" class="unified-flip-modal" onclick="closeUnifiedModalOnBackdrop(event)">
  <div class="flip-card-container" onclick="event.stopPropagation()">
    <div class="flip-card" id="playerFlipCard">
      
      <!-- VIP Side (Front) -->
      <div class="flip-card-side flip-card-front">
        <div class="unified-card-header">
          <div class="unified-card-title-area">
            <div class="unified-card-avatar">üë§</div>
            <div class="unified-card-title-text">
              <h2 id="vipPlayerName">Player Name</h2>
              <p id="vipPlayerEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="61110d0018041321040c00080d4f020e0c">[email&#160;protected]</a></p>
            </div>
          </div>
          <div class="unified-card-header-actions">
            <button class="flip-toggle-btn" id="vipToProfilingFlipBtn" onclick="flipToProfilingCard()" style="display:none">
              üëë View Profiling
            </button>
            <button class="unified-card-delete" id="vipDeletePlayerBtn" onclick="deletePlayerFromModal()" style="background:#ef4444;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
              üóëÔ∏è DELETE
            </button>
            <button class="unified-card-close" onclick="closeUnifiedModal()">√ó</button>
          </div>
        </div>
        <div class="unified-card-body" style="padding:24px">
          <div style="display:flex;flex-direction:column;gap:24px">
            <div>
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0 0 16px 0">üìä Key Metrics</h3>
              <div id="vipPlayerMetrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px"></div>
            </div>
            <div>
              <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0 0 16px 0">üìã Detailed Information</h3>
              <div id="vipPlayerDetails" style="overflow:auto;border:1px solid var(--border);border-radius:8px"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profiling Side (Back) -->
      <div class="flip-card-side flip-card-back">
        <div class="unified-card-header">
          <div class="unified-card-title-area">
            <div class="unified-card-avatar">üëë</div>
            <div class="unified-card-title-text">
              <h2 id="profilingPlayerName">Player Name</h2>
              <p id="profilingPlayerEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dbabb7baa2bea99bbeb6bab2b7f5b8b4b6">[email&#160;protected]</a></p>
            </div>
          </div>
          <div class="unified-card-header-actions">
            <button class="flip-toggle-btn" id="profilingToVIPFlipBtn" onclick="flipToVIPCard()">
              üìä View VIP Data
            </button>
            <button class="unified-card-delete" id="profilingDeletePlayerBtn" onclick="deletePlayerFromModal()" style="background:#ef4444;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
              üóëÔ∏è DELETE
            </button>
            <button class="unified-card-close" onclick="closeUnifiedModal()">√ó</button>
          </div>
        </div>
        <div class="unified-card-body" id="profilingCardBody">
          <!-- Profiling content will be inserted here -->
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Filter Overlays -->
<div class="filter-overlay" id="depositFilterOverlay" onclick="closeDepositFilterSidebar()"></div>
<div class="filter-overlay" id="retentionFilterOverlay" onclick="closeRetentionFilterSidebar()"></div>

<!-- Deposit Filter Sidebar -->
<div class="filter-sidebar" id="depositFilterSidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <span>üîç</span>
      <span>Deposit Filters</span>
    </div>
    <div class="sidebar-subtitle">Filter conversion data</div>
    <button class="close-sidebar-btn" onclick="closeDepositFilterSidebar()">√ó</button>
  </div>
  
  <div class="sidebar-body">
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üìã</span>
        <span>Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search types..." id="depositTypeSearch">
      <div class="sidebar-filter-list" id="depositVipTypeFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üë§</span>
        <span>Manager</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search managers..." id="depositManagerSearch">
      <div class="sidebar-filter-list" id="depositManagerFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üéØ</span>
        <span>Traffic Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search traffic..." id="depositTrafficSearch">
      <div class="sidebar-filter-list" id="depositTrafficFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üåç</span>
        <span>Country</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search countries..." id="depositCountrySearch">
      <div class="sidebar-filter-list" id="depositCountryFilters"></div>
    </div>
  </div>
  
  <div class="sidebar-footer">
    <button class="sidebar-btn-apply" onclick="applyDepositFilters()">‚úÖ Apply Filters</button>
    <button class="sidebar-btn-clear" onclick="clearDepositFilters()">üîÑ Clear All</button>
  </div>
</div>

<!-- Retention Filter Sidebar -->
<div class="filter-sidebar" id="retentionFilterSidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <span>üîç</span>
      <span>Retention Filters</span>
    </div>
    <div class="sidebar-subtitle">Filter cohort data</div>
    <button class="close-sidebar-btn" onclick="closeRetentionFilterSidebar()">√ó</button>
  </div>
  
  <div class="sidebar-body">
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üìã</span>
        <span>Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search types..." id="retentionTypeSearch">
      <div class="sidebar-filter-list" id="retentionVipTypeFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üë§</span>
        <span>Manager</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search managers..." id="retentionManagerSearch">
      <div class="sidebar-filter-list" id="retentionManagerFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üéØ</span>
        <span>Traffic Type</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search traffic..." id="retentionTrafficSearch">
      <div class="sidebar-filter-list" id="retentionTrafficFilters"></div>
    </div>
    
    <div class="sidebar-filter-group">
      <div class="sidebar-filter-label">
        <span>üåç</span>
        <span>Country</span>
      </div>
      <input type="text" class="sidebar-filter-search" placeholder="üîç Search countries..." id="retentionCountrySearch">
      <div class="sidebar-filter-list" id="retentionCountryFilters"></div>
    </div>
  </div>
  
  <div class="sidebar-footer">
    <button class="sidebar-btn-apply" onclick="applyRetentionFilters()">‚úÖ Apply Filters</button>
    <button class="sidebar-btn-clear" onclick="clearRetentionFilters()">üîÑ Clear All</button>
  </div>
</div>

<!-- Profiling Filter Overlay -->
<div class="filter-overlay" id="profilingFilterOverlay" onclick="closeProfilingFilterSidebar()"></div>

<!-- Profiling Filter Sidebar -->
<div class="filter-sidebar" id="profilingFilterSidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <span>üîç</span>
      <span>Profiling Filters</span>
    </div>
    <div class="sidebar-subtitle">Filter player profiles</div>
    <button class="close-sidebar-btn" onclick="closeProfilingFilterSidebar()">√ó</button>
  </div>
  
  <div class="sidebar-body">
    <!-- Dynamic filter groups will be built by populateProfilingFilterSidebar -->
  </div>
  
  <div class="sidebar-footer">
    <button class="sidebar-btn-apply" onclick="closeProfilingFilterSidebar()">‚úÖ Apply Filters</button>
    <button class="sidebar-btn-clear" onclick="clearProfilingFilters()">üîÑ Clear All</button>
  </div>
</div>

</body>
</html>
